<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>Minnesota Then | Self-Guided Tours</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://www.mnthen.com/css/mnthen_tour_gangster.css">
    
<style>
  /* ========================================
     FOUC Buster & Offline Mode
     ======================================== */
  body:not(.loaded) {
    opacity: 0 !important;
    visibility: hidden !important;
  }
  
  body.loaded {
    opacity: 1;
    transition: opacity 0.8s ease-in; 
  }
  
  body.offline .leaflet-control-container {
    filter: grayscale(50%);
  }
  
  body.offline .audio-player button {
    opacity: 0.7;
    pointer-events: none;
  }
  
  /* ========================================
     Offline Indicator
     ======================================== */
  #offlineIndicator {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #ff9800;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    z-index: 10002;
    animation: slideDown 0.3s ease;
  }
  
  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  @keyframes slideUp {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(-100%); opacity: 0; }
  }

  /* ========================================
     Update Banner
     ======================================== */
  #updateBanner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #005f9e;
    color: white;
    padding: 15px;
    text-align: center;
    z-index: 10002;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
  }
  
  #updateBanner button {
    margin-left: 15px;
    background: white;
    color: #005f9e;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
  }

  /* ========================================
     CSS Variables
     ======================================== */
  :root {
    --primary-color: #005f9e;
    --hover-color: #e6f2ff;
    --shadow-color: rgba(0, 0, 0, 0.1);
  }

  /* ========================================
     Base Layout
     ======================================== */
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }

  #map {
    height: 100vh;
    width: 100%;
    position: relative;
    touch-action: none;
  }

  /* ========================================
     User Marker
     ======================================== */
  .user-marker {
    pointer-events: none !important;
    will-change: transform;
  }

  .user-marker-icon {
    transform: translateZ(0) !important;
    backface-visibility: hidden;
    transform-style: preserve-3d;
    width: 24px;
    height: 24px;
    background: #dc3545;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    will-change: transform;
    transition: filter 0.3s ease, box-shadow 0.3s ease;
  }

  .user-marker-icon.moving-fast {
    filter: blur(0.5px);
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
  }
  
  /* ========================================
     Location Pins
     ======================================== */
  .custom-pin-icon .pin-head {
    width: 30px;
    height: 30px;
    background: #28a745;
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    will-change: transform;
    transition: background 0.3s ease, opacity 0.3s ease;
  }
  
  .inactive-pin .pin-head {
    background: #95a5a6;
    opacity: 0.65;
  }
  
  /* ========================================
     Skeleton Loading States
     ======================================== */
  .skeleton-image, .skeleton-text, .skeleton-audio {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }
  
  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* ========================================
     Performance Optimizations
     ======================================== */
  .lochunt-container {
    contain: strict;
    content-visibility: auto;
    contain-intrinsic-size: 300px 600px;
  }
  
  .leaflet-tile-container.high-speed img {
    image-rendering: crisp-edges;
    will-change: transform;
  }

.audio-control-btn {
  background: white;
  color: #005f9e;
  border: 2px solid #005f9e;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  margin: 0 8px;
  padding: 0;
  outline: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.audio-control-btn.play {
  width: 80px;
  height: 80px;
  font-size: 1.8rem;
  margin: 0 12px;
}
.audio-control-btn.rewind,
.audio-control-btn.forward {
  width: 72px;
  height: 72px;
  font-size: 1.5rem;
}
.audio-control-btn:hover,
.audio-control-btn:focus-visible {
  transform: scale(1.08);
  box-shadow: 0 4px 12px rgba(0,95,158,0.2);
}
.audio-control-btn:focus {
  box-shadow: 0 0 0 3px rgba(0,95,158,0.3);
}
  
  /* ========================================
     Loading Screen
     ======================================== */
  .loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-image: url('https://www.mnthen.com/images/gangster/mccord/gangster_mccord_3.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    transition: opacity 0.8s ease, visibility 0.8s ease;
  }

  .loading-screen::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1;
  }

  .loading-screen.fade-out {
    opacity: 0;
    visibility: hidden;
  }

  .loading-content {
    position: relative;
    z-index: 2;
    text-align: center;
    padding: 50px 40px;
    max-width: 500px;
    width: 90%;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  }

  .loading-logo {
    width: 150px;
    height: auto;
    margin-bottom: 25px;
  }

  .loading-title {
    color: #1a1a1a;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 35px;
    line-height: 1.3;
    font-family: 'Georgia', serif;
  }

  .progress-container {
    width: 100%;
    height: 10px;
    background: #e8e8e8;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .progress-bar-loading {
    height: 100%;
    background: linear-gradient(90deg, #2c2c2c 0%, #4a4a4a 100%);
    border-radius: 10px;
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .progress-bar-loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shine 2s infinite;
  }
  
  @keyframes shine {
    0% { left: -100%; }
    100% { left: 100%; }
  }

@media screen and (max-width: 768px) {
  .loading-content {
    transform: translateY(-5vh); /* Move up 5% of viewport height */
  }
}
</style>
</head>
<body>
    <div id="map"></div>
    <div id="distanceBox">Initializing...</div>
    <div id="a11y-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="offlineIndicator" style="display: none;"></div>
    <div id="updateBanner" style="display: none;"></div>
    
    <div class="show-all-switch">
        <label class="switch">
            <input type="checkbox" id="showAllLocations" aria-label="Show all tour locations">
            <span class="slider round"></span>
        </label>
    </div>
    
    <div class="lochunt-container">
        <img id="locationImage" src="" alt="Location Image">
        <div class="lochunt-content">
            <div class="lochunt-info">
                <h2 id="locationTitle" class="mb-2 text-primary"></h2>
                <p id="locationCity" class="text-muted mb-1"></p>
                <p id="locationCreator" class="text-muted mb-3"></p>
            </div>
            <div class="audio-player">
                <div class="audio-progress">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="audio-time">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="audio-controls">
                    <button id="rewindBtn" class="audio-button" aria-label="Rewind 10 seconds"><i class="fas fa-backward"></i></button>
                    <button id="playPauseBtn" class="audio-button" aria-label="Play audio"><i class="fas fa-play"></i></button>
                    <button id="forwardBtn" class="audio-button" aria-label="Forward 10 seconds"><i class="fas fa-forward"></i></button>
                </div>
                <audio id="locationAudio" src="" crossorigin="anonymous"></audio>
            </div>
        </div>
    </div>
    
    <div class="trivia-container">
        <h3 class="mb-3 text-primary">Trivia Question</h3>
        <p id="triviaQuestion" class="mb-3 fw-bold"></p>
        <div id="triviaOptions" class="d-grid gap-2"></div>
    </div>
    
    <div class="map-buttons">
        <button id="recenterButton" class="map-button" aria-label="Recenter map on your location"><i class="fas fa-crosshairs"></i></button>
        <button id="returnButton" class="map-button" aria-label="Return to home page"><i class="fas fa-sign-out-alt"></i></button>
        <button id="tipsButton" class="map-button" aria-label="Show navigation tips"><i class="fas fa-question-circle"></i></button>
    </div>

    <div id="loadingScreen" class="loading-screen">
      <div class="loading-content">
        <img src="https://www.mnthen.com/images/logo.webp" alt="Minnesota Then Logo" class="loading-logo">
        <h1 class="loading-title">Minnesota Then<br>Gangster History Tour</h1>
        <div class="progress-container">
          <div class="progress-bar-loading" id="loadingProgressBar"></div>
        </div>
        <p class="loading-text">Loading your adventure...</p>
      </div>
    </div>
    
    <div class="navigation-tips">
        <button class="close-button" aria-label="Close tips">&times;</button>
        <h3>Navigation Tips</h3>
        <ul>
            <li>Enable the toggle to see every stop on the tour.</li>
            <li>Use the map to navigate to the marked location.</li>
            <li>The distance box shows how far you are from the current location.</li>
            <li>Tap the recenter button to re-focus on your position.</li>
            <li>When you're within 20 feet of a location, you'll be able to interact with it.</li>
            <li>Complete the trivia question to move to the next location.</li>
        </ul>
    </div>
    
    <div id="congratulations" style="display: none;">
        <h2>Congratulations!</h2>
        <p>You have successfully completed the Minnesota Then Gangster History Tour!</p>
        <button onclick="endTour()">Return to the Home Page</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="locations_h.js?v=1.0.3"></script>
<script>
/*  Minnesota Then ‚Äì Gangster Tour  ‚Äì  High-Speed Optimized v2.4.4
    The definitive production version with all critical fixes and features.
    ¬© MIT  ‚Äì  keep console banners intact for attribution
**************************************************************************/

/* --------------------------------------------------------------------------
   0.  CONFIG  (frozen, metric, lat/lng agnostic)
-------------------------------------------------------------------------- */
const CONFIG = Object.freeze({
  SPEED : {
    ROAMING_MAX_MPS   : 6.7056,                      // 15 mph exact at equator
    CENTERED_MIN_MPS  : 6.7056,
    HIGH_MPS          : 15.6464,
    MAX_REASONABLE    : 35.7632,
  },
  EDGE : {
    SOFT : 0.30, MEDIUM : 0.20, HARD : 0.12, EMERGENCY : 0.05,
  },
  ANIMATION : {
    INSTANT : 0.1, FAST : 0.25, NORMAL : 0.4, SLOW : 0.6, RECENTER : 0.35,
    HEADING : 0.15, HIGH_SPEED_PAN : 0.1,
  },
  POSITION : {
    BUFFER_SIZE : 10,
    MIN_ACCURACY : 65,
    MIN_MOVEMENT : 0.3,
    MAX_TELEPORT : 150,
    UPDATE : {  // ms  ‚Äì  battery aware, mutated later
      VERY_HIGH : 100, HIGH : 150, MEDIUM : 250, LOW : 400, VERY_LOW : 1000,
    },
  },
  MAP : {
    DEFAULT_ZOOM : 18, MAX_ZOOM : 18, MIN_ZOOM : 8,
    ZOOM_SNAP : 0.1, ZOOM_DELTA : 0.5, TILE_BUFFER : 2,
  },
  DEAD_RECKONING : { TIMEOUT : 4000, DECAY_RATE : 0.25 },
  GAME : { PROXIMITY : 20 },
  ERRORS : { MAX_GEO : 5, RECOVER_MS : 2000 },
});

/* --------------------------------------------------------------------------
   1.  SERVICE WORKER  (for offline audio caching)
-------------------------------------------------------------------------- */
const SW_VERSION = '4.4.4';
const CACHE_NAMES = {
  STATIC: `mnthen-static-v1-${SW_VERSION}`,
  TILES: `mnthen-tiles-v1-${SW_VERSION}`,
  DATA: `mnthen-data-v1-${SW_VERSION}`,
  AUDIO: `mnthen-audio-v1-${SW_VERSION}`,
  IMAGES: `mnthen-images-v1-${SW_VERSION}`,
};

const MINI_SW = `
const CACHE = ${JSON.stringify(CACHE_NAMES)};
self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('activate', e => { e.waitUntil(clients.claim()); });
self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);
  if (url.pathname.endsWith('.mp3')) {
    e.respondWith(caches.open(CACHE.AUDIO).then(async cache => {
      const range = e.request.headers.get('range');
      let res = await cache.match(e.request.url);
      if (!res) { 
        const net = await fetch(e.request); 
        if (net.ok) cache.put(e.request.url, net.clone()); 
        res = net; 
      }
      if (!range) return res;
      const bytes = range.replace(/bytes=/,'').split('-');
      const start = Number(bytes[0]); 
      const end = Number(bytes[1]) || (await res.blob()).size - 1;
      const blob = await res.blob();
      const chunk = blob.slice(start, end + 1);
      return new Response(chunk, { 
        status: 206, 
        headers: {
          'Content-Range': 'bytes ' + start + '-' + end + '/' + blob.size,
          'Accept-Ranges': 'bytes', 
          'Content-Type': 'audio/mpeg'
        }
      });
    }));
  }
});`;

async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) { 
    warnA11y('Offline mode unavailable'); 
    return; 
  }
  try {
    const blob = new Blob([MINI_SW], {type: 'application/javascript'});
    const url = URL.createObjectURL(blob);
    const reg = await navigator.serviceWorker.register(url, {
      scope: './',
      updateViaCache: 'none'
    });
    console.log('[SW] active');
    
    reg.addEventListener('updatefound', () => {
      const worker = reg.installing;
      worker.addEventListener('statechange', () => {
        if (worker.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdateBanner();
        }
      });
    });
  } catch (e) { 
    console.error('[SW]', e); 
  }
}

function showUpdateBanner() {
  const banner = document.getElementById('updateBanner');
  if (!banner) return;
  banner.innerHTML = '<p>New tour content available!</p><button onclick="location.reload()">Update Now</button>';
  banner.style.display = 'block';
  setTimeout(() => banner.style.transform = 'translateY(0)', 100);
}

/* --------------------------------------------------------------------------
   2.  AUDIO PRE-CACHING
-------------------------------------------------------------------------- */
async function preCacheTourData() {
  if (!Array.isArray(window.locations_h)) return;
  
  try {
    const audioUrls = window.locations_h.map(l => l.audio).filter(Boolean);
    
    // Cache in background without blocking
    requestIdleCallback(async () => {
      for (const url of audioUrls) {
        try {
          await fetch(url, { mode: 'cors' });
          // SW will cache it automatically via fetch handler
        } catch (e) {
          // Silently fail - audio will load on demand
        }
      }
    }, { timeout: 5000 });
  } catch (error) {
    console.warn('[Pre-cache] Failed:', error);
  }
}

/* --------------------------------------------------------------------------
   3.  UTILITY FUNCTIONS
-------------------------------------------------------------------------- */
function dist(p1, p2) {
  const R = 6371000, toRad = d => d * Math.PI / 180,
        a = Math.sin(toRad(p2.lat - p1.lat) / 2) ** 2 +
            Math.cos(toRad(p1.lat)) * Math.cos(toRad(p2.lat)) *
            Math.sin(toRad(p2.lng - p1.lng) / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
function metersPerSecondToMph(mps) { return (mps || 0) * 2.23694; }

/* --------------------------------------------------------------------------
   4.  KALMAN FILTER (Adapts to speed)
-------------------------------------------------------------------------- */
const Kalman = {
  est : null, err : 1, proc : 0.008,
  reset(p) { this.est = {...p}; this.err = 1; },
  update(m, speed) {
    if (!this.est) { this.reset(m); return m; }
    this.proc = speed < 0.3 ? 0.001 : (speed < 5 ? 0.006 : 0.02);
    const meas = Math.max(0.08, m.accuracy / 60);
    const kg = (this.err + this.proc) / (this.err + this.proc + meas);
    this.est.lat += kg * (m.lat - this.est.lat);
    this.est.lng += kg * (m.lng - this.est.lng); // ‚Üê FIXED: was using m.lat incorrectly
    this.err = (1 - kg) * (this.err + this.proc);
    return {...m, ...this.est};
  }
};

/* --------------------------------------------------------------------------
   5.  CIRCULAR BUFFER (For smoothing)
-------------------------------------------------------------------------- */
class CircBuf {
  constructor(n) { this.n = n; this.b = new Array(n); this.i = 0; this.s = 0; }
  push(v) { this.b[this.i] = v; this.i = (this.i + 1) % this.n; if (this.s < this.n) this.s++; }
  avg() {
    if (!this.s) return null;
    let w = 0, lat = 0, lng = 0;
    for (let j = 0; j < this.s; j++) {
      const p = this.b[(this.i - this.s + j + this.n) % this.n];
      const wj = (j + 1) / this.s * (1 / (1 + p.accuracy / 25));
      lat += p.lat * wj; lng += p.lng * wj; w += wj;
    }
    const last = this.b[(this.i - 1 + this.n) % this.n];
    return { 
      lat: lat / w, 
      lng: lng / w, 
      accuracy: last.accuracy,
      timestamp: last.t  // ‚Üê ADDED: timestamp for acceleration boost
    };
  }
  toArray() {  
    const arr = [];
    for (let j = 0; j < this.s; j++) {
      arr.push(this.b[(this.i - this.s + j + this.n) % this.n]);
    }
    return arr;
  }
  clear() { this.s = this.i = 0; }
}

/* --------------------------------------------------------------------------
   6.  VIEWPORT MANAGER (Speed-aware)
-------------------------------------------------------------------------- */
const Viewport = {
  b : null, t : 0, TTL : 100,
  edges(p) {
    const now = Date.now();
    if (!this.b || now - this.t > this.TTL) { this.b = STATE.map.getBounds(); this.t = now; }
    const s = this.b.getNorth() - this.b.getSouth() || 1, w = this.b.getEast() - this.b.getWest() || 1;
    return { n : (this.b.getNorth() - p.lat) / s, s : (p.lat - this.b.getSouth()) / s,
             e : (this.b.getEast() - p.lng) / w, w : (p.lng - this.b.getWest()) / w };
  },
  update(pos, speed) {
    if (!STATE.map || !STATE.userMarker || STATE.interact || STATE.pinch) return;
    const speedMph = metersPerSecondToMph(speed);
    STATE.speedMph = speedMph;

    // CENTERED MODE: ‚â•15 mph ‚Äî icon stays dead-center, map moves
    if (speedMph >= CONFIG.SPEED.CENTERED_MIN_MPS) {
      STATE.viewportMode = 'centered';
      this.centerMarkerSmooth(pos, speedMph);
      return;
    }

    // ROAMING MODE: <15 mph ‚Äî roam freely, gentle nudges near edges
    STATE.viewportMode = 'roaming';
    this.handleRoaming(pos, speed, speedMph);
  },
  centerMarkerSmooth(pos, speedMph) {
    const now = Date.now();
    if (now - STATE.lastRecenterTime < 50) return;
    STATE.lastRecenterTime = now;

    // Disable inertia at high speed for stability
    if (speedMph >= CONFIG.SPEED.CENTERED_MIN_MPS) {
      if (STATE.map.options.inertia !== false) {
        STATE.map.options.inertia = false;
      }
    } else {
      if (STATE.map.options.inertia === false) {
        STATE.map.options.inertia = true;
      }
    }

    const markerPoint = STATE.map.latLngToContainerPoint([pos.lat, pos.lng]);
    const centerPoint = STATE.map.getSize().multiplyBy(0.5);
    const dx = markerPoint.x - centerPoint.x;
    const dy = markerPoint.y - centerPoint.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > 2) {
      STATE.map.setView([pos.lat, pos.lng], STATE.map.getZoom(), {
        animate: true,
        duration: CONFIG.ANIMATION.HIGH_SPEED_PAN,
        noMoveStart: true,
      });
    }
  },
  handleRoaming(pos, speed, speedMph) {
    const edges = this.edges(pos), min = Math.min(...Object.values(edges));
    if (min < CONFIG.EDGE.EMERGENCY) { STATE.map.setView([pos.lat, pos.lng], STATE.map.getZoom(), {animate:true, duration:CONFIG.ANIMATION.FAST}); return; }
    if (min < CONFIG.EDGE.HARD) { STATE.map.panBy([0, 0], {animate:true, duration:CONFIG.ANIMATION.NORMAL}); return; }
    if (min < CONFIG.EDGE.MEDIUM && speedMph > 0.5) STATE.map.panBy([0, 0], {animate:true, duration:CONFIG.ANIMATION.SLOW});
  }
};

/* --------------------------------------------------------------------------
   7.  TILE RENDERING OPTIMIZATION
-------------------------------------------------------------------------- */
function optimizeTileRendering(speedMph) {
  const container = document.querySelector('.leaflet-tile-container');
  if (!container) return;
  container.classList.toggle('high-speed', speedMph > CONFIG.SPEED.HIGH_MPS);
  if (speedMph > CONFIG.SPEED.HIGH_MPS) {
    container.style.opacity = '0.85';
  } else {
    container.style.opacity = '1';
  }
}

/* --------------------------------------------------------------------------
   8.  HEADING SMOOTHING
-------------------------------------------------------------------------- */
function smoothHeading(newHeading, oldHeading, speedMph) {
  if (newHeading === null || oldHeading === null || speedMph > 30) return newHeading;
  const diff = ((newHeading - oldHeading + 180) % 360) - 180;
  if (Math.abs(diff) > 45) return newHeading;
  const direction = diff > 0 ? 1 : -1;
  return oldHeading + direction * Math.min(Math.abs(diff), 8);
}

/* --------------------------------------------------------------------------
   9.  ANIMATION LOOP (RAF, stops when hidden)
-------------------------------------------------------------------------- */
function startAnim() {
  let last = 0, INT = 1000 / 30;
  function frame(ts) {
    STATE.anim = requestAnimationFrame(frame);
    if (document.hidden) { cancelAnimationFrame(STATE.anim); STATE.anim = null; return; }
    if (ts - last < INT) return;
    last = ts;
    if (!STATE.userMarker || !STATE.pos) return;
    const elapsed = (Date.now() - (STATE.lastUpdate || 0)) / 1000;
    if (elapsed > CONFIG.DEAD_RECKONING.TIMEOUT / 1000) {
      const decay = Math.exp(-elapsed * CONFIG.DEAD_RECKONING.DECAY_RATE);
      STATE.userMarker.setLatLng([STATE.pos.lat + STATE.speed * elapsed * decay * 0.00001, STATE.pos.lng + STATE.speed * elapsed * decay * 0.00001]);
    }
    const icon = STATE.userMarker.getElement()?.querySelector('.user-marker-icon');
    if (icon && STATE.heading != null) icon.style.transform = `rotate(${STATE.heading}deg)`;
  }
  STATE.anim = requestAnimationFrame(frame);
}

/* --------------------------------------------------------------------------
   10.  STATE (Complete)
-------------------------------------------------------------------------- */
const STATE = {
  map : null, userMarker : null, locMarker : null, allMarkers : [],
  pos : null, lastPos : null, buf : null, 
  velocity : { lat: 0, lng: 0 }, acceleration : { lat: 0, lng: 0 },
  speed : 0, speedMph : 0, heading : null,
  follow : true, interact : false, pinch : false, viewportMode : 'roaming',
  idx : 0, visited : [], all : [],
  hunt : false, showAll : false, err : 0, deadReckoning : false,
  watchId : null, anim : null, lastUpdate : 0, lastRecenterTime : 0,
};

/* --------------------------------------------------------------------------
   11.  GEO (with coarse fallback)
-------------------------------------------------------------------------- */
let lastProc = 0, procTO = null;
function debounce(pos) {
  clearTimeout(procTO);
  const now = Date.now(), speed = pos.coords?.speed || 0;
  const interval = speed > 15 ? 100 : speed > 8 ? 250 : 800;
  if (now - lastProc < interval) { procTO = setTimeout(() => processPosition(pos), interval - (now - lastProc)); return; }
  processPosition(pos);
}
function processPosition(raw) {
  lastProc = Date.now();
  const c = raw.coords;
  if (!c) return;
  const m = { lat : c.latitude, lng : c.longitude, accuracy : c.accuracy, heading : c.heading ?? null, speed : c.speed ?? 0, t : lastProc };
  if (isNaN(m.lat) || isNaN(m.lng)) return;
  if (m.accuracy > CONFIG.POSITION.MIN_ACCURACY) return;
  if (!STATE.pos) { initPos(m); return; }
  if (dist(STATE.pos, m) > CONFIG.POSITION.MAX_TELEPORT) { Kalman.reset(m); initPos(m); return; }
  const dt = (m.t - (STATE.lastUpdate || 0)) / 1000;
  let v = { lat: 0, lng: 0 }, speed = 0;
  if (dt > 0 && dt < 10) {
    speed = m.speed > 0 ? m.speed : dist(STATE.pos, m) / dt;
    v = {
      lat: (m.lat - STATE.pos.lat) / dt,
      lng: (m.lng - STATE.pos.lng) / dt
    };

    // Acceleration boost (requires 3 buffered points)
    if (speed > 10 && STATE.buf.size >= 3) {
      const arr = STATE.buf.toArray();
      const p0 = arr[arr.length - 3];
      const p1 = arr[arr.length - 2];
      const p2 = arr[arr.length - 1];

      if (p0 && p1 && p2) {
        const dt1 = (p1.t - p0.t) / 1000;
        const dt2 = (p2.t - p1.t) / 1000;

        if (dt1 >= 0.1 && dt2 >= 0.1 && dt1 < 3 && dt2 < 3) {
          // Calculate acceleration
          const accLat = ((p2.lat - p1.lat) / dt2 - (p1.lat - p0.lat) / dt1) / ((dt1 + dt2) / 2);
          const accLng = ((p2.lng - p1.lng) / dt2 - (p1.lng - p0.lng) / dt1) / ((dt1 + dt2) / 2);

          const maxAccel = 12;
          const clampedAccLat = clamp(accLat, -maxAccel, maxAccel);
          const clampedAccLng = clamp(accLng, -maxAccel, maxAccel);

          STATE.acceleration = { lat: clampedAccLat, lng: clampedAccLng };

          const boostLat = clampedAccLat * dt2 * 0.4;
          const boostLng = clampedAccLng * dt2 * 0.4;

          if (Math.abs(boostLat) > 0.000001 || Math.abs(boostLng) > 0.000001) {
            v.lat += boostLat;
            v.lng += boostLng;
          }
        }
      }
    }
  }
  if (speed > CONFIG.SPEED.MAX_REASONABLE) return;
  const filtered = Kalman.update(m, speed);
  STATE.buf.push(filtered);
  const smooth = STATE.buf.avg();
  STATE.pos = smooth; STATE.speed = speed; STATE.lastUpdate = m.t;
  STATE.err = 0;
  STATE.speedMph = metersPerSecondToMph(speed);
  optimizeTileRendering(STATE.speedMph);
  
  // Heading smoothing
  if (filtered.heading !== null) {
    STATE.heading = smoothHeading(filtered.heading, STATE.heading, STATE.speedMph);
  }

  // High-speed visual feedback
  const icon = STATE.userMarker.getElement()?.querySelector('.user-marker-icon');
  if (icon) {
    icon.classList.toggle('moving-fast', STATE.speedMph >= 25);
    icon.classList.toggle('moving-very-fast', STATE.speedMph >= 35);
  }

  // Save velocity to STATE
  STATE.velocity = v;

  if (!document.querySelector('.leaflet-popup,.popup,.modal')) Viewport.update(smooth, speed);
  updateDistance();
}
function initPos(p) {
  STATE.pos = STATE.lastPos = p; STATE.buf = new CircBuf(CONFIG.POSITION.BUFFER_SIZE); STATE.buf.push(p);
  STATE.speed = 0; STATE.heading = null; STATE.lastUpdate = Date.now(); STATE.err = 0;
  STATE.acceleration = { lat: 0, lng: 0 };
  Kalman.reset(p);
  STATE.userMarker.setLatLng([p.lat, p.lng]).setOpacity(1);
  STATE.map.setView([p.lat, p.lng], CONFIG.MAP.DEFAULT_ZOOM, {animate:false});
  STATE.map.options.inertia = true;
}
function startGeo() {
  if (!navigator.geolocation) { warnA11y('Geolocation unavailable'); return; }
  const fail = async (e) => {
    if (!navigator.onLine) { A11y.say('GPS offline ‚Äì estimated position'); return; }
    STATE.err++;
    const msg = { 1 : 'Permission denied', 2 : 'Position unavailable', 3 : 'Timeout' }[e.code] || 'Error';
    warnA11y(msg);
    if (STATE.err >= CONFIG.ERRORS.MAX_GEO && navigator.onLine) {
      navigator.geolocation.getCurrentPosition(debounce, () => {}, { enableHighAccuracy:false, timeout:6000, maximumAge:60000 });
    }
  };
  STATE.watchId = navigator.geolocation.watchPosition(debounce, fail, { enableHighAccuracy:true, timeout:30000, maximumAge:5000 });
  navigator.geolocation.getCurrentPosition(debounce, fail, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
}

/* --------------------------------------------------------------------------
   12.  MAP (Leaflet, minimal)
-------------------------------------------------------------------------- */
function initMap() {
  const bounds = L.latLngBounds([43.5, -97.5], [49.5, -89.5]);
  STATE.map = L.map('map', { center:[46.5, -94], zoom:CONFIG.MAP.DEFAULT_ZOOM, minZoom:CONFIG.MAP.MIN_ZOOM, maxZoom:CONFIG.MAP.MAX_ZOOM,
                             maxBounds:bounds, zoomControl:false, attributionControl:false, zoomSnap:CONFIG.MAP.ZOOM_SNAP,
                             zoomDelta:CONFIG.MAP.ZOOM_DELTA, wheelDebounceTime:100, updateWhenIdle:true, inertia:true, keepBuffer:CONFIG.MAP.TILE_BUFFER });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:CONFIG.MAP.MAX_ZOOM, attribution:'¬© OSM', crossOrigin:true, keepBuffer:CONFIG.MAP.TILE_BUFFER }).addTo(STATE.map);
  STATE.userMarker = L.marker([46.5, -94], { icon:L.divIcon({ className:'user-marker', html:'<div class="user-marker-icon"></div>', iconSize:[28,28], iconAnchor:[14,14] }), zIndexOffset:1000, opacity:0 }).addTo(STATE.map);
  startAnim();
  initMapInteraction();
}
function initMapInteraction() {
  let pinch = false;
  function start() { STATE.interact = true; STATE.follow = false; }
  function end() { STATE.interact = STATE.pinch = false; }
  STATE.map.on('touchstart', e => { if (e.originalEvent.touches.length === 2) pinch = true; STATE.pinch = pinch; start(); });
  STATE.map.on('touchend', () => { pinch = false; end(); });
  STATE.map.on('dragstart', start);
  STATE.map.on('dragend', end);
  STATE.map.on('zoomend', () => { end(); });
}

/* --------------------------------------------------------------------------
   13.  TOUR FLOW (identical UX)
-------------------------------------------------------------------------- */
async function startTour() {
  if (!Array.isArray(window.locations_h)) { warnA11y('Tour data missing'); return; }
  STATE.all = window.locations_h.map(l => ({...l})).sort((a,b) => a.id - b.id);
  STATE.idx = 0; STATE.visited = [];
  loadStop();
  Store.clear('tourProgress');
  A11y.say('Tour started');
}
function loadStop() {
  if (STATE.idx >= STATE.all.length) { congrats(); return; }
  const loc = STATE.all[STATE.idx];
  Store.save('tourProgress', { idx:STATE.idx, visited:STATE.visited, ts:Date.now() });
  if (STATE.locMarker) STATE.map.removeLayer(STATE.locMarker);
  STATE.locMarker = L.marker([loc.lat, loc.lng], { icon:L.divIcon({ className:'custom-pin-icon', html:`<div class="pin-head" data-id="${loc.id}"></div>`, iconSize:[30,30], iconAnchor:[15,30] }) }).addTo(STATE.map);
  STATE.locMarker.bindPopup(`
    <div class="popup-content">
      <img src="${loc.image}" alt="${loc.name}" loading="lazy">
      <h4><a href="${loc.link}" target="_blank" rel="noreferrer">${loc.name}</a></h4>
      <div class="popup-buttons">
        <button class="route-btn" data-lat="${loc.lat}" data-lng="${loc.lng}">Directions</button>
        <button class="skip-btn">Bypass</button>
      </div>
    </div>`, { offset:[0,-25], className:'custom-popup' });
  STATE.locMarker.on('popupopen', () => {
    document.querySelector('.route-btn')?.addEventListener('click', e => { e.stopPropagation(); navModal(e.target.dataset.lat, e.target.dataset.lng); });
    document.querySelector('.skip-btn')?.addEventListener('click', () => { STATE.idx++; loadStop(); STATE.map.closePopup(); });
  });
  updateDistance();
  A11y.say(`Next: ${loc.name}`);
}
function updateDistance() {
  if (!STATE.pos || !STATE.locMarker) return;
  const d = dist(STATE.pos, STATE.locMarker.getLatLng()), ft = Math.round(d * 3.28084);
  document.getElementById('distanceBox').textContent = `Next Stop: ${ft < 5280 ? ft + ' feet' : (ft / 5280).toFixed(2) + ' miles'}`;
  if (ft <= CONFIG.GAME.PROXIMITY && !STATE.hunt) showHunt();
}
function showHunt() {
  STATE.hunt = true;
  const loc = STATE.all[STATE.idx];
  const box = document.querySelector('.lochunt-container');
  if (!box) return;
  box.innerHTML = `
    <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch">
      <img src="${loc.image}" alt="${loc.name}" style="width:100%;height:40vh;object-fit:cover;display:block" loading="lazy">
      <div style="padding:20px;text-align:center">
        <h1 style="margin:0 0 10px;font-size:calc(1.5rem + 1.5vw)">${loc.name}</h1>
        <p style="margin:0 0 5px;font-size:calc(1rem + .5vw);color:#00008b;font-weight:bold">${loc.city}</p>
        <p style="margin:0;font-size:calc(.9rem + .4vw);color:#666">Created by: ${loc.creator}</p>
      </div>
      <div class="audio-player" style="width:100%;max-width:450px;margin:20px auto">
        <audio id="audio" crossorigin="anonymous" preload="metadata"><source src="${loc.audio}"></audio>
        <div style="height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden;margin-bottom:10px;cursor:pointer" id="prog-bar">
          <div id="prog" style="height:100%;width:0%;background:#005f9e;transition:width .1s linear"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.9rem;color:#666;margin-bottom:10px">
          <span id="cur">0:00</span><span id="dur">0:00</span>
        </div>
        <div style="display:flex;justify-content:center;gap:20px">
          <button aria-label="Rewind 10 s" class="ctrl-btn">‚è™</button>
          <button aria-label="Play" class="ctrl-btn" id="play">‚ñ∂Ô∏è</button>
          <button aria-label="Forward 10 s" class="ctrl-btn">‚è©</button>
        </div>
      </div>
      <div class="trivia-container" style="padding:20px;display:none">
        <h3 style="text-align:center;color:#005f9e">Trivia Question</h3>
        <p id="tq" style="font-weight:bold;font-size:1.2rem;margin:20px 0"></p>
        <div id="to" style="display:grid;gap:12px"></div>
      </div>
    </div>
    <div style="height:55px;background:#005f9e;display:flex;justify-content:space-between;align-items:center;padding:0 15px;flex-shrink:0">
      <button class="ico-btn" aria-label="Image source" title="Image source: ${loc.imageSource || 'Unknown'}">‚ÑπÔ∏è</button>
      <a class="ico-btn" aria-label="Feedback" href="mailto:mattreicher@protonmail.com" style="text-decoration:none">‚úâÔ∏è</a>
    </div>`;
  initAudio(loc);
  A11y.say(`You reached ${loc.name}`);
}
function initAudio(loc) {
  const a = document.getElementById('audio'), play = document.getElementById('play'), prog = document.getElementById('prog'), cur = document.getElementById('cur'), dur = document.getElementById('dur'), bar = document.getElementById('prog-bar');
  if (!a) return;
  a.addEventListener('loadedmetadata', () => dur.textContent = fmt(a.duration));
  a.addEventListener('timeupdate', () => { prog.style.width = (a.currentTime / a.duration) * 100 + '%'; cur.textContent = fmt(a.currentTime); });
  a.addEventListener('ended', () => { play.textContent = '‚ñ∂Ô∏è'; showTrivia(); });
  play.addEventListener('click', () => { a.paused ? a.play().catch(() => A11y.say('Could not play')) : a.pause(); play.textContent = a.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'; });
  document.querySelectorAll('.ctrl-btn').forEach(btn => {
    if (btn.id === 'play') return;
    btn.addEventListener('click', () => { a.currentTime = Math.max(0, Math.min(a.duration, a.currentTime + (btn.textContent.includes('‚è©') ? 10 : -10))); });
  });
  if (bar) bar.addEventListener('click', e => { const r = bar.getBoundingClientRect(); a.currentTime = ((e.clientX - r.left) / r.width) * a.duration; });
}
function fmt(s) { if (!isFinite(s)) return '0:00'; const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec.toString().padStart(2, '0')}`; }
function showTrivia() {
  const loc = STATE.all[STATE.idx];
  if (!loc.trivia) return;
  document.querySelector('.trivia-container').style.display = 'block';
  document.getElementById('tq').textContent = loc.trivia.question;
  const to = document.getElementById('to'); to.innerHTML = '';
  loc.trivia.options.forEach((opt, i) => {
    const b = document.createElement('button'); b.className = 'trivia-opt'; b.textContent = opt; b.style.cssText = 'font-size:1.1rem;color:#000;background:#fff;border:2px solid #00008b;border-radius:10px;padding:15px 20px;width:100%;cursor:pointer;text-align:left;font-weight:500;transition:all .3s';
    b.addEventListener('mouseenter', () => { b.style.background = '#f0f8ff'; b.style.transform = 'translateX(5px)'; b.style.borderColor = '#005f9e'; });
    b.addEventListener('mouseleave', () => { b.style.background = '#fff'; b.style.transform = 'translateX(0)'; b.style.borderColor = '#00008b'; });
    b.addEventListener('click', () => checkAnswer(i));
    to.appendChild(b);
  });
  A11y.say('Trivia ready');
}
function checkAnswer(i) {
  const loc = STATE.all[STATE.idx], ok = i === loc.trivia.answer;
  if (ok) {
    STATE.visited.push(STATE.idx);
    Store.save('tourProgress', { idx:STATE.idx, visited:STATE.visited, ts:Date.now() });
    const last = STATE.idx === STATE.all.length - 1;
    A11y.say(last ? 'Correct! Tour complete!' : 'Correct! Next location.');
    showPopup(last ? 'üéâ Congratulations! Tour complete!' : 'Correct! Moving on‚Ä¶', 'success', () => {
      if (last) congrats(); else { STATE.idx++; document.querySelector('.lochunt-container').style.display = 'none'; document.querySelector('.trivia-container').style.display = 'none'; STATE.hunt = false; loadStop(); }
    });
  } else {
    A11y.say('Incorrect, try again');
    showPopup('Incorrect ‚Äì try again', 'danger');
  }
}
function congrats() {
  A11y.say('Tour complete!');
  showPopup('üéâ Tour complete! Returning home‚Ä¶', 'success', () => { Store.clear('tourProgress'); location.href = 'https://www.mnthen.com/index.html'; });
}

/* --------------------------------------------------------------------------
   14.  UI HELPERS (popups, nav modal)
-------------------------------------------------------------------------- */
function showPopup(html, type, then) {
  const overlay = document.createElement('div'); overlay.className = 'popup'; overlay.setAttribute('role', 'alertdialog'); overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;justify-content:center;align-items:center;z-index:10001';
  const pop = document.createElement('div'); pop.className = 'popup-content'; pop.style.cssText = 'background:#fff;border-radius:12px;padding:30px;max-width:450px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,.3);text-align:center';
  pop.innerHTML = `<div style="margin-bottom:20px;color:#333;line-height:1.6">${html}</div><button class="popup-btn" style="background:#005f9e;color:#fff;border:none;padding:12px 30px;border-radius:8px;font-size:1.1rem;cursor:pointer">OK</button>`;
  overlay.appendChild(pop); document.body.appendChild(overlay);
  pop.querySelector('button').addEventListener('click', () => { overlay.remove(); if (then) then(); });
}
function navModal(lat, lng) {
  showPopup(`<h3 style="margin:0 0 20px">Choose navigation</h3>
    <div style="display:grid;gap:12px">
      <button class="nav-btn" data-app="google">Google Maps</button>
      <button class="nav-btn" data-app="waze">Waze</button>
      <button class="nav-btn" data-app="apple">Apple Maps</button>
    </div>`, 'info');
  document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', e => {
    const app = e.target.dataset.app;
    if (app === 'google') open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
    if (app === 'waze') open(`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`);
    if (app === 'apple') /iPad|iPhone|iPod/.test(navigator.userAgent) ? location.href = `maps://maps.apple.com/?daddr=${lat},${lng}` : A11y.say('Apple Maps only on iOS');
    document.querySelector('.popup').remove();
  }));
}

/* --------------------------------------------------------------------------
   15.  RECENTER / TIPS / ALL STOPS (same UI)
-------------------------------------------------------------------------- */
window.RecenterMap = () => {
  if (!STATE.map) return;
  const p = STATE.pos || STATE.lastPos;
  if (!p) { A11y.say('Location not yet available'); return; }
  STATE.map.setView([p.lat, p.lng], CONFIG.MAP.DEFAULT_ZOOM, {animate:true, duration:CONFIG.ANIMATION.RECENTER});
  STATE.follow = true;
  A11y.say('Map centered');
};
window.ToggleNavigationTips = () => {
  const panel = document.querySelector('.navigation-tips'), btn = document.getElementById('tipsButton');
  if (!panel) return;
  const show = panel.style.display !== 'block';
  panel.style.display = show ? 'block' : 'none'; btn?.classList.toggle('active', show); btn?.setAttribute('aria-expanded', show);
  A11y.say(show ? 'Tips opened' : 'Tips closed');
};
window.ToggleAllLocations = show => {
  STATE.allMarkers?.forEach(m => STATE.map.removeLayer(m)); STATE.allMarkers = [];
  if (!show) return;
  STATE.all.forEach((loc, i) => {
    if (i === STATE.idx) return;
    const m = L.marker([loc.lat, loc.lng], { icon:L.divIcon({ className:'custom-pin-icon inactive-pin', html:`<div class="pin-head" data-id="${loc.id}"></div>`, iconSize:[30,30], iconAnchor:[15,30] }) }).addTo(STATE.map);
    STATE.allMarkers.push(m);
  });
  A11y.say(show ? 'All locations visible' : 'Current only');
};

/* --------------------------------------------------------------------------
   16.  STORAGE & A11Y (ePrivacy safe)
-------------------------------------------------------------------------- */
const Store = {
  save(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} },
  load(k) { try { const d = JSON.parse(localStorage.getItem(k)); return d?.ts > Date.now() - 86400000 ? d : null; } catch { return null; } },
  clear(k) { try { localStorage.removeItem(k); } catch {} },
};
const A11y = {
  last : 0,
  say(m, prio = 'polite') {
    const now = Date.now();
    if (prio === 'polite' && now - this.last < 2000) return;
    this.last = now;
    const live = document.getElementById('a11y-announcer');
    if (live) { live.textContent = ''; requestAnimationFrame(() => live.textContent = m); }
  }
};
function warnA11y(m) { A11y.say(m, 'assertive'); }

/* --------------------------------------------------------------------------
   17.  BOOTSTRAP (deferred, battery aware)
-------------------------------------------------------------------------- */
addEventListener('DOMContentLoaded', async () => {
  await registerServiceWorker(); // ‚Üê Add this line FIRST
  await preCacheTourData();     // ‚Üê Add this line
  
  initMap();
  if ('connection' in navigator) {
    const c = navigator.connection;
    if (c.saveData || /2g/.test(c.effectiveType)) Object.keys(CONFIG.POSITION.UPDATE).forEach(k => CONFIG.POSITION.UPDATE[k] *= 2);
  }
  if ('getBattery' in navigator) {
    const bat = await navigator.getBattery();
    const slow = bat.charging ? 400 : 800;
    CONFIG.POSITION.UPDATE.VERY_LOW = slow;
    bat.addEventListener('chargingchange', () => { CONFIG.POSITION.UPDATE.VERY_LOW = bat.charging ? 400 : 800; });
  }
  // restore or start
  const saved = Store.load('tourProgress');
  if (saved) { STATE.idx = saved.idx; STATE.visited = saved.visited; }
  startGeo();
  const wait = () => { if (STATE.pos) { startTour(); document.body.classList.add('app-ready'); } else setTimeout(wait, 100); };
  wait();
  // global keys
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { document.querySelectorAll('.popup').forEach(p => p.remove()); document.querySelectorAll('.modal').forEach(m => m.remove()); STATE.map.closePopup(); } });
  document.addEventListener('visibilitychange', () => { if (!document.hidden) navigator.geolocation.getCurrentPosition(debounce, () => {}, { enableHighAccuracy:true, timeout:10000, maximumAge:0 }); });
  addEventListener('beforeunload', () => { if (STATE.watchId) navigator.geolocation.clearWatch(STATE.watchId); if (STATE.anim) cancelAnimationFrame(STATE.anim); Store.save('tourProgress', { idx:STATE.idx, visited:STATE.visited, ts:Date.now() }); });
});

/* --------------------------------------------------------------------------
   18.  CSS (injected once)
-------------------------------------------------------------------------- */
(function () {
  const s = document.createElement('style');
  s.textContent = `
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    @keyframes subtlePulse {
      0%, 100% { transform: scale(1) rotate(var(--heading, 0deg)); }
      50% { transform: scale(1.06) rotate(var(--heading, 0deg)); }
    }
    .leaflet-tile-container { transform:translateZ(0); backface-visibility:hidden; }
    .user-marker-icon { will-change:transform; transition:transform .15s cubic-bezier(.25,.1,.25,1); transform-origin:center; }
    .user-marker-icon.moving-fast {
      filter: brightness(1.1);
    }
    .user-marker-icon.moving-very-fast {
      animation: subtlePulse 0.8s ease-in-out infinite;
      filter: brightness(1.15) drop-shadow(0 0 4px rgba(220, 53, 69, 0.5));
      box-shadow: 0 0 12px rgba(220, 53, 69, 0.4);
    }
    .popup-content { text-align:center }
    .popup-btn, .nav-btn, .trivia-opt, .ctrl-btn { cursor:pointer; transition:all .3s ease; border:none; border-radius:8px; font-size:1.1rem; padding:12px 20px }
    .popup-btn, .nav-btn { background:#005f9e; color:#fff; width:100%; margin-bottom:10px }
    .ctrl-btn { background:#fff; color:#005f9e; border:2px solid #005f9e; border-radius:50%; width:60px; height:60px; display:flex; align-items:center; justify-content:center }
    .ico-btn { background:transparent; color:#fff; font-size:1.5rem; padding:8px; cursor:pointer; border:none }
  `;
  document.head.appendChild(s);
})();
</script>
</body>
</html>
