<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Markers Map</title>
  <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://www.mnthen.com/css/mnthen_marker.css">
  <style>
    /* Common Modal Styles */
    .modal-base {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .close-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .close-btn:hover {
      background-color: #f0f0f0;
      color: #333;
    }

    /* Floating Menu Styles */
    .floating-menu {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .floating-btn {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }

    .floating-btn:hover {
      background-color: #0056b3;
    }

    .menu-content {
      display: none;
      position: absolute;
      bottom: 60px;
      right: 0;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 200px;
      padding: 10px;
    }

    .menu-content a {
      display: block;
      padding: 10px;
      color: #333;
      text-decoration: none;
      border-bottom: 1px solid #eee;
    }

    .menu-content a:hover {
      background-color: #f9f9f9;
    }

    .menu-content a:last-child {
      border-bottom: none;
    }

    /* Overlay Styles */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7); /* Darker overlay */
      z-index: 1000;
    }

    /* Marker Info Modal Styles */
    .marker-info-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .marker-info-modal img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .marker-info-modal h2 {
      margin-top: 0;
      text-align: center; /* Centered title */
    }

    .marker-info-modal .uploader-info {
      font-size: 0.9rem;
      color: #666;
    }

    .marker-info-modal .description {
      margin-top: 1rem;
    }

    .marker-info-modal .nearby-markers {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .marker-info-modal .nearby-marker {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.5rem;
      text-align: center;
    }

    /* Small Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal .short-description {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
  </style>
</head>
<body>
<div class="floating-menu" id="floatingMenu">
  <button class="floating-btn" id="floatingBtn">â˜°</button>
  <div class="menu-content" id="menuContent">
    <a href="#" id="homeLink">Home</a>
    <a href="#" id="aboutLink">About Us</a>
    <a href="#" id="instructionsLink">Instructions</a>
    <a href="#" id="loginLink">Login/Join</a>
  </div>
</div>

<div class="page search-page" id="searchPage">
  <div class="hero-content">
    <h1>Community Markers</h1>
    <p>Discover and share meaningful places across Minnesota.</p>
    <div class="search-container">
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput">
        <button class="search-button" id="searchButton">Search Location</button>
      </div>
    </div>
  </div>
  <div class="scroll-down" id="scrollDown">
    <span>View Map</span>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
    </svg>
  </div>
</div>

<div class="page map-page" id="mapPage">
  <div class="map-search-bar">
    <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput">
    <button class="map-search-button" id="mapSearchButton">Search</button>
  </div>
  <div id="map"></div>
</div>

<div class="overlay" id="overlay"></div>

<!-- About Popup -->
<div class="about-popup modal-base" id="aboutPopup">
  <button class="close-btn" id="closeAbout">&times;</button>
  <h2>About Community Markers</h2>
  <p>
    Community Markers is a collaborative platform where users can create and discover meaningful locations around the world.
  </p>
</div>

<!-- Instructions Popup -->
<div class="instructions-popup modal-base" id="instructionsPopup">
  <button class="close-btn" id="closeInstructions">&times;</button>
  <h2>Instructions</h2>
  <p>
    Register an account or log in if you already have one.
  </p>
  <p>
    Click on the map to add a location that holds cultural or historical significance to you or your community.
  </p>
</div>

<!-- Marker Modal -->
<div class="modal modal-base" id="markerModal">
  <button class="close-btn" id="closeModal">&times;</button>
  <h2>Add New Marker</h2>
  <form id="markerForm">
    <div class="form-group">
      <label for="title">Title</label>
      <input type="text" id="title" required>
    </div>
    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" rows="3" required></textarea>
    </div>
    <div class="form-group">
      <label for="image">Image URL</label>
      <input type="url" id="image" placeholder="https://example.com/image.jpg">
    </div>
    <div class="form-group">
      <label for="date">Date</label>
      <input type="date" id="date" required>
    </div>
    <button type="submit" class="search-button">Add Marker</button>
  </form>
</div>

<!-- Marker Info Modal -->
<div class="marker-info-modal modal-base" id="markerInfoModal">
  <button class="close-btn" id="closeMarkerInfo">&times;</button>
  <h2 id="markerInfoTitle"></h2>
  <div class="marker-info-content">
    <div class="marker-info-left">
      <img id="markerInfoImage" src="" alt="Marker Image">
      <p class="uploader-info" id="markerInfoUploader"></p>
      <p class="uploader-info" id="markerInfoDate"></p>
      <p class="views" id="markerInfoViews"></p>
      <p class="likes" id="markerInfoLikes"></p>
    </div>
    <div class="marker-info-right">
      <p class="description" id="markerInfoDescription"></p>
      <div class="nearby-markers" id="nearbyMarkers">
        <!-- Nearby markers will be dynamically inserted here -->
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
  authDomain: "mnthen-3151d.firebaseapp.com",
  projectId: "mnthen-3151d",
  storageBucket: "mnthen-3151d.appspot.com",
  messagingSenderId: "416231360428",
  appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// DOM Elements
const floatingBtn = document.getElementById("floatingBtn");
const menuContent = document.getElementById("menuContent");
const loginLink = document.getElementById("loginLink");
const logoutButton = document.getElementById("logoutButton");
const authPopup = document.getElementById("authPopup");
const closePopup = document.getElementById("closePopup");
const joinForm = document.getElementById("joinForm");
const loginForm = document.getElementById("loginForm");
const showLogin = document.getElementById("showLogin");
const showJoin = document.getElementById("showJoin");
const joinButton = document.getElementById("joinButton");
const loginButton = document.getElementById("loginButton");
const notification = document.getElementById("notification");
const joinEmail = document.getElementById("joinEmail");
const joinPassword = document.getElementById("joinPassword");
const joinFirstName = document.getElementById("joinFirstName");
const joinLastName = document.getElementById("joinLastName");
const joinCity = document.getElementById("joinCity");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const searchPage = document.getElementById("searchPage");
const mapPage = document.getElementById("mapPage");
const scrollDown = document.getElementById("scrollDown");
const searchInput = document.getElementById("searchInput");
const searchButton = document.getElementById("searchButton");
const mapSearchInput = document.getElementById("mapSearchInput");
const mapSearchButton = document.getElementById("mapSearchButton");
const markerModal = document.getElementById("markerModal");
const closeModal = document.getElementById("closeModal");
const markerForm = document.getElementById("markerForm");
const titleInput = document.getElementById("title");
const descriptionInput = document.getElementById("description");
const imageInput = document.getElementById("image");
const dateInput = document.getElementById("date");
const aboutLink = document.getElementById("aboutLink");
const aboutPopup = document.getElementById("aboutPopup");
const overlay = document.getElementById("overlay");
const closeAbout = document.getElementById("closeAbout");
const logoutPopup = document.getElementById("logoutPopup");
const confirmLogout = document.getElementById("confirmLogout");
const cancelLogout = document.getElementById("cancelLogout");

// New Instructions Popup Elements
const instructionsLink = document.getElementById("instructionsLink");
const instructionsPopup = document.getElementById("instructionsPopup");
const closeInstructions = document.getElementById("closeInstructions");

// Marker Info Modal Elements
const markerInfoModal = document.getElementById("markerInfoModal");
const closeMarkerInfo = document.getElementById("closeMarkerInfo");
const markerInfoImage = document.getElementById("markerInfoImage");
const markerInfoTitle = document.getElementById("markerInfoTitle");
const markerInfoDescription = document.getElementById("markerInfoDescription");
const markerInfoDate = document.getElementById("markerInfoDate");
const markerInfoViews = document.getElementById("markerInfoViews");
const markerInfoLikes = document.getElementById("markerInfoLikes");
const nearbyMarkers = document.getElementById("nearbyMarkers");

// Global Variables
let map = null;
let markers = null;
let tempMarker = null;
let markersData = JSON.parse(localStorage.getItem('markers') || '[]');
let currentUser = null;

// Firebase Auth State Listener
auth.onAuthStateChanged((user) => {
  currentUser = user;
  loginLink.textContent = user ? "Log Out" : "Login/Join";
  logoutButton.style.display = user ? "block" : "none";

  if (user) {
    loginLink.removeEventListener("click", openAuthPopup);
    loginLink.addEventListener("click", openLogoutPopup);
  } else {
    loginLink.removeEventListener("click", openLogoutPopup);
    loginLink.addEventListener("click", openAuthPopup);
  }
});

// FAB Menu Toggle
floatingBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  menuContent.style.display = menuContent.style.display === "block" ? "none" : "block";
});

// Close FAB Menu on Outside Click
window.addEventListener("click", (e) => {
  if (!e.target.matches(".floating-btn") && !e.target.matches(".menu-content a")) {
    menuContent.style.display = "none";
  }
});

// Event Listeners for Popups
aboutLink.addEventListener("click", (e) => {
  e.preventDefault();
  aboutPopup.style.display = "block";
  overlay.style.display = "block";
});

instructionsLink.addEventListener("click", (e) => {
  e.preventDefault();
  instructionsPopup.style.display = "block";
  overlay.style.display = "block";
});

closeAbout.addEventListener("click", () => {
  aboutPopup.style.display = "none";
  overlay.style.display = "none";
});

closeInstructions.addEventListener("click", () => {
  instructionsPopup.style.display = "none";
  overlay.style.display = "none";
});

closeMarkerInfo.addEventListener("click", () => {
  markerInfoModal.style.display = "none";
  overlay.style.display = "none";
});

window.addEventListener("click", (e) => {
  if (e.target === overlay) {
    aboutPopup.style.display = "none";
    instructionsPopup.style.display = "none";
    markerInfoModal.style.display = "none";
    overlay.style.display = "none";
  }
});

// Map Functions
function initializeMap() {
  if (!map) {
    map = L.map("map", {
      zoomControl: false,
      minZoom: 3,
      maxZoom: 19,
    }).setView([44.9778, -93.265], 18);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "",
      maxZoom: 18,
    }).addTo(map);

    markers = L.markerClusterGroup();
    map.addLayer(markers);

    map.on("click", (e) => {
      if (!currentUser) {
        showNotification("Please log in to add markers.", "error");
        return;
      }
      if (tempMarker) map.removeLayer(tempMarker);
      tempMarker = L.marker(e.latlng).addTo(map);
      markerModal.style.display = "block";
    });

    loadMarkers();
  }
}

function loadMarkers() {
  if (!markers) return;

  markers.clearLayers();
  markersData = JSON.parse(localStorage.getItem("markers") || "[]");

  markersData.forEach((data) => {
    const marker = L.marker([data.lat, data.lng]);
    const popupContent = `
      <div class="marker-popup">
        ${data.image ? `<img src="${data.image}" alt="${data.title}">` : ""}
        <h3><a href="#" class="marker-title-link">${data.title}</a></h3>
        <p>${data.description}</p>
        <p><small>Added on: ${new Date(data.date).toLocaleDateString()}</small></p>
      </div>
    `;
    marker.bindPopup(popupContent);
    marker.on("click", () => {
      updateMarkerInfoModal(data);
      markerInfoModal.style.display = "block";
      overlay.style.display = "block";
    });
    markers.addLayer(marker);
  });
}

// Update Marker Info Modal
function updateMarkerInfoModal(data) {
  markerInfoImage.src = data.image || "";
  markerInfoTitle.textContent = data.title;
  markerInfoDescription.textContent = data.description;
  markerInfoUploader.textContent = `Uploaded by: ${data.uploaderName}`;
  markerInfoDate.textContent = `Added on: ${new Date(data.date).toLocaleDateString()}`;
  markerInfoViews.textContent = `Views: ${data.views || 0}`;
  markerInfoLikes.textContent = `Likes: ${data.likes || 0}`;

  // Increment views
  data.views = (data.views || 0) + 1;
  localStorage.setItem("markers", JSON.stringify(markersData));

  // Load nearby markers
  loadNearbyMarkers(data);
}

// Load Nearby Markers
function loadNearbyMarkers(data) {
  nearbyMarkers.innerHTML = ""; // Clear previous nearby markers
  const nearby = markersData.filter((marker) => {
    const distance = Math.sqrt(
      Math.pow(marker.lat - data.lat, 2) + Math.pow(marker.lng - data.lng, 2)
    );
    return distance < 0.01 && marker !== data; // Adjust distance threshold as needed
  }).slice(0, 3); // Show up to 3 nearby markers

  nearby.forEach((marker) => {
    const nearbyMarker = document.createElement("div");
    nearbyMarker.className = "nearby-marker";
    nearbyMarker.innerHTML = `
      <h4>${marker.title}</h4>
      <p>${marker.description.substring(0, 30)}...</p>
    `;
    nearbyMarkers.appendChild(nearbyMarker);
  });
}

// Close Marker Info Modal
closeMarkerInfo.addEventListener("click", () => {
  markerInfoModal.style.display = "none";
  overlay.style.display = "none";
});

window.addEventListener("click", (e) => {
  if (e.target === overlay) {
    markerInfoModal.style.display = "none";
    overlay.style.display = "none";
  }
});

// Initialize Map if Map Page is Active
if (mapPage.style.transform === "translateY(0)") {
  initializeMap();
}
</script>
</body>
</html>
