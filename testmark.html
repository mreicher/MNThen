<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Markers Map</title>
  <!-- Firebase v8 scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <!-- Styles -->
  <link rel="stylesheet" href="https://www.mnthen.com/css/mnthen_marker.css">
</head>
  
<body>
<!-- Floating Menu -->
<div class="floating-menu" id="floatingMenu">
  <button class="floating-btn" id="floatingBtn">â˜°</button>
  <div class="menu-content" id="menuContent">
    <a href="#" id="homeLink">Home</a>
    <a href="#" id="aboutLink">About Us</a>
    <a href="#" id="loginLink">Login/Join</a>
    <a href="#" id="placeholderLink1">Placeholder 1</a>
    <a href="#" id="placeholderLink2">Placeholder 2</a>
  </div>
</div>

  <!-- Search Page -->
  <div class="page search-page" id="searchPage">
    <div class="hero-content">
      <h1>Community Markers</h1>
      <p>Discover and share meaningful places across Minnesota.</p>
      <div class="search-container">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput">
          <button class="search-button" id="searchButton">Search Location</button>
        </div>
      </div>
    </div>
    <div class="scroll-down" id="scrollDown">
      <span>View Map</span>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
      </svg>
    </div>
  </div>

<!-- Map Page -->
<div class="page map-page" id="mapPage">
    <!-- Map Search Bar -->
    <div class="map-search-bar">
        <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput">
        <button class="map-search-button" id="mapSearchButton">Search</button>
    </div>
    <div id="map"></div>
</div>

  <!-- Overlay -->
  <div class="overlay" id="overlay"></div>
  
  <!-- About Popup -->
  <div class="about-popup" id="aboutPopup">
    <span class="close-modal" id="closeAbout">&times;</span>
    <h2>About Community Markers</h2>
    <p>
      Community Markers is a collaborative platform where users can create and discover meaningful locations around the world. Whether it's a historical landmark, a hidden gem, or a personal memory spot, you can share it with the community.
    </p>
    <p>
      Our mission is to create a global map of stories and experiences, connecting people through the places that matter to them. Join us in building this collective memory of special locations and their significance to different communities.
    </p>
  </div>

  <!-- Marker Modal -->
  <div class="modal" id="markerModal">
    <div class="modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <h2>Add New Marker</h2>
      <form id="markerForm">
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" required>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="image">Image URL</label>
          <input type="url" id="image" placeholder="https://example.com/image.jpg">
        </div>
        <div class="form-group">
          <label for="date">Date</label>
          <input type="date" id="date" required>
        </div>
        <button type="submit" class="search-button">Add Marker</button>
      </form>
    </div>
  </div>

<!-- Login/Join Popup -->
<div class="auth-popup" id="authPopup">
    <button class="close-btn" id="closePopup">&times;</button>
    <div class="form-container" id="joinForm">
        <h3>Join</h3>
        <input type="text" id="joinName" placeholder="Name" required>
        <input type="email" id="joinEmail" placeholder="Email Address" required>
        <input type="text" id="joinCity" placeholder="City" required>
        <input type="password" id="joinPassword" placeholder="Password" required>
        <button id="joinButton">Join</button>
        <p class="toggle-auth" id="showLogin">Already have an account? Log In</p>
    </div>
    <div class="form-container" id="loginForm" style="display: none;">
        <h3>Log In</h3>
        <input type="text" id="loginName" placeholder="Name" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button id="loginButton">Log In</button>
        <p class="toggle-auth" id="showJoin">Don't have an account? Join</p>
    </div>
</div>

  <!-- Logout Button (Visible when logged in) -->
<button id="logoutButton" style="display: none;">Log Out</button>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
  authDomain: "mnthen-3151d.firebaseapp.com",
  projectId: "mnthen-3151d",
  storageBucket: "mnthen-3151d.appspot.com",
  messagingSenderId: "416231360428",
  appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// DOM Elements
const floatingBtn = document.getElementById('floatingBtn');
const menuContent = document.getElementById('menuContent');
const loginLink = document.getElementById('loginLink');
const logoutButton = document.getElementById('logoutButton');
const authPopup = document.getElementById('authPopup');
const closePopup = document.getElementById('closePopup');
const joinForm = document.getElementById('joinForm');
const loginForm = document.getElementById('loginForm');
const showLogin = document.getElementById('showLogin');
const showJoin = document.getElementById('showJoin');
const joinButton = document.getElementById('joinButton');
const loginButton = document.getElementById('loginButton');
const notification = document.getElementById('notification');
const joinName = document.getElementById('joinName');
const joinEmail = document.getElementById('joinEmail');
const joinPassword = document.getElementById('joinPassword');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const searchPage = document.getElementById('searchPage');
const mapPage = document.getElementById('mapPage');
const scrollDown = document.getElementById('scrollDown');
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const mapSearchInput = document.getElementById('mapSearchInput');
const mapSearchButton = document.getElementById('mapSearchButton');
const markerModal = document.getElementById('markerModal');
const closeModal = document.getElementById('closeModal');
const markerForm = document.getElementById('markerForm');
const titleInput = document.getElementById('title');
const descriptionInput = document.getElementById('description');
const imageInput = document.getElementById('image');
const dateInput = document.getElementById('date');
const aboutLink = document.getElementById('aboutLink');
const aboutPopup = document.getElementById('aboutPopup');
const overlay = document.getElementById('overlay');
const closeAbout = document.getElementById('closeAbout');

// Logout Confirmation Pop-up
const logoutPopup = document.createElement('div');
logoutPopup.className = 'auth-popup';
logoutPopup.innerHTML = `
  <div class="form-container">
    <h3>Log Out</h3>
    <p>Are you sure you want to log out?</p>
    <button id="confirmLogout">Yes, Log Out</button>
    <button id="cancelLogout">Cancel</button>
  </div>
`;
document.body.appendChild(logoutPopup);

// Map state
let map = null;
let markers = null;
let tempMarker = null;
let markersData = JSON.parse(localStorage.getItem('markers') || '[]');

// Firebase state
let currentUser = null;

// Track user authentication state
auth.onAuthStateChanged((user) => {
  if (user) {
    // User is logged in
    currentUser = user;
    loginLink.textContent = 'Log Out';
    loginLink.removeEventListener('click', openAuthPopup);
    loginLink.addEventListener('click', openLogoutPopup);
    logoutButton.style.display = 'block';
  } else {
    // User is logged out
    currentUser = null;
    loginLink.textContent = 'Login/Join';
    loginLink.removeEventListener('click', openLogoutPopup);
    loginLink.addEventListener('click', openAuthPopup);
    logoutButton.style.display = 'none';
  }
});

// Floating Menu Toggle
floatingBtn.addEventListener('click', (e) => {
  e.stopPropagation(); // Prevent event from bubbling up
  menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
});

// Close Menu When Clicking Outside
window.addEventListener('click', (e) => {
  if (!e.target.matches('.floating-btn') && !e.target.matches('.menu-content a')) {
    menuContent.style.display = 'none';
  }
});

// Open Login/Join Popup
function openAuthPopup(e) {
  e.preventDefault();
  authPopup.classList.add('active');
}

// Close Login/Join Popup
closePopup.addEventListener('click', () => {
  authPopup.classList.remove('active');
});

// Open Logout Confirmation Pop-up
function openLogoutPopup(e) {
  e.preventDefault();
  logoutPopup.classList.add('active');
}

// Close Logout Confirmation Pop-up
logoutPopup.addEventListener('click', (e) => {
  if (e.target.id === 'confirmLogout') {
    auth.signOut()
      .then(() => {
        showNotification('Logged out successfully!', 'success');
        logoutPopup.classList.remove('active');
      })
      .catch((error) => {
        showNotification('Logout failed: ' + error.message, 'error');
      });
  } else if (e.target.id === 'cancelLogout') {
    logoutPopup.classList.remove('active');
  }
});

// Toggle between Join and Login forms
showLogin.addEventListener('click', () => {
  joinForm.style.display = 'none';
  loginForm.style.display = 'block';
});

showJoin.addEventListener('click', () => {
  loginForm.style.display = 'none';
  joinForm.style.display = 'block';
});

// Join Functionality
joinButton.addEventListener('click', () => {
  const email = joinEmail.value;
  const password = joinPassword.value;
  const name = joinName.value;

  if (!email || !password || !name) {
    showNotification('Please fill out all fields.', 'error');
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      const user = userCredential.user;
      return database.ref('users/' + user.uid).set({
        name: name,
        email: email
      });
    })
    .then(() => {
      showNotification('Join successful!', 'success');
      authPopup.classList.remove('active');
      joinForm.reset();
    })
    .catch((error) => {
      showNotification('Join failed: ' + error.message, 'error');
    });
});

// Login Functionality
loginButton.addEventListener('click', () => {
  const email = loginEmail.value;
  const password = loginPassword.value;

  if (!email || !password) {
    showNotification('Please fill out all fields.', 'error');
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      showNotification('Login successful!', 'success');
      authPopup.classList.remove('active');
      loginForm.reset();
    })
    .catch((error) => {
      showNotification('Login failed: ' + error.message, 'error');
    });
});

// Show Notification
function showNotification(message, type) {
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = 'block';
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

// Initialize Map
function initializeMap() {
  if (!map) {
    map = L.map('map', { zoomControl: false }).setView([44.9778, -93.2650], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '', // Remove attribution
      maxZoom: 16
    }).addTo(map);

    // Initialize markers as a marker cluster group
    markers = L.markerClusterGroup();
    map.addLayer(markers);

    // Add click handler for adding new markers
    map.on('click', function(e) {
      if (tempMarker) {
        map.removeLayer(tempMarker);
      }
      tempMarker = L.marker(e.latlng).addTo(map);
      markerModal.style.display = 'block';
    });

    // Load existing markers
    loadMarkers();
  }
}

// Load existing markers
function loadMarkers() {
  if (!markers) {
    console.error('Markers not initialized');
    return;
  }

  markers.clearLayers();

  if (!markersData) {
    markersData = [];
  }

  markersData.forEach(data => {
    const marker = L.marker([data.lat, data.lng]);
    const popupContent = `
      <div class="marker-popup">
        ${data.image ? `<img src="${data.image}" alt="${data.title}">` : ''}
        <h3>${data.title}</h3>
        <p>${data.description}</p>
        <p><small>Added on: ${new Date(data.date).toLocaleDateString()}</small></p>
      </div>
    `;
    marker.bindPopup(popupContent);
    markers.addLayer(marker);
  });
}

// Navigation
scrollDown.addEventListener('click', () => {
  searchPage.style.transform = 'translateY(-100%)';
  mapPage.style.transform = 'translateY(0)';
  setTimeout(initializeMap, 500);
});

// Search handler
function performSearch(query, inputElement) {
  if (!query) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Minnesota, USA')}`)
    .then(response => response.json())
    .then(data => {
      const minnesotaResults = data.filter(result => result.display_name.includes('Minnesota'));
      if (minnesotaResults.length > 0) {
        const { lat, lon } = minnesotaResults[0];
        searchPage.style.transform = 'translateY(-100%)';
        mapPage.style.transform = 'translateY(0)';
        
        setTimeout(() => {
          initializeMap();
          map.setView([parseFloat(lat), parseFloat(lon)], 13);
          showNotification('Location found in Minnesota!', 'success');
        }, 500);
      } else {
        showNotification('Location not found in Minnesota', 'error');
      }
    })
    .catch(() => {
      showNotification('Error searching location', 'error');
    })
    .finally(() => {
      // Clear the search input after the search is executed
      if (inputElement) {
        inputElement.value = '';
      }
    });
}

// Search on Enter key press (main search bar)
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    performSearch(this.value.trim(), this);
  }
});

// Search on button click (main search bar)
searchButton.addEventListener('click', () => {
  performSearch(searchInput.value.trim(), searchInput);
});

// Search on Enter key press (map search bar)
mapSearchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    performSearch(this.value.trim(), this);
  }
});

// Search on button click (map search bar)
mapSearchButton.addEventListener('click', () => {
  performSearch(mapSearchInput.value.trim(), mapSearchInput);
});

// Form submission handler
markerForm.addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!tempMarker || !currentUser) {
    showNotification('You must be logged in to add a marker.', 'error');
    return;
  }

  const newMarker = {
    title: titleInput.value.trim(),
    description: descriptionInput.value.trim(),
    image: imageInput.value.trim(),
    date: dateInput.value,
    lat: tempMarker.getLatLng().lat,
    lng: tempMarker.getLatLng().lng,
    timestamp: Date.now(),
    userId: currentUser.uid // Associate marker with the logged-in user
  };

  markersData.push(newMarker);
  localStorage.setItem('markers', JSON.stringify(markersData));
  
  map.removeLayer(tempMarker);
  tempMarker = null;
  markerModal.style.display = 'none';
  markerForm.reset();
  
  loadMarkers();
  showNotification('Marker added successfully!', 'success');
});

// Modal close handler
closeModal.addEventListener('click', function() {
  markerModal.style.display = 'none';
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
});

// Click outside modal to close
window.addEventListener('click', function(e) {
  if (e.target === markerModal) {
    markerModal.style.display = 'none';
    if (tempMarker) {
      map.removeLayer(tempMarker);
      tempMarker = null;
    }
  }
});

// Initialize date input to today's date
dateInput.valueAsDate = new Date();

// Initialize markers on load
if (mapPage.style.transform === 'translateY(0)') {
  initializeMap();
}
  </script>
</body>
</html>
