<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Markers Map</title>
  <!-- Firebase v8 scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <!-- Styles -->
  <style>
:root {
  --primary-color: #2563eb;
  --primary-hover: #1d4ed8;
  --text-color: #1f2937;
  --bg-color: #f8fafc;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body, html {
  height: 100%;
  font-family: system-ui, -apple-system, sans-serif;
  color: var(--text-color);
  overflow: hidden;
  background: var(--bg-color);
}

.page {
  height: 100vh;
  width: 100vw;
  position: absolute;
  transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.search-page {
  background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)),
              url('https://images.unsplash.com/photo-1486870591958-9b9d0d1dda99?w=1200&auto=format&fit=crop&q=80') center/cover;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2;
}

.hero-content {
  text-align: center;
  color: white;
  margin-bottom: 2rem;
  max-width: 800px;
  padding: 0 1rem;
}

.hero-content h1 {
  font-size: 3.5rem;
  font-weight: 800;
  margin-bottom: 1rem;
  line-height: 1.2;
}

.hero-content p {
  font-size: 1.25rem;
  margin-bottom: 2rem;
  opacity: 0.9;
}

.hero-content a {
  color: white;
  text-decoration: underline;
  cursor: pointer;
  transition: opacity 0.2s;
}

.hero-content a:hover {
  opacity: 0.8;
}

.search-container {
  width: 100%;
  max-width: 600px;
  background: white;
  padding: 1.5rem;
  border-radius: 1rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  margin: 0 auto;
}

.search-bar {
  display: flex;
  gap: 0.75rem;
  width: 100%;
}

.search-input {
  flex: 1;
  padding: 0.75rem 1.25rem;
  border: 2px solid #e5e7eb;
  border-radius: 0.75rem;
  font-size: 1rem;
  outline: none;
  transition: all 0.2s;
}

.search-input:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.search-button {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 0.75rem;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.search-button:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
}

.search-button:active {
  transform: translateY(0);
}

.map-page {
  transform: translateY(100%);
  z-index: 1;
}

#map {
  height: 100vh;
  width: 100%;
}

/* Login/Join Popup Styles */
.auth-popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  width: 350px;
  border-radius: 8px;
}

.auth-popup.active {
  display: block;
}

.auth-popup .close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 20px;
  background: none;
  border: none;
  cursor: pointer;
}

.auth-popup .form-container {
  display: flex;
  flex-direction: column;
}

.auth-popup .form-container input {
  margin: 10px 0;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.auth-popup .form-container button {
  margin: 10px 0;
  padding: 10px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.auth-popup .form-container button:hover {
  background-color: var(--primary-hover);
}

.auth-popup .toggle-auth {
  text-align: center;
  margin-top: 10px;
  cursor: pointer;
  color: var(--primary-color);
}

.auth-popup .toggle-auth:hover {
  text-decoration: underline;
}

/* Map Search Bar Styles */
.map-search-bar {
  position: absolute;
  top: 1rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem;
  z-index: 1000;
  background: rgba(255, 255, 255, 0.9);
  padding: 0.5rem;
  border-radius: 0.75rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  width: 90%;
  max-width: 400px;
}

.map-search-input {
  flex: 1;
  padding: 0.5rem 1rem;
  border: 2px solid #e5e7eb;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  outline: none;
  transition: all 0.2s;
}

.map-search-input:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.map-search-button {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 0.5rem;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.map-search-button:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
}

.map-search-button:active {
  transform: translateY(0);
}

/* Floating Menu Styles */
.floating-menu {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 1000;
}

.floating-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 50%;
  width: 3rem;
  height: 3rem;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  transition: all 0.2s;
}

.floating-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.1);
}

.menu-content {
  display: none;
  position: absolute;
  right: 0;
  bottom: 100%;
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  padding: 0.5rem;
  margin-bottom: 0.5rem;
}

.menu-content a {
  display: block;
  padding: 0.5rem 1rem;
  color: var(--text-color);
  text-decoration: none;
  border-radius: 0.25rem;
  transition: background 0.2s;
}

.menu-content a:hover {
  background: var(--bg-color);
}

/* Notification Styles */
.notification {
  position: fixed;
  top: 1rem;
  right: 1rem;
  padding: 1rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 500;
  z-index: 1100;
  transform: translateX(150%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: #ecfdf5;
  color: #047857;
  border: 1px solid #a7f3d0;
}

.notification.error {
  background: #fef2f2;
  color: #b91c1c;
  border: 1px solid #fecaca;
}

/* Responsive Styles */
@media (max-width: 640px) {
  .hero-content h1 {
    font-size: 2.5rem;
  }

  .hero-content p {
    font-size: 1.125rem;
  }

  .search-container {
    padding: 1rem;
    margin: 0 1rem;
  }

  .search-bar {
    flex-direction: column;
  }

  .search-button {
    width: 100%;
  }

  .auth-popup {
    width: 90%;
  }
}
  </style>
</head>
<body>
  <!-- Floating Menu -->
  <div class="floating-menu" id="floatingMenu">
    <button class="floating-btn" id="floatingBtn">â˜°</button>
    <div class="menu-content" id="menuContent">
      <a href="#" id="homeLink">Home</a>
      <a href="#" id="aboutLink">About Us</a>
      <a href="#" id="authLink">Login/Join</a> <!-- Dynamic link for login/logout -->
      <a href="#" id="placeholderLink1">Placeholder 1</a>
      <a href="#" id="placeholderLink2">Placeholder 2</a>
    </div>
  </div>

  <!-- Search Page -->
  <div class="page search-page" id="searchPage">
    <div class="hero-content">
      <h1>Community Markers</h1>
      <p>Discover and share meaningful places across Minnesota.</p>
      <div class="search-container">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput">
          <button class="search-button" id="searchButton">Search Location</button>
        </div>
      </div>
    </div>
    <div class="scroll-down" id="scrollDown">
      <span>View Map</span>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
      </svg>
    </div>
  </div>

  <!-- Map Page -->
  <div class="page map-page" id="mapPage">
    <div class="map-search-bar">
      <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput">
      <button class="map-search-button" id="mapSearchButton">Search</button>
    </div>
    <div id="map"></div>
  </div>

  <!-- Login/Join Popup -->
  <div class="auth-popup" id="authPopup">
    <button class="close-btn" id="closePopup">&times;</button>
    <div class="form-container" id="joinForm">
      <h3>Join</h3>
      <input type="text" id="joinName" placeholder="Name" required>
      <input type="email" id="joinEmail" placeholder="Email Address" required>
      <input type="password" id="joinPassword" placeholder="Password" required>
      <button id="joinButton">Join</button>
      <p class="toggle-auth" id="showLogin">Already have an account? Log In</p>
    </div>
    <div class="form-container" id="loginForm" style="display: none;">
      <h3>Log In</h3>
      <input type="email" id="loginEmail" placeholder="Email Address" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button id="loginButton">Log In</button>
      <p class="toggle-auth" id="showJoin">Don't have an account? Join</p>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  
  <script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
  authDomain: "mnthen-3151d.firebaseapp.com",
  projectId: "mnthen-3151d",
  storageBucket: "mnthen-3151d.appspot.com",
  messagingSenderId: "416231360428",
  appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// DOM Elements
const authPopup = document.getElementById('authPopup');
const closePopup = document.getElementById('closePopup');
const joinForm = document.getElementById('joinForm');
const loginForm = document.getElementById('loginForm');
const showLogin = document.getElementById('showLogin');
const showJoin = document.getElementById('showJoin');
const authLink = document.getElementById('authLink');
const joinButton = document.getElementById('joinButton');
const loginButton = document.getElementById('loginButton');
const notification = document.getElementById('notification');
const joinName = document.getElementById('joinName');
const joinEmail = document.getElementById('joinEmail');
const joinPassword = document.getElementById('joinPassword');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');

// Track user authentication state
auth.onAuthStateChanged((user) => {
  if (user) {
    // User is logged in
    authLink.textContent = 'Log Out';
    authLink.removeEventListener('click', openAuthPopup);
    authLink.addEventListener('click', handleLogout);
  } else {
    // User is logged out
    authLink.textContent = 'Login/Join';
    authLink.removeEventListener('click', handleLogout);
    authLink.addEventListener('click', openAuthPopup);
  }
});

// Open Login/Join Popup
function openAuthPopup(e) {
  e.preventDefault();
  authPopup.classList.add('active');
}

// Close Login/Join Popup
closePopup.addEventListener('click', () => {
  authPopup.classList.remove('active');
});

// Toggle between Join and Login forms
showLogin.addEventListener('click', () => {
  joinForm.style.display = 'none';
  loginForm.style.display = 'block';
});

showJoin.addEventListener('click', () => {
  loginForm.style.display = 'none';
  joinForm.style.display = 'block';
});

// Join Functionality
joinButton.addEventListener('click', () => {
  const email = joinEmail.value;
  const password = joinPassword.value;
  const name = joinName.value;

  if (!email || !password || !name) {
    showNotification('Please fill out all fields.', 'error');
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      const user = userCredential.user;
      return database.ref('users/' + user.uid).set({
        name: name,
        email: email
      });
    })
    .then(() => {
      showNotification('Join successful!', 'success');
      authPopup.classList.remove('active');
      joinForm.reset();
    })
    .catch((error) => {
      showNotification('Join failed: ' + error.message, 'error');
    });
});

// Login Functionality
loginButton.addEventListener('click', () => {
  const email = loginEmail.value;
  const password = loginPassword.value;

  if (!email || !password) {
    showNotification('Please fill out all fields.', 'error');
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      showNotification('Login successful!', 'success');
      authPopup.classList.remove('active');
      loginForm.reset();
    })
    .catch((error) => {
      showNotification('Login failed: ' + error.message, 'error');
    });
});

// Logout Functionality
function handleLogout(e) {
  e.preventDefault();
  auth.signOut()
    .then(() => {
      showNotification('Logged out successfully!', 'success');
    })
    .catch((error) => {
      showNotification('Logout failed: ' + error.message, 'error');
    });
}

// Show Notification
function showNotification(message, type) {
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = 'block';
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

// Initialize Map
let map = null;
let markers = null;
let tempMarker = null;
let markersData = JSON.parse(localStorage.getItem('markers') || [];

function initializeMap() {
  if (!map) {
    map = L.map('map', { zoomControl: false }).setView([44.9778, -93.2650], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '', // Remove attribution
      maxZoom: 16
    }).addTo(map);

    // Initialize markers as a marker cluster group
    markers = L.markerClusterGroup();
    map.addLayer(markers);

    // Add click handler for adding new markers
    map.on('click', function(e) {
      if (tempMarker) {
        map.removeLayer(tempMarker);
      }
      tempMarker = L.marker(e.latlng).addTo(map);
      markerModal.style.display = 'block';
    });

    // Load existing markers
    loadMarkers();
  }
}

// Load existing markers
function loadMarkers() {
  if (!markers) {
    console.error('Markers not initialized');
    return;
  }

  markers.clearLayers();

  if (!markersData) {
    markersData = [];
  }

  markersData.forEach(data => {
    const marker = L.marker([data.lat, data.lng]);
    const popupContent = `
      <div class="marker-popup">
        ${data.image ? `<img src="${data.image}" alt="${data.title}">` : ''}
        <h3>${data.title}</h3>
        <p>${data.description}</p>
        <p><small>Added on: ${new Date(data.date).toLocaleDateString()}</small></p>
      </div>
    `;
    marker.bindPopup(popupContent);
    markers.addLayer(marker);
  });
}

// Navigation
const scrollDown = document.getElementById('scrollDown');
const searchPage = document.getElementById('searchPage');
const mapPage = document.getElementById('mapPage');

scrollDown.addEventListener('click', () => {
  searchPage.style.transform = 'translateY(-100%)';
  mapPage.style.transform = 'translateY(0)';
  setTimeout(initializeMap, 500);
});

// Search handler
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const mapSearchInput = document.getElementById('mapSearchInput');
const mapSearchButton = document.getElementById('mapSearchButton');

function performSearch(query, inputElement) {
  if (!query) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Minnesota, USA')}`)
    .then(response => response.json())
    .then(data => {
      const minnesotaResults = data.filter(result => result.display_name.includes('Minnesota'));
      if (minnesotaResults.length > 0) {
        const { lat, lon } = minnesotaResults[0];
        searchPage.style.transform = 'translateY(-100%)';
        mapPage.style.transform = 'translateY(0)';
        
        setTimeout(() => {
          initializeMap();
          map.setView([parseFloat(lat), parseFloat(lon)], 13);
          showNotification('Location found in Minnesota!', 'success');
        }, 500);
      } else {
        showNotification('Location not found in Minnesota', 'error');
      }
    })
    .catch(() => {
      showNotification('Error searching location', 'error');
    })
    .finally(() => {
      // Clear the search input after the search is executed
      if (inputElement) {
        inputElement.value = '';
      }
    });
}

// Search on Enter key press (main search bar)
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    performSearch(this.value.trim(), this);
  }
});

// Search on button click (main search bar)
searchButton.addEventListener('click', () => {
  performSearch(searchInput.value.trim(), searchInput);
});

// Search on Enter key press (map search bar)
mapSearchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    performSearch(this.value.trim(), this);
  }
});

// Search on button click (map search bar)
mapSearchButton.addEventListener('click', () => {
  performSearch(mapSearchInput.value.trim(), mapSearchInput);
});

// Marker Form Submission
const markerModal = document.getElementById('markerModal');
const closeModal = document.getElementById('closeModal');
const markerForm = document.getElementById('markerForm');
const titleInput = document.getElementById('title');
const descriptionInput = document.getElementById('description');
const imageInput = document.getElementById('image');
const dateInput = document.getElementById('date');

markerForm.addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!tempMarker || !auth.currentUser) {
    showNotification('You must be logged in to add a marker.', 'error');
    return;
  }

  const newMarker = {
    title: titleInput.value.trim(),
    description: descriptionInput.value.trim(),
    image: imageInput.value.trim(),
    date: dateInput.value,
    lat: tempMarker.getLatLng().lat,
    lng: tempMarker.getLatLng().lng,
    timestamp: Date.now(),
    userId: auth.currentUser.uid // Associate marker with the logged-in user
  };

  markersData.push(newMarker);
  localStorage.setItem('markers', JSON.stringify(markersData));
  
  map.removeLayer(tempMarker);
  tempMarker = null;
  markerModal.style.display = 'none';
  markerForm.reset();
  
  loadMarkers();
  showNotification('Marker added successfully!', 'success');
});

// Modal close handler
closeModal.addEventListener('click', function() {
  markerModal.style.display = 'none';
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
});

// Click outside modal to close
window.addEventListener('click', function(e) {
  if (e.target === markerModal) {
    markerModal.style.display = 'none';
    if (tempMarker) {
      map.removeLayer(tempMarker);
      tempMarker = null;
    }
  }
});

// Initialize date input to today's date
dateInput.valueAsDate = new Date();

// Initialize markers on load
if (mapPage.style.transform === 'translateY(0)') {
  initializeMap();
}
  </script>
</body>
</html>
