<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunFlow - Professional Running Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00c6ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RunFlow">
    <meta name="description" content="Your professional running companion with GPS tracking, splits, and achievements">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://images.unsplash.com/photo-1544717297-fa95b6ee9643?w=192&h=192&fit=crop&crop=center">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html, body {
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }
        
        body {
            background-color: #0a0a0a;
            color: #ffffff;
        }

        /* Animation keyframes */
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* Common page styles */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            overflow: hidden;
        }

        .page.hidden {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }

        .page.slide-in-right {
            transform: translateX(100%);
            opacity: 0;
        }

        .page.active {
            transform: translateX(0);
            opacity: 1;
        }

        /* Splash Page */
        .splash-page {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8)), 
                        url('https://images.pexels.com/photos/2402777/pexels-photo-2402777.jpeg?auto=compress&cs=tinysrgb&w=1920&h=1080&fit=crop') no-repeat center center;
            background-size: cover;
            color: white;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .splash-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bounceIn 1.5s ease-out;
            color: #00c6ff;
            text-shadow: 0 4px 20px rgba(0, 198, 255, 0.3);
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            animation: fadeInUp 1s ease-out 0.5s both;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .splash-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            animation: fadeInUp 1s ease-out 0.7s both;
            color: rgba(255, 255, 255, 0.9);
        }

        .splash-loading {
            margin-top: 2rem;
            animation: fadeInUp 1s ease-out 1s both;
        }

        .gps-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #00c6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Login Page - Optimized for viewport */
        .login-page {
            background: linear-gradient(135deg, 
                rgba(0, 10, 30, 0.95) 0%, 
                rgba(0, 30, 60, 0.9) 25%, 
                rgba(0, 50, 100, 0.85) 50%, 
                rgba(0, 120, 180, 0.8) 75%, 
                rgba(0, 198, 255, 0.7) 100%), 
                url('https://images.pexels.com/photos/1333525/pexels-photo-1333525.jpeg?auto=compress&cs=tinysrgb&w=1920&h=1080&fit=crop') no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow-y: auto;
        }

        .login-header {
            width: 100%;
            max-width: 480px;
            text-align: center;
            flex-shrink: 0;
            animation: slideInDown 1s ease-out;
            padding-top: 1rem;
        }

        .login-logo {
            font-size: 3.5rem;
            color: #00c6ff;
            margin-bottom: 0.75rem;
            text-shadow: 0 8px 32px rgba(0, 198, 255, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #e0f2ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        .login-tagline {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .login-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-form-container {
            width: 100%;
            max-width: 380px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInUp 1s ease-out 0.3s both;
            min-height: 0;
        }

        .auth-forms {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        .input-group {
            position: relative;
            width: 100%;
        }

        .login-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.15);
            font-weight: 500;
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .login-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(0, 198, 255, 0.6);
            box-shadow: 0 0 0 4px rgba(0, 198, 255, 0.15);
            transform: translateY(-1px);
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .login-btn {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 114, 255, 0.3);
            letter-spacing: 0.5px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 114, 255, 0.4);
        }

        .signup-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.25);
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .signup-btn:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .guest-btn {
            background: transparent;
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .guest-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .divider {
            margin: 1rem 0;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            position: relative;
            width: 100%;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.25);
        }

        .divider span {
            background: rgba(0, 10, 30, 0.8);
            padding: 0 1rem;
            position: relative;
            z-index: 1;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .login-footer {
            flex-shrink: 0;
            padding: 1rem;
            text-align: center;
        }

        .login-footer-text {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            line-height: 1.4;
            max-width: 380px;
        }

        /* Main App Page */
        .main-page {
            background-color: #0a0a0a;
            display: flex;
            flex-direction: column;
            height: 100%;
            height: 100dvh;
        }
        
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header - Compact */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            height: 60px;
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            color: #00c6ff;
            text-shadow: 0 2px 10px rgba(0, 198, 255, 0.3);
        }
        
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .exit-btn {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .exit-btn:hover {
            background: rgba(239, 68, 68, 0.25);
            transform: translateY(-1px);
        }
        
        /* Main Content - Scrollable container */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            overflow-y: auto;
            min-height: 0;
            gap: 1rem;
        }
        
        /* GPS Loading Overlay */
        .gps-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
        }

        .gps-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .gps-loading-content {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 16px;
            padding: 2rem 1.5rem;
            text-align: center;
            max-width: 280px;
            width: 90%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .gps-loading .gps-spinner {
            width: 50px;
            height: 50px;
            margin-bottom: 1rem;
        }

        .gps-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .gps-subtext {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }
        
        /* Time Display - Compact */
        .time-display {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(40, 40, 40, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem 1rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .time-text {
            font-size: clamp(2rem, 7vw, 3.5rem);
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
            line-height: 1;
            text-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }
        
        .time-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        /* Stats Grid - Compact */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        .stat-box {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(40, 40, 40, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 1rem 0.75rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-box:hover {
            transform: translateY(-1px);
            border-color: rgba(0, 198, 255, 0.2);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }
        
        .stat-value {
            font-size: clamp(1.25rem, 3.5vw, 1.5rem);
            font-weight: 800;
            margin-bottom: 0.375rem;
            color: #00c6ff;
            text-shadow: 0 2px 10px rgba(0, 198, 255, 0.2);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            margin-bottom: 0.125rem;
            letter-spacing: 0.5px;
        }
        
        .stat-note {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Controls - Compact */
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .control-btn {
            padding: 0.875rem 0.25rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            min-height: 70px;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .start-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.4);
        }
        
        .pause-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .pause-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(245, 158, 11, 0.4);
        }
        
        .stop-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .stop-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(239, 68, 68, 0.4);
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }
        
        .reset-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #475569, #334155);
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(100, 116, 139, 0.4);
        }
        
        .control-btn i {
            font-size: 1.1rem;
        }
        
        .control-btn span {
            font-size: 0.7rem;
        }
        
        /* Action Buttons - Three in a row */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .action-btn {
            padding: 0.875rem 0.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9), rgba(40, 40, 40, 0.9));
            backdrop-filter: blur(20px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            min-height: 50px;
        }
        
        .action-btn:hover {
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.9), rgba(50, 50, 50, 0.9));
            transform: translateY(-1px);
            border-color: rgba(0, 198, 255, 0.3);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }
        
        .action-btn i {
            font-size: 0.9rem;
        }
        
        /* Disabled state */
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Modal Base Styles - Optimized for mobile */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(40, 40, 40, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            max-height: 85dvh;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            padding: 1.25rem 1.25rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 0;
        }
        
        .modal-close {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .modal-close:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
        }
        
        .modal-content {
            padding: 1.25rem;
            overflow-y: auto;
            color: rgba(255, 255, 255, 0.9);
            flex: 1;
            min-height: 0;
        }

        /* Enhanced Info Modal Styles */
        .info-section {
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .info-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #00c6ff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-section-title i {
            font-size: 1.1rem;
        }
        
        .info-section-content {
            line-height: 1.5;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .info-section-content p {
            margin-bottom: 0.75rem;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0.75rem 0;
        }

        .feature-list li {
            padding: 0.625rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        .feature-icon {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .feature-text {
            flex: 1;
        }

        .feature-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.125rem;
            font-size: 0.9rem;
        }

        .feature-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        .privacy-notice {
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.2);
            border-radius: 10px;
            padding: 0.875rem;
            margin: 1rem 0;
        }

        .privacy-notice h4 {
            color: #00c6ff;
            margin-bottom: 0.375rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .privacy-notice p {
            font-size: 0.8rem;
            line-height: 1.4;
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .coffee-card {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 14px;
            padding: 1rem;
            text-align: center;
            margin-top: 1.25rem;
            border: 1px solid rgba(245, 158, 11, 0.2);
            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.15);
        }

        .coffee-card h4 {
            color: #ffffff;
            margin-bottom: 0.375rem;
            font-size: 1rem;
            font-weight: 700;
        }

        .coffee-card p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.75rem;
            line-height: 1.4;
            font-size: 0.85rem;
        }
        
        .coffee-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.625rem 1.25rem;
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .coffee-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.1);
        }

        .coffee-link i {
            font-size: 1rem;
        }
        
        /* Splits Table - Compact */
        .splits-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 0.75rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(20, 20, 20, 0.5);
        }
        
        .splits-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .splits-table th {
            background: rgba(0, 198, 255, 0.1);
            padding: 0.625rem 0.5rem;
            text-align: left;
            font-weight: 700;
            color: #00c6ff;
            font-size: 0.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }
        
        .splits-table td {
            padding: 0.625rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .splits-table tr:last-child td {
            border-bottom: none;
        }

        .splits-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            width: 100%;
            margin-top: 1rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }
        
        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.4);
        }
        
        .export-btn i {
            font-size: 1rem;
        }

        /* Route Modal Styles - Compact */
        .route-map {
            height: 200px;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 12px;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .route-map-placeholder {
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            padding: 1.25rem;
        }

        .route-map-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: rgba(0, 198, 255, 0.3);
        }

        .route-map-placeholder h4 {
            font-size: 1rem;
            margin: 0.75rem 0 0.375rem;
            color: #ffffff;
        }

        .route-map-placeholder p {
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .route-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .route-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 0.75rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .route-stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: #00c6ff;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 10px rgba(0, 198, 255, 0.2);
        }
        
        .route-stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }
        
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .share-btn {
            padding: 0.75rem 0.375rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        
        .share-btn.facebook {
            background: linear-gradient(135deg, #3b5998, #2d4373);
            color: white;
        }
        
        .share-btn.linkedin {
            background: linear-gradient(135deg, #0077b5, #005885);
            color: white;
        }
        
        .share-btn.bluesky {
            background: linear-gradient(135deg, #1185fe, #0a6edb);
            color: white;
        }
        
        .share-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .guest-message {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 1rem;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        /* Achievements Modal - Compact */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .achievement-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem 0.75rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .achievement-card.earned {
            background: linear-gradient(135deg, rgba(0, 198, 255, 0.15), rgba(0, 114, 255, 0.15));
            border-color: rgba(0, 198, 255, 0.3);
            transform: scale(1.02);
        }
        
        .achievement-icon {
            font-size: 1.75rem;
            margin-bottom: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }
        
        .achievement-card.earned .achievement-icon {
            color: #00c6ff;
            text-shadow: 0 4px 20px rgba(0, 198, 255, 0.3);
        }
        
        .achievement-title {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.125rem;
            color: #ffffff;
        }
        
        .achievement-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.3;
        }
        
        .stats-grid-achievements {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .stat-achievement {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem 0.625rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value-achievement {
            font-size: 1.3rem;
            font-weight: 800;
            color: #00c6ff;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 10px rgba(0, 198, 255, 0.2);
        }
        
        .stat-label-achievement {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        /* Confirmation Modal */
        .confirmation-modal .modal-header {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .confirmation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }
        
        .confirm-btn {
            padding: 0.875rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .confirm-yes {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .confirm-yes:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(239, 68, 68, 0.4);
        }
        
        .confirm-no {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .confirm-no:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Toast notifications - Compact */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(40, 40, 40, 0.95));
            backdrop-filter: blur(20px);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 320px;
            width: 90%;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Install Prompt - Compact */
        .install-prompt {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(40, 40, 40, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1500;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            width: 90%;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        
        .install-prompt.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .install-prompt p {
            flex: 1;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            font-weight: 600;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        
        .install-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 114, 255, 0.4);
        }
        
        .close-install {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .close-install:hover {
            color: rgba(255, 255, 255, 1);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Leaflet Map Customization */
        .leaflet-container {
            background: #1a1a1a;
            height: 100%;
            width: 100%;
            border-radius: 12px;
        }
        
        .leaflet-control-zoom {
            display: none !important;
        }
        
        .leaflet-popup-content {
            color: #333;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
            flex-direction: column;
        }

        .loading-spinner {
            width: 28px;
            height: 28px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #00c6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5rem;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 480px) {
            .page {
                height: 100vh;
                height: 100dvh;
            }

            .login-page {
                padding: 0.75rem;
                justify-content: flex-start;
            }
            
            .login-header {
                padding-top: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .login-logo {
                font-size: 3rem;
                margin-bottom: 0.5rem;
            }
            
            .login-title {
                font-size: 2rem;
                margin-bottom: 0.375rem;
            }
            
            .login-tagline {
                font-size: 1rem;
                margin-bottom: 0.375rem;
            }
            
            .login-subtitle {
                font-size: 0.8rem;
                max-width: 320px;
            }
            
            .login-form-container {
                flex: 1;
                max-width: 320px;
                margin: 0;
                padding: 0;
                min-height: 0;
            }

            .auth-forms {
                gap: 0.75rem;
            }

            .login-form {
                gap: 0.75rem;
            }

            .login-input {
                padding: 0.875rem 0.875rem 0.875rem 2.75rem;
                font-size: 0.9rem;
            }

            .input-icon {
                left: 0.875rem;
                font-size: 0.9rem;
            }

            .login-btn, .signup-btn, .guest-btn {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }

            .divider {
                margin: 0.75rem 0;
            }

            .login-footer {
                padding: 0.75rem;
            }

            .login-footer-text {
                font-size: 0.75rem;
                max-width: 320px;
            }
            
            header {
                padding: 0.625rem 0.875rem;
                height: 52px;
            }
            
            .logo {
                font-size: 1.1rem;
            }

            .header-btn, .exit-btn {
                width: 2rem;
                height: 2rem;
                font-size: 0.8rem;
            }
            
            .main-content {
                padding: 0.625rem;
                gap: 0.75rem;
            }
            
            .time-display {
                padding: 1.25rem 1rem;
            }
            
            .time-text {
                font-size: clamp(1.8rem, 6vw, 2.5rem);
            }

            .time-label {
                font-size: 0.8rem;
            }
            
            .stats-grid {
                gap: 0.5rem;
            }
            
            .stat-box {
                padding: 0.875rem 0.5rem;
            }

            .stat-value {
                font-size: clamp(1.1rem, 3vw, 1.3rem);
                margin-bottom: 0.25rem;
            }

            .stat-label {
                font-size: 0.65rem;
            }

            .stat-note {
                font-size: 0.6rem;
            }
            
            .controls {
                gap: 0.375rem;
            }
            
            .control-btn {
                padding: 0.75rem 0.125rem;
                font-size: 0.65rem;
                min-height: 60px;
            }
            
            .control-btn i {
                font-size: 1rem;
            }

            .control-btn span {
                font-size: 0.6rem;
            }
            
            .action-buttons {
                gap: 0.375rem;
            }
            
            .action-btn {
                padding: 0.75rem 0.375rem;
                font-size: 0.7rem;
                min-height: 45px;
            }

            .action-btn i {
                font-size: 0.8rem;
            }
            
            .modal {
                margin: 0.75rem;
                max-height: 90vh;
                max-height: 90dvh;
            }
            
            .modal-content {
                padding: 1rem;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-title {
                font-size: 1.1rem;
            }
            
            .achievement-grid {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }

            .stats-grid-achievements {
                grid-template-columns: 1fr 1fr;
                gap: 0.625rem;
            }
            
            .share-buttons {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .route-map {
                height: 180px;
            }

            .splits-container {
                max-height: 200px;
            }

            .feature-list li {
                gap: 0.5rem;
                padding: 0.5rem 0;
            }

            .feature-icon {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.8rem;
            }

            .feature-title {
                font-size: 0.85rem;
            }

            .feature-desc {
                font-size: 0.75rem;
            }

            .info-section-title {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .info-section-content {
                font-size: 0.85rem;
            }

            .info-section {
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
            }
        }

        /* Very small screens */
        @media (max-width: 360px) {
            .login-form-container {
                max-width: 290px;
            }

            .login-header {
                padding-top: 1rem;
            }

            .login-logo {
                font-size: 2.5rem;
            }

            .login-title {
                font-size: 1.75rem;
            }

            .controls {
                gap: 0.25rem;
            }
            
            .control-btn {
                padding: 0.625rem 0.125rem;
                min-height: 55px;
            }

            .control-btn i {
                font-size: 0.9rem;
            }

            .control-btn span {
                font-size: 0.55rem;
            }
            
            .action-buttons {
                gap: 0.25rem;
            }
            
            .action-btn {
                padding: 0.625rem 0.25rem;
                font-size: 0.65rem;
                min-height: 40px;
            }

            .action-btn i {
                font-size: 0.75rem;
            }
            
            .stats-grid {
                gap: 0.375rem;
            }
            
            .stat-box {
                padding: 0.75rem 0.375rem;
            }
        }

        /* Larger screens optimization */
        @media (min-width: 768px) {
            .achievement-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .stats-grid-achievements {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .modal {
                max-width: 600px;
            }

            .login-form-container {
                max-width: 420px;
            }

            .main-content {
                max-width: 600px;
                margin: 0 auto;
                padding: 1rem;
            }

            .time-display {
                padding: 2rem 1.5rem;
            }

            .stats-grid {
                gap: 1rem;
            }

            .controls {
                gap: 0.75rem;
            }

            .action-buttons {
                gap: 0.75rem;
            }

            .control-btn {
                padding: 1rem 0.5rem;
                font-size: 0.8rem;
                min-height: 75px;
            }

            .action-btn {
                padding: 1rem 0.75rem;
                font-size: 0.85rem;
                min-height: 55px;
            }
        }

        /* Desktop optimization */
        @media (min-width: 1024px) {
            .main-content {
                max-width: 700px;
            }

            .login-form-container {
                max-width: 450px;
            }
        }

        /* Landscape orientation on mobile - Critical fix */
        @media (max-height: 600px) and (orientation: landscape) {
            .login-page {
                overflow-y: scroll;
                justify-content: flex-start;
                padding: 0.5rem;
            }

            .login-header {
                padding-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .login-logo {
                font-size: 2.5rem;
                margin-bottom: 0.375rem;
            }
            
            .login-title {
                font-size: 2rem;
                margin-bottom: 0.25rem;
            }
            
            .login-tagline {
                font-size: 0.95rem;
                margin-bottom: 0.25rem;
            }

            .login-subtitle {
                font-size: 0.8rem;
            }
            
            .login-form-container {
                margin: 0;
                padding: 0;
                flex: 0 0 auto;
            }

            .auth-forms {
                gap: 0.625rem;
            }

            .login-form {
                gap: 0.625rem;
            }

            .login-input {
                padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            }

            .login-btn, .signup-btn, .guest-btn {
                padding: 0.75rem 1.25rem;
            }

            .divider {
                margin: 0.625rem 0;
            }

            .login-footer {
                padding: 0.5rem;
                flex-shrink: 0;
            }

            .login-footer-text {
                font-size: 0.7rem;
            }
            
            .time-display {
                padding: 1rem;
            }
            
            .stats-grid {
                margin-bottom: 0.75rem;
            }
            
            .controls {
                margin-bottom: 0.75rem;
            }
            
            .gps-loading-content {
                padding: 1.5rem 1.25rem;
            }

            .main-content {
                gap: 0.625rem;
            }
        }

        /* Very short screens */
        @media (max-height: 500px) {
            .login-page {
                padding: 0.25rem;
            }

            .login-header {
                padding-top: 0.25rem;
                margin-bottom: 0.25rem;
            }

            .login-logo {
                font-size: 2rem;
                margin-bottom: 0.25rem;
            }

            .login-title {
                font-size: 1.5rem;
                margin-bottom: 0.125rem;
            }

            .login-tagline {
                font-size: 0.85rem;
                margin-bottom: 0.125rem;
            }

            .login-subtitle {
                display: none;
            }

            .login-form {
                gap: 0.5rem;
            }

            .auth-forms {
                gap: 0.5rem;
            }

            .login-input {
                padding: 0.625rem 0.625rem 0.625rem 2.25rem;
            }

            .login-btn, .signup-btn, .guest-btn {
                padding: 0.625rem 1rem;
                font-size: 0.85rem;
            }

            .divider {
                margin: 0.5rem 0;
            }

            .login-footer {
                display: none;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2) {
            .time-text, .stat-value {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Safe area handling for notch devices */
        @supports (padding: max(0px)) {
            .page {
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            header {
                padding-top: max(0.75rem, env(safe-area-inset-top));
            }

            .login-page {
                padding-top: max(0.75rem, env(safe-area-inset-top));
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }

            .main-content {
                padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <p>Install RunFlow for the best experience</p>
        <button class="install-btn" id="installBtn">Install</button>
        <button class="close-install" id="closeInstall"></button>
    </div>

    <!-- Splash Page -->
    <div class="page splash-page active" id="splashPage">
        <div class="splash-logo">
            <i class="fas fa-running"></i>
        </div>
        <h1 class="splash-title">RunFlow</h1>
        <p class="splash-subtitle">Your professional running companion</p>
        <div class="splash-loading">
            <div class="gps-spinner"></div>
        </div>
    </div>

    <!-- Login Page - Optimized layout -->
    <div class="page login-page hidden" id="loginPage">
        <div class="login-header">
            <div class="login-logo">
                <i class="fas fa-running"></i>
            </div>
            <h1 class="login-title">RunFlow</h1>
            <p class="login-tagline">Professional Running Tracker</p>
            <p class="login-subtitle">Track every step with precision GPS, detailed splits, and achievements</p>
        </div>
        
        <div class="login-form-container">
            <div class="auth-forms">
                <!-- Login Form -->
                <form class="login-form" id="loginForm">
                    <div class="input-group">
                        <i class="input-icon fas fa-envelope"></i>
                        <input type="email" class="login-input" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="input-group">
                        <i class="input-icon fas fa-lock"></i>
                        <input type="password" class="login-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="login-btn">Sign In</button>
                </form>
                
                <button class="signup-btn" id="signupBtn">Create New Account</button>
                
                <div class="divider">
                    <span>or</span>
                </div>
                
                <button class="guest-btn" id="guestBtn">Continue as Guest</button>
            </div>
        </div>

        <div class="login-footer">
            <p class="login-footer-text">
                Experience professional GPS tracking, mile splits, route visualization, and achievement tracking with thousands of runners worldwide.
            </p>
        </div>
    </div>

    <!-- Main App Page -->
    <div class="page main-page hidden" id="mainPage">
        <!-- GPS Loading Overlay -->
        <div class="gps-loading" id="gpsLoading">
            <div class="gps-loading-content">
                <div class="gps-spinner"></div>
                <div class="gps-text">Connecting to GPS...</div>
                <div class="gps-subtext">This may take a few moments for the best accuracy</div>
            </div>
        </div>

        <div class="container">
            <header>
                <div class="logo">
                    <i class="fas fa-running"></i> RunFlow
                </div>
                <div class="header-buttons">
                    <button class="header-btn" id="achievementsBtn" title="Achievements">
                        <i class="fas fa-trophy"></i>
                    </button>
                    <button class="exit-btn" id="exitBtn" title="Exit"></button>
                </div>
            </header>
            
            <div class="main-content">
                <div class="time-display" id="timeDisplay">
                    <div class="time-text">00:00</div>
                    <div class="time-label">TIME</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="distanceValue">0.00</div>
                        <div class="stat-label">DISTANCE</div>
                        <div class="stat-note">miles</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="paceValue">--:--</div>
                        <div class="stat-label">CURRENT PACE</div>
                        <div class="stat-note">min/mile</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="currentMileValue">0</div>
                        <div class="stat-label">CURRENT MILE</div>
                        <div class="stat-note">mile marker</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="milePaceValue">--:--</div>
                        <div class="stat-label">MILE PACE</div>
                        <div class="stat-note">this mile pace</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="control-btn start-btn" id="startBtn" disabled>
                        <i class="fas fa-play"></i>
                        <span>Start</span>
                    </button>
                    <button class="control-btn pause-btn" id="pauseBtn" disabled>
                        <i class="fas fa-pause"></i>
                        <span>Pause</span>
                    </button>
                    <button class="control-btn stop-btn" id="stopBtn" disabled>
                        <i class="fas fa-stop"></i>
                        <span>Stop</span>
                    </button>
                    <button class="control-btn reset-btn" id="resetBtn">
                        <i class="fas fa-redo"></i>
                        <span>Reset</span>
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" id="routeBtn">
                        <i class="fas fa-route"></i> Route
                    </button>
                    <button class="action-btn" id="splitsBtn">
                        <i class="fas fa-chart-line"></i> Splits
                    </button>
                    <button class="action-btn" id="infoBtn">
                        <i class="fas fa-info-circle"></i> Info
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Info Modal -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-info-circle"></i> About RunFlow
                </h3>
                <button class="modal-close" id="closeInfoModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-rocket"></i>
                        Welcome to RunFlow
                    </h4>
                    <div class="info-section-content">
                        <p>RunFlow is your professional running companion, designed to help you track every step of your journey with precision and style. Whether you're a beginner or a seasoned marathoner, RunFlow provides the tools you need to achieve your goals.</p>
                    </div>
                </div>

                <div class="privacy-notice">
                    <h4><i class="fas fa-shield-alt"></i> Location Services</h4>
                    <p>RunFlow uses GPS to track your distance, pace, and route. Data is processed locally and never shared. You can disable location services anytime.</p>
                </div>
                
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-play-circle"></i>
                        Key Features
                    </h4>
                    <div class="info-section-content">
                        <ul class="feature-list">
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-satellite"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">GPS Tracking</div>
                                    <div class="feature-desc">High-accuracy GPS for precise distance and pace</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-stopwatch"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Real-time Metrics</div>
                                    <div class="feature-desc">Monitor pace, distance, and time as you run</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Route Visualization</div>
                                    <div class="feature-desc">View your route on an interactive map</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Split Analysis</div>
                                    <div class="feature-desc">Track pace for each mile to improve consistency</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Achievements</div>
                                    <div class="feature-desc">Earn badges and track milestone progress</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-share-alt"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Social Sharing</div>
                                    <div class="feature-desc">Share achievements on social media</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-question-circle"></i>
                        How to Use RunFlow
                    </h4>
                    <div class="info-section-content">
                        <ul class="feature-list">
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Start Your Run</div>
                                    <div class="feature-desc">Press Start to begin GPS tracking and timer</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-pause"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Pause & Resume</div>
                                    <div class="feature-desc">Take breaks without losing progress</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-stop"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Finish Your Run</div>
                                    <div class="feature-desc">Press Stop to end session and save achievements</div>
                                </div>
                            </li>
                            <li>
                                <div class="feature-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="feature-text">
                                    <div class="feature-title">Export Data</div>
                                    <div class="feature-desc">Download running data in CSV format</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="coffee-card">
                    <h4><i class="fas fa-coffee"></i> Support RunFlow</h4>
                    <p>Your support helps keep this app free and improving for runners!</p>
                    <a href="https://www.buymeacoffee.com/runflow" target="_blank" class="coffee-link">
                        <i class="fas fa-heart"></i> Buy me a coffee
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Splits Modal -->
    <div class="modal-overlay" id="splitsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-chart-line"></i> Run Splits
                </h3>
                <button class="modal-close" id="closeSplitsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p>Track your pace consistency with detailed split analysis. Your split times will appear here as you complete each mile.</p>
                <div class="splits-container">
                    <table class="splits-table">
                        <thead>
                            <tr>
                                <th>Mile</th>
                                <th>Split Time</th>
                                <th>Pace</th>
                            </tr>
                        </thead>
                        <tbody id="splitsTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 1.5rem;">
                                    <div class="loading-state">
                                        <i class="fas fa-running" style="font-size: 1.75rem; margin-bottom: 0.75rem; color: rgba(255,255,255,0.3);"></i>
                                        <div>Start your run to see splits here</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button class="export-btn" id="exportDataBtn">
                    <i class="fas fa-download"></i> Export Running Data
                </button>
            </div>
        </div>
    </div>

    <!-- Route Modal -->
    <div class="modal-overlay" id="routeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-route"></i> Your Route
                </h3>
                <button class="modal-close" id="closeRouteModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="route-map" id="routeMap">
                    <div class="route-map-placeholder" id="routeMapPlaceholder">
                        <i class="fas fa-map-marked-alt"></i>
                        <h4>Route Visualization</h4>
                        <p>Your running route will appear here after you complete a run with GPS tracking.</p>
                    </div>
                </div>
                
                <div class="route-stats">
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeDistance">0.00</div>
                        <div class="route-stat-label">Total Distance (miles)</div>
                    </div>
                    <div class="route-stat">
                        <div class="route-stat-value" id="routeTime">00:00</div>
                        <div class="route-stat-label">Total Time</div>
                    </div>
                </div>
                
                <div id="shareSection" class="hidden">
                    <h4 class="info-section-title">
                        <i class="fas fa-share-alt"></i>
                        Share Your Achievement
                    </h4>
                    <div class="share-buttons">
                        <button class="share-btn facebook" id="shareFacebook">
                            <i class="fab fa-facebook-f"></i> Facebook
                        </button>
                        <button class="share-btn linkedin" id="shareLinkedIn">
                            <i class="fab fa-linkedin-in"></i> LinkedIn
                        </button>
                        <button class="share-btn bluesky" id="shareBlueSky">
                            <i class="fas fa-cloud"></i> BlueSky
                        </button>
                    </div>
                </div>
                
                <div id="guestMessage" class="guest-message">
                    <p><i class="fas fa-info-circle"></i> Create an account to share your runs and save achievements</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal-overlay" id="achievementsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-trophy"></i> Your Achievements
                </h3>
                <button class="modal-close" id="closeAchievementsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="userWelcome">
                    <h4 class="info-section-title">
                        <i class="fas fa-user-circle"></i>
                        Welcome, <span id="userName">Runner</span>!
                    </h4>
                    <p>Track your progress and earn badges as you reach new milestones.</p>
                </div>
                
                <div id="guestAchievementsMessage" class="guest-message">
                    <p><i class="fas fa-info-circle"></i> Create an account to permanently save achievements and track progress over time.</p>
                </div>
                
                <div class="stats-grid-achievements">
                    <div class="stat-achievement">
                        <div class="stat-value-achievement" id="totalRuns">0</div>
                        <div class="stat-label-achievement">Total Runs</div>
                    </div>
                    <div class="stat-achievement">
                        <div class="stat-value-achievement" id="totalDistance">0.0</div>
                        <div class="stat-label-achievement">Total Miles</div>
                    </div>
                    <div class="stat-achievement">
                        <div class="stat-value-achievement" id="bestMile">--:--</div>
                        <div class="stat-label-achievement">Best Mile</div>
                    </div>
                    <div class="stat-achievement">
                        <div class="stat-value-achievement" id="longestRun">0.0</div>
                        <div class="stat-label-achievement">Longest Run</div>
                    </div>
                </div>
                
                <h4 class="info-section-title">
                    <i class="fas fa-medal"></i>
                    Achievement Badges
                </h4>
                <div class="achievement-grid">
                    <div class="achievement-card" id="firstRunBadge">
                        <div class="achievement-icon">
                            <i class="fas fa-shoe-prints"></i>
                        </div>
                        <div class="achievement-title">First Steps</div>
                        <div class="achievement-desc">Complete your first run</div>
                    </div>
                    
                    <div class="achievement-card" id="fiveKBadge">
                        <div class="achievement-icon">
                            <i class="fas fa-road"></i>
                        </div>
                        <div class="achievement-title">5K Runner</div>
                        <div class="achievement-desc">Run 3.1 miles</div>
                    </div>
                    
                    <div class="achievement-card" id="tenKBadge">
                        <div class="achievement-icon">
                            <i class="fas fa-medal"></i>
                        </div>
                        <div class="achievement-title">10K Champion</div>
                        <div class="achievement-desc">Complete 6.2 miles</div>
                    </div>
                    
                    <div class="achievement-card" id="halfMarathonBadge">
                        <div class="achievement-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="achievement-title">Half Marathon</div>
                        <div class="achievement-desc">Run 13.1 miles</div>
                    </div>
                    
                    <div class="achievement-card" id="marathonBadge">
                        <div class="achievement-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="achievement-title">Marathoner</div>
                        <div class="achievement-desc">Complete 26.2 miles</div>
                    </div>
                    
                    <div class="achievement-card" id="speedsterBadge">
                        <div class="achievement-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="achievement-title">Speedster</div>
                        <div class="achievement-desc">Sub-7 minute mile</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i> Create Account
                </h3>
                <button class="modal-close" id="closeSignupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p style="margin-bottom: 1.25rem; color: rgba(255,255,255,0.8);">Join RunFlow to save achievements, track progress, and share runs with the community.</p>
                <form class="login-form" id="signupFormModal">
                    <div class="input-group">
                        <i class="input-icon fas fa-user"></i>
                        <input type="text" class="login-input" id="signupNameModal" placeholder="Full Name" required>
                    </div>
                    <div class="input-group">
                        <i class="input-icon fas fa-envelope"></i>
                        <input type="email" class="login-input" id="signupEmailModal" placeholder="Email Address" required>
                    </div>
                    <div class="input-group">
                        <i class="input-icon fas fa-lock"></i>
                        <input type="password" class="login-input" id="signupPasswordModal" placeholder="Password (minimum 6 characters)" required minlength="6">
                    </div>
                    <button type="submit" class="login-btn">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div class="modal-overlay" id="exitModal">
        <div class="modal confirmation-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-sign-out-alt"></i> Exit RunFlow?
                </h3>
                <button class="modal-close" id="closeExitModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p style="font-size: 0.95rem; text-align: center; margin-bottom: 0.5rem;">Are you sure you want to exit RunFlow?</p>
                <p style="color: rgba(255,255,255,0.7); text-align: center; font-size: 0.85rem;">Your current run progress will be saved and achievements preserved.</p>
                <div class="confirmation-buttons">
                    <button class="confirm-btn confirm-yes" id="confirmExit">
                        <i class="fas fa-check"></i> Yes, Exit
                    </button>
                    <button class="confirm-btn confirm-no" id="cancelExit">
                        <i class="fas fa-times"></i> Stay in App
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- External Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCvpVXgRQILCamgyjVikQ_MVXBfXDjmStE",
        authDomain: "runflow-7d91b.firebaseapp.com",
        projectId: "runflow-7d91b",
        storageBucket: "runflow-7d91b.firebasestorage.app",
        messagingSenderId: "1037165713733",
        appId: "1:1037165713733:web:24c5e965f64e76d7ce462c",
        measurementId: "G-5YV2V8WBFQ"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;

        console.log('Firebase initialized successfully with version 10.14.1');
        
        // Check for existing authenticated user
        onAuthStateChanged(auth, async (user) => {
            if (user && !window.runflowApp?.state?.currentUser) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (window.runflowApp) {
                            window.runflowApp.state.currentUser = {
                                email: user.email,
                                displayName: userData.displayName,
                                achievements: userData.achievements || window.runflowApp.state.achievements
                            };
                            window.runflowApp.state.achievements = userData.achievements || window.runflowApp.state.achievements;
                        }
                    }
                } catch (error) {
                    console.log('Could not load user data from Firebase');
                }
            }
        });
        
    } catch (error) {
        console.error('Firebase initialization error:', error);
        console.log('Running in offline mode with local storage');
    }
</script>
    
    <script>
        // App state
        let state = {
            running: false,
            paused: false,
            startTime: 0,
            pausedTime: 0,
            elapsedTime: 0,
            totalDistance: 0,
            splits: [],
            currentSplitStartTime: 0,
            currentSplitDistance: 0,
            currentSplitElapsedTime: 0,
            gpsReady: false,
            currentUser: null,
            lastPosition: null,
            lastPaceCalculationTime: 0,
            lastPaceCalculationDistance: 0,
            deferredPrompt: null,
            routePositions: [],
            achievements: {
                totalRuns: 0,
                totalDistance: 0,
                bestMile: Infinity,
                longestRun: 0,
                badges: {
                    firstRun: false,
                    fiveK: false,
                    tenK: false,
                    halfMarathon: false,
                    marathon: false,
                    speedster: false
                }
            },
            map: null,
            routePolyline: null
        };

        // Make state available globally for Firebase auth callback
        window.runflowApp = { state };

        // Page management
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden', 'slide-in-right');
                    page.classList.add('active');
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('active');
                }
            });
        }

        // Toast notification
        function showToast(message, duration = 4000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Initialize splash page
        function initSplash() {
            setTimeout(() => {
                showPage('loginPage');
            }, 3500);
        }

        // Firebase Authentication Helper
        async function createUser(email, password, displayName) {
            if (window.firebaseAuth && window.firebaseCreateUser) {
                try {
                    const userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
                    const user = userCredential.user;
                    
                    // Save user profile to Firestore
                    await window.firebaseSetDoc(window.firebaseDoc(window.firebaseDb, 'users', user.uid), {
                        displayName: displayName,
                        email: email,
                        createdAt: new Date(),
                        achievements: state.achievements
                    });
                    
                    return { user, displayName };
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        throw new Error('An account with this email already exists');
                    } else if (error.code === 'auth/weak-password') {
                        throw new Error('Password should be at least 6 characters');
                    } else if (error.code === 'auth/invalid-email') {
                        throw new Error('Please enter a valid email address');
                    } else {
                        throw new Error('Failed to create account. Please try again');
                    }
                }
            } else {
                // Fallback to local storage
                const userData = { email, displayName, achievements: state.achievements };
                localStorage.setItem('runflow_user', JSON.stringify(userData));
                return { user: { email }, displayName };
            }
        }

        async function signInUser(email, password) {
            if (window.firebaseAuth && window.firebaseSignIn) {
                try {
                    const userCredential = await window.firebaseSignIn(window.firebaseAuth, email, password);
                    const user = userCredential.user;
                    
                    // Load user data from Firestore
                    const userDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firebaseDb, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        return { user, displayName: userData.displayName, achievements: userData.achievements || state.achievements };
                    }
                    
                    return { user, displayName: email.split('@')[0], achievements: state.achievements };
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        throw new Error('Invalid email or password');
                    } else if (error.code === 'auth/invalid-email') {
                        throw new Error('Please enter a valid email address');
                    } else {
                        throw new Error('Sign in failed. Please try again');
                    }
                }
            } else {
                // Fallback to local storage
                const storedUser = localStorage.getItem('runflow_user');
                if (storedUser) {
                    const userData = JSON.parse(storedUser);
                    if (userData.email === email) {
                        return { user: { email }, displayName: userData.displayName, achievements: userData.achievements || state.achievements };
                    }
                }
                throw new Error('User not found');
            }
        }

        async function saveUserAchievements() {
            if (state.currentUser && !state.currentUser.isGuest && window.firebaseAuth && window.firebaseAuth.currentUser) {
                try {
                    await window.firebaseUpdateDoc(window.firebaseDoc(window.firebaseDb, 'users', window.firebaseAuth.currentUser.uid), {
                        achievements: state.achievements,
                        lastUpdated: new Date()
                    });
                } catch (error) {
                    console.log('Could not save to Firebase, using local storage');
                    localStorage.setItem('runflow_achievements', JSON.stringify(state.achievements));
                }
            } else if (state.currentUser && !state.currentUser.isGuest) {
                // Fallback to local storage
                localStorage.setItem('runflow_achievements', JSON.stringify(state.achievements));
            }
        }

        // Handle authentication
        function setupAuthHandlers() {
            const loginForm = document.getElementById('loginForm');
            const signupBtn = document.getElementById('signupBtn');
            const guestBtn = document.getElementById('guestBtn');
            const signupFormModal = document.getElementById('signupFormModal');
            
            // Login handler
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showToast('Please enter both email and password');
                    return;
                }
                
                try {
                    const result = await signInUser(email, password);
                    showToast('Welcome back! Signed in successfully');
                    state.currentUser = { 
                        email: result.user.email, 
                        displayName: result.displayName,
                        achievements: result.achievements
                    };
                    state.achievements = result.achievements;
                    showPage('mainPage');
                    setTimeout(checkGPS, 500);
                } catch (error) {
                    showToast(error.message, 5000);
                }
            });
            
            // Signup button handler
            signupBtn.addEventListener('click', function() {
                document.getElementById('signupModal').classList.add('active');
            });
            
            // Signup form handler
            signupFormModal.addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('signupNameModal').value;
                const email = document.getElementById('signupEmailModal').value;
                const password = document.getElementById('signupPasswordModal').value;
                
                if (!name || !email || !password) {
                    showToast('Please fill in all fields');
                    return;
                }
                
                if (password.length < 6) {
                    showToast('Password must be at least 6 characters');
                    return;
                }
                
                try {
                    const result = await createUser(email, password, name);
                    showToast('Account created successfully! Welcome to RunFlow');
                    document.getElementById('signupModal').classList.remove('active');
                    state.currentUser = { 
                        email: result.user.email, 
                        displayName: result.displayName,
                        achievements: state.achievements
                    };
                    showPage('mainPage');
                    setTimeout(checkGPS, 500);
                } catch (error) {
                    showToast(error.message, 5000);
                }
            });
            
            // Guest login handler
            guestBtn.addEventListener('click', function() {
                state.currentUser = { isGuest: true };
                showPage('mainPage');
                setTimeout(checkGPS, 500);
            });
        }

        // GPS checking
        function checkGPS() {
            const gpsLoading = document.getElementById('gpsLoading');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // GPS ready
                        state.gpsReady = true;
                        gpsLoading.classList.add('hidden');
                        document.getElementById('startBtn').disabled = false;
                        showToast('GPS ready! You can start your run now');
                    },
                    function(error) {
                        // GPS error
                        setTimeout(() => {
                            gpsLoading.classList.add('hidden');
                            document.getElementById('startBtn').disabled = false;
                            showToast('GPS not available. Manual distance tracking enabled');
                        }, 3000);
                    },
                    { 
                        timeout: 15000,
                        maximumAge: 60000,
                        enableHighAccuracy: false
                    }
                );
            } else {
                setTimeout(() => {
                    gpsLoading.classList.add('hidden');
                    document.getElementById('startBtn').disabled = false;
                    showToast('Geolocation not supported. Manual tracking only');
                }, 3000);
            }
        }

        // Running app logic
        let timerInterval = null;
        let watchId = null;
        let paceInterval = null;
        
        // Format time to MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Format pace (seconds per mile) to min:sec per mile
        function formatPace(seconds) {
            if (!seconds || seconds === Infinity || isNaN(seconds) || seconds > 3600) return "--:--";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Update display with current values
        function updateDisplay() {
            document.querySelector('.time-text').textContent = formatTime(state.elapsedTime);
            document.getElementById('distanceValue').textContent = metersToMiles(state.totalDistance).toFixed(2);
            
            // Update current mile
            const currentMile = Math.floor(metersToMiles(state.totalDistance)) + 1;
            document.getElementById('currentMileValue').textContent = currentMile;
            
            // Update mile pace (for current mile)
            if (state.currentSplitDistance > 0 || state.totalDistance > 0) {
                const currentMileDistance = state.totalDistance - state.currentSplitDistance;
                if (currentMileDistance > 0 && state.elapsedTime > state.currentSplitStartTime) {
                    const currentMileTime = state.elapsedTime - state.currentSplitStartTime;
                    const milePace = currentMileTime / metersToMiles(currentMileDistance);
                    document.getElementById('milePaceValue').textContent = formatPace(milePace);
                }
            }
        }
        
        // Calculate instant pace
        function calculateInstantPace() {
            if (state.running && !state.paused && state.totalDistance > 0) {
                const now = Date.now();
                const timeDiff = (now - state.lastPaceCalculationTime) / 1000;
                
                if (timeDiff >= 5) { // Update every 5 seconds
                    const distanceDiff = state.totalDistance - state.lastPaceCalculationDistance;
                    
                    if (distanceDiff > 0) {
                        const instantPace = timeDiff / metersToMiles(distanceDiff);
                        if (instantPace < 1800) { // Only show reasonable paces (under 30 min/mile)
                            document.getElementById('paceValue').textContent = formatPace(instantPace);
                        }
                    }
                    
                    state.lastPaceCalculationTime = now;
                    state.lastPaceCalculationDistance = state.totalDistance;
                }
            }
        }
        
        // Start the run
        function startRun() {
            if (state.running) return;
            
            state.running = true;
            state.paused = false;
            state.startTime = Date.now() - state.elapsedTime * 1000;
            state.currentSplitStartTime = state.elapsedTime;
            state.currentSplitDistance = state.totalDistance;
            state.lastPaceCalculationTime = Date.now();
            state.lastPaceCalculationDistance = state.totalDistance;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            
            // Start timer
            timerInterval = setInterval(function() {
                state.elapsedTime = Math.floor((Date.now() - state.startTime) / 1000);
                updateDisplay();
                
                // Check if we've completed a mile
                const totalMiles = metersToMiles(state.totalDistance);
                const completedMiles = Math.floor(totalMiles);
                
                if (completedMiles > state.splits.length && completedMiles > 0) {
                    // Record split for the completed mile
                    const mileStartTime = state.splits.length === 0 ? 0 : state.splits[state.splits.length - 1].totalTime;
                    const splitTime = state.elapsedTime - mileStartTime;
                    
                    state.splits.push({
                        mile: completedMiles,
                        splitTime: splitTime,
                        totalTime: state.elapsedTime,
                        pace: splitTime
                    });
                    
                    showToast(`Mile ${completedMiles} completed! Pace: ${formatPace(splitTime)}/mi`);
                }
            }, 1000);
            
            // Start pace calculation
            paceInterval = setInterval(calculateInstantPace, 2000);
            
            // Start GPS tracking if available
            if (navigator.geolocation && state.gpsReady) {
                let lastPos = null;
                
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        if (lastPos && state.running && !state.paused) {
                            const distance = calculateDistance(
                                lastPos.latitude, lastPos.longitude,
                                position.coords.latitude, position.coords.longitude
                            );
                            
                            // Only add distance if it's reasonable (not a GPS jump)
                            if (distance < 100) { // Less than 100 meters in one reading
                                state.totalDistance += distance;
                                updateDisplay();
                            }
                        }
                        
                        lastPos = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        state.lastPosition = lastPos;
                        
                        // Record position for route visualization
                        if (state.running && !state.paused) {
                            state.routePositions.push({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: Date.now()
                            });
                        }
                    },
                    function(error) {
                        console.error('GPS error during run:', error);
                        showToast('GPS signal lost. Manual tracking mode');
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 5000
                    }
                );
            }
            
            showToast('Run started! Good luck!');
        }
        
        // Pause the run
        function pauseRun() {
            if (!state.running || state.paused) return;
            
            state.paused = true;
            state.pausedTime = Date.now();
            clearInterval(timerInterval);
            clearInterval(paceInterval);
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i><span>Resume</span>';
            
            showToast('Run paused. Take your time!');
        }
        
        // Resume the run
        function resumeRun() {
            if (!state.running || !state.paused) return;
            
            state.paused = false;
            state.startTime = Date.now() - state.elapsedTime * 1000;
            state.lastPaceCalculationTime = Date.now();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
            
            // Restart timer
            timerInterval = setInterval(function() {
                state.elapsedTime = Math.floor((Date.now() - state.startTime) / 1000);
                updateDisplay();
            }, 1000);
            
            // Restart pace calculation
            paceInterval = setInterval(calculateInstantPace, 2000);
            
            // Restart GPS if available
            if (navigator.geolocation && state.gpsReady) {
                let lastPos = state.lastPosition;
                
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        if (lastPos && state.running && !state.paused) {
                            const distance = calculateDistance(
                                lastPos.latitude, lastPos.longitude,
                                position.coords.latitude, position.coords.longitude
                            );
                            
                            if (distance < 100) {
                                state.totalDistance += distance;
                                updateDisplay();
                            }
                        }
                        
                        lastPos = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        state.lastPosition = lastPos;
                        
                        if (state.running && !state.paused) {
                            state.routePositions.push({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                timestamp: Date.now()
                            });
                        }
                    },
                    function(error) {
                        console.error('GPS error during run:', error);
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 5000
                    }
                );
            }
            
            showToast('Run resumed! Keep going!');
        }
        
        // Stop the run
        function stopRun() {
            state.running = false;
            state.paused = false;
            clearInterval(timerInterval);
            clearInterval(paceInterval);
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            // Update achievements
            updateAchievements();
            
            const distance = metersToMiles(state.totalDistance);
            const time = formatTime(state.elapsedTime);
            showToast(`Run completed! ${distance.toFixed(2)} miles in ${time}. Great job!`);
        }
        
        // Reset the run
        function resetRun() {
            state.running = false;
            state.paused = false;
            clearInterval(timerInterval);
            clearInterval(paceInterval);
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            state.elapsedTime = 0;
            state.totalDistance = 0;
            state.splits = [];
            state.currentSplitStartTime = 0;
            state.currentSplitDistance = 0;
            state.lastPosition = null;
            state.lastPaceCalculationTime = 0;
            state.lastPaceCalculationDistance = 0;
            state.routePositions = [];
            
            document.querySelector('.time-text').textContent = '00:00';
            document.getElementById('distanceValue').textContent = '0.00';
            document.getElementById('paceValue').textContent = '--:--';
            document.getElementById('currentMileValue').textContent = '0';
            document.getElementById('milePaceValue').textContent = '--:--';
            
            document.getElementById('startBtn').disabled = !state.gpsReady;
            document.getElementById('startBtn').innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            showToast('Run data reset. Ready for a new run!');
        }
        
        // Update achievements
        function updateAchievements() {
            const currentRunDistance = metersToMiles(state.totalDistance);
            
            // Only update if this was a real run (more than 0.1 miles)
            if (currentRunDistance < 0.1) return;
            
            // Update total runs
            state.achievements.totalRuns++;
            
            // Update total distance
            state.achievements.totalDistance += currentRunDistance;
            
            // Update longest run
            if (currentRunDistance > state.achievements.longestRun) {
                state.achievements.longestRun = currentRunDistance;
            }
            
            // Update best mile
            state.splits.forEach(split => {
                if (split.pace < state.achievements.bestMile) {
                    state.achievements.bestMile = split.pace;
                }
            });
            
            // Check for badges
            const newBadges = [];
            
            if (state.achievements.totalRuns >= 1 && !state.achievements.badges.firstRun) {
                state.achievements.badges.firstRun = true;
                newBadges.push('First Steps');
            }
            
            if (currentRunDistance >= 3.1 && !state.achievements.badges.fiveK) {
                state.achievements.badges.fiveK = true;
                newBadges.push('5K Runner');
            }
            
            if (currentRunDistance >= 6.2 && !state.achievements.badges.tenK) {
                state.achievements.badges.tenK = true;
                newBadges.push('10K Champion');
            }
            
            if (currentRunDistance >= 13.1 && !state.achievements.badges.halfMarathon) {
                state.achievements.badges.halfMarathon = true;
                newBadges.push('Half Marathon');
            }
            
            if (currentRunDistance >= 26.2 && !state.achievements.badges.marathon) {
                state.achievements.badges.marathon = true;
                newBadges.push('Marathoner');
            }
            
            const hasFastMile = state.splits.some(split => split.pace < 420);
            if (hasFastMile && !state.achievements.badges.speedster) {
                state.achievements.badges.speedster = true;
                newBadges.push('Speedster');
            }
            
            // Show new badge notifications
            newBadges.forEach((badge, index) => {
                setTimeout(() => {
                    showToast(` Achievement unlocked: ${badge}!`, 6000);
                }, index * 2000);
            });
            
            // Save achievements
            saveUserAchievements();
            
            // Update UI if achievements modal is open
            updateAchievementsUI();
        }
        
        // Update achievements UI
        function updateAchievementsUI() {
            document.getElementById('totalRuns').textContent = state.achievements.totalRuns;
            document.getElementById('totalDistance').textContent = state.achievements.totalDistance.toFixed(1);
            document.getElementById('bestMile').textContent = state.achievements.bestMile !== Infinity ? 
                formatPace(state.achievements.bestMile) : '--:--';
            document.getElementById('longestRun').textContent = state.achievements.longestRun.toFixed(1);
            
            // Update badge visibility
            document.getElementById('firstRunBadge').classList.toggle('earned', state.achievements.badges.firstRun);
            document.getElementById('fiveKBadge').classList.toggle('earned', state.achievements.badges.fiveK);
            document.getElementById('tenKBadge').classList.toggle('earned', state.achievements.badges.tenK);
            document.getElementById('halfMarathonBadge').classList.toggle('earned', state.achievements.badges.halfMarathon);
            document.getElementById('marathonBadge').classList.toggle('earned', state.achievements.badges.marathon);
            document.getElementById('speedsterBadge').classList.toggle('earned', state.achievements.badges.speedster);
        }
        
        // Show achievements
        function showAchievements() {
            if (state.currentUser && !state.currentUser.isGuest) {
                document.getElementById('userName').textContent = state.currentUser.displayName || 'Runner';
                document.getElementById('userWelcome').style.display = 'block';
                document.getElementById('guestAchievementsMessage').style.display = 'none';
            } else {
                document.getElementById('userWelcome').style.display = 'none';
                document.getElementById('guestAchievementsMessage').style.display = 'block';
            }
            
            updateAchievementsUI();
            document.getElementById('achievementsModal').classList.add('active');
        }
        
        // Export data
        function exportData() {
            if (state.elapsedTime === 0) {
                showToast('No run data to export. Complete a run first!');
                return;
            }
            
            const date = new Date().toLocaleDateString();
            let csvContent = "RunFlow Running Data Export\n";
            csvContent += `Date: ${date}\n\n`;
            csvContent += "Run Summary\n";
            csvContent += `Total Time,${formatTime(state.elapsedTime)}\n`;
            csvContent += `Total Distance,${metersToMiles(state.totalDistance).toFixed(2)} miles\n`;
            csvContent += `Average Pace,${formatPace(state.elapsedTime / metersToMiles(state.totalDistance))}/mile\n\n`;
            
            if (state.splits.length > 0) {
                csvContent += "Mile Splits\n";
                csvContent += "Mile,Split Time,Total Time,Pace (min/mile)\n";
                
                state.splits.forEach(split => {
                    csvContent += `${split.mile},${formatTime(split.splitTime)},${formatTime(split.totalTime)},${formatPace(split.pace)}\n`;
                });
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `runflow_data_${date.replace(/\//g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Run data exported successfully!');
        }
        
        // Show splits
        function showSplits() {
            const splitsTableBody = document.getElementById('splitsTableBody');
            
            if (state.splits.length === 0) {
                splitsTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 1.5rem;">
                            <div class="loading-state">
                                <i class="fas fa-running" style="font-size: 1.75rem; margin-bottom: 0.75rem; color: rgba(255,255,255,0.3);"></i>
                                <div>${state.elapsedTime > 0 ? 'Complete your first mile to see splits' : 'Start your run to track splits'}</div>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                splitsTableBody.innerHTML = '';
                state.splits.forEach(split => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>Mile ${split.mile}</strong></td>
                        <td>${formatTime(split.splitTime)}</td>
                        <td>${formatPace(split.pace)}/mi</td>
                    `;
                    splitsTableBody.appendChild(row);
                });
            }
            document.getElementById('splitsModal').classList.add('active');
        }
        
        // Show route
        function showRoute() {
            // Update route stats
            document.getElementById('routeDistance').textContent = metersToMiles(state.totalDistance).toFixed(2);
            document.getElementById('routeTime').textContent = formatTime(state.elapsedTime);
            
            // Show/hide share section based on user status
            if (state.currentUser && !state.currentUser.isGuest) {
                document.getElementById('shareSection').classList.remove('hidden');
                document.getElementById('guestMessage').style.display = 'none';
            } else {
                document.getElementById('shareSection').classList.add('hidden');
                document.getElementById('guestMessage').style.display = 'block';
            }
            
            // Show the route modal
            document.getElementById('routeModal').classList.add('active');
            
            // If we have route data, visualize it
            if (state.routePositions.length > 1) {
                setTimeout(() => visualizeRoute(), 300);
            }
        }
        
        // Visualize the route on the map
        function visualizeRoute() {
            const routeMap = document.getElementById('routeMap');
            const placeholder = document.getElementById('routeMapPlaceholder');
            
            // Clear previous map
            if (state.map) {
                state.map.remove();
                state.map = null;
            }
            
            // Hide placeholder
            placeholder.style.display = 'none';
            
            try {
                // Initialize map
                state.map = L.map(routeMap, {
                    zoomControl: false,
                    attributionControl: false,
                    dragging: true,
                    touchZoom: true,
                    doubleClickZoom: false,
                    scrollWheelZoom: false,
                    boxZoom: false,
                    keyboard: false
                });
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: ''
                }).addTo(state.map);
                
                // Create array of LatLng objects
                const latlngs = state.routePositions.map(pos => [pos.lat, pos.lng]);
                
                // Fit map to bounds of the route
                const bounds = L.latLngBounds(latlngs);
                state.map.fitBounds(bounds, { padding: [10, 10] });
                
                // Create a polyline
                state.routePolyline = L.polyline(latlngs, {
                    color: '#00c6ff',
                    weight: 4,
                    opacity: 0.8,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(state.map);
                
                // Add start marker
                L.marker([latlngs[0][0], latlngs[0][1]], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background-color: #10b981; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    })
                }).addTo(state.map);
                
                // Add end marker if different from start
                if (latlngs.length > 1) {
                    L.marker([latlngs[latlngs.length - 1][0], latlngs[latlngs.length - 1][1]], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<div style="background-color: #ef4444; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        })
                    }).addTo(state.map);
                }
                
            } catch (error) {
                console.error('Error creating map:', error);
                placeholder.style.display = 'flex';
                placeholder.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1.75rem; color: #f59e0b; margin-bottom: 0.75rem;"></i>
                        <h4 style="margin: 0.5rem 0 0.25rem; color: #ffffff;">Map Error</h4>
                        <p style="font-size: 0.8rem;">Could not load map visualization</p>
                    </div>
                `;
            }
        }
        
        // Share on social media
        function shareOnFacebook() {
            const distance = metersToMiles(state.totalDistance).toFixed(2);
            const time = formatTime(state.elapsedTime);
            const pace = formatPace(state.elapsedTime / metersToMiles(state.totalDistance));
            const text = `Just completed a ${distance} mile run in ${time} (${pace}/mile pace) using RunFlow! `;
            
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');
        }
        
        function shareOnLinkedIn() {
            const distance = metersToMiles(state.totalDistance).toFixed(2);
            const time = formatTime(state.elapsedTime);
            const pace = formatPace(state.elapsedTime / metersToMiles(state.totalDistance));
            const text = `Just completed a ${distance} mile run in ${time} (${pace}/mile pace) using RunFlow! Another step towards my fitness goals.  #Running #Fitness #Health`;
            
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}&summary=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');
        }
        
        function shareOnBlueSky() {
            const distance = metersToMiles(state.totalDistance).toFixed(2);
            const time = formatTime(state.elapsedTime);
            const pace = formatPace(state.elapsedTime / metersToMiles(state.totalDistance));
            const text = `Just completed a ${distance} mile run in ${time} (${pace}/mile pace) using RunFlow!  #Running #Fitness`;
            
            window.open(`https://bsky.app/intent/compose?text=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');
        }
        
        // Helper functions for distance calculation
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin( / 2) * Math.sin( / 2) +
                    Math.cos(1) * Math.cos(2) *
                    Math.sin( / 2) * Math.sin( / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }
        
        function metersToMiles(meters) {
            return meters / 1609.34;
        }
        
        // PWA Installation
        function setupPWA() {
            const installPrompt = document.getElementById('installPrompt');
            const installBtn = document.getElementById('installBtn');
            const closeInstallBtn = document.getElementById('closeInstall');
            
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                installPrompt.classList.add('show');
            });
            
            // Handle install button click
            installBtn.addEventListener('click', async () => {
                if (!state.deferredPrompt) {
                    showToast('Installation not available on this device');
                    return;
                }
                
                try {
                    state.deferredPrompt.prompt();
                    const { outcome } = await state.deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        showToast('RunFlow is being installed...', 6000);
                    }
                    
                    installPrompt.classList.remove('show');
                    state.deferredPrompt = null;
                } catch (error) {
                    console.error('Installation error:', error);
                    showToast('Installation failed. Please try again');
                }
            });
            
            // Handle install prompt close
            closeInstallBtn.addEventListener('click', () => {
                installPrompt.classList.remove('show');
            });
            
            // Listen for app installation
            window.addEventListener('appinstalled', () => {
                installPrompt.classList.remove('show');
                state.deferredPrompt = null;
                showToast(' RunFlow installed successfully! You can now use it offline');
            });
            
            // Show install prompt for iOS users
            if (isIOS() && !isInStandaloneMode()) {
                setTimeout(() => {
                    showToast('Add RunFlow to your home screen for the best experience! Tap Share  Add to Home Screen', 8000);
                }, 5000);
            }
        }
        
        // iOS detection helpers
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        }
        
        // Modal management
        function setupModalHandlers() {
            const modals = [
                { modal: 'infoModal', closeBtn: 'closeInfoModal' },
                { modal: 'splitsModal', closeBtn: 'closeSplitsModal' },
                { modal: 'routeModal', closeBtn: 'closeRouteModal' },
                { modal: 'achievementsModal', closeBtn: 'closeAchievementsModal' },
                { modal: 'signupModal', closeBtn: 'closeSignupModal' },
                { modal: 'exitModal', closeBtn: 'closeExitModal' }
            ];
            
            modals.forEach(({ modal, closeBtn }) => {
                const modalEl = document.getElementById(modal);
                const closeBtnEl = document.getElementById(closeBtn);
                
                // Close button handler
                closeBtnEl.addEventListener('click', () => {
                    modalEl.classList.remove('active');
                });
                
                // Click outside to close
                modalEl.addEventListener('click', (e) => {
                    if (e.target === modalEl) {
                        modalEl.classList.remove('active');
                    }
                });
            });
            
            // Exit confirmation handlers
            document.getElementById('cancelExit').addEventListener('click', () => {
                document.getElementById('exitModal').classList.remove('active');
            });
            
            document.getElementById('confirmExit').addEventListener('click', async () => {
                // Sign out if authenticated
                if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    try {
                        await window.firebaseSignOut(window.firebaseAuth);
                    } catch (error) {
                        console.log('Sign out error:', error);
                    }
                }
                
                showPage('loginPage');
                resetRun();
                state.currentUser = null;
                document.getElementById('exitModal').classList.remove('active');
                showToast('Signed out successfully');
            });
        }
        
        // Initialize the app
        function init() {
            // Setup authentication handlers
            setupAuthHandlers();
            
            // Setup PWA functionality
            setupPWA();
            
            // Setup modal handlers
            setupModalHandlers();
            
            // Start with splash screen
            initSplash();
            
            // Main app event listeners
            document.getElementById('startBtn').addEventListener('click', function() {
                if (state.paused) {
                    resumeRun();
                } else {
                    startRun();
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', pauseRun);
            document.getElementById('stopBtn').addEventListener('click', stopRun);
            document.getElementById('resetBtn').addEventListener('click', resetRun);
            
            document.getElementById('routeBtn').addEventListener('click', showRoute);
            document.getElementById('splitsBtn').addEventListener('click', showSplits);
            document.getElementById('infoBtn').addEventListener('click', () => {
                document.getElementById('infoModal').classList.add('active');
            });
            document.getElementById('achievementsBtn').addEventListener('click', showAchievements);
            
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            
            // Social sharing buttons
            document.getElementById('shareFacebook').addEventListener('click', shareOnFacebook);
            document.getElementById('shareLinkedIn').addEventListener('click', shareOnLinkedIn);
            document.getElementById('shareBlueSky').addEventListener('click', shareOnBlueSky);
            
            // Exit button
            document.getElementById('exitBtn').addEventListener('click', () => {
                document.getElementById('exitModal').classList.add('active');
            });
            
            // Load saved achievements for guests
            const savedAchievements = localStorage.getItem('runflow_achievements');
            if (savedAchievements) {
                try {
                    state.achievements = { ...state.achievements, ...JSON.parse(savedAchievements) };
                } catch (error) {
                    console.log('Could not load saved achievements');
                }
            }
        }
        
        // Initialize the app when loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // Service Worker Registration for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful');
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }
    </script>
</body>
</html>
