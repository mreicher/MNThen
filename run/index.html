<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunFlow - Mobile Run Tracker</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background-color: #e5e7eb;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }
        
        /* Main App Container */
        .app-container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        /* Header - Simplified */
        .header {
            background-color: #3b82f6;
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .app-title {
            font-size: 32px;
            font-weight: 900;
            letter-spacing: -1px;
        }
        
        /* Stats Section - Larger time display */
        .stats {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px 20px 16px;
            background-color: #ffffff;
        }
        
        .time-row {
            background-color: #f8fafc;
            border-radius: 20px;
            padding: 30px 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .distance-pace-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-card {
            background-color: #f8fafc;
            border-radius: 20px;
            padding: 16px 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: #1e293b;
            letter-spacing: -1px;
        }
        
        .time-value {
            font-size: 48px; /* Much larger time display */
            font-weight: 900;
            letter-spacing: -2px;
        }
        
        /* Controls - Exit button moved to right side */
        .controls {
            display: grid;
            gap: 16px;
            padding: 20px;
            background-color: #f1f5f9;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        
        .control-row-two {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: center;
        }
        
        /* GPS Status */
        .gps-status {
            padding: 20px;
            background-color: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Ad Space */
        .ad-space {
            padding: 20px;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            border: 2px dashed #cbd5e1;
            margin: 20px;
            border-radius: 12px;
        }
        
        .ad-placeholder {
            color: #64748b;
            font-size: 14px;
            font-style: italic;
            text-align: center;
        }
        
        /* Splits Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .splits-modal {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background-color: #3b82f6;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-close:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }
        
        .modal-content {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        #splitsList {
            list-style-type: none;
            margin-bottom: 20px;
        }
        
        #splitsList li {
            background-color: #f8fafc;
            padding: 18px;
            margin-bottom: 12px;
            border-radius: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .split-number {
            font-weight: 700;
            color: #3b82f6;
            font-size: 16px;
        }
        
        .split-pace {
            font-weight: 700;
            color: #10b981;
            font-size: 16px;
        }
        
        .no-splits {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px 20px;
        }
        
        /* Download/Email Export Button */
        .download-export {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s ease;
        }
        
        .download-export:active {
            background-color: #2563eb;
            transform: scale(0.98);
        }
        
        /* Buttons - Better contrast color */
        button {
            padding: 18px 12px;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-height: 60px;
        }
        
        button:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #startBtn {
            background-color: #059669; /* Darker green for better contrast */
            color: white;
        }
        
        #pauseBtn {
            background-color: #d97706; /* Darker orange for better contrast */
            color: white;
        }
        
        #resumeBtn {
            background-color: #059669;
            color: white;
            display: none;
        }
        
        #stopBtn {
            background-color: #dc2626; /* Darker red for better contrast */
            color: white;
        }
        
        #resetBtn {
            background-color: #475569; /* Darker gray for better contrast */
            color: white;
        }
        
        #splitsBtn {
            background-color: #1d4ed8; /* Darker blue for better contrast */
            color: white;
        }
        
        /* Exit button - positioned on the right, better contrast */
        #exitBtnMain {
            background-color: #7c2d12; /* Dark brown for better contrast */
            color: white;
            width: 60px; /* Smaller, square-ish button */
            padding: 18px 8px;
            font-size: 14px;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        button:disabled:active {
            transform: none;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .app-title {
                font-size: 28px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .time-value {
                font-size: 40px; /* Still large but fits better on small screens */
            }
            
            button {
                font-size: 14px;
                padding: 16px 10px;
                min-height: 55px;
            }
            
            #exitBtnMain {
                width: 55px;
                font-size: 12px;
            }
            
            .stat-card, .time-row {
                padding: 16px 12px;
            }
            
            .control-row {
                gap: 10px;
            }
        }
        
        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .stats {
                padding: 16px;
            }
            
            .time-value {
                font-size: 36px;
            }
        }
        
        /* Focus styles for accessibility */
        button:focus {
            outline: 3px solid rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div class="app-container">
        <div class="header">
            <h1 class="app-title">🏃‍♂️ RunFlow</h1>
        </div>
        
        <!-- Stats section with larger time display -->
        <div class="stats">
            <div class="time-row">
                <div class="stat-label">⏱️ Time</div>
                <div id="time" class="stat-value time-value">00:00</div>
            </div>
            <div class="distance-pace-row">
                <div class="stat-card">
                    <div class="stat-label">📍 Distance</div>
                    <div id="distance" class="stat-value">0.00 mi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">⚡ Pace</div>
                    <div id="pace" class="stat-value">--:--</div>
                </div>
            </div>
        </div>
        
        <!-- Controls with exit button moved to right -->
        <div class="controls">
            <div class="control-row">
                <button id="startBtn">▶️ Begin</button>
                <button id="pauseBtn" disabled>⏸️ Pause</button>
                <button id="stopBtn" disabled>⏹️ End</button>
            </div>
            <div class="control-row-two">
                <button id="resetBtn">🔄 Reset</button>
                <button id="splitsBtn">📊 Splits</button>
                <button id="exitBtnMain">🚪 Exit</button>
            </div>
        </div>
        
        <div class="gps-status" id="gpsStatus">
            <span>🌐 Acquiring GPS signal...</span>
        </div>
        
        <!-- Ad Space -->
        <div class="ad-space" id="adSpace">
            <div class="ad-placeholder">
                Advertisement Space<br>
                <small>Your ad could be here</small>
            </div>
        </div>
    </div>
    
    <!-- Splits Modal -->
    <div class="modal-overlay" id="splitsModal">
        <div class="splits-modal">
            <div class="modal-header">
                <h3 class="modal-title">📊 Mile Splits</h3>
                <button class="modal-close" id="closeSplitsModal">×</button>
            </div>
            <div class="modal-content">
                <ul id="splitsList">
                    <li class="no-splits">No splits recorded yet</li>
                </ul>
                <button class="download-export" id="downloadExportBtn">
                    <span>💾 Download & Email Results</span>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // App state
        const state = {
            running: false,
            paused: false,
            startTime: 0,
            pausedTime: 0,
            elapsedTime: 0,
            totalDistance: 0,
            lastPosition: null,
            watchId: null,
            splits: [],
            lastSplitDistance: 0,
            completed: false
        };
        
        // DOM elements
        const exitBtnMain = document.getElementById('exitBtnMain');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const splitsBtn = document.getElementById('splitsBtn');
        const timeDisplay = document.getElementById('time');
        const distanceDisplay = document.getElementById('distance');
        const paceDisplay = document.getElementById('pace');
        const splitsList = document.getElementById('splitsList');
        const gpsStatus = document.getElementById('gpsStatus');
        const adSpace = document.getElementById('adSpace');
        const splitsModal = document.getElementById('splitsModal');
        const closeSplitsModal = document.getElementById('closeSplitsModal');
        const downloadExportBtn = document.getElementById('downloadExportBtn');
        
        // Initialize the app
        function init() {
            // Event listeners
            exitBtnMain.addEventListener('click', showSplitsModal); // Exit button now shows splits
            startBtn.addEventListener('click', startRun);
            pauseBtn.addEventListener('click', pauseRun);
            stopBtn.addEventListener('click', stopRun); // Just stops, no modal
            resetBtn.addEventListener('click', resetRun);
            splitsBtn.addEventListener('click', showSplitsModal);
            closeSplitsModal.addEventListener('click', hideSplitsModal);
            downloadExportBtn.addEventListener('click', downloadAndEmailResults);
            
            // Close modal when clicking overlay
            splitsModal.addEventListener('click', function(e) {
                if (e.target === splitsModal) {
                    hideSplitsModal();
                }
            });
            
            // Check if Geolocation is available
            if (!navigator.geolocation) {
                updateGpsStatus('❌ Geolocation not supported');
                return;
            }
            
            // Try to get initial position
            navigator.geolocation.getCurrentPosition(
                () => {
                    startBtn.disabled = false;
                    updateGpsStatus('✅ GPS ready - Begin your run!');
                },
                () => {
                    updateGpsStatus('❌ Enable location services to track runs');
                },
                { timeout: 10000 }
            );
        }
        
        // Show splits modal
        function showSplitsModal() {
            splitsModal.classList.add('active');
        }
        
        // Hide splits modal
        function hideSplitsModal() {
            splitsModal.classList.remove('active');
        }
        
        // Format time from seconds to mm:ss
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Format pace (seconds per mile) to min:sec per mile
        function formatPace(secondsPerMile) {
            if (!secondsPerMile || secondsPerMile === Infinity) return "--:--";
            const mins = Math.floor(secondsPerMile / 60);
            const secs = Math.floor(secondsPerMile % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in meters
        }
        
        // Convert meters to miles
        function metersToMiles(meters) {
            return meters / 1609.34;
        }
        
        // Update GPS status display
        function updateGpsStatus(message) {
            gpsStatus.innerHTML = message;
        }
        
        // Start the run
        function startRun() {
            if (state.running) return;
            
            state.running = true;
            state.completed = false;
            state.startTime = Date.now() - state.elapsedTime * 1000;
            
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            stopBtn.disabled = false;
            
            updateGpsStatus('🎯 Tracking your run...');
            
            // Start tracking position
            startTracking();
            
            // Start the timer
            requestAnimationFrame(updateTimer);
        }
        
        // Start GPS tracking
        function startTracking() {
            state.watchId = navigator.geolocation.watchPosition(
                position => {
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    if (state.lastPosition) {
                        const distance = calculateDistance(
                            state.lastPosition.lat, 
                            state.lastPosition.lng,
                            latitude,
                            longitude
                        );
                        
                        // Only add distance if it's reasonable (filter out GPS jumps)
                        if (distance < 100 && accuracy < 50) {
                            state.totalDistance += distance;
                            
                            // Check for new splits (every full mile)
                            const miles = metersToMiles(state.totalDistance);
                            const currentMile = Math.floor(miles);
                            
                            if (currentMile > state.lastSplitDistance) {
                                recordSplit(currentMile);
                                state.lastSplitDistance = currentMile;
                            }
                            
                            // Add visual feedback
                            distanceDisplay.classList.add('pulse');
                            setTimeout(() => distanceDisplay.classList.remove('pulse'), 500);
                        }
                    }
                    
                    state.lastPosition = { lat: latitude, lng: longitude };
                    updateDisplay();
                },
                error => {
                    let errorMsg;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '❌ GPS access denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '❌ GPS signal unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '❌ GPS signal timeout';
                            break;
                        default:
                            errorMsg = '❌ Unknown GPS error';
                    }
                    updateGpsStatus(errorMsg);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 2000 
                }
            );
        }
        
        // Stop GPS tracking
        function stopTracking() {
            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }
        }
        
        // Pause the run
        function pauseRun() {
            if (!state.running || state.paused) return;
            
            state.paused = true;
            state.pausedTime = Date.now();
            stopTracking();
            
            pauseBtn.textContent = '▶️ Resume';
            pauseBtn.removeEventListener('click', pauseRun);
            pauseBtn.addEventListener('click', resumeRun);
            
            updateGpsStatus('⏸ Run paused - Press Resume to continue');
        }
        
        // Resume the run
        function resumeRun() {
            if (!state.running || !state.paused) return;
            
            state.paused = false;
            state.startTime = Date.now() - state.elapsedTime * 1000;
            
            pauseBtn.textContent = '⏸️ Pause';
            pauseBtn.removeEventListener('click', resumeRun);
            pauseBtn.addEventListener('click', pauseRun);
            
            updateGpsStatus('🎯 Resuming run tracking...');
            
            // Resume tracking position
            startTracking();
            
            // Resume the timer
            requestAnimationFrame(updateTimer);
        }
        
        // Stop the run (just ends it, keeps data visible)
        function stopRun() {
            if (!state.running) return;
            
            state.running = false;
            state.paused = false;
            state.completed = true;
            stopTracking();
            
            // Update button states
            startBtn.disabled = true;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            
            updateGpsStatus('🏁 Run completed! View splits or reset for a new run.');
        }
        
        // Reset the run
        function resetRun() {
            state.running = false;
            state.paused = false;
            state.completed = false;
            state.elapsedTime = 0;
            state.totalDistance = 0;
            state.lastPosition = null;
            state.splits = [];
            state.lastSplitDistance = 0;
            
            stopTracking();
            
            // Reset button states
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
            pauseBtn.textContent = '⏸️ Pause';
            pauseBtn.removeEventListener('click', resumeRun);
            pauseBtn.addEventListener('click', pauseRun);
            
            // Reset displays
            timeDisplay.textContent = '00:00';
            distanceDisplay.textContent = '0.00 mi';
            paceDisplay.textContent = '--:--';
            splitsList.innerHTML = '<li class="no-splits">No splits recorded yet</li>';
            
            updateGpsStatus('Ready to begin a new run');
        }
        
        // Update the timer display
        function updateTimer() {
            if (!state.running || state.paused) return;
            
            state.elapsedTime = Math.floor((Date.now() - state.startTime) / 1000);
            updateDisplay();
            requestAnimationFrame(updateTimer);
        }
        
        // Update all displays
        function updateDisplay() {
            // Update time
            timeDisplay.textContent = formatTime(state.elapsedTime);
            
            // Update distance (in miles)
            const miles = metersToMiles(state.totalDistance);
            distanceDisplay.textContent = miles.toFixed(2) + ' mi';
            
            // Update pace (min:sec per mile)
            if (miles > 0.01) {
                const paceSecPerMile = state.elapsedTime / miles;
                paceDisplay.textContent = formatPace(paceSecPerMile) + ' /mi';
            } else {
                paceDisplay.textContent = '--:--';
            }
        }
        
        // Record a split for a completed mile
        function recordSplit(mile) {
            const paceSecPerMile = state.elapsedTime / mile;
            state.splits.push({
                mile: mile,
                pace: paceSecPerMile,
                time: state.elapsedTime
            });
            
            // Update splits list in modal
            if (splitsList.firstChild && splitsList.firstChild.classList.contains('no-splits')) {
                splitsList.innerHTML = '';
            }
            
            const li = document.createElement('li');
            li.innerHTML = `
                <span class="split-number">Mile ${mile}</span>
                <span class="split-pace">${formatPace(paceSecPerMile)} /mi</span>
            `;
            splitsList.appendChild(li);
        }
        
        // Download results and open email client
        function downloadAndEmailResults() {
            // Create CSV content
            let csvContent = "RunFlow Run Results\n\n";
            csvContent += "Total Time," + formatTime(state.elapsedTime) + "\n";
            csvContent += "Total Distance," + metersToMiles(state.totalDistance).toFixed(2) + " mi\n";
            
            const miles = metersToMiles(state.totalDistance);
            if (miles > 0.01) {
                const paceSecPerMile = state.elapsedTime / miles;
                csvContent += "Average Pace," + formatPace(paceSecPerMile) + " /mi\n";
            } else {
                csvContent += "Average Pace,--:--\n";
            }
            
            csvContent += "\nMile Splits\n";
            csvContent += "Mile,Pace (/mi),Time\n";
            
            state.splits.forEach(split => {
                csvContent += `${split.mile},${formatPace(split.pace)},${formatTime(split.time)}\n`;
            });
            
            // Create a blob and download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'runflow_results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Create mailto link for email
            const subject = "My RunFlow Running Results";
            const body = encodeURIComponent(
                "Here are my running results from RunFlow:\n\n" +
                "Total Time: " + formatTime(state.elapsedTime) + "\n" +
                "Total Distance: " + metersToMiles(state.totalDistance).toFixed(2) + " mi\n" +
                "Average Pace: " + (miles > 0.01 ? formatPace(state.elapsedTime / miles) + " /mi" : "--:--") + "\n\n" +
                "Detailed results have been downloaded as a CSV file. You can attach it to this email!"
            );
            
            // Open email client with pre-filled content
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;
                  }
       
       // Initialize the app when the page loads
       window.addEventListener('load', init);
   </script>
</body>
</html>
