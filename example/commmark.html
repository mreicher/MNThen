<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Heritage: Our Shared Stories</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #map {
            height: calc(100vh - 76px);
            width: 100%;
        }
        .navbar {
            background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
            padding: 0.5rem 1rem;
        }
        .navbar-brand {
            font-weight: bold;
            color: #f8f9fa !important;
            font-size: 1.5rem;
        }
        .btn-login, .btn-add-story {
            background-color: #ffc107;
            border: none;
            color: #000;
            font-weight: bold;
        }
        .btn-login:hover, .btn-add-story:hover {
            background-color: #e0a800;
        }
        .story-card {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            padding: 15px;
            margin-bottom: 15px;
        }
        .story-card:hover {
            transform: translateY(-5px);
        }
        #search-container {
            position: absolute;
            top: 80px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #story-list {
            position: absolute;
            top: 80px;
            right: 10px;
            width: 300px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Minnesota Heritage</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="aboutLink">About</a>
                    </li>
                </ul>
                <button id="loginBtn" class="btn btn-login me-2">
                    <i class="fas fa-user me-2"></i>Log In
                </button>
                <button id="addStoryBtn" class="btn btn-add-story" style="display: none;">
                    <i class="fas fa-plus me-2"></i>Add Story
                </button>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <div id="search-container">
        <input type="text" id="search-input" class="form-control" placeholder="Search stories...">
    </div>

    <div id="story-list">
        <h5>Recent Stories</h5>
        <div id="story-list-content"></div>
    </div>

    <div class="modal fade" id="storyModal" tabindex="-1" aria-labelledby="storyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storyModalLabel">Add Your Story</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="storyForm">
                        <div class="mb-3">
                            <label for="storyTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="storyTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="storyContent" class="form-label">Your Story</label>
                            <textarea class="form-control" id="storyContent" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="storyDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="storyDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="storyCategory" class="form-label">Category</label>
                            <select class="form-control" id="storyCategory" required>
                                <option value="">Select a category</option>
                                <option value="personal">Personal History</option>
                                <option value="community">Community Event</option>
                                <option value="historical">Historical Moment</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Story</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About Minnesota Heritage</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Welcome to Minnesota Heritage, a community-driven platform that brings the rich history of Minnesota to life through personal stories and shared experiences.</p>
                    <p>Our interactive map allows you to explore the state's history geographically, with each marker representing a unique story from a community member. By clicking on these markers, you can dive into the personal narratives that shape Minnesota's cultural landscape.</p>
                    <p>We believe that every story matters, and that the true history of a place is written by the people who live there. That's why we've created this platform - to give voice to the diverse experiences that make Minnesota special.</p>
                    <p>Join us in this exciting journey of discovery and preservation. Log in to add your own stories, or simply explore the map to uncover the hidden gems of Minnesota's past. Together, we're creating a living, breathing historical record that will inform and inspire future generations.</p>
                    <h6>How to Participate:</h6>
                    <ol>
                        <li>Log in using your account</li>
                        <li>Click the "Add Story" button to share your story</li>
                        <li>Fill in the details: title, your story, date, and category</li>
                        <li>Submit your story and see it appear on the map!</li>
                    </ol>
                    <p>Let's preserve Minnesota's history, one story at a time.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase (replace with your own config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Initialize map
        const map = L.map('map').setView([46.7296, -94.6859], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const customIcon = L.icon({
            iconUrl: 'https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Authentication
        const loginBtn = document.getElementById('loginBtn');
        const addStoryBtn = document.getElementById('addStoryBtn');

        loginBtn.addEventListener('click', () => {
            if (auth.currentUser) {
                auth.signOut().then(() => {
                    updateUIForLoggedOutUser();
                }).catch(error => console.error(error));
            } else {
                auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => {
                    updateUIForLoggedInUser();
                }).catch(error => console.error(error));
            }
        });

        function updateUIForLoggedInUser() {
            loginBtn.innerHTML = '<i class="fas fa-user me-2"></i>Log Out';
            addStoryBtn.style.display = 'inline-block';
        }

        function updateUIForLoggedOutUser() {
            loginBtn.innerHTML = '<i class="fas fa-user me-2"></i>Log In';
            addStoryBtn.style.display = 'none';
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                updateUIForLoggedInUser();
            } else {
                updateUIForLoggedOutUser();
            }
        });

        // Load stories
        let allStories = [];
        function loadStories() {
            db.collection('stories').orderBy('timestamp', 'desc').get().then((querySnapshot) => {
                allStories = [];
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                querySnapshot.forEach((doc) => {
                    const story = doc.data();
                    story.id = doc.id;
                    allStories.push(story);
                    addStoryToMap(story);
                });
                updateStoryList();
            }).catch(error => console.error('Error loading stories:', error));
        }

        function addStoryToMap(story) {
            const marker = L.marker([story.location.latitude, story.location.longitude], {icon: customIcon}).addTo(map);
            marker.bindPopup(`
                <div class="story-card">
                    <h5>${story.title}</h5>
                    <p>${story.content.substring(0, 100)}...</p>
                    <small>Posted by ${story.author} on ${story.date}</small>
                    <br>
                    <small>Category: ${story.category}</small>
                </div>
            `);
        }

        function updateStoryList() {
            const storyListContent = document.getElementById('story-list-content');
            storyListContent.innerHTML = '';
            allStories.slice(0, 5).forEach(story => {
                const storyElement = document.createElement('div');
                storyElement.className = 'story-card';
                storyElement.innerHTML = `
                    <h6>${story.title}</h6>
                    <p>${story.content.substring(0, 50)}...</p>
                    <small>${story.date} - ${story.author}</small>
                `;
                storyListContent.appendChild(storyElement);
            });
        }

        loadStories();

        // Add story
        addStoryBtn.addEventListener('click', () => {
            if (auth.currentUser) {
                const storyModal = new bootstrap.Modal(document.getElementById('storyModal'));
                storyModal.show();
            } else {
                alert('Please log in to add a story');
            }
        });

        document.getElementById('storyForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const title = document.getElementById('storyTitle').value;
            const content = document.getElementById('storyContent').value;
            const date = document.getElementById('storyDate').value;
            const category = document.getElementById('storyCategory').value;

            // Get the center of the current map view
            const center = map.getCenter();

            db.collection('stories').add({
                title: title,
                content: content,
                date: date,
                category: category,
                location: new firebase.firestore.GeoPoint(center.lat, center.lng),
                author: auth.currentUser.displayName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                console.log('Story added');
                const storyModal = bootstrap.Modal.getInstance(document.getElementById('storyModal'));
                storyModal.hide();
                loadStories();
            }).catch(error => console.error('Error adding story:', error));
        });

        // Search functionality
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredStories = allStories.filter(story => 
                story.title.toLowerCase().includes(searchTerm) || 
                story.content.toLowerCase().includes(searchTerm) ||
                story.author.toLowerCase().includes(searchTerm) ||
                story.category.toLowerCase().includes(searchTerm)
            );
            
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            filteredStories.forEach(story => addStoryToMap(story));
            updateStoryList();
        });
