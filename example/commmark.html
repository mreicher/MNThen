<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Markers Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        #sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: white;
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        #sidebar.open {
            right: 0;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }
        #image-preview {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
        .progress {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="sidebar">
        <span class="close-btn" onclick="closeSidebar()">&times;</span>
        <h3>Add New Marker</h3>
        <form id="add-marker-form">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" required>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="year" class="form-label">Year</label>
                <input type="number" class="form-control" id="year" required>
            </div>
            <div class="mb-3">
                <label for="image" class="form-label">Image</label>
                <input type="file" class="form-control" id="image" accept="image/*" required>
            </div>
            <img id="image-preview" src="" alt="Preview" style="display: none;">
            <div class="progress" style="display: none;">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <button type="submit" class="btn btn-primary">Add Marker</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // Initialize Firebase (replace with your own config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            databaseURL: "YOUR_DATABASE_URL"
        };
        firebase.initializeApp(firebaseConfig);

        const storage = firebase.storage();
        const database = firebase.database();
        const auth = firebase.auth();

        let map;
        let markers;
        let clickedLatLng;

        function initMap() {
            map = L.map('map').setView([46.7296, -94.6859], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

            markers = L.markerClusterGroup();
            map.addLayer(markers);

            map.on('click', function(e) {
                if (auth.currentUser) {
                    clickedLatLng = e.latlng;
                    openSidebar();
                } else {
                    alert('Please log in to add markers');
                }
            });

            loadMarkers();
        }

        function loadMarkers() {
            markers.clearLayers();
            database.ref('markers').once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const marker = childSnapshot.val();
                    const newMarker = L.marker([marker.lat, marker.lng]);
                    newMarker.bindPopup(`<b>${marker.title}</b><br>${marker.description}<br>Year: ${marker.year}<br><img src="${marker.imageUrl}" alt="${marker.title}" style="max-width: 100%; height: auto;">`);
                    markers.addLayer(newMarker);
                });
            });
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('add-marker-form').reset();
            document.getElementById('image-preview').style.display = 'none';
            document.querySelector('.progress').style.display = 'none';
        }

        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('add-marker-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const year = document.getElementById('year').value;
            const imageFile = document.getElementById('image').files[0];

            if (!imageFile) {
                alert('Please select an image');
                return;
            }

            const progressBar = document.querySelector('.progress-bar');
            const progressContainer = document.querySelector('.progress');
            progressContainer.style.display = 'block';

            const storageRef = storage.ref(`marker_images/${Date.now()}_${imageFile.name}`);
            const uploadTask = storageRef.put(imageFile);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress.toFixed(2) + '%';
                }, 
                (error) => {
                    console.error('Upload failed:', error);
                    alert('Upload failed. Please try again.');
                    progressContainer.style.display = 'none';
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const newMarkerRef = database.ref('markers').push();
                        newMarkerRef.set({
                            title: title,
                            description: description,
                            year: year,
                            imageUrl: downloadURL,
                            lat: clickedLatLng.lat,
                            lng: clickedLatLng.lng
                        }).then(() => {
                            loadMarkers();
                            closeSidebar();
                            alert('Marker added successfully!');
                        }).catch((error) => {
                            console.error('Error adding marker:', error);
                            alert('Error adding marker. Please try again.');
                        });
                    });
                }
            );
        });

        // Initialize map when the page loads
        window.onload = initMap;

        // For demonstration purposes, let's assume the user is logged in
        // In a real application, you would implement proper authentication
        auth.signInAnonymously().catch((error) => {
            console.error('Anonymous auth error:', error);
        });
    </script>
</body>
</html>
