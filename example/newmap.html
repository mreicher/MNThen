<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="An interactive map for self-guided Minnesota history tours and statewide museum exhibits">
    <meta name="theme-color" content="#000000">
    <title>Minnesota Then</title>

    <link rel="shortcut icon" href="https://www.mnthen.com/images/mnthenfav.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://www.mnthen.com/css/map_page.css">

    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --text-color: #333;
            --light-bg-color: #f5f5f5;
            --border-color: #ddd;
        }

        .custom-marker-icon {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }

        .marker-inner {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .leaflet-popup {
            transition: opacity 0.5s;
        }

        #distanceBox {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background: var(--light-bg-color);
            border-radius: 12px;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            border: 2px solid red;
            z-index: 999;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #distanceBox.within-threshold {
            border-color: green;
        }

        #distanceBox.within-cooldown {
            border-color: orange;
        }

        .centered-icon {
            transition: all 0.3s ease-out;
        }

        #explanation-popup {
            width: 95%;
            max-width: 400px;
            background-color: var(--light-bg-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }

        #explanation-popup h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #explanation-popup p {
            margin: 10px 0;
            font-size: 1rem;
        }

        #close-popup {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        #close-popup:hover {
            background-color: var(--secondary-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #fefefe;
            text-align: center;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .modal-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .modal-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
        }

        #continueButton {
            background-color: var(--primary-color);
        }

        #cancelButton {
            background-color: #f44336;
        }

        .modal-button:hover {
            opacity: 0.9;
        }

        #recenter-button, #help-button {
            position: absolute;
            bottom: 20px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #recenter-button {
            left: 20px;
        }

        #help-button {
            left: 70px;
        }

        #exit-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        @media screen and (max-width: 600px) {
            #explanation-popup, .modal-content {
                width: 85%;
            }

            .modal-text {
                font-size: 16px;
            }

            .modal-button {
                font-size: 14px;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <main id="map-container">
        <div id="map" aria-label="Interactive map of Minnesota historical locations"></div>

        <button id="recenter-button" aria-label="Recenter map">
            <i class="fas fa-crosshairs" aria-hidden="true"></i>
        </button>

        <button id="help-button" aria-label="Show help">
            <i class="fas fa-question-circle" aria-hidden="true"></i>
        </button>

        <button id="exit-button" aria-label="Exit map">
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Exit
        </button>

        <div id="distanceBox" aria-live="polite">Initializing ...</div>

        <div id="explanation-popup" aria-labelledby="popup-title">
            <h3 id="popup-title">Navigation Tips</h3>
            <p>&#8226; Pinch, zoom, and glide across the map to uncover hidden gems.</p>
            <p>&#8226; Open popups to read articles or get directions to any location you want to learn more about.</p>
            <p>&#8226; Let the map re-align to your location, or tap the recenter button in the bottom-left corner.</p>
            <p>&#8226; Be within 20 feet of a marker to interact with the location.</p>
            <p>&#8226; Wait 90 seconds to revisit a previous location.</p>
            <button id="close-popup">Close</button>
        </div>

        <div id="forwardingModal" class="modal" aria-labelledby="modal-title">
            <div class="modal-content">
                <span class="close" aria-label="Close modal">&times;</span>
                <h4 id="modal-title" class="modal-text">Get turn-by-turn directions to the location with Google Maps (opens in a new window).</h4>
                <p>Would you like to continue?</p>
                <div class="button-container">
                    <button id="continueButton" class="modal-button">Continue</button>
                    <button id="cancelButton" class="modal-button">Cancel</button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script>
    <script src="/locations_test.js?ts=091020241"></script>
    <script>
        // Main JavaScript code
        document.addEventListener("DOMContentLoaded", function () {
            const INITIAL_DELAY = 2000;
            const COOLDOWN = 90000;
            const HIGH_ACCURACY_THRESHOLD = 1000;
            const AUTO_CENTER_THRESHOLD = 25000;
            const THRESHOLD_FEET = 20;

            let map, userLocationMarker, markers;
            let lastKnownLatLng = null;
            let currentLatLng = null;
            let closestLocation = null;
            let useHighAccuracy = false;
            let userInteracted = false;

            function initMap() {
                map = L.map("map", {
                    attributionControl: false,
                    zoomControl: true,
                    inertia: false,
                }).setView([45.09396938812941, -92.99743282865592], 19);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 19,
                    id: "mapbox/streets-v11",
                    tileSize: 512,
                    zoomOffset: -1,
                    crossOrigin: true,
                    useCache: true,
                    maxRequests: 6
                }).addTo(map);

                L.control.attribution({ prefix: false }).addTo(map);

                userLocationMarker = L.circleMarker([0, 0], {
                    color: "red",
                    fillColor: "#f03",
                    fillOpacity: 0.5,
                    radius: 6,
                }).addTo(map);

                markers = L.markerClusterGroup({
                    spiderfyOnMaxZoom: false,
                    disableClusteringAtZoom: 18,
                    chunkedLoading: true,
                    chunkInterval: 200,
                    chunkDelay: 50,
                    maxClusterRadius: (zoom) => (zoom <= 15) ? 89 : 40,
                    iconCreateFunction: (cluster) => {
                        return L.divIcon({
                            html: `<div style="
                                background-color: #006400; 
                                color: white;
                                border-radius: 50%;
                                width: 35px;
                                height: 35px;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                font-size: 16px;
                                font-weight: bold;
                            ">
                                ${cluster.getChildCount()}
                            </div>`,
                            className: 'custom-cluster-icon',
                            iconSize: L.point(35, 35)
                        });
                    }
                });

                map.addLayer(markers);
            }

            function loadLocations() {
                const script = document.createElement("script");
                script.src = `/locations_test.js?v=${Date.now()}`;
                script.onload = () => {
                    if (Array.isArray(locations) && locations.length) {
                        console.log("Location data loaded successfully:", locations);
                        addMarkersToMap();
                        map.locate({ setView: false, maxZoom: 19 });
                    } else {
                        console.error("Location data is missing or empty:", locations);
                        alert("Location data could not be loaded. Please refresh the page and try again.");
                    }
                };
                script.onerror = () => {
                    console.error("Failed to load the script:", script.src);
                    alert("Failed to load location data. Please check your internet connection and try again.");
                };
                document.body.appendChild(script);
            }

            function addMarkersToMap() {
                const markerIconClasses = {
                    "history": "blue-marker",
                    "hamm": "orange-marker",
                    "gangster": "green-marker",
                    "split": "split-marker",
                    "wbl_split": "wbl_split-marker",
                    "lake": "lake-marker",
                    "capitol": "capitol-marker",
                    "summit": "summit-marker",
                    "northeast": "northeast-marker",
                    "default": "blue-marker"
                };

                locations.forEach(location => {
                    const iconClass = markerIconClasses[location.tours] || markerIconClasses["default"];
                    const newMarkerIcon = L.divIcon({
                        className: `custom-marker-icon ${iconClass}`,
                        iconSize: [17, 17],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -20],
                        html: `<span class="marker-inner"></span>`
                    });

                    const marker = L.marker([location.lat, location.lng], { icon: newMarkerIcon });
                    const popupContent = `
                        <div class="popup-content">
                            <img src="${location.image}" alt="${location.name}">
                            <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>
                            <a href="#" class="directions-link" data-lat="${location.lat}" data-lng="${location.lng}">
                                <img src="/images/route_icon.png" alt="Google Maps" style="width: 40px; height: 40px; margin-bottom: -10px;">
                                <div style="margin-top: -10px; margin-bottom: -10px; color: black; font-size: 16px"><p class="dir">Directions</p></div>
                            </a>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);
                });
            }

            function updateUserLocation(e) {
                currentLatLng = e ? e.latlng : lastKnownLatLng;
                if (!currentLatLng) {
                    console.warn('No current location available');
                    return null;
                }

                userLocationMarker.setLatLng(currentLatLng);
                lastKnownLatLng = currentLatLng;

                const { closestLocation, closestDistance } = findClosestLocation(currentLatLng);
                updateDistanceBox(closestDistance);
                checkLocationTransition(closestLocation, closestDistance);
                updateAccuracyMode(closestDistance);

                return currentLatLng;
            }

            function findClosestLocation(currentLatLng) {
                let closestLocation = null;
                let closestDistance = Infinity;

                locations.forEach(location => {
                    const locationLatLng = L.latLng(location.lat, location.lng);
                    const distance = currentLatLng.distanceTo(locationLatLng);
                    const distanceFeet = Math.round(distance * 3.28084);

                    if (distanceFeet < closestDistance) {
                        closestDistance = distanceFeet;
                        closestLocation = location;
                    }
                });

                return { closestLocation, closestDistance };
            }

            function updateDistanceBox(distanceFeet) {
                const distanceBox = document.getElementById("distanceBox");
                if (distanceFeet < 5280) {
                    distanceBox.textContent = `Closest Marker: ${distanceFeet} feet`;
                } else {
                    const distanceMiles = (distanceFeet / 5280).toFixed(2);
                    distanceBox.textContent = `Closest Marker: ${distanceMiles} miles`;
                }
            }

            function checkLocationTransition(closestLocation, distanceFeet) {
                const distanceBox = document.getElementById("distanceBox");
                const latLngId = `${closestLocation.lat},${closestLocation.lng}`;
                const lastTransitionTime = parseInt(sessionStorage.getItem('lastTransitionTime') || '0');
                const lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');
                const timeSinceLastTransition = Date.now() - lastTransitionTime;
                const cooldownActiveForLastLocation = lastVisitedLocation === latLngId && timeSinceLastTransition < COOLDOWN;

                if (distanceFeet <= THRESHOLD_FEET) {
                    if (cooldownActiveForLastLocation) {
                        distanceBox.classList.add("within-cooldown");
                        distanceBox.classList.remove("within-threshold");
                        setTimeout(() => {
                            checkLocationTransition(closestLocation, distanceFeet);
                        }, COOLDOWN - timeSinceLastTransition);
                    } else {
                        distanceBox.classList.add("within-threshold");
                        distanceBox.classList.remove("within-cooldown");
                        setTimeout(() => {
                            sessionStorage.setItem("lastTransitionTime", Date.now().toString());
                            sessionStorage.setItem("lastVisitedLocation", latLngId);
                            window.location.href = `location.html?id=${closestLocation.id}`;
                        }, INITIAL_DELAY);
                    }
                } else {
                    distanceBox.classList.remove("within-threshold", "within-cooldown");
                }
            }

            function updateAccuracyMode(distanceFeet) {
                if (distanceFeet <= HIGH_ACCURACY_THRESHOLD && !useHighAccuracy) {
                    useHighAccuracy = true;
                    restartLocationTracking();
                } else if (distanceFeet > HIGH_ACCURACY_THRESHOLD && useHighAccuracy) {
                    useHighAccuracy = false;
                    restartLocationTracking();
                }
            }

            function restartLocationTracking() {
                map.stopLocate();
                map.locate({
                    watch: true,
                    enableHighAccuracy: useHighAccuracy,
                    maximumAge: 25000,
                });
            }

            function showModal(lat, lng) {
                const modal = document.getElementById("forwardingModal");
                const span = modal.querySelector(".close");
                const continueButton = document.getElementById("continueButton");
                const cancelButton = document.getElementById("cancelButton");

                modal.style.display = "block";

                span.onclick = closeModal;
                cancelButton.onclick = closeModal;
                continueButton.onclick = () => {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
                    closeModal();
                };

                window.onclick = (event) => {
                    if (event.target == modal) {
                        closeModal();
                    }
                };

                function closeModal() {
                    modal.style.display = "none";
                    recenterAndClosePopup();
                }
            }

            function recenterAndClosePopup() {
                if (userLocationMarker.getLatLng()) {
                    map.setView(userLocationMarker.getLatLng(), 19);
                    map.closePopup();
                    userInteracted = false;
                }
            }

            function initEventListeners() {
                map.on("locationfound", updateUserLocation);
                map.on("locationerror", (e) => {
                    console.error("Location error:", e);
                    alert("Failed to access your location. Please make sure location services are enabled and try again.");
                });

                map.on("drag zoomstart", () => {
                    userInteracted = true;
                });

                document.getElementById("recenter-button").addEventListener("click", () => {
                    if (userLocationMarker.getLatLng()) {
                        map.setView(userLocationMarker.getLatLng(), 19);
                        userInteracted = false;
                    } else {
                        alert("User location not available. Please enable location services.");
                    }
                });

                document.getElementById("help-button").addEventListener("click", () => {
                    document.getElementById("explanation-popup").style.display = "block";
                });

                document.getElementById("close-popup").addEventListener("click", () => {
                    document.getElementById("explanation-popup").style.display = "none";
                });

                document.getElementById("exit-button").addEventListener("click", () => {
                    sessionStorage.removeItem('lastTransitionTime');
                    window.location.href = "/index.html";
                });

                markers.on("clusterclick", (e) => {
                    const childMarkers = e.layer.getAllChildMarkers();
                    if (childMarkers.length > 0) {
                        childMarkers[0].openPopup();
                    }
                });
            }

            initMap();
            loadLocations();
            initEventListeners();
        });
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0M8KR45LDB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0M8KR45LDB');
    </script>
</body>
</html>
