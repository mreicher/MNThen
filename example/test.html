<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
        }

        body {
            background-color: #f8fafc;
            min-height: 100vh;
        }

        .navbar {
            background: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .list-group-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-group-item:hover {
            background-color: #f1f5f9;
        }

        .list-group-item.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .spinner-container {
            text-align: center;
        }

        .spinner-text {
            margin-top: 1rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .img-thumbnail {
            object-fit: cover;
            width: 50px;
            height: 50px;
        }

        .modal-content {
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .table {
            vertical-align: middle;
        }

        .btn-icon {
            padding: 0.25rem 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .directory-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: #e2e8f0;
            border-radius: 9999px;
            color: #475569;
        }
    </style>
</head>
<body>
    <div id="loading-spinner" class="d-none">
        <div class="spinner-container">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="spinner-text">Processing...</div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                    <path d="M20 8h-9a2 2 0 0 0-2 2v6c0 1.1.9 2 2 2h9a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2Z"/>
                    <path d="M4 12V8c0-1.1.9-2 2-2h9"/>
                    <path d="M8 16v-4"/>
                </svg>
                Inventory Pro
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center" href="#" id="logout-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Login Form -->
        <div id="login-form" class="card p-4 mx-auto animate__animated animate__fadeIn" style="max-width: 400px;">
            <div class="text-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary mb-3">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <h2 class="fw-bold">Welcome Back</h2>
                <p class="text-muted">Sign in to manage your inventory</p>
            </div>
            <form>
                <div class="mb-3">
                    <label for="username" class="form-label">Email Address</label>
                    <input type="email" class="form-control form-control-lg" id="username" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control form-control-lg" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100">Sign In</button>
            </form>
        </div>

        <!-- Inventory Management -->
        <div id="inventory-management" class="d-none animate__animated animate__fadeIn">
            <div class="row">
                <!-- Directories -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-white border-bottom-0 py-3">
                            <h3 class="card-title mb-0 fw-bold">Categories</h3>
                        </div>
                        <div class="card-body">
                            <ul id="directories" class="list-group list-group-flush"></ul>
                            <div class="mt-4">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="new-directory" placeholder="New Category">
                                    <button class="btn btn-primary" id="create-directory">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items -->
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0 fw-bold">Inventory Items</h3>
                            <button class="btn btn-primary btn-icon" id="add-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add Item
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Quantity</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="item-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Item Modal -->
        <div class="modal fade" id="item-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-bottom-0">
                        <h5 class="modal-title fw-bold" id="item-modal-label">Add New Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="item-form">
                            <div class="mb-3">
                                <label for="item-title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="item-title" required>
                            </div>
                            <div class="mb-3">
                                <label for="item-description" class="form-label">Description</label>
                                <textarea class="form-control" id="item-description" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="item-quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="item-quantity" required min="0">
                            </div>
                            <div class="mb-3">
                                <label for="item-image" class="form-label">Image</label>
                                <input type="file" class="form-control" id="item-image" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label for="item-directory" class="form-label">Category</label>
                                <select class="form-select" id="item-directory" required></select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary px-4" id="save-item">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB39tWEJsbd73MzhFUjoxEXfiTEoCM8ZzM",
            authDomain: "capitol-inventory.firebaseapp.com",
            projectId: "capitol-inventory",
            storageBucket: "capitol-inventory.appspot.com",
            messagingSenderId: "663001635603",
            appId: "1:663001635603:web:2eda30ee0db3114b0198e6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const inventoryManagement = document.getElementById('inventory-management');
        const directoryList = document.getElementById('directories');
        const newDirectoryInput = document.getElementById('new-directory');
        const createDirectoryButton = document.getElementById('create-directory');
        const itemList = document.getElementById('item-list');
        const addItemButton = document.getElementById('add-item');
        const itemModal = new bootstrap.Modal(document.getElementById('item-modal'));
        const itemForm = document.getElementById('item-form');
        const itemDirectorySelect = document.getElementById('item-directory');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingSpinner = document.getElementById('loading-spinner');

        let currentItemId = null;
        let currentDirectory = null;

        // Toast notification function
        function showToast(message, type = "info") {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function showLoading(message = 'Processing...') {
            const spinnerText = loadingSpinner.querySelector('.spinner-text');
            spinnerText.textContent = message;
            loadingSpinner.classList.remove('d-none');
        }

        function hideLoading() {
            loadingSpinner.classList.add('d-none');
        }

        // Authentication
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            showLoading('Signing in...');
            try {
                await signInWithEmailAndPassword(auth, username, password);
                loginForm.classList.add('d-none');
                inventoryManagement.classList.remove('d-none');
                showToast("Welcome back!", "success");
                loadDirectories();
                loadItems();
            } catch (error) {
                showToast(error.message, "danger");
            } finally {
                hideLoading();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast("Logged out successfully", "info");
                loginForm.classList.remove('d-none');
                inventoryManagement.classList.add('d-none');
                loginForm.reset();
            } catch (error) {
                showToast("Logout failed", "danger");
            }
        });

        // Directory Management
        async function loadDirectories() {
            directoryList.innerHTML = '';
            try {
                const querySnapshot = await getDocs(collection(db, 'directories'));
                if (querySnapshot.empty) {
                    directoryList.innerHTML = '<li class="list-group-item text-muted">No categories found</li>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const directoryName = doc.data().name;
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        ${directoryName}
                        <span class="badge bg-primary rounded-pill">0</span>
                    `;
                    li.addEventListener('click', () => {
                        currentDirectory = directoryName;
                        document.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        loadItems(directoryName);
                    });
                    directoryList.appendChild(li);
                });
            } catch (error) {
                showToast("Error loading categories", "danger");
            }
        }

        createDirectoryButton.addEventListener('click', async () => {
            const newDirectory = newDirectoryInput.value.trim();
            if (!newDirectory) {
                showToast("Please enter a category name", "warning");
                return;
            }

            showLoading('Creating category...');
            try {
                await addDoc(collection(db, 'directories'), { name: newDirectory });
                newDirectoryInput.value = '';
                loadDirectories();
                showToast("Category created successfully", "success");
            } catch (error) {
                showToast("Error creating category", "danger");
            } finally {
                hideLoading();
            }
        });

        // Item Management
        async function loadItems(directory = null) {
            showLoading('Loading items...');
            itemList.innerHTML = '';
            try {
                let q = collection(db, 'items');
                if (directory) {
                    q = query(q, where('directory', '==', directory));
                }
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    itemList.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-3">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M3 9h18"/>
                                    <path d="M9 21V9"/>
                                </svg>
                                <p class="mb-0">No items found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    const tr = document.createElement('tr');
                    tr.className = 'animate__animated animate__fadeIn';
                    tr.innerHTML = `
                        <td>
                            <img src="${item.imageUrl || 'https://via.placeholder.com/50'}" 
                                 alt="${item.title}"
                                 class="img-thumbnail"
                                 onerror="this.src='https://via.placeholder.com/50'">
                        </td>
                        <td>
                            <div class="fw-semibold">${item.title}</div>
                            <small class="text-muted directory-badge">${item.directory}</small>
                        </td>
                        <td>${item.description}</td>
                        <td>
                            <span class="badge bg-${item.quantity > 0 ? 'success' : 'danger'} rounded-pill">
                                ${item.quantity}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary edit-item" data-id="${doc.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-item" data-id="${doc.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"/>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;

                    tr.querySelector('.edit-item').addEventListener('click', () => {
                        currentItemId = doc.id;
                        fillItemForm(doc.id);
                        itemModal.show();
                    });

                    tr.querySelector('.delete-item').addEventListener('click', () => {
                        deleteItem(doc.id);
                    });

                    itemList.appendChild(tr);
                });
            } catch (error) {
                showToast("Error loading items", "danger");
            } finally {
                hideLoading();
            }
        }

        async function fillItemForm(itemId) {
            showLoading('Loading item details...');
            try {
                const docRef = doc(db, 'items', itemId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const item = docSnap.data();
                    document.getElementById('item-title').value = item.title;
                    document.getElementById('item-description').value = item.description;
                    document.getElementById('item-quantity').value = item.quantity;
                    document.getElementById('item-directory').value = item.directory;
                    document.getElementById('item-modal-label').textContent = 'Edit Item';
                }
            } catch (error) {
                showToast("Error loading item details", "danger");
            } finally {
                hideLoading();
            }
        }

        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            showLoading('Deleting item...');
            try {
                await deleteDoc(doc(db, 'items', itemId));
                loadItems(currentDirectory);
                showToast("Item deleted successfully", "success");
            } catch (error) {
                showToast("Error deleting item", "danger");
            } finally {
                hideLoading();
            }
        }

        addItemButton.addEventListener('click', () => {
            currentItemId = null;
            itemForm.reset();
            document.getElementById('item-modal-label').textContent = 'Add New Item';
            loadDirectoriesForSelect();
            itemModal.show();
        });

        document.getElementById('save-item').addEventListener('click', async () => {
            const title = document.getElementById('item-title').value;
            const description = document.getElementById('item-description').value;
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const image = document.getElementById('item-image').files[0];
            const directory = document.getElementById('item-directory').value;

            if (!title || !description || isNaN(quantity) || !directory) {
                showToast("Please fill in all required fields", "warning");
                return;
            }

            showLoading('Saving item...');
            try {
                let imageUrl = '';
                if (image) {
                    const storageRef = ref(storage, `items/${Date.now()}_${image.name}`);
                    const snapshot = await uploadBytes(storageRef, image);
                    imageUrl = await getDownloadURL(snapshot.ref);
                }

                const itemData = {
                    title,
                    description,
                    quantity,
                    directory,
                    ...(imageUrl && { imageUrl }),
                    updatedAt: new Date().toISOString()
                };

                if (currentItemId) {
                    await updateDoc(doc(db, 'items', currentItemId), itemData);
                    showToast("Item updated successfully", "success");
                } else {
                    await addDoc(collection(db, 'items'), {
                        ...itemData,
                        createdAt: new Date().toISOString()
                    });
                    showToast("Item added successfully", "success");
                }

                itemModal.hide();
                loadItems(currentDirectory);
            } catch (error) {
                showToast("Error saving item", "danger");
            } finally {
                hideLoading();
            }
        });

        async function loadDirectoriesForSelect() {
            itemDirectorySelect.innerHTML = '<option value="">Select a category</option>';
            try {
                const querySnapshot = await getDocs(collection(db, 'directories'));
                querySnapshot.forEach((doc) => {
                    const option = document.createElement('option');
                    option.value = doc.data().name;
                    option.textContent = doc.data().name;
                    if (currentDirectory === doc.data().name) {
                        option.selected = true;
                    }
                    itemDirectorySelect.appendChild(option);
                });
            } catch (error) {
                showToast("Error loading categories", "danger");
            }
        }

        // Initialize app
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginForm.classList.add('d-none');
                inventoryManagement.classList.remove('d-none');
                loadDirectories();
                loadItems();
            } else {
                loginForm.classList.remove('d-none');
                inventoryManagement.classList.add('d-none');
            }
        });

        // Offline detection
        window.addEventListener('online', () => showToast("You're back online", "success"));
        window.addEventListener('offline', () => showToast("You're offline. Some features may be unavailable.", "warning"));
    </script>
</body>
</html>
