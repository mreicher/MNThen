<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Minnesota Then History Tours</title>
  <link rel="shortcut icon" type="image/jpg" href="/images/mnthenfav.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <style>
    .map-container {
      height: 450px;
      margin-bottom: 10px;
    }

    #map {
      width: 100%;
      height: 450px;
    }

    .message-box {
      padding: 10px;
      margin-bottom: 20px;
    }

    .safety-message-box {
      padding: 16px;
    }

    body {
      font-size: 18px;
    }

    @media (max-width: 768px) {
      body {
        font-size: 16px;
      }
    }

    .leaflet-popup-content-wrapper:before {
      content: attr(data-number);
      background-color: #0089e0;
      color: #fff;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }

    .leaflet-popup-content {
      font-size: 18px;
    }

    .leaflet-popup-tip-container {
      display: none;
    }
  </style>
</head>
<body style="margin: 0; padding: 0;">
  <div id="map" class="map-container"></div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-12 text-center">
        <button id="returnButton" class="btn btn-lg btn-secondary">Exit the Tour</button>
        <p></p>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="message-box bg-primary text-white p-3 rounded mb-3" style="font-size: 1.2rem;">
          <p><strong>Navigation Tip:</strong> Discover historical locations by moving toward the map's blue markers. Your mobile device will automatically update with information when you're in range.</p>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="safety-message-box bg-danger text-white p-3 rounded" style="font-size: 1.2rem;">
          <p><strong>Safety Reminder:</strong> We want you to have a safe and enjoyable experience while exploring local history. Please keep an eye on your surroundings and be mindful of potential hazards.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="locations.js"></script>
  <script>
    function checkLocationServicesEnabled() {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          function success() {
            // Location services are enabled
            console.log("Location services are enabled");
            initializeMap();
          },
          function error(error) {
            if (error.code === error.PERMISSION_DENIED) {
              // Location services are disabled
              console.log("Location services are disabled");
              promptToEnableLocationServices();
            }
          }
        );
      } else {
        // Geolocation not supported
        console.log("Geolocation is not supported");
      }
    }

function promptToEnableLocationServices() {
  // Prompt the user to enable location services
  if (confirm("Location services are disabled. Do you want to enable them?")) {
    // Call the geolocation API again to trigger the browser's location permission prompt
    navigator.geolocation.getCurrentPosition(
      function success() {
        // Location services enabled
        console.log("Location services are enabled");
      },
      function error() {
        // Location services still disabled or permission denied
        console.log("Location services are still disabled");
        alert("Location services remain disabled. Some features may not work correctly.");
      }
    );
  } else {
    // User chose not to enable location services
    console.log("Location services are disabled");
    alert("Location services remain disabled. Some features may not work correctly.");
  }
}

    function initializeMap() {
      var map = L.map('map', {
        attributionControl: false
      }).setView([44.962472993853055, -93.07146893327669], 18);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
      }).addTo(map);

      L.control.attribution({
        prefix: false
      }).addTo(map);

      for (var i = 0; i < locations.length; i++) {
        var marker = L.marker([locations[i].lat, locations[i].lng])
          .bindPopup("<b>" + "" + " " + locations[i].name + "</b>")
          .addTo(map);
      }

      var userLocationMarker = L.circleMarker([0, 0], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5,
        radius: 10
      }).addTo(map);

      var isUpdatingLocation = false;
      var updateInterval = 2000;

      var isLocationFound = false;
      var feetToMeters = 0.3048;
      var thresholdFeet = 7;
      var thresholdMeters = thresholdFeet * feetToMeters;

      function onLocationFound(e) {
        if (!isLocationFound) {
          isLocationFound = true;
          map.setView(e.latlng);
        }

        function updateUserLocation() {
          if (isUpdatingLocation) return;

          isUpdatingLocation = true;
          setTimeout(function() {
            isUpdatingLocation = false;
          }, updateInterval);

          for (var i = 0; i < locations.length; i++) {
            var distance = e.latlng.distanceTo(L.latLng(locations[i].lat, locations[i].lng));
            if (distance <= thresholdMeters) {
              setTimeout(function() {
                window.location.href = `${locations[i].name}.html`;
              }, 3000);
              return;
            }
          }
        }

        updateUserLocation();
        userLocationMarker.setLatLng(e.latlng);
      }

      function onLocationError(e) {
        if (!isLocationFound) {
          setTimeout(function() {
            alert("Failed to retrieve location. Please make sure location services are enabled and try again.");
          }, 8000);
        }
      }

      map.on('locationfound', onLocationFound);
      map.on('locationerror', onLocationError);

      map.locate({ setView: true, maxZoom: 18, watch: true });
    }

    // Event listener for the return button
    document.getElementById('returnButton').addEventListener('click', function() {
      window.location.href = 'tour_page.html';
    });

    // Call the function to check location services on page load
    checkLocationServicesEnabled();
  </script>
</body>
</html>
