<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then - Historical Mapping Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
   <style>
       body, html {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
}

.navbar {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-container {
    background-color: #f8f9fa;
    padding: 20px 0;
    border-bottom: 1px solid #e9ecef;
    margin-top: 56px;
}

#map {
    width: 100%;
    height: calc(100vh - 170px);
    margin-bottom: 60px;
}

.sidebar {
    position: fixed;
    top: 76px;
    right: -350px;
    width: 350px;
    height: calc(100vh - 136px);
    background-color: #fff;
    box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    overflow-y: auto;
    transition: right 0.3s ease-in-out;
    z-index: 1000;
}

.sidebar.active {
    right: 0;
}

.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    background: none;
    border: none;
    cursor: pointer;
}

.bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #343a40;
    color: white;
    padding: 10px 0;
    z-index: 1000;
}

.bottom-bar-btn {
    color: white;
    background: none;
    border: none;
    cursor: pointer;
}

.location-image {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
    margin-bottom: 15px;
}

.comment {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
}

.thread {
    margin-left: 20px;
    border-left: 2px solid #007bff;
    padding-left: 10px;
}

.user-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-right: 5px;
}

.badge-contributor {
    background-color: #28a745;
    color: white;
}

.badge-historian {
    background-color: #17a2b8;
    color: white;
}

.family-history-tag {
    background-color: #ffc107;
    color: #212529;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-right: 5px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1060;
    min-width: 250px;
}

   </style>
</head>
<body>
    <header>
        <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Minnesota Then</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="aboutUsBtn">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="instructionsBtn">Instructions</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="statsBtn">Statistics</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="account-link">Log In | Register</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="search-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Enter a city in Minnesota">
                        <button class="btn btn-primary" type="button" id="searchButton">Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div id="sidebar" class="sidebar">
        <button id="closeSidebar" class="close-btn">&times;</button>
        <div id="sidebarContent"></div>
    </div>

    <div class="bottom-bar">
        <div class="container">
            <div class="row">
                <div class="col-3 text-center">
                    <button class="bottom-bar-btn" id="homeBtn">
                        <i class="fas fa-home"></i> Home
                    </button>
                </div>
                <div class="col-3 text-center">
                    <button class="bottom-bar-btn" id="resetMapBtn">
                        <i class="fas fa-undo"></i> Reset Map
                    </button>
                </div>
                <div class="col-3 text-center">
                    <button class="bottom-bar-btn" id="profileBtn">
                        <i class="fas fa-user"></i> Profile
                    </button>
                </div>
                <div class="col-3 text-center">
                    <button class="bottom-bar-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Add Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm">
                        <div class="mb-3">
                            <label for="locationName" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="locationName" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="locationDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="locationStory" class="form-label">Historical Story</label>
                            <textarea class="form-control" id="locationStory" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="locationImage" class="form-label">Image (max 5MB)</label>
                            <input type="file" class="form-control" id="locationImage" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="imageYear" class="form-label">Year Image Taken</label>
                            <input type="number" class="form-control" id="imageYear" min="1800" max="2099" step="1">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="familyHistoryCheck">
                            <label class="form-check-label" for="familyHistoryCheck">This is part of my family history</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Location</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aboutUsModal" tabindex="-1" aria-labelledby="aboutUsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutUsModalLabel">About Minnesota Then</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Minnesota Then is a cultural heritage mapping platform that allows users to explore and contribute to the rich history of Minnesota. Our goal is to create a comprehensive, user-driven map of historically and culturally significant locations across the state.</p>
                    <p>Features include:</p>
                    <ul>
                        <li>Interactive map of historical locations</li>
                        <li>User-contributed content</li>
                        <li>Family history tagging</li>
                        <li>Community discussions through threads</li>
                        <li>User badges for active contributors</li>
                    </ul>
                    <p>Join us in preserving and sharing Minnesota's diverse cultural heritage!</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="instructionsModalLabel">How to Use Minnesota Then</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ol>
                        <li>Create an account or log in to start contributing.</li>
                        <li>Explore the map to discover historical locations.</li>
                        <li>Click on a location to view details and join discussions.</li>
                        <li>Add new locations by clicking on the map and filling out the form.</li>
                        <li>Tag locations as part of your family history.</li>
                        <li>Engage in discussions by adding comments and replying to threads.</li>
                        <li>Earn badges by actively contributing to the platform.</li>
                    </ol>
                    <p>Remember to respect copyright and privacy when adding information and images.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalLabel">Platform Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="statsModalBody">
                    <!-- Statistics will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
    authDomain: "mnthen-3151d.firebaseapp.com",
    projectId: "mnthen-3151d",
    storageBucket: "mnthen-3151d.appspot.com",
    messagingSenderId: "416231360428",
    appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

// Initialize map
const map = L.map('map').setView([46.7296, -94.6859], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// Initialize marker cluster group
const markers = L.markerClusterGroup();
map.addLayer(markers);

// DOM elements
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const locationForm = document.getElementById('locationForm');
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebarContent');
const closeSidebar = document.getElementById('closeSidebar');
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const aboutUsBtn = document.getElementById('aboutUsBtn');
const instructionsBtn = document.getElementById('instructionsBtn');
const statsBtn = document.getElementById('statsBtn');
const homeBtn = document.getElementById('homeBtn');
const resetMapBtn = document.getElementById('resetMapBtn');
const profileBtn = document.getElementById('profileBtn');
const logoutBtn = document.getElementById('logoutBtn');
const accountLink = document.getElementById('account-link');

// Event listeners
loginForm.addEventListener('submit', handleLogin);
registerForm.addEventListener('submit', handleRegister);
locationForm.addEventListener('submit', handleLocationSubmit);
closeSidebar.addEventListener('click', () => sidebar.classList.remove('active'));
searchButton.addEventListener('click', handleSearch);
aboutUsBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('aboutUsModal')).show());
instructionsBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('instructionsModal')).show());
statsBtn.addEventListener('click', showStats);
homeBtn.addEventListener('click', () => map.setView([46.7296, -94.6859], 7));
resetMapBtn.addEventListener('click', resetMap);
profileBtn.addEventListener('click', showProfile);
logoutBtn.addEventListener('click', handleLogout);
accountLink.addEventListener('click', showLoginRegisterModal);

map.on('click', handleMapClick);

// Authentication state observer
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        accountLink.textContent = 'Profile';
        loadLocations();
    } else {
        accountLink.textContent = 'Log In | Register';
        resetMap();
    }
});

function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => {
            showNotification('Logged in successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        })
        .catch((error) => showNotification('Login error: ' + error.message, 'danger'));
}

function handleRegister(e) {
    e.preventDefault();
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const name = document.getElementById('registerName').value;

    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            const user = userCredential.user;
            return firebase.database().ref('users/' + user.uid).set({
                email: email,
                name: name,
                contributionCount: 0
            });
        })
        .then(() => {
            showNotification('Registered successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
        })
        .catch((error) => showNotification('Registration error: ' + error.message, 'danger'));
}

function handleLocationSubmit(e) {
    e.preventDefault();
    const name = document.getElementById('locationName').value;
    const description = document.getElementById('locationDescription').value;
    const story = document.getElementById('locationStory').value;
    const imageFile = document.getElementById('locationImage').files[0];
    const imageYear = document.getElementById('imageYear').value;
    const isFamilyHistory = document.getElementById('familyHistoryCheck').checked;

    if (imageFile && imageFile.size > 5 * 1024 * 1024) {
        showNotification('Image size must be less than 5MB', 'warning');
        return;
    }

    const user = firebase.auth().currentUser;
    const locationData = {
        name,
        description,
        story,
        lat: window.tempLatLng.lat,
        lng: window.tempLatLng.lng,
        userId: user.uid,
        imageYear,
        isFamilyHistory,
        timestamp: Date.now()
    };

    if (imageFile) {
        const storageRef = firebase.storage().ref('location_images/' + Date.now() + '_' + imageFile.name);
        storageRef.put(imageFile).then((snapshot) => {
            snapshot.ref.getDownloadURL().then((imageUrl) => {
                locationData.imageUrl = imageUrl;
                saveLocationToDatabase(locationData);
            });
        });
    } else {
        saveLocationToDatabase(locationData);
    }

    bootstrap.Modal.getInstance(document.getElementById('locationModal')).hide();
}

function saveLocationToDatabase(locationData) {
    firebase.database().ref('locations').push(locationData)
        .then((ref) => {
            showNotification('Location added successfully!', 'success');
            addMarkerToMap(ref.key, locationData);
            incrementUserContributionCount(locationData.userId);
        })
        .catch((error) => showNotification('Error adding location: ' + error.message, 'danger'));
}

function addMarkerToMap(key, location) {
    const marker = L.marker([location.lat, location.lng]);
    marker.on('click', () => showLocationDetails(key, location));
    markers.addLayer(marker);
}

function showLocationDetails(key, location) {
    sidebar.classList.add('active');
    sidebarContent.innerHTML = createLocationDetailsHTML(key, location);
    loadComments(key);
}

function createLocationDetailsHTML(key, location) {
    let html = `
        <h2>${location.name}</h2>
        <p>${location.description}</p>
    `;
    if (location.story) {
        html += `<h3>Historical Story</h3><p>${location.story}</p>`;
    }
    if (location.imageUrl) {
        html += `<img src="${location.imageUrl}" alt="${location.name}" class="location-image">`;
    }
    if (location.imageYear) {
        html += `<p>Image taken in: ${location.imageYear}</p>`;
    }
    if (location.isFamilyHistory) {
        html += `<span class="family-history-tag">Family History</span>`;
    }
    html += `
        <h3>Comments</h3>
        <div id="commentsContainer"></div>
        <form id="commentForm">
            <div class="mb-3">
                <textarea class="form-control" id="commentText" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Add Comment</button>
        </form>
    `;
    return html;
}

function loadComments(locationKey) {
    const commentsContainer = document.getElementById('commentsContainer');
    commentsContainer.innerHTML = '';
    firebase.database().ref('comments').orderByChild('locationId').equalTo(locationKey).on('child_added', (snapshot) => {
        const comment = snapshot.val();
        const commentElement = document.createElement('div');
        commentElement.className = 'comment';
        commentElement.innerHTML = `
            <p><strong>${comment.userName}</strong> ${getUserBadges(comment.userId)} - ${new Date(comment.timestamp).toLocaleString()}</p>
            <p>${comment.text}</p>
            <button class="btn btn-sm btn-secondary reply-btn" data-comment-id="${snapshot.key}">Reply</button>
            <div class="thread" id="thread-${snapshot.key}"></div>
        `;
        commentsContainer.appendChild(commentElement);
        loadReplies(snapshot.key);

        // Add event listener for reply button
        commentElement.querySelector('.reply-btn').addEventListener('click', () => {
            showReplyForm(snapshot.key, locationKey);
        });
    });

    document.getElementById('commentForm').onsubmit = (e) => {
        e.preventDefault();
        const commentText = document.getElementById('commentText').value;
        addComment(locationKey, commentText);
    };
}

function addComment(locationKey, text) {
    const user = firebase.auth().currentUser;
    firebase.database().ref('users/' + user.uid).once('value')
        .then((snapshot) => {
            const userData = snapshot.val();
            const comment = {
                locationId: locationKey,
                userId: user.uid,
                userName: userData.name,
                text: text,
                timestamp: Date.now()
            };
            return firebase.database().ref('comments').push(comment);
        })
        .then(() => {
            document.getElementById('commentText').value = '';
            showNotification('Comment added successfully!', 'success');
        })
        .catch((error) => showNotification('Error adding comment: ' + error.message, 'danger'));
}

function loadReplies(commentId) {
    const threadContainer = document.getElementById(`thread-${commentId}`);
    firebase.database().ref('replies').orderByChild('commentId').equalTo(commentId).on('child_added', (snapshot) => {
        const reply = snapshot.val();
        const replyElement = document.createElement('div');
        replyElement.className = 'thread-reply';
        replyElement.innerHTML = `
            <p><strong>${reply.userName}</strong> ${getUserBadges(reply.userId)} - ${new Date(reply.timestamp).toLocaleString()}</p>
            <p>${reply.text}</p>
        `;
        threadContainer.appendChild(replyElement);
    });
}

function showReplyForm(commentId, locationKey) {
    const threadContainer = document.getElementById(`thread-${commentId}`);
    const replyForm = document.createElement('form');
    replyForm.innerHTML = `
        <div class="mb-3">
            <textarea class="form-control" rows="2" required></textarea>
        </div>
        <button type="submit" class="btn btn-sm btn-primary">Submit Reply</button>
    `;
    replyForm.onsubmit = (e) => {
        e.preventDefault();
        const replyText = e.target.querySelector('textarea').value;
        addReply(commentId, locationKey, replyText);
        replyForm.remove();
    };
    threadContainer.appendChild(replyForm);
}

function addReply(commentId, locationKey, text) {
    const user = firebase.auth().currentUser;
    firebase.database().ref('users/' + user.uid).once('value')
        .then((snapshot) => {
            const userData = snapshot.val();
            const reply = {
                commentId: commentId,
                locationId: locationKey,
                userId: user.uid,
                userName: userData.name,
                text: text,
                timestamp: Date.now()
            };
            return firebase.database().ref('replies').push(reply);
        })
        .then(() => {
            showNotification('Reply added successfully!', 'success');
        })
        .catch((error) => showNotification('Error adding reply: ' + error.message, 'danger'));
}

function handleSearch() {
    const query = searchInput.value + ', Minnesota';
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                const { lat, lon } = data[0];
                map.setView([lat, lon], 12);
            } else {
                showNotification('Location not found', 'warning');
            }
        })
        .catch(error => {
            console.error('Error searching for location:', error);
            showNotification('Error searching for location', 'danger');
        });
}

function handleMapClick(e) {
    if (firebase.auth().currentUser) {
        window.tempLatLng = e.latlng;
        new bootstrap.Modal(document.getElementById('locationModal')).show();
    } else {
        showNotification('Please log in to add a location', 'warning');
    }
}

function resetMap() {
    map.setView([46.7296, -94.6859], 7);
    markers.clearLayers();
    loadLocations();
}

function loadLocations() {
    firebase.database().ref('locations').once('value', (snapshot) => {
        snapshot.forEach((childSnapshot) => {
            const key = childSnapshot.key;
            const location = childSnapshot.val();
            addMarkerToMap(key, location);
        });
    });
}

function showProfile() {
    const user = firebase.auth().currentUser;
    if (user) {
        firebase.database().ref('users/' + user.uid).once('value')
            .then((snapshot) =>
            {
                const userData = snapshot.val();
                sidebar.classList.add('active');
                sidebarContent.innerHTML = `
                    <h2>User Profile</h2>
                    <p><strong>Name:</strong> ${userData.name}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Contributions:</strong> ${userData.contributionCount || 0}</p>
                    <h3>Badges</h3>
                    <div>${getUserBadges(user.uid)}</div>
                    <h3>Your Locations</h3>
                    <div id="userLocations"></div>
                `;
                loadUserLocations(user.uid);
            });
    } else {
        showNotification('Please log in to view your profile', 'warning');
    }
}

function loadUserLocations(userId) {
    const userLocationsContainer = document.getElementById('userLocations');
    firebase.database().ref('locations').orderByChild('userId').equalTo(userId).once('value', (snapshot) => {
        snapshot.forEach((childSnapshot) => {
            const location = childSnapshot.val();
            const locationElement = document.createElement('div');
            locationElement.innerHTML = `
                <h4>${location.name}</h4>
                <p>${location.description}</p>
                ${location.isFamilyHistory ? '<span class="family-history-tag">Family History</span>' : ''}
            `;
            userLocationsContainer.appendChild(locationElement);
        });
    });
}

function handleLogout() {
    firebase.auth().signOut()
        .then(() => {
            showNotification('Logged out successfully', 'success');
            resetMap();
        })
        .catch((error) => showNotification('Logout error: ' + error.message, 'danger'));
}

function showLoginRegisterModal() {
    if (firebase.auth().currentUser) {
        showProfile();
    } else {
        new bootstrap.Modal(document.getElementById('loginModal')).show();
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function getUserBadges(userId) {
    // This is a placeholder. In a real application, you would fetch the user's badges from the database.
    return `
        <span class="user-badge badge-contributor">Contributor</span>
        <span class="user-badge badge-historian">Historian</span>
    `;
}

function incrementUserContributionCount(userId) {
    const userRef = firebase.database().ref('users/' + userId);
    userRef.transaction((userData) => {
        if (userData) {
            userData.contributionCount = (userData.contributionCount || 0) + 1;
        }
        return userData;
    });
}

function showStats() {
    firebase.database().ref('locations').once('value')
        .then((locationsSnapshot) => {
            const locationCount = locationsSnapshot.numChildren();
            return firebase.database().ref('users').once('value')
                .then((usersSnapshot) => {
                    const userCount = usersSnapshot.numChildren();
                    const statsModalBody = document.getElementById('statsModalBody');
                    statsModalBody.innerHTML = `
                        <p><strong>Total Locations:</strong> ${locationCount}</p>
                        <p><strong>Total Users:</strong> ${userCount}</p>
                    `;
                    new bootstrap.Modal(document.getElementById('statsModal')).show();
                });
        })
        .catch((error) => {
            console.error('Error fetching stats:', error);
            showNotification('Error fetching statistics', 'danger');
        });
}

// Initialize the map and load locations when the page loads
document.addEventListener('DOMContentLoaded', () => {
    loadLocations();
});
    </script>
</body>
</html>
