<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultural Heritage Mapping Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
    height: 100%;
    margin: 0;
    padding: 0;
}

.d-flex {
    height: calc(100% - 56px);
}

#map {
    flex: 1;
    height: 100%;
}

#sidebar {
    width: 400px;
    height: 100%;
    overflow-y: auto;
    padding: 20px;
    background-color: #f8f9fa;
    border-left: 1px solid #dee2e6;
}

.navbar {
    z-index: 1000;
}

.location-image {
    max-width: 100%;
    height: auto;
    margin-bottom: 10px;
}

.comment {
    border-bottom: 1px solid #dee2e6;
    padding: 10px 0;
}

.comment:last-child {
    border-bottom: none;
}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Cultural Heritage Map</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="loginBtn">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="registerBtn">Register</a>
                    </li>
                    <li class="nav-item d-none" id="profileNavItem">
                        <a class="nav-link" href="#" id="profileBtn">Profile</a>
                    </li>
                    <li class="nav-item d-none" id="logoutNavItem">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="d-flex">
        <div id="map"></div>
        <div id="sidebar" class="d-none">
            <button type="button" class="btn-close float-end" aria-label="Close" id="closeSidebar"></button>
            <div id="sidebarContent"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="registerUsername" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Info Modal -->
    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Add Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm">
                        <div class="mb-3">
                            <label for="locationName" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="locationName" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationDescription" class="form-label">Historical or Cultural Significance</label>
                            <textarea class="form-control" id="locationDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="locationImage" class="form-label">Upload Image (max 75KB)</label>
                            <input type="file" class="form-control" id="locationImage" accept="image/*">
                            <div id="imageError" class="text-danger"></div>
                        </div>
                        <div class="mb-3">
                            <label for="imageYear" class="form-label">Year Image Taken</label>
                            <input type="number" class="form-control" id="imageYear" min="1800" max="2099" step="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationStory" class="form-label">Short Story or Fact</label>
                            <textarea class="form-control" id="locationStory" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Location</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // Firebase configuration
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
        authDomain: "mnthen-3151d.firebaseapp.com",
        projectId: "mnthen-3151d",
        storageBucket: "mnthen-3151d.appspot.com",
        messagingSenderId: "416231360428",
        appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

// Initialize map
const map = L.map('map').setView([46.7296, -94.6859], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// DOM elements
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const logoutBtn = document.getElementById('logoutBtn');
const profileBtn = document.getElementById('profileBtn');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const locationForm = document.getElementById('locationForm');
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebarContent');
const closeSidebar = document.getElementById('closeSidebar');

// Event listeners
loginBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('loginModal')).show());
registerBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('registerModal')).show());
logoutBtn.addEventListener('click', logout);
loginForm.addEventListener('submit', login);
registerForm.addEventListener('submit', register);
locationForm.addEventListener('submit', submitLocation);
closeSidebar.addEventListener('click', () => sidebar.classList.add('d-none'));

map.on('click', (e) => {
    if (firebase.auth().currentUser) {
        showLocationModal(e.latlng);
    } else {
        alert('Please log in to add a location.');
    }
});

// Authentication functions
function login(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            updateUI(true);
        })
        .catch((error) => alert(error.message));
}

function register(e) {
    e.preventDefault();
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const username = document.getElementById('registerUsername').value;

    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            return userCredential.user.updateProfile({
                displayName: username
            });
        })
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
            updateUI(true);
        })
        .catch((error) => alert(error.message));
}

function logout() {
    firebase.auth().signOut()
        .then(() => updateUI(false))
        .catch((error) => alert(error.message));
}

function updateUI(loggedIn) {
    loginBtn.classList.toggle('d-none', loggedIn);
    registerBtn.classList.toggle('d-none', loggedIn);
    logoutBtn.parentElement.classList.toggle('d-none', !loggedIn);
    profileBtn.parentElement.classList.toggle('d-none', !loggedIn);
}

// Location functions
function showLocationModal(latlng) {
    const modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();
    locationForm.onsubmit = (e) => submitLocation(e, latlng);
}

function submitLocation(e, latlng) {
    e.preventDefault();
    const name = document.getElementById('locationName').value;
    const description = document.getElementById('locationDescription').value;
    const story = document.getElementById('locationStory').value;
    const imageFile = document.getElementById('locationImage').files[0];
    const imageYear = document.getElementById('imageYear').value;

    if (imageFile && imageFile.size > 75 * 1024) {
        document.getElementById('imageError').textContent = 'Image size must be less than 75KB';
        return;
    }

    const locationData = {
        name,
        description,
        story,
        lat: latlng.lat,
        lng: latlng.lng,
        userId: firebase.auth().currentUser.uid,
        username: firebase.auth().currentUser.displayName,
        imageYear,
        timestamp: Date.now()
    };

    if (imageFile) {
        const storageRef = firebase.storage().ref('location_images/' + Date.now() + '_' + imageFile.name);
        storageRef.put(imageFile).then((snapshot) => {
            snapshot.ref.getDownloadURL().then((imageUrl) => {
                locationData.imageUrl = imageUrl;
                saveLocationToDatabase(locationData);
            });
        });
    } else {
        saveLocationToDatabase(locationData);
    }

    bootstrap.Modal.getInstance(document.getElementById('locationModal')).hide();
}

function saveLocationToDatabase(locationData) {
    firebase.database().ref('locations').push(locationData)
        .then(() => {
            addMarkerToMap(locationData);
            alert('Location added successfully!');
        })
        .catch((error) => alert('Error adding location: ' + error.message));
}

function addMarkerToMap(location) {
    const marker = L.marker([location.lat, location.lng]).addTo(map);
    marker.on('click', () => showLocationDetails(location));
}

function showLocationDetails(location) {
    sidebar.classList.remove('d-none');
    sidebarContent.innerHTML = createSidebarContent(location);
    loadComments(location);
}

function createSidebarContent(location) {
    let content = `
        <h2>${location.name}</h2>
        <p><strong>Added by:</strong> ${location.username}</p>
        <p><strong>Date added:</strong> ${new Date(location.timestamp).toLocaleDateString()}</p>
    `;
    if (location.imageUrl) {
        content += `
            <img src="${location.imageUrl}" alt="${location.name}" class="location-image">
            <p><strong>Year image taken:</strong> ${location.imageYear}</p>
        `;
    }
    content += `
        <p><strong>Description:</strong> ${location.description}</p>
        <p><strong>Story:</strong> ${location.story || 'No story provided'}</p>
        <h3>Comments</h3>
        <div id="commentsContainer"></div>
        <form id="commentForm">
            <div class="mb-3">
                <label for="commentText" class="form-label">Add a comment</label>
                <textarea class="form-control" id="commentText" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Comment</button>
        </form>
    `;
    return content;
}

function loadComments(location) {
    const commentsContainer = document.getElementById('commentsContainer');
    commentsContainer.innerHTML = '';
    
    firebase.database().ref('comments').orderByChild('locationId').equalTo(location.key).on('child_added', (snapshot) => {
        const comment = snapshot.val();
        const commentElement = document.createElement('div');
        commentElement.className = 'comment';
        commentElement.innerHTML = `
            <p><strong>${comment.username}</strong> - ${new Date(comment.timestamp).toLocaleString()}</p>
            <p>${comment.text}</p>
        `;
        commentsContainer.appendChild(commentElement);
    });

    document.getElementById('commentForm').onsubmit = (e) => {
        e.preventDefault();
        const commentText = document.getElementById('commentText').value;
        submitComment(location.key, commentText);
    };
}

function submitComment(locationId, text) {
    const comment = {
        locationId,
        text,
        userId: firebase.auth().currentUser.uid,
        username: firebase.auth().currentUser.displayName,
        timestamp: Date.now()
    };

    firebase.database().ref('comments').push(comment)
        .then(() => {
            document.getElementById('commentText').value = '';
        })
        .catch((error) => alert('Error adding comment: ' + error.message));
}

// Load existing locations
function loadLocations() {
    firebase.database().ref('locations').on('child_added', (snapshot) => {
        const location = snapshot.val();
        location.key = snapshot.key;
        addMarkerToMap(location);
    });
}

// Initialize app
firebase.auth().onAuthStateChanged((user) => {
    updateUI(!!user);
    if (user) {
        loadLocations();
    }
});
    </script>
</body>
</html>
