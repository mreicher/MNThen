<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultural Heritage Mapping Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
   <style>

body, html {
    height: 100%;
    margin: 0;
    padding: 0;
}

#map {
    height: calc(100% - 56px);
    width: 100%;
}

.navbar {
    z-index: 1000;
}

.leaflet-popup-content-wrapper {
    max-width: 300px;
}

.location-image {
    max-width: 100%;
    height: auto;
    margin-bottom: 10px;
}

</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Cultural Heritage Map</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="loginBtn">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="registerBtn">Register</a>
                    </li>
                    <li class="nav-item d-none" id="profileNavItem">
                        <a class="nav-link" href="#" id="profileBtn">Profile</a>
                    </li>
                    <li class="nav-item d-none" id="logoutNavItem">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Info Modal -->
    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Add Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm">
                        <div class="mb-3">
                            <label for="locationName" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="locationName" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationDescription" class="form-label">Historical or Cultural Significance</label>
                            <textarea class="form-control" id="locationDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="locationImage" class="form-label">Upload Image</label>
                            <input type="file" class="form-control" id="locationImage" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="locationStory" class="form-label">Short Story or Fact</label>
                            <textarea class="form-control" id="locationStory" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Location</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>// Firebase configuration
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Initialize map
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// DOM elements
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const logoutBtn = document.getElementById('logoutBtn');
const profileBtn = document.getElementById('profileBtn');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const locationForm = document.getElementById('locationForm');

// Event listeners
loginBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('loginModal')).show());
registerBtn.addEventListener('click', () => new bootstrap.Modal(document.getElementById('registerModal')).show());
logoutBtn.addEventListener('click', logout);
loginForm.addEventListener('submit', login);
registerForm.addEventListener('submit', register);
locationForm.addEventListener('submit', submitLocation);

map.on('click', (e) => {
    if (firebase.auth().currentUser) {
        showLocationModal(e.latlng);
    } else {
        alert('Please log in to add a location.');
    }
});

// Authentication functions
function login(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            updateUI(true);
        })
        .catch((error) => alert(error.message));
}

function register(e) {
    e.preventDefault();
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;

    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
            updateUI(true);
        })
        .catch((error) => alert(error.message));
}

function logout() {
    firebase.auth().signOut()
        .then(() => updateUI(false))
        .catch((error) => alert(error.message));
}

function updateUI(loggedIn) {
    loginBtn.classList.toggle('d-none', loggedIn);
    registerBtn.classList.toggle('d-none', loggedIn);
    logoutBtn.parentElement.classList.toggle('d-none', !loggedIn);
    profileBtn.parentElement.classList.toggle('d-none', !loggedIn);
}

// Location functions
function showLocationModal(latlng) {
    const modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();
    locationForm.onsubmit = (e) => submitLocation(e, latlng);
}

function submitLocation(e, latlng) {
    e.preventDefault();
    const name = document.getElementById('locationName').value;
    const description = document.getElementById('locationDescription').value;
    const story = document.getElementById('locationStory').value;
    const imageFile = document.getElementById('locationImage').files[0];

    const locationData = {
        name,
        description,
        story,
        lat: latlng.lat,
        lng: latlng.lng,
        userId: firebase.auth().currentUser.uid
    };

    if (imageFile) {
        const storageRef = firebase.storage().ref('location_images/' + Date.now() + '_' + imageFile.name);
        storageRef.put(imageFile).then((snapshot) => {
            snapshot.ref.getDownloadURL().then((imageUrl) => {
                locationData.imageUrl = imageUrl;
                saveLocationToDatabase(locationData);
            });
        });
    } else {
        saveLocationToDatabase(locationData);
    }

    bootstrap.Modal.getInstance(document.getElementById('locationModal')).hide();
}

function saveLocationToDatabase(locationData) {
    firebase.database().ref('locations').push(locationData)
        .then(() => {
            addMarkerToMap(locationData);
            alert('Location added successfully!');
        })
        .catch((error) => alert('Error adding location: ' + error.message));
}

function addMarkerToMap(location) {
    const marker = L.marker([location.lat, location.lng]).addTo(map);
    marker.bindPopup(createPopupContent(location));
}

function createPopupContent(location) {
    let content = `<h3>${location.name}</h3>`;
    if (location.imageUrl) {
        content += `<img src="${location.imageUrl}" alt="${location.name}" class="location-image">`;
    }
    content += `<p>${location.description}</p>`;
    if (location.story) {
        content += `<p><strong>Story:</strong> ${location.story}</p>`;
    }
    return content;
}

// Load existing locations
function loadLocations() {
    firebase.database().ref('locations').on('child_added', (snapshot) => {
        const location = snapshot.val();
        addMarkerToMap(location);
    });
}

// Initialize app
firebase.auth().onAuthStateChanged((user) => {
    updateUI(!!user);
    if (user) {
        loadLocations();
    }
});

</script>
</body>
</html>
