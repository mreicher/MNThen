<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then - Explore Minnesota's Rich History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .badge {
            font-size: 0.8em;
            padding: 0.3em 0.5em;
            margin-right: 0.5em;
        }
        .family-history-tag {
            background-color: #ffd700;
            color: #000;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .comment {
            border-left: 2px solid #007bff;
            padding-left: 10px;
            margin-bottom: 10px;
        }
        .nested-comments {
            margin-left: 20px;
        }
        .user-badge {
            display: inline-block;
            margin-right: 5px;
        }
        .bronze-badge { color: #cd7f32; }
        .silver-badge { color: #c0c0c0; }
        .gold-badge { color: #ffd700; }
        .platinum-badge { color: #e5e4e2; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Minnesota Then</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#addLocationModal">Add Location</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showMyLocations()">My Locations</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showLeaderboard()">Leaderboard</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <button class="btn btn-outline-light me-2" id="loginBtn" onclick="toggleAuth()">Login</button>
                    <button class="btn btn-outline-light" id="registerBtn" onclick="showRegisterModal()">Register</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div id="map"></div>
            </div>
            <div class="col-md-4">
                <div id="locationInfo" class="card d-none">
                    <div class="card-body">
                        <h5 class="card-title" id="locationTitle"></h5>
                        <p class="card-text" id="locationDescription"></p>
                        <p class="card-text"><small class="text-muted" id="locationYear"></small></p>
                        <div id="familyHistoryTag"></div>
                        <div id="locationImage" class="mt-3"></div>
                        <div id="commentsSection" class="mt-3">
                            <h6>Comments</h6>
                            <div id="commentsList"></div>
                            <form id="commentForm" class="mt-3">
                                <div class="mb-3">
                                    <textarea class="form-control" id="commentText" rows="3" placeholder="Add a comment..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Post Comment</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Location Modal -->
    <div class="modal fade" id="addLocationModal" tabindex="-1" aria-labelledby="addLocationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLocationModalLabel">Add New Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addLocationForm">
                        <div class="mb-3">
                            <label for="locationName" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="locationName" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationYear" class="form-label">Year</label>
                            <input type="number" class="form-control" id="locationYear" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="locationDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="locationLatitude" class="form-label">Latitude</label>
                            <input type="number" class="form-control" id="locationLatitude" step="any" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationLongitude" class="form-label">Longitude</label>
                            <input type="number" class="form-control" id="locationLongitude" step="any" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationImage" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="locationImage">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="familyHistoryCheck">
                            <label class="form-check-label" for="familyHistoryCheck">Family History</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addLocation()">Add Location</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="registerUsername" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="registerUser()">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Locations Modal -->
    <div class="modal fade" id="myLocationsModal" tabindex="-1" aria-labelledby="myLocationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myLocationsModalLabel">My Locations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="myLocationsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="leaderboardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="leaderboardModalLabel">Leaderboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="leaderboardList"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let map;
        let markers = [];
        let currentUser = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([46.7296, -94.6859], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            loadLocations();
        }

        // Load locations from Firestore
        function loadLocations() {
            db.collection("locations").get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const location = doc.data();
                    addMarkerToMap(doc.id, location);
                });
            });
        }

        // Add marker to map
        function addMarkerToMap(id, location) {
            const marker = L.marker([location.latitude, location.longitude]).addTo(map);
            marker.on('click', () => showLocationInfo(id, location));
            markers.push({ id, marker });
        }

        // Show location info
        function showLocationInfo(id, location) {
            document.getElementById('locationInfo').classList.remove('d-none');
            document.getElementById('locationTitle').textContent = location.name;
            document.getElementById('locationDescription').textContent = location.description;
            document.getElementById('locationYear').textContent = `Year: ${location.year}`;
            
            const familyHistoryTag = document.getElementById('familyHistoryTag');
            if (location.familyHistory) {
                familyHistoryTag.innerHTML = '<span class="family-history-tag">Family History</span>';
            } else {
                familyHistoryTag.innerHTML = '';
            }

            const locationImage = document.getElementById('locationImage');
            if (location.imageUrl) {
                locationImage.innerHTML = `<img src="${location.imageUrl}" class="img-fluid" alt="${location.name}">`;
            } else {
                locationImage.innerHTML = '';
            }

            loadComments(id);
        }

        // Load comments for a location
        function loadComments(locationId) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';

            db.collection("locations").doc(locationId).collection("comments")
                .orderBy("timestamp", "desc")
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const comment = doc.data();
                        const commentElement = createCommentElement(comment, doc.id, locationId);
                        commentsList.appendChild(commentElement);
                    });
                });
        }

        // Create comment element
        function createCommentElement(comment, commentId, locationId, isReply = false) {
            const commentDiv = document.createElement('div');
            commentDiv.className = isReply ? 'comment reply' : 'comment';
            commentDiv.innerHTML = `
                <p><strong>${comment.username}</strong> ${getUserBadgeHTML(comment.userBadge)} <small class="text-muted">${new Date(comment.timestamp.toDate()).toLocaleString()}</small></p>
                <p>${comment.text}</p>
                <button class="btn btn-sm btn-outline-primary reply-btn" onclick="showReplyForm('${locationId}', '${commentId}')">Reply</button>
                <div id="replyForm-${commentId}" style="display: none;">
                    <textarea class="form-control mt-2" id="replyText-${commentId}" rows="2" placeholder="Write a reply..."></textarea>
                    <button class="btn btn-sm btn-primary mt-2" onclick="submitReply('${locationId}', '${commentId}')">Submit Reply</button>
                </div>
                <div class="nested-comments" id="replies-${commentId}"></div>
            `;

            if (comment.replies) {
                const repliesContainer = commentDiv.querySelector(`#replies-${commentId}`);
                comment.replies.forEach(reply => {
                    const replyElement = createCommentElement(reply, reply.id, locationId, true);
                    repliesContainer.appendChild(replyElement);
                });
            }

            return commentDiv;
        }

        // Show reply form
        function showReplyForm(locationId, commentId) {
            const replyForm = document.getElementById(`replyForm-${commentId}`);
            replyForm.style.display = 'block';
        }

        // Submit reply
        function submitReply(locationId, commentId) {
            if (!currentUser) {
                alert('Please log in to reply to comments.');
                return;
            }

            const replyText = document.getElementById(`replyText-${commentId}`).value;
            if (replyText.trim() === '') return;

            const reply = {
                text: replyText,
                username: currentUser.displayName,
                userId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userBadge: currentUser.badge
            };

            db.collection("locations").doc(locationId)
                .collection("comments").doc(commentId)
                .collection("replies")
                .add(reply)
                .then(() => {
                    loadComments(locationId);
                })
                .catch((error) => {
                    console.error("Error adding reply: ", error);
                });
        }

        // Add new location
        function addLocation() {
            if (!currentUser) {
                alert('Please log in to add a location.');
                return;
            }

            const name = document.getElementById('locationName').value;
            const year = document.getElementById('locationYear').value;
            const description = document.getElementById('locationDescription').value;
            const latitude = parseFloat(document.getElementById('locationLatitude').value);
            const longitude = parseFloat(document.getElementById('locationLongitude').value);
            const imageUrl = document.getElementById('locationImage').value;
            const familyHistory = document.getElementById('familyHistoryCheck').checked;

            const newLocation = {
                name,
                year,
                description,
                latitude,
                longitude,
                imageUrl,
                familyHistory,
                userId: currentUser.uid,
                username: currentUser.displayName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("locations").add(newLocation)
                .then((docRef) => {
                    addMarkerToMap(docRef.id, newLocation);
                    updateUserBadge();
                    bootstrap.Modal.getInstance(document.getElementById('addLocationModal')).hide();
                })
                .catch((error) => {
                    console.error("Error adding location: ", error);
                });
        }

        // Update user badge
        function updateUserBadge() {
            if (!currentUser) return;

            db.collection("locations")
                .where("userId", "==", currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    const locationCount = querySnapshot.size;
                    let newBadge = 'bronze';

                    if (locationCount >= 50) newBadge = 'platinum';
                    else if (locationCount >= 25) newBadge = 'gold';
                    else if (locationCount >= 10) newBadge = 'silver';

                    db.collection("users").doc(currentUser.uid).update({
                        badge: newBadge
                    });

                    currentUser.badge = newBadge;
                });
        }

        // Get user badge HTML
        function getUserBadgeHTML(badge) {
            const badgeIcons = {
                bronze: 'ðŸ¥‰',
                silver: 'ðŸ¥ˆ',
                gold: 'ðŸ¥‡',
                platinum: 'ðŸ’Ž'
            };

            return `<span class="user-badge ${badge}-badge" title="${badge} contributor">${badgeIcons[badge]}</span>`;
        }

        // Toggle authentication state
        function toggleAuth() {
            if (currentUser) {
                auth.signOut().then(() => {
                    console.log('User signed out');
                    updateUIForLoggedOutUser();
                }).catch((error) => {
                    console.error('Sign out error', error);
                });
            } else {
                const email = prompt('Enter your email:');
                const password = prompt('Enter your password:');
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        console.log('User signed in');
                    })
                    .catch((error) => {
                        console.error('Sign in error', error);
                        alert('Login failed. Please check your credentials.');
                    });
            }
        }

        // Show register modal
        function showRegisterModal() {
            const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            registerModal.show();
        }

        // Register new user
        function registerUser() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const username = document.getElementById('registerUsername').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({
                        displayName: username
                    }).then(() => {
                        db.collection("users").doc(userCredential.user.uid).set({
                            username: username,
                            badge: 'bronze'
                        });
                        bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                    });
                })
                .catch((error) => {
                    console.error('Registration error', error);
                    alert('Registration failed. Please try again.');
                });
        }

        // Update UI for logged in user
        function updateUIForLoggedInUser(user) {
            document.getElementById('loginBtn').textContent = 'Logout';
            document.getElementById('registerBtn').style.display = 'none';
            currentUser = user;
        }

        // Update UI for logged out user
        function updateUIForLoggedOutUser() {
            document.getElementById('loginBtn').textContent = 'Login';
            document.getElementById('registerBtn').style.display = 'inline-block';
            currentUser = null;
        }

        // Show user's locations
        function showMyLocations() {
            if (!currentUser) {
                alert('Please log in to view your locations.');
                return;
            }

            const myLocationsList = document.getElementById('myLocationsList');
            myLocationsList.innerHTML = '';

            db.collection("locations")
                .where("userId", "==", currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const location = doc.data();
                        const locationElement = document.createElement('div');
                        locationElement.className = 'card mb-3';
                        locationElement.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">${location.name}</h5>
                                <p class="card-text">${location.description}</p>
                                <p class="card-text"><small class="text-muted">Year: ${location.year}</small></p>
                            </div>
                        `;
                        myLocationsList.appendChild(locationElement);
                    });

                    const myLocationsModal = new bootstrap.Modal(document.getElementById('myLocationsModal'));
                    myLocationsModal.show();
                });
        }

        // Show leaderboard
        function showLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';

            db.collection("users")
                .orderBy("badge", "desc")
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        const userElement = document.createElement('div');
                        userElement.className = 'mb-2';
                        userElement.innerHTML = `
                            <strong>${user.username}</strong> ${getUserBadgeHTML(user.badge)}
                        `;
                        leaderboardList.appendChild(userElement);
                    });

                    const leaderboardModal = new bootstrap.Modal(document.getElementById('leaderboardModal'));
                    leaderboardModal.show();
                });
        }

        // Event listeners
        document.getElementById('commentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentUser) {
                alert('Please log in to post a comment.');
                return;
            }

            const commentText = document.getElementById('commentText').value;
            if (commentText.trim() === '') return;

            const locationId = markers.find(marker => marker.marker.isPopupOpen()).id;

            const comment = {
                text: commentText,
                username: currentUser.displayName,
                userId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userBadge: currentUser.badge
            };

            db.collection("locations").doc(locationId)
                .collection("comments")
                .add(comment)
                .then(() => {
                    document.getElementById('commentText').value = '';
                    loadComments(locationId);
                })
                .catch((error) => {
                    console.error("Error adding comment: ", error);
                });
        });

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        user.badge = doc.data().badge;
                    }
                    updateUIForLoggedInUser(user);
                });
            } else {
                updateUIForLoggedOutUser();
            }
        });

        // Initialize map on page load
        window.onload = initMap;
    </script>
</body>
</html>
