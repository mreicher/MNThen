<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minnesota Then | Self-Guided Tours</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary-color: #005f9e;
            --secondary-color: #0077c2;
            --text-color: #333333;
            --background-color: #f8f9fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
            font-size: 16px;
            line-height: 1.5;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        #distanceBox {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 4px 10px var(--shadow-color);
            font-size: 1.5rem;
            font-weight: 500;
            z-index: 1000;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
        }

        .user-marker-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: red;
            border: 2px solid white;
            box-shadow: 0 0 5px var(--shadow-color);
        }

        .lochunt-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            padding: 0;
            overflow: hidden;
            border-radius: 10px;
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 250px !important;
        }

        .popup-content {
            text-align: center;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
        }
        
        .location-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .location-name {
            margin: 15px 0;
            font-size: 1.2rem;
            color: var(--text-color);
            padding: 0 15px;
        }

        .popup-buttons {
            display: flex;
            margin-top: 10px;
        }

        .button {
            flex: 1;
            padding: 12px 0;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .route-button {
            background-color: #006400;
            width: 100%;
        }

        .pin-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) rotate(-45deg);
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            border: 3px solid white;
            box-shadow: 0 0 5px var(--shadow-color);
            background-color: #191970;
            transition: all 0.3s ease;
        }

        .pin-head:hover {
            transform: translateX(-50%) rotate(-45deg) scale(1.1);
            box-shadow: 0 0 15px var(--shadow-color);
        }

        .directions-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #006400;
            color: white;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .directions-link:hover {
            background-color: #037f51;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px var(--shadow-color);
        }

        .lochunt-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .audio-player {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }

        .audio-progress {
            width: 100%;
            margin-bottom: 10px;
        }

        .progress {
            height: 8px;
            background-color: #d1d1d1;
            cursor: pointer;
            border-radius: 4px;
        }

        .progress-bar {
            background-color: var(--primary-color);
            border-radius: 4px;
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .audio-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5rem;
        }

        .audio-button {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1111;
        }

        .audio-button:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .additional-info-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 2px solid var(--primary-color);
            width: 90%;
            max-width: 600px;
            z-index: 2001;
            display: none;
            font-size: 18px;
        }

        .map-buttons {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 1000;
        }

        .map-button {
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            border: 1px solid var(--primary-color);
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px var(--shadow-color);
            font-size: 2rem;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .map-button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .navigation-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 2001;
            display: none;
            max-width: 90%;
            width: 400px;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary-color);
            transition: color 0.3s ease;
        }

        #congratulations {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 3000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }

        #congratulations h2 {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #congratulations button {
            padding: 12px 24px;
            font-size: 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #congratulations button:hover {
            background-color: var(--hover-color);
        }

        @media (max-width: 768px) {
            body, html {
                font-size: 18px;
            }

            #distanceBox {
                font-size: 1.3rem;
                padding: 6px 10px;
                top: 10px;
                right: 10px;
            }

            .map-buttons {
                bottom: 20px;
            }

            .map-button {
                width: 50px;
                height: 50px;
                font-size: 1.7rem;
            }

            .navigation-tips {
                max-width: 95%;
                padding: 20px;
            }

            #congratulations h2 {
                font-size: 24px;
            }

            #congratulations button {
                font-size: 16px;
                padding: 10px 20px;
            }

            .audio-player {
                max-width: 100%;
            }

            .lochunt-container img {
                height: 30vh;
            }

            .additional-info-container {
                width: 95%;
                padding: 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="distanceBox">Initializing...</div>

    <div class="lochunt-container">
        <img id="locationImage" src="" alt="Location Image">
        <div class="lochunt-content">
            <div class="lochunt-info">
                <h2 id="locationTitle" class="mb-2 text-primary"></h2>
                <p id="locationCity" class="text-muted mb-1"></p>
                <p id="locationCreator" class="text-muted mb-3"></p>
            </div>
            <div class="audio-player">
                <div class="audio-progress">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="audio-time">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="audio-controls">
                    <button id="rewindBtn" class="audio-button"><i class="fas fa-backward"></i></button>
                    <button id="playPauseBtn" class="audio-button"><i class="fas fa-play"></i></button>
                    <button id="forwardBtn" class="audio-button"><i class="fas fa-forward"></i></button>
                </div>
                <audio id="locationAudio" src=""></audio>
            </div>
        </div>
    </div>
    <div class="additional-info-container">
        <h3 class="mb-3 text-primary">Additional Information</h3>
        <p id="additionalInfo" class="mb-3"></p>
        <button id="continueButton" class="btn btn-primary">Continue</button>
    </div>
    <div class="map-buttons">
        <button id="recenterButton" class="map-button"><i class="fas fa-crosshairs"></i></button>
        <button id="returnButton" class="map-button"><i class="fas fa-sign-out-alt"></i></button>
        <button id="tipsButton" class="map-button"><i class="fas fa-question-circle"></i></button>
    </div>
    <div class="navigation-tips">
        <button class="close-button">&times;</button>
        <h3>Navigation Tips</h3>
        <ul>
            <li>Use the map to navigate to the marked locations.</li>
            <li>The distance box shows how far you are from the current location.</li>
            <li>Tap the recenter button to focus on your current position.</li>
            <li>When you're within 20  feet of a location, you'll be able to interact with it.</li>
            <li>Listen to the audio information for each location.</li>
            <li>After the audio, you'll see additional information about the location.</li>
        </ul>
    </div>
    <div id="congratulations">
        <h2>Congratulations!</h2>
        <p>You have successfully completed the Minnesota Then Tour!</p>
        <button onclick="endTour()">Return to the Home Page</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="/locations_test.js?v=1.0.2"></script>

<script>
// Initialize variables
let closestDistance = Infinity;
let newMarkers = {};
const alpha = 0.1;
const beta = 0.005;
let lastEstimatedPos = null;
let lastEstimatedVel = { lat: 0, lng: 0 };
let lastKnownLatLng = null;
let currentLatLng = null;
let closestLocation = null;
let useHighAccuracy = false;
let isStationary = true;
let lastAppliedLatLng = null;
let lastUpdateTime = null;
const SMOOTHING_FACTOR = 0.5;
const PREDICTION_TIME = 0.5;
const UPDATE_INTERVAL = 250;
const ANIMATION_DURATION = 300;
const STATIONARY_THRESHOLD = 0.5;
const HIGH_ACCURACY_THRESHOLD = 500;
const AUTO_CENTER_THRESHOLD = 15000;
const thresholdFeet = 15;
const INITIAL_DELAY = 1500;
const COOLDOWN = 60000;
const CENTER_THRESHOLD = 0.00005;
const PADDING_PERCENTAGE = 0.05;
const CENTER_COOLDOWN = 500;

document.addEventListener("DOMContentLoaded", function () {
    const distanceBox = document.getElementById("distanceBox");
    const locationPopup = document.createElement("div");
    locationPopup.id = "location-popup";
    locationPopup.innerHTML = "Locating user...";
    document.body.appendChild(locationPopup);

    const locationTimeout = setTimeout(() => {
        locationPopup.innerHTML = `<div><p>Still searching ...</p></div>`;
        setTimeout(() => {
            locationPopup.innerHTML = `<div><p>Unable to find your location. Please check your settings or try again.</p></div>`;
        }, 5000);
    }, 15000);

    const lastTransitionTime = sessionStorage.getItem('lastTransitionTime');
    const lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');

    const map = L.map("map", {
        attributionControl: false,
        zoomControl: true,
        inertia: true,
        inertiaDeceleration: 3000,
        inertiaMaxSpeed: 3000,
        zoomAnimationThreshold: 4,
        fadeAnimation: true,
        markerZoomAnimation: true,
        zoomAnimation: true
    }).setView([45.09396938812941, -92.99743282865592], 19);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
        crossOrigin: true,
        useCache: true,
        maxRequests: 8
    }).addTo(map);

    L.control.attribution({ prefix: false }).addTo(map);

    const userLocationMarker = L.circleMarker([0, 0], {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0.5,
        radius: 6,
        weight: 2
    }).addTo(map);

    let userInteracted = false;
    
    map.on("dragstart zoomstart", () => {
        userInteracted = true;
    });

    document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
            userInteracted = false;
        }
    });

    const markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: false,
        disableClusteringAtZoom: 18,
        chunkedLoading: true,
        chunkInterval: 100,
        chunkDelay: 25,
        maxClusterRadius: (zoom) => (zoom <= 15) ? 80 : 40,
        iconCreateFunction: (cluster) => {
            return L.divIcon({
                html: `<div style="
                    background-color: #006400; 
                    color: white;
                    border-radius: 50%;
                    width: 35px;
                    height: 35px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 16px;
                    font-weight: bold;
                ">${cluster.getChildCount()}</div>`,
                className: 'custom-cluster-icon',
                iconSize: L.point(35, 35)
            });
        }
    });
    
    map.addLayer(markers);

    markers.on("clusterclick", (e) => {
        const childMarkers = e.layer.getAllChildMarkers();
        if (childMarkers.length > 0) {
            childMarkers[0].openPopup();
        }
    });

    function loadScriptWithCacheBust() {
        const cacheBust = Date.now();
        const script = document.createElement("script");

        if (!document.querySelector('[src^="/locations_test.js"]')) {
            script.src = `/locations_test.js?v=${cacheBust}`;
        }

        let scriptLoadTimeout;

        script.onload = () => {
            if (Array.isArray(locations) && locations.length) {
                console.log("Location data loaded successfully:", locations);
                map.locate({ setView: false, maxZoom: 19 });
            } else {
                console.error("Location data is missing or empty:", locations);
                alert("Location data could not be loaded. Please refresh the page and try again.");
            }
            clearTimeout(scriptLoadTimeout);
        };

        script.onerror = () => {
            if (!scriptLoadTimeout) {
                scriptLoadTimeout = setTimeout(() => {
                    console.error("Failed to load the script:", script.src);
                    alert("Failed to load location data. Please check your internet connection and try again.");
                }, 10000);
            }
        };

        document.body.appendChild(script);
    }

    loadScriptWithCacheBust();

    let initialLocationSet = false;
    let lastUserInteractionTime = 0;

    map.on("dragstart zoomstart", () => {
        lastUserInteractionTime = Date.now();
    });
  
    map.on("locationfound", (e) => {
        console.log("Location found:", e);
        clearTimeout(locationTimeout);
        locationPopup.innerHTML = "User found.";
        setTimeout(() => {
            locationPopup.style.display = "none";
        }, 1500);

        if (!initialLocationSet) {
            map.setView(e.latlng, 19);
            initialLocationSet = true;
        } else {
            const timeSinceLastInteraction = Date.now() - lastUserInteractionTime;
            if (timeSinceLastInteraction > AUTO_CENTER_THRESHOLD) {
                map.setView(e.latlng, 19);
            }
        }
    });

    const currentMarkers = {};

    class KalmanFilter {
        constructor(R, Q) {
            this.R = R;
            this.Q = Q;
            this.P = 1;
            this.X = null;
            this.K = 0;
        }

        filter(measurement) {
            if (this.X === null) {
                this.X = measurement;
                return this.X;
            }

            this.P = this.P + this.Q;
            this.K = this.P / (this.P + this.R);
            this.X = this.X + this.K * (measurement - this.X);
            this.P = (1 - this.K) * this.P;

            return this.X;
        }
    }

    const latFilter = new KalmanFilter(0.01, 0.1);
    const lngFilter = new KalmanFilter(0.01, 0.1);

    function kalmanFilterPosition(position) {
        return {
            lat: latFilter.filter(position.lat),
            lng: lngFilter.filter(position.lng)
        };
    }

    let lastExpSmoothedValue = null;
    const expSmoothingFactor = 0.2;

    function newExponentialSmoothing(newMeasurement) {
        if (!lastExpSmoothedValue) {
            lastExpSmoothedValue = { ...newMeasurement };
            return lastExpSmoothedValue;
        }
        lastExpSmoothedValue.lat = lastExpSmoothedValue.lat + expSmoothingFactor * (newMeasurement.lat - lastExpSmoothedValue.lat);
        lastExpSmoothedValue.lng = lastExpSmoothedValue.lng + expSmoothingFactor * (newMeasurement.lng - lastExpSmoothedValue.lng);
        return lastExpSmoothedValue;
    }

    const movingAverageWindow = 5;
    const positionBuffer = [];

    function movingAverageFilter(newMeasurement) {
        positionBuffer.push(newMeasurement);
        if (positionBuffer.length > movingAverageWindow) {
            positionBuffer.shift();
        }

        const avgLat = positionBuffer.reduce((sum, pos) => sum + pos.lat, 0) / positionBuffer.length;
        const avgLng = positionBuffer.reduce((sum, pos) => sum + pos.lng, 0) / positionBuffer.length;

        return L.latLng(avgLat, avgLng);
    }

    function fastDistanceApprox(latlng1, latlng2) {
        const { lat: lat1, lng: lng1 } = latlng1;
        const { lat: lat2, lng: lng2 } = latlng2;

        const dx = (lng2 - lng1) * Math.cos((lat1 + lat2) * Math.PI / 180 / 2);
        const dy = lat2 - lat1;

        return 111319.9 * Math.sqrt(dx * dx + dy * dy);
    }

    function applyDynamicDeadband(latLng, lastLatLng, isStationary) {
        if (!latLng || !lastLatLng || typeof latLng.lat !== 'number' || typeof latLng.lng !== 'number' ||
            typeof lastLatLng.lat !== 'number' || typeof lastLatLng.lng !== 'number') {
            throw new Error('Invalid latLng or lastLatLng: Must have numeric lat and lng properties');
        }

        if (typeof isStationary !== 'boolean') {
            throw new Error('isStationary must be a boolean');
        }

        const deadbandThresholdFeet = isStationary ? 3 : 1;
        const distanceFeet = fastDistanceApprox(latLng, lastLatLng) * 3.28084;

        return distanceFeet < deadbandThresholdFeet ? lastLatLng : latLng;
    }

    function lowPassFilter(newMeasurement) {
        if (!lastAppliedLatLng) return newMeasurement;
        return {
            lat: lastAppliedLatLng.lat + SMOOTHING_FACTOR * (newMeasurement.lat - lastAppliedLatLng.lat),
            lng: lastAppliedLatLng.lng + SMOOTHING_FACTOR * (newMeasurement.lng - lastAppliedLatLng.lng)
        };
    }

    let resetInteractionTimeout;

    function updateUserLocation(e = null) {
        const now = Date.now();
        currentLatLng = e ? e.latlng : lastKnownLatLng;
        
        if (!currentLatLng) {
            console.warn('No current location available');
            return null;
        }
        
        if (lastUpdateTime && lastAppliedLatLng) {
            const timeDiff = (now - lastUpdateTime) / 1000;
            const distanceFeet = fastDistanceApprox(currentLatLng, lastAppliedLatLng) * 3.28084;
            const speed = distanceFeet / timeDiff;
            isStationary = speed < STATIONARY_THRESHOLD;
        }
        
        const deadbandFilteredLatLng = applyDynamicDeadband(currentLatLng, lastAppliedLatLng || currentLatLng, isStationary);
        const smoothedLatLng = combinedFilter(deadbandFilteredLatLng);
        
        lastAppliedLatLng = smoothedLatLng;
        lastUpdateTime = now;
        lastKnownLatLng = smoothedLatLng;
        
        userLocationMarker.setLatLng(smoothedLatLng);
        
        const { closestLocation, closestDistance } = findClosestLocation(smoothedLatLng);
        
        updateDistanceBox(closestDistance);
        checkLocationTransition(closestLocation, closestDistance);
        updateAccuracyMode(closestDistance);
        
        return smoothedLatLng;
    }

    let consolidatedInterval;

    function startConsolidatedInterval() {
        consolidatedInterval = setInterval(() => {
            const updatedLocation = updateUserLocation();
            
            if (updatedLocation && !userInteracted) {
                const predictedLatLng = predictFuturePosition(updatedLocation);
                smoothPanMap(predictedLatLng);
            }
            
            centerMapOnUser();
        }, UPDATE_INTERVAL);
    }

    function predictFuturePosition(currentLatLng) {
        if (!currentLatLng || !lastEstimatedVel) {
            return currentLatLng;
        }

        const predictedLat = currentLatLng.lat + (lastEstimatedVel?.lat ?? 0) * PREDICTION_TIME;
        const predictedLng = currentLatLng.lng + (lastEstimatedVel?.lng ?? 0) * PREDICTION_TIME;

        return L.latLng(predictedLat, predictedLng);
    }

    function smoothPanMap(targetLatLng) {
        map.panTo(targetLatLng, {
            animate: true,
            duration: ANIMATION_DURATION,
            easeLinearity: 0.5
        });
    }

    startConsolidatedInterval();

    function stopConsolidatedInterval() {
        clearInterval(consolidatedInterval);
    }

    function findClosestLocation(currentLatLng) {
        let closestLocation = null;
        let closestDistance = Infinity;
        
        for (const location of locations) {
            const locationLatLng = L.latLng(location.lat, location.lng);
            const distance = fastDistanceApprox(currentLatLng, locationLatLng);
            const distanceFeet = Math.round(distance * 3.28084);
            
            if (distanceFeet < closestDistance) {
                closestDistance = distanceFeet;
                closestLocation = location;
            }
        }
        
        return { closestLocation, closestDistance };
    }

    function updateDistanceBox(distanceFeet) {
        if (distanceFeet < 5280) {
            distanceBox.innerHTML = `Closest Marker: ${distanceFeet} feet`;
        } else {
            const distanceMiles = (distanceFeet / 5280).toFixed(2);
            distanceBox.innerHTML = `Closest Marker: ${distanceMiles} miles`;
        }
    }

    function checkLocationTransition(closestLocation, distanceFeet) {
        if (!distanceBox) {
            console.error("distanceBox element not found!");
            return;
        }

        const latLngId = `${closestLocation.lat},${closestLocation.lng}`;
        const lastTransitionTime = parseInt(sessionStorage.getItem('lastTransitionTime') || '0');
        const lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');
        const timeSinceLastTransition = Date.now() - lastTransitionTime;
        const cooldownActiveForLastLocation = lastVisitedLocation === latLngId && timeSinceLastTransition < COOLDOWN;

        if (distanceFeet <= thresholdFeet) {
            if (cooldownActiveForLastLocation) {
                distanceBox.classList.add("within-cooldown");
                distanceBox.classList.remove("within-threshold");
                distanceBox.style.borderColor = 'orange';
                
                const remainingCooldown = COOLDOWN - timeSinceLastTransition;
                setTimeout(() => {
                    checkLocationTransition(closestLocation, distanceFeet);
                }, remainingCooldown);
            } else {
                distanceBox.classList.add("within-threshold");
                distanceBox.classList.remove("within-cooldown");
                distanceBox.style.borderColor = 'green';
                
                setTimeout(() => {
                    sessionStorage.setItem("lastTransitionTime", Date.now().toString());
                    sessionStorage.setItem("lastVisitedLocation", latLngId);
                    window.location.href = `/location.html?id=${closestLocation.id}`;
                }, INITIAL_DELAY);
            }
        } else {
            distanceBox.classList.remove("within-threshold", "within-cooldown");
            distanceBox.style.borderColor = 'red';
        }
    }

    function updateAccuracyMode(distanceFeet) {
        if (distanceFeet <= HIGH_ACCURACY_THRESHOLD && !useHighAccuracy) {
            useHighAccuracy = true;
            restartLocationTracking();
        } else if (distanceFeet > HIGH_ACCURACY_THRESHOLD && useHighAccuracy) {
            useHighAccuracy = false;
            restartLocationTracking();
        }
    }

    function restartLocationTracking() {
        map.stopLocate();
        map.locate({
            watch: true,
            enableHighAccuracy: useHighAccuracy,
            maximumAge: 15000,
        });
    }

    map.on('drag', () => {
        userInteracted = true;
        resetUserInteraction();
    });

    map.on('zoomstart', () => {
        userInteracted = true;
        resetUserInteraction();
    });

    let lastRecenterTime = 0;
    const RECENTER_COOLDOWN = 500;
    const SIGNIFICANT_MOVE_THRESHOLD = 0.00005;
    
    function resetUserInteraction() {
        clearTimeout(resetInteractionTimeout);
        resetInteractionTimeout = setTimeout(() => {
            userInteracted = false;
            const now = Date.now();
            
            if (currentLatLng && (now - lastRecenterTime > RECENTER_COOLDOWN)) {
                const current = map.getCenter();
                const distanceMoved = current.distanceTo(currentLatLng);
                
                if (distanceMoved > SIGNIFICANT_MOVE_THRESHOLD) {
                    const openPopup = document.querySelector('.leaflet-popup');
                    if (openPopup) {
                        openPopup.style.transition = 'opacity 0.3s';
                        openPopup.style.opacity = '0';
                        setTimeout(() => {
                            map.closePopup();
                        }, 300);
                    }
                    
                    map.panTo(currentLatLng, { animate: true, duration: 0.75 });
                    lastRecenterTime = now;
                }
                
                userLocationMarker.getElement().classList.add('centered-icon');
            }
            
            ensureUserIconOnScreen();
        }, 15000);
    }
    
    let lastCenterTime = 0;
    
    function centerMapOnUser() {
        if (map && userLocationMarker && !userInteracted) {
            const userPosition = userLocationMarker.getLatLng();
            const mapCenter = map.getCenter();
            const zoom = map.getZoom();
            
            const zoomFactor = Math.pow(2, 19 - zoom);
            const dynamicThreshold = CENTER_THRESHOLD * zoomFactor;
            
            if (Math.abs(userPosition.lat - mapCenter.lat) > dynamicThreshold || 
                Math.abs(userPosition.lng - mapCenter.lng) > dynamicThreshold) {
                map.panTo(userPosition, { animate: true, duration: 0.3 });
            }
            
            userLocationMarker.getElement().classList.add('centered-icon');
        }
    }

    function ensureUserIconOnScreen() {
        if (!map || !userLocationMarker) return;

        const now = Date.now();
        if (now - lastCenterTime < CENTER_COOLDOWN) return;

        const userPosition = userLocationMarker.getLatLng();
        const bounds = map.getBounds();
        const visibleBounds = bounds.pad(-PADDING_PERCENTAGE);

        if (!visibleBounds.contains(userPosition)) {
            const currentZoom = map.getZoom();
            const newCenter = calculateNewCenter(userPosition, bounds);
            map.flyTo(newCenter, currentZoom, {
                animate: true,
                duration: 0.5,
                easeLinearity: 0.5
            });

            lastCenterTime = now;
        }
    }

    map.on('drag zoomstart touchstart', resetUserInteraction);

    map.on('locationfound', (e) => {
        updateUserLocation(e);
    });

    distanceBox.innerHTML = "Initializing ...";

    map.on("locationfound", updateUserLocation);

    const markerIconClasses = {
        "history": "blue-marker",
        "hamm": "orange-marker",
        "gangster": "green-marker",
        "split": "split-marker",
        "wbl_split": "wbl_split-marker",
        "lake": "lake-marker",
        "capitol": "capitol-marker",
        "summit": "summit-marker",
        "northeast": "northeast-marker",
        "default": "blue-marker"
    };

    markers.clearLayers();

    for (let i = 0; i < locations.length; i++) {
        const location = locations[i];
        const locationLatLng = L.latLng(location.lat, location.lng);
        const markerId = location.lat + ',' + location.lng;
    
        const popupContent = `
          <div class="popup-content">
            <img src="${location.image}" alt="${location.name}">
            <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>
            <a href="#" class="directions-link" data-lat="${location.lat}" data-lng="${location.lng}">
              <img src="/images/route_icon.png" alt="Google Maps" style="width: 40px; height: 40px; margin-bottom: -10px;">
              <div style="margin-top: -10px; margin-bottom: -10px; color: black; font-size: 16px"><p class="dir">Directions</p></div>
            </a>
          </div>
        `;

        function showModal(lat, lng) {
            const modal = document.getElementById("forwardingModal");
            const span = modal.querySelector(".close");
            const continueButton = document.getElementById("continueButton");
            const cancelButton = document.getElementById("cancelButton");

            modal.style.display = "block";

            span.onclick = () => {
                modal.style.display = "none";
                recenterAndClosePopup();
            }

            cancelButton.onclick = () => {
                modal.style.display = "none";
                recenterAndClosePopup();
            }

            continueButton.onclick = () => {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
                modal.style.display = 'none';
                recenterAndClosePopup();
            }

            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = "none";
                    recenterAndClosePopup();
                }
            }
        }

        function showDirectionsPopup(lat, lng) {
          showModal(lat, lng);
        }

        function addPopupEventListeners(popup) {
          popup.querySelectorAll('.directions-link').forEach((link) => {
            link.addEventListener('click', (event) => {
              event.preventDefault();
              const lat = link.getAttribute('data-lat');
              const lng = link.getAttribute('data-lng');
              showDirectionsPopup(lat, lng);
            });
          });
        }

        function bindPopupToExistingMarker(marker, popupContent) {
          marker.bindPopup(popupContent).on('popupopen', (e) => {
            const popup = e.popup._contentNode;
            addPopupEventListeners(popup);
          });
        }

        const iconClass = markerIconClasses[location.tours] || markerIconClasses["default"];

        const newMarkerIcon = L.divIcon({
            className: `custom-marker-icon ${iconClass}`, 
            iconSize: [17, 17],
            iconAnchor: [8, 8],
            popupAnchor: [0, -20],
            html: `<span class="marker-inner"></span>`
        });

        const marker = L.marker(locationLatLng, { icon: newMarkerIcon });
        bindPopupToExistingMarker(marker, popupContent);

        if (!currentMarkers[markerId]) {
            newMarkers[markerId] = marker;
            markers.addLayer(marker);
        } else {
            newMarkers[markerId] = currentMarkers[markerId];
        }
    }

    map.addLayer(markers);

    function recenterAndClosePopup() {
        if (userLocationMarker.getLatLng()) {
            map.setView(userLocationMarker.getLatLng(), 19);
            map.closePopup();
            userInteracted = false;
        }
    }

    function setExitCooldown() {
        const currentTime = Date.now();
        sessionStorage.setItem('lastTransitionTime', currentTime.toString());
        const locationId = getUrlParameter('id');
        if (locationId) {
            const location = locations.find(loc => loc.id === locationId);
            if (location) {
                const latLngId = `${location.lat},${location.lng}`;
                sessionStorage.setItem('lastVisitedLocation', latLngId);
            }
        }
    }
    
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function onLocationError(e) {
        clearTimeout(locationTimeout);
        locationPopup.innerHTML = "Failed to access your location. Please make sure location services are enabled and try again.";
    }

    map.on("locationerror", onLocationError);

    let recenterTimeout;

    function recenterMap() {
        if (!userInteracted && userLocationMarker.getLatLng()) {
            map.setView(userLocationMarker.getLatLng(), 19);
        }
    }

    map.on("popupclose", () => {
        clearTimeout(recenterTimeout);
        recenterTimeout = setTimeout(() => {
            userInteracted = false;
            map.closePopup();
            recenterMap();
        }, 15000);
    });

    map.on("popupopen", () => {
        clearTimeout(recenterTimeout);
    });

    map.locate({
        watch: true,
        enableHighAccuracy: true,
        maximumAge: 15000,
    });

    const questionBtn = document.getElementById('help-button');
    const popup = document.getElementById('explanation-popup');

    questionBtn.addEventListener('click', () => {
        popup.classList.toggle('hidden');
    });

    const closeBtn = document.getElementById('close-popup');

    closeBtn.addEventListener('touchstart', closePopup);
    closeBtn.addEventListener('click', closePopup);

    function closePopup(event) {
        event.stopPropagation();
        popup.classList.add('hidden');
    }

    const recenterButton = document.getElementById("recenter-button");

    recenterButton.addEventListener("click", () => {
        if (userLocationMarker.getLatLng()) {
            const userLatLng = userLocationMarker.getLatLng();
            map.setView(userLatLng, 19);
            userInteracted = false;
            clearTimeout(recenterTimeout);
        } else {
            alert("User location not available. Please enable location services.");
        }
    });

    const exitButton = document.querySelector(".exit-button");

    exitButton.addEventListener("click", () => {
        sessionStorage.removeItem('lastTransitionTime');
        window.location.href = "/index.html";
    });
});

// Add the modal HTML to your document's body
document.body.insertAdjacentHTML('beforeend', `
    <div id="forwardingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p style="font-size: 20px">You will be redirected to Google Maps in a new window for directions. Do you want to continue?</p>
            <div class="button-container">
                <button id="continueButton">Continue</button>
                <button id="cancelButton">Cancel</button>
            </div>
        </div>
    </div>
`);
</script>
   </body>
</html>
