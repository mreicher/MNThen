<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minnesota Then Scavenger Hunt</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #005f9e;
            --text-color: #333333;
            --background-color: #f8f9fa;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --hover-color: #0077c2;
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        #distanceBox {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 30px;
            box-shadow: 0 4px 10px var(--shadow-color);
            font-size: 22px;
            font-weight: 500;
            z-index: 1000;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            transition: all 0.3s ease;
            min-width: 250px;
            text-align: center;
        }

//

.custom-popup .leaflet-popup-content-wrapper {
    padding: 0;
    overflow: hidden;
}

.custom-popup .leaflet-popup-content {
    margin: 0;
    width: 250px !important;
}

.popup-content {
    text-align: center;
    background-color: white;
    border-radius: 10px;
    overflow: hidden;
}

.location-image {
    width: 100%;
    height: auto;
    display: block;
}

.location-name {
    margin: 10px 0;
    font-size: 1.2em;
    color: #333;
    padding: 0 10px;
}

.popup-buttons {
    display: flex;
    margin-top: 10px;
}

.button {
    flex: 1;
    padding: 10px 0;
    font-size: 1em;
    font-weight: bold;
    color: white;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
}

.route-button {
    background-color: #006400;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
}

.bypass-button {
    background-color: #dc3545;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
}

.pin-head {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%) rotate(-45deg);
    width: 30px;
    height: 30px;
    border-radius: 50% 50% 50% 0;
    border: 3px solid white;
    box-shadow: 0 0 5px var(--shadow-color);
    background-color: #31bd24;
    transition: all 0.3s ease;
}

.pin-head:hover {
    transform: translateX(-50%) rotate(-45deg) scale(1.1);
    box-shadow: 0 0 15px var(--shadow-color);
}
//

.pin-head {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%) rotate(-45deg);
    width: 30px;
    height: 30px;
    border-radius: 50% 50% 50% 0;
    border: 3px solid white;
    box-shadow: 0 0 5px var(--shadow-color);
    background-color: #31bd24;
    transition: all 0.3s ease;
}

.pin-head:hover {
  transform: translateX(-50%) rotate(-45deg) scale(1.1);
  box-shadow: 0 0 15px var(--shadow-color);
}

        .popup-content {
            text-align: center;
            padding: 0 5px; 
            border-radius: 12px;
        }

        .popup-content img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .popup-content h4 {
            margin: 10px 0px; 
            color: var(--primary-color);
            font-size: 1.5em;
        }

        .directions-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.5em;
        }

        .directions-link:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px var(--shadow-color);
        }

        .custom-popup .leaflet-popup-content-wrapper {
    padding: 5px;
}

.custom-popup .leaflet-popup-content {
    margin: 5px;
    width: 185px;
}

.popup-content .directions-link {
    display: block;
    padding: 10px 5px;
    background-color: var(--primary-color);
    color: white;
    text-decoration: none;
}

        #startHunt {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #startHunt:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-color);
        }

        .lochunt-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .lochunt-container img {
            width: 100%;
            height: 40vh;
            object-fit: cover;
            object-position: center;
        }

        .lochunt-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lochunt-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .audio-player {
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
        }

        .audio-progress {
            width: 100%;
            margin-bottom: 10px;
        }

        .progress {
            height: 6px;
            background-color: #d1d1d1;
            cursor: pointer;
        }

        .progress-bar {
            background-color: var(--primary-color);
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .audio-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
        }

        .audio-button {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-button:hover {
            background-color: var(--hover-color);
        }

        .trivia-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 2px solid var(--primary-color);
            width: 90%;
            max-width: 600px;
            z-index: 2001;
            display: none;
            font-size: 22px;
        }

        .map-buttons {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 1000;
        }

        .map-button {
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            border: 1px solid var(--primary-color);
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px var(--shadow-color);
            font-size: 30px;
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .map-button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .navigation-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 2001;
            display: none;
            max-width: 90%;
            width: 400px;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
            transition: color 0.3s ease;
        }

        #congratulations {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 3000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }

        #congratulations h2 {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #congratulations button {
            padding: 12px 24px;
            font-size: 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #congratulations button:hover {
            background-color: var(--hover-color);
        }

        @media (max-width: 768px) {
            #distanceBox {
                font-size: 22px;
                padding: 8px 16px;
                top: 10px;
                right: 10px;
                min-width: 200px;
            }

            .map-buttons {
                bottom: 20px;
            }

            .map-button {
                width: 55px;
                height: 55px;
                font-size: 30px;
            }

            .navigation-tips {
                max-width: 95%;
                padding: 20px;
            }

            #congratulations h2 {
                font-size: 24px;
            }

            #congratulations button {
                font-size: 16px;
                padding: 10px 20px;
            }

            .audio-player {
                max-width: 100%;
            }

            .lochunt-container img {
                height: 30vh;
            }

            .trivia-container {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="distanceBox">Initializing...</div>

    <div class="lochunt-container">
        <img id="locationImage" src="" alt="Location Image">
        <div class="lochunt-content">
            <div class="lochunt-info">
                <h2 id="locationTitle" class="mb-2 text-primary"></h2>
                <p id="locationCity" class="text-muted mb-1"></p>
                <p id="locationCreator" class="text-muted mb-3"></p>
            </div>
            <div class="audio-player">
                <div class="audio-progress">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="audio-time">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="audio-controls">
                    <button id="rewindBtn" class="audio-button"><i class="fas fa-backward"></i></button>
                    <button id="playPauseBtn" class="audio-button"><i class="fas fa-play"></i></button>
                    <button id="forwardBtn" class="audio-button"><i class="fas fa-forward"></i></button>
                </div>
                <audio id="locationAudio" src=""></audio>
            </div>
        </div>
    </div>
    <div class="trivia-container">
        <h3 class="mb-3 text-primary">Trivia Question</h3>
        <p id="triviaQuestion" class="mb-3 fw-bold" style="font-size: 24px;"></p>
        <div id="triviaOptions" class="d-grid gap-2" style="font-size: 22px;"></div>
    </div>
    <div class="map-buttons">
        <button id="recenterButton" class="map-button"><i class="fas fa-crosshairs"></i></button>
        <button id="returnButton" class="map-button"><i class="fas fa-sign-out-alt"></i></button>
        <button id="tipsButton" class="map-button"><i class="fas fa-question-circle"></i></button>
    </div>
    <div class="navigation-tips">
        <button class="close-button">&times;</button>
        <h3>Navigation Tips</h3>
        <ul>
            <li>Use the map to navigate to the marked locations.</li>
            <li>The distance box shows how far you are from the current location.</li>
            <li>Tap the recenter button to focus on your current position.</li>
            <li>When you're within 20 feet of a location, you'll be able to interact with it.</li>
            <li>Complete the trivia question to move to the next location.</li>
        </ul>
    </div>
    <div id="congratulations">
        <h2>Congratulations!</h2>
        <p>You have successfully completed the Minnesota Then Scavenger Hunt!</p>
        <button onclick="restartHunt()">Start a New Hunt</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script src="locations_h.js?v=1.0.2"></script>

<script>
    let map, userMarker, locationMarker;
let currentLocationIndex = 0;
let visitedLocations = [];
let gameLocations = [];
let inactivityTimer;
let isLocationHuntVisible = false;
let lastPosition = null;
let positionBuffer = [];
const bufferSize = 10;
const smoothingFactor = 0.1;
let filteredPosition = null;
const DISTANCE_THRESHOLD = 20; // feet
let lastUpdateTime = 0;
let velocity = { lat: 0, lng: 0 };
let isMapInteracting = false;

function initMap() {
    map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const userIcon = L.divIcon({
        className: 'user-marker',
        html: '<div class="user-marker-icon" style="background-color: #FF0000; border: 2px solid #ffffff; border-radius: 50%; width: 16px; height: 16px;"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });

    userMarker = L.marker([0, 0], { icon: userIcon }).addTo(map);

    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(initializeUserLocation, handleLocationError, {
            enableHighAccuracy: true,
            timeout: 30000,
            maximumAge: 0
        });
    } else {
        alert("Geolocation is not supported by your browser");
        map.setView([44.9778, -93.2650], 19); // Default view if geolocation is not available
    }

    map.on('touchstart mousedown', () => {
        isMapInteracting = true;
    });

    map.on('touchend mouseup', () => {
        isMapInteracting = false;
    });
}

function initializeUserLocation(position) {
    const userLat = position.coords.latitude;
    const userLng = position.coords.longitude;
    
    // Set the user marker position
    userMarker.setLatLng([userLat, userLng]);
    
    // Center the map on the user's location
    map.setView([userLat, userLng], 19);

    // Start watching the user's position
    navigator.geolocation.watchPosition(updateUserLocation, handleLocationError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    });

    // Start the hunt after centering on the user
    startHunt();
}

function startHunt() {
    gameLocations = getLocationsInIdOrder();
    currentLocationIndex = 0;
    loadNextLocation();
}

function getLocationsInIdOrder() {
    return locations_h.sort((a, b) => a.id - b.id);
}

function loadNextLocation() {
    if (currentLocationIndex < gameLocations.length) {
        const location = gameLocations[currentLocationIndex];
        
        // Remove existing marker if it exists
        if (locationMarker) {
            map.removeLayer(locationMarker);
        }
        
        // Create new marker
        locationMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'custom-pin-icon',
                html: '<div class="pin-head"></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            })
        });

                // Add marker to map
        locationMarker.addTo(map);

const popupContent = `
<div class="popup-content">
    <img src="${location.image}" alt="${location.name}" class="location-image">
    <h4 class="location-name">${location.name}</h4>
    <div class="popup-buttons">
        <a href="#" class="button route-button" data-lat="${location.lat}" data-lng="${location.lng}" style="color:white;">Directions</a>
        <button class="button bypass-button">Bypass</button>
    </div>
</div>
`;

        //bind content to the popup, ensure that the popup is initially open when it is added.
        locationMarker.bindPopup(popupContent, {
            offset: L.point(0, -25),
            className: 'custom-popup'
       });

        // Add event listeners after the popup is opened
        locationMarker.on('popupopen', function() {
            const routeButton = document.querySelector('.route-button');
            const bypassButton = document.querySelector('.bypass-button');

            if (routeButton) {
                routeButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lat = this.getAttribute('data-lat');
                    const lng = this.getAttribute('data-lng');
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
                });
            }

            if (bypassButton) {
                bypassButton.addEventListener('click', function() {
                    console.log('Bypass clicked');
                    currentLocationIndex++;
                    locationMarker.closePopup();
                    loadNextLocation();
                });
            }
        });

        updateDistanceBox();
        resetInactivityTimer();
    } else {
        showCongratulations();
    }
}
    
function resetInactivityTimer() {
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    inactivityTimer = setTimeout(() => {
        if (userMarker && userMarker.getLatLng()) {
            map.setView(userMarker.getLatLng(), map.getZoom());
            if (locationMarker && locationMarker.getPopup() && locationMarker.getPopup().isOpen()) {
                locationMarker.closePopup();
            }
        }
    }, 25000);
}

function updateDistanceBox() {
    if (userMarker && locationMarker) {
        let userLat = userMarker.getLatLng().lat;
        let userLng = userMarker.getLatLng().lng;
        
        // If user location is not available, use the map center
        if (userLat === 0 && userLng === 0) {
            const center = map.getCenter();
            userLat = center.lat;
            userLng = center.lng;
        }

        const distance = L.latLng(userLat, userLng).distanceTo(locationMarker.getLatLng());
        const distanceFeet = Math.round(distance * 3.28084);
        let distanceText;
        if (distanceFeet < 5280) {
            distanceText = `${distanceFeet} feet`;
        } else {
            const distanceMiles = (distanceFeet / 5280).toFixed(2);
            distanceText = `${distanceMiles} miles`;
        }
        document.getElementById('distanceBox').innerText = `Next Stop: ${distanceText}`;
        if (distanceFeet <= DISTANCE_THRESHOLD && !isLocationHuntVisible) {
            showLocationHunt();
        }
    }
}

function showLocationHunt() {

isLocationHuntVisible = true;

const location = gameLocations[currentLocationIndex];

const lochuntContainer = document.querySelector('.lochunt-container');

lochuntContainer.style.display = 'flex';

lochuntContainer.style.flexDirection = 'column';

lochuntContainer.style.height = '100vh';

lochuntContainer.style.backgroundColor = '#f5f5f5';

const locationImage = document.getElementById('locationImage');

locationImage.src = location.image;

locationImage.style.height = '40vh';

locationImage.style.objectFit = 'cover';

locationImage.style.borderBottom = '3px solid #005f9e';

const contentContainer = document.createElement('div');

contentContainer.style.padding = '20px';

contentContainer.style.flex = '1';

contentContainer.style.display = 'flex';

contentContainer.style.flexDirection = 'column';

contentContainer.style.justifyContent = 'center';

contentContainer.innerHTML =

'<h1 id="locationTitle" style="font-size: 2em; text-align: center; margin-bottom: 10px; color: #1a1a1a; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); font-weight: 600; letter-spacing: 0.5px;">' + location.name + '</h1>' +
'<p id="locationCity" style="font-size: 1.6em; text-align: center; margin-bottom: 5px; color: #333; font-weight: 400; letter-spacing: 0.3px;">' + location.city + '</p>' +
'<p id="locationCreator" style="font-size: 1.4em; text-align: center; color: #555; font-style: italic; margin-top: 5px;">Created by: <span style="font-weight: 500;">' + location.creator + '</span></p>';

locationImage.insertAdjacentElement('afterend', contentContainer);

const audioElement = document.getElementById('locationAudio');

const audioPlayerContainer = document.querySelector('.audio-player');

if (location.audio) {

audioElement.src = location.audio;

audioElement.load();

initAudioPlayer();

audioPlayerContainer.style.display = 'block';

} else {

audioPlayerContainer.style.display = 'none';

}

const blueBar = document.createElement('div');

blueBar.style.width = '100%';

blueBar.style.height = '50px';

blueBar.style.backgroundColor = '#005f9e';

blueBar.style.marginTop = 'auto';

blueBar.style.boxShadow = '0 -2px 5px rgba(0,0,0,0.1)';

lochuntContainer.appendChild(blueBar);

}

function initAudioPlayer() {

const audio = document.getElementById('locationAudio');

const playPauseBtn = document.getElementById('playPauseBtn');

const rewindBtn = document.getElementById('rewindBtn');

const forwardBtn = document.getElementById('forwardBtn');

const progressBar = document.getElementById('progressBar');

const progressContainer = document.querySelector('.progress');

const currentTimeSpan = document.getElementById('currentTime');

const durationSpan = document.getElementById('duration');

playPauseBtn.addEventListener('click', togglePlay);

rewindBtn.addEventListener('click', () => seek(-10));

forwardBtn.addEventListener('click', () => seek(10));

audio.addEventListener('timeupdate', updateProgress);

audio.addEventListener('loadedmetadata', setDuration);

audio.addEventListener('ended', showTriviaQuestion);

progressContainer.addEventListener('click', setProgress);

function togglePlay() {

if (audio.paused) {

audio.play();

playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';

} else {

audio.pause();

playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';

}

}

function seek(seconds) {

audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, audio.duration));

}

function updateProgress() {

const percent = (audio.currentTime / audio.duration) * 100;

progressBar.style.width = `${percent}%`;

currentTimeSpan.textContent = formatTime(audio.currentTime);

}

function setProgress(e) {

const width = this.clientWidth;

const clickX = e.offsetX;

const duration = audio.duration;

audio.currentTime = (clickX / width) * duration;

}

function setDuration() {

durationSpan.textContent = formatTime(audio.duration);

}

function formatTime(time) {

const minutes = Math.floor(time / 60);

const seconds = Math.floor(time % 60);

return `${minutes}:${seconds.toString().padStart(2, '0')}`;

}

}

function showTriviaQuestion() {

const location = gameLocations[currentLocationIndex];

const triviaContainer = document.querySelector('.trivia-container');

triviaContainer.style.display = 'block';

document.getElementById('triviaQuestion').textContent = location.trivia.question;

const optionsContainer = document.getElementById('triviaOptions');

optionsContainer.innerHTML = '';

location.trivia.options.forEach((option, index) => {

const button = document.createElement('button');

button.textContent = option;

button.classList.add('btn', 'btn-outline-primary', 'mb-2');

button.onclick = () => checkAnswer(index);

optionsContainer.appendChild(button);

});

}

function checkAnswer(selectedIndex) {

const location = gameLocations[currentLocationIndex];

if (selectedIndex === location.trivia.answer) {

alert('Correct! Moving to the next location.');

visitedLocations.push(currentLocationIndex);

currentLocationIndex++;

document.querySelector('.lochunt-container').style.display = 'none';

document.querySelector('.trivia-container').style.display = 'none';

isLocationHuntVisible = false;

loadNextLocation();

} else {

alert('Incorrect. Try again!');

}

}

function showCongratulations() {
    alert("Congratulations! You've completed the entire tour!");
}

const smoothingFactor = 0.2;
const velocitySmoothingFactor = 0.3;
let lastSmoothedPosition = null;
let smoothedVelocity = { lat: 0, lng: 0 };

function updateUserLocation(position) {
    if (isMapInteracting) return;

    const currentTime = position.timestamp;
    const newPosition = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        timestamp: currentTime
    };

    // Check if the new position is valid
    if (isNaN(newPosition.lat) || isNaN(newPosition.lng)) {
        console.warn("Invalid position received:", newPosition);
        return;
    }

    if (!lastSmoothedPosition) {
        lastSmoothedPosition = newPosition;
    }

    // Apply exponential smoothing to the position
    const smoothedPosition = {
        lat: lastSmoothedPosition.lat + smoothingFactor * (newPosition.lat - lastSmoothedPosition.lat),
        lng: lastSmoothedPosition.lng + smoothingFactor * (newPosition.lng - lastSmoothedPosition.lng),
        timestamp: currentTime
    };

    // Calculate instantaneous velocity
    const timeDiff = (currentTime - lastSmoothedPosition.timestamp) / 1000; // in seconds
    if (timeDiff > 0) {
        const instantVelocity = {
            lat: (smoothedPosition.lat - lastSmoothedPosition.lat) / timeDiff,
            lng: (smoothedPosition.lng - lastSmoothedPosition.lng) / timeDiff
        };

        // Apply exponential smoothing to velocity
        smoothedVelocity = {
            lat: smoothedVelocity.lat + velocitySmoothingFactor * (instantVelocity.lat - smoothedVelocity.lat),
            lng: smoothedVelocity.lng + velocitySmoothingFactor * (instantVelocity.lng - smoothedVelocity.lng)
        };
    }

    // Predict next position based on smoothed velocity
    const predictedPosition = {
        lat: smoothedPosition.lat + smoothedVelocity.lat * 0.1, // Predict 100ms ahead
        lng: smoothedPosition.lng + smoothedVelocity.lng * 0.1
    };

    const angle = calculateAngle(lastSmoothedPosition, predictedPosition);

    requestAnimationFrame(() => {
        updateUserMarkerHeading(angle);
        updateUserMarkerPosition(predictedPosition);
        centerMapOnUser(predictedPosition);
    });

    lastSmoothedPosition = smoothedPosition;
    updateDistanceBox();
}

function updateUserMarkerPosition(position) {
    const markerElement = userMarker.getElement();
    if (markerElement) {
        markerElement.style.transition = 'transform 0.1s linear';
        markerElement.style.transform = `translate3d(${map.latLngToLayerPoint(position).x}px, ${map.latLngToLayerPoint(position).y}px, 0)`;
    }
    userMarker.setLatLng(position);
}

function centerMapOnUser(position) {
    if (!isMapInteracting) {
        map.panTo(position, { animate: true, duration: 0.1, easeLinearity: 1 });
    }
}

function calculateAngle(pos1, pos2) {
    return Math.atan2(pos2.lng - pos1.lng, pos2.lat - pos1.lat) * 180 / Math.PI;
}

function updateUserMarkerHeading(angle) {
    const userMarkerIcon = userMarker.getElement().querySelector('.user-marker-icon');
    if (userMarkerIcon) {
        userMarkerIcon.style.transition = 'transform 0.1s linear';
        userMarkerIcon.style.transform = `rotate(${angle}deg)`;
    }
}

function handleLocationError(error) {
    console.warn("Error getting user location:", error);
    
    // If we already have a user location, don't disrupt the experience
    if (userMarker.getLatLng().lat !== 0 || userMarker.getLatLng().lng !== 0) {
        console.log("Using last known location");
        return;
    }
    
    // Only show an alert if we don't have any location
    alert("Unable to get your location. The tour will continue with limited functionality. Please ensure location services are enabled for the best experience.");
}

function recenterMap() {
    const recenterButton = document.getElementById('recenterButton');
    recenterButton.style.backgroundColor = '#007bff';
    recenterButton.style.color = 'white';
    if (userMarker.getLatLng()) {
        map.setView(userMarker.getLatLng(), map.getZoom());
    }
    setTimeout(() => {
        recenterButton.style.backgroundColor = 'white';
        recenterButton.style.color = '#007bff';
    }, 500);
}

function returnToIndex() {
    if (confirm("Are you sure you want to end the hunt and return to the index?")) {
        window.location.href = "index.html";
    }
    document.getElementById('returnButton').classList.remove('active');
}

function toggleNavigationTips() {
    const tipsElement = document.querySelector('.navigation-tips');
    tipsElement.style.display = 'block';
    document.getElementById('tipsButton').classList.remove('active');
}

function closeNavigationTips() {
    document.querySelector('.navigation-tips').style.display = 'none';
}
/*
locationMarker.on('popupopen', function() {
    document.querySelector('.route-button').addEventListener('click', function(e) {
        e.preventDefault();
        const lat = this.getAttribute('data-lat');
        const lng = this.getAttribute('data-lng');
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
    });

    document.querySelector('.bypass-button').addEventListener('click', function() {
        // Add your bypass logic here
        console.log('Bypass clicked');
    });
});
*/
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    document.getElementById('recenterButton').addEventListener('click', recenterMap);
    document.getElementById('returnButton').addEventListener('click', function() {
        this.classList.add('active');
        returnToIndex();
    });
    document.getElementById('tipsButton').addEventListener('click', function() {
        this.classList.add('active');
        toggleNavigationTips();
    });
    document.querySelector('.navigation-tips .close-button').addEventListener('click', closeNavigationTips);

    map.on('movestart', resetInactivityTimer);
    map.on('zoomstart', resetInactivityTimer);
    map.on('drag', resetInactivityTimer);
    map.on('click', resetInactivityTimer);
});

</script>
    </body>
</html>
