<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Streets of St. Paul</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <style>
    .map-container {
      border: 2px solid #000 !important;
      width: 88%;
      margin: 10px auto;
      max-width: 100%;
      height: 400px;
    }

    #map {
      width: 100%;
      height: 400;
    }

    .message-box {
      border: 1px solid black;
      padding: 10px;
      margin-bottom: 20px;
    }

    .safety-message-box {
      border: 1px solid black;
      padding: 16px;
    }

    body {
      font-size: 18px;
    }

    @media (max-width: 768px) {
      body {
        font-size: 16px;
      }
    }

    .leaflet-popup-content-wrapper:before {
      content: attr(data-number);
      background-color: #0089e0;
      color: #fff;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }

    .leaflet-popup-content {
      font-size: 18px;
    }

    .leaflet-popup-tip-container {
      display: none;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-12 p-0">
      <div id="map" style="height: 400px;"></div>
    </div>
  </div>
  <div class="col-12 message-box bg-primary text-white p-3 rounded mb-3" style="font-size: 1.2rem;">
    <p><strong>Navigation Tip:</strong> Discover historical locations by moving toward the map's blue markers. Your mobile device will automatically update with information when you're in range.</p>
  </div>
  <div class="col-12 safety-message-box bg-danger text-white p-3 rounded" style="font-size: 1.2rem;">
    <p><strong>Safety Reminder:</strong> We want you to have a safe and enjoyable experience while exploring local history. Please keep an eye on your surroundings and be mindful of potential hazards.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha384-+G7E9Z/3OqWe3TRhO8vKGQQRy4x4cqLw0WtA8iRGd/sZ9H5G87NL5E5f0mw5O5HJ"
        crossorigin=""></script>
<script src="/locations.js"></script>

<script>
  function getDistanceFromLatLonInFeet(lat1, lon1, lat2, lon2) {
    const R = 20908800; // Radius of the earth in feet
    const dLat = deg2rad(lat2 - lat1); // deg2rad below
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(deg2rad(lat1)) *
      Math.cos(deg2rad(lat2)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; // Distance in feet
    return d;
  }

  function deg2rad(deg) {
    return deg * (Math.PI / 180);
  }

  function getNearestTour(latitude, longitude) {
    // Define the tour pages and their GPS coordinates
    const tours = [
      {name: "tour1", latitude: 45.14443858883663, longitude: -93.00451478892819},
      {name: "tour2", latitude: 144.955674, longitude: -93.1069443},
      {name: "tour3", latitude: 144.96237525092297, longitude: -93.0707501008638},
      {name: "tour4", latitude: 145.1439069, longitude: -93.0038262},
      {name: "tour5", latitude: 145.1442686, longitude: -93.0037758},
      {name: "tour6", latitude: 145.1444917, longitude: -93.0041007},
      {name: "tour7", latitude: 145.1444404, longitude: -93.0044889}
    ];

    // Calculate the distances to each tour page
    const distances = tours.map(tour => {
      const distance = getDistanceFromLatLonInFeet(
        latitude,
        longitude,
        tour.latitude,
        tour.longitude
      );
      return {tour: tour.name, distance: distance};
    });

    // Sort the distances in ascending order and return the nearest tour page
    const nearestTour = distances.sort((a, b) => a.distance - b.distance)[0];
    return nearestTour.distance <= 7 ? nearestTour.tour : null;
  }

  function onLocationFound(e) {
    userLocationMarker.setLatLng(e.latlng);
    map.setView(e.latlng);
  }

  function onLocationError(e) {
    alert(e.message);
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          const nearestTour = getNearestTour(latitude, longitude);
          if (nearestTour) {
            window.location.href = `${nearestTour}.html`;
          }
          onLocationFound(position);
        },
        () => {
          alert("Unable to retrieve location."); // Error handling
        },
        {
          timeout: 8000 // Set timeout value to 8 seconds
        }
      );
    } else {
      alert("Geolocation is not supported by this browser."); // Error handling
    }
  }

  var map = L.map('map').setView([44.962472993853055, -93.07146893327669], 18);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '',
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1
  }).addTo(map);

  var userLocationMarker = L.marker([0, 0]).addTo(map);

  map.on('locationfound', onLocationFound);
  map.on('locationerror', onLocationError);

  getLocation();
</script>
</body>
</html>
