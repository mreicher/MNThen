<!DOCTYPE html>
<html>
<head>
    <title>Minnesota Then</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="description" content="An interactive map for self-guided Minnesota history tours">

    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" />
    <link rel="stylesheet" type="text/css" href="https://www.mnthen.com/css/map_page.css">

    <style>
        #distanceBox {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background: var(--light-bg-color);
            border-radius: 12px;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            border: 2px solid red;
            z-index: 999;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .hidden {
            display: none;
        }

        #recenter-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }

        #filter-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div id="recenter-button" class="leaflet-bar leaflet-control leaflet-control-custom">
            <i class="fas fa-crosshairs" id="recenter-icon"></i>
        </div>
        <div id="filter-button" class="leaflet-bar leaflet-control leaflet-control-custom">
            <i class="fas fa-filter" id="filter-icon"></i>
        </div>
    </div>

    <div id="distanceBox">Initializing ...</div>

    <div id="filter-popup" class="popup hidden">
        <h3>Filter Locations</h3>
        <div id="filter-options"></div>
        <p id="location-counter">Visible locations: <span id="count">0</span></p>
        <button id="close-filter">Close</button>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-10 col-md-8 col-lg-6">
                <div class="info-box-container">
                    <div class="info-box">
                        <strong>Navigation Tips:</strong> After exploring a location, wait 90 seconds to revisit. Ready to end your journey? Please exit below.
                    </div>
                    <!-- Exit Button -->
                    <button class="exit-button btn btn-primary">Exit Map</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script>
    <script src="/locations_test.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        var closestDistance = Infinity;
        var newMarkers = {};

        const alpha = 0.4;
        const beta = 0.02;
        var lastEstimatedPos = null;
        var lastEstimatedVel = { lat: 0, lng: 0 };

        const distanceBox = document.getElementById("distanceBox");
        const locationPopup = document.createElement("div");
        locationPopup.id = "location-popup";
        locationPopup.innerHTML = "Locating user...";
        document.body.appendChild(locationPopup);

        const locationTimeout = setTimeout(() => {
            locationPopup.innerHTML = "Location not found. Please try again.";
        }, 10000);

        const INITIAL_DELAY = 2000;
        const COOLDOWN = 90000;
        const HIGH_ACCURACY_THRESHOLD = 1000;
        const AUTO_CENTER_THRESHOLD = 25000;
        const thresholdFeet = 20;

        var lastTransitionTime = sessionStorage.getItem('lastTransitionTime');
        var lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');

        var map = L.map("map", {
            attributionControl: false,
            inertia: false,
        }).setView([45.09396938812941, -92.99743282865592], 20);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 20,
            id: "mapbox/streets-v11",
            tileSize: 512,
            zoomOffset: -1,
        }).addTo(map);

        L.control.attribution({ prefix: false }).addTo(map);

        var userLocationMarker = L.circleMarker([0, 0], {
            color: "red",
            fillColor: "#f03",
            fillOpacity: 0.5,
            radius: 6,
        }).addTo(map);

        var userInteracted = false;

        map.on("dragstart zoomstart", function() {
            userInteracted = true;
        });

        document.addEventListener("visibilitychange", function() {
            if (!document.hidden) {
                userInteracted = false;
            }
        });

        var markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: false
        });

        map.addLayer(markers);

        markers.on("clusterclick", function (e) {
            var childMarkers = e.layer.getAllChildMarkers();
            if (childMarkers.length > 0) {
                childMarkers[0].openPopup();
            }
        });

        function initializeMarkers(locations) {
            locations.forEach(location => {
                const markerIcon = createMarkerIcon(location);
                const marker = L.marker([location.lat, location.lng], { icon: markerIcon }).bindPopup(createPopupContent(location));
                markers.addLayer(marker);
            });
            map.addLayer(markers);
            updateLocationCounter();
        }

        var initialLocationSet = false;
        var lastUserInteractionTime = 0;

        map.on("dragstart zoomstart", function() {
            lastUserInteractionTime = Date.now();
        });

        map.on("locationfound", function (e) {
            console.log("Location found:", e);
            clearTimeout(locationTimeout);
            locationPopup.innerHTML = "User found.";
            setTimeout(() => {
                locationPopup.style.display = "none";
            }, 2000);

            if (!initialLocationSet) {
                map.setView(e.latlng, 20);
                initialLocationSet = true;
            } else {
                const timeSinceLastInteraction = Date.now() - lastUserInteractionTime;
                if (timeSinceLastInteraction > AUTO_CENTER_THRESHOLD) {
                    map.setView(e.latlng, map.getZoom());
                }
            }
            updateUserLocation(e);
        });

        var lastKnownLatLng = null;
        var currentLatLng = null;
        var closestLocation = null;
        let useHighAccuracy = false;

        function alphaBetaFilter(newMeasurement) {
            if (!lastEstimatedPos) {
                lastEstimatedPos = newMeasurement;
                return lastEstimatedPos;
            }

            const predictedPos = {
                lat: lastEstimatedPos.lat + lastEstimatedVel.lat,
                lng: lastEstimatedPos.lng + lastEstimatedVel.lng
            };

            const residual = {
                lat: newMeasurement.lat - predictedPos.lat,
                lng: newMeasurement.lng - predictedPos.lng
            };

            const estimatedPos = {
                lat: predictedPos.lat + alpha * residual.lat,
                lng: predictedPos.lng + alpha * residual.lng
            };

            const estimatedVel = {
                lat: lastEstimatedVel.lat + (beta * residual.lat),
                lng: lastEstimatedVel.lng + (beta * residual.lng)
            };

            lastEstimatedPos = estimatedPos;
            lastEstimatedVel = estimatedVel;

            return lastEstimatedPos;
        }

        function updateUserLocation(e) {
            const newLatLng = e.latlng;
            const filteredLatLng = alphaBetaFilter(newLatLng);
            currentLatLng = filteredLatLng;
            userLocationMarker.setLatLng(currentLatLng);

            const closest = findClosestLocation(currentLatLng, thresholdFeet);
            if (closest && closest !== lastVisitedLocation) {
                console.log("User is close to:", closest);
                lastVisitedLocation = closest;
                displayLocationDetails(closest);
                lastTransitionTime = Date.now();
                sessionStorage.setItem('lastTransitionTime', lastTransitionTime);
                sessionStorage.setItem('lastVisitedLocation', closest);
            }
            distanceBox.innerHTML = `Distance: ${calculateDistance(currentLatLng, closest)} feet`;
        }

        function createMarkerIcon(location) {
            const markerIcon = L.divIcon({
                className: "custom-marker",
                html: `<i class="${location.icon}"></i>`,
                iconSize: [30, 42],
                iconAnchor: [15, 42],
                popupAnchor: [0, -42],
            });
            return markerIcon;
        }

        function createPopupContent(location) {
            return `<div class="popup-content">
                <img src="${location.image}" alt="${location.name}" class="popup-image" />
                <div class="popup-name">${location.name}</div>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank" class="popup-directions">
                    <i class="fas fa-directions"></i> Get Directions
                </a>
            </div>`;
        }

        function calculateDistance(latlng1, latlng2) {
            if (!latlng1 || !latlng2) {
                return null;
            }
            return (latlng1.distanceTo(latlng2)).toFixed(2);
        }

        function findClosestLocation(currentLatLng, thresholdFeet) {
            let minDistance = Infinity;
            let closestLocation = null;

            locations.forEach(location => {
                const locationLatLng = L.latLng(location.lat, location.lng);
                const distance = currentLatLng.distanceTo(locationLatLng);

                if (distance < minDistance && distance <= thresholdFeet) {
                    minDistance = distance;
                    closestLocation = location;
                }
            });

            if (closestLocation) {
                console.log("Closest location within threshold:", closestLocation);
            } else {
                console.log("No locations within threshold.");
            }

            return closestLocation;
        }

        function displayLocationDetails(location) {
            const popupContent = `
                <h3>${location.name}</h3>
                <p>${location.description}</p>
                <audio controls>
                    <source src="${location.audio}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            `;
            L.popup()
                .setLatLng([location.lat, location.lng])
                .setContent(popupContent)
                .openOn(map);
        }

        function handleFilter() {
            const filters = getSelectedFilters();
            filterLocations(filters);
        }

        function getSelectedFilters() {
            const filters = [];
            const checkboxes = document.querySelectorAll("#filter-options input[type=checkbox]");
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    filters.push(checkbox.value);
                }
            });
            return filters;
        }

        function filterLocations(filters) {
            markers.clearLayers();

            const filteredLocations = locations.filter(location => {
                return filters.every(filter => location.categories.includes(filter));
            });

            initializeMarkers(filteredLocations);
        }

        function updateLocationCounter() {
            const countElement = document.getElementById("count");
            const count = markers.getLayers().length;
            countElement.textContent = count;
        }

        const filterPopup = document.getElementById("filter-popup");
        const filterButton = document.getElementById("filter-button");
        const closeFilterButton = document.getElementById("close-filter");

        filterButton.addEventListener("click", function() {
            filterPopup.classList.toggle("hidden");
        });

        closeFilterButton.addEventListener("click", function() {
            filterPopup.classList.add("hidden");
        });

        document.getElementById("filter-options").addEventListener("change", handleFilter);

        map.locate({
            watch: true,
            enableHighAccuracy: true
        });
        
        initializeMarkers(locations);
    });
    </script>
</body>
</html>
