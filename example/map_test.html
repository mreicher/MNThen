<!DOCTYPE html>
<html>
<head>
    <title>Minnesota Then</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="description" content="An interactive map for self-guided Minnesota history tours">

    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" />
    <link rel="stylesheet" type="text/css" href="https://www.mnthen.com/css/map_page.css">

    <style>
        /* Add your styles here */
        #distanceBox {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background: var(--light-bg-color);
            border-radius: 12px;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            border: 2px solid red;
            z-index: 999;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div id="recenter-button" class="leaflet-bar leaflet-control leaflet-control-custom">
            <i class="fas fa-crosshairs" id="recenter-icon"></i>
        </div>
        <div id="help-button" class="leaflet-bar leaflet-control leaflet-control-custom">
            <i class="fas fa-question-circle" id="help-icon"></i>
        </div>
    </div>

    <div id="distanceBox">Initializing ...</div>

    <div id="filter-section">
        <h3>Filter Locations</h3>
        <div id="filter-options">
            <!-- Checkboxes will be dynamically added here -->
        </div>
        <p id="location-counter">Visible locations: <span id="count">0</span></p>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-10 col-md-8 col-lg-6">
                <div class="info-box-container">
                    <div class="info-box">
                        <strong>Navigation Tips:</strong> After exploring a location, wait 90 seconds to revisit. Ready to end your journey? Please exit below.
                    </div>
                    <!-- Exit Button -->
                    <button class="exit-button btn btn-primary">Exit Map</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script>
    <script src="/locations_test.js?ts=070420242"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var closestDistance = Infinity;
            var newMarkers = {};

            const alpha = 0.4;
            const beta = 0.02;
            var lastEstimatedPos = null;
            var lastEstimatedVel = { lat: 0, lng: 0 };

            const distanceBox = document.getElementById("distanceBox");

            var map = L.map("map", {
                attributionControl: false,
                inertia: false,
            }).setView([45.09396938812941, -92.99743282865592], 20);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 20,
                id: "mapbox/streets-v11",
                tileSize: 512,
                zoomOffset: -1,
            }).addTo(map);

            L.control.attribution({ prefix: false }).addTo(map);

            var userLocationMarker = L.circleMarker([0, 0], {
                color: "red",
                fillColor: "#f03",
                fillOpacity: 0.5,
                radius: 6,
            }).addTo(map);

            var userInteracted = false;

            map.on("dragstart zoomstart", function() {
                userInteracted = true;
            });

            document.addEventListener("visibilitychange", function() {
                if (!document.hidden) {
                    userInteracted = false;
                }
            });

            var markers = L.markerClusterGroup({
                spiderfyOnMaxZoom: false
            });

            function loadScriptWithCacheBust() {
                const cacheBust = Date.now();
                const script = document.createElement("script");

                if (!document.querySelector('[src^="/locations_test.js"]')) {
                    script.src = `/locations_test.js?v=${cacheBust}`;
                    document.body.appendChild(script);
                }

                script.onload = function() {
                    if (Array.isArray(locations) && locations.length) {
                        console.log("Location data loaded successfully:", locations);
                        map.locate({ setView: false, maxZoom: 20 });
                        addMarkers(locations);
                    } else {
                        console.error("Location data is missing or empty:", locations);
                    }
                };

                script.onerror = function() {
                    console.error("Failed to load the script:", script.src);
                };

                document.body.appendChild(script);
            }

            loadScriptWithCacheBust();

            function alphaBetaFilter(newMeasurement) {
                if (!lastEstimatedPos) {
                    lastEstimatedPos = newMeasurement;
                    return lastEstimatedPos;
                }

                const predictedPos = {
                    lat: lastEstimatedPos.lat + lastEstimatedVel.lat,
                    lng: lastEstimatedPos.lng + lastEstimatedVel.lng
                };

                const residual = {
                    lat: newMeasurement.lat - predictedPos.lat,
                    lng: newMeasurement.lng - predictedPos.lng
                };

                lastEstimatedPos.lat += alpha * residual.lat;
                lastEstimatedPos.lng += alpha * residual.lng;
                lastEstimatedVel.lat += beta * residual.lat;
                lastEstimatedVel.lng += beta * residual.lng;

                return lastEstimatedPos;
            }

            function addMarkers(locations) {
                const markerIconClasses = {
                    "history": "blue-marker",
                    "hamm": "orange-marker",
                    "gangster": "green-marker",
                    "split": "split-marker",
                    "wbl_split": "wbl_split-marker",
                    "lake": "purple-marker",
                    "capitol": "burgundy-marker",
                    "summit": "charcoal-marker",
                    "northeast": "teal-marker",
                    "default": "blue-marker"
                };

                locations.forEach(location => {
                    const locationLatLng = L.latLng(location.lat, location.lng);
                    const markerId = location.lat + ',' + location.lng;
                    const iconClass = markerIconClasses[location.tour] || markerIconClasses["default"];

                    const markerIcon = L.divIcon({
                        className: `custom-marker-icon ${iconClass}`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6],
                        popupAnchor: [0, -16],
                        html: `<span style="font-weight: bold; color: white; font-size: 14px;"></span>`
                    });

                    var popupContent = `
                        <div class="popup-content">
                            <img src="${location.image}" alt="${location.name}">
                            <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank" rel="noopener noreferrer">
                                <img src="/images/route_icon.png" alt="Google Maps" style="width: 40px; height: 40px; margin-bottom: -10px;">
                                <div style="margin-top: -10px; margin-bottom: -10px; font-size: 12px; color: white;">Directions</div>
                            </a>
                        </div>
                    `;

                    var marker = L.marker(locationLatLng, { icon: markerIcon })
                        .bindPopup(popupContent);

                    markers.addLayer(marker);
                    newMarkers[markerId] = marker;
                });

                map.addLayer(markers);
            }

            function onLocationFound(e) {
                var radius = e.accuracy / 2;
                const userLatLng = L.latLng(e.latitude, e.longitude);

                const estimatedPosition = alphaBetaFilter(userLatLng);
                userLocationMarker.setLatLng(estimatedPosition);

                if (!userInteracted) {
                    map.setView(userLatLng, 17);
                }

                let closestDistance = Infinity;
                let closestMarker = null;

                locations.forEach(location => {
                    const locationLatLng = L.latLng(location.lat, location.lng);
                    const distance = userLatLng.distanceTo(locationLatLng);

                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestMarker = newMarkers[`${location.lat},${location.lng}`];
                    }
                });

                if (closestMarker) {
                    closestMarker.openPopup();
                }

                distanceBox.innerHTML = `Closest distance: ${closestDistance.toFixed(2)} meters`;
            }

            map.on("locationfound", onLocationFound);
            map.on("locationerror", function (e) {
                console.error("Location error:", e.message);
            });

            var isRecenterButtonActive = false;

            document.getElementById("recenter-button").addEventListener("click", function () {
                isRecenterButtonActive = !isRecenterButtonActive;

                if (isRecenterButtonActive) {
                    map.locate({ setView: true, maxZoom: 17 });
                }
            });

            document.getElementById("help-button").addEventListener("click", function () {
                alert("Use the recenter button to find your current location. Explore the map to discover historic sites in Minnesota.");
            });
        });
    </script>
</body>
</html>
