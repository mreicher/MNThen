<!DOCTYPE html>

<html>

<head>

    <title>Minnesota Then</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta charset="UTF-8">

    <meta name="description" content="An interactive map for self-guided Minnesota history tours">


    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" />

    <link rel="stylesheet" type="text/css" href="https://www.mnthen.com/css/map_page.css">


    <style>

        #distanceBox {

            position: absolute;

            top: 10px;

            right: 10px;

            padding: 10px 20px;

            background: var(--light-bg-color);

            border-radius: 12px;

            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);

            font-size: 18px;

            font-weight: 600;

            color: var(--text-color);

            border: 2px solid red;

            z-index: 999;

            transition: transform 0.3s ease, box-shadow 0.3s ease;

        }


        .popup {

    position: absolute;

    top: 50%;

    left: 50%;

    transform: translate(-50%, -50%);

    background: white;

    padding: 20px;

    border-radius: 5px;

    box-shadow: 0 0 10px rgba(0,0,0,0.5);

    z-index: 1000;

}


.hidden {

    display: none;

}


#recenter-button {

    position: absolute;

    bottom: 10px;

    left: 10px;

    z-index: 1000;

}


#filter-button {

    position: absolute;

    bottom: 20px;

    right: 20px;

    z-index: 1000;

}


    </style>

</head>

<body>

    <div id="map-container">

        <div id="map"></div>

        <div id="recenter-button" class="leaflet-bar leaflet-control leaflet-control-custom">

            <i class="fas fa-crosshairs" id="recenter-icon"></i>

        </div>

<div id="filter-button" class="leaflet-bar leaflet-control leaflet-control-custom">

    <i class="fas fa-filter" id="filter-icon"></i>

</div>

    </div>


    <div id="distanceBox">Initializing ...</div>


<div id="filter-popup" class="popup hidden">

    <h3>Filter Locations</h3>

    <div id="filter-options"></div>

    <p id="location-counter">Visible locations: <span id="count">0</span></p>

    <button id="close-filter">Close</button>

</div>


    <div class="container">

        <div class="row justify-content-center">

            <div class="col-10 col-md-8 col-lg-6">

                <div class="info-box-container">

                    <div class="info-box">

                        <strong>Navigation Tips:</strong> After exploring a location, wait 90 seconds to revisit. Ready to end your journey? Please exit below.

                    </div>

                    <!-- Exit Button -->

                    <button class="exit-button btn btn-primary">Exit Map</button>

                </div>

            </div>

        </div>

    </div>


    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script>

    <script src="/locations_test.js?ts=070420243"></script>


    <script>

document.addEventListener("DOMContentLoaded", function () {

    var closestDistance = Infinity;

    var newMarkers = {};


    const alpha = 0.4;

    const beta = 0.02;

    var lastEstimatedPos = null;

    var lastEstimatedVel = { lat: 0, lng: 0 };


    const distanceBox = document.getElementById("distanceBox");

    const locationPopup = document.createElement("div");

    locationPopup.id = "location-popup";

    locationPopup.innerHTML = "Locating user...";

    document.body.appendChild(locationPopup);


    const locationTimeout = setTimeout(() => {

        locationPopup.innerHTML = "Location not found. Please try again.";

    }, 10000);


    const INITIAL_DELAY = 2000;

    const COOLDOWN = 90000;

    const HIGH_ACCURACY_THRESHOLD = 1000;

    const AUTO_CENTER_THRESHOLD = 25000;

    const thresholdFeet = 20;


    var lastTransitionTime = sessionStorage.getItem('lastTransitionTime');

    var lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');


    var map = L.map("map", {

        attributionControl: false,

        inertia: false,

    }).setView([45.09396938812941, -92.99743282865592], 20);


    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {

        maxZoom: 20,

        id: "mapbox/streets-v11",

        tileSize: 512,

        zoomOffset: -1,

    }).addTo(map);


    L.control.attribution({ prefix: false }).addTo(map);


    var userLocationMarker = L.circleMarker([0, 0], {

        color: "red",

        fillColor: "#f03",

        fillOpacity: 0.5,

        radius: 6,

    }).addTo(map);


    var userInteracted = false;


    map.on("dragstart zoomstart", function() {

        userInteracted = true;

    });


    document.addEventListener("visibilitychange", function() {

        if (!document.hidden) {

            userInteracted = false;

        }

    });


    var markers = L.markerClusterGroup({

        spiderfyOnMaxZoom: false

    });


    map.addLayer(markers);


    markers.on("clusterclick", function (e) {

        var childMarkers = e.layer.getAllChildMarkers();

        if (childMarkers.length > 0) {

            childMarkers[0].openPopup();

        }

    });



    loadLocations().then(locations => {

        if (Array.isArray(locations) && locations.length) {

            console.log("Location data loaded successfully:", locations);

            createFilterCheckboxes(locations);

            initializeMarkers(locations);

            updateFilters();

            map.locate({ setView: false, maxZoom: 20 });

        } else {

            console.error("Location data is missing or empty:", locations);

        }

    }).catch(error => {

        console.error("Failed to load locations:", error);

    });


    var initialLocationSet = false;

    var lastUserInteractionTime = 0;


    map.on("dragstart zoomstart", function() {

        lastUserInteractionTime = Date.now();

    });


    map.on("locationfound", function (e) {

        console.log("Location found:", e);

        clearTimeout(locationTimeout);

        locationPopup.innerHTML = "User found.";

        setTimeout(() => {

            locationPopup.style.display = "none";

        }, 2000);


        if (!initialLocationSet) {

            map.setView(e.latlng, 20);

            initialLocationSet = true;

        } else {

            const timeSinceLastInteraction = Date.now() - lastUserInteractionTime;

            if (timeSinceLastInteraction > AUTO_CENTER_THRESHOLD) {

                map.setView(e.latlng, map.getZoom());

            }

        }

        updateUserLocation(e);

    });


    function initializeMarkers(locations) {

        locations.forEach(location => {

            const markerIcon = createMarkerIcon(location);

            const marker = L.marker([location.lat, location.lng], { icon: markerIcon }).bindPopup(createPopupContent(location));

            markers.addLayer(marker);

        });

        map.addLayer(markers);

        updateLocationCounter();

    }


    var lastKnownLatLng = null;

    var currentLatLng = null;

    var closestLocation = null;

    let useHighAccuracy = false;


    function alphaBetaFilter(newMeasurement) {

        if (!lastEstimatedPos) {

            lastEstimatedPos = newMeasurement;

            return lastEstimatedPos;

        }


        const predictedPos = {

            lat: lastEstimatedPos.lat + lastEstimatedVel.lat,

            lng: lastEstimatedPos.lng + lastEstimatedVel.lng

        };


        const residual = {

            lat: newMeasurement.lat - predictedPos.lat,

            lng: newMeasurement.lng - predictedPos.lng

        };


        lastEstimatedPos.lat += alpha * residual.lat;

        lastEstimatedPos.lng += alpha * residual.lng;

        lastEstimatedVel.lat += beta * residual.lat;

        lastEstimatedVel.lng += beta * residual.lng;


        return lastEstimatedPos;

    }


    function updateUserLocation(e = null) {

        currentLatLng = e ? e.latlng : lastKnownLatLng;


        if (!currentLatLng) {

            return null;

        }


        const smoothedLatLng = alphaBetaFilter(currentLatLng);

        lastKnownLatLng = currentLatLng;


        updateLocationMarker(currentLatLng);


        if (!userInteracted) {

            map.setView(currentLatLng, map.getZoom());

        }


        let closestLocation = null;

        let closestDistance = Infinity;


        locations.forEach(location => {

            const locationLatLng = L.latLng(location.lat, location.lng);

            const distance = currentLatLng.distanceTo(locationLatLng);

            const distanceFeet = Math.round(distance * 3.28084);


            if (distanceFeet < closestDistance) {

                closestDistance = distanceFeet;

                closestLocation = location;

            }

        });


        updateDistanceBox(closestDistance);

        checkProximityAndTransition(closestDistance, closestLocation);


        return currentLatLng;

    }


    function updateDistanceBox(distance) {

        if (distance < 5280) {

            distanceBox.innerHTML = `Closest Marker: ${distance} feet`;

        } else if (distance === 5280) {

            distanceBox.innerHTML = `Closest Marker: 1.00 mile`;

        } else {

            const distanceMiles = (distance / 5280).toFixed(2);

            distanceBox.innerHTML = `Closest Marker: ${distanceMiles} miles`;

        }

    }


    function checkProximityAndTransition(distance, location) {

        const latLngId = location.lat + "," + location.lng;

        const lastTransitionTime = sessionStorage.getItem('lastTransitionTime');

        const lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');


        if (distance <= thresholdFeet) {

            const currentTime = Date.now();

            const cooldownActive = lastTransitionTime && (currentTime - lastTransitionTime < COOLDOWN);

            const isSameLocation = lastVisitedLocation === latLngId;


            if (cooldownActive && isSameLocation) {

                distanceBox.classList.add("within-cooldown");

                distanceBox.classList.remove("within-threshold");

                console.log("Cooldown active for this location. Transition blocked.");

            } else {

                distanceBox.classList.add("within-threshold");

                distanceBox.classList.remove("within-cooldown");

                console.log("Transition conditions met. Redirecting...");

                sessionStorage.setItem("lastTransitionTime", currentTime.toString());

                sessionStorage.setItem("lastVisitedLocation", latLngId);


                setTimeout(function() {

                    window.location.href = `location.html?id=${location.id}`;

                }, INITIAL_DELAY);

            }

        } else {

            distanceBox.classList.remove("within-threshold");

            distanceBox.classList.remove("within-cooldown");

        }

    }


    distanceBox.innerHTML = "Initializing ...";


    map.on("locationfound", updateUserLocation);


    function getUniqueTourTypes(locations) {

        const tourTypes = new Set();

        locations.forEach(location => {

            if (Array.isArray(location.tours)) {

                location.tours.forEach(tour => tourTypes.add(tour));

            } else if (typeof location.tour === 'string') {

                tourTypes.add(location.tour);

            }

        });

        return Array.from(tourTypes);

    }


    function createFilterCheckboxes(locations) {

        const filterOptions = document.getElementById('filter-options');

        const tourTypes = getUniqueTourTypes(locations);


        tourTypes.forEach(tourType => {

            const checkbox = document.createElement('input');

            checkbox.type = 'checkbox';

            checkbox.id = `filter-${tourType}`;

            checkbox.checked = true;

            checkbox.addEventListener('change', updateFilters);


            const label = document.createElement('label');

            label.htmlFor = `filter-${tourType}`;

            label.textContent = tourType;


            filterOptions.appendChild(checkbox);

            filterOptions.appendChild(label);

            filterOptions.appendChild(document.createElement('br'));

        });

    }


    function updateFilters() {

        const checkedFilters = Array.from(document.querySelectorAll('#filter-options input:checked')).map(checkbox => checkbox.id.replace('filter-', ''));


        markers.clearLayers();

        locations.forEach(location => {

            const shouldShow = Array.isArray(location.tours) 

                ? location.tours.some(tour => checkedFilters.includes(tour))

                : checkedFilters.includes(location.tour);


            if (shouldShow) {

                const markerIcon = createMarkerIcon(location);

                const marker = L.marker([location.lat, location.lng], { icon: markerIcon }).bindPopup(createPopupContent(location));

                markers.addLayer(marker);

            }

        });


        map.addLayer(markers);

        updateLocationCounter();

    }


    function updateLocationCounter() {

        const visibleLocations = markers.getLayers().length;

        document.getElementById('count').textContent = visibleLocations;

    }


    function createMarkerIcon(location) {

        const markerIconClasses = {

            "history": "blue-marker",

            "hamm": "orange-marker",

            "gangster": "green-marker",

            "split": "split-marker",

            "wbl_split": "wbl_split-marker",

            "lake": "purple-marker",

            "capitol": "burgundy-marker",

            "summit": "charcoal-marker",

            "northeast": "teal-marker",

            "default": "blue-marker"

        };


        const iconClass = markerIconClasses[location.tour] || markerIconClasses["default"];


        return L.divIcon({

            className: `custom-marker-icon ${iconClass}`,

            iconSize: [12, 12],

            iconAnchor: [6, 6],

            popupAnchor: [0, -16],

            html: `<span style="font-weight: bold; color: white; font-size: 14px;"></span>`

        });

    }


    function createPopupContent(location) {

        return `

            <div class="popup-content">

                <img src="${location.image}" alt="${location.name}">

                <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>

                <a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank" rel="noopener noreferrer">

                    <img src="/images/route_icon.png" alt="Google Maps" style="width: 40px; height: 40px; margin-bottom: -10px;">

                    <div style="margin-top: -10px; margin-bottom: -10px; color: black; font-size: 16px"><p class="dir">Directions</p></div>

                </a>

            </div>

        `;

    }


    let consolidatedInterval = setInterval(updateUserLocation, 8000);


    function onLocationError(e) {

        clearTimeout(locationTimeout);

        locationPopup.innerHTML = "Failed to access your location. Please make sure location services are enabled and try again.";

    }


    map.on("locationerror", onLocationError);


    let recenterTimeout;


    function recenterMap() {

        if (!userInteracted && userLocationMarker.getLatLng()) {

            map.setView(userLocationMarker.getLatLng(), 20);

        }

    }


    map.on("popupclose", function(event) {

        clearTimeout(recenterTimeout);

        recenterTimeout = setTimeout(() => {

            userInteracted = false;

            recenterMap();

        }, 25000);

    });


    map.on("popupopen", function(event) {

        clearTimeout(recenterTimeout);

    });


    map.locate({

        watch: true,

        enableHighAccuracy: true,

        maximumAge: 25000,

    });


    const recenterButton = document.getElementById("recenter-button");


    recenterButton.addEventListener("click", function () {

        if (userLocationMarker.getLatLng()) {

            const userLatLng = userLocationMarker.getLatLng();

            map.setView(userLatLng, 20);

            userInteracted = false;

            clearTimeout(recenterTimeout);

        } else {

            alert("User location not available. Please enable location services.");

        }

    });


    const exitButton = document.querySelector(".exit-button");


    exitButton.addEventListener("click", function () {

        sessionStorage.removeItem('lastTransitionTime');

        window.location.href = "/index.html";

    });


    document.getElementById('filter-button').addEventListener('click', function() {

        const filterPopup = document.getElementById('filter-popup');

        filterPopup.classList.toggle('hidden');

    });


    document.getElementById('close-filter').addEventListener('click', function() {

        document.getElementById('filter-popup').classList.add('hidden');

    });


    function updateLocationMarker(latlng) {

        userLocationMarker.setLatLng(latlng);

    }

});

    </script>

</body>

</html>
