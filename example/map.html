<!DOCTYPE html>
<html>
<head>
  <title>Minnesota Then</title>
  <link rel="shortcut icon" type="image/jpg" href="/images/mnthenfav.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" />
  <link rel="stylesheet" type="text/css" href="/css/map.css">
 </head>
<body>
  <div id="map"></div>
  <div id="distanceBox">Initializing ...</div>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-10 col-md-8 col-lg-6">
        <div class="info-box-container">
          <div class="info-box">
            <strong>Navigation Tips:</strong> Explore locations by moving towards map markers.
            Use the 'Exit the Tour' button below to end your tour.
          </div>
          <!-- Exit Button -->
          <button class="exit-button btn btn-primary">Exit the Tour</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script>

<script>

  document.addEventListener("DOMContentLoaded", function () {

    // Retrieve last visit time from session storage
    const lastVisit = sessionStorage.getItem('lastVisitTime');

    // Set your cooldown period in milliseconds
    const COOLDOWN = 20000; // 20 seconds

    const cacheBustCooldown = new Date().getTime();

    if (lastVisit && Date.now() - lastVisit < COOLDOWN) {
      // Apply cooldown logic
      console.log('Cooldown active');
    } else {
      // No cooldown
      console.log('No cooldown');
    }

    var lastTransitionTime = sessionStorage.getItem('lastTransitionTime_' + cacheBustCooldown);

    // Create the map without duplications
    var map = L.map("map", {
      attributionControl: false,
    }).setView([45.09396938812941, -92.99743282865592], 19);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      id: "mapbox/streets-v11",
      tileSize: 512,
      zoomOffset: -1,
    }).addTo(map);

    L.control.attribution({
      prefix: false,
    }).addTo(map);

    var userLocationMarker = L.circleMarker([0, 0], {
      color: "red",
      fillColor: "#f03",
      fillOpacity: 0.5,
      radius: 6,
    }).addTo(map);

    var thresholdFeet = 10;

    var INITIAL_DELAY = 2000; // 2 seconds
    var COOLDOWN_DELAY = 20000; // 20 seconds

    // Create a marker cluster group
    var markers = L.markerClusterGroup();

    // Generate a unique timestamp or version number
    var cacheBust = new Date().getTime(); // You can replace this with your own logic

    // Create the script element
    var script = document.createElement("script");

    // Append the cache-busting parameter to the script URL
    script.src = "/locations_1.js?v=" + cacheBust;

    script.addEventListener("load", function () {
      function updateUserLocation(e) {
        var userLatLng = e.latlng;
        userLocationMarker.setLatLng(userLatLng);
        map.setView(userLatLng);

        var closestDistance = Infinity;
        var closestLocation = null;

        // Clear existing markers
        markers.clearLayers();

        for (var i = 0; i < locations.length; i++) {
          var location = locations[i];
          var locationLatLng = L.latLng(location.lat, location.lng);

          var popupContent = `
            <div class="popup-content">
              <img src="${location.image}" alt="${location.name}">
              <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank" rel="noopener noreferrer">
                <img src="/images/route_icon.png" alt="Google Maps" style="width: 40px; height: 40px; margin-bottom: -10px;">
                <div style="margin-top: -10px; margin-bottom: -10px; color: black; font-size: 16px"><p class="dir">Directions</p></div>
              </a>
            </div>
          `;

          var marker = L.marker(locationLatLng).bindPopup(popupContent);

          // Add the marker to the cluster group
          markers.addLayer(marker);

          // Calculate the closest marker
          var distance = userLatLng.distanceTo(locationLatLng);
          var distanceFeet = Math.floor(distance * 3.28084);

          if (distanceFeet < closestDistance) {
            closestDistance = distanceFeet;
            closestLocation = location;
          }
        }

        var distanceBox = document.getElementById("distanceBox");
        distanceBox.innerHTML = "Closest Marker: " + closestDistance + " feet";

        if (closestDistance <= thresholdFeet) {
          distanceBox.classList.add("within-threshold");

          var currentTime = Date.now();

          if (lastTransitionTime === null || currentTime - lastTransitionTime > COOLDOWN_DELAY) {
            if (lastTransitionTime === null) {
              // Initial transition
              setTimeout(() => {
                sessionStorage.setItem('lastTransitionTime', performance.now());
                window.location.href = closestLocation.htmlFile;
              }, INITIAL_DELAY);
            } else {
              // Return transition
              setTimeout(() => {
                if (lastTransitionTime !== null) {
                  // Set lastTransitionTime to start cooldown only if it's not null
                  sessionStorage.setItem('lastTransitionTime', performance.now());
                }

                // Redirect to the map page after the cooldown period
                window.location.href = closestLocation.htmlFile;
              }, COOLDOWN_DELAY);
            }
          }
        } else {
          distanceBox.classList.remove("within-threshold");
        }
      }

      function onLocationError(e) {
        alert("Failed to access your location. Please make sure location services are enabled and try again.");
      }

      map.on("locationfound", updateUserLocation);
      map.on("locationerror", onLocationError);

      map.locate({
        watch: true,
        enableHighAccuracy: true,
        maximumAge: 0,
      });
    });

    document.body.appendChild(script);

    var exitButton = document.querySelector(".exit-button");
    exitButton.addEventListener("click", function () {
      sessionStorage.removeItem('lastTransitionTime');
      window.location.href = "index.html";
    });

    // Add the marker cluster group to the map
    map.addLayer(markers);
  });

</script>

</body>
</html>
