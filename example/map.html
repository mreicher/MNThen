<!DOCTYPE html>
<html>
<head>

    <title>Minnesota Then</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="An interactive map for self-guided Minnesota history tours and statewide museum exhibits">
    <meta name="theme-color" content="#000000">

    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" />
    <link rel="stylesheet" type="text/css" href="https://www.mnthen.com/css/map_page.css">

    <style>
        .blue-marker { background-color: blue; }
        .orange-marker { background-color: orange; }
        .green-marker { background-color: green; }
        .split-marker { background-color: purple; }
        .wbl_split-marker { background-color: red; }
        .lake-marker { background-color: cyan; }
        .capitol-marker { background-color: brown; }
        .summit-marker { background-color: gray; }
        .northeast-marker { background-color: teal; }

.custom-pin-icon {
    display: flex;
    justify-content: center;
    align-items: flex-start;
}

.pin-head {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%) rotate(-45deg);
    width: 20px;
    height: 20px;
    border-radius: 50% 50% 50% 0;
    border: 2px solid white;  /* Changed to white */
    box-shadow: 0 0 3px rgba(0,0,0,0.1);
}
        
        .leaflet-popup {
            transition: opacity 0.5s;
        }

        #distanceBox {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 18px;
            background: var(--light-bg-color);
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            border: 2px solid #ccc;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        #distanceBox.within-threshold {
            border: 2px solid green;
        }

        #distanceBox.within-cooldown {
            border: 2px solid orange;
        }

        .centered-icon {
            transition: all 0.3s ease-out;
        }
        
#explanation-popup {
    width: 95%; /* Default width */
}

@media only screen and (max-width: 768px) {
 #explanation-popup {
        width: 90%; /* Width for mobile devices */
    }
}

#explanation-popup h3 {
 font-size: 1.3rem;
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}

#explanation-popup h4 {
    font-size: 1.2rem;
    margin-top: 20px;
 margin-bottom: 10px;
}

#explanation-popup p {
    text-align: left;
    margin: 10px 0;
   -size: 1rem}

#explanation-popup ul.itinerary-list {
    list-style-type: none;
    padding-left: 0;
}

#explanation-popup ul.itinerary-list li {
    font-size: 1rem;
    margin: 8px 0;
    padding-left: 25px;
    position: relative;
}

#explanation-popup ul.itinerary-list li i.fas.fa-map-marker-alt {
    position: absolute;
    left: 0;
 top 2px;
    color: var(--primary-color);
}

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #fefefe;
            text-align: center;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .modal-text {
            font-size: 20px;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .modal-button {
            padding: 12px 24px;
            font-size: 18px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 12px;
            flex: 1;
            max-width: 45%;
        }

        #continueButton {
            background-color: #4CAF50;
        }

        #cancelButton {
            background-color: #f44336;
        }

        .modal-button:hover {
            opacity: 0.9;
        }


        #exit-icon {
            color: #333;
            font-size: 30px;
        }
        
        #exit-button button.exit-button {
            background-color: #F5F5F5; /* Set the button background color to white */
            height: 45px;
            border-radius: 20px;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            font-size: 1.125rem; /* Responsive font size */
            padding: 5px;
            border: 1px solid #717171;
        }

        #exit-button button.exit-button i {
            color: black; /* Set icon color to black (or any color you prefer) */
        }

        #recenter-button, #help-button {
            position: absolute;
            bottom: 10px;
            background-color: #F5F5F5;
            padding: 5px;
            border-radius: 50%;
            border: 1px solid #717171;
        }

        @media screen and (max-width: 600px) {
            .modal-content {
                margin: 15% auto;
                width: 85%;
            }

            .modal-text {
                font-size: 19px;
            }

            .modal-button {
                font-size: 16px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>

        <div id="recenter-button" class="leaflet-bar leaflet-control leaflet-control-custom">
            <i class="fas fa-crosshairs" id="recenter-icon"></i>
        </div>

        <div id="help-button" class="leaflet-bar leaflet-control leaflet-control-custom">
            <i class="fas fa-question-circle" id="help-icon"></i>
        </div>

        <div id="exit-button">
            <button class="exit-button"><i class="fas fa-sign-out-alt" id="exit-icon"></i>
        </button>
    </div>

    <div id="distanceBox">Initializing ...</div>

    <div id="explanation-popup" class="hidden">
        <h3>Navigation Tips</h3>
        <p>&#8226; Pinch, zoom, and glide across the map to uncover hidden gems.</p>
        <p>&#8226; Open popups to read articles or get directions to any location you want to learn more about.</p>
        <p>&#8226; Let the map re-align to your location, or tap the recenter button in the bottom-left corner.</p>
        <p>&#8226; Be within 20 feet of a marker to interact with the location.</p>
        <p>&#8226; Wait 90 seconds to revisit a previous location.</p>
        <button id="close-popup">Close</button>
    </div>

    <div id="forwardingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p class="modal-text">Get turn-by-turn directions to the location with Google Maps (opens in a new window). <br><br>Would you like to continue?</p>
            <div class="button-container">
                <button id="continueButton" class="modal-button">Continue</button>
                <button id="cancelButton" class="modal-button">Cancel</button>
            </div>
        </div>
    </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script> 
<script src="/locations_test.js?ts=091020241"></script>
    
<script>
let map, userLocationMarker, locationMarker;
let currentLocationIndex = 0;
let visitedLocations = [];
let gameLocations = [];
let isLocationHuntVisible = false;
let lastPosition = null;
let positionBuffer = [];
const bufferSize = 10;
const smoothingFactor = 0.15;
let filteredPosition = null;
const DISTANCE_THRESHOLD = 20; // feet
let lastUpdateTime = 0;
let velocity = { lat: 0, lng: 0 };
let isMapInteracting = false;
let closestDistance = Infinity;
let newMarkers = {};
let lastEstimatedPos = null;
let lastEstimatedVel = { lat: 0, lng: 0 };
let useHighAccuracy = true;
let followUser = true;
let watchId = null;

const INITIAL_DELAY = 2000; // 2 seconds
const COOLDOWN = 90000; // 90 seconds
const HIGH_ACCURACY_THRESHOLD = 1000; // Distance from marker map transitions to high accuracy
const AUTO_CENTER_THRESHOLD = 25000;  // 25 seconds
const thresholdFeet = 20; // 20 feet for triggering redirection based on proximity to a marker
const BROAD_CHECK_DISTANCE = 1320; // 1/4 mile in feet
const STATIONARY_THRESHOLD = 0.75; // feet per second
const UPDATE_INTERVAL = 1000; // 1 second between updates
const ANIMATION_DURATION = 500; // ms
const RECENTER_COOLDOWN = 1000; // 1 second cooldown between recenters
const SIGNIFICANT_MOVE_THRESHOLD = 0.0001; // Adjust based on your needs
const CENTER_THRESHOLD = 0.0001; // Example value
const PADDING_PERCENTAGE = 0.1; // 10% padding from edges
const CENTER_COOLDOWN = 1000; // 1 second cooldown between centering

document.addEventListener("DOMContentLoaded", function () {
    initializeApp();
});

function initializeApp() {
    setupUI();
    initMap();
    loadLocationData();
    setupEventListeners();
}

function setupUI() {
    const distanceBox = document.getElementById("distanceBox");
    if (!distanceBox) {
        console.error("Distance box element not found!");
        return;
    }
    distanceBox.innerHTML = "Initializing...";

    const locationPopup = document.createElement("div");
    locationPopup.id = "location-popup";
    locationPopup.innerHTML = "Locating user...";
    document.body.appendChild(locationPopup);

    setupLocationTimeout(locationPopup);
}

function setupLocationTimeout(locationPopup) {
    const locationTimeout = setTimeout(() => {
        locationPopup.innerHTML = `
            <div>
                <p>Still searching for your location...</p>
            </div>
        `;

        const extendedTimeout = setTimeout(() => {
            locationPopup.innerHTML = `
                <div>
                    <p>Unable to find your location. Please check your settings or try again.</p>
                </div>
            `;
        }, 10000);
    }, 15000);
}

function initMap() {
    map = L.map("map", {
        attributionControl: false,
        zoomControl: true,
        inertia: false,
    }).setView([45.09396938812941, -92.99743282865592], 19);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
        crossOrigin: true,
        useCache: true,
        maxRequests: 6
    }).addTo(map);

    L.control.attribution({ prefix: false }).addTo(map);

    userLocationMarker = L.circleMarker([0, 0], {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0.5,
        radius: 6,
    }).addTo(map);

    setupMarkerCluster();
}

function setupMarkerCluster() {
    const markers = L.markerClusterGroup({
        chunkedLoading: true,
        chunkInterval: 200,
        chunkDelay: 50,
        spiderfyOnMaxZoom: false,
        disableClusteringAtZoom: 18,
        maxClusterRadius: function(zoom) {
            return (zoom <= 15) ? 80 : 40;
        },
        iconCreateFunction: createClusterIcon
    });
    
    map.addLayer(markers);

    markers.on("clusterclick", function (e) {
        var childMarkers = e.layer.getAllChildMarkers();
        if (childMarkers.length > 0) {
            childMarkers[0].openPopup();
        }
    });
}

function createClusterIcon(cluster) {
    return L.divIcon({
        html: `<div style="
                    background-color: #006400; 
                    color: white;
                    border-radius: 50%;
                    width: 35px;
                    height: 35px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 16px;
                    font-weight: bold;
                ">
                    ${cluster.getChildCount()}
               </div>`,
        className: 'custom-cluster-icon',
        iconSize: L.point(35, 35)
    });
}

function loadLocationData() {
    loadScriptWithCacheBust();
}

function loadScriptWithCacheBust() {
    const cacheBust = Date.now();
    const script = document.createElement("script");

    if (!document.querySelector('[src^="/locations_test.js"]')) {
        script.src = `/locations_test.js?v=${cacheBust}`;
    }

    let scriptLoadTimeout;

    script.onload = function() {
        if (Array.isArray(locations) && locations.length) {
            console.log("Location data loaded successfully:", locations);
            startLocationTracking();
        } else {
            console.error("Location data is missing or empty:", locations);
            showPopup("Location data could not be loaded. Please refresh the page and try again.");
        }
        clearTimeout(scriptLoadTimeout);
    };

    script.onerror = function() {
        if (!scriptLoadTimeout) {
            scriptLoadTimeout = setTimeout(() => {
                console.error("Failed to load the script:", script.src);
                showPopup("Failed to load location data. Please check your internet connection and try again.");
            }, 15000);
        }
    };

    document.body.appendChild(script);
}

function setupEventListeners() {
    map.on("dragstart zoomstart", () => {
        isMapInteracting = true;
    });

    map.on("dragend zoomend", () => {
        isMapInteracting = false;
    });

    map.on("locationfound", onLocationFound);
    map.on("locationerror", onLocationError);

    document.getElementById('help-button').addEventListener('click', toggleExplanationPopup);
    document.getElementById('close-popup').addEventListener('click', closeExplanationPopup);
    document.getElementById("recenter-button").addEventListener("click", recenterMap);
    document.querySelector(".exit-button").addEventListener("click", exitToIndex);
}

function startLocationTracking() {
    if ("geolocation" in navigator) {
        const options = {
            enableHighAccuracy: useHighAccuracy,
            timeout: 10000,
            maximumAge: 0
        };

        watchId = navigator.geolocation.watchPosition(updateUserLocation, handleLocationError, options);
    } else {
        showPopup("Geolocation is not supported by your browser. Please use a modern browser with location services enabled.");
    }
}

function updateUserLocation(position) {
    const userLat = position.coords.latitude;
    const userLng = position.coords.longitude;
    
    if (isNaN(userLat) || isNaN(userLng)) {
        console.warn("Invalid position received:", position);
        return;
    }

    const newPosition = {
        lat: userLat,
        lng: userLng,
        timestamp: position.timestamp
    };

    const smoothedPosition = applyPositionFilters(newPosition);
    updateUserMarker(smoothedPosition);
    updateMapView(smoothedPosition);
    updateDistanceBox(smoothedPosition);
    checkLocationTransition(smoothedPosition);
}

function applyPositionFilters(newPosition) {
    positionBuffer.push(newPosition);
    if (positionBuffer.length > bufferSize) {
        positionBuffer.shift();
    }

    const averagePosition = calculateAveragePosition(positionBuffer);
    const kalmanFilteredPosition = applyKalmanFilter(averagePosition);
    const alphaBetaFilteredPosition = applyAlphaBetaFilter(kalmanFilteredPosition);
    return applyLowPassFilter(alphaBetaFilteredPosition);
}

function calculateAveragePosition(positions) {
    const sum = positions.reduce((acc, pos) => ({
        lat: acc.lat + pos.lat,
        lng: acc.lng + pos.lng
    }), { lat: 0, lng: 0 });

    return {
        lat: sum.lat / positions.length,
        lng: sum.lng / positions.length
    };
}

function applyKalmanFilter(position) {
    // Implement Kalman filter logic here if needed
    return position;
}

function applyAlphaBetaFilter(position) {
    if (!lastEstimatedPos) {
        lastEstimatedPos = { ...position };
        return lastEstimatedPos;
    }

    const { lat: lastLat, lng: lastLng } = lastEstimatedPos;
    const { lat: velLat, lng: velLng } = lastEstimatedVel;

    const predictedPos = {
        lat: lastLat + velLat,
        lng: lastLng + velLng
    };

    const residual = {
        lat: position.lat - predictedPos.lat,
        lng: position.lng - predictedPos.lng
    };

    lastEstimatedPos.lat += smoothingFactor * residual.lat;
    lastEstimatedPos.lng += smoothingFactor * residual.lng;
    lastEstimatedVel.lat += (smoothingFactor * smoothingFactor) * residual.lat;
    lastEstimatedVel.lng += (smoothingFactor * smoothingFactor) * residual.lng;

    return lastEstimatedPos;
}

function applyLowPassFilter(position) {
    if (!lastPosition) {
        lastPosition = position;
        return position;
    }

    const filteredPosition = {
        lat: lastPosition.lat + smoothingFactor * (position.lat - lastPosition.lat),
        lng: lastPosition.lng + smoothingFactor * (position.lng - lastPosition.lng)
    };

    lastPosition = filteredPosition;
    return filteredPosition;
}

function updateUserMarker(position) {
    userLocationMarker.setLatLng([position.lat, position.lng]);
}

function updateMapView(position) {
    if (!isMapInteracting && followUser) {
        map.panTo([position.lat, position.lng], { animate: true, duration: 0.5 });
    }
}

function updateDistanceBox(position) {
    const distanceBox = document.getElementById("distanceBox");
    if (!distanceBox) {
        console.error("Distance box element not found!");
        return;
    }

    if (gameLocations.length === 0) {
        distanceBox.innerHTML = "Loading locations...";
        return;
    }

    const closestLocation = findClosestLocation(position);
    const distanceFeet = calculateDistance(position, closestLocation);

    if (distanceFeet < 5280) {
        distanceBox.innerHTML = `Next Stop: ${Math.round(distanceFeet)} feet`;
    } else {
        const distanceMiles = (distanceFeet / 5280).toFixed(2);
        distanceBox.innerHTML = `Next Stop: ${distanceMiles} miles`;
    }

    if (distanceFeet <= DISTANCE_THRESHOLD && !isLocationHuntVisible) {
        showLocationHunt(closestLocation);
    }
}

function checkLocationTransition(position) {
    const closestLocation = findClosestLocation(position);
    const distanceFeet = calculateDistance(position, closestLocation);

    if (distanceFeet <= thresholdFeet) {
        handleLocationProximity(closestLocation);
    }
}

function findClosestLocation(position) {
    let closestLocation = null;
    let minDistance = Infinity;

    for (const location of gameLocations) {
        const distance = calculateDistance(position, location);
        if (distance < minDistance) {
            minDistance = distance;
            closestLocation = location;
        }
    }

    return closestLocation;
}

function calculateDistance(pos1, pos2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = pos1.lat * Math.PI / 180;
    const φ2 = pos2.lat * Math.PI / 180;
    const Δφ = (pos2.lat - pos1.lat) * Math.PI / 180;
    const Δλ = (pos2.lng - pos1.lng) * Math.PI / 180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    const distanceMeters = R * c;
    return distanceMeters * 3.28084; // Convert to feet
}

function handleLocationProximity(location) {
    const lastTransitionTime = parseInt(sessionStorage.getItem('lastTransitionTime') || '0');
    const lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');
    const timeSinceLastTransition = Date.now() - lastTransitionTime;
    
    if (timeSinceLastTransition >= COOLDOWN || lastVisitedLocation !== `${location.lat},${location.lng}`) {
        transitionToLocation(location);
    }
}

function transitionToLocation(location) {
    sessionStorage.setItem('lastTransitionTime', Date.now().toString());
    sessionStorage.setItem('lastVisitedLocation', `${location.lat},${location.lng}`);
    setTimeout(() => {
        window.location.href = `location.html?id=${location.id}`;
    }, INITIAL_DELAY);
}

function showLocationHunt(location) {
    isLocationHuntVisible = true;
    const lochuntContainer = document.querySelector('.lochunt-container');
    
    if (!lochuntContainer) {
        console.error("Location hunt container not found!");
        return;
    }

    lochuntContainer.innerHTML = createLocationHuntContent(location);
    lochuntContainer.style.display = 'flex';
    
    initAudioPlayer();
}

function createLocationHuntContent(location) {
    return `
        <img src="${location.image}" alt="${location.name}" style="width: 100%; height: 45vh; object-fit: cover; object-position: center;">
        <div class="lochunt-content" style="padding: 20px; display: flex; flex-direction: column; align-items: center;">
            <div class="lochunt-info" style="text-align: center; margin-bottom: 20px;">
                <h1 style="font-size: calc(1.5rem + 1.5vw); font-weight: bold; color: #333;">${location.name}</h1>
                <p style="font-size: calc(1rem + 0.5vw); font-style: italic; color: #666;">Created by: ${location.creator}</p>
            </div>
            <div class="audio-player" style="width: 100%; max-width: 400px; margin-bottom: 15px;">
                <audio id="locationAudio" src="${location.audio}"></audio>
                <div class="audio-progress" style="width: 100%; margin-bottom: 10px;">
                    <div class="progress" style="height: 6px; background-color: #d1d1d1; cursor: pointer;">
                        <div id="progressBar" class="progress-bar" style="background-color: var(--primary-color); width: 0%;"></div>
                    </div>
                </div>
                <div class="audio-time" style="display: flex; justify-content: space-between; font-size: 16px; color: #666; margin-bottom: 10px;">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="audio-controls" style="display: flex; justify-content: space-between; align-items: center; font-size: 24px;">
                    ${createAudioButton('skip-backward', 'rewindBtn')}
                    ${createAudioButton('play', 'playPauseBtn')}
                    ${createAudioButton('skip-forward', 'forwardBtn')}
                </div>
            </div>
        </div>
        <div style="width: 100%; height: 50px; background-color: #005f9e; margin-top: auto; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
            <button class="btn btn-link text-white fs-4 p-0" onclick="showInfoPopup('${location.imageSource}')">
                <i class="fa-regular fa-circle-question"></i>
            </button>
            <a href="mailto:mattreicher@protonmail.com?subject=Feedback" target="_blank" class="btn btn-link text-white text-decoration-none">
                <i class="fa-solid fa-message"></i>
            </a>
        </div>
        <div class="trivia-container" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); border: 2px solid var(--primary-color); width: 90%; max-width: 600px; z-index: 2001; font-size: 22px;">
            <h2 class="card-title text-center mb-4" id="triviaQuestion"></h2>
            <div id="triviaOptions" class="d-grid gap-2"></div>
        </div>
    `;
}

function createAudioButton(iconName, id) {
    return `
        <button id="${id}" class="audio-button" style="background-color: white; color: var(--primary-color); border: 2px solid var(--primary-color); border-radius: 50%; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
            <i class="bi bi-${iconName}"></i>
        </button>
    `;
}

function initAudioPlayer() {
    const audio = document.getElementById('locationAudio');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.querySelector('.progress');
    const currentTimeSpan = document.getElementById('currentTime');
    const durationSpan = document.getElementById('duration');

    if (!audio || !playPauseBtn || !rewindBtn || !forwardBtn || !progressBar || !progressContainer || !currentTimeSpan || !durationSpan) {
        console.error("One or more audio player elements not found!");
        return;
    }

    playPauseBtn.addEventListener('click', togglePlay);
    rewindBtn.addEventListener('click', () => seek(-10));
    forwardBtn.addEventListener('click', () => seek(10));
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', setDuration);
    audio.addEventListener('ended', handleAudioEnd);
    progressContainer.addEventListener('click', setProgress);

    function togglePlay() {
        if (audio.paused) {
            audio.play();
            playPauseBtn.innerHTML = '<i class="bi bi-pause"></i>';
        } else {
            audio.pause();
            playPauseBtn.innerHTML = '<i class="bi bi-play"></i>';
        }
    }

    function seek(seconds) {
        audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, audio.duration));
    }

    function updateProgress() {
        const percent = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = `${percent}%`;
        currentTimeSpan.textContent = formatTime(audio.currentTime);
    }

    function setProgress(e) {
        const width = this.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        audio.currentTime = (clickX / width) * duration;
    }

    function setDuration() {
        durationSpan.textContent = formatTime(audio.duration);
    }

    function handleAudioEnd() {
        playPauseBtn.innerHTML = '<i class="bi bi-play"></i>';
        showTriviaQuestion();
    }

    function formatTime(time) {
        const minutes = Math.floor(time / 60);
        const seconds = Math.floor(time % 60);
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
}

function showTriviaQuestion() {
    const triviaContainer = document.querySelector('.trivia-container');
    if (!triviaContainer) {
        console.error("Trivia container not found!");
        return;
    }

    const currentLocation = gameLocations[currentLocationIndex];
    if (!currentLocation || !currentLocation.trivia) {
        console.error("Current location or trivia not found!");
        return;
    }

    triviaContainer.style.display = 'block';
    document.getElementById('triviaQuestion').textContent = currentLocation.trivia.question;
    const optionsContainer = document.getElementById('triviaOptions');
    optionsContainer.innerHTML = '';
    currentLocation.trivia.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.textContent = option;
        button.classList.add('btn', 'btn-outline-primary', 'mb-2');
        button.onclick = () => checkAnswer(index);
        optionsContainer.appendChild(button);
    });
}

function checkAnswer(selectedIndex) {
    const currentLocation = gameLocations[currentLocationIndex];
    if (selectedIndex === currentLocation.trivia.answer) {
        showAlert('Correct! Moving to the next location.', 'success', () => {
            visitedLocations.push(currentLocationIndex);
            currentLocationIndex++;
            document.querySelector('.lochunt-container').style.display = 'none';
            document.querySelector('.trivia-container').style.display = 'none';
            isLocationHuntVisible = false;
            loadNextLocation();
        });
    } else {
        showAlert('Incorrect. Try again!', 'danger');
    }
}

function showAlert(message, type, callback) {
    const alertContainer = document.createElement('div');
    alertContainer.classList.add('position-fixed', 'top-50', 'start-50', 'translate-middle');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    document.body.appendChild(alertContainer);

    const alertElement = alertContainer.querySelector('.alert');
    const bsAlert = new bootstrap.Alert(alertElement);

    alertElement.addEventListener('closed.bs.alert', () => {
        alertContainer.remove();
        if (callback) callback();
    });

    setTimeout(() => {
        bsAlert.close();
    }, 3000);
}

function loadNextLocation() {
    if (currentLocationIndex < gameLocations.length) {
        const location = gameLocations[currentLocationIndex];
        createLocationMarker(location);
        updateDistanceBox(userLocationMarker.getLatLng());
    } else {
        showCongratulations();
    }
}

function createLocationMarker(location) {
    if (locationMarker) {
        map.removeLayer(locationMarker);
    }
    
    locationMarker = L.marker([location.lat, location.lng], {
        icon: L.divIcon({
            className: 'custom-pin-icon',
            html: '<div class="pin-head"></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        })
    }).addTo(map);

    const popupContent = createPopupContent(location);
    locationMarker.bindPopup(popupContent, {
        offset: L.point(0, -25),
        className: 'custom-popup'
    });

    locationMarker.on('popupopen', attachPopupEventListeners);
}

function createPopupContent(location) {
    return `
        <div class="popup-content">
            <img src="${location.image}" alt="${location.name}" class="location-image">
            <h4 class="location-name">${location.name}</h4>
            <div class="popup-buttons">
                <a href="#" class="button route-button" data-lat="${location.lat}" data-lng="${location.lng}" style="color:white;">Directions</a>
                <button class="button bypass-button">Bypass</button>
            </div>
        </div>
    `;
}

function attachPopupEventListeners() {
    const routeButton = document.querySelector('.route-button');
    const bypassButton = document.querySelector('.bypass-button');

    if (routeButton) {
        routeButton.addEventListener('click', handleRouteButtonClick);
    }

    if (bypassButton) {
        bypassButton.addEventListener('click', handleBypassButtonClick);
    }
}

function handleRouteButtonClick(e) {
    e.preventDefault();
    const lat = this.getAttribute('data-lat');
    const lng = this.getAttribute('data-lng');
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
}

function handleBypassButtonClick() {
    currentLocationIndex++;
    locationMarker.closePopup();
    loadNextLocation();
}

function showCongratulations() {
    showPopup("Congratulations! You've completed the entire tour!");
}

function onLocationFound(e) {
    console.log("Location found:", e);
    clearLocationPopup();
    updateUserLocation(e);
}

function clearLocationPopup() {
    const locationPopup = document.getElementById("location-popup");
    if (locationPopup) {
        locationPopup.innerHTML = "User found.";
        setTimeout(() => {
            locationPopup.style.display = "none";
        }, 2000);
    }
}

function handleLocationError(error) {
    console.warn("Error getting user location:", error);
    showPopup(`Unable to get your location: ${error.message}. Please ensure location services are enabled for the best experience.`);
}

function recenterMap() {
    if (userLocationMarker.getLatLng()) {
        map.setView(userLocationMarker.getLatLng(), 19);
        followUser = true;
    } else {
        showPopup("User location not available. Please enable location services.");
    }
}

function exitToIndex() {
    sessionStorage.removeItem('lastTransitionTime');
    window.location.href = "/index.html";
}

function toggleExplanationPopup() {
    const popup = document.getElementById('explanation-popup');
    if (popup) {
        popup.classList.toggle('hidden');
    }
}

function closeExplanationPopup(event) {
    event.stopPropagation();
    const popup = document.getElementById('explanation-popup');
    if (popup) {
        popup.classList.add('hidden');
    }
}

function showPopup(message, onConfirm = null) {
    const modal = createModal('Message', message, onConfirm);
    document.body.appendChild(modal);
}

function createModal(title, content, onConfirm = null) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>${title}</h2>
            <p>${content}</p>
            <button class="close-button">Close</button>
            ${onConfirm ? '<button class="confirm-button">Confirm</button>' : ''}
        </div>
    `;

    modal.querySelector('.close-button').addEventListener('click', () => document.body.removeChild(modal));
    
    if (onConfirm) {
        modal.querySelector('.confirm-button').addEventListener('click', () => {
            onConfirm();
            document.body.removeChild(modal);
        });
    }

    return modal;
}

// Add the modal HTML to your document's body
document.body.insertAdjacentHTML('beforeend', `
    <div id="forwardingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p style="font-size: 20px">You will be redirected to Google Maps in a new window for directions. Do you want to continue?</p>
            <div class="button-container">
                <button id="continueButton">Continue</button>
                <button id="cancelButton">Cancel</button>
            </div>
        </div>
    </div>
`);

// Setup modal event listeners
document.getElementById('forwardingModal').addEventListener('click', (event) => {
    if (event.target.id === 'forwardingModal') {
        closeForwardingModal();
    }
});

document.querySelector('#forwardingModal .close').addEventListener('click', closeForwardingModal);
document.getElementById('cancelButton').addEventListener('click', closeForwardingModal);
document.getElementById('continueButton').addEventListener('click', handleContinueButtonClick);

function closeForwardingModal() {
    document.getElementById('forwardingModal').style.display = 'none';
    recenterAndClosePopup();
}

function handleContinueButtonClick() {
    const lat = this.getAttribute('data-lat');
    const lng = this.getAttribute('data-lng');
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
    closeForwardingModal();
}

function recenterAndClosePopup() {
    if (userLocationMarker.getLatLng()) {
        map.setView(userLocationMarker.getLatLng(), 19);
        map.closePopup();
        isMapInteracting = false;
    }
}

// Initialize the app
initializeApp();
</script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0M8KR45LDB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date());
        gtag('config', 'G-0M8KR45LDB');
    </script>
    </body> 
</html>
