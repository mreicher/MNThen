<!DOCTYPE html> 
<html> 
    <head> 

  <title>Minnesota Then</title> 
        
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <meta charset="UTF-8"> 
  <meta name="description" content="An interactive map for self-guided Minnesota history tours"> 

<link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" /> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.css" /> 

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.css" /> 
  
    <link rel="stylesheet" type="text/css" href="https://www.mnthen.com/css/map_page.css"> 

        <style>
#distanceBox {
    position: absolute;
    top: 10px; /* Adjust to move it further from or closer to the top edge */
    right: 10px; /* Adjust to move it further from or closer to the right edge */
    padding: 10px 20px; /* Increased padding for better spacing */
    background: var(--light-bg-color);
    border-radius: 12px; /* Slightly more rounded corners */
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.010); /* Enhanced shadow for depth */
    font-size: 18px; /* Adjusted font size for balance */
    font-weight: 600;
    color: var(--text-color);
    border: 2px solid red; /* Red border */
    z-index: 999;
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions */
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 2.5%;
    top: 2.5%;
    width: 95%;
    height: 95%;
    background-color: rgba(0,0,0,0.4);
}

.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 100%;
    height: 100%;
    max-width: 600px;
    max-height: 800px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.modal-image {
    width: 100%;
    height: 33%;
    object-fit: cover;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}

.modal-text {
    padding: 20px;
    overflow-y: auto;
}

.modal-name {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
}

#close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    color: #fff;
    background-color: rgba(0,0,0,0.5);
    border: none;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
}
        </style>
    </head> 
<body> 

    <div id="map-container"> 
    <div id="map"></div> 

    <div id="recenter-button" class="leaflet-bar leaflet-control leaflet-control-custom"> 
      <i class="fas fa-crosshairs" id="recenter-icon"></i> 
    </div> 

        <div id="help-button" class="leaflet-bar leaflet-control leaflet-control-custom"> 
        <i class="fas fa-question-circle" id="help-icon"></i> 
  </div> 
  </div> 

  <div id="distanceBox">Initializing ...</div> 

  <div id="explanation-popup" class="hidden"> 

    <h3>App Features</h3> 

      <p>&#8226; Pinch, zoom, and glide across the map to uncover hidden gems.</p> 

      <p>&#8226; Different color markers denote which local tour(s) the location is part of.</p> 

      <p>&#8226; Follow the map to get in range of markers. The app will automatically open a location page to tell you about the history of the site. There's a cooldown mechanism to prevent immediate redirects.</p> 

      <p>&#8226; Open popups to read articles or get directions to any location you wish to visit - or simply want to learn more about.</p> 

      <p>&#8226; Let the map re-align to your location, or tap the recenter button in the bottom-left corner.</p> 

    <button id="close-popup">Close</button> 

</div> 

<!-- this will open when users are within proximity of location. Should pop from the locations array -->
<div id="location-modal" class="modal">
    <div id="modal-content" class="modal-content">
        <!-- Content will be dynamically inserted here -->
    </div>
    <button id="close-modal">&times;</button>
</div>

  <div class="container"> 

    <div class="row justify-content-center"> 

      <div class="col-10 col-md-8 col-lg-6"> 

        <div class="info-box-container"> 

          <div class="info-box"> 

            <strong>Navigation Tips:</strong> After exploring a location, wait 90 seconds to revisit. Ready to end your journey? Please exit below. 

          </div> 
          <!-- Exit Button --> 
          <button class="exit-button btn btn-primary">Exit Map</button> 

        </div> 
      </div> 
    </div> 
  </div> 

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.js"></script> 
<script src="/locations_1.js?ts=070420242"></script>
    
<script> 
var closestDistance = Infinity;
var newMarkers = {};

const alpha = 0.4;
const beta = 0.02;
var lastEstimatedPos = null;
var lastEstimatedVel = { lat: 0, lng: 0 };

document.addEventListener("DOMContentLoaded", function () {
    const distanceBox = document.getElementById("distanceBox");
    const locationPopup = document.createElement("div");
    locationPopup.id = "location-popup";
    locationPopup.innerHTML = "Locating user...";
    document.body.appendChild(locationPopup);

    const locationTimeout = setTimeout(() => {
        locationPopup.innerHTML = "Location not found. Please try again.";
    }, 10000);

    const INITIAL_DELAY = 2000;
    const COOLDOWN = 90000;
    const HIGH_ACCURACY_THRESHOLD = 1000;
    const AUTO_CENTER_THRESHOLD = 25000;
    const thresholdFeet = 20;
    
    var lastTransitionTime = sessionStorage.getItem('lastTransitionTime');
    var lastVisitedLocation = sessionStorage.getItem('lastVisitedLocation');

    if (lastTransitionTime && Date.now() - lastTransitionTime < COOLDOWN) {
        console.log('Cooldown active');
    } else {
        console.log('No cooldown');
    }

    var map = L.map("map", {
        attributionControl: false,
        inertia: false,
    }).setView([45.09396938812941, -92.99743282865592], 20);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 20,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
    }).addTo(map);

    L.control.attribution({ prefix: false }).addTo(map);

    var userLocationMarker = L.circleMarker([0, 0], {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0.5,
        radius: 6,
    }).addTo(map);

    var userInteracted = false;

    map.on("dragstart zoomstart", function() {
        userInteracted = true;
    });

    document.addEventListener("visibilitychange", function() {
        if (!document.hidden) {
            userInteracted = false;
        }
    });

    var markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: false
    });

    map.addLayer(markers);

    markers.on("clusterclick", function (e) {
        var childMarkers = e.layer.getAllChildMarkers();
        if (childMarkers.length > 0) {
            childMarkers[0].openPopup();
        }
    });

    function loadScriptWithCacheBust() {
        const cacheBust = Date.now();
        const script = document.createElement("script");

        if (!document.querySelector('[src^="/locations_1.js"]')) {
            script.src = `/locations_1.js?v=${cacheBust}`;
            document.body.appendChild(script);
        }

        script.onload = function() {
            if (Array.isArray(locations) && locations.length) {
                console.log("Location data loaded successfully:", locations);
                map.locate({ setView: false, maxZoom: 20 });
                initializeMarkers();
            } else {
                console.error("Location data is missing or empty:", locations);
            }
        };

        script.onerror = function() {
            console.error("Failed to load the script:", script.src);
        };

        document.body.appendChild(script);
    }

    loadScriptWithCacheBust();

    var initialLocationSet = false;
    var lastUserInteractionTime = 0;

    map.on("dragstart zoomstart", function() {
        lastUserInteractionTime = Date.now();
    });
  
    map.on("locationfound", function (e) {
        console.log("Location found:", e);
        clearTimeout(locationTimeout);
        locationPopup.innerHTML = "User found.";
        setTimeout(() => {
            locationPopup.style.display = "none";
        }, 2000);

        if (!initialLocationSet) {
            map.setView(e.latlng, 20);
            initialLocationSet = true;
        } else {
            const timeSinceLastInteraction = Date.now() - lastUserInteractionTime;
            if (timeSinceLastInteraction > AUTO_CENTER_THRESHOLD) {
                map.setView(e.latlng, map.getZoom());
            }
        }
    });

    const locationModal = document.getElementById("location-modal");
    const modalContent = document.getElementById("modal-content");
    const closeModalButton = document.getElementById("close-modal");

    closeModalButton.addEventListener("click", () => {
        locationModal.classList.remove("active");
    });

function initializeMarkers() {
    for (let i = 0; i < locations.length; i++) {
        const location = locations[i];
        const locationLatLng = L.latLng(location.lat, location.lng);

        var marker = L.marker(locationLatLng).bindPopup(`
            <div class="popup-content">
                <h4>${location.name}</h4>
                <button class="show-modal" data-name="${location.name}" data-description="${location.description}" data-image="${location.image}">Show Details</button>
            </div>
        `);

        markers.addLayer(marker);
    }

    map.addLayer(markers);

    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('show-modal')) {
            const name = event.target.getAttribute('data-name');
            const description = event.target.getAttribute('data-description');
            const image = event.target.getAttribute('data-image');
            
            modalContent.innerHTML = `
                <img src="${image}" alt="${name}" class="modal-image">
                <div class="modal-text">
                    <h2 class="modal-name">${name}</h2>
                    <p>${description}</p>
                </div>
                <button id="close-modal">&times;</button>
            `;
            locationModal.classList.add("active");

            // Add this event listener after setting the modal content
            document.getElementById('close-modal').addEventListener('click', function() {
                locationModal.classList.remove("active");
            });
        }
    });
}

    var currentMarkers = {};

    var lastKnownLatLng = null;
    var currentLatLng = null;
    var closestLocation = null;
    let useHighAccuracy = false;

    function alphaBetaFilter(newMeasurement) {
        if (!lastEstimatedPos) {
            lastEstimatedPos = newMeasurement;
            return lastEstimatedPos;
        }

        const predictedPos = {
            lat: lastEstimatedPos.lat + lastEstimatedVel.lat,
            lng: lastEstimatedPos.lng + lastEstimatedVel.lng
        };

        const residual = {
            lat: newMeasurement.lat - predictedPos.lat,
            lng: newMeasurement.lng - predictedPos.lng
        };

        lastEstimatedPos.lat += alpha * residual.lat;
        lastEstimatedPos.lng += alpha * residual.lng;
        lastEstimatedVel.lat += beta * residual.lat;
        lastEstimatedVel.lng += beta * residual.lng;

        return lastEstimatedPos;
    }

    function updateUserLocation(e = null) {
        console.log('updateUserLocation called with', e);

        currentLatLng = e ? e.latlng : lastKnownLatLng;

        console.log('Set currentLatLng to:', currentLatLng);

        if (!currentLatLng) {
            return null;
        }

        const smoothedLatLng = alphaBetaFilter(currentLatLng);
        console.log('Smoothed currentLatLng:', smoothedLatLng);

        lastKnownLatLng = currentLatLng;
        userLocationMarker.setLatLng(currentLatLng);

        if (!userInteracted) {
            map.setView(currentLatLng, map.getZoom());
        }

        let closestLocation = null;
        let closestDistance = Infinity;

        for (let i = 0; i < locations.length; i++) {
            const location = locations[i];
            const locationLatLng = L.latLng(location.lat, location.lng);
            const distance = currentLatLng.distanceTo(locationLatLng);
            const distanceFeet = Math.round(distance * 3.28084);

            if (distanceFeet < closestDistance) {
                closestDistance = distanceFeet;
                closestLocation = location;
            }
        }

        const distanceBox = document.getElementById("distanceBox");

        if (closestDistance < 5280) {
            distanceBox.innerHTML = `Closest Marker: ${closestDistance} feet`;
        } else if (closestDistance === 5280) {
            distanceBox.innerHTML = `Closest Marker: 1.00 mile`;
        } else {
            const distanceMiles = (closestDistance / 5280).toFixed(2);
            distanceBox.innerHTML = `Closest Marker: ${distanceMiles} miles`;
        }

        const latLngId = closestLocation.lat + "," + closestLocation.lng;

        const cooldownActiveForLastLocation = lastVisitedLocation === latLngId && (Date.now() - lastTransitionTime) < COOLDOWN;

        if (closestDistance <= thresholdFeet) {
            if (cooldownActiveForLastLocation) {
                distanceBox.classList.add("within-cooldown");
                distanceBox.classList.remove("within-threshold");
                console.log("Cooldown active for this location. Modal opening blocked.");
            } else {
                distanceBox.classList.add("within-threshold");
                distanceBox.classList.remove("within-cooldown");
                console.log("Transition conditions met. Opening modal...");
                sessionStorage.setItem("lastTransitionTime", Date.now());
                sessionStorage.setItem("lastVisitedLocation", latLngId);

setTimeout(function() {
    modalContent.innerHTML = `
        <img src="${closestLocation.image}" alt="${closestLocation.name}" class="modal-image">
        <div class="modal-text">
            <h2 class="modal-name">${closestLocation.name}</h2>
            <p>${closestLocation.description}</p>
        </div>
        <button id="close-modal">&times;</button>
    `;
    locationModal.classList.add("active");

    // Add this event listener after setting the modal content
    document.getElementById('close-modal').addEventListener('click', function() {
        locationModal.classList.remove("active");
    });
}, INITIAL_DELAY);
            }
        } else {
            distanceBox.classList.remove("within-threshold");
        }

        if (closestDistance <= HIGH_ACCURACY_THRESHOLD && !useHighAccuracy) {
            useHighAccuracy = true;
            map.stopLocate();
            map.locate({
                watch: true,
                enableHighAccuracy: useHighAccuracy,
                maximumAge: 25000,
            });
        } else if (closestDistance > HIGH_ACCURACY_THRESHOLD && useHighAccuracy) {
            useHighAccuracy = false;
            map.stopLocate();
            map.locate({
                watch: true,
                enableHighAccuracy: useHighAccuracy,
                maximumAge: 25000,
            });
        }

        return currentLatLng;
    }

    distanceBox.innerHTML = "Initializing ...";

    map.on("locationfound", updateUserLocation);

    for (let i = 0; i < locations.length; i++) {
        const location = locations[i];
        const locationLatLng = L.latLng(location.lat, location.lng);
        const markerId = location.lat + ',' + location.lng;

        const markerIconClasses = {
            "history": "blue-marker",
            "hamm": "orange-marker",
            "gangster": "green-marker",
            "split": "split-marker",
            "wbl_split": "wbl_split-marker",
            "lake": "purple-marker",
            "capitol": "burgundy-marker",
            "summit": "charcoal-marker",
            "northeast": "teal-marker",
            "default": "blue-marker"
        };
        const iconClass = markerIconClasses[location.tour] || markerIconClasses["default"];
        
        markers.clearLayers();

        for (let i = 0; i < locations.length; i++) {
            const location = locations[i];
            const locationLatLng = L.latLng(location.lat, location.lng);
            const markerId = location.lat + ',' + location.lng;

            const iconClass = markerIconClasses[location.tour] || markerIconClasses["default"];
            
            var popupContent = `
                <div class="popup-content">
                    <img src="${location.image}" alt="${location.name}">
                    <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank" rel="noopener noreferrer">
                        <img src="/images/route_icon.png" alt="Google Maps" style="width: 40px; height: 40px; margin-bottom: -10px;">
                        <div style="margin-top: -10px; margin-bottom: -10px; color: black; font-size: 16px"><p class="dir">Directions</p></div>
                    </a>
                </div>
            `;

            const markerIcon = L.divIcon({
                className: `custom-marker-icon ${iconClass}`,
                iconSize: [12, 12],
                iconAnchor: [6, 6],
                popupAnchor: [0, -16],
                html: `<span style="font-weight: bold; color: white; font-size: 14px;"></span>`
            });

            var marker = L.marker(locationLatLng, { icon: markerIcon }).bindPopup(popupContent);

            if (!currentMarkers[markerId]) {
                newMarkers[markerId] = marker;
                markers.addLayer(marker);
            } else {
                newMarkers[markerId] = currentMarkers[markerId];
            }
        }
    }

    map.addLayer(markers);

    currentMarkers = newMarkers;

    let consolidatedInterval = setInterval(function() {
        var currentTime = Date.now();
        updateUserLocation();
    }, 8000);

    function onLocationError(e) {
        clearTimeout(locationTimeout);
        locationPopup.innerHTML = "Failed to access your location. Please make sure location services are enabled and try again.";
    }

    map.on("locationerror", onLocationError);

    let recenterTimeout;

    function recenterMap() {
        if (!userInteracted && userLocationMarker.getLatLng()) {
            map.setView(userLocationMarker.getLatLng(), 20);
        }
    }

    map.on("popupclose", function(event) {
        clearTimeout(recenterTimeout);
        recenterTimeout = setTimeout(() => {
            userInteracted = false;
            recenterMap();
        }, 25000);
    });

    map.on("popupopen", function(event) {
        clearTimeout(recenterTimeout);
    });

    map.locate({
        watch: true,
        enableHighAccuracy: true,
        maximumAge: 25000,
    });

    const questionBtn = document.getElementById('help-button');
    const popup = document.getElementById('explanation-popup');

    questionBtn.addEventListener('click', () => {
        popup.classList.toggle('hidden');
    });

    const closeBtn = document.getElementById('close-popup');

    closeBtn.addEventListener('touchstart', closePopup);
    closeBtn.addEventListener('click', closePopup);

    function closePopup(event) {
        event.stopPropagation();
        popup.classList.add('hidden');
    }

    const recenterButton = document.getElementById("recenter-button");

  recenterButton.addEventListener("click", function () {
        if (userLocationMarker.getLatLng()) {
            const userLatLng = userLocationMarker.getLatLng();
            map.setView(userLatLng, 20);
            userInteracted = false;
            clearTimeout(recenterTimeout);
        } else {
            alert("User location not available. Please enable location services.");
        }
    });

    var exitButton = document.querySelector(".exit-button");

    exitButton.addEventListener("click", function () {
        sessionStorage.removeItem('lastTransitionTime');
        window.location.href = "/index.html";
    });
});
</script>
    </body> 
</html>
