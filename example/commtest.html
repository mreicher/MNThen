<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then | Crowd Source History Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://www.mnthen.com/css/new_header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="/css/new_header.css">

    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            color: #333;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 30px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.025);
            background-color: rgba(25, 25, 25, 0.95)!important;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #fff !important;
        }

        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: #fff !important;
        }

        .search-container {
            background-color: #f8f9fa;
            padding: 20px 0;
            border-bottom: 1px solid #e9ecef;
            margin-top: 75px;
        }

        .form-control {
            border-radius: 20px 0 0 20px;
            border: 1px solid #ced4da;
        }

        .btn-primary {
            background-color: #1a5f7a;
            border-color: #1a5f7a;
            border-radius: 0 20px 20px 0;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #134b61;
            border-color: #134b61;
        }

        #map {
            width: 100%;
            height: calc(100vh - 180px);
            margin-top: 0;
            margin-bottom: 60px;
        }
        
        #sidebar {
            position: absolute;
            display: block;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            max-height: 100vh; 
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.025);
            overflow-y: auto;
            padding: 20px;
            transition: transform 0.3s ease;
            transform: translateX(100%);
            z-index: 1000;
        }

        #sidebar.active {
            transform: translateX(0);
        }

        .sidebar-content {
            padding: 20px;
        }

        .location-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.025);
        }

        .comment {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #134b61;
            color: white;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        .bottom-bar-btn {
            color: rgba(255,255,255,0.8);
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .bottom-bar-btn:hover {
            color: #fff;
            background-color: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .modal-content {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            background-color: #1a5f7a;
            color: #fff;
            border-radius: 8px 8px 0 0;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            color: #fff;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .map-container {
            height: calc(100vh - 180px);
        }

        @media (max-width: 768px) {
            .bottom-bar {
                padding: 5px 0;
            }

            .bottom-bar-btn {
                font-size: 0.8rem;
                padding: 3px 6px;
            }

            .map-container {
                height: calc(100vh - 220px);
            }
        }

        .bottom-bar-btn::before {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-right: 5px;
        }

        #aboutUsBtn::before {
            content: '\f05a';
        }

        #homeBtn::before {
            content: '\f015';
        }

        #resetMapBtn::before {
            content: '\f0e2';
        }

        #instructionsBtn::before {
            content: '\f46d';
        }

        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
            }
            
            .search-container .col-md-4 {
                width: 100%;
            }
        }

        #sidebar::-webkit-scrollbar {
            width: 8px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .form-control:focus {
            border-color: #1a5f7a;
            box-shadow: 0 0 0 0.2rem rgba(26, 95, 122, 0.25);
        }

        .location-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
        }

        .location-card h2 {
            color: #1a5f7a;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .btn {
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .custom-marker {
            background-color: #1a5f7a;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: scale(0.9);
        }

        .modal.show .modal-dialog {
            transform: scale(1);
        }

        #timeline {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 25px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        #timelineSlider {
            width: 100%;
            margin: 0 10px;
        }

        #yearDisplay {
            font-weight: bold;
            margin-left: 10px;
        }

        .heatmap-toggle {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #tourGuide {
            position: fixed;
            bottom: 50px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }

        #tourGuide h3 {
            margin-top: 0;
        }

        #tourGuide button {
            margin-top: 10px;
        }

        .achievement {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .achievement-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .achievement-info {
            flex-grow: 1;
        }

        .achievement-progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .achievement-bar {
            height: 100%;
            background-color: #1a5f7a;
        }

        #categoryFilter {
            position: absolute;
            top: 80px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .story-container {
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .read-more {
            color: #1a5f7a;
            cursor: pointer;
        }

        .collaborative-edit {
            margin-top: 10px;
        }

        .edit-history {
            margin-top: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Header section -->
    <header>
        <nav class="navbar">
            <div class="navbar-brand">
                <a href="/index.html">Minnesota Then</a>
            </div>
            <a href="#" class="toggle-button">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </a>
            <div class="navbar-links">
                <ul>
                    <li><a href="/blog.html" class="px-1">Blog</a></li>
                    <li><a href="/faq.html" class="px-1">Help Center</a></li>
                    <li class="dropdown">
                        <a href="#" class="px-1 dropdown-toggle">Sponsor Us</a>
                        <div class="dropdown-menu">
                            <div class="container">
                                <a href="/donate.html" class="dropdown-item">
                                    <h5>Make a Donation</h5>
                                </a>
                                <hr class="centered-hr">
                                <a href="#" class="dropdown-item">
                                    <h5>Join our Patreon</h5>
                                </a>
                                <hr class="centered-hr">
                                <a href="#" class="dropdown-item">
                                    <h5>Shop our Online Store</h5>
                                </a>
                            </div>
                        </div>
                    </li>
                    <li><a href="/upcoming_events.html" class="px-1">Upcoming Events</a></li>
                    <li><a href="#" class="donate-btn rounded-pill px-3" id="account-link">
                        <i class="fas fa-user"></i>
                        <span>Log In <span>|</span> Register</span>
                    </a></li>
                </ul>
            </div>
        </nav>
    </header>
    
    <div class="search-container">
        <div class="container">
            <div class="row justify-content-center align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Enter a city in Minnesota">
                        <button class="btn btn-primary" type="button" id="searchButton">Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div  class="map-container">
        <div id="map"></div>
        <div id="sidebar" class="d-none">
            <button id="closeSidebar" class="close-btn">&times;</button>
            <div id="sidebarContent"></div>
        </div>
        <div class="heatmap-toggle">
            <input type="checkbox" id="heatmapToggle">
            <label for="heatmapToggle">Show Heatmap</label>
        </div>
        <div id="categoryFilter">
            <select id="categorySelect" class="form-select">
                <option value="">All Categories</option>
                <option value="landmark">Landmark</option>
                <option value="event">Historical Event</option>
                <option value="person">Notable Person</option>
                <option value="culture">Cultural Heritage</option>
            </select>
        </div>
        <div id="timeline">
            <span id="startYear">1800</span>
            <input type="range" id="timelineSlider" min="1800" max="2023" value="2023">
            <span id="endYear">2023</span>
            <span id="yearDisplay">2023</span>
        </div>
    </div>

    <div id="tourGuide" style="display: none;">
        <h3>Welcome to Minnesota Then!</h3>
        <p id="tourStep"></p>
        <button id="nextStep" class="btn btn-primary">Next</button>
        <button id="skipTour" class="btn btn-secondary">Skip Tour</button>
    </div>

    <div class="bottom-bar">
        <div class="container h-100">
            <div class="row h-100 align-items-center">
                <div class="col-3 text-start">
                    <button class="bottom-bar-btn" id="aboutUsBtn">About Us</button>
                </div>
                <div class="col-3 text-center">
                    <button class="bottom-bar-btn" id="instructionsBtn">Instructions</button>
                </div>
                <div class="col-3 text-center">
                    <button class="bottom-bar-btn" id="homeBtn">Home</button>
                </div>
                <div class="col-3 text-end">
                    <button class="bottom-bar-btn" id="resetMapBtn">Reset Map</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="registerFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="registerLastName" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Info Modal -->
    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Add Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm">
                        <div class="mb-3">
                            <label for="locationName" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="locationName" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationCategory" class="form-label">Category</label>
                            <select class="form-select" id="locationCategory" required>
                                <option value="">Select a category</option>
                                <option value="landmark">Landmark</option>
                                <option value="event">Historical Event</option>
                                <option value="person">Notable Person</option>
                                <option value="culture">Cultural Heritage</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="locationDescription" class="form-label">Historical or Cultural Significance</label>
                            <textarea class="form-control" id="locationDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="locationImage" class="form-label">Upload Image (max 75KB)</label>
                            <input type="file" class="form-control" id="locationImage" accept="image/*">
                            <div id="imageError" class="text-danger"></div>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" id="imageInfoBtn">Image Size Info</button>
                        </div>
                        <div class="mb-3">
                            <label for="imageYear" class="form-label">Year Image Taken</label>
                            <input type="number" class="form-control" id="imageYear" min="1800" max="2099" step="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationStory" class="form-label">Short Story or Fact</label>
                            <textarea class="form-control" id="locationStory" rows="3"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="allowUseInArticles">
                            <label class="form-check-label" for="allowUseInArticles">Allow this information to be used in future Minnesota Then articles</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Location</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- About Us Modal -->
    <div class="modal fade" id="aboutUsModal" tabindex="-1" aria-labelledby="aboutUsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutUsModalLabel">About Cultural Heritage Mapping Platform</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Welcome to the Minnesota Then History Mapping Platform! This interactive map allows users to:</p>
                    <ul>
                        <li>Map historically significant locations in Minnesota</li>
                        <li>Submit information about these locations (text, images, stories)</li>
                        <li>View and explore mapped data interactively</li>
                        <li>Collaborate on historical information</li>
                        <li>Engage with local history through comments and likes</li>
                    </ul>
                    <p>To get started, register an account or log in if you already have one. Then, click on the map to add a new location!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="instructionsModalLabel">How to Use the Platform</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ol>
                        <li>Register an account or log in if you already have one.</li>
                        <li>Use the search bar to find a specific city in Minnesota, or explore the map manually.</li>
                        <li>Click on the map to add a location that holds cultural or historical significance to you or your community.</li>
                        <li>Fill in the details about the location, including its name, description, and an image.</li>
                        <li>View existing locations by clicking on their markers on the map.</li>
                        <li>Like locations and leave comments to engage with other users' contributions.</li>
                        <li>Use the timeline slider to filter locations by year.</li>
                        <li>Toggle the heatmap to see popular areas.</li>
                        <li>Use the category filter to focus on specific types of historical points.</li>
                        <li>Collaborate on location information by suggesting edits or additions.</li>
                        <li>Use the bottom navigation bar to access additional features and reset the map view.</li>
                    </ol>
                    <p>Remember to respect copyright and privacy when adding information and images to the platform.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Info Modal -->
    <div class="modal fade" id="imageInfoModal" tabindex="-1" aria-labelledby="imageInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageInfoModalLabel">Image Size Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>To reduce image size, you can use these free online tools:</p>
                    <ul>
                        <li><a href="https://tinypng.com/" target="_blank">TinyPNG</a> - Compresses PNG and JPEG images</li>
                        <li><a href="https://squoosh.app/" target="_blank">Squoosh</a> - Advanced image compression tool</li>
                    </ul>
                    <p>Remember to keep your image size under 75KB for optimal performance.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">User Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="profileModalBody">
                    <!-- Profile content will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig); 
        const auth = firebase.auth();
        const database = firebase.database();

        // Initialize map
        const map = L.map('map', { zoomControl: false }).setView([44.7696, -94.6859], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        // Initialize marker cluster group
        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        // Initialize heatmap layer
        let heatmapLayer = L.heatLayer([], { radius: 25 }).addTo(map);

        // DOM elements
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const locationForm = document.getElementById('locationForm');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const sidebarContent = document.getElementById('sidebarContent');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const accountLink = document.getElementById('account-link');
        const aboutUsBtn = document.getElementById('aboutUsBtn');
        const instructionsBtn = document.getElementById('instructionsBtn');
        const homeBtn = document.getElementById('homeBtn');
        const resetMapBtn = document.getElementById('resetMapBtn');
        const imageInfoBtn = document.getElementById('imageInfoBtn');
        const heatmapToggle = document.getElementById('heatmapToggle');
        const timelineSlider = document.getElementById('timelineSlider');
        const yearDisplay = document.getElementById('yearDisplay');
        const categorySelect = document.getElementById('categorySelect');
        const tourGuide = document.getElementById('tourGuide');
        const tourStep = document.getElementById('tourStep');
        const nextStepBtn = document.getElementById('nextStep');
        const skipTourBtn = document.getElementById('skipTour');

        // Global variables
        let currentUser = null;
        let selectedLocation = null;
        let currentCategory = '';
        let tourSteps = [];
        let currentTourStep = 0;

        // Event listeners
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        locationForm.addEventListener('submit', handleLocationSubmit);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        searchButton.addEventListener('click', handleSearch);
        accountLink.addEventListener('click', handleAccountClick);
        aboutUsBtn.addEventListener('click', () => $('#aboutUsModal').modal('show'));
        instructionsBtn.addEventListener('click', () => $('#instructionsModal').modal('show'));
        homeBtn.addEventListener('click', resetMap);
        resetMapBtn.addEventListener('click', resetMap);
        imageInfoBtn.addEventListener('click', () => $('#imageInfoModal').modal('show'));
        heatmapToggle.addEventListener('change', toggleHeatmap);
        timelineSlider.addEventListener('input', handleTimelineChange);
        categorySelect.addEventListener('change', handleCategoryChange);
        nextStepBtn.addEventListener('click', nextTourStep);
        skipTourBtn.addEventListener('click', endTour);

        map.on('click', handleMapClick);

        // Authentication state observer
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                updateUIForLoggedInUser();
            } else {
                currentUser = null;
                updateUIForLoggedOutUser();
            }
        });

        // Load locations
        loadLocations();

        // Functions
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    $('#loginModal').modal('hide');
                    showNotification('Logged in successfully!', 'success');
                })
                .catch((error) => {
                    showNotification('Login failed: ' + error.message, 'danger');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;

            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return firebase.database().ref('users/' + user.uid).set({
                        email: email,
                        firstName: firstName,
                        lastName: lastName,
                        locationsAdded: 0,
                        commentsAdded: 0,
                        likesReceived: 0
                    });
                })
                .then(() => {
                    $('#registerModal').modal('hide');
                    showNotification('Registered successfully!', 'success');
                })
                .catch((error) => {
                    showNotification('Registration failed: ' + error.message, 'danger');
                });
        }

        function handleLocationSubmit(e) {
            e.preventDefault();
            if (!currentUser) {
                showNotification('Please log in to add a location.', 'warning');
                return;
            }

            const name = document.getElementById('locationName').value;
            const category = document.getElementById('locationCategory').value;
            const description = document.getElementById('locationDescription').value;
            const imageFile = document.getElementById('locationImage').files[0];
            const imageYear = document.getElementById('imageYear').value;
            const story = document.getElementById('locationStory').value;
            const allowUseInArticles = document.getElementById('allowUseInArticles').checked;

            if (imageFile && imageFile.size > 75 * 1024) {
                document.getElementById('imageError').textContent = 'Image size exceeds 75KB limit.';
                return;
            }

            const locationData = {
                name: name,
                category: category,
                description: description,
                lat: selectedLocation.lat,
                lng: selectedLocation.lng,
                imageYear: parseInt(imageYear),
                story: story,
                allowUseInArticles: allowUseInArticles,
                addedBy: currentUser.uid,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                likes: 0,
                views: 0
            };

            const newLocationRef = firebase.database().ref('locations').push();

            if (imageFile) {
                const storageRef = firebase.storage().ref('location_images/' + newLocationRef.key);
                storageRef.put(imageFile).then((snapshot) => {
                    return snapshot.ref.getDownloadURL();
                }).then((downloadURL) => {
                    locationData.imageUrl = downloadURL;
                    return newLocationRef.set(locationData);
                }).then(() => {
                    $('#locationModal').modal('hide');
                    showNotification('Location added successfully!', 'success');
                    addMarkerToMap(locationData);
                    updateUserStats('locationsAdded');
                    checkAchievements();
                }).catch((error) => {
                    showNotification('Error adding location: ' + error.message, 'danger');
                });
            } else {
                newLocationRef.set(locationData).then(() => {
                    $('#locationModal').modal('hide');
                    showNotification('Location added successfully!', 'success');
                    addMarkerToMap(locationData);
                    updateUserStats('locationsAdded');
                    checkAchievements();
                }).catch((error) => {
                    showNotification('Error adding location: ' + error.message, 'danger');
                });
            }
        }

        function handleMapClick(e) {
            if (currentUser) {
                selectedLocation = e.latlng;
                $('#locationModal').modal('show');
            } else {
                showNotification('Please log in to add a location.', 'warning');
            }
        }

        function handleSearch() {
            const query = searchInput.value;
            if (query) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query},Minnesota`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const result = data[0];
                            map.setView([result.lat, result.lon], 12);
                        } else {
                            showNotification('Location not found.', 'warning');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('An error occurred while searching.', 'danger');
                    });
            }
        }

        function handleAccountClick() {
            if (currentUser) {
                showUserProfile();
            } else {
                $('#loginModal').modal('show');
            }
        }

        function showUserProfile() {
            firebase.database().ref('users/' + currentUser.uid).once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    const profileContent = `
                        <h3>${userData.firstName} ${userData.lastName}</h3>
                        <p><strong>Email:</strong> ${userData.email}</p>
                        <p><strong>Locations Added:</strong> ${userData.locationsAdded || 0}</p>
                        <p><strong>Comments Added:</strong> ${userData.commentsAdded || 0}</p>
                        <p><strong>Likes Received:</strong> ${userData.likesReceived || 0}</p>
                        <h4>Achievements</h4>
                        <div id="achievements"></div>
                        <button class="btn btn-danger mt-3" onclick="handleLogout()">Logout</button>
                    `;
                    document.getElementById('profileModalBody').innerHTML = profileContent;
                    loadAchievements();
                    $('#profileModal').modal('show');
                }
            });
        }

        function handleLogout() {
            firebase.auth().signOut().then(() => {
                $('#profileModal').modal('hide');
                showNotification('Logged out successfully!', 'success');
            }).catch((error) => {
                showNotification('Error logging out: ' + error.message, 'danger');
            });
        }

        function loadLocations() {
            markers.clearLayers();
            firebase.database().ref('locations').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const location = childSnapshot.val();
                    location.key = childSnapshot.key;
                    if (location.imageYear <= timelineSlider.value && (!currentCategory || location.category === currentCategory)) {
                        addMarkerToMap(location);
                    }
                });
            });
            updateHeatmap();
        }

        function addMarkerToMap(location) {
            const marker = L.marker([location.lat, location.lng]);
            marker.bindPopup(`<b>${location.name}</b><br>${location.description}`);
            marker.on('click', () => showLocationDetails(location));
            markers.addLayer(marker);
        }

        function showLocationDetails(location) {
            selectedLocation = location;
            firebase.database().ref('locations/' + location.key + '/views').transaction(views => (views || 0) + 1);
            
            let content = `
                <h2>${location.name}</h2>
                <p><strong>Category:</strong> ${location.category}</p>
                <p><strong>Description:</strong> ${location.description}</p>
                <p><strong>Year:</strong> ${location.imageYear}</p>
            `;

            if (location.imageUrl) {
                content += `<img src="${location.imageUrl}" alt="${location.name}" style="max-width: 100%; height: auto;">`;
            }

            if (location.story) {
                content += `
                    <div class="story-container">
                        <p><strong>Story:</strong> ${location.story}</p>
                    </div>
                    <span class="read-more">Read more</span>
                `;
            }

            content += `
                <p><strong>Views:</strong> <span id="viewCount">${location.views || 0}</span></p>
                <p><strong>Likes:</strong> <span id="likeCount">${location.likes || 0}</span></p>
                <button id="likeButton" class="btn btn-primary">Like</button>
                <div id="comments"></div>
                <textarea id="commentInput" class="form-control mt-2" placeholder="Add a comment..."></textarea>
                <button id="submitComment" class="btn btn-primary mt-2">Submit Comment</button>
            `;

            if (currentUser && currentUser.uid === location.addedBy) {
                content += `
                    <button id="editLocationBtn" class="btn btn-secondary mt-2">Edit Location</button>
                    <button id="deleteLocationBtn" class="btn btn-danger mt-2">Delete Location</button>
                `;
            } else {
                content += `
                    <div class="collaborative-edit mt-2">
                        <button id="suggestEditBtn" class="btn btn-secondary">Suggest Edit</button>
                    </div>
                `;
            }

            content += `
                <div class="edit-history mt-2">
                    <h5>Edit History</h5>
                    <ul id="editHistoryList"></ul>
                </div>
            `;

            sidebarContent.innerHTML = content;
            sidebar.classList.remove('d-none');
            sidebar.classList.add('active');

            loadComments(location.key);
            loadEditHistory(location.key);

            document.getElementById('likeButton').addEventListener('click', () => likeLocation(location.key));
            document.getElementById('submitComment').addEventListener('click', () => addComment(location.key));

            const readMoreSpan = document.querySelector('.read-more');
            if (readMoreSpan) {
                readMoreSpan.addEventListener('click', expandStory);
            }

            const editLocationBtn = document.getElementById('editLocationBtn');
            if (editLocationBtn) {
                editLocationBtn.addEventListener('click', () => editLocation(location));
            }

            const deleteLocationBtn = document.getElementById('deleteLocationBtn');
            if (deleteLocationBtn) {
                deleteLocationBtn.addEventListener('click', () => deleteLocation(location.key));
            }

            const suggestEditBtn = document.getElementById('suggestEditBtn');
            if (suggestEditBtn) {
                suggestEditBtn.addEventListener('click', () => suggestEdit(location.key));
            }
        }

        function expandStory() {
            const storyContainer = document.querySelector('.story-container');
            storyContainer.style.maxHeight = 'none';
            this.style.display = 'none';
        }

        function loadComments(locationKey) {
            const commentsContainer = document.getElementById('comments');
            commentsContainer.innerHTML = '<h4>Comments</h4>';

            firebase.database().ref('comments/' + locationKey).once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const comment = childSnapshot.val();
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.innerHTML = `
                        <p><strong>${comment.username}</strong>: ${comment.text}</p>
                        <small>${new Date(comment.timestamp).toLocaleString()}</small>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            });
        }

        function addComment(locationKey) {
            if (!currentUser) {
                showNotification('Please log in to add a comment.', 'warning');
                return;
            }

            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();

            if (commentText) {
                firebase.database().ref('users/' + currentUser.uid).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    const username = userData ? `${userData.firstName} ${userData.lastName}` : 'Anonymous';

                    firebase.database().ref('comments/' + locationKey).push({
                        text: commentText,
                        userId: currentUser.uid,
                        username: username,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        commentInput.value = '';
                        loadComments(locationKey);
                        updateUserStats('commentsAdded');
                        checkAchievements();
                    }).catch((error) => {
                        showNotification('Error adding comment: ' + error.message, 'danger');
                    });
                });
            }
        }

        function likeLocation(locationKey) {
            if (!currentUser) {
                showNotification('Please log in to like a location.',
                'warning');
                return;
            }

            const likeRef = firebase.database().ref('likes/' + locationKey + '/' + currentUser.uid);
            likeRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    showNotification('You have already liked this location.', 'info');
                } else {
                    likeRef.set(true);
                    firebase.database().ref('locations/' + locationKey + '/likes').transaction(likes => (likes || 0) + 1);
                    updateLocationOwnerStats(locationKey, 'likesReceived');
                    document.getElementById('likeCount').textContent = parseInt(document.getElementById('likeCount').textContent) + 1;
                    showNotification('Location liked!', 'success');
                }
            });
        }

        function updateLocationOwnerStats(locationKey, stat) {
            firebase.database().ref('locations/' + locationKey + '/addedBy').once('value', (snapshot) => {
                const ownerId = snapshot.val();
                if (ownerId) {
                    firebase.database().ref('users/' + ownerId + '/' + stat).transaction(count => (count || 0) + 1);
                }
            });
        }

        function updateUserStats(stat) {
            if (currentUser) {
                firebase.database().ref('users/' + currentUser.uid + '/' + stat).transaction(count => (count || 0) + 1);
            }
        }

        function checkAchievements() {
            if (currentUser) {
                firebase.database().ref('users/' + currentUser.uid).once('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        const achievements = [];

                        if (userData.locationsAdded >= 5) achievements.push('Location Explorer');
                        if (userData.commentsAdded >= 10) achievements.push('Active Commenter');
                        if (userData.likesReceived >= 20) achievements.push('Popular Contributor');

                        if (achievements.length > 0) {
                            firebase.database().ref('users/' + currentUser.uid + '/achievements').set(achievements)
                                .then(() => {
                                    showNotification('You\'ve earned new achievements!', 'success');
                                });
                        }
                    }
                });
            }
        }

        function loadAchievements() {
            const achievementsContainer = document.getElementById('achievements');
            firebase.database().ref('users/' + currentUser.uid + '/achievements').once('value', (snapshot) => {
                const achievements = snapshot.val() || [];
                achievementsContainer.innerHTML = achievements.map(achievement => `
                    <div class="achievement">
                        <span class="achievement-icon">🏆</span>
                        <div class="achievement-info">
                            <strong>${achievement}</strong>
                        </div>
                    </div>
                `).join('');
            });
        }

        function editLocation(location) {
            document.getElementById('locationName').value = location.name;
            document.getElementById('locationCategory').value = location.category;
            document.getElementById('locationDescription').value = location.description;
            document.getElementById('imageYear').value = location.imageYear;
            document.getElementById('locationStory').value = location.story || '';
            document.getElementById('allowUseInArticles').checked = location.allowUseInArticles || false;

            const locationForm = document.getElementById('locationForm');
            locationForm.onsubmit = (e) => {
                e.preventDefault();
                updateLocation(location.key);
            };

            $('#locationModal').modal('show');
        }

        function updateLocation(locationKey) {
            const updatedData = {
                name: document.getElementById('locationName').value,
                category: document.getElementById('locationCategory').value,
                description: document.getElementById('locationDescription').value,
                imageYear: parseInt(document.getElementById('imageYear').value),
                story: document.getElementById('locationStory').value,
                allowUseInArticles: document.getElementById('allowUseInArticles').checked
            };

            const imageFile = document.getElementById('locationImage').files[0];

            if (imageFile) {
                if (imageFile.size > 75 * 1024) {
                    document.getElementById('imageError').textContent = 'Image size exceeds 75KB limit.';
                    return;
                }

                const storageRef = firebase.storage().ref('location_images/' + locationKey);
                storageRef.put(imageFile).then((snapshot) => {
                    return snapshot.ref.getDownloadURL();
                }).then((downloadURL) => {
                    updatedData.imageUrl = downloadURL;
                    return firebase.database().ref('locations/' + locationKey).update(updatedData);
                }).then(() => {
                    $('#locationModal').modal('hide');
                    showNotification('Location updated successfully!', 'success');
                    loadLocations();
                }).catch((error) => {
                    showNotification('Error updating location: ' + error.message, 'danger');
                });
            } else {
                firebase.database().ref('locations/' + locationKey).update(updatedData).then(() => {
                    $('#locationModal').modal('hide');
                    showNotification('Location updated successfully!', 'success');
                    loadLocations();
                }).catch((error) => {
                    showNotification('Error updating location: ' + error.message, 'danger');
                });
            }

            // Add edit to history
            const editHistoryRef = firebase.database().ref('editHistory/' + locationKey).push();
            editHistoryRef.set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                userId: currentUser.uid,
                action: 'update'
            });
        }

        function deleteLocation(locationKey) {
            if (confirm('Are you sure you want to delete this location?')) {
                firebase.database().ref('locations/' + locationKey).remove().then(() => {
                    closeSidebar();
                    showNotification('Location deleted successfully!', 'success');
                    loadLocations();
                }).catch((error) => {
                    showNotification('Error deleting location: ' + error.message, 'danger');
                });

                // Add deletion to edit history
                const editHistoryRef = firebase.database().ref('editHistory/' + locationKey).push();
                editHistoryRef.set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userId: currentUser.uid,
                    action: 'delete'
                });
            }
        }

        function suggestEdit(locationKey) {
            const editSuggestion = prompt('Please describe your suggested edit:');
            if (editSuggestion) {
                const suggestionRef = firebase.database().ref('editSuggestions/' + locationKey).push();
                suggestionRef.set({
                    suggestion: editSuggestion,
                    userId: currentUser.uid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending'
                }).then(() => {
                    showNotification('Edit suggestion submitted successfully!', 'success');
                }).catch((error) => {
                    showNotification('Error submitting edit suggestion: ' + error.message, 'danger');
                });
            }
        }

        function loadEditHistory(locationKey) {
            const editHistoryList = document.getElementById('editHistoryList');
            editHistoryList.innerHTML = '';

            firebase.database().ref('editHistory/' + locationKey).orderByChild('timestamp').limitToLast(5).once('value', (snapshot) => {
                const edits = [];
                snapshot.forEach((childSnapshot) => {
                    edits.unshift(childSnapshot.val());
                });

                edits.forEach((edit) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${edit.action} on ${new Date(edit.timestamp).toLocaleString()}`;
                    editHistoryList.appendChild(listItem);
                });
            });
        }

        function closeSidebar() {
            sidebar.classList.add('d-none');
            sidebar.classList.remove('active');
        }

        function resetMap() {
            map.setView([44.7696, -94.6859], 6);
            closeSidebar();
        }

        function toggleHeatmap() {
            if (heatmapToggle.checked) {
                updateHeatmap();
                map.addLayer(heatmapLayer);
            } else {
                map.removeLayer(heatmapLayer);
            }
        }

        function updateHeatmap() {
            const heatmapData = [];
            markers.eachLayer((layer) => {
                if (layer.getLatLng) {
                    heatmapData.push([layer.getLatLng().lat, layer.getLatLng().lng, 1]);
                }
            });
            heatmapLayer.setLatLngs(heatmapData);
        }

        function handleTimelineChange() {
            const year = timelineSlider.value;
            yearDisplay.textContent = year;
            loadLocations();
        }

        function handleCategoryChange() {
            currentCategory = categorySelect.value;
            loadLocations();
        }

        function updateUIForLoggedInUser() {
            accountLink.innerHTML = '<i class="fas fa-user"></i> Profile';
            accountLink.removeEventListener('click', handleAccountClick);
            accountLink.addEventListener('click', showUserProfile);
        }

        function updateUIForLoggedOutUser() {
            accountLink.innerHTML = '<i class="fas fa-user"></i> Log In | Register';
            accountLink.removeEventListener('click', showUserProfile);
            accountLink.addEventListener('click', handleAccountClick);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} notification`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function startTour() {
            tourSteps = [
                "Welcome to Minnesota Then! Let's take a quick tour of the features.",
                "Use the search bar at the top to find specific locations in Minnesota.",
                "Click on the map to add a new historical location.",
                "Use the timeline slider at the bottom to filter locations by year.",
                "Toggle the heatmap to see popular areas.",
                "Use the category filter to focus on specific types of historical points.",
                "Click on markers to view location details and interact with other users.",
                "That's it! Enjoy exploring Minnesota's rich history!"
            ];
            currentTourStep = 0;
            tourGuide.style.display = 'block';
            showTourStep();
        }

        function showTourStep() {
            tourStep.textContent = tourSteps[currentTourStep];
            nextStepBtn.style.display = currentTourStep < tourSteps.length - 1 ? 'inline-block' : 'none';
            skipTourBtn.textContent = currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Skip Tour';
        }

        function nextTourStep() {
            currentTourStep++;
            if (currentTourStep < tourSteps.length) {
                showTourStep();
            } else {
                endTour();
            }
        }

        function endTour() {
            tourGuide.style.display = 'none';
        }

        // Start the tour when the page loads
        window.addEventListener('load', startTour);
    </script>
</body>
</html>
