<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then | Community Stories</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            scroll-behavior: smooth;
            padding-bottom: 56px;
        }

        .custom-marker-icon {
            background-color: #c30b82;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
        }

        .title-divider {
            border: 0;
            height: 2px;
            background-color: #00008B;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .hero {
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1559177728-f13d60522ce5');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
            padding: 150px 0;
            position: relative;
        }

        .hero-content {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 10px;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .search-section {
            background-color: #f8f9fa;
            padding: 50px 0;
        }

        .stories-section {
            padding: 50px 0;
            background-color: #ffffff;
        }

        .map-container {
            height: calc(100vh - 56px);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .sidebar {
            position: fixed;
            top: 0px;
            right: -400px;
            width: 400px;
            height: calc(100% - 36px);
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.025);
            border-radius: 12px 0 12px 0;
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar.open {
            right: 0;
        }

        .story-card {
            margin-bottom: 20px;
            transition: transform 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.025);
            border-radius: 10px;
            overflow: hidden;
        }

        .story-card:hover {
            transform: translateY(-5px);
        }

        .story-card .card-body {
            padding: 20px;
        }

        .story-card .card-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        #comments-section {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .comment {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .comment-author {
            font-weight: bold;
            color: #007bff;
        }

        .comment-date {
            font-size: 0.8em;
            color: #6c757d;
        }

        #add-comment-form {
            margin-top: 20px;
        }

        .tag {
            display: inline-block;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #007bff;
            padding: 10px 0;
            z-index: 1000;
        }

        .bottom-nav .nav-link {
            color: white !important;
            text-align: center;
        }

        .bottom-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .leaflet-control-attribution.leaflet-control {
            display: none;
        }

        .search-input-group {
            max-width: 600px;
            margin: 0 auto;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .timeline {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 50px 0;
        }

        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #007bff;
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
        }

        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -17px;
            background-color: white;
            border: 4px solid #007bff;
            top: 15px;
            border-radius: 50%;
            z-index: 1;
        }

        .left {
            left: 0;
        }

        .right {
            left: 50%;
        }

        .left::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            right: 30px;
            border: medium solid #007bff;
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent #007bff;
        }

        .right::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 22px;
            width: 0;
            z-index: 1;
            left: 30px;
            border: medium solid #007bff;
            border-width: 10px 10px 10px 0;
            border-color: transparent #007bff transparent transparent;
        }

        .right::after {
            left: -16px;
        }

        .timeline-content {
            padding: 20px 30px;
            background-color: white;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #editor-container {
            height: 300px;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a class="navbar-brand" href="#">Minnesota Then</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#home">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#stories">Stories</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#map">Map</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="add-story-btn">Add Story</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="account-link">Log In | Register</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <section id="home" class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>Community Stories</h1>
                <p class="lead">Explore and share Minnesota's rich history through community-contributed stories</p>
                <a href="#stories" class="btn btn-primary btn-lg">Start Exploring</a>
            </div>
        </div>
    </section>

    <section id="search" class="search-section">
        <div class="container">
            <h2 class="text-center mb-4">Search for Stories</h2>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="input-group mb-3">
                        <input type="text" id="search-input" class="form-control" placeholder="Enter a keyword, location, or year">
                        <button class="btn btn-primary" type="button" id="search-button">Search</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="stories" class="stories-section">
        <div class="container">
            <h2 class="text-center mb-4">Featured Stories</h2>
            <div class="row" id="stories-container">
                <!-- Stories will be dynamically added here -->
            </div>
        </div>
    </section>

    <section id="map" class="map-section">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 p-0">
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="sidebar" class="sidebar">
        <h3 id="story-title"></h3>
        <hr class="title-divider">
        <img id="story-image" class="img-fluid mb-3" src="" alt="">
        <div id="story-content"></div>
        <p id="story-year"></p>
        <p id="story-author"></p>
        <div id="story-tags"></div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary" id="like-btn">
                <i class="far fa-heart"></i> <span id="likes-count">0</span>
            </button>
            <span class="text-muted">Views: <span id="views-count">0</span></span>
        </div>
        <div id="comments-section">
            <h4>Comments</h4>
            <div id="comments-list"></div>
        </div>
        <form id="add-comment-form">
            <div class="form-group">
                <label for="comment-text">Add a comment:</label>
                <textarea class="form-control" id="comment-text" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary mt-2">Submit Comment</button>
        </form>
        <button id="close-sidebar" class="btn btn-secondary mt-3">Close</button>
    </div>

    <div id="add-story-popup" class="popup">
        <div class="popup-content">
            <h3>Add New Story</h3>
            <form id="add-story-form">
                <div class="mb-3">
                    <label for="new-story-title" class="form-label">Title</label>
                    <input type="text" class="form-control" id="new-story-title" required>
                </div>
                <div class="mb-3">
                    <label for="editor-container" class="form-label">Content</label>
                    <div id="editor-container"></div>
                </div>
                <div class="mb-3">
                    <label for="new-story-year" class="form-label">Year</label>
                    <input type="number" class="form-control" id="new-story-year" required>
                </div>
                <div class="mb-3">
                    <label for="new-story-location" class="form-label">Location</label>
                    <input type="text" class="form-control" id="new-story-location" required>
                </div>
                <div class="mb-3">
                    <label for="new-story-image" class="form-label">Image URL</label>
                    <input type="url" class="form-control" id="new-story-image">
                </div>
                <div class="mb-3">
                    <label for="new-story-tags" class="form-label">Tags (comma-separated)</label>
                    <input type="text" class="form-control" id="new-story-tags" placeholder="e.g., Historical, Urban, Nature">
                </div>
                <button type="submit" class="btn btn-primary">Add Story</button>
                <button type="button" class="btn btn-secondary" id="cancel-add-story">Cancel</button>
            </form>
        </div>
    </div>

    <nav class="bottom-nav d-md-none">
        <div class="container">
            <div class="row">
                <div class="col">
                    <a href="#home" class="nav-link"><i class="fas fa-home"></i> Home</a>
                </div>
                <div class="col">
                    <a href="#stories" class="nav-link"><i class="fas fa-book-open"></i> Stories</a>
                </div>
                <div class="col">
                    <a href="#map" class="nav-link"><i class="fas fa-map-marked-alt"></i> Map</a>
                </div>
                <div class="col">
                    <a href="#" class="nav-link" id="mobile-add-story-btn"><i class="fas fa-plus"></i> Add</a>
                </div>
            </div>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Initialize map
        const map = L.map('map', { zoomControl: false }).setView([46.7296, -94.6859], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attributionControl: false,
        }).addTo(map);

        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        let currentUser = null;
        let currentStoryId = null;
        let clickedLatLng = null;

        const customIcon = L.divIcon({
            className: 'custom-marker-icon',
            html: "ðŸ“",
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });

        // Initialize Quill editor
        const quill = new Quill('#editor-container', {
            theme: 'snow'
        });

        function addMarkersToMap() {
            markers.clearLayers();
            database.ref('stories').once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const story = childSnapshot.val();
                    const mapMarker = L.marker([story.lat, story.lng], { icon: customIcon });
                    mapMarker.on('click', () => showSidebar(childSnapshot.key, story));
                    markers.addLayer(mapMarker);
                });
            }).catch(error => console.error('Error loading stories: ', error));
        }

        function showSidebar(storyId, story) {
            currentStoryId = storyId;
            document.getElementById('story-title').textContent = story.title;
            document.getElementById('story-content').innerHTML = story.content;
            document.getElementById('story-year').textContent = `Year: ${story.year}`;
            document.getElementById('story-author').textContent = `Added by: ${story.author}`;
            document.getElementById('likes-count').textContent = story.likes || 0;
            document.getElementById('views-count').textContent = story.views || 0;

            const storyImage = document.getElementById('story-image');
            if (story.image) {
                storyImage.src = story.image;
                storyImage.style.display = 'block';
            } else {
                storyImage.style.display = 'none';
            }

            const tagsContainer = document.getElementById('story-tags');
            tagsContainer.innerHTML = '';
            story.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.textContent = tag;
                tagsContainer.appendChild(tagElement);
            });

            document.getElementById('sidebar').classList.add('open');
            loadComments(storyId);
            incrementViews(storyId);
            checkLikeStatus(storyId);
        }

        function incrementViews(storyId) {
            const storyRef = database.ref(`stories/${storyId}`);
            storyRef.transaction((story) => {
                if (story) {
                    story.views = (story.views || 0) + 1;
                }
                return story;
            });
        }

        function checkLikeStatus(storyId) {
            const user = auth.currentUser;
            if (user) {
                const likeRef = database.ref(`user_likes/${user.uid}/${storyId}`);
                likeRef.once('value').then((snapshot) => {
                    const likeBtn = document.getElementById('like-btn');
                    if (snapshot.exists()) {
                        likeBtn.classList.add('liked');
                        likeBtn.disabled = true;
                    } else {
                        likeBtn.classList.remove('liked');
                        likeBtn.disabled = false;
                    }
                });
            }
        }

        document.getElementById('close-sidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
        });

        document.getElementById('search-button').addEventListener('click', performSearch);
        document.getElementById('search-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performSearch();
            }
        });
        
        function performSearch() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            database.ref('stories').once('value').then((snapshot) => {
                const stories = [];
                snapshot.forEach((childSnapshot) => {
                    const story = childSnapshot.val();
                    if (story.title.toLowerCase().includes(searchQuery) ||
                        story.content.toLowerCase().includes(searchQuery) ||
                        story.year.toString().includes(searchQuery) ||
                        story.location.toLowerCase().includes(searchQuery) ||
                        story.tags.some(tag => tag.toLowerCase().includes(searchQuery))) {
                        stories.push({ id: childSnapshot.key, ...story });
                    }
                });
                displaySearchResults(stories);
            });
        }

        function displaySearchResults(stories) {
            const storiesContainer = document.getElementById('stories-container');
            storiesContainer.innerHTML = '';
            stories.forEach(story => {
                const storyElement = createStoryCard(story);
                storiesContainer.appendChild(storyElement);
            });
        }

        function createStoryCard(story) {
            const storyElement = document.createElement('div');
            storyElement.className = 'col-md-4 mb-4';
            storyElement.innerHTML = `
                <div class="card story-card">
                    <img src="${story.image || 'https://via.placeholder.com/300x200'}" class="card-img-top" alt="${story.title}">
                    <div class="card-body">
                        <h5 class="card-title">${story.title}</h5>
                        <p class="card-text">${story.content.substring(0, 100)}...</p>
                        <p class="card-text"><small class="text-muted">Year: ${story.year}</small></p>
                        <button class="btn btn-primary view-story" data-story-id="${story.id}">View Story</button>
                    </div>
                </div>
            `;
            storyElement.querySelector('.view-story').addEventListener('click', () => {
                showSidebar(story.id, story);
            });
            return storyElement;
        }

        function populateStories() {
            const storiesContainer = document.getElementById('stories-container');
            storiesContainer.innerHTML = '';
            database.ref('stories').once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const story = childSnapshot.val();
                    const storyElement = createStoryCard({ id: childSnapshot.key, ...story });
                    storiesContainer.appendChild(storyElement);
                });
            });
        }

        document.getElementById('like-btn').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                const storyRef = database.ref('stories/' + currentStoryId);
                const userLikeRef = database.ref(`user_likes/${user.uid}/${currentStoryId}`);

                userLikeRef.once('value').then((snapshot) => {
                    if (!snapshot.exists()) {
                        storyRef.transaction((story) => {
                            if (story) {
                                story.likes = (story.likes || 0) + 1;
                            }
                            return story;
                        }).then(() => {
                            userLikeRef.set(true);
                            const likesCount = document.getElementById('likes-count');
                            likesCount.textContent = parseInt(likesCount.textContent) + 1;
                            document.getElementById('like-btn').classList.add('liked');
                            document.getElementById('like-btn').disabled = true;
                        });
                    } else {
                        alert('You have already liked this story.');
                    }
                });
            } else {
                alert('Please log in to like stories');
            }
        });

        function loadComments(storyId) {
            const commentsSection = document.getElementById('comments-list');
            commentsSection.innerHTML = '';
            database.ref(`comments/${storyId}`).once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const comment = childSnapshot.val();
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.innerHTML = `
                        <p class="comment-author">${comment.author}</p>
                        <p>${comment.text}</p>
                        <p class="comment-date">${new Date(comment.timestamp).toLocaleString()}</p>
                    `;
                    commentsSection.appendChild(commentElement);
                });
            });
        }

        document.getElementById('add-comment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (user) {
                const commentText = document.getElementById('comment-text').value;
                const userRef = database.ref('users/' + user.uid);

                userRef.once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    const authorName = `${userData.firstName} ${userData.lastName.charAt(0)}.`;

                    const newCommentRef = database.ref('comments/' + currentStoryId).push();
                    newCommentRef.set({
                        author: authorName,
                        text: commentText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        document.getElementById('comment-text').value = '';
                        loadComments(currentStoryId);
                    }).catch(error => console.error('Error adding comment: ', error));
                });
            } else {
                alert('Please log in to add comments');
            }
        });

        document.getElementById('add-story-btn').addEventListener('click', () => {
            if (auth.currentUser) {
                document.getElementById('add-story-popup').style.display = 'flex';
            } else {
                alert('Please log in to add stories');
            }
        });

        document.getElementById('mobile-add-story-btn').addEventListener('click', () => {
            if (auth.currentUser) {
                document.getElementById('add-story-popup').style.display = 'flex';
            } else {
                alert('Please log in to add stories');
            }
        });

        document.getElementById('add-story-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (user) {
                const userRef = database.ref('users/' + user.uid);
                userRef.once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    const authorName = `${userData.firstName} ${userData.lastName.charAt(0)}.`;
                    
                    const newStoryRef = database.ref('stories').push();
                    const location = document.getElementById('new-story-location').value;
                    
                    // Geocode the location
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lng = parseFloat(data[0].lon);
                                
                                newStoryRef.set({
                                    title: document.getElementById('new-story-title').value,
                                    content: quill.root.innerHTML,
                                    year: document.getElementById('new-story-year').value,
                                    location: location,
                                    lat: lat,
                                    lng: lng,
                                    author: authorName,
                                    likes: 0,
                                    views: 0,
                                    tags: document.getElementById('new-story-tags').value.split(',').map(tag => tag.trim()),
                                    image: document.getElementById('new-story-image').value
                                }).then(() => {
                                    addMarkersToMap();
                                    populateStories();
                                    document.getElementById('add-story-popup').style.display = 'none';
                                    document.getElementById('add-story-form').reset();
                                    quill.setText('');
                                });
                            } else {
                                alert('Location not found. Please try a different location.');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while adding the story. Please try again.');
                        });
                });
            } else {
                alert('Please log in to add stories');
            }
        });

        document.getElementById('cancel-add-story').addEventListener('click', () => {
            document.getElementById('add-story-popup').style.display = 'none';
        });

        // Initialize the map and load stories
        addMarkersToMap();
        populateStories();

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            const accountLink = document.getElementById('account-link');
            if (user) {
                account
Link.textContent = 'Account';
                accountLink.href = '/account.html';
            } else {
                accountLink.textContent = 'Log In | Register';
                accountLink.href = '/login.html';
            }
        });

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>
