<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then: Community Markers</title>
    <meta name="description" content="Mark and explore personal and community history across Minnesota">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="https://www.mnthen.com/css/new_header.css">

    <link rel="stylesheet" href="https://www.mnthen.com/css/comm_mark.css">
    <style>
        #map {
            height: calc(100vh - 56px);
            width: 100%;
        }
        .sidebar {
            position: fixed;
            top: 56px;
            right: -300px;
            width: 300px;
            height: calc(100vh - 56px);
            background-color: white;
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar.open {
            right: 0;
        }
        #filter-dropdown {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
        }
        #about-us-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: #007bff;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #about-us-popup {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 300px;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }
        #next-page-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Minnesota Then</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <div class="dropdown" id="filter-dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="filterDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
            Filter Markers
        </button>
        <ul class="dropdown-menu" aria-labelledby="filterDropdownButton">
            <li><a class="dropdown-item" href="#" data-filter="all">All Markers</a></li>
            <li><a class="dropdown-item" href="#" data-filter="Historical">Historical</a></li>
            <li><a class-="dropdown-item" href="#" data-filter="Cultural">Cultural</a></li>
            <li><a class="dropdown-item" href="#" data-filter="Natural">Natural</a></li>
            <li><a class="dropdown-item" href="#" data-filter="Personal">Personal</a></li>
            <li><a class="dropdown-item" href="#" data-filter="Community">Community</a></li>
        </ul>
    </div>

    <button id="about-us-btn" class="btn btn-info">
        <i class="fas fa-info"></i>
    </button>

    <div id="about-us-popup">
        <span class="close-btn">&times;</span>
        <h4>About Minnesota Then</h4>
        <p>Minnesota Then is a community-driven project aimed at preserving and sharing the rich history of Minnesota. Our platform allows users to mark significant locations and share stories, creating a living digital archive of our state's heritage.</p>
    </div>

    <button id="next-page-btn" class="btn btn-primary">
        <i class="fas fa-arrow-right"></i>
    </button>

    <div id="sidebar" class="sidebar">
        <h3 id="pin-title"></h3>
        <div id="pin-image"></div>
        <p id="pin-description"></p>
        <p id="pin-year"></p>
        <p id="pin-author"></p>
        <button id="close-sidebar" class="btn btn-secondary">Close</button>
    </div>

    <div id="add-marker-sidebar" class="sidebar">
        <h4>Add a New Marker</h4>
        <form id="add-marker-form">
            <div class="mb-3">
                <label for="marker-title" class="form-label">Title</label>
                <input type="text" id="marker-title" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="marker-image" class="form-label">Image</label>
                <input type="file" id="marker-image" class="form-control" accept="image/*">
            </div>
            <div class="mb-3">
                <label for="marker-comment" class="form-label">Comment (50-250 characters)</label>
                <textarea id="marker-comment" class="form-control" rows="3" required minlength="50" maxlength="250"></textarea>
            </div>
            <div class="mb-3">
                <label for="marker-year" class="form-label">Year of Memory</label>
                <input type="number" id="marker-year" class="form-control" required min="1800" max="2099">
            </div>
            <div class="mb-3">
                <label class="form-label">Tags</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="tags" value="Historical" id="tag-Historical">
                    <label class="form-check-label" for="tag-Historical">Historical</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="tags" value="Cultural" id="tag-Cultural">
                    <label class="form-check-label" for="tag-Cultural">Cultural</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="tags" value="Natural" id="tag-Natural">
                    <label class="form-check-label" for="tag-Natural">Natural</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="tags" value="Personal" id="tag-Personal">
                    <label class="form-check-label" for="tag-Personal">Personal</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="tags" value="Community" id="tag-Community">
                    <label class="form-check-label" for="tag-Community">Community</label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Marker</button>
            <button type="button" id="cancel-add-marker" class="btn btn-secondary">Cancel</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
            databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Initialize map
        let map = L.map('map').setView([46.7296, -94.6859], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

        // Initialize marker cluster group
        let markers = L.markerClusterGroup();
        map.addLayer(markers);

        // Custom icon
        const customIcon = L.icon({
            iconUrl: 'https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Load pins
        function loadPins(filter = 'all') {
            markers.clearLayers();
            database.ref('pins').once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const pin = childSnapshot.val();
                    if (filter === 'all' || (pin.tags && pin.tags.includes(filter))) {
                        const marker = L.marker([pin.location.latitude, pin.location.longitude], { icon: customIcon });
                        marker.on('click', () => {
                            document.getElementById('pin-title').textContent = pin.title;
                            document.getElementById('pin-description').textContent = pin.description;
                            document.getElementById('pin-year').textContent = `Year: ${pin.year}`;
                            document.getElementById('pin-author').textContent = `Added by: ${pin.author}`;
                            const pinImage = document.getElementById('pin-image');
                            pinImage.innerHTML = pin.imageUrl ? `<img src="${pin.imageUrl}" alt="${pin.title}" class="img-fluid">` : '';
                            openSidebar('sidebar');
                        });
                        markers.addLayer(marker);
                    }
                });
            }).catch(error => console.error('Error loading markers: ', error));
        }

        // Sidebar functionality
        function openSidebar(sidebarId) {
            document.getElementById(sidebarId).classList.add('open');
        }

        function closeSidebar(sidebarId) {
            document.getElementById(sidebarId).classList.remove('open');
        }

        document.getElementById('close-sidebar').addEventListener('click', () => closeSidebar('sidebar'));
        document.getElementById('cancel-add-marker').addEventListener('click', () => closeSidebar('add-marker-sidebar'));

        // Add marker functionality
        let clickedLatLng;
        map.on('click', function(e) {
            if (auth.currentUser) {
                clickedLatLng = e.latlng;
                openSidebar('add-marker-sidebar');
            } else {
                alert('Please log in to add markers');
            }
        });

        document.getElementById('add-marker-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('marker-title').value;
            const year = document.getElementById('marker-year').value;
            const comment = document.getElementById('marker-comment').value;
            const imageFile = document.getElementById('marker-image').files[0];
            const tags = Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(cb => cb.value);

            const user = auth.currentUser;
            const userRef = database.ref('users/' + user.uid);

            try {
                let imageUrl = '';
                if (imageFile) {
                    const storageRef = storage.ref('marker-images/' + Date.now() + '_' + imageFile.name);
                    await storageRef.put(imageFile);
                    imageUrl = await storageRef.getDownloadURL();
                }

                const userData = (await userRef.once('value')).val();
                const authorName = `${userData.firstName} ${userData.lastName.charAt(0)}.`;

                const newPinRef = database.ref('pins').push();
                await newPinRef.set({
                    title: title,
                    year: parseInt(year),
                    description: comment,
                    imageUrl: imageUrl,
                    location: {
                        latitude: clickedLat

Lng.lat,
                        longitude: clickedLatLng.lng
                    },
                    author: authorName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    tags: tags
                });

                loadPins();
                closeSidebar('add-marker-sidebar');
                document.getElementById('add-marker-form').reset();
            } catch (error) {
                console.error('Error adding pin: ', error);
                alert('Error adding pin. Please try again.');
            }
        });

        // Filter functionality
        document.querySelectorAll('#filter-dropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const filter = e.target.getAttribute('data-filter');
                loadPins(filter);
                document.getElementById('filterDropdownButton').textContent = e.target.textContent;
            });
        });

        // About Us button functionality
        const aboutUsBtn = document.getElementById('about-us-btn');
        const aboutUsPopup = document.getElementById('about-us-popup');
        const closeAboutUsBtn = aboutUsPopup.querySelector('.close-btn');

        aboutUsBtn.addEventListener('click', () => {
            aboutUsPopup.style.display = 'block';
        });

        closeAboutUsBtn.addEventListener('click', () => {
            aboutUsPopup.style.display = 'none';
        });

        // Next page button functionality
        const nextPageBtn = document.getElementById('next-page-btn');
        nextPageBtn.addEventListener('click', () => {
            // Add your next page functionality here
            console.log('Next page button clicked');
        });

        // Load initial pins
        loadPins();

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User is signed in');
                // You can update UI elements here if needed
            } else {
                console.log('No user is signed in');
                // You can update UI elements here if needed
            }
        });
    </script>
</body>
</html>
