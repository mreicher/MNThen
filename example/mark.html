<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then: Community Markers</title>
    <meta name="description" content="Mark and explore personal and community history across Minnesota">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #005f9e;
            --secondary-color: #0077c2;
            --text-color: #333333;
            --background-color: #f8f9fa;
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
        }

        .navbar {
            background-color: var(--primary-color);
            padding: 1rem;
        }

        .navbar-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .navbar-nav .nav-link {
            color: white;
        }

        #map {
            height: calc(100vh - 56px);
            width: 100%;
        }

        .sidebar {
            position: fixed;
            top: 56px;
            right: -400px;
            width: 400px;
            height: calc(100vh - 56px);
            background-color: white;
            padding: 1rem;
            overflow-y: auto;
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar.open {
            right: 0;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .popup-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }

        #refresh-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        #next-page-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .comment-section {
            margin-top: 1rem;
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
        }

        .comment {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                right: -100%;
            }

            #map {
                height: calc(100vh - 56px - 50px);
            }

            .navbar-nav {
                flex-direction: row;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">Minnesota Then</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/blog.html">Blog</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/faq.html">Help Center</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/donate.html">Sponsor Us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upcoming_events.html">Upcoming Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="account-link">
                            <i class="fas fa-user"></i> Log In | Register
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <div id="sidebar" class="sidebar">
        <h3 id="pin-title"></h3>
        <div id="pin-image"></div>
        <p id="pin-description"></p>
        <p id="pin-year"></p>
        <p id="pin-author"></p>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary" id="like-btn">
                <i class="far fa-heart"></i> <span id="likes-count">0</span>
            </button>
            <span class="views-count">Views: <span id="views-count">0</span></span>
        </div>
        <div class="comment-section">
            <h4>Comments</h4>
            <div id="comments-container"></div>
            <form id="comment-form" class="mt-3">
                <div class="mb-3">
                    <textarea class="form-control" id="comment-text" rows="3" placeholder="Add a comment..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>
        </div>
        <button id="close-sidebar" class="btn btn-secondary mt-3">Close</button>
    </div>

    <div id="add-marker-sidebar" class="sidebar">
        <h4>Add a New Marker</h4>
        <form id="add-marker-form">
            <div class="mb-3">
                <label for="marker-title" class="form-label">Title</label>
                <input type="text" id="marker-title" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="marker-image" class="form-label">Image URL</label>
                <div class="input-group">
                    <input type="url" id="marker-image" class="form-control">
                    <button type="button" id="image-info-btn" class="btn btn-outline-secondary">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                <small class="form-text text-muted">Click the info icon for free image hosting options.</small>
            </div>
            <div class="mb-3">
                <label for="marker-comment" class="form-label">Comment (50-250 characters)</label>
                <textarea id="marker-comment" class="form-control" rows="4" required minlength="50" maxlength="250"></textarea>
            </div>
            <div class="mb-3">
                <label for="marker-year" class="form-label">Year of Memory</label>
                <input type="number" id="marker-year" class="form-control" required min="1800" max="2099">
            </div>
            <button type="submit" class="btn btn-primary">Add Marker</button>
            <button type="button" id="cancel-add-marker" class="btn btn-secondary">Cancel</button>
        </form>
    </div>

    <button id="refresh-btn" class="btn btn-primary">
        <i class="fas fa-sync"></i>
    </button>

    <button id="next-page-btn" class="btn btn-primary">
        <i class="fas fa-arrow-right"></i>
    </button>

    <div id="welcome-popup" class="popup">
        <div class="popup-content">
            <h2>Welcome to Community Markers</h2>
            <p>This is a place for people to mark their history, their family's history, and the history of their friends and community across Minnesota. Explore existing markers or log in to add your own!</p>
            <button id="close-popup" class="btn btn-primary">Get Started</button>
        </div>
    </div>

    <div id="image-hosting-popup" class="popup">
        <div class="popup-content">
            <h3>Free Image Hosting Options</h3>
            <p>Here are some free image hosting services you can use to get a URL for your image:</p>
            <ul>
                <li><strong>Imgur:</strong> <a href="https://imgur.com/" target="_blank" rel="noopener noreferrer">imgur.com</a></li>
                <li><strong>ImgBB:</strong> <a href="https://imgbb.com/" target="_blank" rel="noopener noreferrer">imgbb.com</a></li>
                <li><strong>Postimages:</strong> <a href="https://postimages.org/" target="_blank" rel="noopener noreferrer">postimages.org</a></li>
            </ul>
            <p>After obtaining the image URL, paste it into the "Image URL" field in the form.</p>
            <button id="close-image-hosting-popup" class="btn btn-primary">Close</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let map;
            let markers;
            let clickedLatLng;
            let currentPinId;

            const firebaseConfig = {
                apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
                authDomain: "mnthen-3151d.firebaseapp.com",
                projectId: "mnthen-3151d",
                storageBucket: "mnthen-3151d.appspot.com",
                messagingSenderId: "416231360428",
                appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
                databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();

            function initMap() {
                map = L.map('map', {
                    zoomControl: false
                }).setView([46.7296, -94.6859], 7);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

                markers = L.markerClusterGroup();
                map.addLayer(markers);

                map.on('click', function(e) {
                    if (auth.currentUser) {
                        clickedLatLng = e.latlng;
                        document.getElementById('add-marker-sidebar').classList.add('open');
                    } else {
                        alert('Please log in to add markers');
                    }
                });
            }

            function loadPins() {
                markers.clearLayers();
                database.ref('pins').once('value').then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const pin = childSnapshot.val();
                        const marker = L.marker([pin.location.latitude, pin.location.longitude], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: "<div style='background-color:#c30b82;' class='marker-pin'></div><i class='fas fa-map-marker-alt' style='color: white; font-size: 15px;'></i>",
                                iconSize: [30, 42],
                                iconAnchor: [15, 42]
                            })
                        });
                        marker.on('click', () => {
                            currentPinId = childSnapshot.key;
                            document.getElementById('pin-title').textContent = pin.title;
                            document.getElementById('pin-description').textContent = pin.description;
                            document.getElementById('pin-year').textContent = `Year: ${pin.year}`;
                            document.getElementById('pin-author').textContent = `Added by: ${pin.author}`;
                            const pinImage = document.getElementById('pin-image');
                            pinImage.innerHTML = pin.imageUrl ? `<img src="${pin.imageUrl}" alt="${pin.title}" class="img-fluid">` : '';
                            document.getElementById('likes-count').textContent = pin.likes || 0;
                            document.getElementById('views-count').textContent = pin.views || 0;
                            loadComments(currentPinId);
                            openSidebar('sidebar');
                            incrementViews(currentPinId);
                        });
                        markers.addLayer(marker);
                    });
                }).catch(error => console.error('Error loading markers: ', error));
            }

            function openSidebar(sidebarId) {
                document.getElementById(sidebarId).classList.add('open');
            }

            function closeSidebar(sidebarId) {
                document.getElementById(sidebarId).classList.remove('open');
            }

            function incrementViews(pinId) {
                const pinRef = database.ref('pins/' + pinId);
                pinRef.transaction((pin) => {
                    if (pin) {
                        pin.views = (pin.views || 0) + 1;
                    }
                    return pin;
                });
            }

            function loadComments(pinId) {
                const commentsContainer = document.getElementById('comments-container');
                commentsContainer.innerHTML = '';
                database.ref(`comments/${pinId}`).once('value').then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const comment = childSnapshot.val();
                        const commentElement = document.createElement('div');
                        commentElement.className = 'comment';
                        commentElement.innerHTML = `
                            <p><strong>${comment.author}</strong>: ${comment.text}</p>
                            <small>${new Date(comment.timestamp).toLocaleString()}</small>
                        `;
                        commentsContainer.appendChild(commentElement);
                    });
                });
            }

            document.getElementById('comment-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (user) {
                    const commentText = document.getElementById('comment-text').value;
                    const newCommentRef = database.ref(`comments/${currentPinId}`).push();
                    newCommentRef.set({
                        author: user.displayName || user.email,
                        text: commentText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        document.getElementById('comment-text').value = '';
                        loadComments(currentPinId);
                    }).catch(error => console.error('Error adding comment: ', error));
                } else {
                    alert('Please log in to add comments');
                }
            });

            document.getElementById('close-sidebar').addEventListener('click', () => closeSidebar('sidebar'));
            document.getElementById('cancel-add-marker').addEventListener('click', () => closeSidebar('add-marker-sidebar'));

            document.getElementById('add-marker-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('marker-title').value;
                const year = document.getElementById('marker-year').value;
                const comment = document.getElementById('marker-comment').value;
                const imageUrl = document.getElementById('marker-image').value;

                const user = auth.currentUser;
                const userRef = database.ref('users/' + user.uid);

                userRef.once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    const authorName = `${userData.firstName} ${userData.lastName.charAt(0)}.`;

                    const newPinRef = database.ref('pins').push();
                    newPinRef.set({
                        title: title,
                        year: year,
                        description: comment,
                        imageUrl: imageUrl,
                        location: {
                            latitude: clickedLatLng.lat,
                            longitude: clickedLatLng.lng
                        },
                        author: authorName,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        loadPins();
                        closeSidebar('add-marker-sidebar');
                        document.getElementById('add-marker-form').reset();
                    }).catch(error => console.error('Error adding pin: ', error));
                });
            });

            document.getElementById('like-btn').addEventListener('click', () => {
                const user = auth.currentUser;
                if (user) {
                    const pinRef = database.ref('pins/' + currentPinId);
                    const userLikeRef = database.ref(`user_likes/${user.uid}/${currentPinId}`);
                    
                    userLikeRef.once('value').then((snapshot) => {
                        if (!snapshot.exists()) {
                            pinRef.transaction((pin) => {
                                if (pin) {
                                    pin.likes = (pin.likes || 0) + 1;
                                }
                                return pin;
                            }).then(() => {
                                userLikeRef.set(true);
                                const likesCount = document.getElementById('likes-count');
                                likesCount.textContent = parseInt(likesCount.textContent) + 1;
                                document.getElementById('like-btn').classList.add('liked');
                                document.getElementById('like-btn').disabled = true;
                            });
                        } else {
                            alert('You have already liked this marker.');
                        }
                    });
                } else {
                    alert('Please log in to like markers');
                }
            });

            document.getElementById('refresh-btn').addEventListener('click', function() {
                map.setView([46.7296, -94.6859], 7);
                document.getElementById('pin-title').textContent = '';
                document.getElementById('pin-description').textContent = '';
                document.getElementById('pin-image').innerHTML = '';
                document.getElementById('pin-year').textContent = '';
                document.getElementById('pin-author').textContent = '';
            });

            document.getElementById('image-info-btn').addEventListener('click', function() {
                document.getElementById('image-hosting-popup').style.display = 'flex';
            });

            document.getElementById('close-image-hosting-popup').addEventListener('click', function() {
                document.getElementById('image-hosting-popup').style.display = 'none';
            });

            window.addEventListener('resize', function() {
                map.invalidateSize();
            });

            initMap();
            loadPins();

            const welcomePopup = document.getElementById('welcome-popup');
            welcomePopup.style.display = 'flex';

            document.getElementById('close-popup').addEventListener('click', () => {
                gsap.to(welcomePopup, { duration: 0.5, opacity: 0, scale: 0.8, onComplete: () => {
                    welcomePopup.style.display = 'none';
                }});
            });

            auth.onAuthStateChanged((user) => {
                const accountLink = document.getElementById('account-link');
                if (user) {
                    accountLink.href = '/account.html';
                    accountLink.innerHTML = '<i class="fas fa-user-circle"></i><span> Account Info</span>';
                } else {
                    accountLink.href = '/login.html';
                    accountLink.innerHTML = '<i class="fas fa-user"></i><span> Log In | Register</span>';
                }
            });
        });
    </script>
</body>
</html>
