<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then: Community Markers</title>
    <meta name="description" content="Mark and explore personal and community history across Minnesota">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <link rel="stylesheet" href="https://www.mnthen.com/css/new_header.css">
    <link rel="stylesheet" href="https://www.mnthen.com/css/comm_mark.css">
    
    <style>
        #refresh-btn {
            position: absolute;
            height: 45px;
            width: 45px;
            bottom: 40px;
            left: 15px;
            border-radius: 50%;
            z-index: 1000;
        }
        .comment-section {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .comment {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .comment-form {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Header section (unchanged) -->
    <header>
        <!-- ... (header content remains the same) ... -->
    </header>
    
    <div id="page-container">
        <div id="map-container">
            <div id="map" role="application" aria-label="Interactive community map of Minnesota"></div>
        </div>
        
        <div id="sidebar" class="sidebar">
            <h3 id="pin-title"></h3>
            <div id="pin-image"></div>
            <p id="pin-description"></p>
            <p id="pin-year"></p>
            <p id="pin-author"></p>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="like-btn" id="like-btn">
                    <i class="far fa-heart"></i> <span id="likes-count">0</span>
                </button>
                <span class="views-count">Views: <span id="views-count">0</span></span>
            </div>
            <div class="comment-section">
                <h4>Comments</h4>
                <div id="comments-container"></div>
                <form id="comment-form" class="comment-form">
                    <div class="mb-3">
                        <textarea id="comment-text" class="form-control" rows="3" placeholder="Add a comment..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>
            </div>
            <button id="close-sidebar" class="btn btn-secondary mt-3">Close</button>
        </div>
        
        <!-- Add marker sidebar (unchanged) -->
        <div id="add-marker-sidebar" class="sidebar">
            <!-- ... (add marker form content remains the same) ... -->
        </div>

        <button id="refresh-btn" class="btn btn-primary" aria-label="Refresh Map">
            <i class="fas fa-sync"></i>
        </button>

        <!-- Second page, welcome popup, and image hosting popup (unchanged) -->
        <!-- ... (content for these sections remains the same) ... -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let map;
            let markers;
            let clickedLatLng;
            let currentPinId;

            function initMap() {
                if (map) {
                    map.remove();
                }
                map = L.map('map', {
                    zoomControl: false
                }).setView([46.7296, -94.6859], 7);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

                markers = L.markerClusterGroup();
                map.addLayer(markers);

                map.on('click', function(e) {
                    if (auth.currentUser) {
                        clickedLatLng = e.latlng;
                        document.getElementById('add-marker-sidebar').classList.add('open');
                    } else {
                        alert('Please log in to add markers');
                    }
                });
            }
            
            const firebaseConfig = {
                apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
                authDomain: "mnthen-3151d.firebaseapp.com",
                projectId: "mnthen-3151d",
                storageBucket: "mnthen-3151d.appspot.com",
                messagingSenderId: "416231360428",
                appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
                databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();

            firebase.auth().onAuthStateChanged((user) => {
                const accountLink = document.getElementById('account-link');
                if (user) {
                    accountLink.href = '/account.html';
                    accountLink.innerHTML = '<i class="fas fa-user-circle"></i><span> Account Info</span>';
                    console.log('User is logged in');
                } else {
                    accountLink.href = '/login.html';
                    accountLink.innerHTML = '<i class="fas fa-user"></i><span> Log In | Register</span>';
                    console.log('User is not logged in');
                }
            });

            const customIcon = L.icon({
                iconUrl: 'https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');

      document.addEventListener('DOMContentLoaded', function() {
    const dropdownToggle = document.querySelector('#yourDropdownToggleId');
    const dropdownMenu = document.querySelector('#yourDropdownMenuId');
    
    if (dropdownToggle && dropdownMenu) {
        dropdownToggle.addEventListener('click', function() {
            dropdownMenu.classList.toggle('show');
        });
    } else {
        console.error('Dropdown elements not found');
    }
});

            document.addEventListener('click', function(event) {
                if (!event.target.matches('.dropdown-toggle') && !event.target.closest('.dropdown-menu')) {
                    dropdownMenu.classList.remove('show');
                }
            });

            function loadPins() {
                markers.clearLayers();
                database.ref('pins').once('value').then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const pin = childSnapshot.val();
                        const marker = L.marker([pin.location.latitude, pin.location.longitude], { icon: customIcon });
                        marker.on('click', () => {
                            currentPinId = childSnapshot.key;
                            document.getElementById('pin-title').textContent = pin.title;
                            document.getElementById('pin-description').textContent = pin.description;
                            document.getElementById('pin-year').textContent = `Year: ${pin.year}`;
                            document.getElementById('pin-author').textContent = `Added by: ${pin.author}`;
                            const pinImage = document.getElementById('pin-image');
                            pinImage.innerHTML = pin.imageUrl ? `<img src="${pin.imageUrl}" alt="${pin.title}" class="img-fluid">` : '';
                            document.getElementById('likes-count').textContent = pin.likes || 0;
                            document.getElementById('views-count').textContent = pin.views || 0;
                            loadComments(currentPinId);
                            openSidebar('sidebar');
                            incrementViews(currentPinId);
                            checkLikeStatus(currentPinId);
                        });
                        markers.addLayer(marker);
                    });
                }).catch(error => console.error('Error loading markers: ', error));
            }

            function openSidebar(sidebarId) {
                document.getElementById(sidebarId).classList.add('open');
            }

            function closeSidebar(sidebarId) {
                document.getElementById(sidebarId).classList.remove('open');
            }

            document.getElementById('close-sidebar').addEventListener('click', () => closeSidebar('sidebar'));
            document.getElementById('cancel-add-marker').addEventListener('click', () => closeSidebar('add-marker-sidebar'));

            document.getElementById('add-marker-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const title = document.getElementById('marker-title').value;
                const year = document.getElementById('marker-year').value;
                const comment = document.getElementById('marker-comment').value;
                const imageUrl = document.getElementById('marker-image').value;

                const user = auth.currentUser;
                const userRef = database.ref('users/' + user.uid);

                userRef.once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    const authorName = `${userData.firstName} ${userData.lastName.charAt(0)}.`;

                    const newPinRef = database.ref('pins').push();
                    newPinRef.set({
                        title: title,
                        year: year,
                        description: comment,
                        imageUrl: imageUrl,
                        location: {
                            latitude: clickedLatLng.lat,
                            longitude: clickedLatLng.lng
                        },
                        author: authorName,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        loadPins();
                        closeSidebar('add-marker-sidebar');
                        document.getElementById('add-marker-form').reset();
                    }).catch(error => console.error('Error adding pin: ', error));
                });
            });

            const welcomePopup = document.getElementById('welcome-popup');
            document.getElementById('close-popup').addEventListener('click', () => {
                gsap.to(welcomePopup, { duration: 0.5, opacity: 0, scale: 0.8, onComplete: () => {
                    welcomePopup.style.display = 'none';
                }});
            });

            function incrementViews(pinId) {
                const pinRef = database.ref('pins/' + pinId);
                pinRef.transaction((pin) => {
                    if (pin) {
                        pin.views = (pin.views || 0) + 1;
                    }
                    return pin;
                });
            }

            function checkLikeStatus(pinId) {
                const user = auth.currentUser;
                if (user) {
                    const likeRef = database.ref(`user_likes/${user.uid}/${pinId}`);
                    likeRef.once('value').then((snapshot) => {
                        const likeBtn = document.getElementById('like-btn');
                        if (snapshot.exists()) {
                            likeBtn.classList.add('liked');
                            likeBtn.disabled = true;
                        } else {
                            likeBtn.classList.remove('liked');
                            likeBtn.disabled = false;
                        }
                    });
                }
            }

            document.getElementById('like-btn').addEventListener('click', () => {
                const user = auth.currentUser;
                if (user) {
                    const pinRef = database.ref('pins/' + currentPinId);
                    const userLikeRef = database.ref(`user_likes/${user.uid}/${currentPinId}`);
                    
                    userLikeRef.once('value').then((snapshot) => {
                        if (!snapshot.exists()) {
                            pinRef.transaction((pin) => {
                                if (pin) {
                                    pin.likes = (pin.likes || 0) + 1;
                                }
                                return pin;
                            }).then(() => {
                                userLikeRef.set(true);
                                const likesCount = document.getElementById('likes-count');
                                likesCount.textContent = parseInt(likesCount.textContent) + 1;
                                document.getElementById('like-btn').classList.add('liked');
                                document.getElementById('like-btn').disabled = true;
                            });
                        } else {
                            alert('You have already liked this marker.');
                        }
                    });
                } else {
                    alert('Please log in to like markers');
                }
            });

            function loadComments(pinId) {
                const commentsContainer = document.getElementById('comments-container');
                commentsContainer.innerHTML = '';
                database.ref(`comments/${pinId}`).once('value').then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const comment = childSnapshot.val();
                        const commentElement = document.createElement('div');
                        commentElement.className = 'comment';
                        commentElement.innerHTML = `
                            <p><strong>${comment.author}</strong>: ${comment.text}</p>
                            <small>${new Date(comment.timestamp).toLocaleString()}</small>
                        `;
                        commentsContainer.appendChild(commentElement);
                    });
                }).catch(error => console.error('Error loading comments: ', error));
            }

            document.getElementById('comment-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (user) {
                    const commentText = document.getElementById('comment-text').value;
                    if (commentText.trim() !== '') {
                        const userRef = database.ref('users/' + user.uid);
                        userRef.once('value').then((snapshot) => {
                            const userData = snapshot.val();
                            const authorName = `${userData.firstName} ${userData.lastName.charAt(0)}.`;
                            const newCommentRef = database.ref(`comments/${currentPinId}`).push();
                            newCommentRef.set({
                                author: authorName,
                                text: commentText,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            }).then(() => {
                                document.getElementById('comment-text').value = '';
                                loadComments(currentPinId);
                            }).catch(error => console.error('Error adding comment: ', error));
                        });
                    }
                } else {
                    alert('Please log in to add comments');
                }
            });

            document.getElementById('info-btn').addEventListener('click', () => {
                welcomePopup.style.display = 'flex';
            });

            const nextPageBtn = document.getElementById('next-page-btn');
            const secondPage = document.getElementById('second-page');

            nextPageBtn.addEventListener('click', () => {
                if (secondPage.classList.contains('open')) {
                    gsap.to(secondPage, { duration: 0.5, left: '100%', ease: 'power2.inOut', onComplete: () => {
                        secondPage.classList.remove('open');
                    }});
                    nextPageBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                } else {
                    gsap.to(secondPage, { duration: 0.5, left: '0%', ease: 'power2.inOut', onStart: () => {
                        secondPage.classList.add('open');
                    }});
                    nextPageBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                }
            });

            document.getElementById('search-btn').addEventListener('click', performCitySearch);
            document.getElementById('city-search').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    performCitySearch();
                }
            });

            function performCitySearch() {
                const city = document.getElementById('city-search').value;
                if (city) {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)},Minnesota,USA`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lon = parseFloat(data[0].lon);
                                map.setView([lat, lon], 12);
                                secondPage.classList.remove('open');
                                nextPageBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                                gsap.to(secondPage, { duration: 0.5, left: '100%', ease: 'power2.inOut' });
                                
                                setTimeout(() => {
                                    map.invalidateSize();
                                }, 300);
                            } else {
                                alert('City not found. Please try another city in Minnesota.');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while searching for the city. Please try again.');
                        });
                } else {
                    alert('Please enter a city name.');
                }
            }

            const imageInfoBtn = document.getElementById('image-info-btn');
            const imageHostingPopup = document.getElementById('image-hosting-popup');
            const closeImageHostingPopup = document.getElementById('close-image-hosting-popup');

            imageInfoBtn.addEventListener('click', () => {
                imageHostingPopup.classList.add('show');
            });

            closeImageHostingPopup.addEventListener('click', () => {
                imageHostingPopup.classList.remove('show');
            });

            imageHostingPopup.addEventListener('click', (event) => {
                if (event.target === imageHostingPopup) {
                    imageHostingPopup.classList.remove('show');
                }
            });

            window.addEventListener('resize', () => {
                map.invalidateSize();
            });

            initMap();
            loadPins();

            welcomePopup.classList.add('show');

            window.addEventListener('resize', function() {
                map.invalidateSize();
            });

            const toggleButton = document.querySelector('.toggle-button');
            const navbarLinks = document.querySelector('.navbar-links');

            toggleButton.addEventListener('click', function() {
                navbarLinks.classList.toggle('active');
            });

            document.getElementById('refresh-btn').addEventListener('click', function() {
                map.setView([46.7296, -94.6859], 7);
                document.getElementById('pin-title').textContent = '';
                document.getElementById('pin-description').textContent = '';
                document.getElementById('pin-image').innerHTML = '';
                document.getElementById('pin-year').textContent = '';
                document.getElementById('pin-author').textContent = '';
            });
   
            document.getElementById('image-info-btn').addEventListener('click', function() {
                document.getElementById('image-hosting-popup').style.display = 'flex';
            });

            document.getElementById('close-image-hosting-popup').addEventListener('click', function() {
                document.getElementById('image-hosting-popup').style.display = 'none';
            });
        });
    </script>
</body>
</html>
