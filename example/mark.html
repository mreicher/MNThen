<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then: Community Markers</title>
    <meta name="description" content="Mark and explore personal and community history across Minnesota">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .sidebar.open {
            right: 0;
        }
        #filter-dropdown {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        #about-us-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: #007bff;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #about-us-popup {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 300px;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }
        #add-marker-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="dropdown" id="filter-dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="filterDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
            Filter Markers
        </button>
        <ul class="dropdown-menu" aria-labelledby="filterDropdownButton">
            <li><a class="dropdown-item" href="#" data-filter="all">All Markers</a></li>
            <li><a class="dropdown-item" href="#" data-filter="historical">Historical</a></li>
            <li><a class="dropdown-item" href="#" data-filter="cultural">Cultural</a></li>
            <li><a class="dropdown-item" href="#" data-filter="natural">Natural</a></li>
            <li><a class="dropdown-item" href="#" data-filter="personal">Personal</a></li>
        </ul>
    </div>

    <button id="about-us-btn" class="btn btn-primary">
        <i class="fas fa-info"></i>
    </button>

    <div id="about-us-popup">
        <span class="close-btn">&times;</span>
        <h4>About Minnesota Then</h4>
        <p>Minnesota Then is a community-driven project aimed at preserving and sharing the rich history of Minnesota. Our platform allows users to mark significant locations and share stories, creating a living digital archive of our state's heritage.</p>
    </div>

    <button id="add-marker-btn" class="btn btn-success">
        <i class="fas fa-plus"></i> Add Marker
    </button>

    <div id="marker-sidebar" class="sidebar">
        <h3 id="marker-title"></h3>
        <img id="marker-image" class="img-fluid mb-3" src="" alt="">
        <p id="marker-description"></p>
        <p><strong>Year:</strong> <span id="marker-year"></span></p>
        <p><strong>Added by:</strong> <span id="marker-author"></span></p>
        <p><strong>Category:</strong> <span id="marker-category"></span></p>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary" id="like-btn">
                <i class="far fa-heart"></i> <span id="likes-count">0</span>
            </button>
            <span>Views: <span id="views-count">0</span></span>
        </div>
        <button id="close-sidebar" class="btn btn-secondary">Close</button>
    </div>

    <div id="add-marker-sidebar" class="sidebar">
        <h3>Add New Marker</h3>
        <form id="add-marker-form">
            <div class="mb-3">
                <label for="new-marker-title" class="form-label">Title</label>
                <input type="text" class="form-control" id="new-marker-title" required>
            </div>
            <div class="mb-3">
                <label for="new-marker-description" class="form-label">Description</label>
                <textarea class="form-control" id="new-marker-description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
                <label for="new-marker-year" class="form-label">Year</label>
                <input type="number" class="form-control" id="new-marker-year" required min="1800" max="2023">
            </div>
            <div class="mb-3">
                <label for="new-marker-category" class="form-label">Category</label>
                <select class="form-select" id="new-marker-category" required>
                    <option value="historical">Historical</option>
                    <option value="cultural">Cultural</option>
                    <option value="natural">Natural</option>
                    <option value="personal">Personal</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="new-marker-image" class="form-label">Image</label>
                <input type="file" class="form-control" id="new-marker-image" accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary">Add Marker</button>
            <button type="button" id="cancel-add-marker" class="btn btn-secondary">Cancel</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
            databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // Initialize map
        const map = L.map('map').setView([46.7296, -94.6859], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        // Custom icon
        const customIcon = L.icon({
            iconUrl: 'https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-512.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Load markers
        function loadMarkers(filter = 'all') {
            markers.clearLayers();
            database.ref('markers').once('value').then((snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const marker = childSnapshot.val();
                    if (filter === 'all' || marker.category === filter) {
                        const leafletMarker = L.marker([marker.lat, marker.lng], { icon: customIcon });
                        leafletMarker.on('click', () => showMarkerDetails(childSnapshot.key, marker));
                        markers.addLayer(leafletMarker);
                    }
                });
            });
        }

        // Show marker details
        function showMarkerDetails(markerId, markerData) {
            document.getElementById('marker-title').textContent = markerData.title;
            document.getElementById('marker-image').src = markerData.imageUrl || '';
            document.getElementById('marker-description').textContent = markerData.description;
            document.getElementById('marker-year').textContent = markerData.year;
            document.getElementById('marker-author').textContent = markerData.author;
            document.getElementById('marker-category').textContent = markerData.category;
            document.getElementById('likes-count').textContent = markerData.likes || 0;
            document.getElementById('views-count').textContent = markerData.views || 0;
            
            document.getElementById('marker-sidebar').classList.add('open');
            
            // Increment views
            const markerRef = database.ref('markers/' + markerId);
            markerRef.transaction((marker) => {
                if (marker) {
                    marker.views = (marker.views || 0) + 1;
                }
                return marker;
            });
        }

        // Close sidebar
        document.getElementById('close-sidebar').addEventListener('click', () => {
            document.getElementById('marker-sidebar').classList.remove('open');
        });

        // Filter markers
        document.querySelectorAll('#filter-dropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const filter = e.target.getAttribute('data-filter');
                loadMarkers(filter);
                document.getElementById('filterDropdownButton').textContent = e.target.textContent;
            });
        });

        // About Us popup
        const aboutUsBtn = document.getElementById('about-us-btn');
        const aboutUsPopup = document.getElementById('about-us-popup');
        const closePopupBtn = aboutUsPopup.querySelector('.close-btn');

        aboutUsBtn.addEventListener('click', () => {
            aboutUsPopup.style.display = 'block';
        });

        closePopupBtn.addEventListener('click', () => {
            aboutUsPopup.style.display = 'none';
        });

        // Add marker
        const addMarkerBtn = document.getElementById('add-marker-btn');
        const addMarkerSidebar = document.getElementById('add-marker-sidebar');
        const addMarkerForm = document.getElementById('add-marker-form');
        const cancelAddMarkerBtn = document.getElementById('cancel-add-marker');

        addMarkerBtn.addEventListener('click', () => {
            addMarkerSidebar.classList.add('open');
        });

        cancelAddMarkerBtn.addEventListener('click', () => {
            addMarkerSidebar.classList.remove('open');
            addMarkerForm.reset();
        });

        addMarkerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('new-marker-title').value;
            const description = document.getElementById('new-marker-description').value;
            const year = document.getElementById('new-marker-year').value;
            const category = document.getElementById('new-marker-category').value;
            const imageFile = document.getElementById('new-marker-image').files[0];

            try {
                let imageUrl = '';
                if (imageFile) {
                    const storageRef = storage.ref('marker-images/' + Date.now() + '_' + imageFile.name);
                    await storageRef.put(imageFile);
                    imageUrl = await storageRef.getDownloadURL();
                }

                const newMarkerRef = database.ref('markers').push();
                await newMarkerRef.set({
                    title,
                    description,
                    year,
                    category,
                    imageUrl,
                    lat: map.getCenter().lat,
                    lng: map.getCenter().lng,
                    author: 'Anonymous', // Replace with actual user name when authentication is implemented
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                addMarkerSidebar.classList.remove('open');
                addMarkerForm.reset();
                loadMarkers();
            } catch (error) {
                console.error('Error adding marker:', error);
                alert('Error adding marker. Please try again.');
            }
        });

        // Initialize
        loadMarkers();
    </script>
</body>
</html>
