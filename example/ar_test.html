<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Wayfinding Mapping Program</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Add your custom styles here */
        .ar-scene {
            width: 100%;
            height: 400px; /* Adjust the height as needed */
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">AR Wayfinding Mapping Program</h1>
        <div id="arScene" class="ar-scene">
            <!-- AR content will be rendered here -->
        </div>
        <div class="mt-3">
            <h3>Directions</h3>
            <p id="directions">Follow nthe AR markers to reach the next tour marker.</p>
            <p id="distance">Distance left: Calculating...</p>
        </div>
        <div class="mt-3">
            <h3>Add New Marker</h3>
            <button onclick="addNewMarker(37.7749, -122.4194, 'New Marker', 'Information about the new marker')">Add New Marker</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        // Replace the sample data with your actual tour marker coordinates and information
        const tourMarkers = [
            { name: 'Tour Marker 1', latitude: 45.14438389647825, longitude: -93.00431713415057, info: 'Information about Tour Marker 1' },
            { name: 'Tour Marker 2', latitude: 40.7489, longitude: -73.9851, info: 'Information about Tour Marker 2' },
            // Add more tour markers as needed
        ];

        let currentLocation = null;
        let destination = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the AR scene
            const arScene = document.getElementById('arScene');

            // Initialize the AR content and markers
            initializeARContent(arScene);

            // Start watching the user's position
            startWatchingPosition(arScene);
        });

        function initializeARContent(arScene) {
            // Add AR markers for each tour marker
            for (const marker of tourMarkers) {
                addMarker(arScene, marker);
            }
        }

        function addMarker(arScene, marker) {
            const markerEntity = document.createElement('a-entity');
            markerEntity.setAttribute('gps-entity-place', `latitude: ${marker.latitude}; longitude: ${marker.longitude};`);
            markerEntity.setAttribute('title', marker.name);
            markerEntity.setAttribute('info', marker.info);
            markerEntity.setAttribute('scale', '15 15 15');
            markerEntity.setAttribute('gltf-model', 'path/to/your/marker/model.gltf');

            arScene.appendChild(markerEntity);
        }

        function startWatchingPosition(arScene) {
            if (navigator.geolocation) {
                // Watch the user's position continuously
                navigator.geolocation.watchPosition(
                    position => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };

                        // Find the nearest marker and update the destination
                        updateNearestMarker();

                        // Calculate and display the distance
                        const distance = calculateDistance(currentLocation, destination);
                        displayDistance(distance);

                        // Update the AR camera position
                        updateARCamera(arScene, currentLocation);
                    },
                    error => {
                        console.error('Error getting the user\'s position:', error);
                    }
                );
            } else {
                console.error('Geolocation is not supported by this browser.');
            }
        }

        function calculateDistance(location1, location2) {
            // Implement the Haversine formula to calculate the distance between two GPS coordinates
            // You can find many resources online that provide the Haversine formula implementation in JavaScript
            // For simplicity, I'll use a dummy distance calculation function here
            const lat1 = location1.latitude;
            const lon1 = location1.longitude;
            const lat2 = location2.latitude;
            const lon2 = location2.longitude;

            const p = 0.017453292519943295; // Math.PI / 180
            const c = Math.cos;
            const a = 0.5 - c((lat2 - lat1) * p) / 2 +
                c(lat1 * p) * c(lat2 * p) *
                (1 - c((lon2 - lon1) * p)) / 2;
            const distance = 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km

            return distance * 1000; // Convert to meters
        }

        function displayDistance(distance) {
            const distanceElement = document.getElementById('distance');
            distanceElement.textContent = `Distance left: ${distance.toFixed(2)} meters`;
        }

        function updateNearestMarker() {
            let nearestDistance = Number.MAX_VALUE;
            let nearestMarker = null;

            for (const marker of tourMarkers) {
                const distance = calculateDistance(currentLocation, marker);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestMarker = marker;
                }
            }

            destination = nearestMarker;
        }

        function updateARCamera(arScene, location) {
            // Get the AR camera entity
            const arCamera = arScene.querySelector('[gps-camera]');

            // Update the camera's latitude and longitude to the current location
            arCamera.setAttribute('gps-camera', `latitude: ${location.latitude}; longitude: ${location.longitude};`);
        }

        function addNewMarker(latitude, longitude, name, info) {
            const newMarker = { latitude, longitude, name, info };
            addMarker(document.getElementById('arScene'), newMarker);
        }
    </script>
</body>
</html>
