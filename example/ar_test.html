<!DOCTYPE html>
<html>
<head>
  <title>Minnesota Then</title>
  <link rel="shortcut icon" type="image/jpg" href="/images/mnthenfav.ico"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/css/bootstrap.min.css">
  <style>
    /* Map and Info Box styles ... */

    /* AR Scene styles */
    #arScene {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }
  </style>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="distanceBox"></div>

  <!-- AR Scene -->
  <a-scene id="arScene" embedded arjs>
    <a-marker preset="hiro">
      <!-- AR markers will be added dynamically here -->
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var map = L.map("map", {
        attributionControl: false,
      }).setView([44.962472993853055, -93.07146893327669], 19);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
      }).addTo(map);

      L.control.attribution({
        prefix: false,
      }).addTo(map);

      var userLocationMarker = L.circleMarker([0, 0], {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0.5,
        radius: 6,
      }).addTo(map);

      var thresholdFeet = 5;

      function updateUserLocation(e) {
        var userLatLng = e.latlng;
        userLocationMarker.setLatLng(userLatLng);
        map.setView(userLatLng);

        var closestDistance = Infinity;
        var closestLocation = null;

        for (var i = 0; i < locations.length; i++) {
          var location = locations[i];
          var locationLatLng = L.latLng(location.lat, location.lng);
          var distance = userLatLng.distanceTo(locationLatLng);
          var distanceFeet = Math.floor(distance * 3.28084);

          if (distanceFeet < closestDistance) {
            closestDistance = distanceFeet;
            closestLocation = location;
          }
        }

        if (closestDistance <= thresholdFeet) {
          document.getElementById("distanceBox").innerText =
            "You are near " + closestLocation.name + " (" + closestDistance + " feet away)";
          displayARModel(closestLocation);
        } else {
          document.getElementById("distanceBox").innerText = "";
          removeARModel();
        }
      }

      map.on("locationfound", updateUserLocation);

      var locations = [
        {
          name: "Target Field",
          lat: 45.1444062223694,
          lng: -93.0043388320641,
          modelURL: "https://your-external-hosting.com/models/target_field.gltf",
        },
        // Add more locations here...
      ];

      function displayARModel(location) {
        var arScene = document.getElementById("arScene");

        if (!location.arMarkerAdded) {
          var markerElement = document.createElement("a-entity");
          markerElement.setAttribute("gltf-model", location.modelURL);
          markerElement.setAttribute("scale", "0.5 0.5 0.5");
          markerElement.setAttribute("position", "0 0 0");
          markerElement.setAttribute("rotation", "0 0 0");

          var marker = arScene.querySelector("a-marker");
          marker.appendChild(markerElement);

          location.arMarkerAdded = true;
        }
      }

      function removeARModel() {
        var arScene = document.getElementById("arScene");
        arScene.innerHTML = ''; // Remove all AR markers
        for (var i = 0; i < locations.length; i++) {
          locations[i].arMarkerAdded = false; // Reset marker added flag
        }
      }

      // Request location updates
      map.locate({ setView: true, maxZoom: 16 });

      document.addEventListener("DOMContentLoaded", function () {
      var map = L.map("map", {
        attributionControl: false,
      }).setView([44.962472993853055, -93.07146893327669], 19); // Adjusted zoom level for closer view

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 20,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
      }).addTo(map);

      L.control.attribution({
        prefix: false,
      }).addTo(map);

      var userLocationMarker = L.circleMarker([0, 0], {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0.5,
        radius: 6, // Reduced marker size for mobile devices
      }).addTo(map);

      var thresholdFeet = 5; // Reduced threshold distance in feet for mobile devices

      function updateUserLocation(e) {
        var userLatLng = e.latlng;
        userLocationMarker.setLatLng(userLatLng);
        map.setView(userLatLng);

        var closestDistance = Infinity;
        var closestLocation = null;

        for (var i = 0; i < locations.length; i++) {
          var location = locations[i];
          var locationLatLng = L.latLng(location.lat, location.lng);
          var distance = userLatLng.distanceTo(locationLatLng);
          var distanceFeet = Math.floor(distance * 3.28084); // Convert to feet and round down

          if (distanceFeet < closestDistance) {
            closestDistance = distanceFeet;
            closestLocation = location;
          }

          var popupContent =
            "<b>" +
            location.name +
            "</b><br>Distance: " +
            distanceFeet +
            " feet";

          var popupOptions = {
            autoClose: false,
          };

      var marker = L.marker(locationLatLng).bindPopup(
    "<b>" + location.name + "</b>",
    { className: "custom-popup" }
  );

  marker.addTo(map);
}

        // Update distance box
        var distanceBox = document.getElementById("distanceBox");
        distanceBox.innerHTML = "Closest Marker: " + closestDistance + " feet";

        // Update border color based on threshold
        if (closestDistance <= thresholdFeet) {
          distanceBox.classList.add("within-threshold");

          // Delay before switching to the tour page
          setTimeout(function () {
            window.location.href = closestLocation.htmlFile;
          }, 2000); // 3 seconds delay
        } else {
          distanceBox.classList.remove("within-threshold");
        }
      }

      function onLocationError(e) {
        alert("Failed to access your location. Please make sure location services are enabled and try again.");
      }

      map.on("locationfound", updateUserLocation);
      map.on("locationerror", onLocationError);

      map.locate({
        watch: true,
        enableHighAccuracy: true,
        maximumAge: 0,
      });

// Load the locations data dynamically
var script = document.createElement("script");
script.src = "/locations_1.js?v=" + Date.now(); // Append cache-busting query parameter
script.addEventListener("load", function () {
  // Once the script is loaded, the 'locations' array will be available
  // and updateUserLocation function can access it.

  // Add tour markers
  for (var i = 0; i < locations.length; i++) {
    var location = locations[i];
    var locationLatLng = L.latLng(location.lat, location.lng);
    var marker = L.marker(locationLatLng).addTo(map);
    marker.bindPopup("<b>" + location.name + "</b>");
  }
});
document.body.appendChild(script);


      // Handle exit button click
      var exitButton = document.querySelector('.exit-button');
      exitButton.addEventListener('click', function () {
        window.location.href = '/index.html';
      });
    });

    });
    });
  </script>
</body>
</html>
