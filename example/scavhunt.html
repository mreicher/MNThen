<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minnesota Then Scavenger Hunt</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        #distanceBox {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 18px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            font-weight: 600;
            z-index: 1000;
            border: 2px solid #00008B;
        }
        .custom-pin-icon {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .pin-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) rotate(-45deg);
            width: 20px;
            height: 20px;
            border-radius: 50% 50% 50% 0;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.1);
            background-color: #007bff;
        }
        .lochunt-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .lochunt-container img {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .trivia-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        #stopSelector {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .map-buttons {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
            z-index: 1000;
        }
        .map-button {
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            color: #00008B;
        }
        .navigation-tips {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2001;
            display: none;
            max-width: 90%;
            width: 400px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            #distanceBox {
                font-size: 14px;
                padding: 6px 12px;
            }
            .map-buttons {
                bottom: 10px;
            }
            .map-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .navigation-tips {
                max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="distanceBox">Initializing...</div>
    <div id="stopSelector">
        <label for="stopCount">Number of stops:</label>
        <select id="stopCount" class="form-select">
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
        </select>
        <button id="startHunt" class="btn btn-primary mt-2">Start Hunt</button>
    </div>
    <div class="lochunt-container">
        <img id="locationImage" src="" alt="Location Image" class="img-fluid">
        <h2 id="locationTitle" class="mt-3 mb-2"></h2>
        <p id="locationCity" class="text-muted mb-1"></p>
        <p id="locationCreator" class="text-muted mb-3"></p>
        <audio id="locationAudio" controls class="w-100 mb-3"></audio>
        <div class="trivia-container" style="display: none;">
            <h3 class="mb-3">Trivia Question</h3>
            <p id="triviaQuestion" class="mb-3"></p>
            <div id="triviaOptions" class="d-grid gap-2"></div>
        </div>
    </div>
    <div class="map-buttons">
        <button id="recenterButton" class="map-button"><i class="fas fa-crosshairs"></i></button>
        <button id="returnButton" class="map-button"><i class="fas fa-sign-out-alt"></i></button>
        <button id="tipsButton" class="map-button"><i class="fas fa-question-circle"></i></button>
    </div>
    <div class="navigation-tips">
        <button class="close-button">&times;</button>
        <h3>Navigation Tips</h3>
        <ul>
            <li>Use the map to navigate to the marked locations.</li>
            <li>The distance box shows how far you are from the current location.</li>
            <li>Tap the recenter button to focus on your current position.</li>
            <li>When you're within 20 feet of a location, you'll be able to interact with it.</li>
            <li>Complete the trivia question to move to the next location.</li>
        </ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="locations_h.js"></script>
    <script>
        let map, userMarker, locationMarker;
        let currentLocationIndex = 0;
        let visitedLocations = [];
        let gameLocations = [];

        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([44.9778, -93.2650], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            userMarker = L.circleMarker([0, 0], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 10 }).addTo(map);
        }

        function startHunt() {
            const stopCount = parseInt(document.getElementById('stopCount').value);
            gameLocations = getRandomLocations(stopCount);
            document.getElementById('stopSelector').style.display = 'none';
            currentLocationIndex = 0;
            loadNextLocation();
        }

        function getRandomLocations(count) {
            const shuffled = locations_h.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function loadNextLocation() {
            if (currentLocationIndex < gameLocations.length) {
                const location = gameLocations[currentLocationIndex];
                if (locationMarker) {
                    map.removeLayer(locationMarker);
                }
                locationMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'custom-pin-icon',
                        html: '<div class="pin-head"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                }).addTo(map);
                locationMarker.bindPopup(`<b>${location.name}</b>`);
                map.setView([location.lat, location.lng], 15);
                updateDistanceBox();
            } else {
                showCongratulations();
            }
        }

        function updateDistanceBox() {
            if (userMarker && locationMarker) {
                const distance = userMarker.getLatLng().distanceTo(locationMarker.getLatLng());
                const distanceFeet = distance * 3.28084;
                let distanceText;
                if (distanceFeet < 5280) {
                    distanceText = `${Math.round(distanceFeet)} feet`;
                } else {
                    const distanceMiles = distanceFeet / 5280;
                    distanceText = `${distanceMiles.toFixed(2)} miles`;
                }
                document.getElementById('distanceBox').innerText = `Distance: ${distanceText}`;
                if (distanceFeet <= 20) {
                    showLocationHunt();
                }
            }
        }

        function showLocationHunt() {
            const location = gameLocations[currentLocationIndex];
            document.querySelector('.lochunt-container').style.display = 'flex';
            document.getElementById('locationImage').src = location.image;
            const locationTitle = document.getElementById('locationTitle');
            locationTitle.innerHTML = `<a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank">${location.name}</a>`;
            document.getElementById('locationCity').innerText = location.city;
            document.getElementById('locationCreator').innerText = `Created by: ${location.creator}`;
            document.getElementById('locationAudio').src = location.audio;
            document.getElementById('locationAudio').play();
            document.getElementById('locationAudio').onended = showTriviaQuestion;
        }

        function showTriviaQuestion() {
            const location = gameLocations[currentLocationIndex];
            const triviaContainer = document.querySelector('.trivia-container');
            triviaContainer.style.display = 'block';
            document.getElementById('triviaQuestion').innerText = location.trivia.question;
            const optionsContainer = document.getElementById('triviaOptions');
            optionsContainer.innerHTML = '';
            location.trivia.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerText = option;
                button.classList.add('btn', 'btn-outline-primary', 'mb-2');
                button.onclick = () => checkAnswer(index);
                optionsContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex) {
            const location = gameLocations[currentLocationIndex];
            if (selectedIndex === location.trivia.answer) {
                alert('Correct! Moving to the next location.');
                visitedLocations.push(currentLocationIndex);
                currentLocationIndex++;
                document.querySelector('.lochunt-container').style.display = 'none';
                loadNextLocation();
            } else {
                alert('Incorrect. Try again!');
            }
        }

        function showCongratulations() {
            alert('Congratulations! You have completed the scavenger hunt!');
            currentLocationIndex = 0;
            visitedLocations = [];
            document.getElementById('stopSelector').style.display = 'block';
        }

        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userMarker.setLatLng([lat, lng]);
            updateDistanceBox();
        }

        function handleLocationError(error) {
            console.error("Error getting user location:", error);
            alert("Unable to get your location. Please enable location services and refresh the page.");
        }

        function recenterMap() {
            if (userMarker.getLatLng()) {
                map.setView(userMarker.getLatLng(), 15);
            }
        }

        function returnToIndex() {
            if (confirm("Are you sure you want to end the hunt and return to the index?")) {
                window.location.href = "index.html";
            }
        }

        function toggleNavigationTips() {
            const tipsElement = document.querySelector('.navigation-tips');
            tipsElement.style.display = tipsElement.style.display === 'none' ? 'block' : 'none';
        }

        initMap();
        document.getElementById('startHunt').addEventListener('click', startHunt);
        document.getElementById('recenterButton').addEventListener('click', recenterMap);
        document.getElementById('returnButton').addEventListener('click', returnToIndex);
        document.getElementById('tipsButton').addEventListener('click', toggleNavigationTips);
        document.querySelector('.navigation-tips .close-button').addEventListener('click', toggleNavigationTips);

        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userMarker.setLatLng([lat, lng]);
            map.setView([lat, lng], 15);
        }, handleLocationError);

        navigator.geolocation.watchPosition(updateUserLocation, handleLocationError, {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000
        });
    </script>
</body>
</html>
