<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minnesota Then Scavenger Hunt</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #3f51b5;
        --secondary-color: #7986cb;
        --text-color: #333;
        --background-color: #f5f5f5;
    }

    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: 'Arial', sans-serif;
        color: var(--text-color);
        background-color: var(--background-color);
    }

    #map {
        height: 100vh;
        width: 100%;
    }

    #distanceBox {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        font-size: 18px;
        font-weight: 600;
        z-index: 1000;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        transition: all 0.3s ease;
    }

    .custom-pin-icon {
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    .pin-head {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%) rotate(-45deg);
        width: 24px;
        height: 24px;
        border-radius: 50% 50% 50% 0;
        border: 3px solid white;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
        background-color: var(--secondary-color);
        transition: all 0.3s ease;
    }
    
    .popup-content {
        text-align: center;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.025);
    }

    .popup-content img {
        max-width: 100%;
        height: auto;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.025);
    }

    .popup-content h4 {
        margin: 10px 0;
        color: var(--primary-color);
        font-size: 1.2em;
    }

    .popup-content a {
        text-decoration: none;
        color: var(--primary-color);
    }

    .directions-link {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white !important;
        border-radius: 25px;
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0,0,0,0.025);
    }

    .directions-link:hover {
        background-color: var(--secondary-color);
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    .directions-link i {
        margin-right: 5px;
    }

    @media (max-width: 768px) {
        .popup-content {
            padding: 10px;
        }

        .popup-content h4 {
            font-size: 1.1em;
        }

        .directions-link {
            padding: 8px 15px;
            font-size: 0.9em;
        }
    }

        #stopSelector {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        max-width: 250px;
        width: calc(100% - 40px);
    }

    #stopSelector:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    #stopSelector label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--primary-color);
    }

    #stopSelector select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background-color: #fff;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    #stopSelector select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
    }

    #startHunt {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background-color: var(--primary-color);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    }

    #startHunt:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        #stopSelector {
            top: 10px;
            left: 10px;
            padding: 15px;
            max-width: calc(100% - 20px);
        }

        #stopSelector label {
            font-size: 14px;
        }

        #stopSelector select,
        #startHunt {
            font-size: 14px;
            padding: 8px;
        }
    }
    
    .lochunt-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 2000;
        display: none;
        flex-direction: column;
        align-items: center;
        padding: 30px;
        overflow-y: auto;
    }

    .lochunt-container img {
        max-width: 100%;
        height: auto;
        margin-bottom: 25px;
        border-radius: 15px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .trivia-container {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        width: 100%;
    }

    #stopSelector {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .map-buttons {
        position: fixed;
        bottom: 30px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-around;
        padding: 0 30px;
        z-index: 1000;
    }

    .map-button {
        background-color: var(--primary-color);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        font-size: 24px;
        color: white;
        transition: all 0.3s ease;
    }

    .map-button:hover {
        background-color: var(--secondary-color);
        transform: scale(1.1);
    }

    .navigation-tips {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 2001;
        display: none;
        max-width: 90%;
        width: 450px;
    }

    .close-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--primary-color);
        transition: color 0.3s ease;
    }

    .close-button:hover {
        color: var(--secondary-color);
    }

    #congratulations {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 3000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 30px;
        text-align: center;
    }

    #congratulations h2 {
        font-size: 36px;
        color: var(--primary-color);
        margin-bottom: 20px;
    }

    #congratulations p {
        font-size: 18px;
        margin-bottom: 30px;
    }

    #congratulations button {
        padding: 12px 24px;
        font-size: 18px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #congratulations button:hover {
        background-color: var(--secondary-color);
    }

    @media (max-width: 768px) {
        #distanceBox {
            font-size: 16px;
            padding: 8px 16px;
            top: 15px;
            right: 15px;
        }

        .map-buttons {
            bottom: 20px;
        }

        .map-button {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .navigation-tips {
            max-width: 95%;
            padding: 20px;
        }

        #congratulations h2 {
            font-size: 28px;
        }

        #congratulations p {
            font-size: 16px;
        }

        #congratulations button {
            font-size: 16px;
            padding: 10px 20px;
        }
    }
</style>
</head>
<body>
    <div id="map"></div>
    <div id="distanceBox">Initializing...</div>
<div id="stopSelector">
    <label for="stopCount">Number of stops:</label>
    <select id="stopCount" class="form-select">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
    </select>
    <button id="startHunt" class="btn btn-primary mt-2">Start Hunt</button>
</div>
    <div class="lochunt-container">
        <img id="locationImage" src="" alt="Location Image" class="img-fluid">
        <h2 id="locationTitle" class="mt-3 mb-2"></h2>
        <p id="locationCity" class="text-muted mb-1"></p>
        <p id="locationCreator" class="text-muted mb-3"></p>
        <audio id="locationAudio" controls class="w-100 mb-3"></audio>
        <div class="trivia-container" style="display: none;">
            <h3 class="mb-3">Trivia Question</h3>
            <p id="triviaQuestion" class="mb-3"></p>
            <div id="triviaOptions" class="d-grid gap-2"></div>
        </div>
    </div>
    <div class="map-buttons">
        <button id="recenterButton" class="map-button"><i class="fas fa-crosshairs"></i></button>
        <button id="returnButton" class="map-button"><i class="fas fa-sign-out-alt"></i></button>
        <button id="tipsButton" class="map-button"><i class="fas fa-question-circle"></i></button>
    </div>
    <div class="navigation-tips">
        <button class="close-button">&times;</button>
        <h3>Navigation Tips</h3>
        <ul>
            <li>Use the map to navigate to the marked locations.</li>
            <li>The distance box shows how far you are from the current location.</li>
            <li>Tap the recenter button to focus on your current position.</li>
            <li>When you're within 20 feet of a location, you'll be able to interact with it.</li>
            <li>Complete the trivia question to move to the next location.</li>
        </ul>
    </div>
    <div id="congratulations">
        <h2>Congratulations!</h2>
        <p>You have successfully completed the Minnesota Then Scavenger Hunt!</p>
        <button onclick="restartHunt()">Start a New Hunt</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="locations_h.js"></script>
    <script>
        let map, userMarker, locationMarker;
        let currentLocationIndex = 0;
        let visitedLocations = [];
        let gameLocations = [];

        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([44.9778, -93.2650], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            userMarker = L.circleMarker([0, 0], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 10 }).addTo(map);
        }

        function startHunt() {
            const stopCount = parseInt(document.getElementById('stopCount').value);
            gameLocations = getRandomLocations(stopCount);
            document.getElementById('stopSelector').style.display = 'none';
            currentLocationIndex = 0;
            loadNextLocation();
        }

        function getRandomLocations(count) {
            const shuffled = locations_h.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

let inactivityTimer;

function loadNextLocation() {
    if (currentLocationIndex < gameLocations.length) {
        const location = gameLocations[currentLocationIndex];
        if (locationMarker) {
            map.removeLayer(locationMarker);
        }
        locationMarker = L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                className: 'custom-pin-icon',
                html: '<div class="pin-head"></div>',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            })
        }).addTo(map);

        var popupContent = `
          <div class="popup-content">
            <img src="${location.image}" alt="${location.name}" style="width: 100%; max-width: 200px; height: auto;">
            <h4><a href="${location.link}" target="_blank">${location.name}</a></h4>
            <a href="#" class="directions-link" data-lat="${location.lat}" data-lng="${location.lng}">
              <i class="fas fa-directions"></i> Get Directions
            </a>
          </div>
        `;

        locationMarker.bindPopup(popupContent);
        
        locationMarker.on('popupopen', function() {
            document.querySelector('.directions-link').addEventListener('click', function(e) {
                e.preventDefault();
                const lat = this.getAttribute('data-lat');
                const lng = this.getAttribute('data-lng');
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
            });
        });

        map.setView([location.lat, location.lng], 15);
        updateDistanceBox();

        // Clear any existing inactivity timer
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }

        // Set a new inactivity timer
        inactivityTimer = setTimeout(() => {
            if (userMarker.getLatLng()) {
                map.setView(userMarker.getLatLng(), 15);
            }
        }, 30000); // 30 seconds

        // Reset the timer on map interaction
        map.on('movestart', resetInactivityTimer);
        map.on('zoomstart', resetInactivityTimer);
        map.on('click', resetInactivityTimer);
    } else {
        showCongratulations();
    }
}

function resetInactivityTimer() {
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    inactivityTimer = setTimeout(() => {
        if (userMarker.getLatLng()) {
            map.setView(userMarker.getLatLng(), 15);
        }
    }, 30000); // 30 seconds
}

        function updateDistanceBox() {
            if (userMarker && locationMarker) {
                const distance = userMarker.getLatLng().distanceTo(locationMarker.getLatLng());
                const distanceFeet = distance * 3.28084;
                let distanceText;
                if (distanceFeet < 5280) {
                    distanceText = `${Math.round(distanceFeet)} feet`;
                } else {
                    const distanceMiles = distanceFeet / 5280;
                    distanceText = `${distanceMiles.toFixed(2)} miles`;
                }
                document.getElementById('distanceBox').innerText = `Distance: ${distanceText}`;
                if (distanceFeet <= 20) {
                    showLocationHunt();
                }
            }
        }

        function showLocationHunt() {
            const location = gameLocations[currentLocationIndex];
            document.querySelector('.lochunt-container').style.display = 'flex';
            document.getElementById('locationImage').src = location.image;
            const locationTitle = document.getElementById('locationTitle');
            locationTitle.innerHTML = `<a href="https://www.google.com/maps/dir/?api=1&destination=${location.lat},${location.lng}" target="_blank">${location.name}</a>`;
            document.getElementById('locationCity').innerText = location.city;
            document.getElementById('locationCreator').innerText = `Created by: ${location.creator}`;
            document.getElementById('locationAudio').src = location.audio;
            document.getElementById('locationAudio').play();
            document.getElementById('locationAudio').onended = showTriviaQuestion;
        }

        function showTriviaQuestion() {
            const location = gameLocations[currentLocationIndex];
            const triviaContainer = document.querySelector('.trivia-container');
            triviaContainer.style.display = 'block';
            document.getElementById('triviaQuestion').innerText = location.trivia.question;
            const optionsContainer = document.getElementById('triviaOptions');
            optionsContainer.innerHTML = '';
            location.trivia.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerText = option;
                button.classList.add('btn', 'btn-outline-primary', 'mb-2');
                button.onclick = () => checkAnswer(index);
                optionsContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex) {
            const location = gameLocations[currentLocationIndex];
            if (selectedIndex === location.trivia.answer) {
                alert('Correct! Moving to the next location.');
                visitedLocations.push(currentLocationIndex);
                currentLocationIndex++;
                document.querySelector('.lochunt-container').style.display = 'none';
                loadNextLocation();
            } else {
                alert('Incorrect. Try again!');
            }
        }

        function showCongratulations() {
            document.getElementById('congratulations').style.display = 'flex';
        }

        function restartHunt() {
            document.getElementById('congratulations').style.display = 'none';
            currentLocationIndex = 0;
            visitedLocations = [];
            document.getElementById('stopSelector').style.display = 'block';
        }

        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userMarker.setLatLng([lat, lng]);
            updateDistanceBox();
        }

        function handleLocationError(error) {
            console.error("Error getting user location:", error);
            alert("Unable to get your location. Please enable location services and refresh the page.");
        }

        function recenterMap() {
            if (userMarker.getLatLng()) {
                map.setView(userMarker.getLatLng(), 15);
            }
        }

        function returnToIndex() {
            if (confirm("Are you sure you want to end the hunt and return to the index?")) {
                window.location.href = "index.html";
            }
        }

        function toggleNavigationTips() {
            const tipsElement = document.querySelector('.navigation-tips');
            tipsElement.style.display = tipsElement.style.display === 'none' ? 'block' : 'none';
        }

        initMap();
        
        document.addEventListener('DOMContentLoaded', function() {
    const startHuntButton = document.getElementById('startHunt');
    if (startHuntButton) {
        startHuntButton.addEventListener('click', startHunt);
    } else {
        console.error('Start Hunt button not found');
    }
});

        document.getElementById('recenterButton').addEventListener('click', recenterMap);
        document.getElementById('returnButton').addEventListener('click', returnToIndex);
        document.getElementById('tipsButton').addEventListener('click', toggleNavigationTips);
        document.querySelector('.navigation-tips .close-button').addEventListener('click', toggleNavigationTips);

        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userMarker.setLatLng([lat, lng]);
            map.setView([lat, lng], 15);
        }, handleLocationError);

        navigator.geolocation.watchPosition(updateUserLocation, handleLocationError, {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000
        });
    </script>
</body>
</html>
