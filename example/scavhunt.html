<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Minnesota Then Scavenger Hunt</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        #distanceBox {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 18px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: 600;
            z-index: 1000;
        }
        .custom-pin-icon {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .pin-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) rotate(-45deg);
            width: 20px;
            height: 20px;
            border-radius: 50% 50% 50% 0;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.1);
            background-color: #007bff;
        }
        .lochunt-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .lochunt-container img {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .trivia-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        #stopSelector {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="distanceBox">Initializing...</div>
    <div id="stopSelector">
        <label for="stopCount">Number of stops:</label>
        <select id="stopCount" class="form-select">
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
        </select>
        <button id="startHunt" class="btn btn-primary mt-2">Start Hunt</button>
    </div>
    <div class="lochunt-container">
        <img id="locationImage" src="" alt="Location Image" class="img-fluid">
        <h2 id="locationTitle" class="mt-3"></h2>
        <p id="locationCity" class="text-muted"></p>
        <p id="locationCreator" class="text-muted"></p>
        <audio id="locationAudio" controls class="mt-3 mb-3"></audio>
        <div class="trivia-container" style="display: none;">
            <h3 class="mb-3">Trivia Question</h3>
            <p id="triviaQuestion" class="mb-3"></p>
            <div id="triviaOptions" class="d-grid gap-2"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="locations_h.js"></script>
    <script>
        let map, userMarker, locationMarker;
        let currentLocationIndex = 0;
        let visitedLocations = [];
        let gameLocations = [];

        function initMap() {
            map = L.map('map').setView([44.9778, -93.2650], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            userMarker = L.circleMarker([0, 0], { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: 10 }).addTo(map);
        }

        function startHunt() {
            const stopCount = parseInt(document.getElementById('stopCount').value);
            gameLocations = getRandomLocations(stopCount);
            document.getElementById('stopSelector').style.display = 'none';
            currentLocationIndex = 0;
            loadNextLocation();
        }

        function getRandomLocations(count) {
            const shuffled = locations_h.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function loadNextLocation() {
            if (currentLocationIndex < gameLocations.length) {
                const location = gameLocations[currentLocationIndex];
                if (locationMarker) {
                    map.removeLayer(locationMarker);
                }
                locationMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'custom-pin-icon',
                        html: '<div class="pin-head"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                }).addTo(map);
                map.setView([location.lat, location.lng], 15);
                updateDistanceBox();
            } else {
                showCongratulations();
            }
        }

        function updateDistanceBox() {
            if (userMarker && locationMarker) {
                const distance = userMarker.getLatLng().distanceTo(locationMarker.getLatLng());
                document.getElementById('distanceBox').innerText = `Distance: ${Math.round(distance)} meters`;
                if (distance <= 20) {
                    showLocationHunt();
                }
            }
        }

        function showLocationHunt() {
            const location = gameLocations[currentLocationIndex];
            document.querySelector('.lochunt-container').style.display = 'flex';
            document.getElementById('locationImage').src = location.image;
            document.getElementById('locationTitle').innerText = location.name;
            document.getElementById('locationCity').innerText = location.city;
            document.getElementById('locationCreator').innerText = `Created by: ${location.creator}`;
            document.getElementById('locationAudio').src = location.audio;
            document.getElementById('locationAudio').play();
            document.getElementById('locationAudio').onended = showTriviaQuestion;
        }

        function showTriviaQuestion() {
            const location = gameLocations[currentLocationIndex];
            const triviaContainer = document.querySelector('.trivia-container');
            triviaContainer.style.display = 'block';
            document.getElementById('triviaQuestion').innerText = location.trivia.question;
            const optionsContainer = document.getElementById('triviaOptions');
            optionsContainer.innerHTML = '';
            location.trivia.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerText = option;
                button.classList.add('btn', 'btn-outline-primary', 'mb-2');
                button.onclick = () => checkAnswer(index);
                optionsContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedIndex) {
            const location = gameLocations[currentLocationIndex];
            if (selectedIndex === location.trivia.answer) {
                alert('Correct! Moving to the next location.');
                visitedLocations.push(currentLocationIndex);
                currentLocationIndex++;
                document.querySelector('.lochunt-container').style.display = 'none';
                loadNextLocation();
            } else {
                alert('Incorrect. Try again!');
            }
        }

        function showCongratulations() {
            alert('Congratulations! You have completed the scavenger hunt!');
            // Reset the game
            currentLocationIndex = 0;
            visitedLocations = [];
            document.getElementById('stopSelector').style.display = 'block';
        }

        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            userMarker.setLatLng([lat, lng]);
            updateDistanceBox();
        }

        function handleLocationError(error) {
            console.error("Error getting user location:", error);
            alert("Unable to get your location. Please enable location services and refresh the page.");
        }

        initMap();
        document.getElementById('startHunt').addEventListener('click', startHunt);
        navigator.geolocation.watchPosition(updateUserLocation, handleLocationError, {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000
        });
    </script>
</body>
</html>
