<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MN Then ‚Äì Blog Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
  <style>
    .hidden { display: none !important; }
    .blog-card { margin-bottom: 1rem; }
    .form-section { background: #f8f9fa; padding: 20px; border-radius: 5px; }
    #blog-list { max-height: 600px; overflow-y: auto; }
    .edit-mode { background-color: #fff9c4 !important; }
    .copied { color: #28a745 !important; }
    input, textarea, select { font-size: 0.95rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">Blog Admin</span>
      <div id="auth-status" class="text-light"></div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Login Section -->
    <div id="login-container">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow">
            <div class="card-body">
              <h2 class="card-title text-center mb-4">Admin Access</h2>
              <form id="login-form">
                <div class="mb-3">
                  <label class="form-label">Passcode</label>
                  <input type="password" class="form-control" id="passcode" required autocomplete="off">
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Enter</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-content" class="hidden mt-4">
      <div class="row">
        <!-- Form Column -->
        <div class="col-lg-8">
          <div class="form-section mb-4">
            <h2 id="form-title"><i class="fas fa-edit"></i> Create New Blog Entry</h2>
            <form id="blog-form">
              <input type="hidden" id="edit-index">

              <div class="row g-3 mb-3">
                <div class="col-md-8">
                  <label class="form-label">Headline</label>
                  <input type="text" class="form-control" id="headline" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Icon (Font Awesome)</label>
                  <select class="form-select" id="icon" required>
                    <option value="fa-user">üë§ Person</option>
                    <option value="fa-building">üèõÔ∏è Place</option>
                    <option value="fa-calendar">üìÖ Event</option>
                    <option value="fa-book">üìñ Article</option>
                    <option value="fa-music">üéµ Music</option>
                    <option value="fa-beer">üç∫ Beer</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Blurb (1 sentence)</label>
                <textarea class="form-control" id="blurb" rows="2" required></textarea>
                <small class="text-muted">Used in feeds, related articles, search previews.</small>
              </div>

              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label class="form-label">Author</label>
                  <input type="text" class="form-control" id="author" value="Matt Reicher" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Date (YYYY-MM-DD or Month D, YYYY)</label>
                  <input type="text" class="form-control" id="date" placeholder="e.g. November 3, 2025" required>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Image URL</label>
                <input type="url" class="form-control" id="image" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Article URL</label>
                <input type="url" class="form-control" id="url" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Keywords (comma-separated)</label>
                <textarea class="form-control" id="keywords" rows="2" placeholder="e.g. cassius, minneapolis, civil rights"></textarea>
                <small class="text-muted">Include 'all' at end for global search visibility.</small>
              </div>

              <div class="mt-4 d-flex justify-content-between">
                <button type="button" id="cancel-edit" class="btn btn-secondary hidden">
                  <i class="fas fa-times"></i> Cancel Edit
                </button>
                <div>
                  <button type="button" id="export-btn" class="btn btn-success me-2">
                    <i class="fas fa-download"></i> Export blog_articles.js
                  </button>
                  <button type="submit" id="save-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Entry
                  </button>
                </div>
                <button type="button" id="logout-btn" class="btn btn-outline-dark">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- List Column -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h3><i class="fas fa-list"></i> Blog Entries (<span id="count">0</span>)</h3>
              <div class="input-group mb-3">
                <input type="text" id="search-blogs" class="form-control" placeholder="Search...">
                <button class="btn btn-outline-secondary" type="button" id="clear-search">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div id="blog-list">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="text-muted mt-2">Loading blog_articles.js‚Ä¶</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üîê Config
    const ADMIN_PASS_HASH = "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824"; // SHA-256("hello")
    const BLOG_FILE = "blog_articles.js";

    // DOM refs
    const loginContainer = document.getElementById('login-container');
    const adminContent = document.getElementById('admin-content');
    const authStatus = document.getElementById('auth-status');
    const blogList = document.getElementById('blog-list');
    const countEl = document.getElementById('count');
    const blogForm = document.getElementById('blog-form');
    const formTitle = document.getElementById('form-title');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const saveBtn = document.getElementById('save-btn');
    const exportBtn = document.getElementById('export-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const searchInput = document.getElementById('search-blogs');
    const clearSearchBtn = document.getElementById('clear-search');

    let blogEntries = [];
    let currentEditIndex = null;

    // üîê Auth
    document.getElementById('login-form').addEventListener('submit', e => {
      e.preventDefault();
      const pass = document.getElementById('passcode').value;
      if (sha256(pass) === ADMIN_PASS_HASH) {
        loginContainer.classList.add('hidden');
        adminContent.classList.remove('hidden');
        authStatus.textContent = "üîí Authenticated";
        loadBlogEntries();
      } else {
        alert("Incorrect passcode.");
      }
    });

    logoutBtn.addEventListener('click', () => {
      loginContainer.classList.remove('hidden');
      adminContent.classList.add('hidden');
      authStatus.textContent = "";
      document.getElementById('passcode').value = '';
    });

    // üì• Load blog_articles.js
    function loadBlogEntries() {
      blogList.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="text-muted mt-2">Loading ${BLOG_FILE}‚Ä¶</p>
        </div>
      `;

      fetch(BLOG_FILE)
        .then(response => {
          if (!response.ok) throw new Error(`${BLOG_FILE} not found`);
          return response.text();
        })
        .then(js => {
          // Extract JS array from `const blogArticles = [...]`
          const match = js.match(/blogArticles\s*=\s*(\[.*?\]);?\s*$/s);
          if (!match) throw new Error("blogArticles array not found");
          blogEntries = JSON.parse(match[1].replace(/,\s*\]/g, ']')); // Handle trailing commas
          renderBlogList(blogEntries);
        })
        .catch(err => {
          blogList.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        });
    }

    // üñºÔ∏è Render list
    function renderBlogList(entries) {
      countEl.textContent = entries.length;
      
      if (entries.length === 0) {
        blogList.innerHTML = '<p class="text-muted text-center py-4">No entries</p>';
        return;
      }

      blogList.innerHTML = entries.map((entry, i) => `
        <div class="card blog-card">
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-start">
              <div style="flex: 1; min-width: 0;">
                <h6 class="mb-1 text-truncate">${entry.headline}</h6>
                <small class="text-muted d-block">${entry.date} ‚Ä¢ ${entry.author}</small>
                <small class="text-muted d-block text-truncate">${entry.blurb}</small>
              </div>
              <div class="ms-2">
                <button class="btn btn-sm btn-outline-primary edit-btn me-1" data-index="${i}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // Add listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editEntry(btn.dataset.index));
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteEntry(btn.dataset.index));
      });
    }

    // ‚úèÔ∏è Edit
    function editEntry(index) {
      const entry = blogEntries[index];
      if (!entry) return;

      currentEditIndex = parseInt(index);
      document.getElementById('edit-index').value = index;
      
      document.getElementById('headline').value = entry.headline || '';
      document.getElementById('blurb').value = entry.blurb || '';
      document.getElementById('icon').value = entry.icon || 'fa-user';
      document.getElementById('author').value = entry.author || '';
      document.getElementById('date').value = entry.date || '';
      document.getElementById('image').value = entry.image?.trim() || '';
      document.getElementById('url').value = entry.url?.trim() || '';
      document.getElementById('keywords').value = (entry.keywords || []).join(', ');

      formTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Blog Entry';
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Update';
      cancelEditBtn.classList.remove('hidden');
      blogForm.classList.add('edit-mode');
      document.getElementById('headline').focus();
    }

    // üóëÔ∏è Delete
    function deleteEntry(index) {
      if (!confirm("Delete this blog entry?")) return;
      blogEntries.splice(index, 1);
      renderBlogList(blogEntries);
      alert("Deleted.");
    }

    // ‚ùå Cancel
    cancelEditBtn.addEventListener('click', () => {
      currentEditIndex = null;
      blogForm.reset();
      document.getElementById('edit-index').value = '';
      formTitle.innerHTML = '<i class="fas fa-edit"></i> Create New Blog Entry';
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Entry';
      cancelEditBtn.classList.add('hidden');
      blogForm.classList.remove('edit-mode');
    });

    // üíæ Save
    blogForm.addEventListener('submit', e => {
      e.preventDefault();

      const entry = {
        headline: document.getElementById('headline').value.trim(),
        blurb: document.getElementById('blurb').value.trim(),
        icon: document.getElementById('icon').value,
        author: document.getElementById('author').value.trim(),
        date: document.getElementById('date').value.trim(),
        image: document.getElementById('image').value.trim(),
        url: document.getElementById('url').value.trim(),
        keywords: document.getElementById('keywords').value.split(',').map(k => k.trim()).filter(k => k)
      };

      if (!entry.headline || !entry.url || !entry.date) {
        alert("Headline, URL, and Date are required.");
        return;
      }

      if (currentEditIndex !== null) {
        blogEntries[currentEditIndex] = entry;
        alert("Updated.");
      } else {
        blogEntries.push(entry);
        alert("Added.");
      }

      renderBlogList(blogEntries);
      cancelEditBtn.click(); // reset form
    });

    // üì§ Export
    exportBtn.addEventListener('click', () => {
      const jsContent = `const blogArticles = ${JSON.stringify(blogEntries, null, 2)};`;
      const blob = new Blob([jsContent], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'blog_articles.js';
      a.click();
      
      URL.revokeObjectURL(url);
      
      const orig = exportBtn.innerHTML;
      exportBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
      exportBtn.classList.replace('btn-success', 'btn-secondary');
      setTimeout(() => {
        exportBtn.innerHTML = orig;
        exportBtn.classList.replace('btn-secondary', 'btn-success');
      }, 1500);
    });

    // üîç Search
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      if (!term) {
        renderBlogList(blogEntries);
        return;
      }
      const filtered = blogEntries.filter(e =>
        e.headline.toLowerCase().includes(term) ||
        e.blurb.toLowerCase().includes(term) ||
        e.keywords?.some(k => k.toLowerCase().includes(term))
      );
      renderBlogList(filtered);
    });

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      renderBlogList(blogEntries);
    });

    // ‚úÖ Focus on login
    document.getElementById('passcode').focus();
  </script>
</body>
</html>
