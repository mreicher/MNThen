<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MN Then - Marker Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .auth-only { display: none; }
    .logged-in .auth-only { display: block; }
    .logged-out .auth-required { display: none; }
    #map-preview { height: 300px; background: #eee; margin-bottom: 20px; }
    .location-card { margin-bottom: 15px; }
    .form-section { background: #f8f9fa; padding: 20px; border-radius: 5px; }
    .nav-brand { font-weight: 700; }
  </style>
</head>
<body class="logged-out">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand nav-brand">Minnesota Then</span>
      <div id="auth-status" class="text-light"></div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Login Section -->
    <div id="login-container" class="auth-required">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow">
            <div class="card-body">
              <h2 class="card-title text-center mb-4">Admin Login</h2>
              <form id="login-form">
                <div class="mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Password</label>
                  <input type="password" class="form-control" id="password" required>
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Login</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="auth-only">
      <div class="row">
        <div class="col-md-6">
          <div class="form-section mb-4">
            <h2 class="mb-4">Create New Marker</h2>
            <form id="marker-form">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">ID (4 digits)</label>
                  <input type="text" class="form-control" id="id" pattern="\d{4}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">City</label>
                  <input type="text" class="form-control" id="city" required>
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-control" id="name" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Display Title</label>
                <input type="text" class="form-control" id="title" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Coordinates</label>
                <div class="input-group">
                  <input type="number" step="0.0000001" class="form-control" id="lat" placeholder="Latitude" required>
                  <input type="number" step="0.0000001" class="form-control" id="lng" placeholder="Longitude" required>
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Image URL</label>
                <input type="url" class="form-control" id="image" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Audio Path</label>
                <input type="text" class="form-control" id="audio" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Tour Category</label>
                <select class="form-select" id="tours" required>
                  <option value="">Select category</option>
                  <option value="history">History</option>
                  <option value="person">Person</option>
                  <option value="event">Event</option>
                  <option value="place">Place</option>
                </select>
              </div>

              <div class="mt-3">
                <label class="form-label">Summary</label>
                <textarea class="form-control" id="summary" rows="3" required></textarea>
              </div>

              <div class="mt-3">
                <label class="form-label">Location Today</label>
                <input type="text" class="form-control" id="today" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Article Link</label>
                <input type="url" class="form-control" id="link" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Image Credit</label>
                <input type="text" class="form-control" id="imageSource" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Additional Info</label>
                <textarea class="form-control" id="additionalInfo" rows="2"></textarea>
              </div>

              <div class="mt-4 d-flex justify-content-between">
                <button type="button" id="preview-btn" class="btn btn-outline-secondary">Preview</button>
                <button type="submit" class="btn btn-primary">Save Marker</button>
                <button type="button" id="logout-btn" class="btn btn-danger">Logout</button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-md-6">
          <div id="map-preview" class="rounded"></div>
          
          <div class="mt-4">
            <h3>Preview</h3>
            <div id="marker-preview" class="card location-card">
              <img id="preview-image" src="" class="card-img-top" alt="Preview" style="display: none;">
              <div class="card-body">
                <h5 id="preview-title" class="card-title"></h5>
                <h6 id="preview-city" class="card-subtitle mb-2 text-muted"></h6>
                <p id="preview-summary" class="card-text"></p>
                <div id="preview-additional" style="display: none;">
                  <hr>
                  <p class="card-text"><small id="preview-additional-info"></small></p>
                </div>
                <p class="card-text"><small class="text-muted" id="preview-imagesource"></small></p>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h3>Existing Locations <span id="location-count" class="badge bg-secondary">0</span></h3>
            <div id="locations-list" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase and App Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-database.js"></script>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
      authDomain: "mnthen-3151d.firebaseapp.com",
      databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com",
      projectId: "mnthen-3151d",
      storageBucket: "mnthen-3151d.appspot.com",
      messagingSenderId: "416231360428",
      appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const locationsRef = database.ref('locations');

    // Authentication State
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is logged in
        document.body.classList.remove('logged-out');
        document.body.classList.add('logged-in');
        document.getElementById('auth-status').innerHTML = `
          <span class="text-light">Logged in as ${user.email}</span>
        `;
        loadLocations();
      } else {
        // User is logged out
        document.body.classList.remove('logged-in');
        document.body.classList.add('logged-out');
        document.getElementById('auth-status').innerHTML = '';
      }
    });

    // Login Form
    document.getElementById('login-form').addEventListener('submit', e => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          alert('Login failed: ' + error.message);
        });
    });

    // Logout Button
    document.getElementById('logout-btn').addEventListener('click', () => {
      auth.signOut();
    });

    // Preview Button
    document.getElementById('preview-btn').addEventListener('click', () => {
      const formData = getFormData();
      showPreview(formData);
    });

    // Save Marker
    document.getElementById('marker-form').addEventListener('submit', e => {
      e.preventDefault();
      
      const markerData = getFormData();
      markerData.createdAt = firebase.database.ServerValue.TIMESTAMP;
      
      // Check if ID already exists
      locationsRef.orderByChild('id').equalTo(markerData.id).once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            alert('Error: A marker with this ID already exists');
            return;
          }
          
          // Save new marker
          locationsRef.push(markerData)
            .then(() => {
              alert('Marker saved successfully!');
              e.target.reset();
              loadLocations();
            })
            .catch(error => {
              alert('Error saving marker: ' + error.message);
            });
        });
    });

    // Load Existing Locations
    function loadLocations() {
      locationsRef.on('value', snapshot => {
        const locationsList = document.getElementById('locations-list');
        locationsList.innerHTML = '';
        let count = 0;
        
        snapshot.forEach(childSnapshot => {
          count++;
          const location = childSnapshot.val();
          const item = document.createElement('div');
          item.className = 'list-group-item location-card';
          item.innerHTML = `
            <div class="d-flex justify-content-between">
              <div>
                <h5>${location.title || 'Untitled'}</h5>
                <small class="text-muted">ID: ${location.id} | ${location.city}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-danger" data-id="${childSnapshot.key}">
                  Delete
                </button>
              </div>
            </div>
          `;
          locationsList.appendChild(item);
        });
        
        document.getElementById('location-count').textContent = count;
        
        // Add delete handlers
        document.querySelectorAll('#locations-list button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const locationId = e.target.dataset.id;
            if (confirm('Delete this location permanently?')) {
              locationsRef.child(locationId).remove();
            }
          });
        });
      });
    }

    // Get Form Data
    function getFormData() {
      return {
        id: document.getElementById('id').value.trim(),
        lat: parseFloat(document.getElementById('lat').value),
        lng: parseFloat(document.getElementById('lng').value),
        name: document.getElementById('name').value.trim(),
        title: document.getElementById('title').value.trim(),
        image: document.getElementById('image').value.trim(),
        city: document.getElementById('city').value.trim(),
        audio: document.getElementById('audio').value.trim(),
        tours: document.getElementById('tours').value,
        summary: document.getElementById('summary').value.trim(),
        today: document.getElementById('today').value.trim(),
        link: document.getElementById('link').value.trim(),
        imageSource: document.getElementById('imageSource').value.trim(),
        additionalInfo: document.getElementById('additionalInfo').value.trim()
      };
    }

    // Show Preview
    function showPreview(data) {
      const previewImage = document.getElementById('preview-image');
      if (data.image) {
        previewImage.src = data.image;
        previewImage.style.display = 'block';
      } else {
        previewImage.style.display = 'none';
      }
      
      document.getElementById('preview-title').textContent = data.title || 'Untitled';
      document.getElementById('preview-city').textContent = data.city || 'No location specified';
      document.getElementById('preview-summary').textContent = data.summary || 'No summary provided';
      
      if (data.additionalInfo) {
        document.getElementById('preview-additional').style.display = 'block';
        document.getElementById('preview-additional-info').textContent = data.additionalInfo;
      } else {
        document.getElementById('preview-additional').style.display = 'none';
      }
      
      document.getElementById('preview-imagesource').textContent = data.imageSource || 'No image credit provided';
      document.getElementById('marker-preview').style.display = 'block';
    }

    // Initialize Leaflet map (optional - uncomment if you want map preview)
    /*
    let map;
    function initMap() {
      map = L.map('map-preview').setView([44.9778, -93.2650], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }
    window.onload = initMap;
    */
  </script>
</body>
</html>
