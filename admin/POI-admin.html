<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MN Then - Marker Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
  <style>
    .hidden { display: none !important; }
    .location-card { margin-bottom: 15px; }
    .form-section { background: #f8f9fa; padding: 20px; border-radius: 5px; }
    #locations-list { max-height: 600px; overflow-y: auto; }
    .edit-mode { background-color: #fff9c4 !important; }
    .coordinates-input { font-family: monospace; }
    .copied { color: #28a745 !important; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">Marker Admin</span>
      <div id="auth-status" class="text-light"></div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Login Section -->
    <div id="login-container">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow">
            <div class="card-body">
              <h2 class="card-title text-center mb-4">Admin Access</h2>
              <form id="login-form">
                <div class="mb-3">
                  <label class="form-label">Passcode</label>
                  <input type="password" class="form-control" id="passcode" required autocomplete="off">
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Enter</button>
                </div>
              </form>
              <div class="mt-3 text-muted small">
                <i class="fas fa-lock"></i> Passcode required to protect historical data.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-content" class="hidden mt-4">
      <div class="row">
        <div class="col-lg-8">
          <div class="form-section mb-4">
            <h2 id="form-title"><i class="fas fa-map-marker-alt"></i> Create New Location Marker</h2>
            <form id="marker-form">
              <input type="hidden" id="edit-key">

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">ID (4 digits)</label>
                  <input type="text" class="form-control" id="id" pattern="\d{4}" maxlength="4" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">City</label>
                  <input type="text" class="form-control" id="city" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Creator</label>
                  <input type="text" class="form-control" id="creator" required>
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label">Full Name (with dates)</label>
                <input type="text" class="form-control" id="name" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Display Title</label>
                <input type="text" class="form-control" id="title" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Coordinates (from Google Maps)</label>
                <div class="input-group">
                  <span class="input-group-text">Lat</span>
                  <input type="text" class="form-control coordinates-input" id="lat"
                         pattern="-?\d{1,3}\.\d{6,15}" required>
                  <span class="input-group-text">Lng</span>
                  <input type="text" class="form-control coordinates-input" id="lng"
                         pattern="-?\d{1,3}\.\d{6,15}" required>
                </div>
                <small class="text-muted">Paste full values (e.g., 44.97775320703125, -93.2654037475586)</small>
              </div>

              <div class="mt-3">
                <label class="form-label">Image URL</label>
                <input type="url" class="form-control" id="image" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Audio Path</label>
                <input type="text" class="form-control" id="audio" placeholder="/audio/1001.mp3" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Tour Category</label>
                <select class="form-select" id="tours" required>
                  <option value="">Select</option>
                  <option value="history">History</option>
                  <option value="person">Person</option>
                  <option value="event">Event</option>
                  <option value="place">Place</option>
                </select>
              </div>

              <div class="mt-3">
                <label class="form-label">Summary</label>
                <textarea class="form-control" id="summary" rows="3" required></textarea>
              </div>

              <div class="mt-3">
                <label class="form-label">Location Today</label>
                <input type="text" class="form-control" id="today" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Article Link</label>
                <input type="url" class="form-control" id="link" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Image Credit / Source</label>
                <input type="text" class="form-control" id="imageSource" required>
              </div>

              <div class="mt-3">
                <label class="form-label">Additional Info (optional)</label>
                <textarea class="form-control" id="additionalInfo" rows="2"></textarea>
              </div>

              <div class="mt-4 d-flex justify-content-between">
                <button type="button" id="cancel-edit" class="btn btn-secondary hidden">
                  <i class="fas fa-times"></i> Cancel Edit
                </button>
                <div>
                  <button type="button" id="export-btn" class="btn btn-success me-2">
                    <i class="fas fa-download"></i> Export locations_main.js
                  </button>
                  <button type="submit" id="save-btn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Marker
                  </button>
                </div>
                <button type="button" id="logout-btn" class="btn btn-outline-dark">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h3><i class="fas fa-list"></i> Locations (<span id="count">0</span>)</h3>
              <div class="input-group mb-3">
                <input type="text" id="search-locations" class="form-control" placeholder="Search...">
                <button class="btn btn-outline-secondary" type="button" id="clear-search">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div id="locations-list">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="text-muted mt-2">Loading locations...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const ADMIN_PASS_HASH = "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824"; // SHA-256("hello")
    const LOCATIONS_FILE = "/locations_main.js";
    
    // DOM Elements
    const loginContainer = document.getElementById('login-container');
    const adminContent = document.getElementById('admin-content');
    const authStatus = document.getElementById('auth-status');
    const locationsList = document.getElementById('locations-list');
    const countEl = document.getElementById('count');
    const markerForm = document.getElementById('marker-form');
    const formTitle = document.getElementById('form-title');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const saveBtn = document.getElementById('save-btn');
    const exportBtn = document.getElementById('export-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const searchInput = document.getElementById('search-locations');
    const clearSearch = document.getElementById('clear-search');

    // State
    let allLocations = [];
    let currentEditKey = null;

    // ===== AUTH =====
    document.getElementById('login-form').addEventListener('submit', e => {
      e.preventDefault();
      const pass = document.getElementById('passcode').value;
      if (sha256(pass) === ADMIN_PASS_HASH) {
        loginContainer.classList.add('hidden');
        adminContent.classList.remove('hidden');
        authStatus.textContent = "ðŸ”’ Authenticated";
        loadLocations();
      } else {
        alert("Incorrect passcode.");
      }
    });

    logoutBtn.addEventListener('click', () => {
      loginContainer.classList.remove('hidden');
      adminContent.classList.add('hidden');
      authStatus.textContent = "";
      document.getElementById('passcode').value = "";
    });

    // ===== LOAD LOCATIONS =====
    function loadLocations() {
      locationsList.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="text-muted mt-2">Loading ${LOCATIONS_FILE}...</p>
        </div>
      `;

      fetch(LOCATIONS_FILE)
        .then(response => {
          if (!response.ok) throw new Error(`${LOCATIONS_FILE} not found`);
          return response.text();
        })
        .then(js => {
          // Safely extract data without polluting global scope
          const dataMatch = js.match(/LOCATIONS_DATA\s*=\s*(\[[\s\S]*?\]);?\s*$/m);
          if (!dataMatch) throw new Error("LOCATIONS_DATA not found in file");
          const jsonStr = dataMatch[1];
          allLocations = JSON.parse(jsonStr);
          // Ensure each has a key (for editing)
          allLocations.forEach(loc => {
            loc.key = loc.key || generateKey();
          });
          renderLocations(allLocations);
        })
        .catch(err => {
          locationsList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> Failed to load ${LOCATIONS_FILE}: ${err.message}
              <br><small>Ensure the file exists in the same folder as this admin page.</small>
            </div>
          `;
        });
    }

    // ===== RENDER =====
    function renderLocations(locations) {
      countEl.textContent = locations.length;
      
      if (locations.length === 0) {
        locationsList.innerHTML = '<p class="text-muted text-center py-4">No locations</p>';
        return;
      }

      locationsList.innerHTML = locations.map(loc => `
        <div class="card location-card mb-2">
          <div class="card-body p-2">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-0">${loc.title || 'Untitled'}</h6>
                <small class="text-muted d-block">ID ${loc.id} â€¢ ${loc.city}</small>
                <small class="coordinates text-muted coordinates-item" data-coords="${loc.lat}, ${loc.lng}">
                  ${loc.lat}, ${loc.lng}
                </small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary edit-btn me-1" data-key="${loc.key}">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-btn" data-key="${loc.key}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      // Add listeners
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editLocation(btn.dataset.key));
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteLocation(btn.dataset.key));
      });
      document.querySelectorAll('.coordinates-item').forEach(el => {
        el.addEventListener('click', copyCoords);
      });
    }

    // ===== FORM ACTIONS =====
    markerForm.addEventListener('submit', e => {
      e.preventDefault();
      const data = getFormData();
      
      // Validate ID uniqueness (excluding self in edit)
      const isDuplicate = allLocations.some(loc => 
        loc.id === data.id && (currentEditKey ? loc.key !== currentEditKey : true)
      );
      if (isDuplicate) {
        alert(`ID ${data.id} already exists. Choose a unique 4-digit ID.`);
        return;
      }

      if (currentEditKey) {
        // Update
        const index = allLocations.findIndex(l => l.key === currentEditKey);
        if (index !== -1) {
          data.key = currentEditKey;
          data.updatedAt = new Date().toISOString().split('T')[0];
          allLocations[index] = data;
          alert("Marker updated.");
        }
      } else {
        // Create
        data.key = generateKey();
        data.createdAt = new Date().toISOString().split('T')[0];
        data.updatedAt = data.createdAt;
        allLocations.push(data);
        alert("Marker added.");
      }

      renderLocations(allLocations);
      cancelEdit();
    });

    function getFormData() {
      return {
        id: document.getElementById('id').value.trim(),
        lat: document.getElementById('lat').value.trim(),
        lng: document.getElementById('lng').value.trim(),
        name: document.getElementById('name').value.trim(),
        title: document.getElementById('title').value.trim(),
        image: document.getElementById('image').value.trim(),
        creator: document.getElementById('creator').value.trim(),
        city: document.getElementById('city').value.trim(),
        audio: document.getElementById('audio').value.trim(),
        tours: document.getElementById('tours').value,
        summary: document.getElementById('summary').value.trim(),
        today: document.getElementById('today').value.trim(),
        link: document.getElementById('link').value.trim(),
        imageSource: document.getElementById('imageSource').value.trim(),
        additionalInfo: document.getElementById('additionalInfo').value.trim()
      };
    }

    function editLocation(key) {
      const loc = allLocations.find(l => l.key === key);
      if (!loc) return;

      currentEditKey = key;
      document.getElementById('edit-key').value = key;
      
      // Populate form
      document.getElementById('id').value = loc.id;
      document.getElementById('lat').value = loc.lat;
      document.getElementById('lng').value = loc.lng;
      document.getElementById('name').value = loc.name;
      document.getElementById('title').value = loc.title;
      document.getElementById('image').value = loc.image;
      document.getElementById('creator').value = loc.creator;
      document.getElementById('city').value = loc.city;
      document.getElementById('audio').value = loc.audio;
      document.getElementById('tours').value = loc.tours;
      document.getElementById('summary').value = loc.summary;
      document.getElementById('today').value = loc.today;
      document.getElementById('link').value = loc.link;
      document.getElementById('imageSource').value = loc.imageSource;
      document.getElementById('additionalInfo').value = loc.additionalInfo || '';

      // UI update
      formTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Marker';
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Update';
      cancelEditBtn.classList.remove('hidden');
      markerForm.classList.add('edit-mode');
      document.querySelector('#marker-form').scrollIntoView({ behavior: 'smooth' });
    }

    function deleteLocation(key) {
      if (!confirm("Delete this location? This cannot be undone.")) return;
      allLocations = allLocations.filter(l => l.key !== key);
      renderLocations(allLocations);
      alert("Deleted.");
    }

    function cancelEdit() {
      currentEditKey = null;
      markerForm.reset();
      document.getElementById('edit-key').value = '';
      formTitle.innerHTML = '<i class="fas fa-map-marker-alt"></i> Create New Location Marker';
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Marker';
      cancelEditBtn.classList.add('hidden');
      markerForm.classList.remove('edit-mode');
    }

    // ===== EXPORT =====
    exportBtn.addEventListener('click', () => {
      const content = `// Auto-generated ${new Date().toISOString()}\nwindow.LOCATIONS_DATA = ${JSON.stringify(allLocations, null, 2)};\n`;
      const blob = new Blob([content], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = '/locations_main.js';
      a.click();
      
      URL.revokeObjectURL(url);
      
      // Feedback
      const original = exportBtn.innerHTML;
      exportBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
      exportBtn.classList.remove('btn-success');
      exportBtn.classList.add('btn-secondary');
      setTimeout(() => {
        exportBtn.innerHTML = original;
        exportBtn.classList.add('btn-success');
        exportBtn.classList.remove('btn-secondary');
      }, 2000);
    });

    // ===== UTILITIES =====
    function generateKey() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    function copyCoords(e) {
      const coords = e.target.dataset.coords;
      navigator.clipboard.writeText(coords).then(() => {
        e.target.classList.add('copied');
        e.target.textContent = 'âœ“ Copied';
        setTimeout(() => {
          e.target.classList.remove('copied');
          e.target.textContent = coords;
        }, 1500);
      });
    }

    // Search
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      if (!term) {
        renderLocations(allLocations);
        return;
      }
      const filtered = allLocations.filter(l => 
        l.title?.toLowerCase().includes(term) ||
        l.city?.toLowerCase().includes(term) ||
        l.id?.includes(term) ||
        l.name?.toLowerCase().includes(term)
      );
      renderLocations(filtered);
    });

    clearSearch.addEventListener('click', () => {
      searchInput.value = '';
      renderLocations(allLocations);
    });

    // Initial: ensure passcode input gets focus
    document.getElementById('passcode').focus();
  </script>
</body>
</html>
