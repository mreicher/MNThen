<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>StoryMap Builder ‚Äì Minnesota Then</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{
      --bg:#f6f8fa;
      --card:#ffffff;
      --text:#222;
      --accent:#0066cc;
      --border:#e1e4e8;
      --shadow:0 4px 12px rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#0d1117;
      --card:#161b22;
      --text:#c9d1d9;
      --border:#30363d;
      --shadow:0 4px 12px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; margin:0; padding:0;}
    body{background:var(--bg); color:var(--text); line-height:1.4;}
    header{display:flex; align-items:center; justify-content:space-between; padding:1rem 2rem; background:var(--card); box-shadow:var(--shadow);}
    h1{font-size:1.5rem; font-weight:600;}
    .toggle{display:flex; align-items:center; gap:.5rem; font-size:.9rem;}
    .switch{position:relative; width:40px; height:22px; background:var(--border); border-radius:11px; cursor:pointer;}
    .switch::after{content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; background:var(--card); border-radius:50%; transition:.2s;}
    [data-theme="dark"] .switch::after{transform:translateX(18px);}
    main{display:grid; grid-template-columns:380px 1fr; gap:2rem; padding:2rem; max-width:1400px; margin:auto;}
    @media (max-width:900px){main{grid-template-columns:1fr;}}
    .panel{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1.5rem; box-shadow:var(--shadow);}
    .panel h2{margin-bottom:1rem; font-size:1.2rem;}
    .drop-area{border:2px dashed var(--border); border-radius:8px; padding:1.5rem; text-align:center; cursor:pointer; transition:.2s;}
    .drop-area:hover{border-color:var(--accent);}
    input,textarea,select{width:100%; padding:.75rem; margin-bottom:.75rem; border:1px solid var(--border); border-radius:6px; background:var(--bg); color:var(--text);}
    textarea{resize:vertical; min-height:90px;}
    .btn{background:var(--accent); color:#fff; border:0; padding:.75rem 1.5rem; border-radius:6px; cursor:pointer; font-weight:600;}
    .btn:hover{filter:brightness(1.1);}
    .btn-outline{background:transparent; color:var(--accent); border:1px solid var(--accent);}
    #map{height:320px; border-radius:8px; overflow:hidden;}
    .cards{display:grid; gap:1rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); margin-top:1rem;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:8px; padding:1rem; display:flex; flex-direction:column; gap:.5rem;}
    .card img{border-radius:6px; max-height:140px; object-fit:cover;}
    .card small{color:var(--text); opacity:.7;}
    pre{background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:1rem; overflow:auto; font-size:.85rem;}
    .copy-row{display:flex; gap:.5rem; margin-top:1rem;}
  </style>
</head>
<body>
<header>
  <h1>üìç StoryMap Builder</h1>
  <div class="toggle">
    <span>Dark</span>
    <div class="switch" id="themeToggle"></div>
  </div>
</header>

<main>
  <!-- LEFT : FORM + LIST -->
  <section class="panel">
    <h2>1. Add Location</h2>
    <div class="drop-area" id="csvDrop">Drag CSV here or click to select</div>
    <input type="file" id="csvFile" accept=".csv" hidden>
    <form id="form">
      <input name="id" type="number" placeholder="ID (unique number)" required>
      <input name="name" placeholder="Name / Headline" required>
      <input name="title" placeholder="Short Title" required>
      <textarea name="summary" placeholder="1-sentence summary" required></textarea>
      <textarea name="additionalInfo" placeholder="Extra trivia (1 sentence)"></textarea>
      <input name="city" placeholder="City" required>
      <input name="today" placeholder="Today / Address hint" required>
      <input name="image" type="url" placeholder="Image HTTPS url" required>
      <input name="imageSource" placeholder="Image credit line" required>
      <input name="audio" type="url" placeholder="Audio HTTPS url (.mp3)" required>
      <input name="link" type="url" placeholder="Read-more link" required>
      <select name="tours" required>
        <option value="">Tour category‚Ä¶</option>
        <option>history</option><option>person</option><option>event</option><option>place</option>
      </select>
      <select name="difficulty" required>
        <option value="">Difficulty (1-5)</option>
        <option value="1">1 ‚Äì Easy</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5 ‚Äì Hard</option>
      </select>
      <input name="creator" placeholder="Creator credit" value="Your Name">
      <div class="row">
        <input name="lat" type="number" step="0.0000001" placeholder="Latitude" required>
        <input name="lng" type="number" step="0.0000001" placeholder="Longitude" required>
      </div>
      <button type="submit" class="btn">Add ‚Üí</button>
    </form>

    <h2>2. Click Map (optional)</h2>
    <div id="map"></div>

    <h2>3. Export</h2>
    <div class="copy-row">
      <button class="btn btn-outline" id="copyBtn">Copy JS Array</button>
      <button class="btn" id="downloadBtn">Download .js file</button>
    </div>
  </section>

  <!-- RIGHT : PREVIEW + CODE -->
  <section class="panel">
    <h2>Preview <small id="count">0 items</small></h2>
    <div class="cards" id="cards"></div>

    <h2>Generated Code</h2>
    <pre id="output">// new locations appear here</pre>
  </section>
</main>

<script>
/* ---------- theme ---------- */
const themeToggle = document.getElementById('themeToggle');
themeToggle.onclick = () => {
  document.documentElement.dataset.theme = 
    document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
};

/* ---------- map ---------- */
const map = L.map('map').setView([45, -93.5], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);
let marker;
map.on('click', e => {
  if (marker) marker.remove();
  marker = L.marker(e.latlng).addTo(map);
  form.lat.value = e.latlng.lat.toFixed(7);
  form.lng.value = e.latlng.lng.toFixed(7);
});

/* ---------- data store ---------- */
const list = [];
const form = document.getElementById('form');
const cards = document.getElementById('cards');
const output = document.getElementById('output');
const count = document.getElementById('count');

function refreshUI() {
  count.textContent = `${list.length} items`;
  cards.innerHTML = list.map((loc, i) => `
    <div class="card">
      <img src="${loc.image}" onerror="this.style.display='none'">
      <div><strong>${loc.name}</strong></div>
      <div>${loc.city} ¬∑ ${loc.tours} ¬∑ diff ${loc.difficulty}</div>
      <div><small>${loc.summary}</small></div>
      <button class="btn btn-outline" style="margin-top:.5rem" onclick="removeCard(${i})">Remove</button>
    </div>
  `).join('');
  const js = `const newLocations = ${JSON.stringify(list, null, 2).replace(/"([^"]+)":/g, '$1:')};\n\n` +
    `// paste into your main locations array:\n// locations.push(...newLocations);`;
  output.textContent = js;
}
function removeCard(i) { list.splice(i, 1); refreshUI(); }

form.addEventListener('submit', e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form));
  ['id', 'difficulty', 'lat', 'lng'].forEach(k => data[k] = Number(data[k]));
  list.push(data);
  form.reset();
  if (marker) marker.remove();
  refreshUI();
});

/* ---------- csv ---------- */
document.getElementById('csvFile').addEventListener('change', handleCSV);
document.getElementById('csvDrop').addEventListener('click', () => document.getElementById('csvFile').click());
document.getElementById('csvDrop').addEventListener('dragover', e => e.preventDefault());
document.getElementById('csvDrop').addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer.files.length) handleCSV({ target: { files: e.dataTransfer.files } });
});
function handleCSV(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split('\n').filter(Boolean);
    const keys = lines[0].split(',').map(k => k.trim());
    for (let i = 1; i < lines.length; i++) {
      const vals = lines[i].split(',').map(v => v.trim());
      const obj = {};
      keys.forEach((k, j) => obj[k] = k === 'id' || k === 'difficulty' || k === 'lat' || k === 'lng' ? Number(vals[j]) : vals[j]);
      list.push(obj);
    }
    refreshUI();
  };
  reader.readAsText(file);
}

/* ---------- export ---------- */
document.getElementById('copyBtn').onclick = () => {
  navigator.clipboard.writeText(output.textContent);
  alert('Copied!');
};
document.getElementById('downloadBtn').onclick = () => {
  const blob = new Blob([output.textContent], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'newLocations.js';
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
