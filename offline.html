<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ==== PWA manifest & icons (already cached) ========================= -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- ==== Inline CSS – no external request needed ======================== -->
    <style>
        :root {
            --primary   : #1a4b8c;
            --secondary : #2c5282;
            --accent    : #dd6b20;
            --bg        : #fafafa;
            --text      : #2d3748;
            --muted     : #718096;
            --radius    : .75rem;
            --gap       : 1rem;
            --transition: .2s ease;
        }

        *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
        html { font-size:100%; }
        body {
            font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
            background:var(--bg);
            color:var(--text);
            min-height:100vh;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            text-align:center;
            padding:var(--gap);
        }
        h1 { font-size:1.8rem; color:var(--primary); margin-bottom:.5rem; }
        p  { font-size:1rem; color:var(--muted); margin-bottom:var(--gap); }
        .icon {
            width:80px; height:80px;
            margin-bottom:1rem;
            color:var(--accent);
        }
        .sr-only { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); }
        button {
            background:linear-gradient(45deg,var(--accent),#e67a3a);
            color:#fff;
            border:none;
            border-radius:var(--radius);
            padding:.8rem 1.5rem;
            font-size:1rem;
            font-weight:600;
            cursor:pointer;
            margin:.5rem;
            transition:transform var(--transition),box-shadow var(--transition);
        }
        button:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.12); }
        button:focus-visible { outline:2px solid var(--primary); outline-offset:2px; }
        .secondary { background:linear-gradient(45deg,var(--secondary),#4a90e2); }
        .status {
            margin:1rem 0;
            padding:.75rem;
            background:#fff;
            border-radius:var(--radius);
            max-width:400px;
            width:100%;
            box-shadow:0 2px 6px rgba(0,0,0,.04);
        }
        .actions { margin-top:1rem; display:flex; flex-direction:column; gap:.5rem; }
    </style>
</head>

<body>
    <h1>Exploring Offline</h1>
    <p>Your Minnesota history journey continues without internet.</p>

    <!-- ==== Cache status (live region) ================================ -->
    <section class="status" id="cacheStatus" role="status" aria-live="polite">
        Loading cached content…
    </section>

    <!-- ==== Action buttons ============================================= -->
    <div class="actions">
        <button id="retryBtn">Try Connection Again</button>
        <button id="exploreBtn" class="secondary">View Cached Map</button>
    </div>

    <!-- ==== Inline script – no external request needed =================== -->
    <script>
        /* ---------------------------------------------------------------
           1️⃣  Show how many items are cached across all of our caches.
               If the map page (amap.html) is not cached we disable the
               “View Cached Map” button so the user isn’t led to a dead UI.
           --------------------------------------------------------------- */
        (function () {
            const statusEl   = document.getElementById('cacheStatus');
            const exploreBtn = document.getElementById('exploreBtn');

            if (!('caches' in window)) {
                statusEl.textContent = 'Your browser does not support the Cache API.';
                exploreBtn.disabled = true;
                return;
            }

            const cacheNames = [
                'mnthen-v4-ios-4',
                'mnthen-runtime-v4-ios',
                'mnthen-audio-v4',
                'mnthen-tiles-v4',
                'mnthen-shell-v4'
            ];

            let totalItems   = 0;
            let failedCaches = 0;
            let mapIsCached  = false;   // ← will become true if amap.html is found

            // Helper: check whether a particular URL exists in ANY of the caches
            function checkIfInCache(url) {
                return Promise.all(
                    cacheNames.map(name =>
                        caches.open(name)
                              .then(c => c.match(url))
                              .then(match => match ? true : false)
                              .catch(() => false)   // ignore errors for a single cache
                    )
                ).then(results => results.some(Boolean));
            }

            // First, count everything (for the status line)
            Promise.all(
                cacheNames.map(name =>
                    caches.open(name)
                          .then(c => c.keys())
                          .then(keys => { totalItems += keys.length; })
                          .catch(() => { failedCaches++; })
                )
            ).finally(() => {
                // Then, specifically look for the map page
                checkIfInCache('/amap.html')
                    .then(found => {
                        mapIsCached = found;
                        // Update UI based on what we discovered
                        if (totalItems > 0) {
                            statusEl.innerHTML = `<strong>${totalItems}</strong> item${totalItems===1?'':'s'} cached and available offline.`;
                        } else {
                            statusEl.textContent = 'No cached content found.';
                        }

                        // Enable/disable the button according to cache presence
                        exploreBtn.disabled = !mapIsCached;
                        if (!mapIsCached) {
                            exploreBtn.title = 'Map page not cached yet – visit it online first.';
                        }
                    })
                    .catch(err => {
                        console.error('Error checking map cache:', err);
                        exploreBtn.disabled = true;
                    });

                if (failedCaches) {
                    console.warn(`${failedCaches} cache(s) could not be opened – they may not exist yet.`);
                }
            });
        })();

        /* ---------------------------------------------------------------
           2️⃣  Retry button – reloads the page.
               The service‑worker will attempt a network request again.
           --------------------------------------------------------------- */
        document.getElementById('retryBtn')
                .addEventListener('click', () => location.reload());

        /* ---------------------------------------------------------------
           3️⃣  View Cached Map button.
               If the map page is cached we navigate to it directly.
               If for some reason it isn’t (should never happen because we
               disabled the button), we fall back to a friendly message.
           --------------------------------------------------------------- */
        document.getElementById('exploreBtn')
                .addEventListener('click', () => {
                    // Because the button is disabled when the map isn’t cached,
                    // we can safely assume it exists here.
                    const mapUrl = '/amap.html';

                    // Try to fetch it from the cache first (fastest path)
                    caches.open('mnthen-shell-v4')
                          .then(cache => cache.match(mapUrl))
                          .then(response => {
                              if (response) {
                                  // The page is in the cache – navigate to it.
                                  // Using location.replace avoids adding another entry
                                  // to the browser history (good for offline UX).
                                  location.replace(mapUrl);
                              } else {
                                  // Unexpected – the button should have been disabled.
                                  alert('Map page not found in cache. Please go online and visit the map once to cache it.');
                              }
                          })
                          .catch(err => {
                              console.error('Error retrieving cached map:', err);
                              alert('Something went wrong while trying to open the cached map.');
                          });
                });

        /* ---------------------------------------------------------------
           4️⃣  Accessibility – focus the primary button on load.
           --------------------------------------------------------------- */
        window.addEventListener('load', () => {
            document.getElementById('retryBtn').focus();
        });
    </script>
</body>
</html>
