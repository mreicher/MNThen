<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Basic Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Discover and share meaningful places across Minnesota with Community Markers Map">
    
  <title>Community Markers Map</title>
  <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.Default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css" />
    
  <style>
    /* Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        overflow-x: hidden;
        color: #333;
        background-color: #f5f5f5;
        line-height: 1.6;
    }

    .leaflet-control-attribution {
        display: none;
    }

    a {
        text-decoration: none;
        color: #2563eb;
        transition: color 0.3s ease;
    }

    a:hover {
        color: #1d4ed8;
    }

    /* Typography */
    h1, h2, h3, h4, h5, h6 {
        color: #1e293b;
        margin-bottom: 0.5em;
        font-weight: 600;
    }

    p {
        margin-bottom: 1em;
    }

    .sun-editor,
    .sun-editor .se-wrapper .se-content,
    .sun-editor .se-toolbar,
    .sun-editor .se-selector,
    .sun-editor .se-dialog {
        font-size: 15px !important;
    }

    /* Force font size in the editor's dialog boxes */
    .sun-editor .se-dialog {
        font-size: 15px !important;
    }

    /* Page Layout */
    .page {
        width: 100%;
        min-height: 100vh;
        position: relative;
    }

    .search-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('https://images.pexels.com/photos/417173/pexels-photo-417173.jpeg');
        background-size: cover;
        background-position: center;
        color: white;
        text-align: center;
    }

    .search-page h1, .search-page h2, .search-page h3, 
    .search-page h4, .search-page h5, .search-page h6 {
        color: #ffffff;
    }

    .map-page {
        display: none;
        position: relative;
        height: 100vh;
        width: 100%;
    }

    /* Map Container */
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }

    /* Hero Content */
    .hero-content {
        max-width: 800px;
        padding: 2rem;
        z-index: 2;
        animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .hero-content h1 {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .hero-content p {
        font-size: 1.3rem;
        margin-bottom: 2rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Custom styles for Suneditor */
    #description-editor {
        border: 1px solid #d1d5db;
        border-radius: 5px;
        margin-bottom: 1rem;
    }

    .sun-editor .se-toolbar {
        background-color: #f9fafb;
        border-bottom: 1px solid #d1d5db;
    }

    .sun-editor .se-wrapper {
        background-color: white;
    }

    /* Search Components */
    .search-container {
        width: 100%;
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    .search-bar {
        display: flex;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .search-bar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .search-input {
        flex: 1;
        padding: 1.2rem 1.5rem;
        border: none;
        font-size: 1.1rem;
        outline: none;
    }

    .search-button {
        padding: 1.2rem 2rem;
        background-color: #2563eb;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .search-button:hover {
        background-color: #1d4ed8;
    }

    .map-search-bar {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        width: 80%;
        max-width: 500px;
        z-index: 10;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.3s ease;
    }

    .map-search-bar:hover {
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
    }

    .map-search-input {
        flex: 1;
        padding: 0.9rem 1.25rem;
        border: none;
        font-size: 1rem;
        outline: none;
    }

    .map-search-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border: none;
        background-color: #2563eb;
        border-radius: 0 50px 50px 0;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .map-search-button:hover {
        background-color: #1d4ed8;
    }

    .map-search-button i {
        color: white;
        font-size: 18px;
    }

    /* Category Selector */
    .category-selector {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        z-index: 10;
        padding: 12px 16px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease;
    }

    .category-badge {
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .category-badge.active {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .category-badge.inactive {
        opacity: 0.6;
        background-color: #94a3b8;
    }

    .category-badge.architecture {
        background-color: #2563eb;
    }

    .category-badge.nature {
        background-color: #10b981;
    }

    .category-badge.events {
        background-color: #f59e0b;
    }

    .category-badge.people {
        background-color: #8b5cf6;
    }

    .category-count {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    /* Category Legend */
    .category-legend {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10;
        max-width: 200px;
    }

    .legend-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #1e293b;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.85rem;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .legend-color.architecture {
        background-color: #2563eb;
    }

    .legend-color.nature {
        background-color: #10b981;
    }

    .legend-color.events {
        background-color: #f59e0b;
    }

    .legend-color.people {
        background-color: #8b5cf6;
    }

    /* Floating Menu */
    .floating-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    .floating-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #2563eb;
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .floating-btn:hover {
        background-color: #1d4ed8;
        transform: scale(1.05);
    }

    .menu-content {
        display: none;
        position: absolute;
        top: 60px;
        left: 0;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        padding: 0.5rem;
        width: 220px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .menu-content a {
        display: block;
        padding: 0.85rem 1.2rem;
        color: #333;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 500;
    }

    .menu-content a:hover {
        background-color: #f3f4f6;
        color: #2563eb;
        transform: translateX(5px);
    }

    /* Scroll Down Button */
    .scroll-down {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        cursor: pointer;
        animation: bounce 2s infinite;
    }

    .scroll-down span {
        margin-bottom: 0.5rem;
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0) translateX(-50%);
        }
        40% {
            transform: translateY(-10px) translateX(-50%);
        }
        60% {
            transform: translateY(-5px) translateX(-50%);
        }
    }

    /* Overlay */
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        backdrop-filter: blur(3px);
        transition: opacity 0.3s ease;
    }

    /* Modal Base */
    .modal-base {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        padding: 2.5rem;
        max-width: 90%;
        width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1100;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translate(-50%, -48%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .modal-base h2 {
        color: #1e3a8a;
        margin-bottom: 1.2rem;
        font-size: 1.8rem;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 0.8rem;
    }

    .modal-base p {
        color: #4b5563;
        margin-bottom: 1.2rem;
        line-height: 1.7;
    }

    .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #374151;
        background-color: #f3f4f6;
    }

    /* Auth Popup */
    .auth-popup {
        width: 420px;
    }

    .auth-tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .auth-tab {
        flex: 1;
        padding: 0.85rem;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s;
    }

    .auth-tab.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
    }

    .auth-form {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 500;
        font-size: 0.95rem;
        color: #4b5563;
    }

    .form-input {
        padding: 0.85rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .auth-button {
        padding: 0.9rem;
        background-color: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .auth-button:hover {
        background-color: #1d4ed8;
    }

    /* Marker Info Modal */
    #markerInfoModal {
        width: 1100px;
        max-width: 95%;
        z-index: 1200;
    }

    .marker-info-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .marker-info-content {
            flex-direction: row;
        }
    }

    /* Marker Image Container */
    .marker-image-container {
        position: relative;
        display: inline-block;
        margin-bottom: 25px;
        flex: 1;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: none;
        border: none;
        background-color: white;
    }

    /* Marker Image */
    .marker-image {
        display: block;
        width: 100%;
        height: auto;
        transition: transform 0.5s ease;
        cursor: pointer;
    }

    .marker-image:hover {
        transform: scale(1.03);
    }

    /* Historical Source */
    .source-citation {
        background-color: #f8fafc;
        padding: 1.2rem;
        border-radius: 12px;
        margin-top: 1rem;
        font-size: 0.95rem;
        border: 1px solid #e2e8f0;
    }

    .source-citation h4 {
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        color: #1e3a8a;
    }
    
    /* Copyright options */
    .copyright-info {
        margin-top: 0.8rem;
        font-size: 0.9rem;
        color: #64748b;
        font-style: italic;
    }

    .marker-details {
        flex: 1.5;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .marker-title {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        color: #1e3a8a;
    }

    .upload-info {
        font-size: 0.95rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .upload-info i {
        color: #2563eb;
    }

    .category-tags {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
    }

    .category-tag {
        padding: 0.35rem 0.9rem;
        border-radius: 50px;
        font-size: 0.85rem;
        color: white;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .category-tag.architecture {
        background-color: #2563eb;
    }

    .category-tag.nature {
        background-color: #10b981;
    }

    .category-tag.events {
        background-color: #f59e0b;
    }

    .category-tag.people {
        background-color: #8b5cf6;
    }

    .description {
        line-height: 1.7;
        color: #4b5563;
    }

    .marker-stats {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.8rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b;
        font-size: 0.95rem;
    }

    .interaction-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.7rem 1.2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .btn-primary {
        background-color: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background-color: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary {
        background-color: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
        background-color: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background-color: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
        background-color: #10b981;
        color: white;
    }

    .btn-success:hover {
        background-color: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-warning {
        background-color: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background-color: #d97706;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .report-button {
        background-color: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        padding: 0.5rem 0.8rem;
        border-radius: 6px;
    }

    .report-button:hover {
        color: #dc2626;
        background-color: rgba(239, 68, 68, 0.05);
    }

    .share-buttons {
        display: flex;
        gap: 0.8rem;
        margin-top: 1.2rem;
    }

    .share-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .share-button:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
    }

    .share-button.facebook {
        background-color: #1877f2;
    }

    .share-button.twitter {
        background-color: #1da1f2;
    }

    .share-button.linkedin {
        background-color: #0a66c2;
    }

    /* Comments Section */
    .comments-section {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .comments-section h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
    }

    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        margin-bottom: 1.8rem;
    }

    .comment {
        background-color: #f8fafc;
        padding: 1.2rem;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
    }

    .comment:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.8rem;
    }

    .comment-author {
        font-weight: 600;
        color: #1e3a8a;
    }

    .comment-date {
        font-size: 0.85rem;
        color: #64748b;
    }

    .comment-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #4b5563;
    }

    .comment-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .comment-form textarea {
        resize: vertical;
        min-height: 100px;
        border-radius: 8px;
        padding: 1rem;
        font-family: inherit;
        font-size: 0.95rem;
    }

    /* Collections Grid */
    .collections-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.8rem;
        margin: 1.8rem 0;
    }

    .collection-card {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        background-color: white;
        position: relative;
        border: 1px solid #e2e8f0;
    }

    .collection-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .collection-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .collection-card:hover .collection-image {
        transform: scale(1.05);
    }

    .collection-info {
        padding: 1.5rem;
    }

    .collection-title {
        margin-bottom: 0.8rem;
        font-size: 1.2rem;
        color: #1e3a8a;
    }

    .collection-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 1.2rem;
        font-size: 0.85rem;
        color: #64748b;
    }

    .collection-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 0.6rem;
    }

    .collection-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9rem;
        color: #475569;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .collection-action-btn:hover {
        background-color: white;
        color: #2563eb;
        transform: scale(1.1);
    }

    /* Collection Markers Modal */
    .collection-markers-modal {
        width: 800px;
        max-width: 95%;
    }

    .collection-markers-list {
        margin-top: 1.8rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.2rem;
    }

    .collection-marker-item {
        background-color: #f8fafc;
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        position: relative;
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
    }

    .collection-marker-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
    }

    .collection-marker-title {
        font-weight: 600;
        margin-bottom: 0.8rem;
        color: #1e3a8a;
    }

    .collection-marker-category {
        display: inline-block;
        padding: 0.25rem 0.7rem;
        border-radius: 50px;
        font-size: 0.75rem;
        color: white;
        margin-bottom: 0.8rem;
        font-weight: 600;
    }

    .collection-marker-category.architecture {
        background-color: #2563eb;
    }

    .collection-marker-category.nature {
        background-color: #10b981;
    }

    .collection-marker-category.events {
        background-color: #f59e0b;
    }

    .collection-marker-category.people {
        background-color: #8b5cf6;
    }

    .remove-from-collection {
        position: absolute;
        top: 0.8rem;
        right: 0.8rem;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: rgba(239, 68, 68, 0.1);
        border: none;
        color: #ef4444;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background-color 0.2s;
        z-index: 5;
    }

    .remove-from-collection:hover {
        background-color: rgba(239, 68, 68, 0.2);
    }

    /* Notification */
    .notification {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        max-width: 350px;
    }

    .notification.info {
        background-color: #3b82f6;
        border-left: 5px solid #2563eb;
    }

    .notification.success {
        background-color: #10b981;
        border-left: 5px solid #059669;
    }

    .notification.error {
        background-color: #ef4444;
        border-left: 5px solid #dc2626;
    }

    .notification.warning {
        background-color: #f59e0b;
        border-left: 5px solid #d97706;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Expanded Image Modal */
    .expanded-image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .expanded-image {
        max-width: 90%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        animation: zoomIn 0.3s ease-out;
    }

    @keyframes zoomIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .expanded-image-title {
        color: white;
        font-size: 1.3rem;
        margin-top: 1.5rem;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .expanded-image-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 2001;
    }

    .expanded-image-close:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    /* Info Button */
    .info-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(200, 200, 200, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        transition: all 0.3s;
        opacity: 0.8;
    }

    .info-button:hover {
        background-color: rgba(255, 255, 255, 0.9);
        opacity: 1;
        transform: scale(1.1);
    }

    .info-button i {
        color: #1e3a8a;
        font-size: 18px;
    }

    /* Recenter Button */
    .recenter-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #2563eb;
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .recenter-button:hover {
        background-color: #1d4ed8;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }

    /* Leaderboard styling */
    .leaderboard {
        margin-top: 1.5rem;
    }

    .leaderboard-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 1.2rem;
        text-align: center;
        padding-bottom: 0.8rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 0.8rem;
        background-color: #f8fafc;
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
    }

    .leaderboard-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .leaderboard-rank {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2563eb;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e0e7ff;
        border-radius: 50%;
        margin-right: 1rem;
    }

    .leaderboard-user {
        flex: 1;
        font-weight: 600;
        color: #1e293b;
    }

    .leaderboard-points {
        font-weight: 600;
        color: #10b981;
        background-color: #ecfdf5;
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
    }

    /* Copyright options */
    .copyright-options {
        margin-top: 15px;
    }
    
    .copyright-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
    }
    
    .copyright-option input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .copyright-option label {
        cursor: pointer;
        font-size: 0.95rem;
        color: #4b5563;
    }

    /* Return link */
    .return-link {
        display: inline-block;
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 0.7rem 1.5rem;
        border-radius: 50px;
        font-weight: 500;
        transition: all 0.3s;
        margin-top: 1rem;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .return-link:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        color: white;
    }

    /* Collection Features Improvements */
    .collection-features {
        margin-top: 1.5rem;
        padding: 1.2rem;
        background-color: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .collection-features-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 1rem;
    }

    .collection-features-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .collection-feature {
        flex: 1;
        min-width: 200px;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
    }

    .collection-feature:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .collection-feature-icon {
        font-size: 1.5rem;
        color: #2563eb;
        margin-bottom: 0.5rem;
    }

    .collection-feature-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1e293b;
    }

    /* Enhanced styles for collaborative history features */
    .history-timeline {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .history-timeline h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .history-timeline h3 i {
        color: #10b981;
    }

    .timeline-container {
        position: relative;
        max-width: 100%;
        margin: 0 auto;
    }

    .timeline-container::after {
        content: '';
        position: absolute;
        width: 3px;
        background: linear-gradient(180deg, #2563eb 0%, #10b981 50%, #f59e0b 100%);
        top: 0;
        bottom: 0;
        left: 50%;
        margin-left: -1.5px;
        border-radius: 2px;
    }

    .timeline-item {
        padding: 15px 45px;
        position: relative;
        background-color: inherit;
        width: 50%;
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .timeline-item::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background-color: white;
        border: 4px solid #2563eb;
        border-radius: 50%;
        top: 20px;
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .timeline-item.edit::after {
        border-color: #10b981;
    }

    .timeline-item.creation::after {
        border-color: #2563eb;
    }

    .timeline-item.verification::after {
        border-color: #f59e0b;
    }

    .timeline-item.review::after {
        border-color: #8b5cf6;
    }

    .left {
        left: 0;
    }

    .right {
        left: 50%;
    }

    .left::after {
        right: -10px;
    }

    .right::after {
        left: -10px;
    }

    .timeline-content {
        padding: 25px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        position: relative;
        transition: all 0.3s ease;
    }

    .timeline-content:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .timeline-content::before {
        content: '';
        position: absolute;
        top: 20px;
        width: 0;
        height: 0;
        border: 10px solid transparent;
    }

    .left .timeline-content::before {
        right: -20px;
        border-left-color: white;
    }

    .right .timeline-content::before {
        left: -20px;
        border-right-color: white;
    }

    .timeline-date {
        font-weight: 700;
        color: #2563eb;
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .timeline-date i {
        color: #10b981;
    }

    .timeline-user {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 0.8rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .timeline-user i {
        color: #8b5cf6;
    }

    .timeline-text {
        font-size: 1rem;
        line-height: 1.7;
        color: #4b5563;
        margin-bottom: 0.8rem;
    }

    .timeline-changes {
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 0.8rem;
        border-left: 4px solid #2563eb;
    }

    .timeline-change-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .timeline-change-item:last-child {
        margin-bottom: 0;
    }

    .timeline-change-label {
        font-weight: 600;
        color: #1e3a8a;
        min-width: 80px;
    }

    .timeline-change-value {
        color: #4b5563;
        flex: 1;
    }

    /* Source Verification Enhanced Styles */
    .source-verification {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .source-verification h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .source-verification h3 i {
        color: #f59e0b;
    }

    .verification-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .verification-status i {
        font-size: 1rem;
    }

    .verification-status.pending {
        background-color: #fef3c7;
        color: #d97706;
        border: 2px solid #f59e0b;
    }

    .verification-status.verified {
        background-color: #d1fae5;
        color: #059669;
        border: 2px solid #10b981;
    }

    .verification-status.rejected {
        background-color: #fee2e2;
        color: #dc2626;
        border: 2px solid #ef4444;
    }

    .verification-status.under-review {
        background-color: #e0e7ff;
        color: #4338ca;
        border: 2px solid #6366f1;
    }

    .source-documents {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1.5rem;
        margin: 1.5rem 0;
    }

    .source-document {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 2px solid #e2e8f0;
        background-color: white;
    }

    .source-document:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        border-color: #2563eb;
    }

    .source-document img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .source-document:hover img {
        transform: scale(1.05);
    }

    .source-document-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        padding: 1rem 0.8rem 0.8rem;
        font-size: 0.8rem;
        text-align: center;
        font-weight: 600;
    }

    .source-document-type {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(37, 99, 235, 0.9);
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 50px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .citation-list {
        margin-top: 1.5rem;
    }

    .citation-item {
        background-color: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
        position: relative;
        transition: all 0.3s ease;
    }

    .citation-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        border-color: #2563eb;
    }

    .citation-title {
        font-weight: 700;
        margin-bottom: 0.8rem;
        color: #1e3a8a;
        font-size: 1.1rem;
    }

    .citation-details {
        font-size: 0.9rem;
        color: #64748b;
        line-height: 1.6;
        margin-bottom: 0.8rem;
    }

    .citation-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 0.8rem;
    }

    .citation-meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.8rem;
        color: #64748b;
    }

    .citation-meta-item i {
        color: #2563eb;
    }

    .citation-url {
        margin-top: 0.8rem;
    }

    .citation-url a {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #2563eb;
        font-weight: 600;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .citation-url a:hover {
        color: #1d4ed8;
    }

    /* Peer Review Enhanced Styles */
    .peer-review-section {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .peer-review-section h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .peer-review-section h3 i {
        color: #8b5cf6;
    }

    .review-summary {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .review-summary-item {
        flex: 1;
        text-align: center;
        padding: 0.8rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .review-summary-item.approved {
        background-color: #d1fae5;
        border: 2px solid #10b981;
    }

    .review-summary-item.neutral {
        background-color: #f3f4f6;
        border: 2px solid #6b7280;
    }

    .review-summary-item.rejected {
        background-color: #fee2e2;
        border: 2px solid #ef4444;
    }

    .review-summary-count {
        font-size: 1.5rem;
        font-weight: 700;
        display: block;
    }

    .review-summary-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.8;
    }

    .review-item {
        background-color: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.2rem;
        border: 1px solid #e2e8f0;
        position: relative;
        transition: all 0.3s ease;
    }

    .review-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .review-status-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.3rem 0.8rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .review-status-badge.approved {
        background-color: #10b981;
        color: white;
    }

    .review-status-badge.neutral {
        background-color: #6b7280;
        color: white;
    }

    .review-status-badge.rejected {
        background-color: #ef4444;
        color: white;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding-right: 80px;
    }

    .review-author-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .review-author-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2563eb, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .review-author-details {
        display: flex;
        flex-direction: column;
    }

    .review-author {
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 0.2rem;
    }

    .review-date {
        font-size: 0.8rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .review-date i {
        color: #10b981;
    }

    .review-text {
        font-size: 1rem;
        line-height: 1.7;
        color: #4b5563;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        border-left: 4px solid #e2e8f0;
    }

    .review-actions {
        display: flex;
        gap: 0.8rem;
        margin-top: 1rem;
    }

    .review-action-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .review-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .review-action-btn.approve {
        background-color: #10b981;
        color: white;
    }

    .review-action-btn.approve:hover {
        background-color: #059669;
    }

    .review-action-btn.reject {
        background-color: #ef4444;
        color: white;
    }

    .review-action-btn.reject:hover {
        background-color: #dc2626;
    }

    .review-action-btn.neutral {
        background-color: #e2e8f0;
        color: #475569;
    }

    .review-action-btn.neutral:hover {
        background-color: #cbd5e1;
    }

    .review-action-btn.active {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .review-form-container {
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        margin-top: 1.5rem;
    }

    .review-form-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .review-form-title i {
        color: #8b5cf6;
    }

    /* Dropzone Enhanced Styles */
    .dropzone {
        border: 3px dashed #d1d5db;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        position: relative;
        overflow: hidden;
    }

    .dropzone::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(37, 99, 235, 0.03) 0%, transparent 70%);
        transition: all 0.3s ease;
        z-index: 0;
    }

    .dropzone:hover {
        border-color: #2563eb;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.1);
    }

    .dropzone:hover::before {
        transform: scale(1.1);
    }

    .dropzone .dz-message {
        margin: 0;
        font-size: 1.1rem;
        color: #64748b;
        font-weight: 600;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.8rem;
    }

    .dropzone .dz-message i {
        font-size: 2.5rem;
        color: #2563eb;
        margin-bottom: 0.5rem;
    }

    .dropzone .dz-preview {
        margin: 10px;
        position: relative;
        z-index: 1;
    }

    .dropzone .dz-preview .dz-image {
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Story Contribution System */
    .story-contribution-section {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .story-contribution-section h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .story-contribution-section h3 i {
        color: #f59e0b;
    }

    .story-contributions {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .story-contribution {
        background-color: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        position: relative;
        transition: all 0.3s ease;
    }

    .story-contribution:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .story-contribution-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .story-contributor-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .story-contributor-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .story-contributor-details {
        display: flex;
        flex-direction: column;
    }

    .story-contributor-name {
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 0.2rem;
    }

    .story-contribution-date {
        font-size: 0.8rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .story-contribution-status {
        padding: 0.3rem 0.8rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .story-contribution-status.pending {
        background-color: #fef3c7;
        color: #d97706;
        border: 1px solid #f59e0b;
    }

    .story-contribution-status.approved {
        background-color: #d1fae5;
        color: #059669;
        border: 1px solid #10b981;
    }

    .story-contribution-status.rejected {
        background-color: #fee2e2;
        color: #dc2626;
        border: 1px solid #ef4444;
    }

    .story-contribution-text {
        font-size: 1rem;
        line-height: 1.7;
        color: #4b5563;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        border-left: 4px solid #f59e0b;
        margin-bottom: 1rem;
    }

    .story-contribution-actions {
        display: flex;
        gap: 0.8rem;
        justify-content: flex-end;
    }

    .story-action-btn {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .story-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .story-action-btn.approve {
        background-color: #10b981;
        color: white;
    }

    .story-action-btn.reject {
        background-color: #ef4444;
        color: white;
    }

    /* Moderation Dashboard Styles */
    .moderation-section {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .moderation-section h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .moderation-section h3 i {
        color: #ef4444;
    }

    .moderation-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .moderation-stat {
        background-color: #f8fafc;
        padding: 1.2rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        text-align: center;
        transition: all 0.3s ease;
    }

    .moderation-stat:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    }

    .moderation-stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #2563eb;
        display: block;
    }

    .moderation-stat-label {
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 600;
    }

    /* Enhanced Points and Badge System */
    .user-achievements {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .user-achievements h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .user-achievements h3 i {
        color: #f59e0b;
    }

    .achievement-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .achievement-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .achievement-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(37, 99, 235, 0.1) 0%, transparent 70%);
        transition: all 0.3s ease;
        z-index: 0;
    }

    .achievement-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.15);
    }

    .achievement-card:hover::before {
        transform: scale(1.2);
    }

    .achievement-icon {
        font-size: 2.5rem;
        color: #f59e0b;
        margin-bottom: 0.8rem;
        position: relative;
        z-index: 1;
    }

    .achievement-title {
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .achievement-description {
        font-size: 0.9rem;
        color: #64748b;
        position: relative;
        z-index: 1;
    }

    .achievement-progress {
        margin-top: 1rem;
        position: relative;
        z-index: 1;
    }

    .achievement-progress-bar {
        width: 100%;
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .achievement-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #2563eb 0%, #10b981 100%);
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .achievement-progress-text {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 600;
    }

    /* Version Comparison Modal */
    .version-comparison-modal {
        width: 1200px;
        max-width: 95%;
    }

    .version-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 1.5rem;
    }

    .version-panel {
        background-color: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .version-panel h4 {
        color: #1e3a8a;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .version-panel.old {
        border-color: #ef4444;
    }

    .version-panel.new {
        border-color: #10b981;
    }

    .version-field {
        margin-bottom: 1rem;
        padding: 0.8rem;
        background-color: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .version-field-label {
        font-weight: 600;
        color: #4b5563;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .version-field-content {
        color: #1e293b;
        line-height: 1.6;
    }

    .version-field.changed {
        border-left: 4px solid #f59e0b;
        background-color: #fffbeb;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .hero-content h1 {
            font-size: 2.5rem;
        }

        .search-bar {
            flex-direction: column;
            border-radius: 12px;
        }

        .search-input, .search-button {
            width: 100%;
            border-radius: 0;
        }

        .search-input {
            border-radius: 12px 12px 0 0;
        }

        .search-button {
            border-radius: 0 0 12px 12px;
        }

        .map-search-bar {
            width: 90%;
        }

        #markerInfoModal {
            width: 95%;
            max-height: 85vh;
        }

        .marker-info-content {
            flex-direction: column;
        }

        .marker-image {
            max-height: 250px;
            object-fit: cover;
        }

        .category-selector {
            padding: 10px;
            width: 90%;
        }

        .category-badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .collection-markers-list {
            grid-template-columns: 1fr;
        }

        .category-legend {
            top: auto;
            bottom: 80px;
            right: 20px;
        }

        .timeline-container::after {
            left: 31px;
        }

        .timeline-item {
            width: 100%;
            padding-left: 70px;
            padding-right: 25px;
        }

        .timeline-item::after {
            left: 23px;
        }

        .left::after, .right::after {
            left: 23px;
        }

        .left, .right {
            left: 0;
        }

        .timeline-content::before {
            display: none;
        }

        .version-comparison {
            grid-template-columns: 1fr;
        }

        .achievement-grid {
            grid-template-columns: 1fr;
        }

        .moderation-stats {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .source-documents {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }

        .interaction-buttons {
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn {
            justify-content: center;
        }
    }
  </style>
</head>
<body>
    <div class="floating-menu" id="floatingMenu">
        <button class="floating-btn" id="floatingBtn" aria-label="Open Menu">☰</button>
        <div class="menu-content" id="menuContent">
            <a href="#" id="homeLink">Home</a>
            <a href="#" id="aboutLink">About Us</a>
            <a href="#" id="instructionsLink">Instructions</a>
            <a href="#" id="loginLink">Login/Join</a>
            <a href="#" id="collectionsLink">Collections</a>
            <a href="#" id="leaderboardLink">Leaderboard</a>
            <a href="#" id="historyLink">History</a>
            <a href="#" id="moderationLink">Moderation</a>
        </div>
    </div>

    <div class="page search-page" id="searchPage">
        <div class="hero-content">
            <h1>Community Markers</h1>
            <p>Discover and share meaningful places across Minnesota with collaborative storytelling and verified historical documentation.</p>
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput" aria-label="Search for a location">
                    <button class="search-button" id="searchButton">Search</button>
                </div>
            </div>
            <a href="https://www.mnthen.com" class="return-link">Return to Minnesota Then</a>
        </div>
        <div class="scroll-down" id="scrollDown">
            <span>Explore Map</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
            </svg>
        </div>
        <button class="info-button" id="infoButton" aria-label="Information"><i class="fas fa-info"></i></button>
    </div>

    <div class="page map-page" id="mapPage">
        <div class="map-search-bar">
            <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput" aria-label="Search for a location in Minnesota">
            <button class="map-search-button" id="mapSearchButton" aria-label="Search">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <div id="map"></div>
        <div class="category-selector" id="categorySelector">
            <span class="category-badge architecture active" data-category="architecture">
                <i class="fas fa-building"></i>
                Architecture
                <span class="category-count" id="architectureCount">0</span>
            </span>
            <span class="category-badge nature active" data-category="nature">
                <i class="fas fa-tree"></i>
                Nature
                <span class="category-count" id="natureCount">0</span>
            </span>
            <span class="category-badge events active" data-category="events">
                <i class="fas fa-calendar"></i>
                Events
                <span class="category-count" id="eventsCount">0</span>
            </span>
            <span class="category-badge people active" data-category="people">
                <i class="fas fa-users"></i>
                People
                <span class="category-count" id="peopleCount">0</span>
            </span>
        </div>
        <button class="recenter-button" id="recenterButton" aria-label="Recenter Map"><i class="fas fa-crosshairs"></i></button>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="notification" class="notification" role="alert"></div>

    <!-- Authentication Modal -->
    <div id="authPopup" class="modal-base auth-popup" role="dialog" aria-labelledby="authTitle">
        <button id="closePopup" class="close-btn" aria-label="Close">&times;</button>
        <div class="auth-container">
            <div class="auth-tabs" role="tablist">
                <button id="showLogin" class="auth-tab active" role="tab" aria-selected="true" aria-controls="loginForm">Login</button>
                <button id="showJoin" class="auth-tab" role="tab" aria-selected="false" aria-controls="joinForm">Join</button>
            </div>
            <form id="loginForm" class="auth-form" role="tabpanel">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required aria-required="true">
                </div>
                <button type="submit" id="loginButton" class="auth-button">Login</button>
            </form>
            <form id="joinForm" class="auth-form" style="display: none;" role="tabpanel">
                <div class="form-group">
                    <label for="joinEmail">Email</label>
                    <input type="email" id="joinEmail" class="form-input" placeholder="Enter your email" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinPassword">Password</label>
                    <input type="password" id="joinPassword" class="form-input" placeholder="Create a password" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinFirstName">First Name</label>
                    <input type="text" id="joinFirstName" class="form-input" placeholder="Enter your first name" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinLastName">Last Name</label>
                    <input type="text" id="joinLastName" class="form-input" placeholder="Enter your last name" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinCity">City</label>
                    <input type="text" id="joinCity" class="form-input" placeholder="Enter your city" required aria-required="true">
                </div>
                <button type="submit" id="joinButton" class="auth-button">Join</button>
            </form>
        </div>
    </div>

    <!-- Information Modals -->
    <div id="aboutPopup" class="modal-base" role="dialog" aria-labelledby="aboutTitle">
        <button id="closeAbout" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="aboutTitle">About Community Markers</h2>
        <p>
            Community Markers is a collaborative platform that allows users to discover, document, and share meaningful places across Minnesota through verified historical storytelling and community-driven curation.
        </p>
        <p>
            Our mission is to create a comprehensive digital heritage map that showcases the rich history, culture, and natural beauty of Minnesota through the collective knowledge and experiences of its residents and visitors.
        </p>
        <div class="collection-features">
            <h3 class="collection-features-title">Key Features</h3>
            <div class="collection-features-list">
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-users"></i></div>
                    <h4 class="collection-feature-title">Collaborative Stories</h4>
                    <p>Multiple users can contribute to location stories with peer review and moderation</p>
                </div>
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-shield-alt"></i></div>
                    <h4 class="collection-feature-title">Source Verification</h4>
                    <p>Upload documents and photos with citation management for historical accuracy</p>
                </div>
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-history"></i></div>
                    <h4 class="collection-feature-title">Version Control</h4>
                    <p>Track all edits and changes with detailed history timelines</p>
                </div>
            </div>
        </div>
        <p>
            Join our growing community of historians, storytellers, and explorers as we collectively preserve and celebrate Minnesota's heritage, one verified marker at a time!
        </p>
    </div>

    <div id="instructionsPopup" class="modal-base" role="dialog" aria-labelledby="instructionsTitle">
        <button id="closeInstructions" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="instructionsTitle">How to Use Community Markers</h2>
        <div class="collection-features">
            <h3 class="collection-features-title">Getting Started</h3>
            <ol style="padding-left: 1.5rem; line-height: 1.8;">
                <li><strong>Create an account</strong> to add markers and participate in community reviews</li>
                <li><strong>Explore the map</strong> to discover existing markers and stories</li>
                <li><strong>Add new markers</strong> by clicking on any location on the map</li>
                <li><strong>Upload source materials</strong> like photos and documents to verify your contributions</li>
                <li><strong>Review other submissions</strong> to help maintain quality and accuracy</li>
                <li><strong>Contribute to stories</strong> by adding additional information to existing markers</li>
                <li><strong>Create collections</strong> to organize markers by themes or routes</li>
            </ol>
        </div>
        <div class="collection-features">
            <h3 class="collection-features-title">Quality Guidelines</h3>
            <ul style="padding-left: 1.5rem; line-height: 1.8;">
                <li>Provide accurate historical information with proper citations</li>
                <li>Upload high-quality images with appropriate copyright permissions</li>
                <li>Be respectful when reviewing others' contributions</li>
                <li>Follow community guidelines and maintain appropriate language</li>
                <li>Verify information through reliable historical sources when possible</li>
            </ul>
        </div>
        <p><strong>Remember:</strong> All submissions go through a community review process to ensure accuracy and quality. Your contributions help preserve Minnesota's heritage for future generations!</p>
    </div>

    <div id="logoutPopup" class="modal-base auth-popup" role="dialog">
        <button id="cancelLogout" class="close-btn" aria-label="Close">&times;</button>
        <h2>Confirm Logout</h2>
        <p>Are you sure you want to log out? Any unsaved changes will be lost.</p>
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button id="confirmLogout" class="auth-button">Log Out</button>
            <button id="cancelLogoutBtn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>

    <!-- Marker Creation Modal -->
    <div id="markerModal" class="modal-base" role="dialog" aria-labelledby="addMarkerTitle">
        <button id="closeModal" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="addMarkerTitle">Add New Historical Marker</h2>
        <p>Share a meaningful location with the community. All submissions are reviewed for quality and accuracy.</p>
        <form id="markerForm">
            <div class="form-group">
                <label for="title" class="form-label">Title (max 50 characters)</label>
                <input type="text" id="title" class="form-input" maxlength="50" required aria-required="true" placeholder="Enter a descriptive title">
            </div>
            <div class="form-group">
                <label for="category" class="form-label">Category</label>
                <select id="category" class="form-input" required aria-required="true">
                    <option value="">Select a category</option>
                    <option value="architecture">Architecture & Buildings</option>
                    <option value="nature">Nature & Landscapes</option>
                    <option value="events">Historical Events</option>
                    <option value="people">People & Culture</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description-editor" class="form-label">Description & Historical Context</label>
                <textarea id="description-editor" placeholder="Provide detailed information about this location, its historical significance, and any interesting stories..."></textarea>
            </div>
            <div class="form-group">
                <label for="imageUpload" class="form-label">Primary Image</label>
                <input type="file" id="imageUpload" class="form-input" accept="image/*" aria-label="Upload Primary Image">
                <small style="color: #64748b; font-size: 0.85rem;">Upload a high-quality image that represents this location</small>
            </div>
            <div class="form-group">
                <label for="date" class="form-label">Date of Significance</label>
                <input type="date" id="date" class="form-input" required aria-required="true">
                <small style="color: #64748b; font-size: 0.85rem;">When did the significant event occur or when was this location established?</small>
            </div>
            <div class="form-group">
                <label class="form-label">Copyright & Licensing</label>
                <div class="copyright-options">
                    <div class="copyright-option">
                        <input type="checkbox" id="creativeCommons" name="copyright" value="creativeCommons">
                        <label for="creativeCommons">Release under Creative Commons BY-NC 4.0 License</label>
                    </div>
                    <div class="copyright-option">
                        <input type="checkbox" id="authorOwned" name="copyright" value="authorOwned">
                        <label for="authorOwned">I own the copyright to this content</label>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Submit for Community Review
            </button>
        </form>
    </div>

    <!-- Marker Information Modal -->
    <div id="markerInfoModal" class="modal-base" style="display: none;" role="dialog" aria-labelledby="markerInfoTitle">
        <button id="closeMarkerInfo" class="close-btn" aria-label="Close">&times;</button>
        <div class="marker-info-content">
            <div class="marker-image-container">
                <img id="markerInfoImage" src="" alt="" class="marker-image">
            </div>
            
            <div class="marker-details">
                <h3 id="markerInfoTitle" class="marker-title"></h3>
                <p class="upload-info" id="markerInfoUploader"></p>
                <div class="category-tags" id="markerInfoCategories"></div>
                <div class="description" id="markerInfoDescription"></div>
                
                <div class="source-citation">
                    <h4><i class="fas fa-copyright"></i> Copyright & Licensing</h4>
                    <div class="copyright-info" id="markerInfoCopyright"></div>
                </div>
                
                <div class="marker-stats">
                    <span id="markerInfoViews" class="stat-item">
                        <i class="fas fa-eye"></i>
                        <span>0 views</span>
                    </span>
                    <span id="markerInfoLikes" class="stat-item">
                        <i class="fas fa-heart"></i>
                        <span>0 likes</span>
                    </span>
                    <span id="markerInfoContributions" class="stat-item">
                        <i class="fas fa-users"></i>
                        <span>0 contributors</span>
                    </span>
                </div>
                
                <div class="interaction-buttons" id="interactionButtons">
                    <button id="likeButton" class="btn btn-primary">
                        <i class="fas fa-heart"></i> Like
                    </button>
                    <button id="addToCollectionButton" class="btn btn-secondary">
                        <i class="fas fa-folder-plus"></i> Add to Collection
                    </button>
                    <button id="contributeStoryButton" class="btn btn-success">
                        <i class="fas fa-feather"></i> Contribute Story
                    </button>
                    <button id="uploadSourcesButton" class="btn btn-warning">
                        <i class="fas fa-upload"></i> Upload Sources
                    </button>
                    <button id="viewHistoryButton" class="btn btn-secondary">
                        <i class="fas fa-history"></i> View History
                    </button>
                    <button id="reportButton" class="report-button">
                        <i class="fas fa-flag"></i> Report
                    </button>
                </div>
                
                <div class="share-buttons">
                    <button class="share-button facebook" aria-label="Share on Facebook">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="share-button twitter" aria-label="Share on Twitter">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="share-button linkedin" aria-label="Share on LinkedIn">
                        <i class="fab fa-linkedin-in"></i>
                    </button>
                </div>

                <!-- Story Contributions Section -->
                <div class="story-contribution-section">
                    <h3><i class="fas fa-book-open"></i> Community Stories</h3>
                    <div class="story-contributions" id="storyContributions"></div>
                </div>

                <!-- Comments Section -->
                <div class="comments-section">
                    <h3><i class="fas fa-comments"></i> Community Discussion</h3>
                    <div class="comments-list" id="commentsList"></div>
                    <form class="comment-form" id="commentForm">
                        <textarea class="form-input" placeholder="Share your thoughts, memories, or additional historical context..." required aria-label="Add a comment"></textarea>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-comment"></i> Post Comment
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Expanded Image Modal -->
    <div id="expandedImageModal" class="expanded-image-modal" role="dialog" aria-labelledby="expandedImageTitle">
        <button id="closeExpandedImage" class="expanded-image-close" aria-label="Close">&times;</button>
        <img id="expandedImage" class="expanded-image" src="" alt="Expanded marker image">
        <h3 id="expandedImageTitle" class="expanded-image-title"></h3>
    </div>

    <!-- Collections Modal -->
    <div id="collectionsModal" class="modal-base" role="dialog" aria-labelledby="collectionsTitle">
        <button id="closeCollections" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="collectionsTitle"><i class="fas fa-folder-open"></i> Your Collections</h2>
        <p>Create themed collections to organize and share your favorite Minnesota locations with the community.</p>
        
        <div class="collection-features">
            <h3 class="collection-features-title">Collection Features</h3>
            <div class="collection-features-list">
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <h4 class="collection-feature-title">Themed Tours</h4>
                    <p>Create collections for specific themes like "Historic Buildings" or "Scenic Lakes"</p>
                </div>
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-share-alt"></i></div>
                    <h4 class="collection-feature-title">Share with Friends</h4>
                    <p>Share your collections with friends and family planning to visit Minnesota</p>
                </div>
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-route"></i></div>
                    <h4 class="collection-feature-title">Plan Trips</h4>
                    <p>Use collections to plan your next Minnesota road trip or adventure</p>
                </div>
            </div>
        </div>
        
        <div class="collections-grid" id="collectionsGrid"></div>
        <button id="createCollectionBtn" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Collection
        </button>
    </div>

    <!-- Collection Markers Modal -->
    <div id="collectionMarkersModal" class="modal-base collection-markers-modal" role="dialog" aria-labelledby="collectionMarkersTitle">
        <button id="closeCollectionMarkers" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="collectionMarkersTitle">Collection Markers</h2>
        <p id="collectionMarkersDescription">View and manage markers in this collection.</p>
        <div class="collection-markers-list" id="collectionMarkersList"></div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="modal-base" role="dialog" aria-labelledby="leaderboardTitle">
        <button id="closeLeaderboard" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="leaderboardTitle"><i class="fas fa-trophy"></i> Community Leaderboard</h2>
        <p>Recognize our most active community contributors and their achievements in preserving Minnesota's heritage.</p>
        
        <div class="user-achievements">
            <h3><i class="fas fa-medal"></i> Available Achievements</h3>
            <div class="achievement-grid" id="achievementGrid"></div>
        </div>
        
        <div class="leaderboard" id="leaderboardList"></div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal-base" role="dialog" aria-labelledby="reportTitle">
        <button id="closeReport" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="reportTitle"><i class="fas fa-flag"></i> Report Content</h2>
        <p>Help us maintain community standards by reporting inappropriate or inaccurate content.</p>
        <form id="reportForm">
            <div class="form-group">
                <label class="form-label" for="reportReason">Reason for Report</label>
                <select id="reportReason" class="form-input" required aria-required="true">
                    <option value="">Select a reason</option>
                    <option value="inappropriate">Inappropriate Content</option>
                    <option value="spam">Spam or Promotional Content</option>
                    <option value="offensive">Offensive Language</option>
                    <option value="inaccurate">Historically Inaccurate Information</option>
                    <option value="copyright">Copyright Violation</option>
                    <option value="privacy">Privacy Violation</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="reportDetails">Additional Details</label>
                <textarea id="reportDetails" class="form-input" rows="4" required aria-required="true" placeholder="Please provide specific details about the issue..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Submit Report
            </button>
        </form>
    </div>

    <!-- History & Timeline Modal -->
    <div id="historyModal" class="modal-base" role="dialog" aria-labelledby="historyTitle" style="width: 1000px; max-width: 95%;">
        <button id="closeHistory" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="historyTitle"><i class="fas fa-history"></i> Marker History & Timeline</h2>
        <p>Track all changes, contributions, and reviews for this location with detailed version control.</p>
        
        <div class="history-timeline" id="historyTimeline">
            <h3><i class="fas fa-timeline"></i> Edit History</h3>
            <div class="timeline-container" id="timelineContainer"></div>
        </div>
        
        <div class="source-verification" id="sourceVerification">
            <h3><i class="fas fa-shield-alt"></i> Source Verification</h3>
            <div class="verification-status pending" id="verificationStatus">
                <i class="fas fa-clock"></i> Pending Verification
            </div>
            <div class="source-documents" id="sourceDocuments"></div>
            <div class="citation-list" id="citationList"></div>
            <button id="uploadSourcesBtn" class="btn btn-warning">
                <i class="fas fa-upload"></i> Upload Additional Sources
            </button>
        </div>
        
        <div class="peer-review-section" id="peerReviewSection">
            <h3><i class="fas fa-users-cog"></i> Peer Reviews</h3>
            <div class="review-summary" id="reviewSummary">
                <div class="review-summary-item approved">
                    <span class="review-summary-count" id="approvedCount">0</span>
                    <span class="review-summary-label">Approved</span>
                </div>
                <div class="review-summary-item neutral">
                    <span class="review-summary-count" id="neutralCount">0</span>
                    <span class="review-summary-label">Neutral</span>
                </div>
                <div class="review-summary-item rejected">
                    <span class="review-summary-count" id="rejectedCount">0</span>
                    <span class="review-summary-label">Rejected</span>
                </div>
            </div>
            <div id="reviewsList"></div>
            <div class="review-form-container">
                <div class="review-form-title">
                    <i class="fas fa-star"></i> Submit Your Review
                </div>
                <form id="reviewForm" class="comment-form">
                    <textarea class="form-input" placeholder="Provide your detailed review of this content's accuracy and quality..." required aria-label="Add your review"></textarea>
                    <div class="review-actions">
                        <button type="button" class="review-action-btn approve" id="approveReview">
                            <i class="fas fa-thumbs-up"></i> Approve
                        </button>
                        <button type="button" class="review-action-btn neutral" id="neutralReview">
                            <i class="fas fa-minus"></i> Neutral
                        </button>
                        <button type="button" class="review-action-btn reject" id="rejectReview">
                            <i class="fas fa-thumbs-down"></i> Reject
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Review
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Source Upload Modal -->
    <div id="sourceUploadModal" class="modal-base" role="dialog" aria-labelledby="sourceUploadTitle">
        <button id="closeSourceUpload" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="sourceUploadTitle"><i class="fas fa-upload"></i> Upload Source Documents</h2>
        <p>Help verify this location by uploading historical documents, photos, maps, or other source materials.</p>
        <form id="sourceUploadForm">
            <div class="form-group">
                <label class="form-label">Source Documents</label>
                <div class="dropzone" id="documentDropzone">
                    <div class="dz-message">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Drop files here or click to upload</span>
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">Supported: Images, PDFs, Word documents (Max 5MB each)</small>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="sourceTitle" class="form-label">Source Title</label>
                <input type="text" id="sourceTitle" class="form-input" required aria-required="true" placeholder="e.g., 'Minneapolis City Directory 1920'">
            </div>
            <div class="form-group">
                <label for="sourceAuthor" class="form-label">Author/Creator</label>
                <input type="text" id="sourceAuthor" class="form-input" required aria-required="true" placeholder="e.g., 'Minnesota Historical Society'">
            </div>
            <div class="form-group">
                <label for="sourceDate" class="form-label">Publication/Creation Date</label>
                <input type="date" id="sourceDate" class="form-input" required aria-required="true">
            </div>
            <div class="form-group">
                <label for="sourceUrl" class="form-label">Source URL (if available)</label>
                <input type="url" id="sourceUrl" class="form-input" placeholder="https://example.com/source">
            </div>
            <div class="form-group">
                <label for="sourceDescription" class="form-label">Description</label>
                <textarea id="sourceDescription" class="form-input" rows="3" placeholder="Describe what this source shows and how it relates to this location..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Submit Sources for Verification
            </button>
        </form>
    </div>

    <!-- Story Contribution Modal -->
    <div id="storyContributionModal" class="modal-base" role="dialog" aria-labelledby="storyContributionTitle">
        <button id="closeStoryContribution" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="storyContributionTitle"><i class="fas fa-feather"></i> Contribute to This Story</h2>
        <p>Add your knowledge, memories, or historical research to enhance this location's story for the community.</p>
        <form id="storyContributionForm">
            <div class="form-group">
                <label for="contributionType" class="form-label">Type of Contribution</label>
                <select id="contributionType" class="form-input" required aria-required="true">
                    <option value="">Select contribution type</option>
                    <option value="historical-context">Historical Context</option>
                    <option value="personal-memory">Personal Memory</option>
                    <option value="research-findings">Research Findings</option>
                    <option value="additional-details">Additional Details</option>
                    <option value="correction">Correction/Update</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contributionTitle" class="form-label">Contribution Title</label>
                <input type="text" id="contributionTitle" class="form-input" required aria-required="true" placeholder="Brief title for your contribution">
            </div>
            <div class="form-group">
                <label for="contributionContent" class="form-label">Your Contribution</label>
                <textarea id="contributionContent" class="form-input" rows="6" required aria-required="true" placeholder="Share your knowledge, memories, or research about this location..."></textarea>
            </div>
            <div class="form-group">
                <label for="contributionSources" class="form-label">Sources (optional)</label>
                <textarea id="contributionSources" class="form-input" rows="3" placeholder="List any sources that support your contribution..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Submit Contribution for Review
            </button>
        </form>
    </div>

    <!-- Moderation Dashboard Modal -->
    <div id="moderationModal" class="modal-base" role="dialog" aria-labelledby="moderationTitle" style="width: 1200px; max-width: 95%;">
        <button id="closeModerationModal" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="moderationTitle"><i class="fas fa-shield-alt"></i> Moderation Dashboard</h2>
        <p>Review pending submissions, manage community content, and maintain quality standards.</p>
        
        <div class="moderation-section">
            <h3><i class="fas fa-chart-bar"></i> Moderation Statistics</h3>
            <div class="moderation-stats" id="moderationStats">
                <div class="moderation-stat">
                    <span class="moderation-stat-number" id="pendingMarkersCount">0</span>
                    <span class="moderation-stat-label">Pending Markers</span>
                </div>
                <div class="moderation-stat">
                    <span class="moderation-stat-number" id="pendingStoriesCount">0</span>
                    <span class="moderation-stat-label">Pending Stories</span>
                </div>
                <div class="moderation-stat">
                    <span class="moderation-stat-number" id="reportsCount">0</span>
                    <span class="moderation-stat-label">Open Reports</span>
                </div>
                <div class="moderation-stat">
                    <span class="moderation-stat-number" id="verificationCount">0</span>
                    <span class="moderation-stat-label">Pending Verification</span>
                </div>
            </div>
        </div>
        
        <div id="moderationContent">
            <!-- Moderation content will be dynamically loaded here -->
        </div>
    </div>

    <!-- Version Comparison Modal -->
    <div id="versionComparisonModal" class="modal-base version-comparison-modal" role="dialog" aria-labelledby="versionComparisonTitle">
        <button id="closeVersionComparison" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="versionComparisonTitle"><i class="fas fa-code-branch"></i> Version Comparison</h2>
        <p>Compare different versions of this marker to see what has changed over time.</p>
        <div class="version-comparison" id="versionComparisonContent">
            <!-- Version comparison content will be dynamically loaded here -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>

    <script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
  authDomain: "mnthen-3151d.firebaseapp.com",
  projectId: "mnthen-3151d",
  storageBucket: "mnthen-3151d.appspot.com",
  messagingSenderId: "416231360428",
  appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
};

// Initialize Firebase
let firebaseApp;
if (!firebase.apps.length) {
  firebaseApp = firebase.initializeApp(firebaseConfig);
} else {
  firebaseApp = firebase.app();
}

const auth = firebaseApp.auth();
const database = firebaseApp.database();
const storage = firebaseApp.storage();

// Map Variables
let map = null;
let markers = null;
let tempMarker = null;

// Global Variables
let currentUser = null;
let currentMarkerId = null;
let selectedCategories = new Set(['architecture', 'nature', 'events', 'people']);
let currentCollectionId = null;
let categoryCounts = {
  architecture: 0,
  nature: 0,
  events: 0,
  people: 0
};

// Store original marker data by category
let markersByCategory = {
  architecture: [],
  nature: [],
  events: [],
  people: []
};

// Enhanced profanity filter
const profanityList = [
  "fuck", "fucking", "shit", "shitty", "damn", "hell", "ass", "asshole", 
  "bitch", "bastard", "cock", "dick", "pussy", "cunt", "prick", "twat",
  "motherfucker", "bullshit", "crap", "piss", "dammit", 
  "idiot", "moron", "stupid", "dumb", "retard", "tard", "loser", 
  "jerk", "jackass", "douche", "douchebag", "asshat",
  "hate", "kill", "die", "death", 
  "viagra", "casino", "poker", "loan", "mortgage", "bitcoin", "crypto",
  "trump", "biden", "liberal", "conservative", "democrat", "republican",
  "wisconsin", "iowa", "dakota",
  "fk", "fck", "sh1t", "f u c k", "b i t c h", "a s s", "wtf", "stfu"
];

function containsProfanity(text) {
  if (!text) return false;
  
  const normalizedText = text.toLowerCase()
    .replace(/[^\w\s]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  
  return profanityList.some(profanity => {
    const wordRegex = new RegExp(`\\b${profanity}\\b`, 'i');
    const substringMatch = normalizedText.includes(profanity.toLowerCase());
    return wordRegex.test(normalizedText) || substringMatch;
  });
}

// Points System Configuration
const POINTS = {
  ADD_MARKER: 15,
  RECEIVE_LIKE: 5,
  ADD_COMMENT: 3,
  MARKER_VIEW: 1,
  ADD_SOURCE: 8,
  STORY_CONTRIBUTION: 12,
  APPROVE_REVIEW: 4,
  COMPLETE_REVIEW: 10,
  VERIFY_SOURCE: 15,
  MODERATE_CONTENT: 20,
  FIRST_MARKER: 25,
  COLLECTION_CREATED: 10,
  HELPFUL_REPORT: 5
};

// Badge System Configuration
const BADGES = {
  NEWCOMER: { 
    name: "Newcomer", 
    icon: "star", 
    requirement: 10,
    description: "Welcome to the community!",
    color: "#64748b"
  },
  CONTRIBUTOR: { 
    name: "Active Contributor", 
    icon: "pen", 
    requirement: 50,
    description: "Regular community participant",
    color: "#2563eb"
  },
  HISTORIAN: { 
    name: "Local Historian", 
    icon: "book", 
    requirement: 100,
    description: "Knowledgeable about local history",
    color: "#8b5cf6"
  },
  PHOTOGRAPHER: { 
    name: "Photography Expert", 
    icon: "camera", 
    requirement: 75,
    description: "Shares quality historical photos",
    color: "#10b981"
  },
  EXPLORER: { 
    name: "Minnesota Explorer", 
    icon: "compass", 
    requirement: 150,
    description: "Discovers hidden gems across Minnesota",
    color: "#f59e0b"
  },
  VERIFIER: { 
    name: "Source Verifier", 
    icon: "shield-check", 
    requirement: 200,
    description: "Helps verify historical accuracy",
    color: "#059669"
  },
  REVIEWER: { 
    name: "Community Reviewer", 
    icon: "clipboard-check", 
    requirement: 250,
    description: "Active in peer review process",
    color: "#dc2626"
  },
  STORYTELLER: { 
    name: "Master Storyteller", 
    icon: "feather", 
    requirement: 300,
    description: "Exceptional at sharing historical narratives",
    color: "#7c3aed"
  },
  MODERATOR: { 
    name: "Community Moderator", 
    icon: "shield-alt", 
    requirement: 500,
    description: "Helps maintain community standards",
    color: "#059669"
  },
  LEGEND: { 
    name: "Minnesota Legend", 
    icon: "crown", 
    requirement: 1000,
    description: "Outstanding contribution to preserving Minnesota heritage",
    color: "#d97706"
  }
};

// Initialize Suneditor
let editor;

// Initialize Dropzone for source document uploads
let myDropzone;

// Initialize Map Function
function initializeMap() {
  if (!map && document.getElementById("map")) {
    map = L.map("map", {
      zoomControl: false,
      attributionControl: true
    }).setView([44.9778, -93.265], 10);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '',
      maxZoom: 18,
    }).addTo(map);

    markers = L.markerClusterGroup({
      disableClusteringAtZoom: 15,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    });
    
    map.addLayer(markers);

    // Add map click handler for authenticated users
    map.on("click", (e) => {
      if (!currentUser) {
        showNotification("Please log in to add markers.", "error");
        return;
      }
      if (tempMarker) map.removeLayer(tempMarker);
      tempMarker = L.marker(e.latlng).addTo(map);
      document.getElementById('markerModal').style.display = "block";
      document.getElementById('overlay').style.display = "block";
    });

    // Load existing markers
    loadMarkers();
    
    // Force map to update its size after initialization
    setTimeout(() => {
      map.invalidateSize();
    }, 100);
  }
}

// Load Markers Function
function loadMarkers() {
  if (!markers) return;

  markers.clearLayers();
  resetCategoryCounts();
  
  // Clear stored markers by category
  for (let category in markersByCategory) {
    markersByCategory[category] = [];
  }

  database.ref("markers").once("value", (snapshot) => {
    snapshot.forEach((childSnapshot) => {
      const markerData = childSnapshot.val();
      markerData.id = childSnapshot.key;
      
      // Only load approved markers or user's own markers
      if (markerData.status === 'approved' || 
          (currentUser && markerData.uploaderId === currentUser.uid)) {
        
        // Store marker data by category
        if (markerData.category && markersByCategory.hasOwnProperty(markerData.category)) {
          markersByCategory[markerData.category].push(markerData);
        }

        // Only add markers for active categories
        if (selectedCategories.has(markerData.category)) {
          addMarkerToMap(markerData);
          
          // Update category counts
          if (markerData.category && categoryCounts.hasOwnProperty(markerData.category)) {
            categoryCounts[markerData.category]++;
          }
        }
      }
    });
    
    // Update category count displays
    updateCategoryCountDisplay();
  });
}

// Reset Category Counts
function resetCategoryCounts() {
  for (let category in categoryCounts) {
    categoryCounts[category] = 0;
  }
}

// Update Category Count Display
function updateCategoryCountDisplay() {
  document.getElementById('architectureCount').textContent = categoryCounts.architecture;
  document.getElementById('natureCount').textContent = categoryCounts.nature;
  document.getElementById('eventsCount').textContent = categoryCounts.events;
  document.getElementById('peopleCount').textContent = categoryCounts.people;
}

// Add Marker to Map Function
function addMarkerToMap(markerData) {
  const categoryColors = {
    architecture: '#2563eb',
    nature: '#10b981',
    events: '#f59e0b',
    people: '#8b5cf6'
  };
  
  const defaultColor = '#2563eb';
  const markerColor = categoryColors[markerData.category] || defaultColor;
  
  // Create status indicator
  let statusIndicator = '';
  if (markerData.status === 'pending') {
    statusIndicator = '<div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background-color: #f59e0b; border-radius: 50%; border: 1px solid white;"></div>';
  } else if (markerData.status === 'verified') {
    statusIndicator = '<div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; border: 1px solid white;"></div>';
  }
  
  const customIcon = L.divIcon({
    className: 'custom-marker',
    html: `<div style="position: relative; background-color: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${statusIndicator}</div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12]
  });
  
  const marker = L.marker([markerData.lat, markerData.lng], { 
    icon: customIcon,
    alt: markerData.title,
    category: markerData.category
  });
  
  const statusBadge = markerData.status === 'pending' ? 
    '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">PENDING</span>' :
    markerData.status === 'verified' ? 
    '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">VERIFIED</span>' : '';
  
  const popupContent = `
    <div class="marker-popup" style="max-width: 250px;">
      <h2 style="margin: 0 0 8px 0; font-size: 16px;"><a href="#" class="title-link" data-marker-id="${markerData.id}" style="color: #2563eb; text-decoration: none;">${markerData.title}</a></h2>
      ${statusBadge}
      <p style="margin: 8px 0; color: #64748b; font-size: 14px; line-height: 1.4;">${stripHtml(markerData.description).split(" ").slice(0, 15).join(" ")}${stripHtml(markerData.description).split(" ").length > 15 ? "..." : ""}</p>
      <p style="margin: 4px 0; font-weight: 600; color: #1e3a8a; font-size: 12px;"><strong>Category:</strong> ${markerData.category ? markerData.category.charAt(0).toUpperCase() + markerData.category.slice(1) : 'Uncategorized'}</p>
      <p style="margin: 4px 0; color: #64748b; font-size: 11px;"><i class="fas fa-user"></i> ${markerData.uploaderName || "Anonymous"}</p>
    </div>
  `;
  marker.bindPopup(popupContent);

  marker.on('popupopen', function() {
    setTimeout(() => {
      const titleLink = document.querySelector(`.title-link[data-marker-id="${markerData.id}"]`);
      if (titleLink) {
        titleLink.addEventListener("click", (e) => {
          e.preventDefault();
          updateMarkerInfoModal(markerData);
          document.getElementById('markerInfoModal').style.display = "block";
          document.getElementById('overlay').style.display = "block";
          marker.closePopup();
        });
      }
    }, 100);
  });

  markers.addLayer(marker);
}

// Update Marker Info Modal Function
function updateMarkerInfoModal(data) {
  currentMarkerId = data.id;
  
  // Update basic info
  document.getElementById('markerInfoTitle').textContent = data.title;

  // Handle image display
  const markerInfoImage = document.getElementById('markerInfoImage');
  if (data.image) {
    markerInfoImage.src = data.image;
    markerInfoImage.style.cursor = "pointer";
    markerInfoImage.onclick = () => {
      document.getElementById('expandedImageModal').style.display = "flex";
      document.getElementById('expandedImage').src = data.image;
      document.getElementById('expandedImage').alt = data.title;
      document.getElementById('expandedImageTitle').textContent = data.title;
      document.getElementById('overlay').style.zIndex = "1000";
      document.getElementById('expandedImageModal').style.zIndex = "2000";
    };
  } else {
    markerInfoImage.src = "https://images.pexels.com/photos/417173/pexels-photo-417173.jpeg?auto=compress&cs=tinysrgb&w=400";
    markerInfoImage.style.cursor = "default";
    markerInfoImage.onclick = null;
  }

  markerInfoImage.alt = data.title;
  document.getElementById('markerInfoUploader').innerHTML = `<i class="fas fa-user"></i> Contributed by ${data.uploaderName || "Anonymous"} on ${new Date(data.date).toLocaleDateString()}`;
  
  // Display clean description text
  document.getElementById('markerInfoDescription').textContent = data.description ? stripHtml(data.description) : "";
  
  // Display copyright information
  const copyrightElement = document.getElementById('markerInfoCopyright');
  if (data.copyright) {
    let copyrightText = "";
    if (data.copyright.creativeCommons) {
      copyrightText += "Licensed under Creative Commons BY-NC 4.0. ";
    }
    if (data.copyright.authorOwned) {
      copyrightText += copyrightText ? "Author also retains rights." : "All associated content is author owned.";
    }
    copyrightElement.textContent = copyrightText || "Not specified";
  } else {
    copyrightElement.textContent = "Not specified";
  }
  
  // Update stats
  document.getElementById('markerInfoViews').innerHTML = `<i class="fas fa-eye"></i> <span>${data.views || 0} views</span>`;
  document.getElementById('markerInfoLikes').innerHTML = `<i class="fas fa-heart"></i> <span>${data.likes || 0} likes</span>`;
  
  // Load contribution count
  loadContributionCount(data.id);

  // Update category display
  document.getElementById('markerInfoCategories').innerHTML = `
    <span class="category-tag ${data.category || 'architecture'}">${data.category ? data.category.charAt(0).toUpperCase() + data.category.slice(1) : 'Uncategorized'}</span>
  `;

  // Load various sections
  loadComments(data.id);
  loadStoryContributions(data.id);
  loadSourceVerification(data.id);
  updateLikeButtonState();
  
  // Increment view count
  database.ref(`markers/${data.id}/views`).transaction((currentViews) => {
    return (currentViews || 0) + 1;
  }).then(() => {
    if (currentUser) {
      updateUserPoints(POINTS.MARKER_VIEW);
    }
  });
}

// Load Contribution Count
function loadContributionCount(markerId) {
  database.ref(`storyContributions/${markerId}`).once("value", (snapshot) => {
    const contributionCount = snapshot.numChildren();
    document.getElementById('markerInfoContributions').innerHTML = `<i class="fas fa-users"></i> <span>${contributionCount} contributors</span>`;
  });
}

// Load Story Contributions
function loadStoryContributions(markerId) {
  database.ref(`storyContributions/${markerId}`).orderByChild("timestamp").once("value", (snapshot) => {
    const contributionsContainer = document.getElementById('storyContributions');
    contributionsContainer.innerHTML = "";
    
    if (!snapshot.exists()) {
      contributionsContainer.innerHTML = "<p style='color: #64748b; font-style: italic;'>No community stories yet. Be the first to contribute!</p>";
      return;
    }
    
    const contributions = [];
    snapshot.forEach((childSnapshot) => {
      contributions.push({
        id: childSnapshot.key,
        ...childSnapshot.val(),
      });
    });
    
    // Show most recent first
    contributions.reverse();
    
    contributions.forEach(contribution => {
      const contributionElement = document.createElement('div');
      contributionElement.className = 'story-contribution';
      
      const statusClass = contribution.status || 'pending';
      const statusText = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
      
      contributionElement.innerHTML = `
        <div class="story-contribution-header">
          <div class="story-contributor-info">
            <div class="story-contributor-avatar">
              ${(contribution.userName || "A").charAt(0).toUpperCase()}
            </div>
            <div class="story-contributor-details">
              <div class="story-contributor-name">${contribution.userName || "Anonymous"}</div>
              <div class="story-contribution-date">
                <i class="fas fa-clock"></i> ${new Date(contribution.timestamp).toLocaleDateString()}
              </div>
            </div>
          </div>
          <div class="story-contribution-status ${statusClass}">
            ${statusText}
          </div>
        </div>
        <div class="story-contribution-text">${contribution.content}</div>
        ${contribution.type ? `<p style="font-size: 0.85rem; color: #64748b; margin: 0.5rem 0;"><strong>Type:</strong> ${contribution.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>` : ''}
        ${currentUser && (currentUser.uid === contribution.userId || isUserModerator()) ? `
          <div class="story-contribution-actions">
            ${contribution.status === 'pending' && isUserModerator() ? `
              <button class="story-action-btn approve" onclick="moderateStoryContribution('${contribution.id}', '${markerId}', 'approved')">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="story-action-btn reject" onclick="moderateStoryContribution('${contribution.id}', '${markerId}', 'rejected')">
                <i class="fas fa-times"></i> Reject
              </button>
            ` : ''}
          </div>
        ` : ''}
      `;
      
      contributionsContainer.appendChild(contributionElement);
    });
  });
}

// Load Source Verification Function
function loadSourceVerification(markerId) {
  database.ref(`markerSources/${markerId}`).once("value", (snapshot) => {
    const sourceDocuments = document.getElementById('sourceDocuments');
    const citationList = document.getElementById('citationList');
    const verificationStatus = document.getElementById('verificationStatus');
    
    // Check if elements exist (only in history modal)
    if (!sourceDocuments || !citationList || !verificationStatus) return;
    
    sourceDocuments.innerHTML = "";
    citationList.innerHTML = "";
    
    if (!snapshot.exists()) {
      verificationStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> No Sources Submitted';
      verificationStatus.className = "verification-status pending";
      sourceDocuments.innerHTML = "<p style='color: #64748b; font-style: italic;'>No source documents uploaded yet.</p>";
      citationList.innerHTML = "<p style='color: #64748b; font-style: italic;'>No citations provided yet.</p>";
      return;
    }
    
    const sourceData = snapshot.val();
    
    // Update verification status
    if (sourceData.verified) {
      verificationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Verified by Community';
      verificationStatus.className = "verification-status verified";
    } else if (sourceData.underReview) {
      verificationStatus.innerHTML = '<i class="fas fa-hourglass-half"></i> Under Review';
      verificationStatus.className = "verification-status under-review";
    } else {
      verificationStatus.innerHTML = '<i class="fas fa-clock"></i> Pending Verification';
      verificationStatus.className = "verification-status pending";
    }
    
    // Display source documents
    if (sourceData.documents && Object.keys(sourceData.documents).length > 0) {
      sourceDocuments.innerHTML = Object.values(sourceData.documents).map(doc => {
        const fileType = doc.type ? doc.type.split('/')[0] : 'document';
        const typeColor = fileType === 'image' ? '#10b981' : fileType === 'application' ? '#f59e0b' : '#2563eb';
        
        return `
          <div class="source-document">
            ${doc.type && doc.type.startsWith('image/') ? 
              `<img src="${doc.url}" alt="${doc.name}">` : 
              `<div style="width: 100%; height: 120px; background: linear-gradient(135deg, ${typeColor}, ${typeColor}99); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;"><i class="fas fa-file-alt"></i></div>`
            }
            <div class="source-document-overlay">${doc.name}</div>
            <div class="source-document-type" style="background-color: ${typeColor};">${fileType.toUpperCase()}</div>
          </div>
        `;
      }).join("");
    } else {
      sourceDocuments.innerHTML = "<p style='color: #64748b; font-style: italic;'>No documents uploaded</p>";
    }
    
    // Display citations
    if (sourceData.citations && sourceData.citations.length > 0) {
      citationList.innerHTML = sourceData.citations.map(citation => `
        <div class="citation-item">
          <div class="citation-title">${citation.title}</div>
          <div class="citation-details">${citation.author || 'Unknown Author'}</div>
          <div class="citation-meta">
            <div class="citation-meta-item">
              <i class="fas fa-calendar"></i>
              ${new Date(citation.date).toLocaleDateString()}
            </div>
            ${citation.url ? `
              <div class="citation-meta-item">
                <i class="fas fa-link"></i>
                <a href="${citation.url}" target="_blank">View Source</a>
              </div>
            ` : ''}
          </div>
          ${citation.description ? `<p style="margin-top: 0.8rem; font-size: 0.9rem; color: #4b5563;">${citation.description}</p>` : ''}
        </div>
      `).join("");
    } else {
      citationList.innerHTML = "<p style='color: #64748b; font-style: italic;'>No citations provided</p>";
    }
  });
}

// Moderate Story Contribution
window.moderateStoryContribution = function(contributionId, markerId, status) {
  if (!currentUser || !isUserModerator()) {
    showNotification("You don't have permission to moderate content.", "error");
    return;
  }
  
  database.ref(`storyContributions/${markerId}/${contributionId}/status`).set(status)
    .then(() => {
      showNotification(`Story contribution ${status}`, "success");
      loadStoryContributions(markerId);
      updateUserPoints(POINTS.MODERATE_CONTENT);
    })
    .catch(error => {
      showNotification(error.message, "error");
    });
};

// Check if user is moderator
function isUserModerator() {
  return currentUser && currentUser.email && (
    currentUser.email.includes('admin') || 
    currentUser.email.includes('moderator')
  );
}

// Helper function to strip HTML tags
function stripHtml(html) {
  const temp = document.createElement("div");
  temp.innerHTML = html;
  return temp.textContent || temp.innerText || "";
}

// Load Comments Function
function loadComments(markerId) {
  return database.ref(`comments/${markerId}`).orderByChild("timestamp").once("value").then((snapshot) => {
    const comments = [];
    snapshot.forEach((childSnapshot) => {
      comments.push({
        id: childSnapshot.key,
        ...childSnapshot.val(),
      });
    });
    
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = comments.length > 0 ?
      comments.reverse()
        .map(
          (comment) => `
            <div class="comment">
              <div class="comment-header">
                <span class="comment-author">${comment.userName || "Anonymous"}</span>
                <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
              </div>
              <p class="comment-text">${comment.text}</p>
            </div>
          `
        )
        .join("")
      : "<p style='color: #64748b; font-style: italic;'>No comments yet. Start the conversation!</p>";
    
    return comments;
  });
}

// Load History Timeline Function
function loadHistoryTimeline(markerId) {
  database.ref(`markerHistory/${markerId}`).orderByChild("timestamp").once("value", (snapshot) => {
    const timelineContainer = document.getElementById('timelineContainer');
    timelineContainer.innerHTML = "";
    
    if (!snapshot.exists()) {
      timelineContainer.innerHTML = "<p style='color: #64748b; text-align: center; font-style: italic;'>No edit history available for this marker.</p>";
      return;
    }
    
    const historyItems = [];
    snapshot.forEach((childSnapshot) => {
      historyItems.push({
        id: childSnapshot.key,
        ...childSnapshot.val(),
      });
    });
    
    // Show most recent first
    historyItems.reverse();
    
    historyItems.forEach((item, index) => {
      const isLeft = index % 2 === 0;
      const historyItem = document.createElement("div");
      
      // Determine the type of change for styling
      let changeType = 'edit';
      if (item.changeDescription && item.changeDescription.includes('Created')) {
        changeType = 'creation';
      } else if (item.changeDescription && item.changeDescription.includes('verified')) {
        changeType = 'verification';
      } else if (item.changeDescription && item.changeDescription.includes('review')) {
        changeType = 'review';
      }
      
      historyItem.className = `timeline-item ${isLeft ? 'left' : 'right'} ${changeType}`;
      
      const changesHtml = item.changes ? `
        <div class="timeline-changes">
          ${Object.entries(item.changes).map(([key, value]) => `
            <div class="timeline-change-item">
              <span class="timeline-change-label">${key}:</span>
              <span class="timeline-change-value">${typeof value === 'string' ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : value}</span>
            </div>
          `).join('')}
        </div>
      ` : '';
      
      historyItem.innerHTML = `
        <div class="timeline-content">
          <div class="timeline-date">
            <i class="fas fa-clock"></i>
            ${new Date(item.timestamp).toLocaleString()}
          </div>
          <div class="timeline-user">
            <i class="fas fa-user"></i>
            ${item.userName || "Anonymous"}
          </div>
          <div class="timeline-text">${item.changeDescription || "Updated marker details"}</div>
          ${changesHtml}
        </div>
      `;
      
      timelineContainer.appendChild(historyItem);
    });
  });
}

// Load Peer Reviews Function
function loadPeerReviews(markerId) {
  database.ref(`markerReviews/${markerId}`).orderByChild("timestamp").once("value", (snapshot) => {
    const reviewsList = document.getElementById('reviewsList');
    const approvedCount = document.getElementById('approvedCount');
    const neutralCount = document.getElementById('neutralCount');
    const rejectedCount = document.getElementById('rejectedCount');
    
    reviewsList.innerHTML = "";
    
    if (!snapshot.exists()) {
      reviewsList.innerHTML = "<p style='color: #64748b; font-style: italic; text-align: center;'>No reviews yet. Be the first to review this content!</p>";
      approvedCount.textContent = "0";
      neutralCount.textContent = "0";
      rejectedCount.textContent = "0";
      return;
    }
    
    const reviews = [];
    let counts = { approved: 0, neutral: 0, rejected: 0 };
    
    snapshot.forEach((childSnapshot) => {
      const review = {
        id: childSnapshot.key,
        ...childSnapshot.val(),
      };
      reviews.push(review);
      counts[review.status] = (counts[review.status] || 0) + 1;
    });
    
    // Update counts
    approvedCount.textContent = counts.approved;
    neutralCount.textContent = counts.neutral;
    rejectedCount.textContent = counts.rejected;
    
    // Show most recent first
    reviews.reverse();
    
    reviewsList.innerHTML = reviews.map(review => {
      const authorInitial = (review.userName || "A").charAt(0).toUpperCase();
      
      return `
        <div class="review-item">
          <div class="review-status-badge ${review.status}">${review.status.toUpperCase()}</div>
          <div class="review-header">
            <div class="review-author-info">
              <div class="review-author-avatar">${authorInitial}</div>
              <div class="review-author-details">
                <div class="review-author">${review.userName || "Anonymous"}</div>
                <div class="review-date">
                  <i class="fas fa-clock"></i>
                  ${new Date(review.timestamp).toLocaleDateString()}
                </div>
              </div>
            </div>
          </div>
          <div class="review-text">${review.text}</div>
        </div>
      `;
    }).join("");
  });
}

// Update Like Button State Function
function updateLikeButtonState() {
  const likeButton = document.getElementById('likeButton');
  
  if (!currentUser || !currentMarkerId) {
    likeButton.disabled = true;
    likeButton.innerHTML = '<i class="far fa-heart"></i> Login to Like';
    return;
  }

  likeButton.disabled = false;

  database.ref(`likes/${currentMarkerId}/${currentUser.uid}`).once("value", (snapshot) => {
    if (snapshot.exists()) {
      likeButton.classList.add("liked");
      likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
    } else {
      likeButton.classList.remove("liked");
      likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
    }
  });
}

// Show Notification Function
function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = "block";

  setTimeout(() => {
    notification.style.display = "none";
  }, 5000);
}

// Update User Points Function
function updateUserPoints(points) {
  if (!currentUser) return;

  const userPointsRef = database.ref(`users/${currentUser.uid}/points`);

  userPointsRef.transaction((currentPoints) => {
    return (currentPoints || 0) + points;
  }).then(() => {
    checkForBadges();
    showNotification(`+${points} points earned!`, "success");
  });
}

// Check for Badges Function
function checkForBadges() {
  if (!currentUser) return;

  database.ref(`users/${currentUser.uid}`).once("value", (snapshot) => {
    const userData = snapshot.val() || {};
    const points = userData.points || 0;
    const currentBadges = userData.badges || [];
    const earnedBadges = [];

    for (const [badgeId, badge] of Object.entries(BADGES)) {
      if (points >= badge.requirement && !currentBadges.includes(badgeId)) {
        earnedBadges.push(badgeId);
        showNotification(`🎉 Badge Earned: ${badge.name}!`, "success");
      }
    }

    if (earnedBadges.length > 0) {
      const updatedBadges = [...currentBadges, ...earnedBadges];
      database.ref(`users/${currentUser.uid}/badges`).set(updatedBadges);
    }
  });
}

// Load User Data Function
function loadUserData() {
  if (!currentUser) return;

  database.ref(`users/${currentUser.uid}`).once("value", (snapshot) => {
    const userData = snapshot.val() || {};

    if (userData.firstName && userData.lastName) {
      currentUser.displayName = `${userData.firstName} ${userData.lastName}`;
    }

    // Update UI based on user data
    const loginLink = document.getElementById('loginLink');
    loginLink.textContent = "Logout";
    loginLink.removeEventListener("click", showLoginPopup);
    loginLink.addEventListener("click", showLogoutPopup);
    
    // Show moderation link for moderators
    const moderationLink = document.getElementById('moderationLink');
    if (isUserModerator()) {
      moderationLink.style.display = 'block';
    } else {
      moderationLink.style.display = 'none';
    }
  });
}

// Show Login Popup Function
function showLoginPopup(e) {
  e.preventDefault();
  document.getElementById('authPopup').style.display = "block";
  document.getElementById('overlay').style.display = "block";
}

// Show Logout Popup Function
function showLogoutPopup(e) {
  e.preventDefault();
  document.getElementById('logoutPopup').style.display = "block";
  document.getElementById('overlay').style.display = "block";
}

// Toggle Category Visibility
function toggleCategoryVisibility(category) {
  const badge = document.querySelector(`.category-badge[data-category="${category}"]`);
  
  if (selectedCategories.has(category)) {
    selectedCategories.delete(category);
    badge.classList.remove("active");
    badge.classList.add("inactive");
    categoryCounts[category] = 0;
  } else {
    selectedCategories.add(category);
    badge.classList.add("active");
    badge.classList.remove("inactive");
    
    markersByCategory[category].forEach(markerData => {
      addMarkerToMap(markerData);
      categoryCounts[category]++;
    });
  }
  
  updateCategoryCountDisplay();
  refreshMapMarkers();
}

// Refresh Map Markers
function refreshMapMarkers() {
  if (!markers) return;
  
  markers.clearLayers();
  
  for (let category in markersByCategory) {
    if (selectedCategories.has(category)) {
      markersByCategory[category].forEach(markerData => {
        addMarkerToMap(markerData);
      });
    }
  }
}

// Perform Search Function
function performSearch(searchTerm) {
  if (!searchTerm.toLowerCase().includes("minnesota") && !searchTerm.toLowerCase().includes("mn")) {
    searchTerm = searchTerm + " Minnesota";
  }
  
  showNotification("Searching for location...", "info");
  
  const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}&limit=5`;
  
  fetch(geocodingUrl)
    .then((response) => response.json())
    .then((data) => {
      const mnResults = data.filter(result => {
        return (result.display_name.toLowerCase().includes("minnesota") || 
                result.display_name.toLowerCase().includes(", mn,")) &&
               result.display_name.toLowerCase().includes("united states");
      });
      
      if (mnResults.length > 0) {
        const result = mnResults[0];
        map.setView([result.lat, result.lon], 13);
        
        const resultText = mnResults.length === 1 ? "result" : "results";
        showNotification(`Found ${mnResults.length} ${resultText} for "${searchTerm}"`, "success");
      } else {
        showNotification("No locations found in Minnesota. Try a different search term.", "error");
      }
    })
    .catch((error) => {
      console.error("Search error:", error);
      showNotification("An error occurred while searching. Please try again.", "error");
    });
}

// Load Collections Function
function loadCollections() {
  if (!currentUser) return;

  database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
    const collectionsGrid = document.getElementById('collectionsGrid');
    collectionsGrid.innerHTML = "";

    if (!snapshot.exists()) {
      collectionsGrid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #64748b;">
          <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; color: #cbd5e1;"></i>
          <h3>No Collections Yet</h3>
          <p>Create your first collection to organize meaningful Minnesota locations.</p>
        </div>
      `;
      return;
    }

    snapshot.forEach((childSnapshot) => {
      const collection = childSnapshot.val();
      const collectionId = childSnapshot.key;
      const markerCount = collection.markers ? Object.keys(collection.markers).length : 0;

      const collectionCard = document.createElement('div');
      collectionCard.className = 'collection-card';
      collectionCard.innerHTML = `
        <img src="${collection.image || 'https://images.pexels.com/photos/417173/pexels-photo-417173.jpeg?auto=compress&cs=tinysrgb&w=400'}" alt="${collection.name}" class="collection-image">
        <div class="collection-actions">
          <button class="collection-action-btn" onclick="shareCollection('${collectionId}')" title="Share Collection">
            <i class="fas fa-share"></i>
          </button>
          <button class="collection-action-btn" onclick="deleteCollection('${collectionId}')" title="Delete Collection">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="collection-info">
          <h3 class="collection-title">${collection.name}</h3>
          <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">${collection.description || 'No description provided'}</p>
          <div class="collection-stats">
            <span><i class="fas fa-map-marker-alt"></i> ${markerCount} markers</span>
            <span><i class="fas fa-calendar"></i> ${new Date(collection.created).toLocaleDateString()}</span>
          </div>
          <button onclick="viewCollectionMarkers('${collectionId}', '${collection.name}')" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
            <i class="fas fa-eye"></i> View Markers
          </button>
        </div>
      `;

      collectionsGrid.appendChild(collectionCard);
    });
  });
}

// Load Leaderboard Function
function loadLeaderboard() {
  database.ref("users").orderByChild("points").limitToLast(20).once("value", (snapshot) => {
    const leaderboardList = document.getElementById('leaderboardList');
    const achievementGrid = document.getElementById('achievementGrid');
    
    // Load achievements first
    achievementGrid.innerHTML = Object.entries(BADGES).map(([badgeId, badge]) => `
      <div class="achievement-card">
        <div class="achievement-icon" style="color: ${badge.color};">
          <i class="fas fa-${badge.icon}"></i>
        </div>
        <div class="achievement-title">${badge.name}</div>
        <div class="achievement-description">${badge.description}</div>
        <div class="achievement-progress">
          <div class="achievement-progress-bar">
            <div class="achievement-progress-fill" style="width: ${currentUser ? Math.min((getUserPoints() / badge.requirement) * 100, 100) : 0}%;"></div>
          </div>
          <div class="achievement-progress-text">${badge.requirement} points required</div>
        </div>
      </div>
    `).join('');

    // Load leaderboard
    const users = [];
    snapshot.forEach((childSnapshot) => {
      const user = childSnapshot.val();
      users.push({
        id: childSnapshot.key,
        ...user,
      });
    });

    users.reverse(); // Highest points first

    leaderboardList.innerHTML = `
      <div class="leaderboard-title">Top Contributors</div>
      ${users.map((user, index) => `
        <div class="leaderboard-item">
          <div class="leaderboard-rank">${index + 1}</div>
          <div class="leaderboard-user">
            ${user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : 'Anonymous User'}
            <div style="font-size: 0.8rem; color: #64748b; font-weight: normal;">${user.city || 'Minnesota'}</div>
          </div>
          <div class="leaderboard-points">${user.points || 0} pts</div>
        </div>
      `).join('')}
    `;
  });
}

// Get current user points
function getUserPoints() {
  // This would normally fetch from database, simplified for demo
  return 0;
}

// Initialize Application
document.addEventListener("DOMContentLoaded", () => {
  // Initialize Suneditor
  if (document.getElementById('description-editor')) {
    editor = SUNEDITOR.create('description-editor', {
      height: '200px',
      fontSizeUnit: 'px',
      defaultStyle: 'font-size: 15px;',
      buttonList: [
        ['undo', 'redo'],
        ['font', 'fontSize', 'formatBlock'],
        ['bold', 'underline', 'italic', 'strike'],
        ['fontColor', 'hiliteColor'],
        ['align', 'list'],
        ['link'],
        ['showBlocks', 'codeView'],
      ],
      placeholder: 'Provide detailed information about this location...'
    });
  }

  // Initialize Dropzone
  Dropzone.autoDiscover = false;
  if (document.getElementById('documentDropzone')) {
    myDropzone = new Dropzone('#documentDropzone', {
      url: "#",
      autoProcessQueue: false,
      maxFiles: 10,
      maxFilesize: 5,
      acceptedFiles: 'image/*,.pdf,.doc,.docx',
      addRemoveLinks: true,
      dictDefaultMessage: "Drop files here or click to upload",
      dictRemoveFile: "Remove file",
      dictFileTooBig: "File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB.",
      dictInvalidFileType: "You can't upload files of this type.",
      init: function() {
        this.on("addedfile", function(file) {
          console.log("File added: ", file.name);
        });
      }
    });
  }

  // Set current date as default for date input
  const today = new Date().toISOString().split('T')[0];
  if (document.getElementById('date')) {
    document.getElementById('date').value = today;
  }
  
  // Show search page first
  document.getElementById('searchPage').style.display = "flex";
  document.getElementById('mapPage').style.display = "none";

  // Initialize Firebase Auth state
  auth.onAuthStateChanged((user) => {
    currentUser = user;

    if (user) {
      showNotification("Welcome back!", "success");
      loadUserData();
    } else {
      const loginLink = document.getElementById('loginLink');
      loginLink.textContent = "Login/Join";
      loginLink.removeEventListener("click", showLogoutPopup);
      loginLink.addEventListener("click", showLoginPopup);
    }
  });

  // Initialize map observer
  const mapPageObserver = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === "style") {
        if (document.getElementById('mapPage').style.display === "block" && !map) {
          initializeMap();
        }
      }
    });
  });

  mapPageObserver.observe(document.getElementById('mapPage'), {
    attributes: true,
  });

  // Setup all event listeners
  setupEventListeners();
});

// Setup Event Listeners Function
function setupEventListeners() {
  // Floating menu
  document.getElementById('floatingBtn').addEventListener("click", () => {
    const menuContent = document.getElementById('menuContent');
    menuContent.style.display = menuContent.style.display === "block" ? "none" : "block";
  });

  // Close menu when clicking outside
  document.addEventListener("click", (e) => {
    const floatingBtn = document.getElementById('floatingBtn');
    const menuContent = document.getElementById('menuContent');
    if (e.target !== floatingBtn && !floatingBtn.contains(e.target) && menuContent.style.display === "block") {
      menuContent.style.display = "none";
    }
  });

  // Menu content links
  document.getElementById('menuContent').addEventListener("click", (e) => {
    if (e.target.tagName === "A") {
      document.getElementById('menuContent').style.display = "none";
    }
    e.stopPropagation();
  });

  // Auth tabs
  document.getElementById('showLogin').addEventListener("click", () => {
    document.getElementById('loginForm').style.display = "block";
    document.getElementById('joinForm').style.display = "none";
    document.getElementById('showLogin').classList.add("active");
    document.getElementById('showJoin').classList.remove("active");
  });

  document.getElementById('showJoin').addEventListener("click", () => {
    document.getElementById('loginForm').style.display = "none";
    document.getElementById('joinForm').style.display = "block";
    document.getElementById('showJoin').classList.add("active");
    document.getElementById('showLogin').classList.remove("active");
  });

  // Close buttons for all modals
  const closeButtons = [
    'closePopup', 'closeAbout', 'closeInstructions', 'cancelLogout', 
    'closeModal', 'closeMarkerInfo', 'closeExpandedImage', 'closeCollections',
    'closeCollectionMarkers', 'closeLeaderboard', 'closeReport', 'closeHistory',
    'closeSourceUpload', 'closeStoryContribution', 'closeModerationModal',
    'closeVersionComparison'
  ];

  closeButtons.forEach(buttonId => {
    const button = document.getElementById(buttonId);
    if (button) {
      button.addEventListener("click", closeAllModals);
    }
  });

  // Auth forms
  document.getElementById('loginForm').addEventListener("submit", (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    auth.signInWithEmailAndPassword(email, password)
      .then((userCredential) => {
        showNotification("Logged in successfully", "success");
        closeAllModals();
        currentUser = userCredential.user;
        loadUserData();
      })
      .catch((error) => {
        showNotification(error.message, "error");
      });
  });

  document.getElementById('joinForm').addEventListener("submit", (e) => {
    e.preventDefault();
    const email = document.getElementById('joinEmail').value;
    const password = document.getElementById('joinPassword').value;
    const firstName = document.getElementById('joinFirstName').value;
    const lastName = document.getElementById('joinLastName').value;
    const city = document.getElementById('joinCity').value;

    auth.createUserWithEmailAndPassword(email, password)
      .then((userCredential) => {
        currentUser = userCredential.user;
        return database.ref("users/" + userCredential.user.uid).set({
          firstName: firstName,
          lastName: lastName,
          city: city,
          email: email,
          points: 0,
          badges: [],
          joinDate: Date.now(),
        });
      })
      .then(() => {
        showNotification("Account created successfully! Welcome to the community!", "success");
        closeAllModals();
        loadUserData();
        updateUserPoints(POINTS.FIRST_MARKER); // Welcome bonus
      })
      .catch((error) => {
        showNotification(error.message, "error");
      });
  });

  // Logout
  document.getElementById('confirmLogout').addEventListener("click", () => {
    auth.signOut().then(() => {
      showNotification("Logged out successfully", "success");
      closeAllModals();
      currentUser = null;
    }).catch((error) => {
      showNotification(error.message, "error");
    });
  });

  document.getElementById('cancelLogoutBtn').addEventListener("click", closeAllModals);

  // Navigation links
  document.getElementById('aboutLink').addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById('aboutPopup').style.display = "block";
    document.getElementById('overlay').style.display = "block";
  });

  document.getElementById('instructionsLink').addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById('instructionsPopup').style.display = "block";
    document.getElementById('overlay').style.display = "block";
  });

  document.getElementById('collectionsLink').addEventListener("click", (e) => {
    e.preventDefault();
    if (!currentUser) {
      showNotification("Please log in to view collections", "error");
      return;
    }
    loadCollections();
    document.getElementById('collectionsModal').style.display = "block";
    document.getElementById('overlay').style.display = "block";
  });

  document.getElementById('leaderboardLink').addEventListener("click", (e) => {
    e.preventDefault();
    loadLeaderboard();
    document.getElementById('leaderboardModal').style.display = "block";
    document.getElementById('overlay').style.display = "block";
  });

  document.getElementById('historyLink').addEventListener("click", (e) => {
    e.preventDefault();
    showNotification("Please select a marker to view its history", "info");
  });

  document.getElementById('moderationLink').addEventListener("click", (e) => {
    e.preventDefault();
    if (!currentUser || !isUserModerator()) {
      showNotification("You don't have moderation permissions", "error");
      return;
    }
    document.getElementById('moderationModal').style.display = "block";
    document.getElementById('overlay').style.display = "block";
  });

  document.getElementById('homeLink').addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById('searchPage').style.display = "flex";
    document.getElementById('mapPage').style.display = "none";
  });

  // Search functionality
  document.getElementById('scrollDown').addEventListener("click", () => {
    document.getElementById('searchPage').style.display = "none";
    document.getElementById('mapPage').style.display = "block";
    if (!map) {
      initializeMap();
    }
  });

  document.getElementById('infoButton').addEventListener("click", () => {
    document.getElementById('aboutPopup').style.display = "block";
    document.getElementById('overlay').style.display = "block";
  });

  document.getElementById('searchButton').addEventListener("click", () => {
    const searchTerm = document.getElementById('searchInput').value;
    if (searchTerm.trim() === "") {
      showNotification("Please enter a search term", "error");
      return;
    }

    document.getElementById('searchPage').style.display = "none";
    document.getElementById('mapPage').style.display = "block";

    if (!map) {
      initializeMap();
    }

    performSearch(searchTerm);
  });

  document.getElementById('mapSearchButton').addEventListener("click", () => {
    const searchTerm = document.getElementById('mapSearchInput').value;
    if (searchTerm.trim() === "") {
      showNotification("Please enter a search term", "error");
      return;
    }
    performSearch(searchTerm);
  });

  // Enter key support for search inputs
  document.getElementById('searchInput').addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      document.getElementById('searchButton').click();
    }
  });

  document.getElementById('mapSearchInput').addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      document.getElementById('mapSearchButton').click();
    }
  });

  // Recenter button
  document.getElementById('recenterButton').addEventListener("click", () => {
    if (map) {
      map.setView([44.9778, -93.265], 10);
    }
  });

  // Enhanced Marker form submission
  document.getElementById('markerForm').addEventListener("submit", (e) => {
    e.preventDefault();

    const title = document.getElementById('title').value;
    const category = document.getElementById('category').value;
    const description = editor ? editor.getContents() : document.getElementById('description-editor').value;
    const date = document.getElementById('date').value;
    const imageUpload = document.getElementById('imageUpload');
    
    const copyright = {
      creativeCommons: document.getElementById('creativeCommons').checked,
      authorOwned: document.getElementById('authorOwned').checked
    };

    // Enhanced profanity check
    if (containsProfanity(title) || containsProfanity(stripHtml(description))) {
      showNotification("Please keep your content appropriate for all community members.", "error");
      return;
    }

    if (!tempMarker) {
      showNotification("Please select a location on the map", "error");
      return;
    }

    const newMarkerRef = database.ref("markers").push();
    const newMarker = {
      id: newMarkerRef.key,
      title: title,
      category: category,
      description: description,
      lat: tempMarker.getLatLng().lat,
      lng: tempMarker.getLatLng().lng,
      uploaderName: currentUser.displayName || "Anonymous",
      uploaderId: currentUser.uid,
      date: date,
      timestamp: Date.now(),
      views: 0,
      likes: 0,
      copyright: copyright,
      status: "pending"
    };

    // Create detailed history entry
    const historyEntry = {
      userId: currentUser.uid,
      userName: currentUser.displayName || "Anonymous",
      timestamp: Date.now(),
      changeDescription: "Created marker",
      changes: {
        title: title,
        description: description.substring(0, 200) + (description.length > 200 ? '...' : ''),
        category: category,
        location: `${tempMarker.getLatLng().lat.toFixed(6)}, ${tempMarker.getLatLng().lng.toFixed(6)}`
      }
    };

    // Handle image upload
    if (imageUpload.files.length > 0) {
      const file = imageUpload.files[0];
      const storageRef = storage.ref("marker_images/" + newMarkerRef.key);

      storageRef.put(file).then((snapshot) => {
        return snapshot.ref.getDownloadURL();
      }).then((downloadURL) => {
        newMarker.image = downloadURL;
        return newMarkerRef.set(newMarker);
      }).then(() => {
        return database.ref(`markerHistory/${newMarkerRef.key}`).push().set(historyEntry);
      }).then(() => {
        showNotification("Marker submitted for community review! You'll be notified when it's approved.", "success");
        closeMarkerModal();
        updateUserPoints(POINTS.ADD_MARKER);
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    } else {
      newMarkerRef.set(newMarker)
        .then(() => {
          return database.ref(`markerHistory/${newMarkerRef.key}`).push().set(historyEntry);
        })
        .then(() => {
          showNotification("Marker submitted for community review! You'll be notified when it's approved.", "success");
          closeMarkerModal();
          updateUserPoints(POINTS.ADD_MARKER);
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    }
  });

  // Report form
  document.getElementById('reportForm').addEventListener("submit", (e) => {
    e.preventDefault();
    
    const reason = document.getElementById('reportReason').value;
    const details = document.getElementById('reportDetails').value;
    
    if (!currentUser) {
      showNotification("Please log in to submit reports", "error");
      return;
    }
    
    const reportRef = database.ref('reports').push();
    reportRef.set({
      markerId: currentMarkerId,
      reporterId: currentUser.uid,
      reporterName: currentUser.displayName || "Anonymous",
      reason: reason,
      details: details,
      timestamp: Date.now(),
      status: 'pending'
    }).then(() => {
      showNotification("Report submitted successfully. Thank you for helping maintain community standards.", "success");
      closeAllModals();
      document.getElementById('reportForm').reset();
      updateUserPoints(POINTS.HELPFUL_REPORT);
    }).catch((error) => {
      showNotification(error.message, "error");
    });
  });

  // Story contribution form
  document.getElementById('storyContributionForm').addEventListener("submit", (e) => {
    e.preventDefault();
    
    const type = document.getElementById('contributionType').value;
    const title = document.getElementById('contributionTitle').value;
    const content = document.getElementById('contributionContent').value;
    const sources = document.getElementById('contributionSources').value;
    
    if (!currentUser || !currentMarkerId) {
      showNotification("Please log in and select a marker", "error");
      return;
    }

    if (containsProfanity(title) || containsProfanity(content)) {
      showNotification("Please keep contributions respectful and appropriate.", "error");
      return;
    }
    
    const contributionRef = database.ref(`storyContributions/${currentMarkerId}`).push();
    contributionRef.set({
      userId: currentUser.uid,
      userName: currentUser.displayName || "Anonymous",
      type: type,
      title: title,
      content: content,
      sources: sources,
      timestamp: Date.now(),
      status: "pending"
    }).then(() => {
      showNotification("Story contribution submitted for review!", "success");
      closeAllModals();
      document.getElementById('storyContributionForm').reset();
      updateUserPoints(POINTS.STORY_CONTRIBUTION);
      if (currentMarkerId) {
        loadStoryContributions(currentMarkerId);
      }
    }).catch((error) => {
      showNotification(error.message, "error");
    });
  });

  // Source upload form
  document.getElementById('sourceUploadForm').addEventListener("submit", (e) => {
    e.preventDefault();
    
    const sourceTitle = document.getElementById('sourceTitle').value;
    const sourceAuthor = document.getElementById('sourceAuthor').value;
    const sourceDate = document.getElementById('sourceDate').value;
    const sourceUrl = document.getElementById('sourceUrl').value;
    const sourceDescription = document.getElementById('sourceDescription').value;
    
    if (!currentUser || !currentMarkerId) {
      showNotification("Please log in and select a marker", "error");
      return;
    }
    
    const sourceRef = database.ref(`markerSources/${currentMarkerId}`).push();
    sourceRef.set({
      title: sourceTitle,
      author: sourceAuthor,
      date: sourceDate,
      url: sourceUrl,
      description: sourceDescription,
      uploaderId: currentUser.uid,
      uploaderName: currentUser.displayName || "Anonymous",
      timestamp: Date.now(),
      status: "pending"
    }).then(() => {
      showNotification("Source documents submitted for verification!", "success");
      closeAllModals();
      document.getElementById('sourceUploadForm').reset();
      updateUserPoints(POINTS.ADD_SOURCE);
    }).catch((error) => {
      showNotification(error.message, "error");
    });
  });

  // Category badges
  document.querySelectorAll('.category-badge').forEach((badge) => {
    badge.addEventListener("click", () => {
      const category = badge.dataset.category;
      toggleCategoryVisibility(category);
    });
  });

  // Button event listeners for marker info modal
  setupMarkerInfoButtonListeners();

  // Additional modal close buttons and overlay clicks
  document.getElementById('overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('overlay')) {
      closeAllModals();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllModals();
    }
  });

  // Setup enhanced event listeners for interactive elements
  setupEnhancedEventListeners();
}

// Setup Marker Info Button Listeners
function setupMarkerInfoButtonListeners() {
  // Like button
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'likeButton' || e.target.closest('#likeButton'))) {
      handleLikeButton();
    }
  });

  // Add to Collection button
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'addToCollectionButton' || e.target.closest('#addToCollectionButton'))) {
      handleAddToCollection();
    }
  });

  // Contribute Story button
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'contributeStoryButton' || e.target.closest('#contributeStoryButton'))) {
      handleContributeStory();
    }
  });

  // Upload Sources button
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'uploadSourcesButton' || e.target.closest('#uploadSourcesButton'))) {
      handleUploadSources();
    }
  });

  // View History button
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'viewHistoryButton' || e.target.closest('#viewHistoryButton'))) {
      handleViewHistory();
    }
  });

  // Report button
  document.addEventListener('click', (e) => {
    if (e.target && (e.target.id === 'reportButton' || e.target.closest('#reportButton'))) {
      if (!currentUser) {
        showNotification("Please log in to report content", "error");
        return;
      }
      document.getElementById('reportModal').style.display = "block";
      document.getElementById('overlay').style.display = "block";
    }
  });
}

// Handle Add to Collection
function handleAddToCollection() {
  if (!currentUser) {
    showNotification("Please log in to add markers to collections", "error");
    return;
  }
  
  if (!currentMarkerId) {
    showNotification("No marker selected", "error");
    return;
  }
  
  showNotification("Add to Collection feature coming soon!", "info");
}

// Handle Contribute Story
function handleContributeStory() {
  if (!currentUser) {
    showNotification("Please log in to contribute stories", "error");
    return;
  }
  
  if (!currentMarkerId) {
    showNotification("No marker selected", "error");
    return;
  }
  
  document.getElementById('storyContributionModal').style.display = "block";
  document.getElementById('overlay').style.display = "block";
}

// Handle Upload Sources
function handleUploadSources() {
  if (!currentUser) {
    showNotification("Please log in to upload sources", "error");
    return;
  }
  
  if (!currentMarkerId) {
    showNotification("No marker selected", "error");
    return;
  }
  
  document.getElementById('sourceUploadModal').style.display = "block";
  document.getElementById('overlay').style.display = "block";
}

// Handle View History
function handleViewHistory() {
  if (!currentMarkerId) {
    showNotification("No marker selected", "error");
    return;
  }
  
  // Load history data
  loadHistoryTimeline(currentMarkerId);
  loadSourceVerification(currentMarkerId);
  loadPeerReviews(currentMarkerId);
  
  document.getElementById('historyModal').style.display = "block";
  document.getElementById('overlay').style.display = "block";
}

// Setup Enhanced Event Listeners Function
function setupEnhancedEventListeners() {
  // Comment form
  document.addEventListener('submit', (e) => {
    if (e.target && e.target.id === 'commentForm') {
      e.preventDefault();
      handleCommentSubmission(e.target);
    }
  });

  // Share buttons
  document.addEventListener('click', (e) => {
    if (e.target && e.target.closest('.share-button')) {
      const button = e.target.closest('.share-button');
      const platform = button.classList.contains('facebook') ? 'facebook' :
                      button.classList.contains('twitter') ? 'twitter' :
                      button.classList.contains('linkedin') ? 'linkedin' : null;
      
      if (platform && currentMarkerId) {
        shareMarker(platform, { title: document.getElementById('markerInfoTitle').textContent });
      }
    }
  });
}

// Modal close function
function closeMarkerModal() {
  document.getElementById('markerModal').style.display = "none";
  document.getElementById('overlay').style.display = "none";
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
  document.getElementById('markerForm').reset();
  if (editor) {
    editor.setContents("");
  }
  document.getElementById('date').value = new Date().toISOString().split('T')[0];
}

// Handle Like Button
function handleLikeButton() {
  if (!currentUser) {
    showNotification("Please log in to like markers", "error");
    return;
  }

  if (!currentMarkerId) return;

  const likeRef = database.ref(`likes/${currentMarkerId}/${currentUser.uid}`);
  const markerLikesRef = database.ref(`markers/${currentMarkerId}/likes`);

  likeRef.once("value", (snapshot) => {
    if (snapshot.exists()) {
      likeRef.remove();
      markerLikesRef.transaction((currentLikes) => Math.max((currentLikes || 1) - 1, 0));
      document.getElementById('likeButton').classList.remove("liked");
      document.getElementById('likeButton').innerHTML = '<i class="far fa-heart"></i> Like';
      showNotification("Like removed", "info");
    } else {
      likeRef.set(true);
      markerLikesRef.transaction((currentLikes) => (currentLikes || 0) + 1);
      document.getElementById('likeButton').classList.add("liked");
      document.getElementById('likeButton').innerHTML = '<i class="fas fa-heart"></i> Liked';
      showNotification("Marker liked!", "success");

      // Award points to marker creator
      database.ref(`markers/${currentMarkerId}`).once("value", (snapshot) => {
        const markerData = snapshot.val();
        if (markerData && markerData.uploaderId && markerData.uploaderId !== currentUser.uid) {
          const uploaderPointsRef = database.ref(`users/${markerData.uploaderId}/points`);
          uploaderPointsRef.transaction((currentPoints) => (currentPoints || 0) + POINTS.RECEIVE_LIKE);
        }
      });
    }
  });
}

// Handle Comment Submission
function handleCommentSubmission(form) {
  const textarea = form.querySelector("textarea");
  const text = textarea.value.trim();

  if (containsProfanity(text)) {
    showNotification("Please keep comments respectful and appropriate.", "error");
    return;
  }

  if (!currentUser) {
    showNotification("Please log in to add comments", "error");
    return;
  }

  if (!currentMarkerId) {
    showNotification("No marker selected", "error");
    return;
  }

  const commentRef = database.ref(`comments/${currentMarkerId}`).push();
  commentRef.set({
    userId: currentUser.uid,
    userName: currentUser.displayName || "Anonymous",
    text: text,
    timestamp: Date.now(),
  }).then(() => {
    showNotification("Comment added successfully", "success");
    form.reset();
    updateUserPoints(POINTS.ADD_COMMENT);
    loadComments(currentMarkerId);
  }).catch((error) => {
    showNotification(error.message, "error");
  });
}

// Close All Modals
function closeAllModals() {
  document.querySelectorAll(".modal-base").forEach((modal) => {
    modal.style.display = "none";
  });
  document.getElementById('expandedImageModal').style.display = "none";
  document.getElementById('overlay').style.display = "none";
  document.getElementById('overlay').style.zIndex = "1000";
}

// Social Sharing
function shareMarker(platform, marker) {
  const url = window.location.href;
  const text = `Discover this fascinating Minnesota location: ${marker.title}`;

  const shareUrls = {
    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
    twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
    linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(marker.title)}`,
  };

  window.open(shareUrls[platform], "_blank", "noopener,noreferrer");
}

// Global functions for onclick handlers
window.shareCollection = function(collectionId) {
  const shareUrl = `${window.location.origin}?collection=${collectionId}`;
  navigator.clipboard.writeText(shareUrl).then(() => {
    showNotification("Collection share link copied to clipboard!", "success");
  }).catch(() => {
    showNotification("Unable to copy link. Please copy manually: " + shareUrl, "info");
  });
};

window.deleteCollection = function(collectionId) {
  if (confirm("Are you sure you want to delete this collection?")) {
    database.ref(`collections/${currentUser.uid}/${collectionId}`).remove()
      .then(() => {
        showNotification("Collection deleted successfully", "success");
        loadCollections();
      })
      .catch((error) => {
        showNotification(error.message, "error");
      });
  }
};

window.viewCollectionMarkers = function(collectionId, collectionName) {
  document.getElementById('collectionMarkersTitle').textContent = collectionName;
  document.getElementById('collectionMarkersDescription').textContent = `View and manage markers in the "${collectionName}" collection.`;
  
  // Load collection markers
  database.ref(`collections/${currentUser.uid}/${collectionId}/markers`).once("value", (snapshot) => {
    const markersList = document.getElementById('collectionMarkersList');
    markersList.innerHTML = "";
    
    if (!snapshot.exists()) {
      markersList.innerHTML = "<p style='color: #64748b; font-style: italic; text-align: center;'>No markers in this collection yet.</p>";
      return;
    }
    
    snapshot.forEach((childSnapshot) => {
      const markerId = childSnapshot.key;
      
      // Fetch marker details
      database.ref(`markers/${markerId}`).once("value", (markerSnapshot) => {
        const markerData = markerSnapshot.val();
        if (markerData) {
          const markerElement = document.createElement('div');
          markerElement.className = 'collection-marker-item';
          markerElement.innerHTML = `
            <button class="remove-from-collection" onclick="removeFromCollection('${collectionId}', '${markerId}')" title="Remove from collection">
              <i class="fas fa-times"></i>
            </button>
            <h4 class="collection-marker-title">${markerData.title}</h4>
            <div class="collection-marker-category ${markerData.category}">${markerData.category ? markerData.category.charAt(0).toUpperCase() + markerData.category.slice(1) : 'Uncategorized'}</div>
            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.8rem;">${stripHtml(markerData.description).substring(0, 100)}${markerData.description && markerData.description.length > 100 ? '...' : ''}</p>
            <button onclick="viewMarkerFromCollection('${markerId}')" class="btn btn-primary" style="width: 100%; font-size: 0.85rem;">
              <i class="fas fa-eye"></i> View Details
            </button>
          `;
          markersList.appendChild(markerElement);
        }
      });
    });
  });
  
  document.getElementById('collectionMarkersModal').style.display = "block";
  document.getElementById('overlay').style.display = "block";
};

window.removeFromCollection = function(collectionId, markerId) {
  if (confirm("Remove this marker from the collection?")) {
    database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).remove()
      .then(() => {
        showNotification("Marker removed from collection", "success");
        // Refresh the collection view
        window.viewCollectionMarkers(collectionId, document.getElementById('collectionMarkersTitle').textContent);
      })
      .catch((error) => {
        showNotification(error.message, "error");
      });
  }
};

window.viewMarkerFromCollection = function(markerId) {
  // Close collection modal and open marker info
  closeAllModals();
  
  database.ref(`markers/${markerId}`).once("value", (snapshot) => {
    const markerData = snapshot.val();
    if (markerData) {
      markerData.id = markerId;
      updateMarkerInfoModal(markerData);
      document.getElementById('markerInfoModal').style.display = "block";
      document.getElementById('overlay').style.display = "block";
    }
  });
};

// Window resize handler
window.addEventListener('resize', () => {
  if (map) {
    map.invalidateSize();
  }
});

// Initialize everything when document is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    // DOM is fully loaded, initialization will happen via the existing event listener
  });
} else {
  // DOM is already loaded, run initialization immediately
  setTimeout(() => {
    if (typeof auth !== 'undefined') {
      // Firebase is ready, trigger auth state check
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
          loadUserData();
        }
      });
    }
  }, 1000);
}
    </script>
</body>
</html>
