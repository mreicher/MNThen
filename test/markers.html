<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Basic Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Collaborative storytelling platform for preserving and sharing historical narratives through location-based multimedia stories">
    
  <title>Historical Narratives - Collaborative Storytelling Platform</title>
  <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.Default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" />
    
  <style>
    /* Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Georgia', 'Times New Roman', serif;
    }

    body {
        overflow-x: hidden;
        color: #2c3e50;
        background-color: #faf8f4;
        line-height: 1.7;
    }

    .leaflet-control-attribution {
        display: none;
    }

    a {
        text-decoration: none;
        color: #8b4513;
        transition: color 0.3s ease;
    }

    a:hover {
        color: #654321;
    }

    /* Typography */
    h1, h2, h3, h4, h5, h6 {
        color: #2c3e50;
        margin-bottom: 0.8em;
        font-weight: 600;
        font-family: 'Georgia', serif;
    }

    p {
        margin-bottom: 1.2em;
        line-height: 1.7;
    }

    .sun-editor,
    .sun-editor .se-wrapper .se-content,
    .sun-editor .se-toolbar,
    .sun-editor .se-selector,
    .sun-editor .se-dialog {
        font-size: 15px !important;
        font-family: 'Georgia', serif !important;
    }

    /* Page Layout */
    .page {
        width: 100%;
        min-height: 100vh;
        position: relative;
    }

    .search-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(rgba(44, 62, 80, 0.8), rgba(44, 62, 80, 0.9)), url('https://images.pexels.com/photos/1462643/pexels-photo-1462643.jpeg');
        background-size: cover;
        background-position: center;
        color: white;
        text-align: center;
    }

    .search-page h1, .search-page h2, .search-page h3, 
    .search-page h4, .search-page h5, .search-page h6 {
        color: #ffffff;
    }

    .map-page {
        display: none;
        position: relative;
        height: 100vh;
        width: 100%;
    }

    /* Map Container */
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }

    /* Hero Content */
    .hero-content {
        max-width: 900px;
        padding: 3rem;
        z-index: 2;
        animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .hero-content h1 {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        font-family: 'Georgia', serif;
    }

    .hero-content p {
        font-size: 1.4rem;
        margin-bottom: 2.5rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        font-style: italic;
    }

    .hero-subtitle {
        font-size: 1.1rem;
        margin-bottom: 2rem;
        opacity: 0.9;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Search Components */
    .search-container {
        width: 100%;
        max-width: 700px;
        margin: 0 auto 3rem;
    }

    .search-bar {
        display: flex;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    .search-bar:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }

    .search-input {
        flex: 1;
        padding: 1.4rem 1.8rem;
        border: none;
        font-size: 1.1rem;
        outline: none;
        background: transparent;
        color: #2c3e50;
        font-family: 'Georgia', serif;
    }

    .search-input::placeholder {
        color: #7f8c8d;
        font-style: italic;
    }

    .search-button {
        padding: 1.4rem 2.5rem;
        background-color: #8b4513;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        font-family: 'Georgia', serif;
    }

    .search-button:hover {
        background-color: #654321;
    }

    .map-search-bar {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        width: 85%;
        max-width: 600px;
        z-index: 10;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    .map-search-input {
        flex: 1;
        padding: 1rem 1.5rem;
        border: none;
        font-size: 1rem;
        outline: none;
        background: transparent;
        color: #2c3e50;
        font-family: 'Georgia', serif;
    }

    .map-search-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border: none;
        background-color: #8b4513;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .map-search-button:hover {
        background-color: #654321;
    }

    .map-search-button i {
        color: white;
        font-size: 18px;
    }

    /* Story Categories */
    .category-selector {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        z-index: 10;
        padding: 15px 20px;
        background-color: rgba(250, 248, 244, 0.95);
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 69, 19, 0.2);
    }

    .category-badge {
        padding: 0.8rem 1.5rem;
        border-radius: 25px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 0.7rem;
        font-family: 'Georgia', serif;
    }

    .category-badge.active {
        transform: scale(1.05);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }

    .category-badge.inactive {
        opacity: 0.5;
        background-color: #95a5a6;
    }

    .category-badge.family-history {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .category-badge.local-business {
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .category-badge.landmark {
        background: linear-gradient(135deg, #f39c12, #d68910);
    }

    .category-badge.community-event {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .category-badge.oral-history {
        background: linear-gradient(135deg, #27ae60, #229954);
    }

    .category-count {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }

    /* Timeline Integration */
    .timeline-controls {
        position: absolute;
        top: 100px;
        right: 20px;
        background: rgba(250, 248, 244, 0.95);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        z-index: 10;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 69, 19, 0.2);
    }

    .timeline-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 0.9rem;
        font-family: 'Georgia', serif;
    }

    .timeline-slider {
        width: 200px;
        margin: 10px 0;
    }

    .timeline-display {
        text-align: center;
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-top: 8px;
        font-family: 'Georgia', serif;
    }

    /* Floating Menu */
    .floating-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    .floating-btn {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b4513, #654321);
        color: white;
        border: none;
        font-size: 1.4rem;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(139, 69, 19, 0.3);
        transition: all 0.3s ease;
    }

    .floating-btn:hover {
        background: linear-gradient(135deg, #654321, #5d4037);
        transform: scale(1.1);
        box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
    }

    .menu-content {
        display: none;
        position: absolute;
        top: 65px;
        left: 0;
        background: rgba(250, 248, 244, 0.95);
        border-radius: 15px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        padding: 0.8rem;
        width: 250px;
        animation: slideIn 0.3s ease-out;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 69, 19, 0.2);
    }

    .menu-content a {
        display: block;
        padding: 1rem 1.4rem;
        color: #2c3e50;
        border-radius: 10px;
        transition: all 0.3s;
        font-weight: 500;
        font-family: 'Georgia', serif;
    }

    .menu-content a:hover {
        background-color: rgba(139, 69, 19, 0.1);
        color: #8b4513;
        transform: translateX(8px);
    }

    /* Scroll Down Button */
    .scroll-down {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        cursor: pointer;
        animation: bounce 2s infinite;
    }

    .scroll-down span {
        margin-bottom: 0.8rem;
        font-weight: 500;
        letter-spacing: 0.5px;
        font-family: 'Georgia', serif;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0) translateX(-50%);
        }
        40% {
            transform: translateY(-15px) translateX(-50%);
        }
        60% {
            transform: translateY(-8px) translateX(-50%);
        }
    }

    /* Modal Base */
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(44, 62, 80, 0.7);
        z-index: 1000;
        backdrop-filter: blur(5px);
        transition: opacity 0.3s ease;
    }

    .modal-base {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #faf8f4, #f5f3ef);
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        padding: 3rem;
        max-width: 90%;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1100;
        animation: modalFadeIn 0.4s ease-out;
        border: 2px solid rgba(139, 69, 19, 0.1);
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translate(-50%, -45%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .modal-base h2 {
        color: #8b4513;
        margin-bottom: 1.5rem;
        font-size: 2rem;
        border-bottom: 2px solid rgba(139, 69, 19, 0.2);
        padding-bottom: 1rem;
        font-family: 'Georgia', serif;
    }

    .modal-base p {
        color: #5d6d7e;
        margin-bottom: 1.5rem;
        line-height: 1.8;
    }

    .close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        color: #95a5a6;
        transition: all 0.2s;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #8b4513;
        background-color: rgba(139, 69, 19, 0.1);
        transform: scale(1.1);
    }

    /* Story Creation Modal */
    .story-modal {
        width: 1000px;
        max-width: 95%;
    }

    .story-form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .section-title {
        font-size: 1.3rem;
        color: #8b4513;
        margin-bottom: 1rem;
        font-family: 'Georgia', serif;
        font-weight: 600;
    }

    /* Media Upload Area */
    .media-upload-area {
        border: 2px dashed rgba(139, 69, 19, 0.3);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background: rgba(255, 255, 255, 0.5);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .media-upload-area:hover {
        border-color: #8b4513;
        background: rgba(139, 69, 19, 0.05);
    }

    .media-upload-area.dragover {
        border-color: #8b4513;
        background: rgba(139, 69, 19, 0.1);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 3rem;
        color: #8b4513;
        margin-bottom: 1rem;
    }

    .upload-text {
        font-size: 1.1rem;
        color: #5d6d7e;
        margin-bottom: 0.5rem;
        font-family: 'Georgia', serif;
    }

    .upload-subtext {
        font-size: 0.9rem;
        color: #95a5a6;
        font-style: italic;
    }

    /* Media Preview */
    .media-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .media-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        background: white;
    }

    .media-item img,
    .media-item video {
        width: 100%;
        height: 120px;
        object-fit: cover;
    }

    .media-item audio {
        width: 100%;
        height: 60px;
    }

    .media-item .document-preview {
        height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #ecf0f1;
        color: #5d6d7e;
    }

    .remove-media {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(231, 76, 60, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s;
    }

    .remove-media:hover {
        background: #c0392b;
        transform: scale(1.1);
    }

    /* Voice Recording */
    .voice-recording {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        margin-top: 1rem;
    }

    .record-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .record-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
    }

    .record-button.recording {
        background: linear-gradient(135deg, #27ae60, #229954);
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .recording-status {
        flex: 1;
        font-family: 'Georgia', serif;
    }

    .recording-time {
        font-size: 1.2rem;
        font-weight: bold;
        color: #e74c3c;
    }

    /* Source Management */
    .source-section {
        border-top: 2px solid rgba(139, 69, 19, 0.2);
        padding-top: 1.5rem;
        margin-top: 1.5rem;
    }

    .source-input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .source-type-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .source-type-btn {
        padding: 0.5rem 1rem;
        border: 2px solid rgba(139, 69, 19, 0.3);
        background: transparent;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-family: 'Georgia', serif;
        color: #8b4513;
    }

    .source-type-btn.active {
        background: #8b4513;
        color: white;
    }

    /* Collaborative Features */
    .contributors-section {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .contributor-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(139, 69, 19, 0.1);
    }

    .contributor-info {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .contributor-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b4513, #654321);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .contributor-details {
        font-family: 'Georgia', serif;
    }

    .contributor-name {
        font-weight: 600;
        color: #2c3e50;
    }

    .contributor-role {
        font-size: 0.85rem;
        color: #7f8c8d;
        font-style: italic;
    }

    .contribution-date {
        font-size: 0.8rem;
        color: #95a5a6;
        font-family: 'Georgia', serif;
    }

    /* Story Timeline */
    .story-timeline {
        margin-top: 2rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .timeline-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(139, 69, 19, 0.1);
    }

    .timeline-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b4513, #654321);
        margin-right: 1rem;
        margin-top: 0.3rem;
        box-shadow: 0 2px 6px rgba(139, 69, 19, 0.3);
    }

    .timeline-content {
        flex: 1;
    }

    .timeline-date {
        font-size: 0.9rem;
        color: #8b4513;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-family: 'Georgia', serif;
    }

    .timeline-title {
        font-size: 1.1rem;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-family: 'Georgia', serif;
        font-weight: 600;
    }

    .timeline-description {
        color: #5d6d7e;
        line-height: 1.6;
        font-size: 0.95rem;
    }

    /* Story Info Modal */
    .story-info-modal {
        width: 1200px;
        max-width: 95%;
    }

    .story-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(139, 69, 19, 0.2);
    }

    .story-title-section h1 {
        font-size: 2.5rem;
        color: #8b4513;
        margin-bottom: 0.5rem;
        font-family: 'Georgia', serif;
    }

    .story-metadata {
        display: flex;
        gap: 2rem;
        color: #7f8c8d;
        font-size: 0.9rem;
        font-family: 'Georgia', serif;
    }

    .story-actions {
        display: flex;
        gap: 1rem;
    }

    .story-content {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
    }

    .story-main {
        order: 1;
    }

    .story-sidebar {
        order: 2;
    }

    .story-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .story-section h3 {
        color: #8b4513;
        margin-bottom: 1rem;
        font-family: 'Georgia', serif;
    }

    .story-text {
        line-height: 1.8;
        color: #2c3e50;
        font-size: 1.05rem;
    }

    /* Media Gallery */
    .media-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .gallery-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .gallery-item:hover {
        transform: scale(1.05);
    }

    .gallery-item img,
    .gallery-item video {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .gallery-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        padding: 1rem 0.8rem 0.8rem;
        font-size: 0.85rem;
        font-family: 'Georgia', serif;
    }

    /* Form Styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-family: 'Georgia', serif;
    }

    .form-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid rgba(139, 69, 19, 0.2);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        background: rgba(255, 255, 255, 0.9);
        font-family: 'Georgia', serif;
    }

    .form-input:focus {
        outline: none;
        border-color: #8b4513;
        box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        background: white;
    }

    .form-textarea {
        min-height: 120px;
        resize: vertical;
    }

    /* Button Styling */
    .btn {
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.8rem;
        font-family: 'Georgia', serif;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #8b4513, #654321);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #654321, #5d4037);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        color: #8b4513;
        border: 2px solid rgba(139, 69, 19, 0.3);
    }

    .btn-secondary:hover {
        background: rgba(139, 69, 19, 0.1);
        border-color: #8b4513;
        transform: translateY(-2px);
    }

    .btn-outline {
        background: transparent;
        color: #8b4513;
        border: 2px solid #8b4513;
    }

    .btn-outline:hover {
        background: #8b4513;
        color: white;
    }

    /* Notification */
    .notification {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1.2rem 2rem;
        border-radius: 12px;
        color: white;
        font-weight: 500;
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        font-family: 'Georgia', serif;
    }

    .notification.info {
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .notification.success {
        background: linear-gradient(135deg, #27ae60, #229954);
    }

    .notification.error {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .notification.warning {
        background: linear-gradient(135deg, #f39c12, #d68910);
    }

    /* Story Trails */
    .story-trails {
        position: absolute;
        bottom: 100px;
        left: 20px;
        background: rgba(250, 248, 244, 0.95);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        z-index: 10;
        max-width: 300px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(139, 69, 19, 0.2);
    }

    .trail-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255, 255, 255, 0.5);
    }

    .trail-item:hover {
        background: rgba(139, 69, 19, 0.1);
        transform: translateX(5px);
    }

    .trail-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b4513, #654321);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
    }

    .trail-info {
        flex: 1;
        font-family: 'Georgia', serif;
    }

    .trail-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
    }

    .trail-count {
        font-size: 0.75rem;
        color: #7f8c8d;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hero-content {
            padding: 2rem 1rem;
        }

        .hero-content h1 {
            font-size: 2.8rem;
        }

        .search-bar {
            flex-direction: column;
            border-radius: 12px;
        }

        .search-input, .search-button {
            width: 100%;
            border-radius: 0;
        }

        .search-input {
            border-radius: 12px 12px 0 0;
        }

        .search-button {
            border-radius: 0 0 12px 12px;
        }

        .map-search-bar {
            width: 95%;
        }

        .story-modal {
            width: 95%;
            padding: 2rem;
        }

        .story-content {
            grid-template-columns: 1fr;
        }

        .story-sidebar {
            order: 1;
        }

        .story-main {
            order: 2;
        }

        .category-selector {
            padding: 12px;
            width: 95%;
            gap: 10px;
        }

        .category-badge {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        .timeline-controls {
            top: auto;
            bottom: 200px;
            right: 20px;
            left: 20px;
            width: auto;
        }

        .timeline-slider {
            width: 100%;
        }

        .source-input-group {
            grid-template-columns: 1fr;
        }

        .media-preview {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
    }

    /* Dark mode for historical feel */
    .historical-mode {
        filter: sepia(20%) saturate(80%) brightness(95%);
    }

    /* Loading states */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #7f8c8d;
        font-style: italic;
        font-family: 'Georgia', serif;
    }

    .loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid #8b4513;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Story Version History */
    .version-history {
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .version-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(139, 69, 19, 0.1);
    }

    .version-info {
        font-family: 'Georgia', serif;
    }

    .version-number {
        font-weight: 600;
        color: #8b4513;
    }

    .version-date {
        font-size: 0.85rem;
        color: #7f8c8d;
    }

    .version-author {
        font-size: 0.9rem;
        color: #2c3e50;
    }

    .version-actions {
        display: flex;
        gap: 0.5rem;
    }

    .version-btn {
        padding: 0.3rem 0.8rem;
        border: 1px solid rgba(139, 69, 19, 0.3);
        background: transparent;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8rem;
        color: #8b4513;
        transition: all 0.3s;
        font-family: 'Georgia', serif;
    }

    .version-btn:hover {
        background: rgba(139, 69, 19, 0.1);
    }

    /* Quality rating system */
    .quality-rating {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        margin-top: 1rem;
        border: 1px solid rgba(139, 69, 19, 0.1);
    }

    .rating-stars {
        display: flex;
        gap: 0.3rem;
    }

    .star {
        font-size: 1.2rem;
        color: #ecf0f1;
        cursor: pointer;
        transition: all 0.2s;
    }

    .star:hover,
    .star.active {
        color: #f39c12;
        transform: scale(1.1);
    }

    .rating-info {
        font-family: 'Georgia', serif;
        color: #5d6d7e;
    }
  </style>
</head>
<body>
    <div class="floating-menu" id="floatingMenu">
        <button class="floating-btn" id="floatingBtn" aria-label="Open Menu">☰</button>
        <div class="menu-content" id="menuContent">
            <a href="#" id="homeLink">Home</a>
            <a href="#" id="aboutLink">About</a>
            <a href="#" id="instructionsLink">How to Contribute</a>
            <a href="#" id="loginLink">Login/Join</a>
            <a href="#" id="collectionsLink">My Collections</a>
            <a href="#" id="trailsLink">Story Trails</a>
            <a href="#" id="leaderboardLink">Contributors</a>
        </div>
    </div>

    <div class="page search-page" id="searchPage">
        <div class="hero-content">
            <h1>Historical Narratives</h1>
            <p>Preserve and share the stories that shaped our communities</p>
            <div class="hero-subtitle">
                Collaborative storytelling platform where every location becomes a living archive of historical memories, 
                built by the people who lived there.
            </div>
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search for a location to explore its stories..." id="searchInput" aria-label="Search for a location">
                    <button class="search-button" id="searchButton">Explore Stories</button>
                </div>
            </div>
            <a href="https://www.mnthen.com" class="btn btn-outline">Learn More</a>
        </div>
        <div class="scroll-down" id="scrollDown">
            <span>Start Exploring</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
            </svg>
        </div>
    </div>

    <div class="page map-page" id="mapPage">
        <div class="map-search-bar">
            <input type="text" class="map-search-input" placeholder="Search for a location to discover its stories..." id="mapSearchInput" aria-label="Search for a location">
            <button class="map-search-button" id="mapSearchButton" aria-label="Search">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <div class="timeline-controls" id="timelineControls">
            <div class="timeline-title">Historical Timeline</div>
            <input type="range" class="timeline-slider" id="timelineSlider" min="1800" max="2024" value="2024" step="1">
            <div class="timeline-display" id="timelineDisplay">All Years (1800-2024)</div>
        </div>
        
        <div id="map"></div>
        
        <div class="story-trails" id="storyTrails">
            <h4 style="margin-bottom: 1rem; color: #8b4513; font-family: Georgia, serif;">Story Trails</h4>
            <div class="trail-item" data-trail="historic-downtown">
                <div class="trail-icon"><i class="fas fa-building"></i></div>
                <div class="trail-info">
                    <div class="trail-title">Historic Downtown</div>
                    <div class="trail-count">12 connected stories</div>
                </div>
            </div>
            <div class="trail-item" data-trail="immigrant-journey">
                <div class="trail-icon"><i class="fas fa-ship"></i></div>
                <div class="trail-info">
                    <div class="trail-title">Immigrant Journey</div>
                    <div class="trail-count">8 connected stories</div>
                </div>
            </div>
            <div class="trail-item" data-trail="industrial-heritage">
                <div class="trail-icon"><i class="fas fa-industry"></i></div>
                <div class="trail-info">
                    <div class="trail-title">Industrial Heritage</div>
                    <div class="trail-count">15 connected stories</div>
                </div>
            </div>
        </div>
        
        <div class="category-selector" id="categorySelector">
            <span class="category-badge family-history active" data-category="family-history">
                <i class="fas fa-users"></i>
                Family History
                <span class="category-count" id="familyHistoryCount">0</span>
            </span>
            <span class="category-badge local-business active" data-category="local-business">
                <i class="fas fa-store"></i>
                Local Business
                <span class="category-count" id="localBusinessCount">0</span>
            </span>
            <span class="category-badge landmark active" data-category="landmark">
                <i class="fas fa-landmark"></i>
                Landmark
                <span class="category-count" id="landmarkCount">0</span>
            </span>
            <span class="category-badge community-event active" data-category="community-event">
                <i class="fas fa-calendar-alt"></i>
                Community Event
                <span class="category-count" id="communityEventCount">0</span>
            </span>
            <span class="category-badge oral-history active" data-category="oral-history">
                <i class="fas fa-microphone"></i>
                Oral History
                <span class="category-count" id="oralHistoryCount">0</span>
            </span>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="notification" class="notification" role="alert"></div>

    <!-- Auth Modal -->
    <div id="authPopup" class="modal-base" role="dialog" aria-labelledby="authTitle">
        <button id="closeAuth" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="authTitle">Join Our Storytelling Community</h2>
        <div class="auth-container">
            <div class="auth-tabs" role="tablist">
                <button id="showLogin" class="auth-tab active" role="tab" aria-selected="true">Login</button>
                <button id="showJoin" class="auth-tab" role="tab" aria-selected="false">Join Community</button>
            </div>
            <form id="loginForm" class="auth-form" role="tabpanel">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login to Continue</button>
            </form>
            <form id="joinForm" class="auth-form" style="display: none;" role="tabpanel">
                <div class="form-group">
                    <label for="joinEmail" class="form-label">Email</label>
                    <input type="email" id="joinEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="joinPassword" class="form-label">Password</label>
                    <input type="password" id="joinPassword" class="form-input" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="joinFirstName" class="form-label">First Name</label>
                    <input type="text" id="joinFirstName" class="form-input" placeholder="Enter your first name" required>
                </div>
                <div class="form-group">
                    <label for="joinLastName" class="form-label">Last Name</label>
                    <input type="text" id="joinLastName" class="form-input" placeholder="Enter your last name" required>
                </div>
                <div class="form-group">
                    <label for="joinCity" class="form-label">City</label>
                    <input type="text" id="joinCity" class="form-input" placeholder="Enter your city" required>
                </div>
                <button type="submit" class="btn btn-primary">Join Community</button>
            </form>
        </div>
    </div>

    <!-- Story Creation Modal -->
    <div id="storyModal" class="modal-base story-modal" role="dialog" aria-labelledby="storyModalTitle">
        <button id="closeStoryModal" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="storyModalTitle">Add Your Story to This Location</h2>
        
        <form id="storyForm">
            <!-- Basic Information -->
            <div class="story-form-section">
                <h3 class="section-title">Story Details</h3>
                <div class="form-group">
                    <label for="storyTitle" class="form-label">Story Title</label>
                    <input type="text" id="storyTitle" class="form-input" maxlength="100" required 
                           placeholder="Give your story a compelling title...">
                </div>
                <div class="form-group">
                    <label for="storyCategory" class="form-label">Category</label>
                    <select id="storyCategory" class="form-input" required>
                        <option value="">Select a category</option>
                        <option value="family-history">Family History</option>
                        <option value="local-business">Local Business</option>
                        <option value="landmark">Landmark</option>
                        <option value="community-event">Community Event</option>
                        <option value="oral-history">Oral History</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="storyDate" class="form-label">Historical Date</label>
                    <input type="date" id="storyDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="storyDescription" class="form-label">Your Story</label>
                    <textarea id="storyDescription" class="form-input form-textarea" required 
                              placeholder="Share the story of this place. What happened here? Who was involved? What makes this location significant?"></textarea>
                </div>
            </div>

            <!-- Media Upload -->
            <div class="story-form-section">
                <h3 class="section-title">Add Media</h3>
                <div class="media-upload-area" id="mediaUploadArea">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">Drag and drop files here or click to browse</div>
                    <div class="upload-subtext">Photos, videos, audio recordings, and documents welcome</div>
                    <input type="file" id="mediaInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx" style="display: none;">
                </div>
                <div class="media-preview" id="mediaPreview"></div>
                
                <!-- Voice Recording -->
                <div class="voice-recording">
                    <button type="button" class="record-button" id="recordButton">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div class="recording-status">
                        <div class="recording-time" id="recordingTime">00:00</div>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">Click to record your voice</div>
                    </div>
                </div>
            </div>

            <!-- Source Information -->
            <div class="story-form-section source-section">
                <h3 class="section-title">Source Information</h3>
                <div class="source-type-selector">
                    <button type="button" class="source-type-btn active" data-type="personal">Personal Memory</button>
                    <button type="button" class="source-type-btn" data-type="oral">Oral History</button>
                    <button type="button" class="source-type-btn" data-type="document">Document</button>
                    <button type="button" class="source-type-btn" data-type="newspaper">Newspaper</button>
                    <button type="button" class="source-type-btn" data-type="book">Book/Publication</button>
                    <button type="button" class="source-type-btn" data-type="archive">Archive</button>
                </div>
                <div class="source-input-group">
                    <div class="form-group">
                        <label for="sourceTitle" class="form-label">Source Title</label>
                        <input type="text" id="sourceTitle" class="form-input" 
                               placeholder="Name of source (if applicable)">
                    </div>
                    <div class="form-group">
                        <label for="sourceAuthor" class="form-label">Author/Creator</label>
                        <input type="text" id="sourceAuthor" class="form-input" 
                               placeholder="Who created this source?">
                    </div>
                </div>
                <div class="source-input-group">
                    <div class="form-group">
                        <label for="sourceDate" class="form-label">Source Date</label>
                        <input type="date" id="sourceDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="sourceLocation" class="form-label">Source Location</label>
                        <input type="text" id="sourceLocation" class="form-input" 
                               placeholder="Where is this source held?">
                    </div>
                </div>
                <div class="form-group">
                    <label for="sourceNotes" class="form-label">Additional Notes</label>
                    <textarea id="sourceNotes" class="form-input" rows="3" 
                              placeholder="Any additional information about this source..."></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="saveDraftButton">Save as Draft</button>
                <button type="submit" class="btn btn-primary">Submit Story</button>
            </div>
        </form>
    </div>

    <!-- Story Info Modal -->
    <div id="storyInfoModal" class="modal-base story-info-modal" role="dialog" aria-labelledby="storyInfoTitle">
        <button id="closeStoryInfo" class="close-btn" aria-label="Close">&times;</button>
        
        <div class="story-header">
            <div class="story-title-section">
                <h1 id="storyInfoTitle">Story Title</h1>
                <div class="story-metadata">
                    <span id="storyInfoDate"><i class="fas fa-calendar"></i> Date</span>
                    <span id="storyInfoCategory"><i class="fas fa-tag"></i> Category</span>
                    <span id="storyInfoViews"><i class="fas fa-eye"></i> Views</span>
                </div>
            </div>
            <div class="story-actions">
                <button class="btn btn-outline" id="addContributionButton">
                    <i class="fas fa-plus"></i> Add Your Memory
                </button>
                <button class="btn btn-secondary" id="shareStoryButton">
                    <i class="fas fa-share"></i> Share
                </button>
            </div>
        </div>

        <div class="story-content">
            <div class="story-main">
                <div class="story-section">
                    <h3>The Story</h3>
                    <div class="story-text" id="storyInfoText"></div>
                </div>

                <div class="story-section" id="mediaGallerySection">
                    <h3>Media Gallery</h3>
                    <div class="media-gallery" id="storyMediaGallery"></div>
                </div>

                <div class="story-section">
                    <h3>Contributors</h3>
                    <div class="contributors-section" id="storyContributors"></div>
                </div>

                <div class="story-section">
                    <h3>Story Timeline</h3>
                    <div class="story-timeline" id="storyTimeline"></div>
                </div>

                <div class="story-section">
                    <h3>Community Discussion</h3>
                    <div id="storyComments"></div>
                    <form id="addCommentForm" style="margin-top: 1rem;">
                        <div class="form-group">
                            <textarea class="form-input" placeholder="Share your thoughts or memories about this story..." rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Comment</button>
                    </form>
                </div>
            </div>

            <div class="story-sidebar">
                <div class="story-section">
                    <h3>Source Information</h3>
                    <div id="storySourceInfo"></div>
                </div>

                <div class="story-section">
                    <h3>Related Stories</h3>
                    <div id="relatedStories"></div>
                </div>

                <div class="story-section">
                    <h3>Story Quality</h3>
                    <div class="quality-rating">
                        <div class="rating-stars" id="qualityRating">
                            <span class="star" data-rating="1">★</span>
                            <span class="star" data-rating="2">★</span>
                            <span class="star" data-rating="3">★</span>
                            <span class="star" data-rating="4">★</span>
                            <span class="star" data-rating="5">★</span>
                        </div>
                        <div class="rating-info">
                            <div id="averageRating">4.2/5 (15 ratings)</div>
                        </div>
                    </div>
                </div>

                <div class="story-section">
                    <h3>Version History</h3>
                    <div class="version-history" id="versionHistory"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal-base" role="dialog" aria-labelledby="aboutTitle">
        <button id="closeAbout" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="aboutTitle">Preserving Stories, Building Community</h2>
        <p>
            Historical Narratives is a collaborative platform dedicated to preserving and sharing the stories that shaped our communities. Every location has a story—from family homes to corner stores, from landmarks to forgotten places.
        </p>
        <p>
            Our mission is to create a living archive where community members can contribute their memories, photographs, documents, and oral histories. Through collaborative storytelling, we build a comprehensive picture of how our communities evolved over time.
        </p>
        <div class="story-section">
            <h3>How It Works</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 1rem;"><i class="fas fa-map-marker-alt" style="color: #8b4513; margin-right: 0.5rem;"></i> <strong>Drop a Pin:</strong> Click anywhere on the map to mark a significant location</li>
                <li style="margin-bottom: 1rem;"><i class="fas fa-book-open" style="color: #8b4513; margin-right: 0.5rem;"></i> <strong>Share Your Story:</strong> Add text, photos, videos, audio recordings, and documents</li>
                <li style="margin-bottom: 1rem;"><i class="fas fa-users" style="color: #8b4513; margin-right: 0.5rem;"></i> <strong>Build Together:</strong> Other community members can add their memories to your story</li>
                <li style="margin-bottom: 1rem;"><i class="fas fa-route" style="color: #8b4513; margin-right: 0.5rem;"></i> <strong>Create Trails:</strong> Connect related stories to create thematic historical tours</li>
            </ul>
        </div>
        <p>
            Join our community of storytellers, historians, and memory keepers as we preserve the past for future generations.
        </p>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal-base" role="dialog" aria-labelledby="instructionsTitle">
        <button id="closeInstructions" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="instructionsTitle">Contributing to Historical Narratives</h2>
        
        <div class="story-section">
            <h3>Getting Started</h3>
            <ol style="line-height: 1.8;">
                <li><strong>Create an account</strong> to begin contributing stories</li>
                <li><strong>Click on the map</strong> where your story took place</li>
                <li><strong>Choose a category</strong> that best fits your story</li>
                <li><strong>Write your narrative</strong> with as much detail as possible</li>
                <li><strong>Add media</strong> - photos, documents, audio recordings</li>
                <li><strong>Cite your sources</strong> to help maintain historical accuracy</li>
                <li><strong>Submit for community review</strong></li>
            </ol>
        </div>

        <div class="story-section">
            <h3>Best Practices</h3>
            <ul style="line-height: 1.8;">
                <li><strong>Be specific:</strong> Include dates, names, and details that help place the story in context</li>
                <li><strong>Respect privacy:</strong> Only share stories you have permission to tell</li>
                <li><strong>Cite sources:</strong> Help others verify and build upon your research</li>
                <li><strong>Add media thoughtfully:</strong> Include captions and context for photos and documents</li>
                <li><strong>Collaborate:</strong> Build upon existing stories rather than duplicating them</li>
                <li><strong>Stay factual:</strong> Distinguish between verified facts and family stories or legends</li>
            </ul>
        </div>

        <div class="story-section">
            <h3>Community Guidelines</h3>
            <p>
                Our platform thrives on respectful collaboration. Please be considerate of others' contributions, 
                maintain historical accuracy, and help create a welcoming space for all community members to share their stories.
            </p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

    <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
      authDomain: "mnthen-3151d.firebaseapp.com",
      projectId: "mnthen-3151d",
      storageBucket: "mnthen-3151d.appspot.com",
      messagingSenderId: "416231360428",
      appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
    };

    // Initialize Firebase
    let firebaseApp;
    if (!firebase.apps.length) {
      firebaseApp = firebase.initializeApp(firebaseConfig);
    } else {
      firebaseApp = firebase.app();
    }

    const auth = firebaseApp.auth();
    const database = firebaseApp.database();
    const storage = firebaseApp.storage();

    // Global Variables
    let map = null;
    let markers = null;
    let tempMarker = null;
    let currentUser = null;
    let currentStoryId = null;
    let selectedCategories = new Set(['family-history', 'local-business', 'landmark', 'community-event', 'oral-history']);
    let timelineRange = { start: 1800, end: 2024 };
    let uploadedFiles = [];
    let isRecording = false;
    let mediaRecorder = null;
    let recordingStartTime = 0;
    let recordingInterval = null;

    // Story categories
    const storyCategories = {
      'family-history': { color: '#e74c3c', icon: 'fas fa-users' },
      'local-business': { color: '#3498db', icon: 'fas fa-store' },
      'landmark': { color: '#f39c12', icon: 'fas fa-landmark' },
      'community-event': { color: '#9b59b6', icon: 'fas fa-calendar-alt' },
      'oral-history': { color: '#27ae60', icon: 'fas fa-microphone' }
    };

    // Category counts
    let categoryCounts = {
      'family-history': 0,
      'local-business': 0,
      'landmark': 0,
      'community-event': 0,
      'oral-history': 0
    };

    // Store stories by category
    let storiesByCategory = {
      'family-history': [],
      'local-business': [],
      'landmark': [],
      'community-event': [],
      'oral-history': []
    };

    // DOM Elements
    const searchPage = document.getElementById('searchPage');
    const mapPage = document.getElementById('mapPage');
    const scrollDown = document.getElementById('scrollDown');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const mapSearchInput = document.getElementById('mapSearchInput');
    const mapSearchButton = document.getElementById('mapSearchButton');
    const overlay = document.getElementById('overlay');
    const notification = document.getElementById('notification');
    
    // Menu elements
    const floatingBtn = document.getElementById('floatingBtn');
    const menuContent = document.getElementById('menuContent');
    const homeLink = document.getElementById('homeLink');
    const aboutLink = document.getElementById('aboutLink');
    const instructionsLink = document.getElementById('instructionsLink');
    const loginLink = document.getElementById('loginLink');
    
    // Auth elements
    const authPopup = document.getElementById('authPopup');
    const closeAuth = document.getElementById('closeAuth');
    const showLogin = document.getElementById('showLogin');
    const showJoin = document.getElementById('showJoin');
    const loginForm = document.getElementById('loginForm');
    const joinForm = document.getElementById('joinForm');
    
    // Story modal elements
    const storyModal = document.getElementById('storyModal');
    const closeStoryModal = document.getElementById('closeStoryModal');
    const storyForm = document.getElementById('storyForm');
    const mediaUploadArea = document.getElementById('mediaUploadArea');
    const mediaInput = document.getElementById('mediaInput');
    const mediaPreview = document.getElementById('mediaPreview');
    const recordButton = document.getElementById('recordButton');
    const recordingTime = document.getElementById('recordingTime');
    
    // Timeline elements
    const timelineSlider = document.getElementById('timelineSlider');
    const timelineDisplay = document.getElementById('timelineDisplay');
    
    // Category elements
    const categoryBadges = document.querySelectorAll('.category-badge');
    const familyHistoryCount = document.getElementById('familyHistoryCount');
    const localBusinessCount = document.getElementById('localBusinessCount');
    const landmarkCount = document.getElementById('landmarkCount');
    const communityEventCount = document.getElementById('communityEventCount');
    const oralHistoryCount = document.getElementById('oralHistoryCount');

    // Initialize the platform
    document.addEventListener('DOMContentLoaded', function() {
      initializeAuth();
      setupEventListeners();
      
      // Set default date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('storyDate').value = today;
      
      // Show search page initially
      searchPage.style.display = 'flex';
      mapPage.style.display = 'none';
    });

    // Initialize Firebase Auth
    function initializeAuth() {
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        updateAuthUI();
        
        if (user) {
          loadUserData();
          showNotification('Welcome back!', 'success');
        }
      });
    }

    // Update auth UI
    function updateAuthUI() {
      if (currentUser) {
        loginLink.textContent = 'Logout';
        loginLink.onclick = logout;
      } else {
        loginLink.textContent = 'Login/Join';
        loginLink.onclick = showAuthModal;
      }
    }

    // Load user data
    function loadUserData() {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}`).once('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData && userData.firstName && userData.lastName) {
          currentUser.displayName = `${userData.firstName} ${userData.lastName}`;
        }
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Menu toggle
      floatingBtn.addEventListener('click', toggleMenu);
      document.addEventListener('click', (e) => {
        if (!floatingBtn.contains(e.target) && !menuContent.contains(e.target)) {
          menuContent.style.display = 'none';
        }
      });
      
      // Navigation
      scrollDown.addEventListener('click', showMapPage);
      searchButton.addEventListener('click', performSearch);
      mapSearchButton.addEventListener('click', performMapSearch);
      homeLink.addEventListener('click', showSearchPage);
      aboutLink.addEventListener('click', showAboutModal);
      instructionsLink.addEventListener('click', showInstructionsModal);
      
      // Auth forms
      setupAuthEventListeners();
      
      // Story creation
      setupStoryCreationListeners();
      
      // Timeline
      timelineSlider.addEventListener('input', updateTimeline);
      
      // Category filtering
      categoryBadges.forEach(badge => {
        badge.addEventListener('click', () => {
          const category = badge.dataset.category;
          toggleCategory(category);
        });
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
      
      // Modal closing
      overlay.addEventListener('click', closeAllModals);
    }

    // Auth event listeners
    function setupAuthEventListeners() {
      closeAuth.addEventListener('click', closeAuthModal);
      showLogin.addEventListener('click', () => switchAuthTab('login'));
      showJoin.addEventListener('click', () => switchAuthTab('join'));
      
      loginForm.addEventListener('submit', handleLogin);
      joinForm.addEventListener('submit', handleJoin);
    }

    // Story creation listeners
    function setupStoryCreationListeners() {
      closeStoryModal.addEventListener('click', closeStoryModal);
      
      // Media upload
      mediaUploadArea.addEventListener('click', () => mediaInput.click());
      mediaUploadArea.addEventListener('dragover', handleDragOver);
      mediaUploadArea.addEventListener('drop', handleDrop);
      mediaInput.addEventListener('change', handleFileSelect);
      
      // Voice recording
      recordButton.addEventListener('click', toggleRecording);
      
      // Source type selection
      document.querySelectorAll('.source-type-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.source-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
      
      // Form submission
      storyForm.addEventListener('submit', handleStorySubmission);
      document.getElementById('saveDraftButton').addEventListener('click', saveDraft);
    }

    // Initialize map
    function initializeMap() {
      if (map) return;
      
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      }).setView([44.9778, -93.265], 10);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '',
        maxZoom: 18,
      }).addTo(map);

      markers = L.markerClusterGroup({
        disableClusteringAtZoom: 15,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
      });
      
      map.addLayer(markers);

      // Add click handler for story creation
      map.on('click', handleMapClick);

      // Load existing stories
      loadStories();
      
      // Force map to resize
      setTimeout(() => map.invalidateSize(), 100);
    }

    // Handle map click for story creation
    function handleMapClick(e) {
      if (!currentUser) {
        showNotification('Please log in to add stories', 'error');
        showAuthModal();
        return;
      }
      
      if (tempMarker) map.removeLayer(tempMarker);
      tempMarker = L.marker(e.latlng).addTo(map);
      
      showStoryCreationModal();
    }

    // Load stories from database
    function loadStories() {
      if (!markers) return;

      markers.clearLayers();
      resetCategoryCounts();
      
      // Clear stored stories by category
      for (let category in storiesByCategory) {
        storiesByCategory[category] = [];
      }

      database.ref('stories').once('value', (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const storyData = childSnapshot.val();
          storyData.id = childSnapshot.key;
          
          // Store story data by category
          if (storyData.category && storiesByCategory.hasOwnProperty(storyData.category)) {
            storiesByCategory[storyData.category].push(storyData);
          }

          // Check if story falls within timeline range
          const storyYear = new Date(storyData.historicalDate || storyData.timestamp).getFullYear();
          if (storyYear >= timelineRange.start && storyYear <= timelineRange.end) {
            // Only add stories for active categories
            if (selectedCategories.has(storyData.category)) {
              addStoryToMap(storyData);
              
              // Update category counts
              if (storyData.category && categoryCounts.hasOwnProperty(storyData.category)) {
                categoryCounts[storyData.category]++;
              }
            }
          }
        });
        
        updateCategoryCountDisplay();
      });
    }

    // Add story marker to map
    function addStoryToMap(storyData) {
      const category = storyCategories[storyData.category] || storyCategories['landmark'];
      
      const customIcon = L.divIcon({
        className: 'custom-story-marker',
        html: `<div style="
          background: ${category.color}; 
          width: 30px; 
          height: 30px; 
          border-radius: 50%; 
          border: 3px solid white; 
          box-shadow: 0 3px 8px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 12px;
        "><i class="${category.icon.replace('fas', 'fa')}"></i></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
      });
      
      const marker = L.marker([storyData.lat, storyData.lng], { 
        icon: customIcon,
        alt: storyData.title
      });
      
      const popupContent = `
        <div style="font-family: Georgia, serif; max-width: 250px;">
          <h3 style="margin: 0 0 8px 0; color: #8b4513; font-size: 1.1rem;">
            <a href="#" class="story-link" data-story-id="${storyData.id}" style="color: #8b4513; text-decoration: none;">
              ${storyData.title}
            </a>
          </h3>
          <p style="margin: 0 0 8px 0; color: #5d6d7e; font-size: 0.9rem; line-height: 1.4;">
            ${storyData.description ? storyData.description.substring(0, 100) + '...' : 'Click to read the full story'}
          </p>
          <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #7f8c8d;">
            <span><i class="${category.icon}" style="margin-right: 4px;"></i>${storyData.category.replace('-', ' ')}</span>
            <span>${new Date(storyData.historicalDate || storyData.timestamp).getFullYear()}</span>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      marker.on('popupopen', function() {
        setTimeout(() => {
          const storyLink = document.querySelector(`.story-link[data-story-id="${storyData.id}"]`);
          if (storyLink) {
            storyLink.addEventListener('click', (e) => {
              e.preventDefault();
              showStoryInfo(storyData);
              marker.closePopup();
            });
          }
        }, 100);
      });

      markers.addLayer(marker);
    }

    // Navigation functions
    function showSearchPage(e) {
      if (e) e.preventDefault();
      searchPage.style.display = 'flex';
      mapPage.style.display = 'none';
      menuContent.style.display = 'none';
    }

    function showMapPage() {
      searchPage.style.display = 'none';
      mapPage.style.display = 'block';
      
      if (!map) {
        initializeMap();
      }
    }

    function toggleMenu() {
      menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
    }

    // Search functions
    function performSearch() {
      const searchTerm = searchInput.value.trim();
      if (!searchTerm) {
        showNotification('Please enter a search term', 'error');
        return;
      }
      
      showMapPage();
      if (!map) {
        setTimeout(() => searchLocation(searchTerm), 500);
      } else {
        searchLocation(searchTerm);
      }
    }

    function performMapSearch() {
      const searchTerm = mapSearchInput.value.trim();
      if (!searchTerm) {
        showNotification('Please enter a search term', 'error');
        return;
      }
      
      searchLocation(searchTerm);
    }

    function searchLocation(searchTerm) {
      // Add context if needed
      if (!searchTerm.toLowerCase().includes('minnesota') && !searchTerm.toLowerCase().includes('mn')) {
        searchTerm += ' Minnesota';
      }
      
      showNotification('Searching for location...', 'info');
      
      const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}`;
      
      fetch(geocodingUrl)
        .then(response => response.json())
        .then(data => {
          const mnResults = data.filter(result => 
            (result.display_name.toLowerCase().includes('minnesota') || 
             result.display_name.toLowerCase().includes(', mn,')) &&
            result.display_name.toLowerCase().includes('united states')
          );
          
          if (mnResults.length > 0) {
            const result = mnResults[0];
            map.setView([result.lat, result.lon], 13);
            showNotification(`Found location: ${result.display_name}`, 'success');
          } else {
            showNotification('No locations found in Minnesota', 'error');
          }
        })
        .catch(error => {
          console.error('Search error:', error);
          showNotification('Search failed. Please try again.', 'error');
        });
    }

    // Auth functions
    function showAuthModal(e) {
      if (e) e.preventDefault();
      authPopup.style.display = 'block';
      overlay.style.display = 'block';
      menuContent.style.display = 'none';
    }

    function closeAuthModal() {
      authPopup.style.display = 'none';
      overlay.style.display = 'none';
    }

    function switchAuthTab(tab) {
      if (tab === 'login') {
        loginForm.style.display = 'block';
        joinForm.style.display = 'none';
        showLogin.classList.add('active');
        showJoin.classList.remove('active');
      } else {
        loginForm.style.display = 'none';
        joinForm.style.display = 'block';
        showJoin.classList.add('active');
        showLogin.classList.remove('active');
      }
    }

    function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          showNotification('Welcome back!', 'success');
          closeAuthModal();
        })
        .catch(error => {
          showNotification(error.message, 'error');
        });
    }

    function handleJoin(e) {
      e.preventDefault();
      const email = document.getElementById('joinEmail').value;
      const password = document.getElementById('joinPassword').value;
      const firstName = document.getElementById('joinFirstName').value;
      const lastName = document.getElementById('joinLastName').value;
      const city = document.getElementById('joinCity').value;

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          return database.ref(`users/${userCredential.user.uid}`).set({
            firstName,
            lastName,
            city,
            email,
            joinDate: Date.now(),
            storiesContributed: 0,
            totalContributions: 0
          });
        })
        .then(() => {
          showNotification('Welcome to our storytelling community!', 'success');
          closeAuthModal();
        })
        .catch(error => {
          showNotification(error.message, 'error');
        });
    }

    function logout() {
      auth.signOut().then(() => {
        showNotification('Logged out successfully', 'success');
        currentUser = null;
        updateAuthUI();
      });
    }

    // Story creation functions
    function showStoryCreationModal() {
      storyModal.style.display = 'block';
      overlay.style.display = 'block';
    }

    function closeStoryModal() {
      storyModal.style.display = 'none';
      overlay.style.display = 'none';
      
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
      
      // Clear form
      storyForm.reset();
      uploadedFiles = [];
      updateMediaPreview();
    }

    // Media upload functions
    function handleDragOver(e) {
      e.preventDefault();
      mediaUploadArea.classList.add('dragover');
    }

    function handleDrop(e) {
      e.preventDefault();
      mediaUploadArea.classList.remove('dragover');
      
      const files = Array.from(e.dataTransfer.files);
      processFiles(files);
    }

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      processFiles(files);
    }

    function processFiles(files) {
      files.forEach(file => {
        if (uploadedFiles.length >= 10) {
          showNotification('Maximum 10 files allowed', 'warning');
          return;
        }
        
        uploadedFiles.push({
          file,
          type: getFileType(file),
          name: file.name,
          size: file.size,
          url: URL.createObjectURL(file)
        });
      });
      
      updateMediaPreview();
    }

    function getFileType(file) {
      if (file.type.startsWith('image/')) return 'image';
      if (file.type.startsWith('video/')) return 'video';
      if (file.type.startsWith('audio/')) return 'audio';
      return 'document';
    }

    function updateMediaPreview() {
      mediaPreview.innerHTML = uploadedFiles.map((fileObj, index) => {
        let preview = '';
        
        switch (fileObj.type) {
          case 'image':
            preview = `<img src="${fileObj.url}" alt="${fileObj.name}">`;
            break;
          case 'video':
            preview = `<video src="${fileObj.url}" controls></video>`;
            break;
          case 'audio':
            preview = `<audio src="${fileObj.url}" controls></audio>`;
            break;
          default:
            preview = `
              <div class="document-preview">
                <i class="fas fa-file" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <div style="font-size: 0.8rem; text-align: center;">${fileObj.name}</div>
              </div>
            `;
        }
        
        return `
          <div class="media-item">
            ${preview}
            <button type="button" class="remove-media" onclick="removeMedia(${index})">×</button>
          </div>
        `;
      }).join('');
    }

    function removeMedia(index) {
      URL.revokeObjectURL(uploadedFiles[index].url);
      uploadedFiles.splice(index, 1);
      updateMediaPreview();
    }

    // Voice recording functions
    async function toggleRecording() {
      if (!isRecording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          
          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
              const audioBlob = new Blob([e.data], { type: 'audio/webm' });
              const audioFile = new File([audioBlob], `recording-${Date.now()}.webm`, { type: 'audio/webm' });
              
              uploadedFiles.push({
                file: audioFile,
                type: 'audio',
                name: audioFile.name,
                size: audioFile.size,
                url: URL.createObjectURL(audioBlob)
              });
              
              updateMediaPreview();
            }
          };
          
          mediaRecorder.start();
          isRecording = true;
          recordingStartTime = Date.now();
          
          recordButton.classList.add('recording');
          recordButton.innerHTML = '<i class="fas fa-stop"></i>';
          
          recordingInterval = setInterval(updateRecordingTime, 1000);
          
        } catch (error) {
          showNotification('Could not access microphone', 'error');
        }
      } else {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        isRecording = false;
        recordButton.classList.remove('recording');
        recordButton.innerHTML = '<i class="fas fa-microphone"></i>';
        
        clearInterval(recordingInterval);
        recordingTime.textContent = '00:00';
      }
    }

    function updateRecordingTime() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      recordingTime.textContent = `${minutes}:${seconds}`;
    }

    // Story submission
    async function handleStorySubmission(e) {
      e.preventDefault();
      
      if (!tempMarker) {
        showNotification('Please select a location on the map', 'error');
        return;
      }
      
      const formData = new FormData(storyForm);
      const storyData = {
        title: document.getElementById('storyTitle').value,
        category: document.getElementById('storyCategory').value,
        description: document.getElementById('storyDescription').value,
        historicalDate: document.getElementById('storyDate').value,
        lat: tempMarker.getLatLng().lat,
        lng: tempMarker.getLatLng().lng,
        authorId: currentUser.uid,
        authorName: currentUser.displayName || 'Anonymous',
        timestamp: Date.now(),
        status: 'published',
        sources: {
          type: document.querySelector('.source-type-btn.active').dataset.type,
          title: document.getElementById('sourceTitle').value,
          author: document.getElementById('sourceAuthor').value,
          date: document.getElementById('sourceDate').value,
          location: document.getElementById('sourceLocation').value,
          notes: document.getElementById('sourceNotes').value
        },
        mediaFiles: [],
        contributors: {
          [currentUser.uid]: {
            name: currentUser.displayName || 'Anonymous',
            role: 'Author',
            timestamp: Date.now()
          }
        },
        versions: {
          1: {
            timestamp: Date.now(),
            author: currentUser.uid,
            changes: 'Initial story creation'
          }
        },
        views: 0,
        likes: 0,
        comments: {},
        ratings: {}
      };
      
      try {
        showNotification('Saving your story...', 'info');
        
        // Upload media files
        if (uploadedFiles.length > 0) {
          const mediaPromises = uploadedFiles.map(async (fileObj, index) => {
            const storageRef = storage.ref(`story-media/${Date.now()}-${index}-${fileObj.file.name}`);
            const snapshot = await storageRef.put(fileObj.file);
            const downloadURL = await snapshot.ref.getDownloadURL();
            
            return {
              type: fileObj.type,
              name: fileObj.name,
              url: downloadURL,
              caption: '' // Could add caption input later
            };
          });
          
          storyData.mediaFiles = await Promise.all(mediaPromises);
        }
        
        // Save to database
        const storyRef = database.ref('stories').push();
        await storyRef.set(storyData);
        
        showNotification('Story published successfully!', 'success');
        closeStoryModal();
        
        // Add to local data and map
        storyData.id = storyRef.key;
        if (storiesByCategory[storyData.category]) {
          storiesByCategory[storyData.category].push(storyData);
        }
        
        if (selectedCategories.has(storyData.category)) {
          addStoryToMap(storyData);
          categoryCounts[storyData.category]++;
          updateCategoryCountDisplay();
        }
        
      } catch (error) {
        console.error('Error saving story:', error);
        showNotification('Failed to save story. Please try again.', 'error');
      }
    }

    function saveDraft() {
      showNotification('Draft saved locally', 'info');
      // Could implement local storage for drafts
    }

    // Timeline functions
    function updateTimeline() {
      const year = parseInt(timelineSlider.value);
      timelineRange.end = year;
      timelineDisplay.textContent = `Showing stories up to ${year}`;
      
      // Reload stories with new timeline filter
      loadStories();
    }

    // Category functions
    function toggleCategory(category) {
      const badge = document.querySelector(`.category-badge[data-category="${category}"]`);
      
      if (selectedCategories.has(category)) {
        selectedCategories.delete(category);
        badge.classList.remove('active');
        badge.classList.add('inactive');
        categoryCounts[category] = 0;
      } else {
        selectedCategories.add(category);
        badge.classList.add('active');
        badge.classList.remove('inactive');
        
        // Count stories for this category within timeline
        categoryCounts[category] = storiesByCategory[category].filter(story => {
          const storyYear = new Date(story.historicalDate || story.timestamp).getFullYear();
          return storyYear >= timelineRange.start && storyYear <= timelineRange.end;
        }).length;
      }
      
      updateCategoryCountDisplay();
      refreshMapStories();
    }

    function resetCategoryCounts() {
      for (let category in categoryCounts) {
        categoryCounts[category] = 0;
      }
    }

    function updateCategoryCountDisplay() {
      familyHistoryCount.textContent = categoryCounts['family-history'];
      localBusinessCount.textContent = categoryCounts['local-business'];
      landmarkCount.textContent = categoryCounts['landmark'];
      communityEventCount.textContent = categoryCounts['community-event'];
      oralHistoryCount.textContent = categoryCounts['oral-history'];
    }

    function refreshMapStories() {
      if (!markers) return;
      
      markers.clearLayers();
      
      // Add stories for selected categories within timeline
      for (let category in storiesByCategory) {
        if (selectedCategories.has(category)) {
          storiesByCategory[category].forEach(story => {
            const storyYear = new Date(story.historicalDate || story.timestamp).getFullYear();
            if (storyYear >= timelineRange.start && storyYear <= timelineRange.end) {
              addStoryToMap(story);
            }
          });
        }
      }
    }

    // Story info modal
    function showStoryInfo(storyData) {
      currentStoryId = storyData.id;
      
      // Update story info modal content
      document.getElementById('storyInfoTitle').textContent = storyData.title;
      document.getElementById('storyInfoDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(storyData.historicalDate || storyData.timestamp).toLocaleDateString()}`;
      document.getElementById('storyInfoCategory').innerHTML = `<i class="fas fa-tag"></i> ${storyData.category.replace('-', ' ')}`;
      document.getElementById('storyInfoViews').innerHTML = `<i class="fas fa-eye"></i> ${storyData.views || 0} views`;
      document.getElementById('storyInfoText').textContent = storyData.description;
      
      // Update media gallery
      updateMediaGallery(storyData.mediaFiles || []);
      
      // Update contributors
      updateContributorsSection(storyData.contributors || {});
      
      // Update source info
      updateSourceInfo(storyData.sources || {});
      
      // Show modal
      document.getElementById('storyInfoModal').style.display = 'block';
      overlay.style.display = 'block';
      
      // Increment view count
      database.ref(`stories/${storyData.id}/views`).transaction(views => (views || 0) + 1);
    }

    function updateMediaGallery(mediaFiles) {
      const gallery = document.getElementById('storyMediaGallery');
      
      if (mediaFiles.length === 0) {
        document.getElementById('mediaGallerySection').style.display = 'none';
        return;
      }
      
      document.getElementById('mediaGallerySection').style.display = 'block';
      
      gallery.innerHTML = mediaFiles.map(media => {
        let content = '';
        
        switch (media.type) {
          case 'image':
            content = `<img src="${media.url}" alt="${media.caption || media.name}">`;
            break;
          case 'video':
            content = `<video src="${media.url}" controls></video>`;
            break;
          case 'audio':
            content = `<audio src="${media.url}" controls style="width: 100%; height: 50px;"></audio>`;
            break;
          default:
            content = `
              <div style="height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa;">
                <i class="fas fa-file" style="font-size: 2rem; margin-bottom: 0.5rem; color: #6c757d;"></i>
                <div style="text-align: center; font-size: 0.8rem;">${media.name}</div>
              </div>
            `;
        }
        
        return `
          <div class="gallery-item">
            ${content}
            ${media.caption ? `<div class="gallery-caption">${media.caption}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function updateContributorsSection(contributors) {
      const section = document.getElementById('storyContributors');
      
      section.innerHTML = Object.entries(contributors).map(([userId, contributor]) => `
        <div class="contributor-item">
          <div class="contributor-info">
            <div class="contributor-avatar">
              ${contributor.name.charAt(0).toUpperCase()}
            </div>
            <div class="contributor-details">
              <div class="contributor-name">${contributor.name}</div>
              <div class="contributor-role">${contributor.role}</div>
            </div>
          </div>
          <div class="contribution-date">
            ${new Date(contributor.timestamp).toLocaleDateString()}
          </div>
        </div>
      `).join('');
    }

    function updateSourceInfo(sources) {
      const section = document.getElementById('storySourceInfo');
      
      if (!sources.type) {
        section.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No source information provided</p>';
        return;
      }
      
      section.innerHTML = `
        <div style="line-height: 1.6;">
          <p><strong>Type:</strong> ${sources.type.replace('-', ' ')}</p>
          ${sources.title ? `<p><strong>Title:</strong> ${sources.title}</p>` : ''}
          ${sources.author ? `<p><strong>Author:</strong> ${sources.author}</p>` : ''}
          ${sources.date ? `<p><strong>Date:</strong> ${new Date(sources.date).toLocaleDateString()}</p>` : ''}
          ${sources.location ? `<p><strong>Location:</strong> ${sources.location}</p>` : ''}
          ${sources.notes ? `<p><strong>Notes:</strong> ${sources.notes}</p>` : ''}
        </div>
      `;
    }

    // Modal management
    function showAboutModal(e) {
      if (e) e.preventDefault();
      document.getElementById('aboutModal').style.display = 'block';
      overlay.style.display = 'block';
      menuContent.style.display = 'none';
    }

    function showInstructionsModal(e) {
      if (e) e.preventDefault();
      document.getElementById('instructionsModal').style.display = 'block';
      overlay.style.display = 'block';
      menuContent.style.display = 'none';
    }

    function closeAllModals() {
      document.querySelectorAll('.modal-base').forEach(modal => {
        modal.style.display = 'none';
      });
      overlay.style.display = 'none';
    }

    // Add close button event listeners
    document.getElementById('closeAbout').addEventListener('click', closeAllModals);
    document.getElementById('closeInstructions').addEventListener('click', closeAllModals);
    document.getElementById('closeStoryInfo').addEventListener('click', closeAllModals);

    // Keyboard shortcuts
    function handleKeyboardShortcuts(e) {
      if (e.key === 'Escape') {
        closeAllModals();
      }
    }

    // Notification system
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';

      setTimeout(() => {
        notification.style.display = 'none';
      }, 4000);
    }

    // Make functions globally available
    window.removeMedia = removeMedia;
    </script>
</body>
</html>
