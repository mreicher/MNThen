<!DOCTYPE html>
<html lang="en">
<head>
<!-- Basic Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Discover and share meaningful places across Minnesota with Community Markers Map">
    
  <title>Community Markers Map</title>
  <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.Default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" />
    
  <style>
    /* Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        overflow-x: hidden;
        color: #333;
        background-color: #f5f5f5;
        line-height: 1.6;
    }

    .leaflet-control-attribution {
        display: none;
    }

    /* Hide Leaflet zoom controls */
    .leaflet-control-zoom {
        display: none !important;
    }

    a {
        text-decoration: none;
        color: #1e40af;
        transition: color 0.3s ease;
    }

    a:hover {
        color: #1d4ed8;
    }

    /* Typography */
    h1, h2, h3, h4, h5, h6 {
        color: #1e293b;
        margin-bottom: 0.5em;
        font-weight: 600;
    }

    p {
        margin-bottom: 1em;
    }

    .sun-editor,
    .sun-editor .se-wrapper .se-content,
    .sun-editor .se-toolbar,
    .sun-editor .se-selector,
    .sun-editor .se-dialog {
        font-size: 15px !important;
    }

    /* Force font size in the editor's dialog boxes */
    .sun-editor .se-dialog {
        font-size: 15px !important;
    }

    /* Page Layout */
    .page {
        width: 100%;
        min-height: 100vh;
        position: relative;
    }

    .search-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('https://www.mnthen.com/images/header/mn_history_header.jpg');
        background-size: cover;
        background-position: center;
        color: white;
        text-align: center;
    }

    .search-page h1, .search-page h2, .search-page h3, 
    .search-page h4, .search-page h5, .search-page h6 {
        color: #ffffff;
    }

    .map-page {
        display: none;
        position: relative;
        height: 100vh;
        width: 100%;
    }

    /* Map Container */
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }

    /* Hero Content */
    .hero-content {
        max-width: 800px;
        padding: 2rem;
        z-index: 2;
        animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .hero-content h1 {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .hero-content p {
        font-size: 1.3rem;
        margin-bottom: 2rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Custom styles for Suneditor */
    #description-editor {
        border: 1px solid #d1d5db;
        border-radius: 5px;
        margin-bottom: 1rem;
    }

    .sun-editor .se-toolbar {
        background-color: #f9fafb;
        border-bottom: 1px solid #d1d5db;
    }

    .sun-editor .se-wrapper {
        background-color: white;
    }

    /* Search Components */
    .search-container {
        width: 100%;
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    .search-bar {
        display: flex;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .search-bar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .search-input {
        flex: 1;
        padding: 1.2rem 1.5rem;
        border: none;
        font-size: 1.1rem;
        outline: none;
    }

    .search-button {
        padding: 1.2rem 2rem;
        background-color: #1e40af;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .search-button:hover {
        background-color: #1d4ed8;
    }

    .map-search-bar {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        width: 80%;
        max-width: 500px;
        z-index: 10;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.3s ease;
    }

    .map-search-bar:hover {
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
    }

    .map-search-input {
        flex: 1;
        padding: 0.9rem 1.25rem;
        border: none;
        font-size: 1rem;
        outline: none;
    }

    .map-search-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border: none;
        background-color: #1e40af;
        border-radius: 0 50px 50px 0;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .map-search-button:hover {
        background-color: #1d4ed8;
    }

    .map-search-button i {
        color: white;
        font-size: 18px;
    }

    /* Authentication UI - moved to dropdown menu */
    .auth-menu-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .user-avatar-small {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #1e40af;
    }



    /* Features Grid - positioned under search bar */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem;
        max-width: 900px;
        width: 100%;
        margin-top: 3rem;
    }

    .feature-item {
        text-align: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.3s ease;
    }

    .feature-item:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.2);
    }

    .feature-item i {
        font-size: 2rem;
        margin-bottom: 0.8rem;
        color: #ffffff;
    }

    .feature-item h3 {
        font-size: 1.1rem;
        margin-bottom: 0.6rem;
        color: #ffffff;
    }

    .feature-item p {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.4;
    }

    /* Filter Controls - moved to bottom right */
    .filter-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-width: 200px;
    }

    .filter-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #1e293b;
    }

    .filter-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .filter-item:hover {
        background-color: rgba(30, 64, 175, 0.1);
    }

    .filter-checkbox {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 8px;
        border: 2px solid;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
    }

    .filter-checkbox.architecture {
        border-color: #1e40af;
        background-color: #1e40af;
    }

    .filter-checkbox.nature {
        border-color: #10b981;
        background-color: #10b981;
    }

    .filter-checkbox.events {
        border-color: #f59e0b;
        background-color: #f59e0b;
    }

    .filter-checkbox.people {
        border-color: #8b5cf6;
        background-color: #8b5cf6;
    }

    .filter-checkbox.unchecked {
        background-color: transparent;
        color: transparent;
    }

    /* Floating Menu */
    .floating-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    .floating-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #1e40af;
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .floating-btn:hover {
        background-color: #1d4ed8;
        transform: scale(1.05);
    }

    .menu-content {
        display: none;
        position: absolute;
        top: 60px;
        left: 0;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        padding: 0.5rem;
        width: 220px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .menu-content a {
        display: block;
        padding: 0.85rem 1.2rem;
        color: #333;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 500;
    }

    .menu-content a:hover {
        background-color: #f3f4f6;
        color: #1e40af;
        transform: translateX(5px);
    }

    .menu-content a.mn-then-link {
        color: #1e40af;
        font-weight: 600;
        border-top: 1px solid #e5e7eb;
        margin-top: 0.5rem;
        padding-top: 1rem;
    }

    /* User authentication UI */
    .user-info {
        display: flex;
        align-items: center;
        padding: 0.85rem 1.2rem;
        gap: 0.8rem;
        border-radius: 8px;
        background-color: #f8fafc;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #1e40af;
        object-fit: cover;
    }

    .user-name {
        font-weight: 600;
        color: #1e293b;
        flex-grow: 1;
    }

    .logout-button {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background-color 0.3s;
    }

    .logout-button:hover {
        background: #dc2626;
    }

    /* Click to Add Indicator */
    .click-indicator {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(30, 64, 175, 0.95);
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: none;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 0.8; }
        50% { opacity: 1; }
        100% { opacity: 0.8; }
    }



    /* Overlay */
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        backdrop-filter: blur(3px);
        transition: opacity 0.3s ease;
    }

    /* Modal Base */
    .modal-base {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        padding: 2.5rem;
        max-width: 90%;
        width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1100;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translate(-50%, -48%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .modal-base h2 {
        color: #1e40af;
        margin-bottom: 1.2rem;
        font-size: 1.8rem;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 0.8rem;
    }

    .modal-base p {
        margin-bottom: 1rem;
        color: #374151;
        line-height: 1.7;
    }

    .modal-base .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.8rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0.3rem;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .modal-base .close-btn:hover {
        background-color: #f3f4f6;
        color: #1e40af;
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }

    .form-input {
        width: 100%;
        padding: 0.9rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        background-color: #fafafa;
    }

    .form-input:focus {
        outline: none;
        border-color: #1e40af;
        background-color: white;
    }

    .form-textarea {
        width: 100%;
        padding: 0.9rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        background-color: #fafafa;
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #1e40af;
        background-color: white;
    }

    .form-select {
        width: 100%;
        padding: 0.9rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        background-color: #fafafa;
        cursor: pointer;
    }

    .form-select:focus {
        outline: none;
        border-color: #1e40af;
        background-color: white;
    }

    /* Buttons */
    .btn {
        display: inline-block;
        padding: 0.9rem 1.8rem;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-size: 1rem;
    }

    .btn-primary {
        background-color: #1e40af;
        color: white;
    }

    .btn-primary:hover {
        background-color: #1d4ed8;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
    }

    .btn-danger {
        background-color: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background-color: #b91c1c;
    }

    /* Notification System */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 2000;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .notification.success {
        background-color: #10b981;
        color: white;
    }

    .notification.error {
        background-color: #dc2626;
        color: white;
    }

    .notification.info {
        background-color: #1e40af;
        color: white;
    }

    /* Marker Details in Popup */
    .marker-popup {
        max-width: 300px;
        font-family: inherit;
    }

    .marker-popup h3 {
        color: #1e40af;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .marker-popup p {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .marker-popup .category-tag {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.5rem;
    }

    .marker-popup .category-tag.architecture {
        background-color: #1e40af;
    }

    .marker-popup .category-tag.nature {
        background-color: #10b981;
    }

    .marker-popup .category-tag.events {
        background-color: #f59e0b;
    }

    .marker-popup .category-tag.people {
        background-color: #8b5cf6;
    }

    .marker-popup .popup-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.8rem;
    }

    .marker-popup .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        border-radius: 4px;
        font-weight: 500;
    }

    /* Comments Section */
    .comments-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #f3f4f6;
    }

    .comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .add-comment-form {
        background-color: #f9fafb;
        padding: 1.2rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .comment {
        background-color: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #1e40af;
    }

    .comment-author {
        font-weight: 600;
        color: #1e40af;
        margin-bottom: 0.3rem;
    }

    .comment-date {
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }

    .comment-text {
        color: #374151;
        line-height: 1.6;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hero-content h1 {
            font-size: 2.5rem;
        }

        .hero-content p {
            font-size: 1.1rem;
        }

        .search-container {
            max-width: 90%;
        }

        .map-search-bar {
            width: 90%;
            max-width: 400px;
        }

        .category-selector {
            max-width: 95%;
            padding: 10px;
            gap: 8px;
        }

        .category-badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .modal-base {
            max-width: 95%;
            padding: 1.5rem;
        }

        .floating-menu {
            top: 15px;
            left: 15px;
        }

        .auth-container {
            top: 15px;
            right: 15px;
            padding: 0.8rem;
        }

        .category-legend {
            top: 70px;
            right: 15px;
            max-width: 150px;
            padding: 8px;
        }
    }

    /* Loading Animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top-color: #1e40af;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Front page navigation menu */
    .front-page-nav {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    .front-nav-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.3);
        color: rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .front-nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
    }

    .front-menu-content {
        display: none;
        position: absolute;
        top: 60px;
        left: 0;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        padding: 0.5rem;
        width: 200px;
        animation: slideIn 0.3s ease-out;
        backdrop-filter: blur(10px);
    }

    .front-menu-content a {
        display: block;
        padding: 0.85rem 1.2rem;
        color: #333;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 500;
    }

    .front-menu-content a:hover {
        background-color: #f3f4f6;
        color: #1e40af;
        transform: translateX(5px);
    }

    .front-menu-content a.mn-then-link {
        color: #1e40af;
        font-weight: 600;
        border-top: 1px solid #e5e7eb;
        margin-top: 0.5rem;
        padding-top: 1rem;
    }

    /* Info button for map and front page */
    .info-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.3);
        color: rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 1000;
    }

    .info-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
    }

    /* Map page info button - different styling */
    .map-page .info-button {
        background-color: rgba(255, 255, 255, 0.9);
        color: #1e40af;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .map-page .info-button:hover {
        background-color: #1e40af;
        color: white;
    }
  </style>
</head>
<body>
  <!-- Search/Welcome Page -->
  <div class="page search-page" id="searchPage">
    <!-- Front page navigation -->
    <div class="front-page-nav">
      <button class="front-nav-btn" id="frontMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <div class="front-menu-content" id="frontMenuContent">
        <a href="#" onclick="showMapPage()"><i class="fas fa-map"></i> Explore Map</a>
        <a href="#" onclick="showAboutModal()"><i class="fas fa-info-circle"></i> About</a>
        <a href="#" onclick="showHelpModal()"><i class="fas fa-question-circle"></i> Help</a>
        <a href="https://www.mnthen.com" target="_blank" class="mn-then-link"><i class="fas fa-external-link-alt"></i> Minnesota Then</a>
      </div>
    </div>

    <!-- Info button for image source -->
    <button class="info-button" onclick="showImageInfoModal()">
      <i class="fas fa-info"></i>
    </button>

    <div class="hero-content">
      <h1>Community Markers Map</h1>
      <p class="subtitle">Discover and share meaningful places across Minnesota. A collaborative platform for preserving local history and cultural heritage.</p>
      
      <div class="search-container">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search for Minnesota locations (e.g., Minneapolis, Duluth, Rochester)..." id="mainSearchInput">
          <button class="search-button" id="mainSearchButton">
            <i class="fas fa-search"></i>
            Search
          </button>
        </div>
      </div>
      
      <div class="features-grid">
        <div class="feature-item">
          <i class="fas fa-map-marker-alt"></i>
          <h3>Mark Historical Sites</h3>
          <p>Add markers for significant locations with rich descriptions and photos</p>
        </div>
        <div class="feature-item">
          <i class="fas fa-users"></i>
          <h3>Community Driven</h3>
          <p>Collaborate with others to build a comprehensive historical database</p>
        </div>
        <div class="feature-item">
          <i class="fas fa-clock"></i>
          <h3>Preserve History</h3>
          <p>Help preserve Minnesota's heritage and stories for future generations</p>
        </div>
      </div>
    </div>
    

  </div>

  <!-- Map Page -->
  <div class="page map-page" id="mapPage">

    <!-- Floating Menu -->
    <div class="floating-menu">
      <button class="floating-btn" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <div class="menu-content" id="menuContent">
        <a href="#" onclick="showSearchPage()"><i class="fas fa-home"></i> Home</a>
        <div id="authMenuItems">
          <!-- Auth items will be inserted here -->
        </div>
        <a href="#" onclick="showAboutModal()"><i class="fas fa-info-circle"></i> About</a>
        <a href="#" onclick="showHelpModal()"><i class="fas fa-question-circle"></i> Help</a>
        <a href="#" onclick="showShareModal()"><i class="fas fa-share-alt"></i> Share</a>
        <a href="https://www.mnthen.com" target="_blank" class="mn-then-link"><i class="fas fa-external-link-alt"></i> Minnesota Then</a>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="map-search-bar">
      <input type="text" class="map-search-input" placeholder="Search Minnesota locations..." id="mapSearchInput">
      <button class="map-search-button" id="mapSearchButton">
        <i class="fas fa-search"></i>
      </button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Click to Add Indicator -->
    <div class="click-indicator" id="clickIndicator">
      <i class="fas fa-mouse-pointer"></i>
      Click on the map to add a new historical marker
    </div>

    <!-- Info button for image source -->
    <button class="info-button" onclick="showImageInfoModal()">
      <i class="fas fa-info"></i>
    </button>

    <!-- Filter Controls -->
    <div class="filter-controls">
      <div class="filter-title">Show Categories</div>
      <div class="filter-item" data-category="architecture">
        <div class="filter-checkbox architecture" id="architectureFilter">✓</div>
        <span>Architecture</span>
      </div>
      <div class="filter-item" data-category="nature">
        <div class="filter-checkbox nature" id="natureFilter">✓</div>
        <span>Nature</span>
      </div>
      <div class="filter-item" data-category="events">
        <div class="filter-checkbox events" id="eventsFilter">✓</div>
        <span>Events</span>
      </div>
      <div class="filter-item" data-category="people">
        <div class="filter-checkbox people" id="peopleFilter">✓</div>
        <span>People</span>
      </div>
    </div>
  </div>

  <!-- Overlay for modals -->
  <div class="overlay" id="overlay"></div>

  <!-- Add Marker Modal -->
  <div class="modal-base" id="addMarkerModal">
    <button class="close-btn" onclick="closeModal('addMarkerModal')">&times;</button>
    <h2><i class="fas fa-map-marker-plus"></i> Add Historical Marker</h2>
    
    <form id="markerForm">
      <div class="form-group">
        <label class="form-label">Title *</label>
        <input type="text" class="form-input" id="markerTitle" required placeholder="Enter a descriptive title">
      </div>
      
      <div class="form-group">
        <label class="form-label">Category *</label>
        <select class="form-select" id="markerCategory" required>
          <option value="">Select category</option>
          <option value="architecture">Architecture</option>
          <option value="nature">Nature</option>
          <option value="events">Historical Events</option>
          <option value="people">Notable People</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Year/Period</label>
        <input type="text" class="form-input" id="markerYear" placeholder="e.g., 1875, 1900s, Early 1800s">
      </div>
      
      <div class="form-group">
        <label class="form-label">Description *</label>
        <div id="description-editor"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Image URL</label>
        <input type="url" class="form-input" id="markerImage" placeholder="https://example.com/image.jpg">
      </div>
      
      <div class="form-group">
        <label class="form-label">Source/Reference</label>
        <input type="text" class="form-input" id="markerSource" placeholder="Historical society, book, website, etc.">
      </div>
      
      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Save Marker
        </button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('addMarkerModal')">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Marker Details Modal -->
  <div class="modal-base" id="markerDetailsModal">
    <button class="close-btn" onclick="closeModal('markerDetailsModal')">&times;</button>
    <div id="markerDetailsContent">
      <!-- Content populated dynamically -->
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal-base" id="aboutModal">
    <button class="close-btn" onclick="closeModal('aboutModal')">&times;</button>
    <h2>About Community Markers Map</h2>
    <p>Community Markers Map is a collaborative historical location mapping platform focused on Minnesota. Discover and share meaningful places across the state, creating a community-driven database of historical locations.</p>
    
    <p>This platform serves as a digital preservation tool for local history and cultural heritage, enabling users to mark, describe, and explore significant locations that have shaped Minnesota's story.</p>
    
    <p><strong>Key Features:</strong></p>
    <p>• Interactive mapping with detailed historical information<br>
    • Community-driven content creation and collaboration<br>
    • Rich text descriptions with photos and sources<br>
    • Organized by categories: Architecture, Nature, Events, and People<br>
    • Real-time commenting and discussion</p>
    
    <p>Join us in preserving Minnesota's heritage for future generations. Every location has a story - help us tell them all.</p>
    
    <p><em>A project by <a href="https://www.mnthen.com" target="_blank">Minnesota Then</a></em></p>
  </div>

  <!-- Help Modal -->
  <div class="modal-base" id="helpModal">
    <button class="close-btn" onclick="closeModal('helpModal')">&times;</button>
    <h2>How to Use Community Markers Map</h2>
    
    <p><strong>Exploring the Map</strong><br>
    Browse freely without signing in. Click on any marker to learn about that historical location. Use the category filters in the bottom right to show or hide different types of markers.</p>
    
    <p><strong>Adding Historical Markers</strong><br>
    To contribute your own historical knowledge:</p>
    <p>1. Sign in using the menu in the top left corner<br>
    2. Click anywhere on the Minnesota map where you want to add a marker<br>
    3. Fill out the form with historical details, photos, and sources<br>
    4. Submit to share with the community</p>
    
    <p><strong>Quality Guidelines</strong><br>
    • Use specific, descriptive titles<br>
    • Include historical context and approximate dates<br>
    • Cite sources when possible for verification<br>
    • Select the most appropriate category<br>
    • Add images that help tell the story</p>
    
    <p><strong>Community Standards</strong><br>
    All contributions should be respectful, accurate, and relevant to Minnesota history. Content that doesn't meet these standards will be removed to maintain the integrity of our historical database.</p>
    
    <p>Questions? Contact us through <a href="https://www.mnthen.com" target="_blank">Minnesota Then</a>.</p>
  </div>

  <!-- Share Modal -->
  <div class="modal-base" id="shareModal">
    <button class="close-btn" onclick="closeModal('shareModal')">&times;</button>
    <h2><i class="fas fa-share-alt"></i> Share Community Markers Map</h2>
    <p>Help grow our community by sharing this historical mapping project!</p>
    
    <div class="share-options">
      <button class="btn btn-primary" onclick="shareOnSocial('facebook')">
        <i class="fab fa-facebook"></i> Share on Facebook
      </button>
      <button class="btn btn-primary" onclick="shareOnSocial('twitter')">
        <i class="fab fa-twitter"></i> Share on Twitter
      </button>
      <button class="btn btn-secondary" onclick="copyShareLink()">
        <i class="fas fa-link"></i> Copy Link
      </button>
    </div>
    
    <div class="form-group">
      <label class="form-label">Direct Link</label>
      <input type="text" class="form-input" id="shareLink" readonly value="">
    </div>
  </div>

  <!-- Image Info Modal -->
  <div class="modal-base" id="imageInfoModal">
    <button class="close-btn" onclick="closeModal('imageInfoModal')">&times;</button>
    <h2>Image Source</h2>
    <p><strong>Background Image:</strong> Minnesota History Header</p>
    <p><strong>Source:</strong> <a href="https://www.mnthen.com" target="_blank">Minnesota Then</a></p>
    <p><strong>Description:</strong> Historic photograph showcasing Minnesota's rich heritage and landscapes, used with permission as the backdrop for our collaborative historical mapping platform.</p>
    <p>This image represents the spirit of Minnesota's history that we aim to preserve and share through community contributions.</p>
  </div>

  <!-- Firebase and External Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
<!-- Firebase and External Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCQLUeL28hLlvG6hXkvVqM8GG7tIIEEFpM",
      authDomain: "mn-then-8ca75.firebaseapp.com",
      projectId: "mn-then-8ca75",
      storageBucket: "mn-then-8ca75.firebasestorage.app",
      messagingSenderId: "638953816865",
      appId: "1:638953816865:web:88e5a53dc75877b5ab9daf"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Global Firebase references
    window.auth = firebase.auth();
    window.db = firebase.firestore();
    window.provider = new firebase.auth.GoogleAuthProvider();

    // Authentication state management
    let currentUser = null;

    function updateAuthUI() {
      const authMenuItems = document.getElementById('authMenuItems');
      
      if (currentUser) {
        authMenuItems.innerHTML = `
          <div class="user-info">
            <img src="${currentUser.photoURL || 'https://via.placeholder.com/32'}" alt="User" class="user-avatar">
            <span class="user-name">${currentUser.displayName || 'User'}</span>
            <button class="logout-button" onclick="signOutUser()">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        `;
      } else {
        authMenuItems.innerHTML = `
          <a href="#" onclick="signInUser()"><i class="fas fa-sign-in-alt"></i> Sign In</a>
        `;
      }
    }

    // Initialize authentication
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      updateAuthUI();
      
      if (user) {
        console.log('User signed in:', user.displayName);
        showNotification(`Welcome, ${user.displayName}!`, 'success');
        showClickIndicator();
      } else {
        console.log('User signed out');
        hideClickIndicator();
      }
    });

    // Click indicator functions
    function showClickIndicator() {
      if (currentUser) {
        const indicator = document.getElementById('clickIndicator');
        if (indicator) indicator.style.display = 'block';
      }
    }

    function hideClickIndicator() {
      const indicator = document.getElementById('clickIndicator');
      if (indicator) indicator.style.display = 'none';
    }
  </script>

  <!-- External Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

  <!-- Main Application Script -->
  <script>
    console.log("Loading...");
    
    // Global variables
    let map;
    let markers;
    let editor;
    let tempMarkerPosition = null;
    let isAddingMarker = false;
    const MINNESOTA_BOUNDS = [[43.5, -97.5], [49.5, -89.0]];
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      console.log("Service Worker support detected");
      initializeEditor();
      setupEventListeners();
      
      // Set share link if element exists
      const shareLink = document.getElementById('shareLink');
      if (shareLink) {
        shareLink.value = window.location.href;
      }
      
      setTimeout(() => {
        console.log("Loading complete");
      }, 3000);
    });

    // Authentication functions
    function signInUser() {
      firebase.auth().signInWithRedirect(window.provider);
    }

    function signOutUser() {
      firebase.auth().signOut().then(() => {
        showNotification('Signed out successfully', 'success');
      });
    }

    // Location search functionality
    async function searchAndShowLocation(searchTerm) {
      showMapPage();
      
      // Wait for map to initialize
      setTimeout(() => {
        searchLocation(searchTerm);
      }, 500);
    }

    async function searchLocation(searchTerm) {
      if (!map) return;
      
      try {
        showNotification('Searching...', 'info');
        
        // Use OpenStreetMap Nominatim geocoding - more reliable approach
        const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=us&q=${encodeURIComponent(searchTerm + ' Minnesota')}`;
        
        const response = await fetch(searchUrl, {
          headers: {
            'User-Agent': 'CommunityMarkersMap/1.0'
          }
        });
        
        if (!response.ok) {
          throw new Error('Search service unavailable');
        }
        
        const results = await response.json();
        console.log('Search results:', results);
        
        if (results && results.length > 0) {
          // Filter for Minnesota results
          const mnResults = results.filter(result => {
            const lat = parseFloat(result.lat);
            const lon = parseFloat(result.lon);
            return lat >= 43.5 && lat <= 49.5 && lon >= -97.5 && lon <= -89.0;
          });
          
          if (mnResults.length > 0) {
            const result = mnResults[0];
            const lat = parseFloat(result.lat);
            const lon = parseFloat(result.lon);
            
            // Determine zoom level based on place type
            let zoomLevel = 12;
            if (result.type === 'city' || result.type === 'town') {
              zoomLevel = 13;
            } else if (result.type === 'county') {
              zoomLevel = 10;
            } else if (result.type === 'state') {
              zoomLevel = 7;
            }
            
            map.setView([lat, lon], zoomLevel);
            
            // Create and add temporary marker
            const tempMarker = L.marker([lat, lon], {
              icon: L.divIcon({
                html: '<div style="background-color: #ef4444; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;"><i class="fas fa-search" style="color: white; font-size: 14px;"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                className: 'search-result-marker'
              })
            }).addTo(map);
            
            const displayName = result.display_name.split(',').slice(0, 3).join(', ');
            tempMarker.bindPopup(`<strong>${displayName}</strong><br><em>Search result</em>`).openPopup();
            
            // Remove temporary marker after 15 seconds
            setTimeout(() => {
              if (map.hasLayer(tempMarker)) {
                map.removeLayer(tempMarker);
              }
            }, 15000);
            
            showNotification(`Found: ${displayName}`, 'success');
          } else {
            showNotification('No Minnesota locations found. Try searching for a Minnesota city, county, or landmark.', 'error');
          }
        } else {
          showNotification('Location not found. Please try a different search term.', 'error');
        }
      } catch (error) {
        console.error('Search error:', error);
        showNotification('Search service temporarily unavailable. Please try again.', 'error');
      }
    }

    // Page navigation
    function showMapPage() {
      document.getElementById('searchPage').style.display = 'none';
      document.getElementById('mapPage').style.display = 'block';
      
      if (!map) {
        initializeMap();
      }
      
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
        }
      }, 100);
    }

    function showSearchPage() {
      document.getElementById('mapPage').style.display = 'none';
      document.getElementById('searchPage').style.display = 'flex';
    }

    // Map initialization
    function initializeMap() {
      if (map) return;
      
      // Initialize map centered on Minnesota without zoom controls
      map = L.map('map', {
        zoomControl: false, // Disable zoom controls
        center: [46.7296, -94.6859], // Minnesota center
        zoom: 7,
        minZoom: 6,
        maxZoom: 18
      });

      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Initialize marker cluster group
      markers = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 80,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          let className = 'marker-cluster ';
          
          if (count < 10) {
            className += 'marker-cluster-small';
          } else if (count < 100) {
            className += 'marker-cluster-medium';
          } else {
            className += 'marker-cluster-large';
          }
          
          return new L.DivIcon({
            html: '<div><span>' + count + '</span></div>',
            className: className,
            iconSize: new L.Point(40, 40)
          });
        }
      });

      map.addLayer(markers);

      // Add click listener for authenticated users to add markers
      map.on('click', function(e) {
        if (currentUser && isWithinMinnesota(e.latlng)) {
          tempMarkerPosition = e.latlng;
          openAddMarkerModal();
        } else if (!currentUser) {
          showNotification('Please sign in to add markers', 'info');
        } else {
          showNotification('Please click within Minnesota boundaries', 'error');
        }
      });

      // Load existing markers
      loadMarkers();
    }

    function isWithinMinnesota(latlng) {
      const lat = latlng.lat;
      const lng = latlng.lng;
      
      // Minnesota approximate bounds
      return lat >= 43.5 && lat <= 49.5 && lng >= -97.5 && lng <= -89.0;
    }

    // Initialize rich text editor
    function initializeEditor() {
      if (typeof SUNEDITOR !== 'undefined') {
        setTimeout(() => {
          try {
            editor = SUNEDITOR.create('description-editor', {
              height: 200,
              buttonList: [
                ['undo', 'redo'],
                ['bold', 'italic', 'underline'],
                ['list', 'outdent', 'indent'],
                ['link', 'image'],
                ['removeFormat']
              ],
              placeholder: 'Describe the historical significance of this location...'
            });
          } catch (error) {
            console.warn('Editor initialization failed:', error);
          }
        }, 100);
      }
    }

    // Event listeners setup
    function setupEventListeners() {
      // Search functionality for front page
      const mainSearchButton = document.getElementById('mainSearchButton');
      const mainSearchInput = document.getElementById('mainSearchInput');
      
      if (mainSearchButton) {
        mainSearchButton.addEventListener('click', function() {
          const searchTerm = document.getElementById('mainSearchInput').value.trim();
          if (searchTerm) {
            searchAndShowLocation(searchTerm);
          } else {
            showMapPage();
          }
        });
      }
      
      if (mainSearchInput) {
        mainSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const searchTerm = this.value.trim();
            if (searchTerm) {
              searchAndShowLocation(searchTerm);
            } else {
              showMapPage();
            }
          }
        });
      }
      
      // Search functionality for map page
      const mapSearchButton = document.getElementById('mapSearchButton');
      const mapSearchInput = document.getElementById('mapSearchInput');
      
      if (mapSearchButton) {
        mapSearchButton.addEventListener('click', function() {
          const searchTerm = document.getElementById('mapSearchInput').value.trim();
          if (searchTerm) {
            searchLocation(searchTerm);
          }
        });
      }
      
      if (mapSearchInput) {
        mapSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const searchTerm = this.value.trim();
            if (searchTerm) {
              searchLocation(searchTerm);
            }
          }
        });
      }

      // Filter controls
      document.querySelectorAll('.filter-item').forEach(item => {
        item.addEventListener('click', function() {
          toggleFilter(this.dataset.category);
        });
      });

      // Menu toggle for map page
      const menuToggle = document.getElementById('menuToggle');
      if (menuToggle) {
        menuToggle.addEventListener('click', function() {
          const menuContent = document.getElementById('menuContent');
          if (menuContent) {
            menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
          }
        });
      }

      // Menu toggle for front page
      const frontMenuToggle = document.getElementById('frontMenuToggle');
      if (frontMenuToggle) {
        frontMenuToggle.addEventListener('click', function() {
          const menuContent = document.getElementById('frontMenuContent');
          if (menuContent) {
            menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
          }
        });
      }

      // Close menus when clicking outside
      document.addEventListener('click', function(e) {
        const mapMenu = document.getElementById('menuContent');
        const mapToggle = document.getElementById('menuToggle');
        const frontMenu = document.getElementById('frontMenuContent');
        const frontToggle = document.getElementById('frontMenuToggle');
        
        if (mapMenu && mapToggle && !mapMenu.contains(e.target) && !mapToggle.contains(e.target)) {
          mapMenu.style.display = 'none';
        }
        
        if (frontMenu && frontToggle && !frontMenu.contains(e.target) && !frontToggle.contains(e.target)) {
          frontMenu.style.display = 'none';
        }
      });

      // Marker form submission
      const markerForm = document.getElementById('markerForm');
      if (markerForm) {
        markerForm.addEventListener('submit', handleMarkerSubmit);
      }

      // Modal overlay clicks
      const overlay = document.getElementById('overlay');
      if (overlay) {
        overlay.addEventListener('click', function() {
          closeAllModals();
        });
      }
    }

    // Marker management
    async function loadMarkers() {
      try {
        const markersRef = db.collection('markers');
        const q = markersRef.orderBy('createdAt', 'desc');
        
        q.onSnapshot((snapshot) => {
          if (markers) {
            markers.clearLayers();
          }
          
          const categoryCounts = {
            architecture: 0,
            nature: 0,
            events: 0,
            people: 0
          };
          
          snapshot.forEach((doc) => {
            const markerData = { id: doc.id, ...doc.data() };
            addMarkerToMap(markerData);
            if (categoryCounts.hasOwnProperty(markerData.category)) {
              categoryCounts[markerData.category]++;
            }
          });
          console.log(`Loaded ${snapshot.size} markers`);
        });
        
      } catch (error) {
        console.error('Error loading markers:', error);
        showNotification('Error loading markers', 'error');
      }
    }

    function addMarkerToMap(markerData) {
      if (!markers || !markerData.lat || !markerData.lng) return;
      
      const categoryColors = {
        architecture: '#1e40af',
        nature: '#10b981',
        events: '#f59e0b',
        people: '#8b5cf6'
      };

      const categoryIcons = {
        architecture: 'fas fa-building',
        nature: 'fas fa-tree',
        events: 'fas fa-calendar',
        people: 'fas fa-user'
      };

      const iconColor = categoryColors[markerData.category] || '#1e40af';
      const iconClass = categoryIcons[markerData.category] || 'fas fa-map-marker-alt';

      const customIcon = L.divIcon({
        html: `<div style="background-color: ${iconColor}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="${iconClass}" style="color: white; font-size: 14px;"></i></div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        className: 'custom-marker-icon'
      });

      const marker = L.marker([markerData.lat, markerData.lng], { 
        icon: customIcon,
        markerData: markerData
      });

      const popupContent = `
        <div class="marker-popup">
          <h3>${markerData.title || 'Untitled'}</h3>
          <div class="category-tag ${markerData.category}">${markerData.category}</div>
          ${markerData.year ? `<p><strong>Period:</strong> ${markerData.year}</p>` : ''}
          <p>${markerData.description ? markerData.description.substring(0, 150) + '...' : ''}</p>
          ${markerData.source ? `<p><em>Source: ${markerData.source}</em></p>` : ''}
          <div class="popup-actions">
            <button class="btn btn-primary btn-small" onclick="showMarkerDetails('${markerData.id}')">
              <i class="fas fa-info-circle"></i> Details
            </button>
          </div>
        </div>
      `;

      marker.bindPopup(popupContent);
      markers.addLayer(marker);
    }

    async function handleMarkerSubmit(e) {
      e.preventDefault();
      
      if (!currentUser || !tempMarkerPosition) {
        showNotification('Authentication error. Please try again.', 'error');
        return;
      }

      const formData = {
        title: document.getElementById('markerTitle').value.trim(),
        category: document.getElementById('markerCategory').value,
        year: document.getElementById('markerYear').value.trim(),
        description: editor ? editor.getContents() : '',
        image: document.getElementById('markerImage').value.trim(),
        source: document.getElementById('markerSource').value.trim(),
        lat: tempMarkerPosition.lat,
        lng: tempMarkerPosition.lng,
        authorId: currentUser.uid,
        authorName: currentUser.displayName,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Validate required fields
      if (!formData.title || !formData.category || !formData.description) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }

      try {
        const docRef = await db.collection('markers').add(formData);
        console.log('Marker added with ID:', docRef.id);
        
        showNotification('Marker added successfully!', 'success');
        closeModal('addMarkerModal');
        resetMarkerForm();
        tempMarkerPosition = null;
        
      } catch (error) {
        console.error('Error adding marker:', error);
        showNotification('Error adding marker. Please try again.', 'error');
      }
    }

    function resetMarkerForm() {
      const form = document.getElementById('markerForm');
      if (form) {
        form.reset();
      }
      if (editor) {
        editor.setContents('');
      }
      tempMarkerPosition = null;
    }

    // Modal functions
    function openAddMarkerModal() {
      if (!currentUser) {
        showNotification('Please sign in to add markers', 'info');
        return;
      }
      
      showModal('addMarkerModal');
    }

    function showModal(modalId) {
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById(modalId);
      
      if (overlay && modal) {
        overlay.style.display = 'block';
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal(modalId) {
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById(modalId);
      
      if (modal) {
        modal.style.display = 'none';
      }
      if (overlay) {
        overlay.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
      
      if (modalId === 'addMarkerModal') {
        resetMarkerForm();
      }
    }

    function closeAllModals() {
      const modals = document.querySelectorAll('.modal-base');
      const overlay = document.getElementById('overlay');
      
      modals.forEach(modal => modal.style.display = 'none');
      if (overlay) {
        overlay.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
    }

    function showAboutModal() {
      showModal('aboutModal');
    }

    function showHelpModal() {
      showModal('helpModal');
    }

    function showShareModal() {
      showModal('shareModal');
    }

    function showImageInfoModal() {
      showModal('imageInfoModal');
    }

    async function showMarkerDetails(markerId) {
      try {
        const doc = await db.collection('markers').doc(markerId).get();
        
        if (doc.exists) {
          const markerData = { id: doc.id, ...doc.data() };
          displayMarkerDetails(markerData);
          showModal('markerDetailsModal');
        }
      } catch (error) {
        console.error('Error fetching marker details:', error);
        showNotification('Error loading marker details', 'error');
      }
    }

    function displayMarkerDetails(markerData) {
      const content = document.getElementById('markerDetailsContent');
      if (!content) return;
      
      content.innerHTML = `
        <h2>${markerData.title}</h2>
        <div class="category-tag ${markerData.category}" style="margin-bottom: 1rem;">${markerData.category}</div>
        ${markerData.year ? `<p><strong>Period:</strong> ${markerData.year}</p>` : ''}
        ${markerData.image ? `<img src="${markerData.image}" alt="${markerData.title}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin: 1rem 0;">` : ''}
        <div style="margin: 1rem 0;">${markerData.description}</div>
        ${markerData.source ? `<p><em><strong>Source:</strong> ${markerData.source}</em></p>` : ''}
        <p><small>Added by ${markerData.authorName} on ${markerData.createdAt?.toDate?.()?.toLocaleDateString?.() || 'Unknown date'}</small></p>
        
        <div class="comments-section">
          <div class="comments-header">
            <h3>Community Comments</h3>
            ${currentUser ? `<button class="btn btn-primary btn-small" onclick="toggleAddComment('${markerData.id}')">Add Comment</button>` : ''}
          </div>
          
          <div id="addCommentForm-${markerData.id}" class="add-comment-form" style="display: none;">
            <textarea id="commentText-${markerData.id}" class="form-textarea" placeholder="Share your knowledge about this location..." rows="3"></textarea>
            <div style="margin-top: 0.5rem;">
              <button class="btn btn-primary btn-small" onclick="submitComment('${markerData.id}')">Post Comment</button>
              <button class="btn btn-secondary btn-small" onclick="toggleAddComment('${markerData.id}')">Cancel</button>
            </div>
          </div>
          
          <div id="commentsList-${markerData.id}">
            <!-- Comments will be loaded here -->
          </div>
        </div>
      `;
      
      loadComments(markerData.id);
    }

    // Comments functionality
    async function loadComments(markerId) {
      try {
        const commentsRef = db.collection('comments');
        const q = commentsRef.where('markerId', '==', markerId).orderBy('createdAt', 'desc');
        
        q.onSnapshot((snapshot) => {
          const commentsList = document.getElementById(`commentsList-${markerId}`);
          if (!commentsList) return;
          
          commentsList.innerHTML = '';
          
          snapshot.forEach((doc) => {
            const commentData = doc.data();
            const commentEl = document.createElement('div');
            commentEl.className = 'comment';
            commentEl.innerHTML = `
              <div class="comment-author">${commentData.authorName}</div>
              <div class="comment-date">${commentData.createdAt?.toDate?.()?.toLocaleDateString?.() || 'Unknown date'}</div>
              <div class="comment-text">${commentData.text}</div>
            `;
            commentsList.appendChild(commentEl);
          });
        });
        
      } catch (error) {
        console.error('Error loading comments:', error);
      }
    }

    function toggleAddComment(markerId) {
      const form = document.getElementById(`addCommentForm-${markerId}`);
      if (form) {
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      }
    }

    async function submitComment(markerId) {
      if (!currentUser) {
        showNotification('Please sign in to comment', 'info');
        return;
      }

      const commentTextElement = document.getElementById(`commentText-${markerId}`);
      if (!commentTextElement) return;
      
      const commentText = commentTextElement.value.trim();
      
      if (!commentText) {
        showNotification('Please enter a comment', 'error');
        return;
      }

      try {
        await db.collection('comments').add({
          markerId: markerId,
          text: commentText,
          authorId: currentUser.uid,
          authorName: currentUser.displayName,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        commentTextElement.value = '';
        toggleAddComment(markerId);
        showNotification('Comment added successfully!', 'success');
        
      } catch (error) {
        console.error('Error adding comment:', error);
        showNotification('Error adding comment. Please try again.', 'error');
      }
    }

    // Filter functionality
    const activeFilters = {
      architecture: true,
      nature: true,
      events: true,
      people: true
    };

    function toggleFilter(category) {
      activeFilters[category] = !activeFilters[category];
      
      const filterCheckbox = document.getElementById(`${category}Filter`);
      if (filterCheckbox) {
        if (activeFilters[category]) {
          filterCheckbox.classList.remove('unchecked');
          filterCheckbox.textContent = '✓';
        } else {
          filterCheckbox.classList.add('unchecked');
          filterCheckbox.textContent = '';
        }
      }
      
      filterMarkers();
    }

    function filterMarkers() {
      if (markers) {
        markers.eachLayer(function(layer) {
          const markerData = layer.options.markerData;
          if (markerData && activeFilters[markerData.category]) {
            layer.setOpacity(1);
            layer.options.interactive = true;
          } else {
            layer.setOpacity(0.3);
            layer.options.interactive = false;
          }
        });
      }
    }

    // Utility functions
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 4000);
    }

    function shareOnSocial(platform) {
      const url = encodeURIComponent(window.location.href);
      const title = encodeURIComponent('Community Markers Map - Discover Minnesota History');
      
      let shareUrl;
      switch (platform) {
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
          break;
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
          break;
      }
      
      if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
      }
    }

    function copyShareLink() {
      const shareLink = document.getElementById('shareLink');
      if (shareLink) {
        shareLink.select();
        document.execCommand('copy');
        showNotification('Link copied to clipboard!', 'success');
      }
    }

    // Make functions globally available
    window.showMapPage = showMapPage;
    window.showSearchPage = showSearchPage;
    window.searchAndShowLocation = searchAndShowLocation;
    window.searchLocation = searchLocation;
    window.showAboutModal = showAboutModal;
    window.showHelpModal = showHelpModal;
    window.showShareModal = showShareModal;
    window.showImageInfoModal = showImageInfoModal;
    window.closeModal = closeModal;
    window.showMarkerDetails = showMarkerDetails;
    window.toggleAddComment = toggleAddComment;
    window.submitComment = submitComment;
    window.shareOnSocial = shareOnSocial;
    window.copyShareLink = copyShareLink;
    window.signInUser = signInUser;
    window.signOutUser = signOutUser;
    window.toggleFilter = toggleFilter;
  </script>
</body>
</html>
