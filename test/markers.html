<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Basic Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Discover and share meaningful places across Minnesota with Community Markers Map">
    
  <title>Community Markers Map</title>
  <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.Default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css" />
    
  <style>
    /* Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        overflow-x: hidden;
        color: #333;
        background-color: #f5f5f5;
        line-height: 1.6;
    }

    .leaflet-control-attribution {
        display: none;
    }

    a {
        text-decoration: none;
        color: #2563eb;
        transition: color 0.3s ease;
    }

    a:hover {
        color: #1d4ed8;
    }

    /* Typography */
    h1, h2, h3, h4, h5, h6 {
        color: #1e293b;
        margin-bottom: 0.5em;
        font-weight: 600;
    }

    p {
        margin-bottom: 1em;
    }

    .sun-editor,
    .sun-editor .se-wrapper .se-content,
    .sun-editor .se-toolbar,
    .sun-editor .se-selector,
    .sun-editor .se-dialog {
        font-size: 15px !important;
    }

    /* Force font size in the editor's dialog boxes */
    .sun-editor .se-dialog {
        font-size: 15px !important;
    }

    /* Page Layout */
    .page {
        width: 100%;
        min-height: 100vh;
        position: relative;
    }

    .search-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('https://www.mnthen.com/images/header/mn_history_header.jpg');
        background-size: cover;
        background-position: center;
        color: white;
        text-align: center;
    }

    .search-page h1, .search-page h2, .search-page h3, 
    .search-page h4, .search-page h5, .search-page h6 {
        color: #ffffff;
    }

    .map-page {
        display: none;
        position: relative;
        height: 100vh;
        width: 100%;
    }

    /* Map Container */
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }

    /* Hero Content */
    .hero-content {
        max-width: 800px;
        padding: 2rem;
        z-index: 2;
        animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .hero-content h1 {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .hero-content p {
        font-size: 1.3rem;
        margin-bottom: 2rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Custom styles for Suneditor */
    #description-editor {
        border: 1px solid #d1d5db;
        border-radius: 5px;
        margin-bottom: 1rem;
    }

    .sun-editor .se-toolbar {
        background-color: #f9fafb;
        border-bottom: 1px solid #d1d5db;
    }

    .sun-editor .se-wrapper {
        background-color: white;
    }

    /* Search Components */
    .search-container {
        width: 100%;
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    .search-bar {
        display: flex;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .search-bar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .search-input {
        flex: 1;
        padding: 1.2rem 1.5rem;
        border: none;
        font-size: 1.1rem;
        outline: none;
    }

    .search-button {
        padding: 1.2rem 2rem;
        background-color: #2563eb;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .search-button:hover {
        background-color: #1d4ed8;
    }

    .map-search-bar {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        width: 80%;
        max-width: 500px;
        z-index: 10;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        transition: box-shadow 0.3s ease;
    }

    .map-search-bar:hover {
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
    }

    .map-search-input {
        flex: 1;
        padding: 0.9rem 1.25rem;
        border: none;
        font-size: 1rem;
        outline: none;
    }

    .map-search-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border: none;
        background-color: #2563eb;
        border-radius: 0 50px 50px 0;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .map-search-button:hover {
        background-color: #1d4ed8;
    }

    .map-search-button i {
        color: white;
        font-size: 18px;
    }

    /* Category Selector */
    .category-selector {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        z-index: 10;
        padding: 12px 16px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease;
    }

    .category-badge {
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .category-badge.active {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .category-badge.inactive {
        opacity: 0.6;
        background-color: #94a3b8;
    }

    .category-badge.architecture {
        background-color: #2563eb;
    }

    .category-badge.nature {
        background-color: #10b981;
    }

    .category-badge.events {
        background-color: #f59e0b;
    }

    .category-badge.people {
        background-color: #8b5cf6;
    }

    .category-count {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    /* Category Legend */
    .category-legend {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10;
        max-width: 200px;
    }

    .legend-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: #1e293b;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.85rem;
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .legend-color.architecture {
        background-color: #2563eb;
    }

    .legend-color.nature {
        background-color: #10b981;
    }

    .legend-color.events {
        background-color: #f59e0b;
    }

    .legend-color.people {
        background-color: #8b5cf6;
    }

    /* Floating Menu */
    .floating-menu {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
    }

    .floating-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #2563eb;
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .floating-btn:hover {
        background-color: #1d4ed8;
        transform: scale(1.05);
    }

    .menu-content {
        display: none;
        position: absolute;
        top: 60px;
        left: 0;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        padding: 0.5rem;
        width: 220px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .menu-content a {
        display: block;
        padding: 0.85rem 1.2rem;
        color: #333;
        border-radius: 8px;
        transition: all 0.3s;
        font-weight: 500;
    }

    .menu-content a:hover {
        background-color: #f3f4f6;
        color: #2563eb;
        transform: translateX(5px);
    }

    /* Scroll Down Button */
    .scroll-down {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        cursor: pointer;
        animation: bounce 2s infinite;
    }

    .scroll-down span {
        margin-bottom: 0.5rem;
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0) translateX(-50%);
        }
        40% {
            transform: translateY(-10px) translateX(-50%);
        }
        60% {
            transform: translateY(-5px) translateX(-50%);
        }
    }

    /* Overlay */
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        backdrop-filter: blur(3px);
        transition: opacity 0.3s ease;
    }

    /* Modal Base */
    .modal-base {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        padding: 2.5rem;
        max-width: 90%;
        width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        z-index: 1100;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translate(-50%, -48%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .modal-base h2 {
        color: #1e3a8a;
        margin-bottom: 1.2rem;
        font-size: 1.8rem;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 0.8rem;
    }

    .modal-base p {
        color: #4b5563;
        margin-bottom: 1.2rem;
        line-height: 1.7;
    }

    .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #374151;
        background-color: #f3f4f6;
    }

    /* Auth Popup */
    .auth-popup {
        width: 420px;
    }

    .auth-tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .auth-tab {
        flex: 1;
        padding: 0.85rem;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s;
    }

    .auth-tab.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
    }

    .auth-form {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 500;
        font-size: 0.95rem;
        color: #4b5563;
    }

    .form-input {
        padding: 0.85rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .auth-button {
        padding: 0.9rem;
        background-color: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .auth-button:hover {
        background-color: #1d4ed8;
    }

    /* Marker Info Modal */
    #markerInfoModal {
        width: 900px;
        max-width: 95%;
        z-index: 1200; /* Ensure marker info appears above collection modals */
    }

    .marker-info-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .marker-info-content {
            flex-direction: row;
        }
    }

    /* Marker Image Container */
    .marker-image-container {
        position: relative;
        display: inline-block;
        margin-bottom: 25px;
        flex: 1;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: none; /* Removes the shadow */
        border: none; /* Ensures no border */
        /* If you want it white instead of transparent */
        background-color: white;
    }

    /* Marker Image */
    .marker-image {
        display: block;
        width: 100%;
        height: auto;
        transition: transform 0.5s ease;
        cursor: pointer;
    }

    .marker-image:hover {
        transform: scale(1.03);
    }

    /* Historical Source */
    .source-citation {
        background-color: #f8fafc;
        padding: 1.2rem;
        border-radius: 12px;
        margin-top: 1rem;
        font-size: 0.95rem;
        border: 1px solid #e2e8f0;
    }

    .source-citation h4 {
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        color: #1e3a8a;
    }
    
    /* Copyright options */
    .copyright-info {
        margin-top: 0.8rem;
        font-size: 0.9rem;
        color: #64748b;
        font-style: italic;
    }

    .marker-details {
        flex: 1.5;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    .marker-title {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        color: #1e3a8a;
    }

    .upload-info {
        font-size: 0.95rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .upload-info i {
        color: #2563eb;
    }

    .category-tags {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
    }

    .category-tag {
        padding: 0.35rem 0.9rem;
        border-radius: 50px;
        font-size: 0.85rem;
        color: white;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .category-tag.architecture {
        background-color: #2563eb;
    }

    .category-tag.nature {
        background-color: #10b981;
    }

    .category-tag.events {
        background-color: #f59e0b;
    }

    .category-tag.people {
        background-color: #8b5cf6;
    }

    .description {
        line-height: 1.7;
        color: #4b5563;
    }

    .marker-stats {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.8rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b;
        font-size: 0.95rem;
    }

    .interaction-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .btn {
        padding: 0.7rem 1.2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background-color: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background-color: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary {
        background-color: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
        background-color: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background-color: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .report-button {
        background-color: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        padding: 0.5rem 0.8rem;
        border-radius: 6px;
    }

    .report-button:hover {
        color: #dc2626;
        background-color: rgba(239, 68, 68, 0.05);
    }

    .share-buttons {
        display: flex;
        gap: 0.8rem;
        margin-top: 1.2rem;
    }

    .share-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .share-button:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
    }

    .share-button.facebook {
        background-color: #1877f2;
    }

    .share-button.twitter {
        background-color: #1da1f2;
    }

    .share-button.linkedin {
        background-color: #0a66c2;
    }

    /* Comments Section */
    .comments-section {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .comments-section h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
    }

    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        margin-bottom: 1.8rem;
    }

    .comment {
        background-color: #f8fafc;
        padding: 1.2rem;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
    }

    .comment:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.8rem;
    }

    .comment-author {
        font-weight: 600;
        color: #1e3a8a;
    }

    .comment-date {
        font-size: 0.85rem;
        color: #64748b;
    }

    .comment-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #4b5563;
    }

    .comment-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .comment-form textarea {
        resize: vertical;
        min-height: 100px;
        border-radius: 8px;
        padding: 1rem;
        font-family: inherit;
        font-size: 0.95rem;
    }

    /* Collections Grid */
    .collections-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.8rem;
        margin: 1.8rem 0;
    }

    .collection-card {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        background-color: white;
        position: relative;
        border: 1px solid #e2e8f0;
    }

    .collection-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .collection-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .collection-card:hover .collection-image {
        transform: scale(1.05);
    }

    .collection-info {
        padding: 1.5rem;
    }

    .collection-title {
        margin-bottom: 0.8rem;
        font-size: 1.2rem;
        color: #1e3a8a;
    }

    .collection-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 1.2rem;
        font-size: 0.85rem;
        color: #64748b;
    }

    .collection-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 0.6rem;
    }

    .collection-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9rem;
        color: #475569;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .collection-action-btn:hover {
        background-color: white;
        color: #2563eb;
        transform: scale(1.1);
    }

    /* Collection Markers Modal */
    .collection-markers-modal {
        width: 800px;
        max-width: 95%;
    }

    .collection-markers-list {
        margin-top: 1.8rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.2rem;
    }

    .collection-marker-item {
        background-color: #f8fafc;
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        position: relative;
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
    }

    .collection-marker-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
    }

    .collection-marker-title {
        font-weight: 600;
        margin-bottom: 0.8rem;
        color: #1e3a8a;
    }

    .collection-marker-category {
        display: inline-block;
        padding: 0.25rem 0.7rem;
        border-radius: 50px;
        font-size: 0.75rem;
        color: white;
        margin-bottom: 0.8rem;
        font-weight: 600;
    }

    .collection-marker-category.architecture {
        background-color: #2563eb;
    }

    .collection-marker-category.nature {
        background-color: #10b981;
    }

    .collection-marker-category.events {
        background-color: #f59e0b;
    }

    .collection-marker-category.people {
        background-color: #8b5cf6;
    }

    .remove-from-collection {
        position: absolute;
        top: 0.8rem;
        right: 0.8rem;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: rgba(239, 68, 68, 0.1);
        border: none;
        color: #ef4444;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background-color 0.2s;
        z-index: 5;
    }

    .remove-from-collection:hover {
        background-color: rgba(239, 68, 68, 0.2);
    }

    /* Notification */
    .notification {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        max-width: 350px;
    }

    .notification.info {
        background-color: #3b82f6;
        border-left: 5px solid #2563eb;
    }

    .notification.success {
        background-color: #10b981;
        border-left: 5px solid #059669;
    }

    .notification.error {
        background-color: #ef4444;
        border-left: 5px solid #dc2626;
    }

    .notification.warning {
        background-color: #f59e0b;
        border-left: 5px solid #d97706;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Expanded Image Modal */
    .expanded-image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .expanded-image {
        max-width: 90%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        animation: zoomIn 0.3s ease-out;
    }

    @keyframes zoomIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .expanded-image-title {
        color: white;
        font-size: 1.3rem;
        margin-top: 1.5rem;
        text-align: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Added close button for expanded image modal */
    .expanded-image-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 2001;
    }

    .expanded-image-close:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    /* Info Button */
    .info-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(200, 200, 200, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        transition: all 0.3s;
        opacity: 0.8;
    }

    .info-button:hover {
        background-color: rgba(255, 255, 255, 0.9);
        opacity: 1;
        transform: scale(1.1);
    }

    .info-button i {
        color: #1e3a8a;
        font-size: 18px;
    }

    /* Recenter Button */
    .recenter-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #2563eb;
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .recenter-button:hover {
        background-color: #1d4ed8;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
    }

    /* Leaderboard styling */
    .leaderboard {
        margin-top: 1.5rem;
    }

    .leaderboard-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 1.2rem;
        text-align: center;
        padding-bottom: 0.8rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 0.8rem;
        background-color: #f8fafc;
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
    }

    .leaderboard-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .leaderboard-rank {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2563eb;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e0e7ff;
        border-radius: 50%;
        margin-right: 1rem;
    }

    .leaderboard-user {
        flex: 1;
        font-weight: 600;
        color: #1e293b;
    }

    .leaderboard-points {
        font-weight: 600;
        color: #10b981;
        background-color: #ecfdf5;
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
    }

    /* Copyright options */
    .copyright-options {
        margin-top: 15px;
    }
    
    .copyright-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
    }
    
    .copyright-option input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .copyright-option label {
        cursor: pointer;
        font-size: 0.95rem;
        color: #4b5563;
    }

    /* Return link */
    .return-link {
        display: inline-block;
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 0.7rem 1.5rem;
        border-radius: 50px;
        font-weight: 500;
        transition: all 0.3s;
        margin-top: 1rem;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .return-link:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        color: white;
    }

    /* Collection Features Improvements */
    .collection-features {
        margin-top: 1.5rem;
        padding: 1.2rem;
        background-color: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .collection-features-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e3a8a;
        margin-bottom: 1rem;
    }

    .collection-features-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .collection-feature {
        flex: 1;
        min-width: 200px;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
    }

    .collection-feature:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .collection-feature-icon {
        font-size: 1.5rem;
        color: #2563eb;
        margin-bottom: 0.5rem;
    }

    .collection-feature-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1e293b;
    }

    /* New styles for collaborative history features */
    .history-timeline {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .history-timeline h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
    }

    .timeline-container {
        position: relative;
        max-width: 100%;
        margin: 0 auto;
    }

    .timeline-container::after {
        content: '';
        position: absolute;
        width: 2px;
        background-color: #e2e8f0;
        top: 0;
        bottom: 0;
        left: 50%;
        margin-left: -1px;
    }

    .timeline-item {
        padding: 10px 40px;
        position: relative;
        background-color: inherit;
        width: 50%;
    }

    .timeline-item::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        background-color: white;
        border: 3px solid #2563eb;
        border-radius: 50%;
        top: 15px;
        z-index: 1;
    }

    .left {
        left: 0;
    }

    .right {
        left: 50%;
    }

    .left::after {
        right: -8px;
    }

    .right::after {
        left: -8px;
    }

    .timeline-content {
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .timeline-date {
        font-weight: 600;
        color: #2563eb;
        margin-bottom: 0.5rem;
    }

    .timeline-user {
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .timeline-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #4b5563;
    }

    .source-verification {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .source-verification h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
    }

    .verification-status {
        display: inline-block;
        padding: 0.25rem 0.7rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .verification-status.pending {
        background-color: #f59e0b;
        color: white;
    }

    .verification-status.verified {
        background-color: #10b981;
        color: white;
    }

    .verification-status.rejected {
        background-color: #ef4444;
        color: white;
    }

    .source-documents {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .source-document {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        border: 1px solid #e2e8f0;
    }

    .source-document img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .source-document-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 0.5rem;
        font-size: 0.7rem;
        text-align: center;
    }

    .citation-list {
        margin-top: 1rem;
    }

    .citation-item {
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.8rem;
        border: 1px solid #e2e8f0;
    }

    .citation-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1e3a8a;
    }

    .citation-details {
        font-size: 0.85rem;
        color: #64748b;
    }

    .peer-review-section {
        margin-top: 2rem;
        border-top: 1px solid #e5e7eb;
        padding-top: 1.5rem;
    }

    .peer-review-section h3 {
        margin-bottom: 1.2rem;
        font-size: 1.3rem;
        color: #1e3a8a;
    }

    .review-item {
        background-color: #f8fafc;
        padding: 1.2rem;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.8rem;
    }

    .review-author {
        font-weight: 600;
        color: #1e3a8a;
    }

    .review-date {
        font-size: 0.85rem;
        color: #64748b;
    }

    .review-text {
        font-size: 0.95rem;
        line-height: 1.6;
        color: #4b5563;
    }

    .review-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.8rem;
    }

    .review-action-btn {
        padding: 0.3rem 0.8rem;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        border: none;
    }

    .review-action-btn.approve {
        background-color: #10b981;
        color: white;
    }

    .review-action-btn.reject {
        background-color: #ef4444;
        color: white;
    }

    .review-action-btn.neutral {
        background-color: #e2e8f0;
        color: #475569;
    }

    /* Dropzone styles */
    .dropzone {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .dropzone:hover {
        border-color: #2563eb;
        background-color: rgba(37, 99, 235, 0.05);
    }

    .dropzone .dz-message {
        margin: 0;
        font-size: 1rem;
        color: #64748b;
    }

    .dropzone .dz-preview {
        margin: 10px;
    }

    .dropzone .dz-preview .dz-image {
        border-radius: 8px;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .hero-content h1 {
            font-size: 2.5rem;
        }

        .search-bar {
            flex-direction: column;
            border-radius: 12px;
        }

        .search-input, .search-button {
            width: 100%;
            border-radius: 0;
        }

        .search-input {
            border-radius: 12px 12px 0 0;
        }

        .search-button {
            border-radius: 0 0 12px 12px;
        }

        .map-search-bar {
            width: 90%;
        }

        #markerInfoModal {
            width: 95%;
            max-height: 85vh;
        }

        .marker-info-content {
            flex-direction: column;
        }

        .marker-image {
            max-height: 250px;
            object-fit: cover;
        }

        .category-selector {
            padding: 10px;
            width: 90%;
        }

        .category-badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .collection-markers-list {
            grid-template-columns: 1fr;
        }

        .category-legend {
            top: auto;
            bottom: 80px;
            right: 20px;
        }

        /* Timeline adjustments for mobile */
        .timeline-container::after {
            left: 31px;
        }

        .timeline-item {
            width: 100%;
            padding-left: 70px;
            padding-right: 25px;
        }

        .timeline-item::after {
            left: 23px;
        }

        .left::after, .right::after {
            left: 23px;
        }

        .left, .right {
            left: 0;
        }
    }
  </style>
</head>
<body>
    <div class="floating-menu" id="floatingMenu">
        <button class="floating-btn" id="floatingBtn" aria-label="Open Menu">â˜°</button>
        <div class="menu-content" id="menuContent">
            <a href="#" id="homeLink">Home</a>
            <a href="#" id="aboutLink">About Us</a>
            <a href="#" id="instructionsLink">Instructions</a>
            <a href="#" id="loginLink">Login/Join</a>
            <a href="#" id="collectionsLink">Collections</a>
            <a href="#" id="leaderboardLink">Leaderboard</a>
            <a href="#" id="historyLink">History</a>
        </div>
    </div>

    <div class="page search-page" id="searchPage">
        <div class="hero-content">
            <h1>Community Markers</h1>
            <p>Discover and share meaningful places across Minnesota.</p>
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput" aria-label="Search for a location">
                    <button class="search-button" id="searchButton">Search</button>
                </div>
            </div>
            <a href="https://www.mnthen.com" class="return-link">Return to Minnesota Then</a>
        </div>
        <div class="scroll-down" id="scrollDown">
            <span>View Map</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
            </svg>
        </div>
        <button class="info-button" id="infoButton" aria-label="Information"><i class="fas fa-info"></i></button>
    </div>

    <div class="page map-page" id="mapPage">
        <div class="map-search-bar">
            <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput" aria-label="Search for a location in Minnesota">
            <button class="map-search-button" id="mapSearchButton" aria-label="Search">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <div id="map"></div>
        <div class="category-selector" id="categorySelector">
            <span class="category-badge architecture active" data-category="architecture">
                Architecture
                <span class="category-count" id="architectureCount">0</span>
            </span>
            <span class="category-badge nature active" data-category="nature">
                Nature
                <span class="category-count" id="natureCount">0</span>
            </span>
            <span class="category-badge events active" data-category="events">
                Events
                <span class="category-count" id="eventsCount">0</span>
            </span>
            <span class="category-badge people active" data-category="people">
                People
                <span class="category-count" id="peopleCount">0</span>
            </span>
        </div>
        <button class="recenter-button" id="recenterButton" aria-label="Recenter Map"><i class="fas fa-crosshairs"></i></button>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="notification" class="notification" role="alert"></div>

    <div id="authPopup" class="modal-base auth-popup" role="dialog" aria-labelledby="authTitle">
        <button id="closePopup" class="close-btn" aria-label="Close">&times;</button>
        <div class="auth-container">
            <div class="auth-tabs" role="tablist">
                <button id="showLogin" class="auth-tab active" role="tab" aria-selected="true" aria-controls="loginForm">Login</button>
                <button id="showJoin" class="auth-tab" role="tab" aria-selected="false" aria-controls="joinForm">Join</button>
            </div>
            <form id="loginForm" class="auth-form" role="tabpanel">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required aria-required="true">
                </div>
                <button type="submit" id="loginButton" class="auth-button">Login</button>
            </form>
            <form id="joinForm" class="auth-form" style="display: none;" role="tabpanel">
                <div class="form-group">
                    <label for="joinEmail">Email</label>
                    <input type="email" id="joinEmail" placeholder="Enter your email" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinPassword">Password</label>
                    <input type="password" id="joinPassword" placeholder="Create a password" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinFirstName">First Name</label>
                    <input type="text" id="joinFirstName" placeholder="Enter your first name" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinLastName">Last Name</label>
                    <input type="text" id="joinLastName" placeholder="Enter your last name" required aria-required="true">
                </div>
                <div class="form-group">
                    <label for="joinCity">City</label>
                    <input type="text" id="joinCity" placeholder="Enter your city" required aria-required="true">
                </div>
                <button type="submit" id="joinButton" class="auth-button">Join</button>
            </form>
        </div>
    </div>

    <div id="aboutPopup" class="modal-base" role="dialog" aria-labelledby="aboutTitle">
        <button id="closeAbout" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="aboutTitle">About Us</h2>
        <p>
            Community Markers is a platform that allows users to discover and share meaningful places across Minnesota. Our mission is to create a digital map that showcases the rich history, culture, and natural beauty of our state through the eyes of its residents and visitors.
        </p>
        <p>
            By creating and exploring markers on our interactive map, you can share your favorite locations, hidden gems, and historical sites with others. Whether it's a scenic overlook, a local restaurant, or a significant landmark, Community Markers helps preserve and celebrate the diverse experiences that make Minnesota unique.
        </p>
        <p>
            Join our growing community of explorers and storytellers as we map out the best of Minnesota, one marker at a time!
        </p>
    </div>

    <div id="instructionsPopup" class="modal-base" role="dialog" aria-labelledby="instructionsTitle">
        <button id="closeInstructions" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="instructionsTitle">Instructions</h2>
        <ol>
            <li>To add a marker, click on the map at the desired location.</li>
            <li>Fill in the marker details, including title, description, and an optional image.</li>
            <li>Click "Submit for Review" to save your marker to the map.</li>
            <li>To view marker details, click on any marker on the map.</li>
            <li>Use the search bar to find specific locations in Minnesota.</li>
            <li>Explore the map to discover markers added by other community members.</li>
            <li>Login or create an account to add your own markers and interact with the community.</li>
            <li>Create collections to organize markers by theme or location.</li>
        </ol>
        <p>Remember to respect others and follow community guidelines when adding markers. Enjoy exploring Minnesota!</p>
    </div>

    <div id="logoutPopup" class="modal-base auth-popup" role="dialog">
        <button id="cancelLogout" class="close-btn" aria-label="Close">&times;</button>
        <p>Are you sure you want to log out?</p>
        <button id="confirmLogout" class="auth-button">Log Out</button>
    </div>

    <div id="markerModal" class="modal-base" role="dialog" aria-labelledby="addMarkerTitle">
        <button id="closeModal" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="addMarkerTitle">Add New Marker</h2>
        <form id="markerForm">
            <div class="form-group">
                <label for="title" class="form-label">Title (max 50 characters)</label>
                <input type="text" id="title" class="form-input" maxlength="50" required aria-required="true">
            </div>
            <div class="form-group">
                <label for="category" class="form-label">Category</label>
                <select id="category" class="form-input" required aria-required="true">
                    <option value="">Select a category</option>
                    <option value="architecture">Architecture</option>
                    <option value="nature">Nature</option>
                    <option value="events">Events</option>
                    <option value="people">People</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description-editor" class="form-label">Description</label>
                <textarea id="description-editor"></textarea>
            </div>
            <div class="form-group">
                <label for="imageUpload" class="form-label">Image</label>
                <input type="file" id="imageUpload" accept="image/*" aria-label="Upload Image">
            </div>
            <div class="form-group">
                <label for="date" class="form-label">Date</label>
                <input type="date" id="date" class="form-input" required aria-required="true">
            </div>
            <div class="form-group">
                <label class="form-label">Copyright Information</label>
                <div class="copyright-options">
                    <div class="copyright-option">
                        <input type="checkbox" id="creativeCommons" name="copyright" value="creativeCommons">
                        <label for="creativeCommons">Creative Commons BY-NC 4.0.</label>
                    </div>
                    <div class="copyright-option">
                        <input type="checkbox" id="authorOwned" name="copyright" value="authorOwned">
                        <label for="authorOwned">Author Owned</label>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Submit for Review</button>
        </form>
    </div>

    <div id="markerInfoModal" class="modal-base" style="display: none;" role="dialog" aria-labelledby="markerInfoTitle">
        <button id="closeMarkerInfo" class="close-btn" aria-label="Close">&times;</button>
        <div class="marker-info-content">
            <div class="marker-image-container">
                <img id="markerInfoImage" src=" " alt="" class="marker-image">
            </div>
            
            <div class="marker-details">
                <h3 id="markerInfoTitle" class="marker-title"></h3>
                <p class="upload-info" id="markerInfoUploader"></p>
                <div class="category-tags" id="markerInfoCategories"></div>
                <p class="description" id="markerInfoDescription"></p>
                <div class="source-citation">
                    <h4>Copyright Information</h4>
                    <div class="copyright-info" id="markerInfoCopyright"></div>
                </div>
                <div class="marker-stats">
                    <span id="markerInfoViews" class="stat-item">
                        <i class="fas fa-eye"></i>
                        <span>0 views</span>
                    </span>
                    <span id="markerInfoLikes" class="stat-item">
                        <i class="fas fa-heart"></i>
                        <span>0 likes</span>
                    </span>
                </div>
                <div class="interaction-buttons" id="interactionButtons">
                    <button id="likeButton" class="btn btn-primary">
                        <i class="fas fa-heart"></i> Like
                    </button>
                    <button id="addToCollectionButton" class="btn btn-secondary">
                        <i class="fas fa-folder-plus"></i> Add to Collection
                    </button>
                    <button id="reportButton" class="report-button">
                        <i class="fas fa-flag"></i> Report
                    </button>
                </div>
                <div class="share-buttons">
                    <button class="share-button facebook" aria-label="Share on Facebook">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="share-button twitter" aria-label="Share on Twitter">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="share-button linkedin" aria-label="Share on LinkedIn">
                        <i class="fab fa-linkedin-in"></i>
                    </button>
                </div>
                <div class="comments-section">
                    <h3>Comments</h3>
                    <div class="comments-list" id="commentsList"></div>
                    <form class="comment-form" id="commentForm">
                        <textarea class="form-input" placeholder="Add a comment..." required aria-label="Add a comment"></textarea>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="expandedImageModal" class="expanded-image-modal" role="dialog" aria-labelledby="expandedImageTitle">
        <button id="closeExpandedImage" class="expanded-image-close" aria-label="Close">&times;</button>
        <img id="expandedImage" class="expanded-image" src="/placeholder.svg" alt="Expanded marker image">
        <h3 id="expandedImageTitle" class="expanded-image-title"></h3>
    </div>

    <div id="collectionsModal" class="modal-base" role="dialog" aria-labelledby="collectionsTitle">
        <button id="closeCollections" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="collectionsTitle">Your Collections</h2>
        <p>Create themed collections to organize and share your favorite Minnesota locations.</p>
        
        <div class="collection-features">
            <h3 class="collection-features-title">Collection Features</h3>
            <div class="collection-features-list">
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <h4 class="collection-feature-title">Themed Tours</h4>
                    <p>Create collections for specific themes like "Historic Buildings" or "Scenic Lakes"</p>
                </div>
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-share-alt"></i></div>
                    <h4 class="collection-feature-title">Share with Friends</h4>
                    <p>Share your collections with friends and family planning to visit Minnesota</p>
                </div>
                <div class="collection-feature">
                    <div class="collection-feature-icon"><i class="fas fa-route"></i></div>
                    <h4 class="collection-feature-title">Plan Trips</h4>
                    <p>Use collections to plan your next Minnesota road trip or adventure</p>
                </div>
            </div>
        </div>
        
        <div class="collections-grid" id="collectionsGrid"></div>
        <button id="createCollectionBtn" class="btn btn-primary">Create New Collection</button>
    </div>

    <div id="collectionMarkersModal" class="modal-base collection-markers-modal" role="dialog" aria-labelledby="collectionMarkersTitle">
        <button id="closeCollectionMarkers" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="collectionMarkersTitle">Collection Markers</h2>
        <p id="collectionMarkersDescription">View and manage markers in this collection.</p>
        <div class="collection-markers-list" id="collectionMarkersList"></div>
    </div>

    <div id="leaderboardModal" class="modal-base" role="dialog" aria-labelledby="leaderboardTitle">
        <button id="closeLeaderboard" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="leaderboardTitle">Community Leaderboard</h2>
        <div class="leaderboard" id="leaderboardList"></div>
    </div>

    <div id="reportModal" class="modal-base" role="dialog" aria-labelledby="reportTitle">
        <button id="closeReport" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="reportTitle">Report Inappropriate Content</h2>
        <form id="reportForm">
            <div class="form-group">
                <label class="form-label" for="reportReason">Reason for Report</label>
                <select id="reportReason" class="form-input" required aria-required="true">
                    <option value="">Select a reason</option>
                    <option value="inappropriate">Inappropriate Content</option>
                    <option value="spam">Spam</option>
                    <option value="offensive">Offensive Language</option>
                    <option value="inaccurate">Inaccurate Information</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="reportDetails">Additional Details</label>
                <textarea id="reportDetails" class="form-input" rows="4" required aria-required="true"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Report</button>
        </form>
    </div>

    <div id="citationModal" class="modal-base" role="dialog" aria-labelledby="citationTitle">
        <button id="closeCitation" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="citationTitle">Image Citation</h2>
        <p>Image source: <a href="https://collection.mndigital.org/catalog/p16022coll55:121" target="_blank" rel="noopener noreferrer">MN Digital Library</a></p>
        <p>Photographer: Minneapolis Park & Recreation Board</p>
        <p>Description: Convention American Association of Park Superintendents, Minneapolis, August 11-13, 1908, at the foot of Minnehaha Falls, Minneapolis, Minnesota. (August 11-13, 1908)</p>
    </div>

    <!-- New Modals for Collaborative History Features -->
    <div id="historyModal" class="modal-base" role="dialog" aria-labelledby="historyTitle">
        <button id="closeHistory" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="historyTitle">Marker History</h2>
        <div class="history-timeline" id="historyTimeline">
            <h3>Edit History</h3>
            <div class="timeline-container" id="timelineContainer"></div>
        </div>
        <div class="source-verification" id="sourceVerification">
            <h3>Source Verification</h3>
            <div class="verification-status pending">Pending Verification</div>
            <div class="source-documents" id="sourceDocuments"></div>
            <div class="citation-list" id="citationList"></div>
        </div>
        <div class="peer-review-section" id="peerReviewSection">
            <h3>Peer Reviews</h3>
            <div id="reviewsList"></div>
            <form id="reviewForm" class="comment-form">
                <textarea class="form-input" placeholder="Add your review..." required aria-label="Add your review"></textarea>
                <div class="review-actions">
                    <button type="button" class="review-action-btn approve" id="approveReview">Approve</button>
                    <button type="button" class="review-action-btn neutral" id="neutralReview">Neutral</button>
                    <button type="button" class="review-action-btn reject" id="rejectReview">Reject</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sourceUploadModal" class="modal-base" role="dialog" aria-labelledby="sourceUploadTitle">
        <button id="closeSourceUpload" class="close-btn" aria-label="Close">&times;</button>
        <h2 id="sourceUploadTitle">Upload Source Documents</h2>
        <form id="sourceUploadForm">
            <div class="form-group">
                <label class="form-label">Source Documents</label>
                <div class="dropzone" id="documentDropzone">
                    <div class="dz-message">Drop files here or click to upload</div>
                </div>
            </div>
            <div class="form-group">
                <label for="sourceTitle" class="form-label">Source Title</label>
                <input type="text" id="sourceTitle" class="form-input" required aria-required="true">
            </div>
            <div class="form-group">
                <label for="sourceAuthor" class="form-label">Author/Creator</label>
                <input type="text" id="sourceAuthor" class="form-input" required aria-required="true">
            </div>
            <div class="form-group">
                <label for="sourceDate" class="form-label">Publication Date</label>
                <input type="date" id="sourceDate" class="form-input" required aria-required="true">
            </div>
            <div class="form-group">
                <label for="sourceUrl" class="form-label">Source URL (if applicable)</label>
                <input type="url" id="sourceUrl" class="form-input">
            </div>
            <button type="submit" class="btn btn-primary">Submit Sources</button>
        </form>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/js/suneditor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>

    <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
      authDomain: "mnthen-3151d.firebaseapp.com",
      projectId: "mnthen-3151d",
      storageBucket: "mnthen-3151d.appspot.com",
      messagingSenderId: "416231360428",
      appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
    };

    // Initialize Firebase
    let firebaseApp;
    if (!firebase.apps.length) {
      firebaseApp = firebase.initializeApp(firebaseConfig);
    } else {
      firebaseApp = firebase.app();
    }

    const auth = firebaseApp.auth();
    const database = firebaseApp.database();
    const storage = firebaseApp.storage();

    // Map Variables
    let map = null;
    let markers = null;
    let tempMarker = null;

    // Global Variables
    let currentUser = null;
    let currentMarkerId = null;
    let selectedCategories = new Set(['architecture', 'nature', 'events', 'people']);
    let currentCollectionId = null;
    let categoryCounts = {
      architecture: 0,
      nature: 0,
      events: 0,
      people: 0
    };
    
    // Store original marker data by category
    let markersByCategory = {
      architecture: [],
      nature: [],
      events: [],
      people: []
    };

    const profanityList = [
      // Sexual references
      "ass", "asshole", "bastard", "bitch", "cock", "cunt", "dick", "pussy", 
      "slut", "whore", "prick", "twat", 

      // Vulgar language
      "fuck", "fucking", "shit", "shitty", "crap", "piss", "damn", "hell", 
      "dammit", "bullshit", "motherfucker", "fuckwit", 

      // Derogatory terms
      "jag", "dipshit", "douchebag", "douche", "asshat", "jackass", 
      "nimrod", "moron", "imbecile", "idiot", 

      // Offensive slurs (generic, removed specific group-based slurs)
      "retard", "tard", "dumb", 

      // Crude anatomical references
      "tits", "boobs", "balls", "screw", 

      // Political/controversial additions
      "Trump", "Wisconsin",

      // Variations and common misspellings
      "fk", "fck", "sh1t", "f u c k", "b i t c h",
    ];

    function containsProfanity(text) {
      if (!text) return false;
      
      // Normalize text thoroughly
      const normalizedText = text.toLowerCase().replace(/[^a-z0-9]/g, '');
      
      // Check for full word matches and subword matches
      return profanityList.some(profanity => {
        // Exact word match
        const wordRegex = new RegExp(`\\b${profanity}\\b`, 'i');
        
        // Substring match to catch variations
        const substringMatch = normalizedText.includes(profanity);
        
        return wordRegex.test(text) || substringMatch;
      });
    }

    // Points System Configuration
    const POINTS = {
      ADD_MARKER: 10,
      RECEIVE_LIKE: 5,
      ADD_COMMENT: 2,
      MARKER_VIEW: 1,
      ADD_SOURCE: 3,
      APPROVE_REVIEW: 2,
      COMPLETE_REVIEW: 5
    };

    // Badge System Configuration
    const BADGES = {
      NEWCOMER: { name: "Newcomer", icon: "star", requirement: 1 },
      CONTRIBUTOR: { name: "Active Contributor", icon: "pen", requirement: 5 },
      HISTORIAN: { name: "Local Historian", icon: "book", requirement: 10 },
      PHOTOGRAPHER: { name: "Photography Expert", icon: "camera", requirement: 15 },
      EXPLORER: { name: "Minnesota Explorer", icon: "compass", requirement: 20 },
      VERIFIER: { name: "Source Verifier", icon: "check-circle", requirement: 25 },
      REVIEWER: { name: "Community Reviewer", icon: "clipboard-check", requirement: 30 }
    };

    // DOM Elements
    const floatingBtn = document.getElementById("floatingBtn");
    const menuContent = document.getElementById("menuContent");
    const loginLink = document.getElementById("loginLink");
    const authPopup = document.getElementById("authPopup");
    const closePopup = document.getElementById("closePopup");
    const joinForm = document.getElementById("joinForm");
    const loginForm = document.getElementById("loginForm");
    const showLogin = document.getElementById("showLogin");
    const showJoin = document.getElementById("showJoin");
    const joinButton = document.getElementById("joinButton");
    const loginButton = document.getElementById("loginButton");
    const notification = document.getElementById("notification");
    const searchPage = document.getElementById("searchPage");
    const mapPage = document.getElementById("mapPage");
    const scrollDown = document.getElementById("scrollDown");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const mapSearchInput = document.getElementById("mapSearchInput");
    const mapSearchButton = document.getElementById("mapSearchButton");
    const markerModal = document.getElementById("markerModal");
    const closeModal = document.getElementById("closeModal");
    const markerForm = document.getElementById("markerForm");
    const titleInput = document.getElementById("title");
    const categoryInput = document.getElementById("category");
    const imageUpload = document.getElementById("imageUpload");
    const dateInput = document.getElementById("date");
    const creativeCommonsCheckbox = document.getElementById("creativeCommons");
    const authorOwnedCheckbox = document.getElementById("authorOwned");
    const aboutLink = document.getElementById("aboutLink");
    const aboutPopup = document.getElementById("aboutPopup");
    const overlay = document.getElementById("overlay");
    const closeAbout = document.getElementById("closeAbout");
    const logoutPopup = document.getElementById("logoutPopup");
    const confirmLogout = document.getElementById("confirmLogout");
    const cancelLogout = document.getElementById("cancelLogout");
    const instructionsLink = document.getElementById("instructionsLink");
    const instructionsPopup = document.getElementById("instructionsPopup");
    const closeInstructions = document.getElementById("closeInstructions");
    const markerInfoModal = document.getElementById("markerInfoModal");
    const closeMarkerInfo = document.getElementById("closeMarkerInfo");
    const markerInfoImage = document.getElementById("markerInfoImage");
    const markerInfoTitle = document.getElementById("markerInfoTitle");
    const markerInfoDescription = document.getElementById("markerInfoDescription");
    const markerInfoCategories = document.getElementById("markerInfoCategories");
    const markerInfoCopyright = document.getElementById("markerInfoCopyright");
    const markerInfoViews = document.getElementById("markerInfoViews");
    const markerInfoUploader = document.getElementById("markerInfoUploader");
    const markerInfoLikes = document.getElementById("markerInfoLikes");
    const likeButton = document.getElementById("likeButton");
    const addToCollectionButton = document.getElementById("addToCollectionButton");
    const reportButton = document.getElementById("reportButton");
    const interactionButtons = document.getElementById("interactionButtons");
    const commentsList = document.getElementById("commentsList");
    const commentForm = document.getElementById("commentForm");
    const expandedImageModal = document.getElementById("expandedImageModal");
    const expandedImage = document.getElementById("expandedImage");
    const expandedImageTitle = document.getElementById("expandedImageTitle");
    const closeExpandedImage = document.getElementById("closeExpandedImage");
    const collectionsLink = document.getElementById("collectionsLink");
    const collectionsModal = document.getElementById("collectionsModal");
    const closeCollections = document.getElementById("closeCollections");
    const collectionMarkersModal = document.getElementById("collectionMarkersModal");
    const closeCollectionMarkers = document.getElementById("closeCollectionMarkers");
    const collectionMarkersTitle = document.getElementById("collectionMarkersTitle");
    const collectionMarkersDescription = document.getElementById("collectionMarkersDescription");
    const collectionMarkersList = document.getElementById("collectionMarkersList");
    const leaderboardLink = document.getElementById("leaderboardLink");
    const leaderboardModal = document.getElementById("leaderboardModal");
    const closeLeaderboard = document.getElementById("closeLeaderboard");
    const reportModal = document.getElementById("reportModal");
    const closeReport = document.getElementById("closeReport");
    const homeLink = document.getElementById("homeLink");
    const categoryBadges = document.querySelectorAll(".category-badge");
    const infoButton = document.getElementById("infoButton");
    const citationModal = document.getElementById("citationModal");
    const closeCitation = document.getElementById("closeCitation");
    const recenterButton = document.getElementById("recenterButton");
    const architectureCount = document.getElementById("architectureCount");
    const natureCount = document.getElementById("natureCount");
    const eventsCount = document.getElementById("eventsCount");
    const peopleCount = document.getElementById("peopleCount");
    const historyLink = document.getElementById("historyLink");
    const historyModal = document.getElementById("historyModal");
    const closeHistory = document.getElementById("closeHistory");
    const timelineContainer = document.getElementById("timelineContainer");
    const sourceVerification = document.getElementById("sourceVerification");
    const sourceDocuments = document.getElementById("sourceDocuments");
    const citationList = document.getElementById("citationList");
    const peerReviewSection = document.getElementById("peerReviewSection");
    const reviewsList = document.getElementById("reviewsList");
    const reviewForm = document.getElementById("reviewForm");
    const approveReview = document.getElementById("approveReview");
    const neutralReview = document.getElementById("neutralReview");
    const rejectReview = document.getElementById("rejectReview");
    const sourceUploadModal = document.getElementById("sourceUploadModal");
    const closeSourceUpload = document.getElementById("closeSourceUpload");
    const sourceUploadForm = document.getElementById("sourceUploadForm");
    const documentDropzone = document.getElementById("documentDropzone");

    // Initialize Suneditor
    const editor = SUNEDITOR.create('description-editor', {
      height: '300px', // Set the height of the editor
      fontSizeUnit: 'px', // Use pixels for font size
      defaultStyle: 'font-size: 15px;', // Set default font size
        
      buttonList: [
        ['undo', 'redo'],
        ['font', 'fontSize', 'formatBlock'],
        ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
        ['fontColor', 'hiliteColor'],
        ['align', 'list'],
        ['link', 'image'],
        ['fullScreen', 'showBlocks', 'codeView'],
      ],
    });

    // Initialize Dropzone for source document uploads
    Dropzone.autoDiscover = false;
    let myDropzone;
    if (documentDropzone) {
        myDropzone = new Dropzone(documentDropzone, {
            url: "/fake-url", // We'll handle the upload manually
            autoProcessQueue: false,
            maxFiles: 5,
            maxFilesize: 5, // MB
            acceptedFiles: 'image/*,.pdf,.doc,.docx',
            addRemoveLinks: true,
            dictDefaultMessage: "Drop files here or click to upload",
            dictRemoveFile: "Remove file",
            dictFileTooBig: "File is too big ({{filesize}}MB). Max filesize: {{maxFilesize}}MB.",
            dictInvalidFileType: "You can't upload files of this type."
        });
    }

    // Initialize Map Function
    function initializeMap() {
      if (!map && document.getElementById("map")) {
        map = L.map("map", {
          zoomControl: false,
          attributionControl: true
        }).setView([44.9778, -93.265], 10);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '',
          maxZoom: 18,
        }).addTo(map);

        markers = L.markerClusterGroup({
          disableClusteringAtZoom: 15,
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true
        });
        
        map.addLayer(markers);

        // Add map click handler
        map.on("click", (e) => {
          if (!currentUser) {
            showNotification("Please log in to add markers.", "error");
            return;
          }
          if (tempMarker) map.removeLayer(tempMarker);
          tempMarker = L.marker(e.latlng).addTo(map);
          markerModal.style.display = "block";
          overlay.style.display = "block";
        });

        // Load existing markers
        loadMarkers();
        
        // Make sure map takes up 100% of the screen view
        const mapContainer = document.getElementById("map");
        mapContainer.style.height = "100vh";
        mapContainer.style.width = "100%";
        
        // Force map to update its size after initialization
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      }
    }

    // Load Markers Function
    function loadMarkers() {
      if (!markers) return;

      markers.clearLayers();
      resetCategoryCounts();
      
      // Clear stored markers by category
      for (let category in markersByCategory) {
        markersByCategory[category] = [];
      }

      database.ref("markers").once("value", (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const markerData = childSnapshot.val();
          markerData.id = childSnapshot.key;
          
          // Store marker data by category
          if (markerData.category && markersByCategory.hasOwnProperty(markerData.category)) {
            markersByCategory[markerData.category].push(markerData);
          }

          // Only add markers for active categories
          if (selectedCategories.has(markerData.category)) {
            addMarkerToMap(markerData);
            
            // Update category counts
            if (markerData.category && categoryCounts.hasOwnProperty(markerData.category)) {
              categoryCounts[markerData.category]++;
            }
          }
        });
        
        // Update category count displays
        updateCategoryCountDisplay();
      });
    }

    // Reset Category Counts
    function resetCategoryCounts() {
      for (let category in categoryCounts) {
        categoryCounts[category] = 0;
      }
    }

    // Update Category Count Display
    function updateCategoryCountDisplay() {
      architectureCount.textContent = categoryCounts.architecture;
      natureCount.textContent = categoryCounts.nature;
      eventsCount.textContent = categoryCounts.events;
      peopleCount.textContent = categoryCounts.people;
    }

    // Add Marker to Map Function with colored icons based on category
    function addMarkerToMap(markerData) {
      // Create custom icon based on category
      const categoryColors = {
        architecture: '#2563eb',
        nature: '#10b981',
        events: '#f59e0b',
        people: '#8b5cf6'
      };
      
      const defaultColor = '#2563eb'; // Default blue color
      const markerColor = categoryColors[markerData.category] || defaultColor;
      
      const customIcon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="background-color: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        popupAnchor: [0, -12]
      });
      
      const marker = L.marker([markerData.lat, markerData.lng], { 
        icon: customIcon,
        alt: markerData.title,
        category: markerData.category
      });
      
      const popupContent = `
        <div class="marker-popup">
          <h2><a href="#" class="title-link" data-marker-id="${markerData.id}">${markerData.title}</a></h2>
          <p class="description">${markerData.description.split(" ").slice(0, 10).join(" ")}${markerData.description.split(" ").length > 10 ? "..." : ""}</p>
          <p><strong>Category:</strong> ${markerData.category ? markerData.category.charAt(0).toUpperCase() + markerData.category.slice(1) : 'Uncategorized'}</p>
        </div>
      `;
      marker.bindPopup(popupContent);

      // Use on('popupopen') instead of trying to access the DOM node directly
      marker.on('popupopen', function() {
        setTimeout(() => {
          const titleLink = document.querySelector(`.title-link[data-marker-id="${markerData.id}"]`);
          if (titleLink) {
            titleLink.addEventListener("click", (e) => {
              e.preventDefault();
              updateMarkerInfoModal(markerData);
              markerInfoModal.style.display = "block";
              overlay.style.display = "block";
              marker.closePopup();
            });
          }
        }, 100); // Small delay to ensure DOM is ready
      });

      markers.addLayer(marker);
    }

    // Update Marker Info Modal Function
    function updateMarkerInfoModal(data) {
      currentMarkerId = data.id;
      markerInfoTitle.textContent = data.title;

      if (data.image) {
        markerInfoImage.src = data.image;
        markerInfoImage.style.cursor = "pointer";
        markerInfoImage.onclick = () => {
          expandedImageModal.style.display = "flex";
          expandedImage.src = data.image;
          expandedImage.alt = data.title;
          expandedImageTitle.textContent = data.title;
          overlay.style.zIndex = "1000";
          expandedImageModal.style.zIndex = "2000";
        };
      } else {
        markerInfoImage.src = "https://via.placeholder.com/400x300?text=No+Image+Available";
        markerInfoImage.style.cursor = "default";
        markerInfoImage.onclick = null;
      }

      markerInfoImage.alt = data.title;
      markerInfoUploader.innerHTML = `<i class="fas fa-user"></i> Taken by ${data.uploaderName || "Anonymous"} on ${new Date(data.date).toLocaleDateString()}`;
      
      // Fix for Issue #1: Display plain text description instead of HTML
      markerInfoDescription.textContent = data.description ? stripHtml(data.description) : "";
      
      // Fix for Issue #2: Display copyright information
      if (data.copyright) {
        let copyrightText = "";
        if (data.copyright.creativeCommons) {
          copyrightText += "Licensed under Creative Commons BY-NC 4.0.";
        }
        if (data.copyright.authorOwned) {
          copyrightText += copyrightText ? ", Author Owned" : "All associated content is author owned.";
        }
        markerInfoCopyright.textContent = `${copyrightText || "Not specified"}`;
      } else {
        markerInfoCopyright.textContent = "Not specified";
      }
      
      markerInfoViews.innerHTML = `<i class="fas fa-eye"></i> <span>${data.views || 0} views</span>`;
      markerInfoLikes.innerHTML = `<i class="fas fa-heart"></i> <span>${data.likes || 0} likes</span>`;

      markerInfoCategories.innerHTML = `
        <span class="category-tag ${data.category || 'architecture'}">${data.category ? data.category.charAt(0).toUpperCase() + data.category.slice(1) : 'Uncategorized'}</span>
      `;

      loadComments(data.id).then((comments) => {
        commentsList.innerHTML = comments.length > 0 ?
         comments
           .map(
             (comment) => `
               <div class="comment">
                 <div class="comment-header">
                   <span class="comment-author">${comment.userName || "Anonymous"}</span>
                   <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
                 </div>
                 <p class="comment-text">${comment.text}</p>
               </div>
             `
           )
           .join("")
        : "<p>No comments yet. Be the first to comment!</p>";
      });

      database.ref(`markers/${data.id}/views`).transaction((currentViews) => {
        return (currentViews || 0) + 1;
      }).then(() => {
        if (currentUser) {
          updateUserPoints(POINTS.MARKER_VIEW);
        }
      });

      updateLikeButtonState();
      
      // Load history timeline
      loadHistoryTimeline(data.id);
      
      // Load source verification info
      loadSourceVerification(data.id);
      
      // Load peer reviews
      loadPeerReviews(data.id);
    }
    
    // Helper function to strip HTML tags
    function stripHtml(html) {
      const temp = document.createElement("div");
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || "";
    }

    // Load Comments Function
    function loadComments(markerId) {
      return database.ref(`comments/${markerId}`).once("value").then((snapshot) => {
        const comments = [];
        snapshot.forEach((childSnapshot) => {
          comments.push({
            id: childSnapshot.key,
            ...childSnapshot.val(),
          });
        });
        return comments;
      });
    }

    // Load History Timeline Function
    function loadHistoryTimeline(markerId) {
      database.ref(`markerHistory/${markerId}`).orderByChild("timestamp").once("value", (snapshot) => {
        timelineContainer.innerHTML = "";
        
        if (!snapshot.exists()) {
          timelineContainer.innerHTML = "<p>No edit history available for this marker.</p>";
          return;
        }
        
        const historyItems = [];
        snapshot.forEach((childSnapshot) => {
          historyItems.push({
            id: childSnapshot.key,
            ...childSnapshot.val(),
          });
        });
        
        // Reverse to show most recent first
        historyItems.reverse();
        
        historyItems.forEach((item, index) => {
          const isLeft = index % 2 === 0;
          const historyItem = document.createElement("div");
          historyItem.className = `timeline-item ${isLeft ? 'left' : 'right'}`;
          
          historyItem.innerHTML = `
            <div class="timeline-content">
              <div class="timeline-date">${new Date(item.timestamp).toLocaleString()}</div>
              <div class="timeline-user">Edited by ${item.userName || "Anonymous"}</div>
              <div class="timeline-text">${item.changeDescription || "Updated marker details"}</div>
            </div>
          `;
          
          timelineContainer.appendChild(historyItem);
        });
      });
    }

    // Load Source Verification Function
    function loadSourceVerification(markerId) {
      database.ref(`markerSources/${markerId}`).once("value", (snapshot) => {
        sourceDocuments.innerHTML = "";
        citationList.innerHTML = "";
        
        if (!snapshot.exists()) {
          sourceVerification.querySelector(".verification-status").textContent = "No Sources Submitted";
          sourceVerification.querySelector(".verification-status").className = "verification-status pending";
          return;
        }
        
        const sourceData = snapshot.val();
        
        // Update verification status
        const statusElement = sourceVerification.querySelector(".verification-status");
        statusElement.textContent = sourceData.verified ? "Verified" : "Pending Verification";
        statusElement.className = `verification-status ${sourceData.verified ? 'verified' : 'pending'}`;
        
        // Display source documents
        if (sourceData.documents && Object.keys(sourceData.documents).length > 0) {
          sourceDocuments.innerHTML = Object.values(sourceData.documents).map(doc => `
            <div class="source-document">
              <img src="${doc.url}" alt="${doc.name}">
              <div class="source-document-overlay">${doc.name}</div>
            </div>
          `).join("");
        } else {
          sourceDocuments.innerHTML = "<p>No documents uploaded</p>";
        }
        
        // Display citations
        if (sourceData.citations && sourceData.citations.length > 0) {
          citationList.innerHTML = sourceData.citations.map(citation => `
            <div class="citation-item">
              <div class="citation-title">${citation.title}</div>
              <div class="citation-details">${citation.author} - ${new Date(citation.date).toLocaleDateString()}</div>
              ${citation.url ? `<a href="${citation.url}" target="_blank">View Source</a>` : ''}
            </div>
          `).join("");
        } else {
          citationList.innerHTML = "<p>No citations provided</p>";
        }
      });
    }

    // Load Peer Reviews Function
    function loadPeerReviews(markerId) {
      database.ref(`markerReviews/${markerId}`).orderByChild("timestamp").once("value", (snapshot) => {
        reviewsList.innerHTML = "";
        
        if (!snapshot.exists()) {
          reviewsList.innerHTML = "<p>No reviews yet. Be the first to review!</p>";
          return;
        }
        
        const reviews = [];
        snapshot.forEach((childSnapshot) => {
          reviews.push({
            id: childSnapshot.key,
            ...childSnapshot.val(),
          });
        });
        
        reviewsList.innerHTML = reviews.map(review => `
          <div class="review-item">
            <div class="review-header">
              <span class="review-author">${review.userName || "Anonymous"}</span>
              <span class="review-date">${new Date(review.timestamp).toLocaleDateString()}</span>
            </div>
            <div class="review-text">${review.text}</div>
            <div class="review-actions">
              <span class="review-status ${review.status}">${review.status.charAt(0).toUpperCase() + review.status.slice(1)}</span>
            </div>
          </div>
        `).join("");
      });
    }

    // Update Like Button State Function
    function updateLikeButtonState() {
      if (!currentUser || !currentMarkerId) {
        likeButton.disabled = true;
        likeButton.innerHTML = '<i class="far fa-heart"></i> Login to Like';
        return;
      }

      likeButton.disabled = false;

      database.ref(`likes/${currentMarkerId}/${currentUser.uid}`).once("value", (snapshot) => {
        if (snapshot.exists()) {
          // User has already liked, so unlike
          likeButton.classList.add("liked");
          likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
        } else {
          likeButton.classList.remove("liked");
          likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
        }
      });
    }

    // Show Notification Function
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = "block";

      setTimeout(() => {
        notification.style.display = "none";
      }, 3000);
    }

    // Update User Points Function
    function updateUserPoints(points) {
      if (!currentUser) return;

      const userPointsRef = database.ref(`users/${currentUser.uid}/points`);

      userPointsRef.transaction((currentPoints) => {
        return (currentPoints || 0) + points;
      }).then(() => {
        checkForBadges();
      });
    }

    // Check for Badges Function
    function checkForBadges() {
      if (!currentUser) return;

      database.ref(`users/${currentUser.uid}/points`).once("value", (snapshot) => {
        const points = snapshot.val() || 0;
        const earnedBadges = [];

        for (const [badgeId, badge] of Object.entries(BADGES)) {
          if (points >= badge.requirement) {
            earnedBadges.push(badgeId);
          }
        }

        database.ref(`users/${currentUser.uid}/badges`).set(earnedBadges);
      });
    }

    // Load User Data Function
    function loadUserData() {
      if (!currentUser) return;

      database.ref(`users/${currentUser.uid}`).once("value", (snapshot) => {
        const userData = snapshot.val() || {};

        if (userData.firstName && userData.lastName) {
          currentUser.displayName = `${userData.firstName} ${userData.lastName}`;
        }

        // Update UI based on user data
        loginLink.textContent = "Logout";
        loginLink.removeEventListener("click", showLoginPopup);
        loginLink.addEventListener("click", showLogoutPopup);
      });
    }

    // Show Login Popup Function
    function showLoginPopup(e) {
      e.preventDefault();
      authPopup.style.display = "block";
      overlay.style.display = "block";
    }

    // Show Logout Popup Function
    function showLogoutPopup(e) {
      e.preventDefault();
      logoutPopup.style.display = "block";
      overlay.style.display = "block";
    }

    // Toggle Category Visibility
    function toggleCategoryVisibility(category) {
      const badge = document.querySelector(`.category-badge[data-category="${category}"]`);
      
      if (selectedCategories.has(category)) {
        // Category is currently visible, hide it
        selectedCategories.delete(category);
        badge.classList.remove("active");
        badge.classList.add("inactive");
        
        // Set count to 0
        categoryCounts[category] = 0;
      } else {
        // Category is currently hidden, show it
        selectedCategories.add(category);
        badge.classList.add("active");
        badge.classList.remove("inactive");
        
        // Add markers for this category
        markersByCategory[category].forEach(markerData => {
          addMarkerToMap(markerData);
          categoryCounts[category]++;
        });
      }
      
      // Update the display
      updateCategoryCountDisplay();
      
      // Refresh the map
      refreshMapMarkers();
    }
    
    // Refresh Map Markers
    function refreshMapMarkers() {
      if (!markers) return;
      
      markers.clearLayers();
      
      // Add markers for selected categories
      for (let category in markersByCategory) {
        if (selectedCategories.has(category)) {
          markersByCategory[category].forEach(markerData => {
            addMarkerToMap(markerData);
          });
        }
      }
    }

    // Initialize Map and Firebase when the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", () => {
      // Set current date as default for date input
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      
      // Show search page first
      searchPage.style.display = "flex";
      mapPage.style.display = "none";

      // Initialize Firebase Auth state
      auth.onAuthStateChanged((user) => {
        currentUser = user;

        if (user) {
          showNotification("Welcome back!", "success");
          loadUserData();
          loginLink.textContent = "Logout";
          loginLink.removeEventListener("click", showLoginPopup);
          loginLink.addEventListener("click", showLogoutPopup);
        } else {
          loginLink.textContent = "Login/Join";
          loginLink.removeEventListener("click", showLogoutPopup);
          loginLink.addEventListener("click", showLoginPopup);
        }
      });

      // Initialize map if mapPage is displayed
      const mapPageObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === "style") {
            if (mapPage.style.display === "block" && !map) {
              initializeMap();
            }
          }
        });
      });

      mapPageObserver.observe(mapPage, {
        attributes: true, // Monitor style changes
      });
    });

    // Event Listeners
    floatingBtn.addEventListener("click", () => {
      menuContent.style.display = menuContent.style.display === "block" ? "none" : "block";
    });

    // Close menu when clicking anywhere on the document
    document.addEventListener("click", (e) => {
      // If the click is not on the floating button and the menu is open, close it
      if (e.target !== floatingBtn && !floatingBtn.contains(e.target) && menuContent.style.display === "block") {
        menuContent.style.display = "none";
      }
    });

    // Stop propagation on menu content to prevent it from closing when clicking inside it
    menuContent.addEventListener("click", (e) => {
      if (e.target.tagName === "A") {
        menuContent.style.display = "none";
      }
      e.stopPropagation();
    });

    showLogin.addEventListener("click", () => {
      loginForm.style.display = "block";
      joinForm.style.display = "none";
      showLogin.classList.add("active");
      showJoin.classList.remove("active");
      showLogin.setAttribute("aria-selected", "true");
      showJoin.setAttribute("aria-selected", "false");
    });

    showJoin.addEventListener("click", () => {
      loginForm.style.display = "none";
      joinForm.style.display = "block";
      showJoin.classList.add("active");
      showLogin.classList.remove("active");
      showJoin.setAttribute("aria-selected", "true");
      showLogin.setAttribute("aria-selected", "false");
    });

    closePopup.addEventListener("click", () => {
      authPopup.style.display = "none";
      overlay.style.display = "none";
    });

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginEmail.value;
      const password = loginPassword.value;

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          showNotification("Logged in successfully", "success");
          authPopup.style.display = "none";
          overlay.style.display = "none";
          currentUser = userCredential.user;

          // Load user data (including displayName)
          loadUserData();
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    });

    joinForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = joinEmail.value;
      const password = joinPassword.value;
      const firstName = joinFirstName.value;
      const lastName = joinLastName.value;
      const city = joinCity.value;

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          return database.ref("users/" + userCredential.user.uid).set({
            firstName: firstName,
            lastName: lastName,
            city: city,
            email: email,
            points: 0,
            badges: [],
            joinDate: Date.now(),
          });
        })
        .then(() => {
          showNotification("Account created successfully", "success");
          authPopup.style.display = "none";
          overlay.style.display = "none";
          loadUserData();
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    });

    confirmLogout.addEventListener("click", () => {
      auth.signOut().then(() => {
        showNotification("Logged out successfully", "success");
        logoutPopup.style.display = "none";
        overlay.style.display = "none";
        currentUser = null;
        loginLink.textContent = "Login/Join";
        loginLink.removeEventListener("click", showLogoutPopup);
        loginLink.addEventListener("click", showLoginPopup);
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    });

    cancelLogout.addEventListener("click", () => {
      logoutPopup.style.display = "none";
      overlay.style.display = "none";
    });

    aboutLink.addEventListener("click", (e) => {
      e.preventDefault();
      aboutPopup.style.display = "block";
      overlay.style.display = "block";
    });

    closeAbout.addEventListener("click", () => {
      aboutPopup.style.display = "none";
      overlay.style.display = "none";
    });

    instructionsLink.addEventListener("click", (e) => {
      e.preventDefault();
      instructionsPopup.style.display = "block";
      overlay.style.display = "block";
    });

    closeInstructions.addEventListener("click", () => {
      instructionsPopup.style.display = "none";
      overlay.style.display = "none";
    });

    // Fixed marker submission functionality
    markerForm.addEventListener("submit", (e) => {
      e.preventDefault();

      // Get form values
      const title = titleInput.value;
      const category = categoryInput.value;
      const description = editor.getContents(); // Get content from Suneditor
      const date = dateInput.value;
      
      // Get copyright information
      const copyright = {
        creativeCommons: creativeCommonsCheckbox.checked,
        authorOwned: authorOwnedCheckbox.checked
      };

      // Check for profanity
      if (containsProfanity(title) || containsProfanity(stripHtml(description))) {
        showNotification("Please watch your language! Your submission contains inappropriate words.", "error");
        return;
      }

      // Check if a location is selected
      if (!tempMarker) {
        showNotification("Please select a location on the map", "error");
        return;
      }

      // Prepare marker data
      const newMarkerRef = database.ref("markers").push();
      const newMarker = {
        id: newMarkerRef.key,
        title: title,
        category: category,
        description: description,
        lat: tempMarker.getLatLng().lat,
        lng: tempMarker.getLatLng().lng,
        uploaderName: currentUser.displayName || "Anonymous",
        uploaderId: currentUser.uid,
        date: date,
        timestamp: Date.now(),
        views: 0,
        likes: 0,
        copyright: copyright,
        status: "pending" // New marker status for moderation
      };

      // Create history entry
      const historyEntry = {
        userId: currentUser.uid,
        userName: currentUser.displayName || "Anonymous",
        timestamp: Date.now(),
        changeDescription: "Created marker",
        changes: {
          title: title,
          description: description,
          category: category
        }
      };

      // Handle image upload (if applicable)
      if (imageUpload.files.length > 0) {
        const file = imageUpload.files[0];
        const storageRef = storage.ref("marker_images/" + newMarkerRef.key);

        storageRef.put(file).then((snapshot) => {
          return snapshot.ref.getDownloadURL();
        }).then((downloadURL) => {
          newMarker.image = downloadURL; // Add image URL to marker data
          return newMarkerRef.set(newMarker);
        }).then(() => {
          // Add history entry
          return database.ref(`markerHistory/${newMarkerRef.key}`).push().set(historyEntry);
        }).then(() => {
          showNotification("Marker added successfully and submitted for review", "success");
          markerModal.style.display = "none";
          overlay.style.display = "none";
          map.removeLayer(tempMarker);
          tempMarker = null;
          markerForm.reset();
          editor.setContents(""); // Clear Suneditor content
          dateInput.value = today; // Reset date to today
          
          // Add to markers by category
          if (newMarker.category && markersByCategory.hasOwnProperty(newMarker.category)) {
            markersByCategory[newMarker.category].push(newMarker);
          }
          
          // Only add to map if category is selected
          if (selectedCategories.has(newMarker.category)) {
            addMarkerToMap(newMarker);
            categoryCounts[newMarker.category]++;
            updateCategoryCountDisplay();
          }
          
          updateUserPoints(POINTS.ADD_MARKER);
        }).catch((error) => {
          showNotification(error.message, "error");
        });
      } else {
        // No image to upload
        newMarkerRef.set(newMarker)
          .then(() => {
            // Add history entry
            return database.ref(`markerHistory/${newMarkerRef.key}`).push().set(historyEntry);
          })
          .then(() => {
            showNotification("Marker added successfully and submitted for review", "success");
            markerModal.style.display = "none";
            overlay.style.display = "none";
            map.removeLayer(tempMarker);
            tempMarker = null;
            markerForm.reset();
            editor.setContents(""); // Clear Suneditor content
            dateInput.value = today; // Reset date to today
            
            // Add to markers by category
            if (newMarker.category && markersByCategory.hasOwnProperty(newMarker.category)) {
              markersByCategory[newMarker.category].push(newMarker);
            }
            
            // Only add to map if category is selected
            if (selectedCategories.has(newMarker.category)) {
              addMarkerToMap(newMarker);
              categoryCounts[newMarker.category]++;
              updateCategoryCountDisplay();
            }
            
            updateUserPoints(POINTS.ADD_MARKER);
          })
          .catch((error) => {
            showNotification(error.message, "error");
          });
      }
    });

    closeModal.addEventListener("click", () => {
      markerModal.style.display = "none";
      overlay.style.display = "none";
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    });

    searchButton.addEventListener("click", () => {
      const searchTerm = searchInput.value;
      if (searchTerm.trim() === "") {
        showNotification("Please enter a search term", "error");
        return;
      }

      // Switch to map page
      searchPage.style.display = "none";
      mapPage.style.display = "block";

      // Initialize map if not already done
      if (!map) {
        initializeMap();
      }

      // Perform search
      performSearch(searchTerm);
    });

    mapSearchButton.addEventListener("click", () => {
      const searchTerm = mapSearchInput.value;
      if (searchTerm.trim() === "") {
        showNotification("Please enter a search term", "error");
        return;
      }
      performSearch(searchTerm);
    });

    function performSearch(searchTerm) {
      // Add Minnesota to the search if not already included
      if (!searchTerm.toLowerCase().includes("minnesota") && !searchTerm.toLowerCase().includes("mn")) {
        searchTerm = searchTerm + " Minnesota";
      }
      
      // Show loading notification
      showNotification("Searching for location...", "info");
      
      const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}`;
      
      fetch(geocodingUrl)
        .then((response) => response.json())
        .then((data) => {
          // Filter results to only include Minnesota locations
          const mnResults = data.filter(result => {
            // Check if the display name contains Minnesota or MN
            return (result.display_name.toLowerCase().includes("minnesota") || 
                    result.display_name.toLowerCase().includes(", mn,")) &&
                   // Verify the result is in the US
                   result.display_name.toLowerCase().includes("united states");
          });
          
          if (mnResults.length > 0) {
            const result = mnResults[0];
            map.setView([result.lat, result.lon], 13);
            
            // Use correct singular/plural form based on number of results
            const resultText = mnResults.length === 1 ? "result" : "results";
            showNotification(`Found ${mnResults.length} ${resultText} for "${searchTerm}"`, "success");
          } else {
            showNotification("No locations found in Minnesota", "error");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showNotification("An error occurred while searching", "error");
        });
    }

    scrollDown.addEventListener("click", () => {
      searchPage.style.display = "none";
      mapPage.style.display = "block";

      // Initialize map if not already done
      if (!map) {
        initializeMap();
      }
    });

    homeLink.addEventListener("click", (e) => {
      e.preventDefault();
      searchPage.style.display = "flex";
      mapPage.style.display = "none";
    });

    likeButton.addEventListener("click", () => {
      if (!currentUser) {
        showNotification("Please log in to like markers", "error");
        return;
      }

      if (!currentMarkerId) return;

      const likeRef = database.ref(`likes/${currentMarkerId}/${currentUser.uid}`);
      const markerLikesRef = database.ref(`markers/${currentMarkerId}/likes`);

      likeRef.once("value", (snapshot) => {
        if (snapshot.exists()) {
          // User has already liked, so unlike
          likeRef.remove();
          markerLikesRef.transaction((currentLikes) => (currentLikes || 1) - 1);
          likeButton.classList.remove("liked");
          likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
          showNotification("You unliked this marker", "success");
        } else {
          // User hasn't liked, so add like
          likeRef.set(true);
          markerLikesRef.transaction((currentLikes) => (currentLikes || 0) + 1);
          likeButton.classList.add("liked");
          likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
          showNotification("You liked this marker", "success");

          // Update marker uploader's points
          database.ref(`markers/${currentMarkerId}`).once("value", (snapshot) => {
            const markerData = snapshot.val();
            if (markerData && markerData.uploaderId && markerData.uploaderId !== currentUser.uid) {
              const uploaderPointsRef = database.ref(`users/${markerData.uploaderId}/points`);
              uploaderPointsRef.transaction((currentPoints) => (currentPoints || 0) + POINTS.RECEIVE_LIKE);
            }
          });
        }
      });
    });

    addToCollectionButton.addEventListener("click", () => {
      if (!currentUser) {
        showNotification("Please log in to add markers to collections", "error");
        return;
      }

      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }

      showCollectionSelector(currentMarkerId);
    });

    reportButton.addEventListener("click", () => {
      if (!currentUser) {
        showNotification("Please log in to report markers", "error");
        return;
      }

      reportModal.style.display = "block";
      overlay.style.display = "block";
    });

    document.getElementById("reportForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const reason = document.getElementById("reportReason").value;
      const details = document.getElementById("reportDetails").value;

      // Check for profanity
      if (containsProfanity(details)) {
        showNotification("Please watch your language! Your report contains inappropriate words.", "error");
        return;
      }

      if (!currentUser) {
        showNotification("Please log in to report markers", "error");
        return;
      }

      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }

      const reportRef = database.ref("reports").push();
      reportRef.set({
        markerId: currentMarkerId,
        reporterId: currentUser.uid,
        reporterName: currentUser.displayName || "Anonymous",
        reason: reason,
        details: details,
        timestamp: Date.now(),
        status: "pending",
      }).then(() => {
        showNotification("Report submitted successfully", "success");
        reportModal.style.display = "none";
        overlay.style.display = "none";
        e.target.reset();
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    });

    commentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = e.target.querySelector("textarea").value;

      // Check for profanity
      if (containsProfanity(text)) {
        showNotification("Please watch your language! Your comment contains inappropriate words.", "error");
        return;
      }

      if (!currentUser) {
        showNotification("Please log in to add comments", "error");
        return;
      }

      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }

      const commentRef = database.ref(`comments/${currentMarkerId}`).push();
      commentRef.set({
        userId: currentUser.uid,
        userName: currentUser.displayName || "Anonymous", // Use displayName if available
        text: text,
        timestamp: Date.now(),
      }).then(() => {
        showNotification("Comment added successfully", "success");
        e.target.reset();
        updateUserPoints(POINTS.ADD_COMMENT);

        // Reload comments
        loadComments(currentMarkerId).then((comments) => {
          commentsList.innerHTML = comments
            .map(
              (comment) => `
                <div class="comment">
                  <div class="comment-header">
                    <span class="comment-author">${comment.userName}</span>
                    <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
                  </div>
                  <p class="comment-text">${comment.text}</p>
                </div>
              `
            )
            .join("");
        });
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    });

    document.querySelectorAll(".share-button").forEach((button) => {
      button.addEventListener("click", () => {
        if (!currentMarkerId) {
          showNotification("No marker selected", "error");
          return;
        }

        const platform = button.classList[1];
        const markerData = {
          title: markerInfoTitle.textContent,
          description: markerInfoDescription.textContent,
        };

        shareMarker(platform, markerData);
      });
    });

    closeMarkerInfo.addEventListener("click", () => {
      markerInfoModal.style.display = "none";
      overlay.style.display = "none";
    });

    // Add event listener for the close button in expanded image modal
    closeExpandedImage.addEventListener("click", () => {
      expandedImageModal.style.display = "none";
      overlay.style.zIndex = "1000";
    });

    // Also close expanded image modal when clicking anywhere on it
    expandedImageModal.addEventListener("click", (e) => {
      if (e.target === expandedImageModal) {
        expandedImageModal.style.display = "none";
        overlay.style.zIndex = "1000";
      }
    });

    collectionsLink.addEventListener("click", (e) => {
      e.preventDefault();

      if (!currentUser) {
        showNotification("Please log in to view collections", "error");
        return;
      }

      loadCollections();
      collectionsModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeCollections.addEventListener("click", () => {
      collectionsModal.style.display = "none";
      overlay.style.display = "none";
    });

    closeCollectionMarkers.addEventListener("click", () => {
      collectionMarkersModal.style.display = "none";
      overlay.style.display = "none";
    });

    leaderboardLink.addEventListener("click", (e) => {
      e.preventDefault();
      loadLeaderboard();
      leaderboardModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeLeaderboard.addEventListener("click", () => {
      leaderboardModal.style.display = "none";
      overlay.style.display = "none";
    });

    closeReport.addEventListener("click", () => {
      reportModal.style.display = "none";
      overlay.style.display = "none";
    });

    // Add event listeners to category badges for toggling visibility
    categoryBadges.forEach((badge) => {
      badge.addEventListener("click", () => {
        const category = badge.dataset.category;
        toggleCategoryVisibility(category);
      });
    });

    infoButton.addEventListener("click", () => {
      citationModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeCitation.addEventListener("click", () => {
      citationModal.style.display = "none";
      overlay.style.display = "none";
    });

    recenterButton.addEventListener("click", () => {
      if (map) {
        map.setView([44.9778, -93.265], 10);
      }
    });

    // History Link Click Handler
    historyLink.addEventListener("click", (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        showNotification("Please log in to view history", "error");
        return;
      }
      
      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }
      
      historyModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeHistory.addEventListener("click", () => {
      historyModal.style.display = "none";
      overlay.style.display = "none";
    });

    // Source Upload Button Click Handler
    document.addEventListener("click", (e) => {
      if (e.target && e.target.id === "uploadSourcesBtn") {
        if (!currentUser) {
          showNotification("Please log in to upload sources", "error");
          return;
        }
        
        if (!currentMarkerId) {
          showNotification("No marker selected", "error");
          return;
        }
        
        // Reset Dropzone
        if (myDropzone) {
          myDropzone.removeAllFiles(true);
        }
        
        // Reset form
        sourceUploadForm.reset();
        
        sourceUploadModal.style.display = "block";
        overlay.style.display = "block";
      }
    });

    closeSourceUpload.addEventListener("click", () => {
      sourceUploadModal.style.display = "none";
      overlay.style.display = "none";
    });

    // Source Upload Form Submission
    sourceUploadForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      if (!currentUser || !currentMarkerId) {
        showNotification("Please log in to upload sources", "error");
        return;
      }
      
      const sourceTitle = document.getElementById("sourceTitle").value;
      const sourceAuthor = document.getElementById("sourceAuthor").value;
      const sourceDate = document.getElementById("sourceDate").value;
      const sourceUrl = document.getElementById("sourceUrl").value;
      
      if (!sourceTitle || !sourceAuthor || !sourceDate) {
        showNotification("Please fill in all required fields", "error");
        return;
      }
      
      // Prepare source data
      const sourceData = {
        title: sourceTitle,
        author: sourceAuthor,
        date: sourceDate,
        url: sourceUrl || null,
        submittedBy: currentUser.uid,
        submittedByName: currentUser.displayName || "Anonymous",
        timestamp: Date.now(),
        verified: false,
        citations: [
          {
            title: sourceTitle,
            author: sourceAuthor,
            date: sourceDate,
            url: sourceUrl || null
          }
        ]
      };
      
      // Handle document uploads if any
      if (myDropzone && myDropzone.files.length > 0) {
        const uploadPromises = [];
        const documents = {};
        
        myDropzone.files.forEach((file, index) => {
          const storageRef = storage.ref(`marker_sources/${currentMarkerId}/${file.name}`);
          uploadPromises.push(
            storageRef.put(file).then(snapshot => {
              return snapshot.ref.getDownloadURL().then(url => {
                documents[file.name] = {
                  name: file.name,
                  url: url,
                  type: file.type
                };
              });
            })
          );
        });
        
        Promise.all(uploadPromises).then(() => {
          sourceData.documents = documents;
          return database.ref(`markerSources/${currentMarkerId}`).set(sourceData);
        }).then(() => {
          showNotification("Sources uploaded successfully", "success");
          sourceUploadModal.style.display = "none";
          overlay.style.display = "none";
          sourceUploadForm.reset();
          if (myDropzone) {
            myDropzone.removeAllFiles(true);
          }
          
          // Update points
          updateUserPoints(POINTS.ADD_SOURCE);
          
          // Reload source verification info
          loadSourceVerification(currentMarkerId);
        }).catch(error => {
          showNotification(error.message, "error");
        });
      } else {
        // No documents to upload
        database.ref(`markerSources/${currentMarkerId}`).set(sourceData)
          .then(() => {
            showNotification("Sources submitted successfully", "success");
            sourceUploadModal.style.display = "none";
            overlay.style.display = "none";
            sourceUploadForm.reset();
            
            // Update points
            updateUserPoints(POINTS.ADD_SOURCE);
            
            // Reload source verification info
            loadSourceVerification(currentMarkerId);
          })
          .catch(error => {
            showNotification(error.message, "error");
          });
      }
    });

    // Peer Review Form Submission
    reviewForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      if (!currentUser || !currentMarkerId) {
        showNotification("Please log in to submit reviews", "error");
        return;
      }
      
      const reviewText = reviewForm.querySelector("textarea").value;
      
      if (!reviewText) {
        showNotification("Please enter your review", "error");
        return;
      }
      
      // Check which review button was clicked (approve/neutral/reject)
      let reviewStatus = "neutral";
      if (approveReview.classList.contains("active")) {
        reviewStatus = "approved";
      } else if (rejectReview.classList.contains("active")) {
        reviewStatus = "rejected";
      }
      
      const reviewData = {
        userId: currentUser.uid,
        userName: currentUser.displayName || "Anonymous",
        text: reviewText,
        status: reviewStatus,
        timestamp: Date.now()
      };
      
      database.ref(`markerReviews/${currentMarkerId}`).push().set(reviewData)
        .then(() => {
          showNotification("Review submitted successfully", "success");
          reviewForm.reset();
          
          // Update points based on review type
          if (reviewStatus === "approved" || reviewStatus === "rejected") {
            updateUserPoints(POINTS.COMPLETE_REVIEW);
          } else {
            updateUserPoints(POINTS.APPROVE_REVIEW);
          }
          
          // Reload reviews
          loadPeerReviews(currentMarkerId);
        })
        .catch(error => {
          showNotification(error.message, "error");
        });
    });

    // Review Action Button Click Handlers
    approveReview.addEventListener("click", () => {
      approveReview.classList.add("active");
      neutralReview.classList.remove("active");
      rejectReview.classList.remove("active");
    });

    neutralReview.addEventListener("click", () => {
      neutralReview.classList.add("active");
      approveReview.classList.remove("active");
      rejectReview.classList.remove("active");
    });

    rejectReview.addEventListener("click", () => {
      rejectReview.classList.add("active");
      approveReview.classList.remove("active");
      neutralReview.classList.remove("active");
    });

    // Social Sharing
    function shareMarker(platform, marker) {
      const url = window.location.href;
      const text = `Check out this interesting location in Minnesota: ${marker.title}`;

      const shareUrls = {
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
        twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
        linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(marker.title)}`,
      };

      window.open(shareUrls[platform], "_blank", "noopener,noreferrer");
    }

    // Check URL for collection parameter
    function checkUrlForCollection() {
      const urlParams = new URLSearchParams(window.location.search);
      const collectionId = urlParams.get('collection');
      const userId = urlParams.get('user');
      
      if (collectionId && userId) {
        // If we have both parameters, try to load the shared collection
        loadSharedCollection(collectionId, userId);
      }
    }

    // Load a shared collection
    function loadSharedCollection(collectionId, userId) {
      database.ref(`collections/${userId}/${collectionId}`).once("value", (snapshot) => {
        const collection = snapshot.val();
        if (!collection) {
          showNotification("Shared collection not found", "error");
          return;
        }
        
        // Switch to map view
        searchPage.style.display = "none";
        mapPage.style.display = "block";
        
        // Initialize map if needed
        if (!map) {
          initializeMap();
        }
        
        // Get markers in this collection
        const markerIds = Object.keys(collection.markers || {});
        
        if (markerIds.length === 0) {
          showNotification("This collection has no markers", "info");
          return;
        }
        
        // Show loading notification
        showNotification(`Loading shared collection: ${collection.name}`, "info");
        
        // Fetch and display markers
        const markerPromises = markerIds.map(markerId => 
          database.ref(`markers/${markerId}`).once("value").then(snapshot => {
            const markerData = snapshot.val();
            if (markerData) {
              markerData.id = markerId;
              return markerData;
            }
            return null;
          })
        );
        
        Promise.all(markerPromises).then(markers => {
          const validMarkers = markers.filter(marker => marker !== null);
          
          if (validMarkers.length === 0) {
            showNotification("No valid markers found in this collection", "error");
            return;
          }
          
          // Clear existing markers and add only the ones from this collection
          markers.clearLayers();
          
          // Add markers to map
          validMarkers.forEach(markerData => {
            addMarkerToMap(markerData);
          });
          
          // Fit map to show all markers
          const markerGroup = L.featureGroup(validMarkers.map(m => 
            L.marker([m.lat, m.lng])
          ));
          
          map.fitBounds(markerGroup.getBounds(), {
            padding: [50, 50]
          });
          
          showNotification(`Loaded ${validMarkers.length} markers from shared collection: ${collection.name}`, "success");
        });
      });
    }

    // Document click handler for closing modals when clicking outside
    document.addEventListener("click", (e) => {
      if (e.target === overlay) {
        document.querySelectorAll(".modal-base").forEach((modal) => {
          modal.style.display = "none";
        });
        expandedImageModal.style.display = "none";
        overlay.style.display = "none";
      }
    });

    // Make sure the map takes up 100% of the screen view when displayed
    window.addEventListener('resize', () => {
      if (map) {
        map.invalidateSize();
      }
    });

    // Check for keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Close modals with Escape key
      if (e.key === 'Escape') {
        document.querySelectorAll(".modal-base").forEach((modal) => {
          if (modal.style.display === "block") {
            modal.style.display = "none";
            overlay.style.display = "none";
          }
        });
        
        if (expandedImageModal.style.display === "flex") {
          expandedImageModal.style.display = "none";
          overlay.style.zIndex = "1000";
        }
      }
    });

    // Check URL for collection parameter when page loads
    window.addEventListener('load', () => {
      checkUrlForCollection();
    });
</script>
</body>
</html>
