<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Markers Map</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

    <!-- Suneditor CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" />

    <!-- Suneditor JS -->
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            overflow-x: hidden;
            color: #333;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        a {
            text-decoration: none;
            color: #2563eb;
            transition: color 0.3s ease;
        }

        a:hover {
            color: #1d4ed8;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            color: #1e293b;
            margin-bottom: 0.5em;
            font-weight: 600;
        }

        p {
            margin-bottom: 1em;
        }

        /* Page Layout */
        .page {
            width: 100%;
            min-height: 100vh;
            position: relative;
        }

        .search-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('https://www.mnthen.com/images/header/mn_history_header.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            text-align: center;
        }

        .search-page h1, .search-page h2, .search-page h3, 
        .search-page h4, .search-page h5, .search-page h6 {
            color: #ffffff;
        }

        .map-page {
            display: none;
            position: relative;
            height: 100vh;
            width: 100%;
        }

        /* Map Container */
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Hero Content */
        .hero-content {
            max-width: 800px;
            padding: 2rem;
            z-index: 2;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero-content h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .hero-content p {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Custom styles for Suneditor */
        #description-editor {
            border: 1px solid #d1d5db;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .sun-editor .se-toolbar {
            background-color: #f9fafb;
            border-bottom: 1px solid #d1d5db;
        }

        .sun-editor .se-wrapper {
            background-color: white;
        }

        /* Search Components */
        .search-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .search-bar {
            display: flex;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .search-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .search-input {
            flex: 1;
            padding: 1.2rem 1.5rem;
            border: none;
            font-size: 1.1rem;
            outline: none;
        }

        .search-button {
            padding: 1.2rem 2rem;
            background-color: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #1d4ed8;
        }

        .map-search-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            width: 80%;
            max-width: 500px;
            z-index: 10;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: box-shadow 0.3s ease;
        }

        .map-search-bar:hover {
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
        }

        .map-search-input {
            flex: 1;
            padding: 0.9rem 1.25rem;
            border: none;
            font-size: 1rem;
            outline: none;
        }

        .map-search-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: none;
            background-color: #2563eb;
            border-radius: 0 50px 50px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .map-search-button:hover {
            background-color: #1d4ed8;
        }

        .map-search-button i {
            color: white;
            font-size: 18px;
        }

        /* Category Selector */
        .category-selector {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            z-index: 10;
            padding: 12px 16px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .category-selector:hover {
            transform: translateX(-50%) translateY(-2px);
        }

        .category-badge {
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-badge.active {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .category-badge.architecture {
            background-color: #2563eb;
        }

        .category-badge.nature {
            background-color: #10b981;
        }

        .category-badge.events {
            background-color: #f59e0b;
        }

        .category-badge.people {
            background-color: #8b5cf6;
        }

        /* Floating Menu */
        .floating-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .floating-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #2563eb;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .floating-btn:hover {
            background-color: #1d4ed8;
            transform: scale(1.05);
        }

        .menu-content {
            display: none;
            position: absolute;
            top: 60px;
            left: 0;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            width: 220px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-content a {
            display: block;
            padding: 0.85rem 1.2rem;
            color: #333;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .menu-content a:hover {
            background-color: #f3f4f6;
            color: #2563eb;
            transform: translateX(5px);
        }

        /* Scroll Down Button */
        .scroll-down {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            cursor: pointer;
            animation: bounce 2s infinite;
        }

        .scroll-down span {
            margin-bottom: 0.5rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) translateX(-50%);
            }
            40% {
                transform: translateY(-10px) translateX(-50%);
            }
            60% {
                transform: translateY(-5px) translateX(-50%);
            }
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }

        /* Modal Base */
        .modal-base {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            padding: 2.5rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1100;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translate(-50%, -48%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .modal-base h2 {
            color: #1e3a8a;
            margin-bottom: 1.2rem;
            font-size: 1.8rem;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 0.8rem;
        }

        .modal-base p {
            color: #4b5563;
            margin-bottom: 1.2rem;
            line-height: 1.7;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #374151;
            background-color: #f3f4f6;
        }

        /* Auth Popup */
        .auth-popup {
            width: 420px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .auth-tab {
            flex: 1;
            padding: 0.85rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            font-size: 0.95rem;
            color: #4b5563;
        }

        .form-input {
            padding: 0.85rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-button {
            padding: 0.9rem;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-button:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Marker Info Modal */
        #markerInfoModal {
            width: 900px;
            max-width: 95%;
        }

        .marker-info-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .marker-info-content {
                flex-direction: row;
            }
        }

        /* Marker Image Container */
        .marker-image-container {
            position: relative;
            display: inline-block;
            margin-bottom: 25px;
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Marker Image */
        .marker-image {
            display: block;
            width: 100%;
            height: auto;
            transition: transform 0.5s ease;
            cursor: pointer;
        }

        .marker-image:hover {
            transform: scale(1.03);
        }

        /* Historical Source */
        .source-citation {
            background-color: #f8fafc;
            padding: 1.2rem;
            border-radius: 12px;
            margin-top: 1rem;
            font-size: 0.95rem;
            border: 1px solid #e2e8f0;
        }

        .source-citation h4 {
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            color: #1e3a8a;
        }
        
        /* Copyright options */
        .copyright-info {
            margin-top: 0.8rem;
            font-size: 0.9rem;
            color: #64748b;
            font-style: italic;
        }

        .marker-details {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .marker-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #1e3a8a;
        }

        .upload-info {
            font-size: 0.95rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-info i {
            color: #2563eb;
        }

        .category-tags {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .category-tag {
            padding: 0.35rem 0.9rem;
            border-radius: 50px;
            font-size: 0.85rem;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-tag.architecture {
            background-color: #2563eb;
        }

        .category-tag.nature {
            background-color: #10b981;
        }

        .category-tag.events {
            background-color: #f59e0b;
        }

        .category-tag.people {
            background-color: #8b5cf6;
        }

        .description {
            line-height: 1.7;
            color: #4b5563;
        }

        .marker-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.8rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #64748b;
            font-size: 0.95rem;
        }

        .interaction-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: #f8fafc;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background-color: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .report-button {
            background-color: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
        }

        .report-button:hover {
            color: #dc2626;
            background-color: rgba(239, 68, 68, 0.05);
        }

        .share-buttons {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.2rem;
        }

        .share-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .share-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .share-button.facebook {
            background-color: #1877f2;
        }

        .share-button.twitter {
            background-color: #1da1f2;
        }

        .share-button.linkedin {
            background-color: #0a66c2;
        }

        /* Comments Section */
        .comments-section {
            margin-top: 2rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
        }

        .comments-section h3 {
            margin-bottom: 1.2rem;
            font-size: 1.3rem;
            color: #1e3a8a;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            margin-bottom: 1.8rem;
        }

        .comment {
            background-color: #f8fafc;
            padding: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }

        .comment:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .comment-author {
            font-weight: 600;
            color: #1e3a8a;
        }

        .comment-date {
            font-size: 0.85rem;
            color: #64748b;
        }

        .comment-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #4b5563;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .comment-form textarea {
            resize: vertical;
            min-height: 100px;
            border-radius: 8px;
            padding: 1rem;
            font-family: inherit;
            font-size: 0.95rem;
        }

        /* Collections Grid */
        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.8rem;
            margin: 1.8rem 0;
        }

        .collection-card {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            background-color: white;
            position: relative;
            border: 1px solid #e2e8f0;
        }

        .collection-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .collection-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .collection-card:hover .collection-image {
            transform: scale(1.05);
        }

        .collection-info {
            padding: 1.5rem;
        }

        .collection-title {
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
            color: #1e3a8a;
        }

        .collection-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 1.2rem;
            font-size: 0.85rem;
            color: #64748b;
        }

        .collection-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 0.6rem;
        }

        .collection-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #475569;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .collection-action-btn:hover {
            background-color: white;
            color: #2563eb;
            transform: scale(1.1);
        }

        /* Collection Markers Modal */
        .collection-markers-modal {
            width: 800px;
            max-width: 95%;
        }

        .collection-markers-list {
            margin-top: 1.8rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.2rem;
        }

        .collection-marker-item {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }

        .collection-marker-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        }

        .collection-marker-title {
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: #1e3a8a;
        }

        .collection-marker-category {
            display: inline-block;
            padding: 0.25rem 0.7rem;
            border-radius: 50px;
            font-size: 0.75rem;
            color: white;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        .remove-from-collection {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.1);
            border: none;
            color: #ef4444;
            display: flex;
            align-items  68, 68, 0.1);
            border: none;
            color: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
            z-index: 5;
        }

        .remove-from-collection:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }

        /* Notification */
        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            max-width: 350px;
        }

        .notification.info {
            background-color: #3b82f6;
            border-left: 5px solid #2563eb;
        }

        .notification.success {
            background-color: #10b981;
            border-left: 5px solid #059669;
        }

        .notification.error {
            background-color: #ef4444;
            border-left: 5px solid #dc2626;
        }

        .notification.warning {
            background-color: #f59e0b;
            border-left: 5px solid #d97706;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Expanded Image Modal */
        .expanded-image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .expanded-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: zoomIn 0.3s ease-out;
        }

        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .expanded-image-title {
            color: white;
            font-size: 1.3rem;
            margin-top: 1.5rem;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Info Button */
        .info-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(200, 200, 200, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: all 0.3s;
            opacity: 0.8;
        }

        .info-button:hover {
            background-color: rgba(255, 255, 255, 0.9);
            opacity: 1;
            transform: scale(1.1);
        }

        .info-button i {
            color: #1e3a8a;
            font-size: 18px;
        }

        /* Recenter Button */
        .recenter-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #2563eb;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .recenter-button:hover {
            background-color: #1d4ed8;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        /* Leaderboard styling */
        .leaderboard {
            margin-top: 1.5rem;
        }

        .leaderboard-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 1.2rem;
            text-align: center;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.8rem;
            background-color: #f8fafc;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }

        .leaderboard-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2563eb;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e7ff;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .leaderboard-user {
            flex: 1;
            font-weight: 600;
            color: #1e293b;
        }

        .leaderboard-points {
            font-weight: 600;
            color: #10b981;
            background-color: #ecfdf5;
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
        }

        /* Copyright options */
        .copyright-options {
            margin-top: 15px;
        }
        
        .copyright-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .copyright-option input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .copyright-option label {
            cursor: pointer;
            font-size: 0.95rem;
            color: #4b5563;
        }

        /* Return link */
        .return-link {
            display: inline-block;
            color: white;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 0.7rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            transition: all 0.3s;
            margin-top: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .return-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .hero-content h1 {
                font-size: 2.5rem;
            }

            .search-bar {
                flex-direction: column;
                border-radius: 12px;
            }

            .search-input, .search-button {
                width: 100%;
                border-radius: 0;
            }

            .search-input {
                border-radius: 12px 12px 0 0;
            }

            .search-button {
                border-radius: 0 0 12px 12px;
            }

            .map-search-bar {
                width: 90%;
            }

            #markerInfoModal {
                width: 95%;
                max-height: 85vh;
            }

            .marker-info-content {
                flex-direction: column;
            }

            .marker-image {
                max-height: 250px;
                object-fit: cover;
            }

            .category-selector {
                padding: 10px;
                width: 90%;
            }

            .category-badge {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            .collection-markers-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="floating-menu" id="floatingMenu">
        <button class="floating-btn" id="floatingBtn">☰</button>
        <div class="menu-content" id="menuContent">
            <a href="#" id="homeLink">Home</a>
            <a href="#" id="aboutLink">About Us</a>
            <a href="#" id="instructionsLink">Instructions</a>
            <a href="#" id="loginLink">Login/Join</a>
            <a href="#" id="collectionsLink">Collections</a>
            <a href="#" id="leaderboardLink">Leaderboard</a>
        </div>
    </div>

    <div class="page search-page" id="searchPage">
        <div class="hero-content">
            <h1>Community Markers</h1>
            <p>Discover and share meaningful places across Minnesota.</p>
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput">
                    <button class="search-button" id="searchButton">Search</button>
                </div>
            </div>
            <a href="https://www.mnthen.com" class="return-link">Return to Minnesota Then</a>
        </div>
        <div class="scroll-down" id="scrollDown">
            <span>View Map</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
            </svg>
        </div>
        <button class="info-button" id="infoButton"><i class="fas fa-info"></i></button>
    </div>

    <div class="page map-page" id="mapPage">
        <div class="map-search-bar">
            <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput">
            <button class="map-search-button" id="mapSearchButton">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div id="map"></div>
        <div class="category-selector">
            <span class="category-badge architecture" data-category="architecture">Architecture</span>
            <span class="category-badge nature" data-category="nature">Nature</span>
            <span class="category-badge events" data-category="events">Events</span>
            <span class="category-badge people" data-category="people">People</span>
        </div>
        <button class="recenter-button" id="recenterButton"><i class="fas fa-crosshairs"></i></button>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="notification" class="notification"></div>

    <div id="authPopup" class="modal-base auth-popup">
        <button id="closePopup" class="close-btn">&times;</button>
        <div class="auth-container">
            <div class="auth-tabs">
                <button id="showLogin" class="auth-tab active">Login</button>
                <button id="showJoin" class="auth-tab">Join</button>
            </div>
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                </div>
                <button type="submit" id="loginButton" class="auth-button">Login</button>
            </form>
            <form id="joinForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="joinEmail">Email</label>
                    <input type="email" id="joinEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="joinPassword">Password</label>
                    <input type="password" id="joinPassword" class="form-input" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="joinFirstName">First Name</label>
                    <input type="text" id="joinFirstName" class="form-input" placeholder="Enter your first name" required>
                </div>
                <div class="form-group">
                    <label for="joinLastName">Last Name</label>
                    <input type="text" id="joinLastName" class="form-input" placeholder="Enter your last name" required>
                </div>
                <div class="form-group">
                    <label for="joinCity">City</label>
                    <input type="text" id="joinCity" class="form-input" placeholder="Enter your city" required>
                </div>
                <button type="submit" id="joinButton" class="auth-button">Join</button>
            </form>
        </div>
    </div>

    <div id="aboutPopup" class="modal-base">
        <button id="closeAbout" class="close-btn">&times;</button>
        <h2>About Us</h2>
        <p>
            Community Markers is a platform that allows users to discover and share meaningful places across Minnesota. Our mission is to create a digital map that showcases the rich history, culture, and natural beauty of our state through the eyes of its residents and visitors.
        </p>
        <p>
            By creating and exploring markers on our interactive map, you can share your favorite locations, hidden gems, and historical sites with others. Whether it's a scenic overlook, a local restaurant, or a significant landmark, Community Markers helps preserve and celebrate the diverse experiences that make Minnesota unique.
        </p>
        <p>
            Join our growing community of explorers and storytellers as we map out the best of Minnesota, one marker at a time!
        </p>
    </div>

    <div id="instructionsPopup" class="modal-base">
        <button id="closeInstructions" class="close-btn">&times;</button>
        <h2>Instructions</h2>
        <ol>
            <li>To add a marker, click on the map at the desired location.</li>
            <li>Fill in the marker details, including title, description, and an optional image.</li>
            <li>Click "Submit for Review" to save your marker to the map.</li>
            <li>To view marker details, click on any marker on the map.</li>
            <li>Use the search bar to find specific locations in Minnesota.</li>
            <li>Explore the map to discover markers added by other community members.</li>
            <li>Login or create an account to add your own markers and interact with the community.</li>
            <li>Create collections to organize markers by theme or location.</li>
        </ol>
        <p>Remember to respect others and follow community guidelines when adding markers. Enjoy exploring Minnesota!</p>
    </div>

    <div id="logoutPopup" class="modal-base auth-popup">
        <button id="cancelLogout" class="close-btn">&times;</button>
        <h2>Log Out</h2>
        <p>Are you sure you want to log out?</p>
        <button id="confirmLogout" class="auth-button">Log Out</button>
    </div>

    <div id="markerModal" class="modal-base">
        <button id="closeModal" class="close-btn">&times;</button>
        <h2>Add New Marker</h2>
        <form id="markerForm">
            <div class="form-group">
                <label for="title" class="form-label">Title (max 50 characters)</label>
                <input type="text" id="title" class="form-input" maxlength="50" required>
            </div>
            <div class="form-group">
                <label for="category" class="form-label">Category</label>
                <select id="category" class="form-input" required>
                    <option value="">Select a category</option>
                    <option value="architecture">Architecture</option>
                    <option value="nature">Nature</option>
                    <option value="events">Events</option>
                    <option value="people">People</option>
                </select>
            </div>
            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <textarea id="description-editor"></textarea>
            </div>
            <div class="form-group">
                <label for="imageUpload" class="form-label">Image</label>
                <input type="file" id="imageUpload" class="form-input" accept="image/*">
            </div>
            <div class="form-group">
                <label for="sourceCitation" class="form-label">Source Citation</label>
                <input type="text" id="sourceCitation" class="form-input" placeholder="Source of historical information" required>
            </div>
            <div class="form-group">
                <label for="date" class="form-label">Date</label>
                <input type="date" id="date" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Copyright Information</label>
                <div class="copyright-options">
                    <div class="copyright-option">
                        <input type="checkbox" id="creativeCommons" name="copyright" value="creativeCommons">
                        <label for="creativeCommons">Creative Commons</label>
                    </div>
                    <div class="copyright-option">
                        <input type="checkbox" id="authorOwned" name="copyright" value="authorOwned">
                        <label for="authorOwned">Author Owned</label>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Submit for Review</button>
        </form>
    </div>

    <div id="markerInfoModal" class="modal-base" style="display: none;">
        <button id="closeMarkerInfo" class="close-btn">&times;</button>
        <div class="marker-info-content">
            <div class="marker-image-container">
                <img id="markerInfoImage" src="/placeholder.svg" alt="" class="marker-image">
            </div>
            
            <div class="marker-details">
                <h3 id="markerInfoTitle" class="marker-title"></h3>
                <p class="upload-info" id="markerInfoUploader"><i class="fas fa-user"></i> <span></span></p>
                <div class="category-tags" id="markerInfoCategories"></div>
                <p class="description" id="markerInfoDescription"></p>
                <div class="source-citation">
                    <h4>Historical Source</h4>
                    <p id="markerInfoSource"></p>
                    <div class="copyright-info" id="markerInfoCopyright"></div>
                </div>
                <div class="marker-stats">
                    <span id="markerInfoViews" class="stat-item">
                        <i class="fas fa-eye"></i>
                        <span>0 views</span>
                    </span>
                    <span id="markerInfoLikes" class="stat-item">
                        <i class="fas fa-heart"></i>
                        <span>0 likes</span>
                    </span>
                </div>
                <div class="interaction-buttons" id="interactionButtons">
                    <button id="likeButton" class="btn btn-primary">
                        <i class="fas fa-heart"></i> Like
                    </button>
                    <button id="addToCollectionButton" class="btn btn-secondary">
                        <i class="fas fa-folder-plus"></i> Add to Collection
                    </button>
                    <button id="reportButton" class="report-button">
                        <i class="fas fa-flag"></i> Report
                    </button>
                </div>
                <div class="share-buttons">
                    <button class="share-button facebook">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="share-button twitter">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="share-button linkedin">
                        <i class="fab fa-linkedin-in"></i>
                    </button>
                </div>
                <div class="comments-section">
                    <h3>Comments</h3>
                    <div class="comments-list" id="commentsList"></div>
                    <form class="comment-form" id="commentForm">
                        <textarea class="form-input" placeholder="Add a comment..." required></textarea>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="expandedImageModal" class="expanded-image-modal">
        <img id="expandedImage" class="expanded-image" src="/placeholder.svg" alt="Expanded marker image">
        <h3 id="expandedImageTitle" class="expanded-image-title"></h3>
    </div>

    <div id="collectionsModal" class="modal-base">
        <button id="closeCollections" class="close-btn">&times;</button>
        <h2>Your Collections</h2>
        <div class="collections-grid" id="collectionsGrid"></div>
        <button id="createCollectionBtn" class="btn btn-primary">Create New Collection</button>
    </div>

    <div id="collectionMarkersModal" class="modal-base collection-markers-modal">
        <button id="closeCollectionMarkers" class="close-btn">&times;</button>
        <h2 id="collectionMarkersTitle">Collection Markers</h2>
        <p id="collectionMarkersDescription">View and manage markers in this collection.</p>
        <div class="collection-markers-list" id="collectionMarkersList"></div>
    </div>

    <div id="leaderboardModal" class="modal-base">
        <button id="closeLeaderboard" class="close-btn">&times;</button>
        <h2>Community Leaderboard</h2>
        <div class="leaderboard" id="leaderboardList"></div>
    </div>

    <div id="reportModal" class="modal-base">
        <button id="closeReport" class="close-btn">&times;</button>
        <h2>Report Inappropriate Content</h2>
        <form id="reportForm">
            <div class="form-group">
                <label class="form-label">Reason for Report</label>
                <select class="form-input" required>
                    <option value="">Select a reason</option>
                    <option value="inappropriate">Inappropriate Content</option>
                    <option value="spam">Spam</option>
                    <option value="offensive">Offensive Language</option>
                    <option value="inaccurate">Inaccurate Information</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Additional Details</label>
                <textarea class="form-input" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit Report</button>
        </form>
    </div>

    <div id="citationModal" class="modal-base">
        <button id="closeCitation" class="close-btn">&times;</button>
        <h2>Image Citation</h2>
        <p>Image source: <a href="https://collection.mndigital.org/catalog/p16022coll55:121" target="_blank" rel="noopener noreferrer">MN Digital Library</a></p>
        <p>Photographer: Minneapolis Park & Recreation Board</p>
        <p>Description: Convention American Association of Park Superintendents, Minneapolis, August 11-13, 1908, at the foot of Minnehaha Falls, Minneapolis, Minnesota. (August 11-13, 1908)</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
      authDomain: "mnthen-3151d.firebaseapp.com",
      projectId: "mnthen-3151d",
      storageBucket: "mnthen-3151d.appspot.com",
      messagingSenderId: "416231360428",
      appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
    };

    // Initialize Firebase
    let firebaseApp;
    if (!firebase.apps.length) {
      firebaseApp = firebase.initializeApp(firebaseConfig);
    } else {
      firebaseApp = firebase.app();
    }

    const auth = firebaseApp.auth();
    const database = firebaseApp.database();
    const storage = firebaseApp.storage();

    // Map Variables
    let map = null;
    let markers = null;
    let tempMarker = null;

    // Global Variables
    let currentUser = null;
    let currentMarkerId = null;
    let selectedCategories = new Set();
    let currentCollectionId = null;

    const profanityList = [
      // Sexual references
      "ass", "asshole", "bastard", "bitch", "cock", "cunt", "dick", "pussy", 
      "slut", "whore", "prick", "twat", 

      // Vulgar language
      "fuck", "fucking", "shit", "shitty", "crap", "piss", "damn", "hell", 
      "dammit", "bullshit", "motherfucker", "fuckwit", 

      // Derogatory terms
      "jag", "dipshit", "douchebag", "douche", "asshat", "jackass", 
      "nimrod", "moron", "imbecile", "idiot", 

      // Offensive slurs (generic, removed specific group-based slurs)
      "retard", "tard", "dumb", 

      // Crude anatomical references
      "tits", "boobs", "balls", "screw", 

      // Political/controversial additions
      "Trump", "Wisconsin",

      // Variations and common misspellings
      "fk", "fck", "sh1t", "f u c k", "b i t c h"
    ];

    function containsProfanity(text) {
      if (!text) return false;
      
      // Normalize text thoroughly
      const normalizedText = text.toLowerCase().replace(/[^a-z0-9]/g, '');
      
      // Check for full word matches and subword matches
      return profanityList.some(profanity => {
        // Exact word match
        const wordRegex = new RegExp(`\\b${profanity}\\b`, 'i');
        
        // Substring match to catch variations
        const substringMatch = normalizedText.includes(profanity);
        
        return wordRegex.test(text) || substringMatch;
      });
    }

    // Points System Configuration
    const POINTS = {
      ADD_MARKER: 10,
      RECEIVE_LIKE: 5,
      ADD_COMMENT: 2,
      MARKER_VIEW: 1,
    };

    // Badge System Configuration
    const BADGES = {
      NEWCOMER: { name: "Newcomer", icon: "star", requirement: 1 },
      CONTRIBUTOR: { name: "Active Contributor", icon: "pen", requirement: 5 },
      HISTORIAN: { name: "Local Historian", icon: "book", requirement: 10 },
      PHOTOGRAPHER: { name: "Photography Expert", icon: "camera", requirement: 15 },
      EXPLORER: { name: "Minnesota Explorer", icon: "compass", requirement: 20 },
    };

    // DOM Elements
    const floatingBtn = document.getElementById("floatingBtn");
    const menuContent = document.getElementById("menuContent");
    const loginLink = document.getElementById("loginLink");
    const authPopup = document.getElementById("authPopup");
    const closePopup = document.getElementById("closePopup");
    const joinForm = document.getElementById("joinForm");
    const loginForm = document.getElementById("loginForm");
    const showLogin = document.getElementById("showLogin");
    const showJoin = document.getElementById("showJoin");
    const joinButton = document.getElementById("joinButton");
    const loginButton = document.getElementById("loginButton");
    const notification = document.getElementById("notification");
    const searchPage = document.getElementById("searchPage");
    const mapPage = document.getElementById("mapPage");
    const scrollDown = document.getElementById("scrollDown");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const mapSearchInput = document.getElementById("mapSearchInput");
    const mapSearchButton = document.getElementById("mapSearchButton");
    const markerModal = document.getElementById("markerModal");
    const closeModal = document.getElementById("closeModal");
    const markerForm = document.getElementById("markerForm");
    const titleInput = document.getElementById("title");
    const categoryInput = document.getElementById("category");
    const imageUpload = document.getElementById("imageUpload");
    const sourceCitationInput = document.getElementById("sourceCitation");
    const dateInput = document.getElementById("date");
    const creativeCommonsCheckbox = document.getElementById("creativeCommons");
    const authorOwnedCheckbox = document.getElementById("authorOwned");
    const aboutLink = document.getElementById("aboutLink");
    const aboutPopup = document.getElementById("aboutPopup");
    const overlay = document.getElementById("overlay");
    const closeAbout = document.getElementById("closeAbout");
    const logoutPopup = document.getElementById("logoutPopup");
    const confirmLogout = document.getElementById("confirmLogout");
    const cancelLogout = document.getElementById("cancelLogout");
    const instructionsLink = document.getElementById("instructionsLink");
    const instructionsPopup = document.getElementById("instructionsPopup");
    const closeInstructions = document.getElementById("closeInstructions");
    const markerInfoModal = document.getElementById("markerInfoModal");
    const closeMarkerInfo = document.getElementById("closeMarkerInfo");
    const markerInfoImage = document.getElementById("markerInfoImage");
    const markerInfoTitle = document.getElementById("markerInfoTitle");
    const markerInfoDescription = document.getElementById("markerInfoDescription");
    const markerInfoCategories = document.getElementById("markerInfoCategories");
    const markerInfoSource = document.getElementById("markerInfoSource");
    const markerInfoCopyright = document.getElementById("markerInfoCopyright");
    const markerInfoViews = document.getElementById("markerInfoViews");
    const markerInfoUploader = document.getElementById("markerInfoUploader");
    const markerInfoLikes = document.getElementById("markerInfoLikes");
    const likeButton = document.getElementById("likeButton");
    const addToCollectionButton = document.getElementById("addToCollectionButton");
    const reportButton = document.getElementById("reportButton");
    const interactionButtons = document.getElementById("interactionButtons");
    const commentsList = document.getElementById("commentsList");
    const commentForm = document.getElementById("commentForm");
    const expandedImageModal = document.getElementById("expandedImageModal");
    const expandedImage = document.getElementById("expandedImage");
    const expandedImageTitle = document.getElementById("expandedImageTitle");
    const collectionsLink = document.getElementById("collectionsLink");
    const collectionsModal = document.getElementById("collectionsModal");
    const closeCollections = document.getElementById("closeCollections");
    const collectionMarkersModal = document.getElementById("collectionMarkersModal");
    const closeCollectionMarkers = document.getElementById("closeCollectionMarkers");
    const collectionMarkersTitle = document.getElementById("collectionMarkersTitle");
    const collectionMarkersDescription = document.getElementById("collectionMarkersDescription");
    const collectionMarkersList = document.getElementById("collectionMarkersList");
    const leaderboardLink = document.getElementById("leaderboardLink");
    const leaderboardModal = document.getElementById("leaderboardModal");
    const closeLeaderboard = document.getElementById("closeLeaderboard");
    const reportModal = document.getElementById("reportModal");
    const closeReport = document.getElementById("closeReport");
    const homeLink = document.getElementById("homeLink");
    const categoryBadges = document.querySelectorAll(".category-badge");
    const infoButton = document.getElementById("infoButton");
    const citationModal = document.getElementById("citationModal");
    const closeCitation = document.getElementById("closeCitation");
    const recenterButton = document.getElementById("recenterButton");

    // Initialize Suneditor
    const editor = SUNEDITOR.create('description-editor', {
      height: '300px',
      buttonList: [
        ['undo', 'redo'],
        ['font', 'fontSize', 'formatBlock'],
        ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
        ['fontColor', 'hiliteColor'],
        ['align', 'list'],
        ['link', 'image'],
        ['fullScreen', 'showBlocks', 'codeView'],
      ],
    });

    // Initialize Map Function
    function initializeMap() {
      if (!map && document.getElementById("map")) {
        map = L.map("map", {
          zoomControl: false,
          attributionControl: true
        }).setView([44.9778, -93.265], 10);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '',
          maxZoom: 18,
        }).addTo(map);

        markers = L.markerClusterGroup();
        map.addLayer(markers);

        // Add map click handler
        map.on("click", (e) => {
          if (!currentUser) {
            showNotification("Please log in to add markers.", "error");
            return;
          }
          if (tempMarker) map.removeLayer(tempMarker);
          tempMarker = L.marker(e.latlng).addTo(map);
          markerModal.style.display = "block";
          overlay.style.display = "block";
        });

        // Load existing markers
        loadMarkers();
        
        // Make sure map takes up 100% of the screen view
        const mapContainer = document.getElementById("map");
        mapContainer.style.height = "100vh";
        mapContainer.style.width = "100%";
        
        // Force map to update its size after initialization
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
      }
    }

    // Load Markers Function
    function loadMarkers() {
      if (!markers) return;

      markers.clearLayers();

      database.ref("markers").once("value", (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const markerData = childSnapshot.val();
          markerData.id = childSnapshot.key;

          // Filter by selected categories if any are selected
          if (selectedCategories.size === 0 || selectedCategories.has(markerData.category)) {
            addMarkerToMap(markerData);
          }
        });
      });
    }

    // Add Marker to Map Function
    function addMarkerToMap(markerData) {
      // Create a custom icon based on the marker's category
      const markerIcon = L.divIcon({
        className: `custom-marker ${markerData.category || 'architecture'}`,
        html: `<i class="fas fa-map-marker-alt" style="color: ${getCategoryColor(markerData.category)}; font-size: 24px; text-shadow: 2px 2px 3px rgba(0,0,0,0.3);"></i>`,
        iconSize: [24, 24],
        iconAnchor: [12, 24],
        popupAnchor: [0, -20]
      });
      
      const marker = L.marker([markerData.lat, markerData.lng], { icon: markerIcon });
      
      const popupContent = `
        <div class="marker-popup">
          <h2><a href="#" class="title-link" data-marker-id="${markerData.id}">${markerData.title}</a></h2>
          <p class="description">${markerData.description.split(" ").slice(0, 10).join(" ")}${markerData.description.split(" ").length > 10 ? "..." : ""}</p>
        </div>
      `;
      marker.bindPopup(popupContent);

      // Use on('popupopen') instead of trying to access the DOM node directly
      marker.on('popupopen', function() {
        setTimeout(() => {
          const titleLink = document.querySelector(`.title-link[data-marker-id="${markerData.id}"]`);
          if (titleLink) {
            titleLink.addEventListener("click", (e) => {
              e.preventDefault();
              updateMarkerInfoModal(markerData);
              markerInfoModal.style.display = "block";
              overlay.style.display = "block";
              marker.closePopup();
            });
          }
        }, 100); // Small delay to ensure DOM is ready
      });

      markers.addLayer(marker);
    }
    
    // Helper function to get color based on category
    function getCategoryColor(category) {
      switch(category) {
        case 'architecture':
          return '#2563eb';
        case 'nature':
          return '#10b981';
        case 'events':
          return '#f59e0b';
        case 'people':
          return '#8b5cf6';
        default:
          return '#2563eb';
      }
    }

    // Update Marker Info Modal Function
    function updateMarkerInfoModal(data) {
      currentMarkerId = data.id;
      markerInfoTitle.textContent = data.title;

      if (data.image) {
        markerInfoImage.src = data.image;
        markerInfoImage.style.cursor = "pointer";
        markerInfoImage.onclick = () => {
          expandedImageModal.style.display = "flex";
          expandedImage.src = data.image;
          expandedImage.alt = data.title;
          expandedImageTitle.textContent = data.title;
          overlay.style.zIndex = "1000";
          expandedImageModal.style.zIndex = "2000";
        };
      } else {
        markerInfoImage.src = "https://via.placeholder.com/400x300?text=No+Image+Available";
        markerInfoImage.style.cursor = "default";
        markerInfoImage.onclick = null;
      }

      markerInfoImage.alt = data.title;
      
      // Improved uploader display
      const uploaderName = data.uploaderName && data.uploaderName !== "undefined" ? data.uploaderName : "Anonymous";
      markerInfoUploader.querySelector('span').textContent = `Taken by ${uploaderName} on ${new Date(data.date).toLocaleDateString()}`;
      
      // Fix for Issue #1: Display plain text description instead of HTML
      markerInfoDescription.textContent = data.description ? stripHtml(data.description) : "";
      
      markerInfoSource.textContent = data.sourceCitation;
      
      // Fix for Issue #2: Display copyright information
      if (data.copyright) {
        let copyrightText = "";
        if (data.copyright.creativeCommons) {
          copyrightText += "Creative Commons";
        }
        if (data.copyright.authorOwned) {
          copyrightText += copyrightText ? ", Author Owned" : "Author Owned";
        }
        markerInfoCopyright.textContent = `Copyright: ${copyrightText || "Not specified"}`;
      } else {
        markerInfoCopyright.textContent = "Copyright: Not specified";
      }
      
      markerInfoViews.innerHTML = `<i class="fas fa-eye"></i> <span>${data.views || 0} views</span>`;
      markerInfoLikes.innerHTML = `<i class="fas fa-heart"></i> <span>${data.likes || 0} likes</span>`;

      markerInfoCategories.innerHTML = `
        <span class="category-tag ${data.category || 'architecture'}">${data.category ? data.category.charAt(0).toUpperCase() + data.category.slice(1) : 'Uncategorized'}</span>
      `;

      loadComments(data.id).then((comments) => {
        commentsList.innerHTML = comments.length > 0 ?
         comments
           .map(
             (comment) => `
               <div class="comment">
                 <div class="comment-header">
                   <span class="comment-author">${comment.userName && comment.userName !== "undefined" ? comment.userName : "Anonymous"}</span>
                   <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
                 </div>
                 <p class="comment-text">${comment.text}</p>
               </div>
             `
           )
           .join("")
        : "<p>No comments yet. Be the first to comment!</p>";
      });

      database.ref(`markers/${data.id}/views`).transaction((currentViews) => {
        return (currentViews || 0) + 1;
      }).then(() => {
        if (currentUser) {
          updateUserPoints(POINTS.MARKER_VIEW);
        }
      });

      updateLikeButtonState();
    }
    
    // Helper function to strip HTML tags
    function stripHtml(html) {
      const temp = document.createElement("div");
      temp.innerHTML = html;
      return temp.textContent || temp.innerText || "";
    }

    // Load Comments Function
    function loadComments(markerId) {
      return database.ref(`comments/${markerId}`).once("value").then((snapshot) => {
        const comments = [];
        snapshot.forEach((childSnapshot) => {
          comments.push({
            id: childSnapshot.key,
            ...childSnapshot.val(),
          });
        });
        return comments;
      });
    }

    // Update Like Button State Function
    function updateLikeButtonState() {
      if (!currentUser || !currentMarkerId) {
        likeButton.disabled = true;
        likeButton.innerHTML = '<i class="far fa-heart"></i> Login to Like';
        return;
      }

      likeButton.disabled = false;

      database.ref(`likes/${currentMarkerId}/${currentUser.uid}`).once("value", (snapshot) => {
        if (snapshot.exists()) {
          likeButton.classList.add("liked");
          likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
        } else {
          likeButton.classList.remove("liked");
          likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
        }
      });
    }

    // Show Notification Function
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = "block";

      setTimeout(() => {
        notification.style.display = "none";
      }, 3000);
    }

    // Update User Points Function
    function updateUserPoints(points) {
      if (!currentUser) return;

      const userPointsRef = database.ref(`users/${currentUser.uid}/points`);

      userPointsRef.transaction((currentPoints) => {
        return (currentPoints || 0) + points;
      }).then(() => {
        checkForBadges();
      });
    }

    // Check for Badges Function
    function checkForBadges() {
      if (!currentUser) return;

      database.ref(`users/${currentUser.uid}/points`).once("value", (snapshot) => {
        const points = snapshot.val() || 0;
        const earnedBadges = [];

        for (const [badgeId, badge] of Object.entries(BADGES)) {
          if (points >= badge.requirement) {
            earnedBadges.push(badgeId);
          }
        }

        database.ref(`users/${currentUser.uid}/badges`).set(earnedBadges);
      });
    }

    // Load User Data Function
    function loadUserData() {
      if (!currentUser) return;

      database.ref(`users/${currentUser.uid}`).once("value", (snapshot) => {
        const userData = snapshot.val() || {};

        if (userData.firstName && userData.lastName) {
          currentUser.displayName = `${userData.firstName} ${userData.lastName}`;
        }

        // Update UI based on user data
        loginLink.textContent = "Logout";
        loginLink.removeEventListener("click", showLoginPopup);
        loginLink.addEventListener("click", showLogoutPopup);
      });
    }

    // Show Login Popup Function
    function showLoginPopup(e) {
      e.preventDefault();
      authPopup.style.display = "block";
      overlay.style.display = "block";
    }

    // Show Logout Popup Function
    function showLogoutPopup(e) {
      e.preventDefault();
      logoutPopup.style.display = "block";
      overlay.style.display = "block";
    }

    // Initialize Map and Firebase when the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", () => {
      // Show search page first
      searchPage.style.display = "flex";
      mapPage.style.display = "none";

      // Initialize Firebase Auth state
      auth.onAuthStateChanged((user) => {
        currentUser = user;

        if (user) {
          showNotification("Welcome back!", "success");
          loadUserData();
          loginLink.textContent = "Logout";
          loginLink.removeEventListener("click", showLoginPopup);
          loginLink.addEventListener("click", showLogoutPopup);
        } else {
          loginLink.textContent = "Login/Join";
          loginLink.removeEventListener("click", showLogoutPopup);
          loginLink.addEventListener("click", showLoginPopup);
        }
      });

      // Initialize map if mapPage is displayed
      const mapPageObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.attributeName === "style") {
            if (mapPage.style.display === "block" && !map) {
              initializeMap();
            }
          }
        });
      });

      mapPageObserver.observe(mapPage, {
        attributes: true, // Monitor style changes
      });
    });

    // Event Listeners
    floatingBtn.addEventListener("click", () => {
      menuContent.style.display = menuContent.style.display === "block" ? "none" : "block";
    });

    menuContent.addEventListener("click", (e) => {
      if (e.target.tagName === "A") {
        menuContent.style.display = "none";
      }
    });

    showLogin.addEventListener("click", () => {
      loginForm.style.display = "block";
      joinForm.style.display = "none";
      showLogin.classList.add("active");
      showJoin.classList.remove("active");
    });

    showJoin.addEventListener("click", () => {
      loginForm.style.display = "none";
      joinForm.style.display = "block";
      showJoin.classList.add("active");
      showLogin.classList.remove("active");
    });

    closePopup.addEventListener("click", () => {
      authPopup.style.display = "none";
      overlay.style.display = "none";
    });

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginEmail.value;
      const password = loginPassword.value;

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          showNotification("Logged in successfully", "success");
          authPopup.style.display = "none";
          overlay.style.display = "none";
          currentUser = userCredential.user;

          // Load user data (including displayName)
          loadUserData();
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    });

    joinForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = joinEmail.value;
      const password = joinPassword.value;
      const firstName = joinFirstName.value;
      const lastName = joinLastName.value;
      const city = joinCity.value;

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          return database.ref("users/" + userCredential.user.uid).set({
            firstName: firstName,
            lastName: lastName,
            city: city,
            email: email,
            points: 0,
            badges: [],
            joinDate: Date.now(),
          });
        })
        .then(() => {
          showNotification("Account created successfully", "success");
          authPopup.style.display = "none";
          overlay.style.display = "none";
          loadUserData();
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    });

    confirmLogout.addEventListener("click", () => {
      auth.signOut().then(() => {
        showNotification("Logged out successfully", "success");
        logoutPopup.style.display = "none";
        overlay.style.display = "none";
        currentUser = null;
        loginLink.textContent = "Login/Join";
        loginLink.removeEventListener("click", showLogoutPopup);
        loginLink.addEventListener("click", showLoginPopup);
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    });

    cancelLogout.addEventListener("click", () => {
      logoutPopup.style.display = "none";
      overlay.style.display = "none";
    });

    aboutLink.addEventListener("click", (e) => {
      e.preventDefault();
      aboutPopup.style.display = "block";
      overlay.style.display = "block";
    });

    closeAbout.addEventListener("click", () => {
      aboutPopup.style.display = "none";
      overlay.style.display = "none";
    });

    instructionsLink.addEventListener("click", (e) => {
      e.preventDefault();
      instructionsPopup.style.display = "block";
      overlay.style.display = "block";
    });

    closeInstructions.addEventListener("click", () => {
      instructionsPopup.style.display = "none";
      overlay.style.display = "none";
    });

    markerForm.addEventListener("submit", (e) => {
      e.preventDefault();

      // Get form values
      const title = titleInput.value;
      const category = categoryInput.value;
      const description = editor.getContents(); // Get content from Suneditor
      const sourceCitation = sourceCitationInput.value;
      const date = dateInput.value;
      
      // Get copyright information
      const copyright = {
        creativeCommons: creativeCommonsCheckbox.checked,
        authorOwned: authorOwnedCheckbox.checked
      };

      // Check for profanity
      if (containsProfanity(title) || containsProfanity(stripHtml(description)) || containsProfanity(sourceCitation)) {
        showNotification("Please watch your language! Your submission contains inappropriate words.", "error");
        return;
      }

      // Check if a location is selected
      if (!tempMarker) {
        showNotification("Please select a location on the map", "error");
        return;
      }

      // Prepare marker data
      const newMarkerRef = database.ref("markers").push();
      const newMarker = {
        id: newMarkerRef.key,
        title: title,
        category: category,
        description: description,
        lat: tempMarker.getLatLng().lat,
        lng: tempMarker.getLatLng().lng,
        uploaderName: currentUser.displayName || "Anonymous",
        uploaderId: currentUser.uid,
        sourceCitation: sourceCitation,
        date: date,
        timestamp: Date.now(),
        views: 0,
        likes: 0,
        copyright: copyright
      };

      // Handle image upload (if applicable)
      if (imageUpload.files.length > 0) {
        const file = imageUpload.files[0];
        const storageRef = storage.ref("marker_images/" + newMarkerRef.key);

        storageRef.put(file).then((snapshot) => {
          return snapshot.ref.getDownloadURL();
        }).then((downloadURL) => {
          newMarker.image = downloadURL; // Add image URL to marker data
          return newMarkerRef.set(newMarker);
        }).then(() => {
          showNotification("Marker added successfully", "success");
          markerModal.style.display = "none";
          overlay.style.display = "none";
          map.removeLayer(tempMarker);
          tempMarker = null;
          markerForm.reset();
          editor.setContents(""); // Clear Suneditor content
          addMarkerToMap(newMarker);
          updateUserPoints(POINTS.ADD_MARKER);
        }).catch((error) => {
          showNotification(error.message, "error");
        });
      } else {
        // If no image is uploaded
        newMarkerRef.set(newMarker).then(() => {
          showNotification("Marker added successfully", "success");
          markerModal.style.display = "none";
          overlay.style.display = "none";
          map.removeLayer(tempMarker);
          tempMarker = null;
          markerForm.reset();
          editor.setContents(""); // Clear Suneditor content
          addMarkerToMap(newMarker);
          updateUserPoints(POINTS.ADD_MARKER);
        }).catch((error) => {
          showNotification(error.message, "error");
        });
      }
    });

    closeModal.addEventListener("click", () => {
      markerModal.style.display = "none";
      overlay.style.display = "none";
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
    });

    searchButton.addEventListener("click", () => {
      const searchTerm = searchInput.value;
      if (searchTerm.trim() === "") {
        showNotification("Please enter a search term", "error");
        return;
      }

      // Switch to map page
      searchPage.style.display = "none";
      mapPage.style.display = "block";

      // Initialize map if not already done
      if (!map) {
        initializeMap();
      }

      // Perform search
      performSearch(searchTerm);
    });

    mapSearchButton.addEventListener("click", () => {
      const searchTerm = mapSearchInput.value;
      if (searchTerm.trim() === "") {
        showNotification("Please enter a search term", "error");
        return;
      }
      performSearch(searchTerm);
    });

    function performSearch(searchTerm) {
      // Add Minnesota to the search if not already included
      if (!searchTerm.toLowerCase().includes("minnesota") && !searchTerm.toLowerCase().includes("mn")) {
        searchTerm = searchTerm + " Minnesota";
      }
      
      const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}`;
      
      fetch(geocodingUrl)
        .then((response) => response.json())
        .then((data) => {
          // Filter results to only include Minnesota locations
          const mnResults = data.filter(result => {
            // Check if the display name contains Minnesota or MN
            return (result.display_name.toLowerCase().includes("minnesota") || 
                    result.display_name.toLowerCase().includes(", mn,")) &&
                   // Verify the result is in the US
                   result.display_name.toLowerCase().includes("united states");
          });
          
          if (mnResults.length > 0) {
            const result = mnResults[0];
            map.setView([result.lat, result.lon], 13);
            
            // Use correct singular/plural form based on number of results
            const resultText = mnResults.length === 1 ? "result" : "results";
            showNotification(`Found ${mnResults.length} ${resultText} for "${searchTerm}"`, "success");
          } else {
            showNotification("No locations found in Minnesota", "error");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showNotification("An error occurred while searching", "error");
        });
    }

    scrollDown.addEventListener("click", () => {
      searchPage.style.display = "none";
      mapPage.style.display = "block";

      // Initialize map if not already done
      if (!map) {
        initializeMap();
      }
    });

    homeLink.addEventListener("click", (e) => {
      e.preventDefault();
      searchPage.style.display = "flex";
      mapPage.style.display = "none";
    });

    likeButton.addEventListener("click", () => {
      if (!currentUser) {
        showNotification("Please log in to like markers", "error");
        return;
      }

      if (!currentMarkerId) return;

      const likeRef = database.ref(`likes/${currentMarkerId}/${currentUser.uid}`);
      const markerLikesRef = database.ref(`markers/${currentMarkerId}/likes`);

      likeRef.once("value", (snapshot) => {
        if (snapshot.exists()) {
          // User has already liked, so unlike
          likeRef.remove();
          markerLikesRef.transaction((currentLikes) => (currentLikes || 1) - 1);
          likeButton.classList.remove("liked");
          likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
          showNotification("You unliked this marker", "success");
        } else {
          // User hasn't liked, so add like
          likeRef.set(true);
          markerLikesRef.transaction((currentLikes) => (currentLikes || 0) + 1);
          likeButton.classList.add("liked");
          likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
          showNotification("You liked this marker", "success");

          // Update marker uploader's points
          database.ref(`markers/${currentMarkerId}`).once("value", (snapshot) => {
            const markerData = snapshot.val();
            if (markerData && markerData.uploaderId && markerData.uploaderId !== currentUser.uid) {
              const uploaderPointsRef = database.ref(`users/${markerData.uploaderId}/points`);
              uploaderPointsRef.transaction((currentPoints) => (currentPoints || 0) + POINTS.RECEIVE_LIKE);
            }
          });
        }
      });
    });

    addToCollectionButton.addEventListener("click", () => {
      if (!currentUser) {
        showNotification("Please log in to add markers to collections", "error");
        return;
      }

      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }

      showCollectionSelector(currentMarkerId);
    });

    reportButton.addEventListener("click", () => {
      if (!currentUser) {
        showNotification("Please log in to report markers", "error");
        return;
      }

      reportModal.style.display = "block";
      overlay.style.display = "block";
    });

    document.getElementById("reportForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const reason = e.target.querySelector("select").value;
      const details = e.target.querySelector("textarea").value;

      // Check for profanity
      if (containsProfanity(details)) {
        showNotification("Please watch your language! Your report contains inappropriate words.", "error");
        return;
      }

      if (!currentUser) {
        showNotification("Please log in to report markers", "error");
        return;
      }

      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }

      const reportRef = database.ref("reports").push();
      reportRef.set({
        markerId: currentMarkerId,
        reporterId: currentUser.uid,
        reporterName: currentUser.displayName || "Anonymous",
        reason: reason,
        details: details,
        timestamp: Date.now(),
        status: "pending",
      }).then(() => {
        showNotification("Report submitted successfully", "success");
        reportModal.style.display = "none";
        overlay.style.display = "none";
        e.target.reset();
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    });

    commentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = e.target.querySelector("textarea").value;

      // Check for profanity
      if (containsProfanity(text)) {
        showNotification("Please watch your language! Your comment contains inappropriate words.", "error");
        return;
      }

      if (!currentUser) {
        showNotification("Please  "error");
        return;
      }

      if (!currentUser) {
        showNotification("Please log in to add comments", "error");
        return;
      }

      if (!currentMarkerId) {
        showNotification("No marker selected", "error");
        return;
      }

      const commentRef = database.ref(`comments/${currentMarkerId}`).push();
      commentRef.set({
        userId: currentUser.uid,
        userName: currentUser.displayName || "Anonymous", 
        text: text,
        timestamp: Date.now(),
      }).then(() => {
        showNotification("Comment added successfully", "success");
        e.target.reset();
        updateUserPoints(POINTS.ADD_COMMENT);

        // Reload comments
        loadComments(currentMarkerId).then((comments) => {
          commentsList.innerHTML = comments
            .map(
              (comment) => `
                <div class="comment">
                  <div class="comment-header">
                    <span class="comment-author">${comment.userName && comment.userName !== "undefined" ? comment.userName : "Anonymous"}</span>
                    <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
                  </div>
                  <p class="comment-text">${comment.text}</p>
                </div>
              `
            )
            .join("");
        });
      }).catch((error) => {
        showNotification(error.message, "error");
      });
    });

    document.querySelectorAll(".share-button").forEach((button) => {
      button.addEventListener("click", () => {
        if (!currentMarkerId) {
          showNotification("No marker selected", "error");
          return;
        }

        const platform = button.classList[1];
        const markerData = {
          title: markerInfoTitle.textContent,
          description: markerInfoDescription.textContent,
        };

        shareMarker(platform, markerData);
      });
    });

    closeMarkerInfo.addEventListener("click", () => {
      markerInfoModal.style.display = "none";
      overlay.style.display = "none";
    });

    expandedImageModal.addEventListener("click", (e) => {
      if (e.target === expandedImageModal) {
        expandedImageModal.style.display = "none";
        overlay.style.zIndex = "1000";
      }
    });

    collectionsLink.addEventListener("click", (e) => {
      e.preventDefault();

      if (!currentUser) {
        showNotification("Please log in to view collections", "error");
        return;
      }

      loadCollections();
      collectionsModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeCollections.addEventListener("click", () => {
      collectionsModal.style.display = "none";
      overlay.style.display = "none";
    });

    closeCollectionMarkers.addEventListener("click", () => {
      collectionMarkersModal.style.display = "none";
      overlay.style.display = "none";
    });

    leaderboardLink.addEventListener("click", (e) => {
      e.preventDefault();
      loadLeaderboard();
      leaderboardModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeLeaderboard.addEventListener("click", () => {
      leaderboardModal.style.display = "none";
      overlay.style.display = "none";
    });

    closeReport.addEventListener("click", () => {
      reportModal.style.display = "none";
      overlay.style.display = "none";
    });

    categoryBadges.forEach((badge) => {
      badge.addEventListener("click", () => {
        const category = badge.dataset.category;

        if (badge.classList.contains("active")) {
          badge.classList.remove("active");
          selectedCategories.delete(category);
        } else {
          badge.classList.add("active");
          selectedCategories.add(category);
        }

        loadMarkers();
      });
    });

    infoButton.addEventListener("click", () => {
      citationModal.style.display = "block";
      overlay.style.display = "block";
    });

    closeCitation.addEventListener("click", () => {
      citationModal.style.display = "none";
      overlay.style.display = "none";
    });

    recenterButton.addEventListener("click", () => {
      if (map) {
        map.setView([44.9778, -93.265], 10);
      }
    });

    // Collections Feature
    function loadCollections() {
      if (!currentUser) return;

      const collectionsGrid = document.getElementById("collectionsGrid");
      collectionsGrid.innerHTML = '<div class="loading">Loading collections...</div>';

      database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
        if (!snapshot.exists()) {
          collectionsGrid.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
          return;
        }

        const collections = [];
        snapshot.forEach((childSnapshot) => {
          collections.push({
            id: childSnapshot.key,
            ...childSnapshot.val(),
          });
        });

        if (collections.length === 0) {
          collectionsGrid.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
          return;
        }

        collectionsGrid.innerHTML = collections
          .map(
            (collection) => `
              <div class="collection-card">
                <img src="${collection.image || "https://via.placeholder.com/300x150?text=Collection"}" class="collection-image" alt="${collection.name}">
                <div class="collection-actions">
                  <button class="collection-action-btn view-collection" data-collection-id="${collection.id}" title="View Markers">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="collection-action-btn delete-collection" data-collection-id="${collection.id}" title="Delete Collection">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                <div class="collection-info">
                  <h3 class="collection-title">${collection.name}</h3>
                  <p>${collection.description || "No description"}</p>
                  <div class="collection-stats">
                    <span><i class="fas fa-map-marker-alt"></i> ${Object.keys(collection.markers || {}).length} markers</span>
                    <span><i class="fas fa-calendar-alt"></i> Created ${new Date(collection.created).toLocaleDateString()}</span>
                  </div>
                </div>
              </div>
            `
          )
          .join("");
          
        // Add event listeners to the view and delete buttons
        document.querySelectorAll('.view-collection').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
            viewCollectionMarkers(collectionId);
          });
        });
        
        document.querySelectorAll('.delete-collection').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
            deleteCollection(collectionId);
          });
        });
      });
    }

    document.getElementById("createCollectionBtn").addEventListener("click", () => {
      const name = prompt("Enter collection name:");
      if (!name) return;
      
      const description = prompt("Enter collection description (optional):");
      
      createCollection(name, description)
        .then(() => {
          showNotification("Collection created successfully", "success");
          loadCollections();
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    });

    function createCollection(name, description) {
      if (!currentUser) return Promise.reject(new Error("User not logged in"));

      const collectionRef = database.ref(`collections/${currentUser.uid}`).push();
      return collectionRef.set({
        name,
        description,
        created: Date.now(),
        markers: {},
      }).then(() => collectionRef.key);
    }

    function addMarkerToCollection(markerId, collectionId) {
      if (!currentUser) return Promise.reject(new Error("User not logged in"));

      return database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).set(true)
        .then(() => {
          showNotification("Marker added to collection", "success");
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    }

    function viewCollectionMarkers(collectionId) {
      if (!currentUser) return;
      
      currentCollectionId = collectionId;
      
      database.ref(`collections/${currentUser.uid}/${collectionId}`).once("value", (snapshot) => {
        const collection = snapshot.val();
        if (!collection) {
          showNotification("Collection not found", "error");
          return;
        }
        
        collectionMarkersTitle.textContent = collection.name;
        collectionMarkersDescription.textContent = collection.description || "View and manage markers in this collection.";
        
        // Get markers in this collection
        const markerIds = Object.keys(collection.markers || {});
        
        if (markerIds.length === 0) {
          collectionMarkersList.innerHTML = "<p>No markers in this collection yet.</p>";
          collectionMarkersModal.style.display = "block";
          overlay.style.display = "block";
          return;
        }
        
        collectionMarkersList.innerHTML = '<div class="loading">Loading markers...</div>';
        
        // Fetch marker details for each marker ID
        const markerPromises = markerIds.map(markerId => 
          database.ref(`markers/${markerId}`).once("value").then(snapshot => {
            const markerData = snapshot.val();
            if (markerData) {
              markerData.id = markerId;
              return markerData;
            }
            return null;
          })
        );
        
        Promise.all(markerPromises).then(markers => {
          const validMarkers = markers.filter(marker => marker !== null);
          
          if (validMarkers.length === 0) {
            collectionMarkersList.innerHTML = "<p>No valid markers found in this collection.</p>";
            return;
          }
          
          collectionMarkersList.innerHTML = validMarkers
            .map(marker => `
              <div class="collection-marker-item">
                <button class="remove-from-collection" data-marker-id="${marker.id}" title="Remove from collection">
                  <i class="fas fa-times"></i>
                </button>
                <h4 class="collection-marker-title">${marker.title}</h4>
                <span class="collection-marker-category ${marker.category}">${marker.category}</span>
                <p>${stripHtml(marker.description).substring(0, 100)}${stripHtml(marker.description).length > 100 ? '...' : ''}</p>
                <button class="btn btn-primary view-marker-btn" data-marker-id="${marker.id}">View Marker</button>
              </div>
            `)
            .join('');
            
          // Add event listeners to the view and remove buttons
          document.querySelectorAll('.view-marker-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const markerId = e.target.dataset.markerId;
              viewMarkerFromCollection(markerId);
            });
          });
          
          document.querySelectorAll('.remove-from-collection').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const markerId = e.target.closest('.remove-from-collection').dataset.markerId;
              removeMarkerFromCollection(markerId, collectionId);
            });
          });
        });
        
        collectionMarkersModal.style.display = "block";
        overlay.style.display = "block";
      });
    }

    function viewMarkerFromCollection(markerId) {
      database.ref(`markers/${markerId}`).once("value", (snapshot) => {
        const markerData = snapshot.val();
        if (markerData) {
          markerData.id = markerId;
          updateMarkerInfoModal(markerData);
          collectionMarkersModal.style.display = "none";
          markerInfoModal.style.display = "block";
        } else {
          showNotification("Marker not found", "error");
        }
      });
    }

    function removeMarkerFromCollection(markerId, collectionId) {
      if (!currentUser || !collectionId) return;
      
      database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).remove()
        .then(() => {
          showNotification("Marker removed from collection", "success");
          // Refresh the collection markers view
          viewCollectionMarkers(collectionId);
        })
        .catch(error => {
          showNotification(error.message, "error");
        });
    }

    function deleteCollection(collectionId) {
      if (!currentUser) return;
      
      if (confirm("Are you sure you want to delete this collection? This action cannot be undone.")) {
        database.ref(`collections/${currentUser.uid}/${collectionId}`).remove()
          .then(() => {
            showNotification("Collection deleted successfully", "success");
            loadCollections();
          })
          .catch(error => {
            showNotification(error.message, "error");
          });
      }
    }

    function showCollectionSelector(markerId) {
      if (!currentUser) {
        showNotification("Please log in to add markers to collections", "error");
        return;
      }

      const collectionSelectorModal = document.createElement("div");
      collectionSelectorModal.className = "modal-base";
      collectionSelectorModal.innerHTML = `
        <button class="close-btn">&times;</button>
        <h2>Add to Collection</h2>
        <div id="collectionList" class="collections-grid"></div>
        <button id="newCollectionBtn" class="btn btn-primary">Create New Collection</button>
      `;
      document.body.appendChild(collectionSelectorModal);
      collectionSelectorModal.style.display = "block";
      overlay.style.display = "block";

      const closeBtn = collectionSelectorModal.querySelector(".close-btn");
      closeBtn.addEventListener("click", () => {
        collectionSelectorModal.style.display = "none";
        overlay.style.display = "none";
        collectionSelectorModal.remove();
      });

      const collectionList = document.getElementById("collectionList");
      const newCollectionBtn = document.getElementById("newCollectionBtn");

      loadUserCollections(collectionList, markerId);

      newCollectionBtn.addEventListener("click", () => createNewCollection(markerId));
    }

    function loadUserCollections(collectionList, markerId) {
      database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
        collectionList.innerHTML = "";
        
        if (!snapshot.exists()) {
          collectionList.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
          return;
        }
        
        const collections = [];
        snapshot.forEach((childSnapshot) => {
          collections.push({
            id: childSnapshot.key,
            ...childSnapshot.val(),
          });
        });

        if (collections.length === 0) {
          collectionList.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
          return;
        }

        collectionList.innerHTML = collections
          .map(
            (collection) => `
              <div class="collection-card">
                <img src="${collection.image || "https://via.placeholder.com/300x150?text=Collection"}" class="collection-image" alt="${collection.name}">
                <div class="collection-info">
                  <h3 class="collection-title">${collection.name}</h3>
                  <p>${collection.description || "No description"}</p>
                  <button class="btn btn-primary add-to-collection-btn" data-collection-id="${collection.id}" data-marker-id="${markerId}">Add to this collection</button>
                </div>
              </div>
            `
          )
          .join("");
          
        // Add event listeners to the newly created buttons
        document.querySelectorAll('.add-to-collection-btn[data-marker-id]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const collectionId = e.target.dataset.collectionId;
            const markerId = e.target.dataset.markerId;
            addMarkerToCollection(markerId, collectionId);
            document.querySelector('.modal-base').style.display = "none";
            overlay.style.display = "none";
            document.querySelector('.modal-base').remove();
          });
        });
      });
    }

    function createNewCollection(markerId) {
      const name = prompt("Enter collection name:");
      if (!name) return;
      
      const description = prompt("Enter collection description (optional):");
      
      createCollection(name, description)
        .then((collectionId) => {
          addMarkerToCollection(markerId, collectionId);
          showNotification("Marker added to new collection", "success");
        })
        .catch((error) => {
          showNotification(error.message, "error");
        });
    }

    // Leaderboard Feature
    function loadLeaderboard() {
      const leaderboardList = document.getElementById("leaderboardList");
      leaderboardList.innerHTML = '<div class="loading">Loading leaderboard...</div>';

      database.ref("users")
        .orderByChild("points")
        .limitToLast(10)
        .once("value", (snapshot) => {
          const users = [];
          snapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            // Only add users with valid names
            if (userData.firstName && userData.lastName) {
              users.push({
                id: childSnapshot.key,
                ...userData,
              });
            }
          });

          users.reverse(); // Highest points first

          if (users.length === 0) {
            leaderboardList.innerHTML = "<p>No users on the leaderboard yet.</p>";
            return;
          }

          leaderboardList.innerHTML = `
            <div class="leaderboard-title">Top Contributors</div>
            ${users
              .map(
                (user, index) => `
                <div class="leaderboard-item">
                  <div class="leaderboard-rank">${index + 1}</div>
                  <div class="leaderboard-user">${user.firstName} ${user.lastName}</div>
                  <div class="leaderboard-points">${user.points || 0} pts</div>
                </div>
              `
              )
              .join("")}
          `;
        });
    }

    // Social Sharing
    function shareMarker(platform, marker) {
      const url = window.location.href;
      const text = `Check out this interesting location in Minnesota: ${marker.title}`;

      const shareUrls = {
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
        twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
        linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(marker.title)}`,
      };

      window.open(shareUrls[platform], "_blank");
    }

    // Document click handler for closing modals when clicking outside
    document.addEventListener("click", (e) => {
      if (e.target === overlay) {
        document.querySelectorAll(".modal-base").forEach((modal) => {
          modal.style.display = "none";
        });
        expandedImageModal.style.display = "none";
        overlay.style.display = "none";
      }
    });

    // Make sure the map takes up 100% of the screen view when displayed
    window.addEventListener('resize', () => {
      if (map) {
        map.invalidateSize();
      }
    });

    </script>
</body>
</html>
