<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then - A Community History Wiki</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --wiki-bg: #ffffff;
            --wiki-text: #202122;
            --wiki-link: #0645ad;
            --wiki-link-visited: #0b0080;
            --wiki-link-new: #cc2200;
            --wiki-border: #a2a9b1;
            --wiki-header: #f8f9fa;
            --wiki-sidebar: #f6f6f6;
            --wiki-blue: #3366cc;
            --wiki-gray: #72777d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Lato, Helvetica, Arial, sans-serif;
            background-color: var(--wiki-bg);
            color: var(--wiki-text);
            line-height: 1.6;
            font-size: 14px;
        }

        /* Wikipedia-style header */
        .wiki-header {
            background-color: var(--wiki-header);
            border-bottom: 1px solid var(--wiki-border);
            padding: 0.5rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .wiki-title {
            font-family: Linux Libertine, Georgia, Times, serif;
            font-size: 1.8rem;
            color: var(--wiki-text);
            font-weight: normal;
            margin: 0;
        }

        .wiki-subtitle {
            font-style: italic;
            color: var(--wiki-gray);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Wikipedia-style sidebar */
        .sidebar {
            background-color: var(--wiki-sidebar);
            border-right: 1px solid var(--wiki-border);
            padding: 0.5rem;
            min-height: calc(100vh - 80px);
        }

        .sidebar h5 {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--wiki-text);
            margin: 1rem 0 0.5rem 0;
            padding: 0.25rem 0.5rem;
            border-bottom: 1px solid var(--wiki-border);
        }

        .sidebar .nav-link {
            color: var(--wiki-link);
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
            border-radius: 0;
        }

        .sidebar .nav-link:hover {
            color: var(--wiki-link);
            background-color: #eee;
            text-decoration: underline;
        }

        .sidebar .nav-link.active {
            background-color: #e3f2fd;
            color: var(--wiki-text);
            font-weight: bold;
        }

        /* Main content area */
        .content-area {
            background-color: var(--wiki-bg);
            padding: 1rem 1.5rem;
            min-height: calc(100vh - 80px);
        }

        /* Wikipedia-style page title */
        #page-title {
            font-family: Linux Libertine, Georgia, Times, serif;
            font-size: 2.2rem;
            font-weight: normal;
            color: var(--wiki-text);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: 0.25rem;
        }

        /* Page metadata */
        .content-meta {
            font-size: 0.8rem;
            color: var(--wiki-gray);
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        /* Wikipedia-style tabs */
        .page-tabs {
            border-bottom: 1px solid var(--wiki-border);
            margin-bottom: 1rem;
        }

        .page-tabs .nav-link {
            border: 1px solid transparent;
            border-bottom: none;
            background-color: var(--wiki-header);
            color: var(--wiki-link);
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            margin-right: 0.25rem;
        }

        .page-tabs .nav-link:hover {
            background-color: #fff;
            text-decoration: underline;
        }

        .page-tabs .nav-link.active {
            background-color: #fff;
            border-color: var(--wiki-border);
            color: var(--wiki-text);
            font-weight: bold;
        }

        /* Table of Contents */
        .toc {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: 1rem;
            margin: 1rem 0;
            width: fit-content;
            float: right;
            max-width: 300px;
            font-size: 0.9rem;
        }

        .toc-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .toc ul {
            list-style-type: none;
            padding-left: 1rem;
            margin: 0;
        }

        .toc li {
            margin: 0.2rem 0;
        }

        .toc a {
            color: var(--wiki-link);
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        /* Wikipedia-style sections */
        .wiki-section {
            margin-bottom: 2rem;
            clear: both;
        }

        .wiki-section h2 {
            font-family: Linux Libertine, Georgia, Times, serif;
            font-size: 1.5rem;
            font-weight: normal;
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: 0.25rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .wiki-section h3 {
            font-family: Linux Libertine, Georgia, Times, serif;
            font-size: 1.2rem;
            font-weight: normal;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--wiki-link);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        a:visited {
            color: var(--wiki-link-visited);
        }

        .new-page-link {
            color: var(--wiki-link-new);
        }

        /* Search box */
        .search-container {
            margin: 1rem 0;
        }

        .search-container input {
            font-size: 0.85rem;
            border: 1px solid var(--wiki-border);
        }

        .search-container button {
            font-size: 0.85rem;
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            color: var(--wiki-text);
        }

        /* Edit toolbar */
        .edit-toolbar {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: 0.5rem;
            margin-bottom: 1rem;
        }

        .edit-toolbar button {
            margin-right: 0.5rem;
            font-size: 0.8rem;
        }

        /* References */
        .references {
            font-size: 0.85rem;
            border-top: 1px solid var(--wiki-border);
            margin-top: 2rem;
            padding-top: 1rem;
        }

        .reference {
            color: var(--wiki-link);
            font-size: 0.75rem;
            text-decoration: none;
        }

        /* Infobox styling */
        .infobox {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: 1rem;
            margin: 0 0 1rem 1rem;
            width: 300px;
            float: right;
            font-size: 0.9rem;
        }

        .infobox-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--wiki-border);
        }

        /* Notices and status boxes */
        .notice-box {
            background-color: #fef6e7;
            border: 1px solid #fc3;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 3px;
        }

        .approval-pending {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 3px;
        }

        /* Footer */
        .wiki-footer {
            background-color: var(--wiki-header);
            border-top: 1px solid var(--wiki-border);
            padding: 2rem 0;
            margin-top: 3rem;
            font-size: 0.8rem;
        }

        /* Auth status */
        #auth-status {
            font-size: 0.85rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                border-right: none;
                border-bottom: 1px solid var(--wiki-border);
                margin-bottom: 1rem;
                min-height: auto;
            }

            .toc {
                float: none;
                width: 100%;
                max-width: none;
            }

            .infobox {
                float: none;
                width: 100%;
                margin: 1rem 0;
            }

            .wiki-title {
                font-size: 1.5rem;
                text-align: center;
            }

            #page-title {
                font-size: 1.8rem;
            }
        }

        /* Print styles */
        @media print {
            .sidebar, .wiki-header, .wiki-footer, .edit-toolbar, #auth-status {
                display: none !important;
            }
            
            .content-area {
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <header class="wiki-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="wiki-title">Minnesota Then</h1>
                    <p class="wiki-subtitle">A Community History Wiki</p>
                </div>
                <div class="col-md-4">
                    <div id="auth-status" class="d-flex justify-content-end">
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                        <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid">
        <div class="row">
            <div class="col-md-2">
                <div class="sidebar">
                    <h5>Navigation</h5>
                    <ul class="nav flex-column" id="sidebar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="home">Main page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recent-changes">Recent changes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="random-page">Random article</a>
                        </li>
                    </ul>

                    <h5>Tools</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="help">Help</a>
                        </li>
                        <li class="nav-item" id="create-page-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="create-page">Create a page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="special-pages">Special pages</a>
                        </li>
                    </ul>

                    <div class="search-container">
                        <h5>Search</h5>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="search-input" placeholder="Search Minnesota Then">
                            <button class="btn btn-outline-secondary" id="search-btn">Go</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <div class="content-area">
                    <!-- Page tabs (Wikipedia-style) -->
                    <ul class="nav nav-tabs page-tabs" id="page-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-tab="article">Article</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="discussion">Discussion</a>
                        </li>
                        <li class="nav-item" id="edit-tab" style="display: none;">
                            <a class="nav-link" href="#" data-tab="edit">Edit</a>
                        </li>
                        <li class="nav-item" id="history-tab">
                            <a class="nav-link" href="#" data-tab="history">View history</a>
                        </li>
                    </ul>

                    <div id="page-header">
                        <h1 id="page-title">Welcome to Minnesota Then</h1>
                        <div class="content-meta" id="page-meta">
                            <span id="page-info"></span>
                            <span id="page-actions" class="float-end"></span>
                        </div>
                    </div>

                    <div id="page-content">
                        <div class="toc" id="toc">
                            <div class="toc-title">Contents</div>
                            <ul>
                                <li>1 <a href="#introduction">Introduction</a></li>
                                <li>2 <a href="#getting-started">Getting started</a></li>
                                <li>3 <a href="#featured">Featured articles</a></li>
                                <li>4 <a href="#community">Community</a></li>
                            </ul>
                        </div>

                        <section id="introduction" class="wiki-section">
                            <h2>Introduction</h2>
                            <p>Welcome to <strong>Minnesota Then</strong>, a community-driven historical wiki dedicated to preserving and sharing the rich history of Minnesota. Our goal is to create a comprehensive resource that documents the people, places, events, and stories that have shaped our state from its earliest inhabitants to the present day.</p>
                            
                            <p>This wiki serves as a collaborative platform where historians, researchers, students, and anyone with an interest in Minnesota's past can contribute their knowledge and discoveries. Whether you're researching your family history, exploring local landmarks, or studying significant historical events, Minnesota Then provides a reliable and comprehensive resource.</p>
                        </section>

                        <section id="getting-started" class="wiki-section">
                            <h2>Getting started</h2>
                            <p>Contributing to Minnesota Then is easy and rewarding:</p>
                            <ul>
                                <li><strong>Create an account</strong> to start contributing to articles</li>
                                <li><strong>Browse existing articles</strong> to get familiar with our style and standards</li>
                                <li><strong>Add new content</strong> or improve existing articles with additional information</li>
                                <li><strong>Cite your sources</strong> to maintain the reliability of information</li>
                                <li><strong>Follow our guidelines</strong> for writing neutral, encyclopedic content</li>
                            </ul>
                            
                            <div class="notice-box">
                                <strong>Note:</strong> All contributions are reviewed by our community of editors before publication to ensure accuracy and quality.
                            </div>
                        </section>

                        <section id="featured" class="wiki-section">
                            <h2>Featured articles</h2>
                            <p>Explore some of our comprehensive, well-researched articles:</p>
                            <div id="featured-articles">
                                <p><em>Loading featured articles...</em></p>
                            </div>
                        </section>

                        <section id="community" class="wiki-section">
                            <h2>Community</h2>
                            <p>Minnesota Then is built and maintained by a community of volunteers who share a passion for Minnesota history. Join us in preserving the stories that make our state unique.</p>
                            
                            <h3>How to help</h3>
                            <ul>
                                <li>Add articles about your local community</li>
                                <li>Upload historical photographs and documents</li>
                                <li>Improve existing articles with additional sources</li>
                                <li>Help with proofreading and fact-checking</li>
                                <li>Share your expertise on specific topics or time periods</li>
                            </ul>
                        </section>
                    </div>

                    <div id="edit-section" class="mt-4" style="display: none;">
                        <div class="edit-toolbar">
                            <strong>Editing tools:</strong>
                            <button class="btn btn-sm btn-outline-secondary" data-format="header">Heading</button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="bold">Bold</button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="italic">Italic</button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="link">Link</button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="reference">Reference</button>
                        </div>
                        <form id="edit-form">
                            <div class="mb-3">
                                <label for="edit-title" class="form-label">Article title</label>
                                <input type="text" class="form-control" id="edit-title" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-content" class="form-label">Content</label>
                                <textarea class="form-control" id="edit-content" rows="20" required placeholder="Write your article content here. Use wiki markup for formatting."></textarea>
                                <small class="form-text text-muted">Use == for headings, ** for bold, * for italic, and [[Link]] for internal links.</small>
                            </div>
                            <div class="mb-3">
                                <label for="edit-summary" class="form-label">Edit summary</label>
                                <input type="text" class="form-control" id="edit-summary" placeholder="Briefly describe your changes" maxlength="200">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="minor-edit">
                                <label class="form-check-label" for="minor-edit">
                                    This is a minor edit
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                            <button type="button" class="btn btn-secondary" id="show-preview">Show preview</button>
                            <button type="button" class="btn btn-outline-secondary" id="cancel-edit">Cancel</button>
                        </form>
                        
                        <div id="edit-preview" class="mt-3" style="display: none;">
                            <h4>Preview</h4>
                            <div class="border p-3" id="edit-preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="wiki-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h5>Minnesota Then</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="about">About Minnesota Then</a></li>
                        <li><a href="#" data-page="disclaimers">General disclaimer</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contribute</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="help">Help</a></li>
                        <li><a href="#" data-page="community-portal">Community portal</a></li>
                        <li><a href="#" data-page="recent-changes">Recent changes</a></li>
                        <li><a href="#" data-page="contact">Contact page</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Tools</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="special-pages">Special pages</a></li>
                        <li><a href="#" data-page="permanent-link">Permanent link</a></li>
                        <li><a href="#" data-page="page-information">Page information</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Legal</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="privacy">Privacy policy</a></li>
                        <li><a href="#" data-page="terms">Terms of use</a></li>
                        <li><small>Content is available under <a href="#" data-page="license">CC BY-SA 4.0</a></small></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <small>© 2024 Minnesota Then Community. Powered by community contributions.</small>
            </div>
        </div>
    </footer>

    <!-- Same modals as before -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Log in</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="mb-3">
                            <label for="auth-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="auth-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div id="auth-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary" id="auth-submit-btn">Log in</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link" id="switch-auth-mode">Create an account</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // [Previous JavaScript code with enhancements]
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };

        // Initialize Firebase
        let firebaseApp;
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Enhanced DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authStatus = document.getElementById('auth-status');
        const authModal = new bootstrap.Modal(document.getElementById('authModal'));
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authModalTitle = document.getElementById('authModalTitle');
        const switchAuthMode = document.getElementById('switch-auth-mode');
        const authError = document.getElementById('auth-error');
        const pageTitle = document.getElementById('page-title');
        const pageContent = document.getElementById('page-content');
        const pageInfo = document.getElementById('page-info');
        const pageActions = document.getElementById('page-actions');
        const editSection = document.getElementById('edit-section');
        const editForm = document.getElementById('edit-form');
        const editTitle = document.getElementById('edit-title');
        const editContent = document.getElementById('edit-content');
        const editPreview = document.getElementById('edit-preview');
        const editPreviewContent = document.getElementById('edit-preview-content');
        const editSummary = document.getElementById('edit-summary');
        const cancelEdit = document.getElementById('cancel-edit');
        const showPreview = document.getElementById('show-preview');
        const createPageItem = document.getElementById('create-page-item');
        const editTab = document.getElementById('edit-tab');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const sidebarNav = document.getElementById('sidebar-nav');
        const pageTabs = document.getElementById('page-tabs');

        // State variables
        let isLoginMode = true;
        let currentPageId = 'home';
        let currentUser = null;
        let isEditing = false;
        let currentTab = 'article';

        // Initialize the app
        function init() {
            setupAuth();
            setupNavigation();
            setupEditor();
            setupTabs();
            loadPage(currentPageId);
            loadFeaturedArticles();
        }

        // Enhanced authentication
        function setupAuth() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateAuthUI();
                updatePageActions();
            });

            loginBtn?.addEventListener('click', () => {
                isLoginMode = true;
                updateAuthModalUI();
                authModal.show();
            });

            signupBtn?.addEventListener('click', () => {
                isLoginMode = false;
                updateAuthModalUI();
                authModal.show();
            });

            switchAuthMode.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                updateAuthModalUI();
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = authEmail.value;
                const password = authPassword.value;

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                    }
                    authModal.hide();
                } catch (error) {
                    authError.textContent = error.message;
                    authError.classList.remove('d-none');
                }
            });
        }

        function updateAuthModalUI() {
            authModalTitle.textContent = isLoginMode ? 'Log in' : 'Create account';
            authSubmitBtn.textContent = isLoginMode ? 'Log in' : 'Create account';
            switchAuthMode.textContent = isLoginMode ? 'Create an account' : 'Already have an account?';
            authForm.reset();
            authError.classList.add('d-none');
        }

        function updateAuthUI() {
            if (currentUser) {
                authStatus.innerHTML = `
                    <span class="user-greeting me-2">Welcome, ${currentUser.email.split('@')[0]}</span>
                    <button id="logout-btn" class="btn btn-outline-primary btn-sm">Log out</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                createPageItem.style.display = 'block';
                editTab.style.display = 'block';
            } else {
                authStatus.innerHTML = `
                    <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                    <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                `;

        document.getElementById('login-btn').addEventListener('click', () => {
                   isLoginMode = true;
                   updateAuthModalUI();
                   authModal.show();
               });
               document.getElementById('signup-btn').addEventListener('click', () => {
                   isLoginMode = false;
                   updateAuthModalUI();
                   authModal.show();
               });
               createPageItem.style.display = 'none';
               editTab.style.display = 'none';
           }
       }

       // Enhanced navigation
       function setupNavigation() {
           sidebarNav.addEventListener('click', (e) => {
               e.preventDefault();
               if (e.target.tagName === 'A') {
                   const pageId = e.target.getAttribute('data-page');
                   if (pageId) {
                       loadPage(pageId);
                       updateActiveNavLink(e.target);
                   }
               }
           });

           searchBtn.addEventListener('click', () => {
               const searchTerm = searchInput.value.trim();
               if (searchTerm) {
                   searchPages(searchTerm);
               }
           });

           searchInput.addEventListener('keypress', (e) => {
               if (e.key === 'Enter') {
                   const searchTerm = searchInput.value.trim();
                   if (searchTerm) {
                       searchPages(searchTerm);
                   }
               }
           });
       }

       function updateActiveNavLink(activeLink) {
           // Remove active class from all nav links
           sidebarNav.querySelectorAll('.nav-link').forEach(link => {
               link.classList.remove('active');
           });
           // Add active class to clicked link
           activeLink.classList.add('active');
       }

       // Tab system setup
       function setupTabs() {
           pageTabs.addEventListener('click', (e) => {
               e.preventDefault();
               if (e.target.tagName === 'A') {
                   const tabId = e.target.getAttribute('data-tab');
                   if (tabId) {
                       switchTab(tabId);
                   }
               }
           });
       }

       function switchTab(tabId) {
           currentTab = tabId;
           
           // Update tab appearance
           pageTabs.querySelectorAll('.nav-link').forEach(link => {
               link.classList.remove('active');
           });
           document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

           // Show appropriate content
           switch (tabId) {
               case 'article':
                   pageContent.style.display = 'block';
                   editSection.style.display = 'none';
                   break;
               case 'discussion':
                   showDiscussion();
                   break;
               case 'edit':
                   if (currentUser) {
                       startEditing();
                   } else {
                       alert('Please log in to edit pages.');
                       switchTab('article');
                   }
                   break;
               case 'history':
                   showHistory();
                   break;
           }
       }

       // Enhanced editor setup
       function setupEditor() {
           const toolbar = document.querySelector('.edit-toolbar');
           toolbar.addEventListener('click', (e) => {
               if (e.target.hasAttribute('data-format')) {
                   const format = e.target.getAttribute('data-format');
                   insertFormat(format);
               }
           });

           editContent.addEventListener('input', () => {
               updateLivePreview();
           });

           showPreview.addEventListener('click', () => {
               if (editPreview.style.display === 'none') {
                   editPreview.style.display = 'block';
                   showPreview.textContent = 'Hide preview';
                   updatePreview();
               } else {
                   editPreview.style.display = 'none';
                   showPreview.textContent = 'Show preview';
               }
           });

           editForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               if (!currentUser) {
                   alert('You must be logged in to edit pages.');
                   return;
               }

               const title = editTitle.value.trim();
               const content = editContent.value.trim();
               const summary = editSummary.value.trim() || 'No edit summary provided';
               const isMinor = document.getElementById('minor-edit').checked;

               if (!title || !content) {
                   alert('Please provide both a title and content.');
                   return;
               }

               try {
                   await submitRevision(title, content, summary, isMinor);
                   switchTab('article');
                   editForm.reset();
                   alert('Your changes have been submitted successfully!');
                   loadPage(currentPageId);
               } catch (error) {
                   console.error('Error submitting revision:', error);
                   alert('There was an error submitting your changes. Please try again.');
               }
           });

           cancelEdit.addEventListener('click', () => {
               if (confirm('Are you sure you want to cancel editing? Your changes will be lost.')) {
                   switchTab('article');
                   editForm.reset();
               }
           });
       }

       function insertFormat(format) {
           const textarea = editContent;
           const start = textarea.selectionStart;
           const end = textarea.selectionEnd;
           const selectedText = textarea.value.substring(start, end);
           let replacement = '';

           switch (format) {
               case 'header':
                   replacement = selectedText ? `== ${selectedText} ==` : '== New Section ==';
                   break;
               case 'bold':
                   replacement = selectedText ? `**${selectedText}**` : '**bold text**';
                   break;
               case 'italic':
                   replacement = selectedText ? `*${selectedText}*` : '*italic text*';
                   break;
               case 'link':
                   replacement = selectedText ? `[[${selectedText}]]` : '[[Link text]]';
                   break;
               case 'reference':
                   replacement = '<ref>Citation needed</ref>';
                   break;
           }

           const newText = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
           textarea.value = newText;
           textarea.focus();
           
           // Position cursor appropriately
           const newPosition = start + replacement.length;
           textarea.selectionStart = newPosition;
           textarea.selectionEnd = newPosition;
           
           updateLivePreview();
       }

       function updateLivePreview() {
           if (editPreview.style.display !== 'none') {
               updatePreview();
           }
       }

       function updatePreview() {
           const content = editContent.value;
           editPreviewContent.innerHTML = markdownToHtml(content);
       }

       async function submitRevision(title, content, summary, isMinor = false) {
           const revisionData = {
               pageId: generatePageId(title),
               title: title,
               content: content,
               summary: summary,
               author: currentUser.email,
               authorId: currentUser.uid,
               timestamp: firebase.firestore.FieldValue.serverTimestamp(),
               isMinor: isMinor,
               status: 'approved', // For demo purposes, auto-approve
               isNewPage: !await pageExists(generatePageId(title))
           };

           // Save as both a revision and update the main page
           await db.collection('revisions').add(revisionData);
           
           const pageData = {
               title: title,
               content: content,
               lastUpdatedBy: currentUser.email,
               updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
               createdAt: revisionData.isNewPage ? firebase.firestore.FieldValue.serverTimestamp() : undefined
           };

           await db.collection('pages').doc(revisionData.pageId).set(pageData, { merge: true });
       }

       async function pageExists(pageId) {
           const doc = await db.collection('pages').doc(pageId).get();
           return doc.exists;
       }

       // Enhanced page loading
       async function loadPage(pageId) {
           currentPageId = pageId;
           
           try {
               const doc = await db.collection('pages').doc(pageId).get();
               if (doc.exists) {
                   const pageData = doc.data();
                   displayPage(pageData);
               } else {
                   displayDefaultContent(pageId);
               }
           } catch (error) {
               console.error('Error loading page:', error);
               displayError();
           }
           
           // Reset to article tab
           switchTab('article');
       }

       function displayPage(pageData) {
           pageTitle.textContent = pageData.title;
           pageContent.innerHTML = markdownToHtml(pageData.content);
           
           const lastModified = pageData.updatedAt ? formatDate(pageData.updatedAt) : 'Unknown date';
           pageInfo.innerHTML = `
               <small>
                   Last edited ${lastModified}${pageData.lastUpdatedBy ? ` by ${pageData.lastUpdatedBy.split('@')[0]}` : ''}
               </small>
           `;
           
           updatePageActions();
           updateTableOfContents();
       }

       function displayDefaultContent(pageId) {
           if (pageId === 'home') {
               // Home page content is already in the HTML
               pageInfo.innerHTML = '<small>Main page</small>';
               updatePageActions();
               return;
           }

           pageTitle.textContent = pageId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
           pageContent.innerHTML = `
               <div class="notice-box">
                   <p><strong>This page does not exist yet.</strong></p>
                   <p>You can create it by clicking the "Edit" tab above${!currentUser ? ' (requires login)' : ''}.</p>
               </div>
           `;
           pageInfo.innerHTML = '<small>This page does not exist</small>';
       }

       function displayError() {
           pageTitle.textContent = 'Error';
           pageContent.innerHTML = '<div class="alert alert-danger">There was an error loading this page. Please try again later.</div>';
           pageInfo.textContent = '';
       }

       function updatePageActions() {
           if (!currentUser) {
               pageActions.innerHTML = '';
               return;
           }

           pageActions.innerHTML = `
               <small>
                   <a href="#" onclick="switchTab('edit')" class="me-2">Edit</a>
                   <a href="#" onclick="switchTab('history')" class="me-2">History</a>
                   <a href="#" onclick="watchPage()" class="me-2">Watch</a>
               </small>
           `;
       }

       function startEditing(pageData = null) {
           pageContent.style.display = 'none';
           editSection.style.display = 'block';
           
           if (pageData) {
               editTitle.value = pageData.title;
               editContent.value = pageData.content;
           } else {
               // Try to load current page data
               db.collection('pages').doc(currentPageId).get().then(doc => {
                   if (doc.exists) {
                       const data = doc.data();
                       editTitle.value = data.title;
                       editContent.value = data.content;
                   } else {
                       editTitle.value = currentPageId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                       editContent.value = `== ${editTitle.value} ==\n\nWrite your article content here.\n\n== References ==\n<references />\n\n[[Category:Minnesota History]]`;
                   }
               });
           }
       }

       // Enhanced search functionality
       async function searchPages(searchTerm) {
           pageTitle.textContent = `Search results for "${searchTerm}"`;
           pageContent.innerHTML = '<p>Searching...</p>';
           pageInfo.innerHTML = '<small>Search results</small>';

           try {
               // Search in titles
               const titleResults = await db.collection('pages')
                   .where('title', '>=', searchTerm)
                   .where('title', '<=', searchTerm + '\uf8ff')
                   .limit(10)
                   .get();

               // Search in content (simplified - in production you'd use a proper search service)
               const contentResults = await db.collection('pages')
                   .limit(20)
                   .get();

               const filteredContentResults = contentResults.docs.filter(doc => {
                   const data = doc.data();
                   return data.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          data.title.toLowerCase().includes(searchTerm.toLowerCase());
               });

               if (titleResults.empty && filteredContentResults.length === 0) {
                   displayNoSearchResults(searchTerm);
                   return;
               }

               displaySearchResults([...titleResults.docs, ...filteredContentResults], searchTerm);
           } catch (error) {
               console.error('Error searching pages:', error);
               pageContent.innerHTML = '<div class="alert alert-danger">Error performing search. Please try again.</div>';
           }
       }

       function displayNoSearchResults(searchTerm) {
           pageContent.innerHTML = `
               <div class="notice-box">
                   <p>No pages found matching "<strong>${searchTerm}</strong>".</p>
                   ${currentUser ? `<p><a href="#" onclick="createPageFromSearch('${searchTerm}')">Create this page?</a></p>` : '<p>Log in to create new pages.</p>'}
               </div>
           `;
       }

       function displaySearchResults(results, searchTerm) {
           // Remove duplicates based on document ID
           const uniqueResults = results.filter((doc, index, self) => 
               index === self.findIndex(d => d.id === doc.id)
           );

           let html = `<p>Found ${uniqueResults.length} result(s) for "<strong>${searchTerm}</strong>":</p>`;
           html += '<div class="list-group mt-3">';
           
           uniqueResults.forEach(doc => {
               const page = doc.data();
               const snippet = extractSearchSnippet(page.content, searchTerm);
               html += `
                   <a href="#" class="list-group-item list-group-item-action" onclick="loadPage('${doc.id}')">
                       <h5 class="mb-1">${highlightSearchTerm(page.title, searchTerm)}</h5>
                       <p class="mb-1">${highlightSearchTerm(snippet, searchTerm)}...</p>
                       <small class="text-muted">Last modified ${page.updatedAt ? formatDate(page.updatedAt) : 'Unknown date'}</small>
                   </a>
               `;
           });
           
           html += '</div>';
           pageContent.innerHTML = html;
       }

       function extractSearchSnippet(content, searchTerm, maxLength = 200) {
           const lowerContent = content.toLowerCase();
           const lowerTerm = searchTerm.toLowerCase();
           const index = lowerContent.indexOf(lowerTerm);
           
           if (index === -1) {
               return content.substring(0, maxLength);
           }
           
           const start = Math.max(0, index - 50);
           const end = Math.min(content.length, index + maxLength - 50);
           
           return (start > 0 ? '...' : '') + content.substring(start, end) + (end < content.length ? '...' : '');
       }

       function highlightSearchTerm(text, searchTerm) {
           const regex = new RegExp(`(${searchTerm})`, 'gi');
           return text.replace(regex, '<mark>$1</mark>');
       }

       function createPageFromSearch(searchTerm) {
           currentPageId = generatePageId(searchTerm);
           switchTab('edit');
       }

       // Featured Articles
       async function loadFeaturedArticles() {
           const featuredSection = document.getElementById('featured-articles');
           try {
               const snapshot = await db.collection('pages')
                   .where('featured', '==', true)
                   .limit(5)
                   .get();

               if (snapshot.empty) {
                   // If no featured articles, show recent articles
                   const recentSnapshot = await db.collection('pages')
                       .orderBy('updatedAt', 'desc')
                       .limit(3)
                       .get();
                   
                   if (recentSnapshot.empty) {
                       featuredSection.innerHTML = '<p><em>No articles available yet. Be the first to contribute!</em></p>';
                       return;
                   }
                   
                   displayRecentArticles(recentSnapshot, featuredSection);
                   return;
               }

               displayFeaturedArticles(snapshot, featuredSection);
           } catch (error) {
               console.error('Error loading featured articles:', error);
               featuredSection.innerHTML = '<div class="alert alert-warning">Unable to load featured articles at this time.</div>';
           }
       }

       function displayFeaturedArticles(snapshot, container) {
           let html = '<div class="row">';
           snapshot.forEach(doc => {
               const article = doc.data();
               html += `
                   <div class="col-md-4 mb-3">
                       <div class="card h-100">
                           <div class="card-body">
                               <h5 class="card-title">${article.title}</h5>
                               <p class="card-text">${stripWikiMarkup(article.content).substring(0, 150)}...</p>
                               <a href="#" onclick="loadPage('${doc.id}')" class="btn btn-link p-0">Read article →</a>
                           </div>
                       </div>
                   </div>
               `;
           });
           html += '</div>';
           container.innerHTML = html;
       }

       function displayRecentArticles(snapshot, container) {
           let html = '<p><em>Recent contributions:</em></p><div class="row">';
           snapshot.forEach(doc => {
               const article = doc.data();
               html += `
                   <div class="col-md-4 mb-3">
                       <div class="card h-100">
                           <div class="card-body">
                               <h5 class="card-title">${article.title}</h5>
                               <p class="card-text">${stripWikiMarkup(article.content).substring(0, 150)}...</p>
                               <a href="#" onclick="loadPage('${doc.id}')" class="btn btn-link p-0">Read article →</a>
                           </div>
                       </div>
                   </div>
               `;
           });
           html += '</div>';
           container.innerHTML = html;
       }

       // Discussion and History tabs
       function showDiscussion() {
           pageContent.innerHTML = `
               <div class="notice-box">
                   <p><strong>Discussion</strong></p>
                   <p>This is the discussion page for "${pageTitle.textContent}". Use this space to discuss improvements to the article.</p>
                   ${currentUser ? '<p><a href="#" onclick="startDiscussion()">Start a discussion</a></p>' : '<p>Log in to participate in discussions.</p>'}
               </div>
           `;
           editSection.style.display = 'none';
       }

       async function showHistory() {
           pageContent.innerHTML = '<p>Loading revision history...</p>';
           editSection.style.display = 'none';
           
           try {
               const snapshot = await db.collection('revisions')
                   .where('pageId', '==', currentPageId)
                   .orderBy('timestamp', 'desc')
                   .limit(20)
                   .get();

               if (snapshot.empty) {
                   pageContent.innerHTML = '<p>No revision history available for this page.</p>';
                   return;
               }

               let html = '<h3>Revision history</h3>';
               html += '<ul class="list-unstyled">';
               
               snapshot.forEach(doc => {
                   const revision = doc.data();
                   html += `
                       <li class="border-bottom py-2">
                           <small class="text-muted">${formatDate(revision.timestamp)}</small><br>
                           <strong>${revision.author.split('@')[0]}</strong>
                           ${revision.isMinor ? '<span class="badge bg-secondary">minor</span>' : ''}
                           <br>
                           <em>${revision.summary}</em>
                       </li>
                   `;
               });
               
               html += '</ul>';
               pageContent.innerHTML = html;
           } catch (error) {
               console.error('Error loading history:', error);
               pageContent.innerHTML = '<div class="alert alert-danger">Error loading revision history.</div>';
           }
       }

       // Table of Contents generation
       function updateTableOfContents() {
           const headings = pageContent.querySelectorAll('h2, h3');
           const toc = document.getElementById('toc');
           
           if (headings.length === 0) {
               toc.style.display = 'none';
               return;
           }
           
           toc.style.display = 'block';
           const tocList = toc.querySelector('ul');
           tocList.innerHTML = '';
           
           let sectionNum = 1;
           let subsectionNum = 1;
           
           headings.forEach(heading => {
               const id = heading.textContent.toLowerCase().replace(/[^a-z0-9]+/g, '-');
               heading.id = id;
               
               const li = document.createElement('li');
               
               if (heading.tagName === 'H2') {
                   li.innerHTML = `${sectionNum} <a href="#${id}">${heading.textContent}</a>`;
                   sectionNum++;
                   subsectionNum = 1;
               } else if (heading.tagName === 'H3') {
                   li.innerHTML = `${sectionNum - 1}.${subsectionNum} <a href="#${id}">${heading.textContent}</a>`;
                   li.style.marginLeft = '1rem';
                   subsectionNum++;
               }
               
               tocList.appendChild(li);
           });
       }

       // Enhanced Helper Functions
       function markdownToHtml(markdown) {
           if (!markdown) return '';
           
           return markdown
               // Headers
               .replace(/^====\s*(.*?)\s*====$/gm, '<h4>$1</h4>')
               .replace(/^===\s*(.*?)\s*===$/gm, '<h3>$1</h3>')
               .replace(/^==\s*(.*?)\s*==$/gm, '<h2>$1</h2>')
               // Text formatting
               .replace(/'''(.*?)'''/g, '<strong>$1</strong>')
               .replace(/''(.*?)''/g, '<em>$1</em>')
               .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
               .replace(/\*(.*?)\*/g, '<em>$1</em>')
               // Links
               .replace(/\[\[(.*?)\|(.*?)\]\]/g, '<a href="#" onclick="loadPage(\'$1\')">$2</a>')
               .replace(/\[\[(.*?)\]\]/g, '<a href="#" onclick="loadPage(\'$1\')">$1</a>')
               // Images
               .replace(/\[\[Image:(.*?)\|(.*?)\|(.*?)\]\]/g, '<figure class="figure"><img src="$1" alt="$3" class="figure-img img-fluid"><figcaption class="figure-caption">$3</figcaption></figure>')
               // References
               .replace(/<ref>(.*?)<\/ref>/g, '<sup class="reference"><a href="#references">[$1]</a></sup>')
               .replace(/<references\s*\/>/g, '<div class="references"><h3>References</h3><ol><li>References will appear here</li></ol></div>')
               // Categories
               .replace(/\[\[Category:(.*?)\]\]/g, '')
               // Line breaks and paragraphs
               .replace(/\n\n/g, '</p><p>')
               .replace(/^\s*$(?:\r\n?|\n)/gm, '</p><p>')
               .replace(/^(?!<[h|p|d|u|o])/gm, '<p>')
               .replace(/(?<![>])\n/g, '<br>')
               // Clean up
               .replace(/<p><\/p>/g, '')
               .replace(/<p>(<h[2-6]>)/g, '$1')
               .replace(/(<\/h[2-6]>)<\/p>/g, '$1');
       }

       function stripWikiMarkup(text) {
           return text
               .replace(/==+\s*(.*?)\s*==+/g, '$1')
               .replace(/\*\*(.*?)\*\*/g, '$1')
               .replace(/\*(.*?)\*/g, '$1')
               .replace(/\[\[(.*?)\|(.*?)\]\]/g, '$2')
               .replace(/\[\[(.*?)\]\]/g, '$1')
               .replace(/<ref>.*?<\/ref>/g, '')
               .replace(/<.*?>/g, '')
               .replace(/\n+/g, ' ')
               .trim();
       }

       function formatDate(timestamp) {
           if (!timestamp) return 'Unknown date';
           const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
           return new Intl.DateTimeFormat('en-US', {
               year: 'numeric',
               month: 'long',
               day: 'numeric',
               hour: '2-digit',
               minute: '2-digit'
           }).format(date);
       }

       function generatePageId(title) {
           return title.toLowerCase()
               .replace(/[^a-z0-9\s]/g, '')
               .replace(/\s+/g, '-')
               .replace(/^-|-$/g, '');
       }

       // Global functions for onclick handlers
       window.loadPage = loadPage;
       window.switchTab = switchTab;
       window.createPageFromSearch = createPageFromSearch;
       window.startDiscussion = () => alert('Discussion feature coming soon!');
       window.watchPage = () => alert('Watch feature coming soon!');

       // Initialize the app when DOM is loaded
       document.addEventListener('DOMContentLoaded', init);
   </script>
</body>
</html>
