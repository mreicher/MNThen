<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Minnesota Then - A Community History Wiki</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Primary palette */
            --primary-50: #EFF6FF;
            --primary-100: #DBEAFE;
            --primary-200: #BFDBFE;
            --primary-300: #93C5FD;
            --primary-400: #60A5FA;
            --primary-500: #3B82F6;
            --primary-600: #2563EB;
            --primary-700: #1D4ED8;
            --primary-800: #1E40AF;
            --primary-900: #1E3A8A;
            
            /* Secondary palette */
            --secondary-50: #EEF2FF;
            --secondary-100: #E0E7FF;
            --secondary-200: #C7D2FE;
            --secondary-300: #A5B4FC;
            --secondary-400: #818CF8;
            --secondary-500: #6366F1;
            --secondary-600: #4F46E5;
            --secondary-700: #4338CA;
            --secondary-800: #3730A3;
            --secondary-900: #312E81;
            
            /* Neutral palette */
            --neutral-50: #F9FAFB;
            --neutral-100: #F3F4F6;
            --neutral-200: #E5E7EB;
            --neutral-300: #D1D5DB;
            --neutral-400: #9CA3AF;
            --neutral-500: #6B7280;
            --neutral-600: #4B5563;
            --neutral-700: #374151;
            --neutral-800: #1F2937;
            --neutral-900: #111827;
            
            /* Status colors */
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            
            /* Legacy wiki variables for backward compatibility */
            --wiki-bg: var(--neutral-50);
            --wiki-text: var(--neutral-900);
            --wiki-link: var(--primary-600);
            --wiki-link-visited: var(--primary-800);
            --wiki-link-new: var(--error);
            --wiki-border: var(--neutral-300);
            --wiki-header: var(--neutral-100);
            --wiki-sidebar: var(--neutral-100);
            --wiki-blue: var(--primary-600);
            --wiki-gray: var(--neutral-500);
            
            /* Spacing system (8px increments) */
            --space-1: 0.25rem; /* 4px */
            --space-2: 0.5rem;  /* 8px */
            --space-3: 0.75rem; /* 12px */
            --space-4: 1rem;    /* 16px */
            --space-5: 1.25rem; /* 20px */
            --space-6: 1.5rem;  /* 24px */
            --space-8: 2rem;    /* 32px */
            --space-10: 2.5rem; /* 40px */
            --space-12: 3rem;   /* 48px */
            --space-16: 4rem;   /* 64px */
            
            /* Typography */
            --font-heading: 'EB Garamond', Georgia, Times, serif;
            --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Animation */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--wiki-bg);
            color: var(--wiki-text);
            line-height: 1.6;
            font-size: 14px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            line-height: 1.2;
        }

        /* Wikipedia-style header */
        .wiki-header {
            background-color: var(--wiki-header);
            border-bottom: 1px solid var(--wiki-border);
            padding: var(--space-2) 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            transition: box-shadow var(--transition-normal);
        }

        .wiki-header.scrolled {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .wiki-title {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            color: var(--wiki-text);
            font-weight: normal;
            margin: 0;
            transition: color var(--transition-fast);
        }

        .wiki-title:hover {
            color: var(--primary-600);
        }

        .wiki-subtitle {
            font-style: italic;
            color: var(--wiki-gray);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Wikipedia-style sidebar */
        .sidebar {
            background-color: var(--wiki-sidebar);
            border-right: 1px solid var(--wiki-border);
            padding: var(--space-2);
            min-height: calc(100vh - 80px);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .sidebar h5 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--wiki-text);
            margin: var(--space-4) 0 var(--space-2) 0;
            padding: var(--space-1) var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
        }

        .sidebar .nav-link {
            color: var(--wiki-link);
            padding: var(--space-1) var(--space-2);
            font-size: 0.85rem;
            border-radius: 4px;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .sidebar .nav-link:hover {
            color: var(--wiki-link);
            background-color: var(--primary-50);
            text-decoration: underline;
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-100);
            color: var(--primary-800);
            font-weight: 500;
        }

        /* Mobile sidebar toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary-600);
            color: white;
            border: none;
            z-index: 1100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }

        .sidebar-toggle:hover {
            background-color: var(--primary-700);
            transform: translateY(-2px);
        }

        /* Main content area */
        .content-area {
            background-color: var(--wiki-bg);
            padding: var(--space-4) var(--space-6);
            min-height: calc(100vh - 80px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0.8; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Wikipedia-style page title */
        #page-title {
            font-family: var(--font-heading);
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--wiki-text);
            margin-bottom: var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: var(--space-1);
        }

        /* Page metadata */
        .content-meta {
            font-size: 0.8rem;
            color: var(--wiki-gray);
            margin-bottom: var(--space-4);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--neutral-200);
        }

        /* Wikipedia-style tabs */
        .page-tabs {
            border-bottom: 1px solid var(--wiki-border);
            margin-bottom: var(--space-4);
        }

        .page-tabs .nav-link {
            border: 1px solid transparent;
            border-bottom: none;
            background-color: var(--wiki-header);
            color: var(--wiki-link);
            font-size: 0.85rem;
            padding: var(--space-2) var(--space-4);
            margin-right: var(--space-1);
            border-radius: 4px 4px 0 0;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .page-tabs .nav-link:hover {
            background-color: #fff;
            text-decoration: underline;
        }

        .page-tabs .nav-link.active {
            background-color: #fff;
            border-color: var(--wiki-border);
            color: var(--wiki-text);
            font-weight: 500;
        }

        /* Table of Contents */
        .toc {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            width: fit-content;
            float: right;
            max-width: 300px;
            font-size: 0.9rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .toc-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
            text-align: center;
            color: var(--neutral-700);
        }

        .toc ul {
            list-style-type: none;
            padding-left: var(--space-4);
            margin: 0;
        }

        .toc li {
            margin: var(--space-1) 0;
        }

        .toc a {
            color: var(--wiki-link);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .toc a:hover {
            text-decoration: underline;
            color: var(--primary-700);
        }

        /* Wikipedia-style sections */
        .wiki-section {
            margin-bottom: var(--space-8);
            clear: both;
        }

        .wiki-section h2 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 500;
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: var(--space-1);
            margin-top: var(--space-8);
            margin-bottom: var(--space-4);
            color: var(--neutral-800);
        }

        .wiki-section h3 {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: var(--space-6);
            margin-bottom: var(--space-2);
            color: var(--neutral-800);
        }

        /* Links */
        a {
            color: var(--wiki-link);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            text-decoration: underline;
        }

        a:visited {
            color: var(--wiki-link-visited);
        }

        .new-page-link {
            color: var(--wiki-link-new);
        }

        /* Search box */
        .search-container {
            margin: var(--space-4) 0;
        }

        .search-container input {
            font-size: 0.85rem;
            border: 1px solid var(--wiki-border);
            border-radius: 4px 0 0 4px;
            padding: var(--space-2);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .search-container input:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px var(--primary-100);
            outline: none;
        }

        .search-container button {
            font-size: 0.85rem;
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            border-left: none;
            color: var(--wiki-text);
            border-radius: 0 4px 4px 0;
            padding: var(--space-2) var(--space-3);
            transition: background-color var(--transition-fast);
        }

        .search-container button:hover {
            background-color: var(--neutral-200);
        }

        /* Edit toolbar */
        .edit-toolbar {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-2);
            margin-bottom: var(--space-4);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .edit-toolbar button {
            margin-right: var(--space-2);
            font-size: 0.8rem;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
        }

        .edit-toolbar button:hover {
            transform: translateY(-1px);
        }

        /* References */
        .references {
            font-size: 0.85rem;
            border-top: 1px solid var(--wiki-border);
            margin-top: var(--space-8);
            padding-top: var(--space-4);
        }

        .reference {
            color: var(--wiki-link);
            font-size: 0.75rem;
            text-decoration: none;
        }

        /* Infobox styling */
        .infobox {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-4);
            margin: 0 0 var(--space-4) var(--space-4);
            width: 300px;
            float: right;
            font-size: 0.9rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .infobox-title {
            font-weight: 600;
            text-align: center;
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
            color: var(--neutral-700);
        }

        /* Notices and status boxes */
        .notice-box {
            background-color: var(--primary-50);
            border: 1px solid var(--primary-200);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            border-radius: 4px;
            animation: fadeIn 0.4s ease;
        }

        .approval-pending {
            background-color: var(--warning-50);
            border: 1px solid var(--warning-200);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-radius: 4px;
        }

        /* Success message */
        .success-message {
            background-color: var(--success-50);
            border: 1px solid var(--success-200);
            color: var(--success-700);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-radius: 4px;
            display: none;
            animation: fadeIn 0.4s ease;
        }

        /* Footer */
        .wiki-footer {
            background-color: var(--wiki-header);
            border-top: 1px solid var(--wiki-border);
            padding: var(--space-8) 0;
            margin-top: var(--space-12);
            font-size: 0.8rem;
        }

        .wiki-footer h5 {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--neutral-700);
        }

        .wiki-footer a {
            color: var(--primary-600);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .wiki-footer a:hover {
            color: var(--primary-800);
            text-decoration: underline;
        }

        /* Auth status */
        #auth-status {
            font-size: 0.85rem;
        }

        .user-greeting {
            color: var(--neutral-700);
            font-weight: 500;
        }

        /* Modal customizations */
        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .modal-header {
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-4) var(--space-6);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            border-top: 1px solid var(--neutral-200);
            padding: var(--space-4) var(--space-6);
        }

        /* Form controls */
        .form-control:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        /* Button customizations */
        .btn-primary {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
            transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .btn-primary:hover {
            background-color: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-outline-primary {
            border-color: var(--primary-600);
            color: var(--primary-600);
            transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-50);
            color: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
        }

        /* Contributor badge */
        .contributor-badge {
            font-size: 0.7rem;
            background-color: var(--primary-100);
            color: var(--primary-800);
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: var(--space-2);
            vertical-align: middle;
            font-weight: 500;
        }

        .contributor-badge.admin {
            background-color: var(--secondary-100);
            color: var(--secondary-800);
        }

        /* Loading spinner */
        .loading-spinner {
            display: none;
            margin: var(--space-8) auto;
            text-align: center;
        }

        .spinner-border {
            color: var(--primary-500);
            width: 3rem;
            height: 3rem;
        }

        /* Edit history styles */
        .history-item {
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-3) 0;
            transition: background-color var(--transition-fast);
        }

        .history-item:hover {
            background-color: var(--neutral-50);
        }

        .history-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .history-badge.minor {
            background-color: var(--neutral-100);
            color: var(--neutral-700);
        }

        .history-badge.major {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        /* Responsive design */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 80px;
                width: 280px;
                z-index: 1200;
                bottom: 0;
                box-shadow: none;
                transition: left var(--transition-normal), box-shadow var(--transition-normal);
            }
            
            .sidebar.show {
                left: 0;
                box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .content-area {
                padding: var(--space-4);
            }
            
            .wiki-title {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                top: 70px;
            }
            
            .toc {
                float: none;
                width: 100%;
                max-width: none;
                margin: var(--space-4) 0;
            }
            
            .infobox {
                float: none;
                width: 100%;
                margin: var(--space-4) 0;
            }
            
            .wiki-title {
                font-size: 1.5rem;
                text-align: center;
            }
            
            #page-title {
                font-size: 1.8rem;
            }
            
            .page-tabs .nav-link {
                padding: var(--space-2);
            }
            
            #auth-status {
                justify-content: center !important;
                margin-top: var(--space-2);
            }
        }

        @media (max-width: 576px) {
            .wiki-title {
                font-size: 1.3rem;
            }
            
            .wiki-subtitle {
                font-size: 0.75rem;
            }
            
            #page-title {
                font-size: 1.6rem;
            }
            
            .page-tabs .nav-link {
                font-size: 0.8rem;
                padding: var(--space-1) var(--space-2);
            }
            
            .content-area {
                padding: var(--space-3);
            }
            
            .edit-toolbar button {
                padding: var(--space-1) var(--space-2);
                margin-bottom: var(--space-2);
                font-size: 0.75rem;
            }
        }

        /* Print styles */
        @media print {
            .sidebar, .wiki-header, .wiki-footer, .edit-toolbar, #auth-status, .page-tabs {
                display: none !important;
            }
            
            .content-area {
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            body {
                font-size: 12pt;
                line-height: 1.4;
            }
            
            #page-title {
                font-size: 24pt;
                border-bottom: 1pt solid #000;
                margin-bottom: 12pt;
            }
            
            .wiki-section h2 {
                font-size: 18pt;
                border-bottom: 0.5pt solid #000;
                margin: 16pt 0 8pt 0;
                page-break-after: avoid;
            }
            
            .wiki-section h3 {
                font-size: 14pt;
                margin: 12pt 0 6pt 0;
                page-break-after: avoid;
            }
            
            a {
                color: #000;
                text-decoration: none;
            }
            
            a::after {
                content: " (" attr(href) ")";
                font-size: 90%;
                color: #333;
            }
            
            .toc, .infobox {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <header class="wiki-header" id="wikiHeader">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-8 col-md-6">
                    <a href="/" class="text-decoration-none">
                        <h1 class="wiki-title">Minnesota Then</h1>
                        <p class="wiki-subtitle">A Community History Wiki</p>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div id="auth-status" class="d-flex justify-content-end">
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                        <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid">
        <div class="row">
            <div class="col-lg-2 col-md-3 p-0">
                <div class="sidebar" id="sidebar">
                    <h5>Navigation</h5>
                    <ul class="nav flex-column" id="sidebar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="home">Main page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recent-changes">Recent changes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="random-page">Random article</a>
                        </li>
                    </ul>

                    <h5>Topics</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="landmarks">Historic Landmarks</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="people">Notable People</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="events">Historic Events</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="indigenous">Indigenous History</a>
                        </li>
                    </ul>

                    <h5>Tools</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="help">Help</a>
                        </li>
                        <li class="nav-item" id="create-page-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="create-page">Create a page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="special-pages">Special pages</a>
                        </li>
                        <li class="nav-item" id="my-contributions-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="my-contributions">My contributions</a>
                        </li>
                    </ul>

                    <div class="search-container">
                        <h5>Search</h5>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="search-input" placeholder="Search Minnesota Then">
                            <button class="btn btn-outline-secondary" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <div class="col-lg-10 col-md-9">
                <div class="content-area">
                    <!-- Page tabs (Wikipedia-style) -->
                    <ul class="nav nav-tabs page-tabs" id="page-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-tab="article">Article</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="discussion">Discussion</a>
                        </li>
                        <li class="nav-item" id="edit-tab" style="display: none;">
                            <a class="nav-link" href="#" data-tab="edit">Edit</a>
                        </li>
                        <li class="nav-item" id="history-tab">
                            <a class="nav-link" href="#" data-tab="history">View history</a>
                        </li>
                    </ul>

                    <!-- Success Message -->
                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="success-text">Your changes have been saved successfully!</span>
                    </div>

                    <div id="page-header">
                        <h1 id="page-title">Welcome to Minnesota Then</h1>
                        <div class="content-meta" id="page-meta">
                            <span id="page-info"></span>
                            <span id="page-actions" class="float-end"></span>
                        </div>
                    </div>

                    <!-- Loading spinner -->
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading content...</p>
                    </div>

                    <div id="page-content">
                        <div class="toc" id="toc">
                            <div class="toc-title">Contents</div>
                            <ul>
                                <li>1 <a href="#introduction">Introduction</a></li>
                                <li>2 <a href="#getting-started">Getting started</a></li>
                                <li>3 <a href="#featured">Featured articles</a></li>
                                <li>4 <a href="#community">Community</a></li>
                            </ul>
                        </div>

                        <section id="introduction" class="wiki-section">
                            <h2>Introduction</h2>
                            <p>Welcome to <strong>Minnesota Then</strong>, a community-driven historical wiki dedicated to preserving and sharing the rich history of Minnesota. Our goal is to create a comprehensive resource that documents the people, places, events, and stories that have shaped our state from its earliest inhabitants to the present day.</p>
                            
                            <p>This wiki serves as a collaborative platform where historians, researchers, students, and anyone with an interest in Minnesota's past can contribute their knowledge and discoveries. Whether you're researching your family history, exploring local landmarks, or studying significant historical events, Minnesota Then provides a reliable and comprehensive resource.</p>
                        </section>

                        <section id="getting-started" class="wiki-section">
                            <h2>Getting started</h2>
                            <p>Contributing to Minnesota Then is easy and rewarding:</p>
                            <ul>
                                <li><strong>Create an account</strong> to start contributing to articles</li>
                                <li><strong>Browse existing articles</strong> to get familiar with our style and standards</li>
                                <li><strong>Add new content</strong> or improve existing articles with additional information</li>
                                <li><strong>Cite your sources</strong> to maintain the reliability of information</li>
                                <li><strong>Follow our guidelines</strong> for writing neutral, encyclopedic content</li>
                            </ul>
                            
                            <div class="notice-box">
                                <strong>Note:</strong> All contributions are reviewed by our community of editors before publication to ensure accuracy and quality.
                            </div>
                        </section>

                        <section id="featured" class="wiki-section">
                            <h2>Featured articles</h2>
                            <p>Explore some of our comprehensive, well-researched articles:</p>
                            <div id="featured-articles">
                                <p><em>Loading featured articles...</em></p>
                            </div>
                        </section>

                        <section id="community" class="wiki-section">
                            <h2>Community</h2>
                            <p>Minnesota Then is built and maintained by a community of volunteers who share a passion for Minnesota history. Join us in preserving the stories that make our state unique.</p>
                            
                            <h3>How to help</h3>
                            <ul>
                                <li>Add articles about your local community</li>
                                <li>Upload historical photographs and documents</li>
                                <li>Improve existing articles with additional sources</li>
                                <li>Help with proofreading and fact-checking</li>
                                <li>Share your expertise on specific topics or time periods</li>
                            </ul>
                        </section>
                    </div>

                    <div id="edit-section" class="mt-4" style="display: none;">
                        <div class="edit-toolbar">
                            <strong>Editing tools:</strong>
                            <button class="btn btn-sm btn-outline-secondary" data-format="header">
                                <i class="fas fa-heading me-1"></i> Heading
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="bold">
                                <i class="fas fa-bold me-1"></i> Bold
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="italic">
                                <i class="fas fa-italic me-1"></i> Italic
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="link">
                                <i class="fas fa-link me-1"></i> Link
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="list">
                                <i class="fas fa-list me-1"></i> List
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="image">
                                <i class="fas fa-image me-1"></i> Image
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="reference">
                                <i class="fas fa-quote-right me-1"></i> Reference
                            </button>
                        </div>
                        <form id="edit-form">
                            <div class="mb-3">
                                <label for="edit-title" class="form-label">Article title</label>
                                <input type="text" class="form-control" id="edit-title" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-content" class="form-label">Content</label>
                                <textarea class="form-control" id="edit-content" rows="20" required placeholder="Write your article content here. Use wiki markup for formatting."></textarea>
                                <small class="form-text text-muted">Use == for headings, ** for bold, * for italic, and [[Link]] for internal links.</small>
                            </div>
                            <div class="mb-3">
                                <label for="edit-summary" class="form-label">Edit summary</label>
                                <input type="text" class="form-control" id="edit-summary" placeholder="Briefly describe your changes" maxlength="200">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="minor-edit">
                                <label class="form-check-label" for="minor-edit">
                                    This is a minor edit
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Save changes
                            </button>
                            <button type="button" class="btn btn-secondary" id="show-preview">
                                <i class="fas fa-eye me-1"></i> Show preview
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="cancel-edit">
                                <i class="fas fa-times me-1"></i> Cancel
                            </button>
                        </form>
                        
                        <div id="edit-preview" class="mt-3" style="display: none;">
                            <h4>Preview</h4>
                            <div class="border p-3" id="edit-preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="wiki-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h5>Minnesota Then</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="about">About Minnesota Then</a></li>
                        <li><a href="#" data-page="disclaimers">General disclaimer</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contribute</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="help">Help</a></li>
                        <li><a href="#" data-page="community-portal">Community portal</a></li>
                        <li><a href="#" data-page="recent-changes">Recent changes</a></li>
                        <li><a href="#" data-page="contact">Contact page</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Tools</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="special-pages">Special pages</a></li>
                        <li><a href="#" data-page="permanent-link">Permanent link</a></li>
                        <li><a href="#" data-page="page-information">Page information</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Legal</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="privacy">Privacy policy</a></li>
                        <li><a href="#" data-page="terms">Terms of use</a></li>
                        <li><small>Content is available under <a href="#" data-page="license">CC BY-SA 4.0</a></small></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <small>&copy; 2025 Minnesota Then Community. Powered by community contributions.</small>
            </div>
        </div>
    </footer>

    <!-- Authentication Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Log in</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="mb-3">
                            <label for="auth-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="auth-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div id="auth-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100" id="auth-submit-btn">Log in</button>
                    </form>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-link" id="switch-auth-mode">Create an account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal fade" id="imageUploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="image-upload-form">
                        <div class="mb-3">
                            <label for="image-file" class="form-label">Select Image</label>
                            <input type="file" class="form-control" id="image-file" accept="image/*" required>
                        </div>
                        <div class="mb-3">
                            <label for="image-title" class="form-label">Image Title</label>
                            <input type="text" class="form-control" id="image-title" placeholder="Descriptive title for the image" required>
                        </div>
                        <div class="mb-3">
                            <label for="image-description" class="form-label">Description</label>
                            <textarea class="form-control" id="image-description" rows="3" placeholder="Describe the image and provide attribution"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="image-source" class="form-label">Source</label>
                            <input type="text" class="form-control" id="image-source" placeholder="Original source of the image">
                        </div>
                        <div id="upload-error" class="alert alert-danger d-none"></div>
                        <div id="upload-progress" class="progress d-none mb-3">
                            <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="upload-submit-btn">Upload Image</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Discussion Modal -->
    <div class="modal fade" id="discussionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Start a discussion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="discussion-form">
                        <div class="mb-3">
                            <label for="discussion-topic" class="form-label">Topic</label>
                            <input type="text" class="form-control" id="discussion-topic" required>
                        </div>
                        <div class="mb-3">
                            <label for="discussion-content" class="form-label">Message</label>
                            <textarea class="form-control" id="discussion-content" rows="6" required></textarea>
                        </div>
                        <div id="discussion-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary">Post Discussion</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };

        // Initialize Firebase
        let firebaseApp;
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Enhanced DOM Elements
        const wikiHeader = document.getElementById('wikiHeader');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authStatus = document.getElementById('auth-status');
        const authModal = new bootstrap.Modal(document.getElementById('authModal'));
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authModalTitle = document.getElementById('authModalTitle');
        const switchAuthMode = document.getElementById('switch-auth-mode');
        const authError = document.getElementById('auth-error');
        const pageTitle = document.getElementById('page-title');
        const pageContent = document.getElementById('page-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const pageInfo = document.getElementById('page-info');
        const pageActions = document.getElementById('page-actions');
        const editSection = document.getElementById('edit-section');
        const editForm = document.getElementById('edit-form');
        const editTitle = document.getElementById('edit-title');
        const editContent = document.getElementById('edit-content');
        const editPreview = document.getElementById('edit-preview');
        const editPreviewContent = document.getElementById('edit-preview-content');
        const editSummary = document.getElementById('edit-summary');
        const cancelEdit = document.getElementById('cancel-edit');
        const showPreview = document.getElementById('show-preview');
        const createPageItem = document.getElementById('create-page-item');
        const myContributionsItem = document.getElementById('my-contributions-item');
        const editTab = document.getElementById('edit-tab');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const sidebarNav = document.getElementById('sidebar-nav');
        const pageTabs = document.getElementById('page-tabs');
        const successMessage = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        const imageUploadModal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
        const imageUploadForm = document.getElementById('image-upload-form');
        const discussionModal = new bootstrap.Modal(document.getElementById('discussionModal'));
        const discussionForm = document.getElementById('discussion-form');

        // State variables
        let isLoginMode = true;
        let currentPageId = 'home';
        let currentUser = null;
        let isEditing = false;
        let currentTab = 'article';
        let discussionTopics = [];
        let recentChanges = [];
        let isAdminUser = false;

        // Initialize the app
        function init() {
            setupAuth();
            setupNavigation();
            setupEditor();
            setupTabs();
            setupSidebarToggle();
            setupScrollEffects();
            loadPage(currentPageId);
            loadFeaturedArticles();
        }

        // Scroll effects
        function setupScrollEffects() {
            window.addEventListener('scroll', function() {
                if (window.scrollY > 20) {
                    wikiHeader.classList.add('scrolled');
                } else {
                    wikiHeader.classList.remove('scrolled');
                }
            });
        }

        // Toggle sidebar on mobile
        function setupSidebarToggle() {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
                
                // Change icon based on state
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('show')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 992 &&
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target) && 
                    sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    const icon = sidebarToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        }

        // Enhanced authentication
        function setupAuth() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    // Check if user is admin
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists && doc.data().role === 'admin') {
                            isAdminUser = true;
                        } else {
                            isAdminUser = false;
                        }
                        updateAuthUI();
                        updatePageActions();
                    }).catch(error => {
                        console.error("Error checking user role:", error);
                        isAdminUser = false;
                        updateAuthUI();
                        updatePageActions();
                    });
                } else {
                    isAdminUser = false;
                    updateAuthUI();
                    updatePageActions();
                }
            });

            loginBtn?.addEventListener('click', () => {
                isLoginMode = true;
                updateAuthModalUI();
                authModal.show();
            });

            signupBtn?.addEventListener('click', () => {
                isLoginMode = false;
                updateAuthModalUI();
                authModal.show();
            });

            switchAuthMode.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                updateAuthModalUI();
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = authEmail.value;
                const password = authPassword.value;
                
                authSubmitBtn.disabled = true;
                authSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        // Create user profile in Firestore
                        await db.collection('users').doc(userCredential.user.uid).set({
                            email: email,
                            displayName: email.split('@')[0],
                            role: 'contributor',
                            joinDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    authModal.hide();
                    showSuccessMessage(isLoginMode ? 'Successfully logged in!' : 'Account created successfully!');
                } catch (error) {
                    authError.textContent = error.message;
                    authError.classList.remove('d-none');
                } finally {
                    authSubmitBtn.disabled = false;
                    authSubmitBtn.innerHTML = isLoginMode ? 'Log in' : 'Create account';
                }
            });
        }

        function updateAuthModalUI() {
            authModalTitle.textContent = isLoginMode ? 'Log in' : 'Create account';
            authSubmitBtn.textContent = isLoginMode ? 'Log in' : 'Create account';
            switchAuthMode.textContent = isLoginMode ? 'Create an account' : 'Already have an account?';
            authForm.reset();
            authError.classList.add('d-none');
        }

        function updateAuthUI() {
            if (currentUser) {
                const displayName = currentUser.email.split('@')[0];
                const badgeClass = isAdminUser ? 'contributor-badge admin' : 'contributor-badge';
                const badgeText = isAdminUser ? 'Admin' : 'Contributor';
                
                authStatus.innerHTML = `
                    <span class="user-greeting me-2">Welcome, ${displayName}</span>
                    <span class="${badgeClass}">${badgeText}</span>
                    <button id="logout-btn" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sign-out-alt me-1"></i> Log out
                    </button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                createPageItem.style.display = 'block';
                myContributionsItem.style.display = 'block';
                editTab.style.display = 'block';
            } else {
                authStatus.innerHTML = `
                    <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-sign-in-alt me-1"></i> Log in
                    </button>
                    <button id="signup-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-user-plus me-1"></i> Create account
                    </button>
                `;

                document.getElementById('login-btn').addEventListener('click', () => {
                    isLoginMode = true;
                    updateAuthModalUI();
                    authModal.show();
                });
                document.getElementById('signup-btn').addEventListener('click', () => {
                    isLoginMode = false;
                    updateAuthModalUI();
                    authModal.show();
                });
                createPageItem.style.display = 'none';
                myContributionsItem.style.display = 'none';
                editTab.style.display = 'none';
            }
        }

        // Enhanced navigation
        function setupNavigation() {
            document.addEventListener('click', (e) => {
                // Handle navigation links
                if (e.target.closest('[data-page]')) {
                    e.preventDefault();
                    const link = e.target.closest('[data-page]');
                    const pageId = link.getAttribute('data-page');
                    if (pageId) {
                        loadPage(pageId);
                        if (window.innerWidth <= 992) {
                            sidebar.classList.remove('show');
                            const icon = sidebarToggle.querySelector('i');
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                        updateActiveNavLink(link);
                    }
                }
            });

            searchBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchPages(searchTerm);
                }
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        searchPages(searchTerm);
                    }
                }
            });
        }

        function updateActiveNavLink(activeLink) {
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            // Add active class to clicked link
            activeLink.classList.add('active');
        }

        // Tab system setup
        function setupTabs() {
            pageTabs.addEventListener('click', (e) => {
                e.preventDefault();
                if (e.target.closest('[data-tab]')) {
                    const link = e.target.closest('[data-tab]');
                    const tabId = link.getAttribute('data-tab');
                    if (tabId) {
                        switchTab(tabId);
                    }
                }
            });
        }

        function switchTab(tabId) {
            currentTab = tabId;
            
            // Update tab appearance
            pageTabs.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Show appropriate content
            switch (tabId) {
                case 'article':
                    pageContent.style.display = 'block';
                    editSection.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    break;
                case 'discussion':
                    showDiscussion();
                    break;
                case 'edit':
                    if (currentUser) {
                        startEditing();
                    } else {
                        showLoginPrompt('Please log in to edit pages.');
                        switchTab('article');
                    }
                    break;
                case 'history':
                    showHistory();
                    break;
            }
        }

        // Show success message
        function showSuccessMessage(message, duration = 4000) {
            successText.textContent = message;
            successMessage.style.display = 'block';
            
            // Hide message after duration
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, duration);
        }

        // Show login prompt
        function showLoginPrompt(message) {
            const prompt = confirm(`${message} Would you like to log in now?`);
            if (prompt) {
                isLoginMode = true;
                updateAuthModalUI();
                authModal.show();
            }
        }

        // Enhanced editor setup
        function setupEditor() {
            const toolbar = document.querySelector('.edit-toolbar');
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('[data-format]');
                if (button) {
                    const format = button.getAttribute('data-format');
                    if (format === 'image') {
                        // Open image upload modal
                        imageUploadModal.show();
                    } else {
                        insertFormat(format);
                    }
                }
            });

            editContent.addEventListener('input', () => {
                updateLivePreview();
            });

            showPreview.addEventListener('click', () => {
                if (editPreview.style.display === 'none') {
                    editPreview.style.display = 'block';
                    showPreview.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide preview';
                    updatePreview();
                } else {
                    editPreview.style.display = 'none';
                    showPreview.innerHTML = '<i class="fas fa-eye me-1"></i> Show preview';
                }
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showLoginPrompt('You must be logged in to edit pages.');
                    return;
                }

                const title = editTitle.value.trim();
                const content = editContent.value.trim();
                const summary = editSummary.value.trim() || 'No edit summary provided';
                const isMinor = document.getElementById('minor-edit').checked;

                if (!title || !content) {
                    alert('Please provide both a title and content.');
                    return;
                }

                // Disable submit button and show loading state
                const submitBtn = editForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Saving...';

                try {
                    await submitRevision(title, content, summary, isMinor);
                    switchTab('article');
                    editForm.reset();
                    showSuccessMessage('Your changes have been submitted successfully!');
                    loadPage(currentPageId);
                } catch (error) {
                    console.error('Error submitting revision:', error);
                    alert('There was an error submitting your changes. Please try again.');
                } finally {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save changes';
                }
            });

            cancelEdit.addEventListener('click', () => {
                if (confirm('Are you sure you want to cancel editing? Your changes will be lost.')) {
                    switchTab('article');
                    editForm.reset();
                }
            });

            // Image upload functionality
            imageUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showLoginPrompt('You must be logged in to upload images.');
                    return;
                }

                const fileInput = document.getElementById('image-file');
                const title = document.getElementById('image-title').value.trim();
                const description = document.getElementById('image-description').value.trim();
                const source = document.getElementById('image-source').value.trim();
                const uploadError = document.getElementById('upload-error');
                const uploadProgress = document.getElementById('upload-progress');
                const uploadProgressBar = document.getElementById('upload-progress-bar');
                const uploadSubmitBtn = document.getElementById('upload-submit-btn');

                if (!fileInput.files.length || !title) {
                    uploadError.textContent = 'Please provide both an image file and title.';
                    uploadError.classList.remove('d-none');
                    return;
                }

                const file = fileInput.files[0];
                const fileName = `${Date.now()}-${file.name}`;
                const storageRef = storage.ref(`images/${fileName}`);

                // Reset UI
                uploadError.classList.add('d-none');
                uploadProgress.classList.remove('d-none');
                uploadSubmitBtn.disabled = true;
                uploadSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Uploading...';

                try {
                    // Upload file with progress tracking
                    const uploadTask = storageRef.put(file);
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgressBar.style.width = `${progress}%`;
                        },
                        (error) => {
                            throw error;
                        }
                    );

                    // Wait for upload to complete
                    await uploadTask;
                    
                    // Get download URL
                    const downloadURL = await storageRef.getDownloadURL();
                    
                    // Store image metadata in Firestore
                    await db.collection('images').add({
                        title: title,
                        description: description,
                        source: source,
                        url: downloadURL,
                        fileName: fileName,
                        uploadedBy: currentUser.uid,
                        uploadedByEmail: currentUser.email,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Insert image tag in editor
                    const imageTag = `[[Image:${downloadURL}|${title}|${description || title}]]`;
                    insertTextAtCursor(editContent, imageTag);
                    
                    // Close modal and reset form
                    imageUploadModal.hide();
                    imageUploadForm.reset();
                    showSuccessMessage('Image uploaded successfully!');
                    
                    // Update preview if open
                    updateLivePreview();
                } catch (error) {
                    console.error('Error uploading image:', error);
                    uploadError.textContent = `Error uploading image: ${error.message}`;
                    uploadError.classList.remove('d-none');
                } finally {
                    uploadProgress.classList.add('d-none');
                    uploadSubmitBtn.disabled = false;
                    uploadSubmitBtn.innerHTML = 'Upload Image';
                }
            });

            // Discussion form functionality
            discussionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showLoginPrompt('You must be logged in to start discussions.');
                    return;
                }

                const topic = document.getElementById('discussion-topic').value.trim();
                const content = document.getElementById('discussion-content').value.trim();
                const discussionError = document.getElementById('discussion-error');
                const submitBtn = discussionForm.querySelector('button[type="submit"]');

                if (!topic || !content) {
                    discussionError.textContent = 'Please provide both a topic and message.';
                    discussionError.classList.remove('d-none');
                    return;
                }

                // Disable submit button and show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Posting...';

                try {
                    await db.collection('discussions').add({
                        pageId: currentPageId,
                        topic: topic,
                        content: content,
                        author: currentUser.uid,
                        authorEmail: currentUser.email,
                        authorName: currentUser.email.split('@')[0],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'open'
                    });

                    // Close modal and reset form
                    discussionModal.hide();
                    discussionForm.reset();
                    showSuccessMessage('Discussion posted successfully!');
                    
                    // Refresh discussion tab
                    if (currentTab === 'discussion') {
                        showDiscussion();
                    }
                } catch (error) {
                    console.error('Error posting discussion:', error);
                    discussionError.textContent = `Error posting discussion: ${error.message}`;
                    discussionError.classList.remove('d-none');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Post Discussion';
                }
            });
        }

        function insertTextAtCursor(textarea, text) {
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;
            const scrollTop = textarea.scrollTop;
            
            textarea.value = textarea.value.substring(0, startPos) + text + 
                             textarea.value.substring(endPos, textarea.value.length);
            
            textarea.focus();
            textarea.selectionStart = startPos + text.length;
            textarea.selectionEnd = startPos + text.length;
            textarea.scrollTop = scrollTop;
        }

        function insertFormat(format) {
            const textarea = editContent;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = '';

            switch (format) {
                case 'header':
                    replacement = selectedText ? `== ${selectedText} ==` : '== New Section ==';
                    break;
                case 'bold':
                    replacement = selectedText ? `**${selectedText}**` : '**bold text**';
                    break;
                case 'italic':
                    replacement = selectedText ? `*${selectedText}*` : '*italic text*';
                    break;
                case 'link':
                    replacement = selectedText ? `[[${selectedText}]]` : '[[Link text]]';
                    break;
                case 'list':
                    if (selectedText) {
                        // Convert selected text to list items
                        const lines = selectedText.split('\n');
                        replacement = lines.map(line => `* ${line}`).join('\n');
                    } else {
                        replacement = '* List item\n* List item\n* List item';
                    }
                    break;
                case 'reference':
                    replacement = selectedText ? `<ref>${selectedText}</ref>` : '<ref>Citation needed</ref>';
                    break;
            }

            const newText = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.value = newText;
            textarea.focus();
            
            // Position cursor appropriately
            const newPosition = start + replacement.length;
            textarea.selectionStart = newPosition;
            textarea.selectionEnd = newPosition;
            
            updateLivePreview();
        }

        function updateLivePreview() {
            if (editPreview.style.display !== 'none') {
                updatePreview();
            }
        }

        function updatePreview() {
            const content = editContent.value;
            editPreviewContent.innerHTML = markdownToHtml(content);
        }

        async function submitRevision(title, content, summary, isMinor = false) {
            const pageId = generatePageId(title);
            
            // Check if this is a new page
            const isNewPage = !(await pageExists(pageId));
            
            const revisionData = {
                pageId: pageId,
                title: title,
                content: content,
                summary: summary,
                author: currentUser.uid,
                authorEmail: currentUser.email,
                authorName: currentUser.email.split('@')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isMinor: isMinor,
                status: isAdminUser ? 'approved' : 'pending',
                isNewPage: isNewPage
            };

            // Save revision to history
            await db.collection('revisions').add(revisionData);
            
            // If user is admin or this is an existing page, update the page content
            if (isAdminUser || !isNewPage) {
                const pageData = {
                    title: title,
                    content: content,
                    lastUpdatedBy: currentUser.uid,
                    lastUpdatedByEmail: currentUser.email,
                    lastUpdatedByName: currentUser.email.split('@')[0],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: isNewPage ? firebase.firestore.FieldValue.serverTimestamp() : undefined,
                    status: isAdminUser ? 'approved' : 'pending',
                };
                
                await db.collection('pages').doc(pageId).set(pageData, { merge: true });
            }
            
            // Update current page ID if this is a new page
            if (isNewPage) {
                currentPageId = pageId;
            }
        }

        async function pageExists(pageId) {
            const doc = await db.collection('pages').doc(pageId).get();
            return doc.exists;
        }

        // Enhanced page loading
        async function loadPage(pageId) {
            currentPageId = pageId;
            
            // Show loading spinner
            pageContent.style.display = 'none';
            loadingSpinner.style.display = 'block';
            
            try {
                const doc = await db.collection('pages').doc(pageId).get();
                if (doc.exists) {
                    const pageData = doc.data();
                    displayPage(pageData);
                } else {
                    displayDefaultContent(pageId);
                }
            } catch (error) {
                console.error('Error loading page:', error);
                displayError();
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                pageContent.style.display = 'block';
            }
            
            // Reset to article tab
            switchTab('article');
        }

        function displayPage(pageData) {
            pageTitle.textContent = pageData.title;
            pageContent.innerHTML = markdownToHtml(pageData.content);
            
            const lastModified = pageData.updatedAt ? formatDate(pageData.updatedAt) : 'Unknown date';
            let infoHTML = `<small>Last edited ${lastModified}`;
            
            if (pageData.lastUpdatedByName) {
                infoHTML += ` by <a href="#" data-page="user-${pageData.lastUpdatedBy}">${pageData.lastUpdatedByName}</a>`;
            }
            
            infoHTML += `</small>`;
            
            // Add status badge if needed
            if (pageData.status === 'pending') {
                infoHTML += `<span class="badge bg-warning ms-2">Pending approval</span>`;
            }
            
            pageInfo.innerHTML = infoHTML;
            
            updatePageActions();
            updateTableOfContents();
            
            // Add smooth animation to page content
            pageContent.style.animation = 'none';
            setTimeout(() => {
                pageContent.style.animation = 'fadeIn 0.3s ease';
            }, 10);
        }

        function displayDefaultContent(pageId) {
            if (pageId === 'home') {
                // Home page content is already in the HTML
                pageInfo.innerHTML = '<small>Main page</small>';
                updatePageActions();
                return;
            } else if (pageId === 'recent-changes') {
                displayRecentChanges();
                return;
            } else if (pageId === 'random-page') {
                loadRandomPage();
                return;
            } else if (pageId.startsWith('user-')) {
                displayUserProfile(pageId.replace('user-', ''));
                return;
            } else if (pageId === 'my-contributions') {
                displayMyContributions();
                return;
            }

            pageTitle.textContent = formatPageTitle(pageId);
            pageContent.innerHTML = `
                <div class="notice-box">
                    <i class="fas fa-info-circle me-2"></i>
                    <p><strong>This page does not exist yet.</strong></p>
                    <p>You can create it by clicking the "Edit" tab above${!currentUser ? ' (requires login)' : ''}.</p>
                </div>
            `;
            pageInfo.innerHTML = '<small>This page does not exist</small>';
        }

        async function loadRandomPage() {
            try {
                const snapshot = await db.collection('pages')
                    .where('status', '==', 'approved')
                    .limit(10)
                    .get();
                
                if (snapshot.empty) {
                    displayError('No pages available.');
                    return;
                }
                
                const pages = snapshot.docs;
                const randomIndex = Math.floor(Math.random() * pages.length);
                const randomPage = pages[randomIndex];
                
                loadPage(randomPage.id);
            } catch (error) {
                console.error('Error loading random page:', error);
                displayError();
            }
        }

        async function displayRecentChanges() {
            pageTitle.textContent = 'Recent Changes';
            pageContent.innerHTML = '<p>Loading recent changes...</p>';
            pageInfo.innerHTML = '<small>Special page</small>';
            
            try {
                const snapshot = await db.collection('revisions')
                    .orderBy('timestamp', 'desc')
                    .limit(25)
                    .get();
                
                if (snapshot.empty) {
                    pageContent.innerHTML = '<p>No recent changes available.</p>';
                    return;
                }
                
                let html = `<p>Recent changes to Minnesota Then (last 25 edits):</p>`;
                html += `<div class="list-group mt-3">`;
                
                snapshot.docs.forEach(doc => {
                    const revision = doc.data();
                    const date = formatDate(revision.timestamp);
                    const badge = revision.isMinor 
                        ? `<span class="history-badge minor">minor</span>` 
                        : `<span class="history-badge major">major</span>`;
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">
                                        <a href="#" data-page="${revision.pageId}">${revision.title}</a>
                                    </h5>
                                    <p class="mb-1 text-muted">
                                        ${date} · 
                                        <a href="#" data-page="user-${revision.author}">${revision.authorName || revision.authorEmail}</a> · 
                                        ${badge}
                                    </p>
                                    <p class="mb-0"><em>${revision.summary}</em></p>
                                </div>
                                <div>
                                    <span class="badge ${revision.isNewPage ? 'bg-success' : 'bg-primary'} rounded-pill">
                                        ${revision.isNewPage ? 'New' : 'Edit'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                pageContent.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent changes:', error);
                pageContent.innerHTML = '<div class="alert alert-danger">Error loading recent changes.</div>';
            }
        }

        async function displayUserProfile(userId) {
            pageContent.innerHTML = '<p>Loading user profile...</p>';
            
            try {
                // Get user data
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    pageContent.innerHTML = '<div class="alert alert-warning">User not found.</div>';
                    pageTitle.textContent = 'Unknown User';
                    return;
                }
                
                const userData = userDoc.data();
                pageTitle.textContent = userData.displayName || userData.email.split('@')[0];
                pageInfo.innerHTML = '<small>User profile</small>';
                
                // Get user contributions
                const revisions = await db.collection('revisions')
                    .where('author', '==', userId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                let html = `
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">User Information</h5>
                                    <p class="card-text">
                                        <strong>Username:</strong> ${userData.displayName || userData.email.split('@')[0]}<br>
                                        <strong>Role:</strong> ${userData.role.charAt(0).toUpperCase() + userData.role.slice(1)}<br>
                                        <strong>Member since:</strong> ${formatDate(userData.joinDate)}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h3>Recent Contributions</h3>
                `;
                
                if (revisions.empty) {
                    html += `<p>This user has not made any contributions yet.</p>`;
                } else {
                    html += `<div class="list-group">`;
                    revisions.docs.forEach(doc => {
                        const revision = doc.data();
                        html += `
                            <a href="#" class="list-group-item list-group-item-action" data-page="${revision.pageId}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${revision.title}</h5>
                                    <small>${formatDate(revision.timestamp)}</small>
                                </div>
                                <p class="mb-1">${revision.summary}</p>
                                <small class="text-muted">
                                    ${revision.isNewPage ? 'Created new page' : 'Edited page'}
                                    ${revision.isMinor ? ' (minor edit)' : ''}
                                </small>
                            </a>
                        `;
                    });
                    html += `</div>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                pageContent.innerHTML = html;
            } catch (error) {
                console.error('Error loading user profile:', error);
                pageContent.innerHTML = '<div class="alert alert-danger">Error loading user profile.</div>';
            }
        }

        async function displayMyContributions() {
            if (!currentUser) {
                pageContent.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        You need to be logged in to view your contributions.
                    </div>
                `;
                pageTitle.textContent = 'My Contributions';
                return;
            }
            
            pageTitle.textContent = 'My Contributions';
            pageInfo.innerHTML = '<small>Special page</small>';
            pageContent.innerHTML = '<p>Loading your contributions...</p>';
            
            try {
                const revisions = await db.collection('revisions')
                    .where('author', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                if (revisions.empty) {
                    pageContent.innerHTML = `
                        <div class="notice-box">
                            <p>You haven't made any contributions yet.</p>
                            <p>Get started by editing an existing page or creating a new one!</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <h3>Your Contributions</h3>
                    <p>You have made ${revisions.size} contribution(s) to Minnesota Then.</p>
                    <div class="list-group mt-3">
                `;
                
                revisions.docs.forEach(doc => {
                    const revision = doc.data();
                    const date = formatDate(revision.timestamp);
                    const badge = revision.isNewPage ? 'bg-success' : 'bg-primary';
                    const status = revision.status === 'pending' ? 
                        '<span class="badge bg-warning ms-2">Pending</span>' : 
                        '<span class="badge bg-success ms-2">Approved</span>';
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1">
                                        <a href="#" data-page="${revision.pageId}">${revision.title}</a>
                                        ${status}
                                    </h5>
                                    <p class="mb-1 text-muted">
                                        ${date} · 
                                        <span class="badge ${badge}">${revision.isNewPage ? 'Created' : 'Edited'}</span>
                                        ${revision.isMinor ? '<span class="history-badge minor">minor</span>' : ''}
                                    </p>
                                    <p class="mb-0"><em>${revision.summary}</em></p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                pageContent.innerHTML = html;
            } catch (error) {
                console.error('Error loading contributions:', error);
                pageContent.innerHTML = '<div class="alert alert-danger">Error loading your contributions.</div>';
            }
        }

        function displayError(message = 'There was an error loading this page. Please try again later.') {
            pageTitle.textContent = 'Error';
            pageContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>${message}</div>`;
            pageInfo.textContent = '';
        }

        function updatePageActions() {
            if (!currentUser) {
                pageActions.innerHTML = '';
                return;
            }

            pageActions.innerHTML = `
                <small>
                    <a href="#" onclick="switchTab('edit')" class="me-2">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <a href="#" onclick="switchTab('history')" class="me-2">
                        <i class="fas fa-history"></i> History
                    </a>
                    <a href="#" onclick="watchPage()" class="me-2">
                        <i class="far fa-star"></i> Watch
                    </a>
                </small>
            `;
        }

        function startEditing(pageData = null) {
            pageContent.style.display = 'none';
            editSection.style.display = 'block';
            
            if (pageData) {
                editTitle.value = pageData.title;
                editContent.value = pageData.content;
            } else {
                // Try to load current page data
                db.collection('pages').doc(currentPageId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        editTitle.value = data.title;
                        editContent.value = data.content;
                    } else {
                        editTitle.value = formatPageTitle(currentPageId);
                        editContent.value = `== ${formatPageTitle(currentPageId)} ==\n\nWrite your article content here.\n\n== References ==\n<references />\n\n[[Category:Minnesota History]]`;
                    }
                });
            }
        }

        // Enhanced search functionality
        async function searchPages(searchTerm) {
            pageTitle.textContent = `Search results for "${searchTerm}"`;
            pageContent.innerHTML = '<p><i class="fas fa-search me-2"></i> Searching...</p>';
            pageInfo.innerHTML = '<small>Search results</small>';

            try {
                // Search in titles (case insensitive)
                const titleResults = await db.collection('pages')
                    .orderBy('title')
                    .startAt(searchTerm.toLowerCase())
                    .endAt(searchTerm.toLowerCase() + '\uf8ff')
                    .limit(15)
                    .get();

                // Search in content (simplified - in production you'd use a proper search service)
                const contentResults = await db.collection('pages')
                    .limit(30)
                    .get();

                const filteredContentResults = contentResults.docs.filter(doc => {
                    const data = doc.data();
                    return (data.content && data.content.toLowerCase().includes(searchTerm.toLowerCase())) ||
                           (data.title && data.title.toLowerCase().includes(searchTerm.toLowerCase()));
                });

                if (titleResults.empty && filteredContentResults.length === 0) {
                    displayNoSearchResults(searchTerm);
                    return;
                }

                displaySearchResults([...titleResults.docs, ...filteredContentResults], searchTerm);
            } catch (error) {
                console.error('Error searching pages:', error);
                pageContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error performing search. Please try again.
                    </div>
                `;
            }
        }

        function displayNoSearchResults(searchTerm) {
            pageContent.innerHTML = `
                <div class="notice-box">
                    <i class="fas fa-search me-2"></i>
                    <p>No pages found matching "<strong>${searchTerm}</strong>".</p>
                    ${currentUser ? 
                        `<p><a href="#" onclick="createPageFromSearch('${searchTerm}')" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-plus me-1"></i> Create this page?
                        </a></p>` : 
                        '<p>Log in to create new pages.</p>'}
                </div>
            `;
        }

        function displaySearchResults(results, searchTerm) {
            // Remove duplicates based on document ID
            const uniqueResults = results.filter((doc, index, self) => 
                index === self.findIndex(d => d.id === doc.id)
            );

            let html = `<div class="mb-4">
                <i class="fas fa-search me-2"></i>
                Found ${uniqueResults.length} result(s) for "<strong>${searchTerm}</strong>":
            </div>`;
            
            html += '<div class="list-group">';
            
            uniqueResults.forEach(doc => {
                const page = doc.data();
                const snippet = extractSearchSnippet(page.content || '', searchTerm);
                html += `
                    <a href="#" class="list-group-item list-group-item-action" data-page="${doc.id}">
                        <h5 class="mb-1">${highlightSearchTerm(page.title || '', searchTerm)}</h5>
                        <p class="mb-1">${highlightSearchTerm(snippet, searchTerm)}...</p>
                        <small class="text-muted">Last modified ${page.updatedAt ? formatDate(page.updatedAt) : 'Unknown date'}</small>
                    </a>
                `;
            });
            
            html += '</div>';
            pageContent.innerHTML = html;
        }

        function extractSearchSnippet(content, searchTerm, maxLength = 200) {
            if (!content) return '';
            
            const lowerContent = content.toLowerCase();
            const lowerTerm = searchTerm.toLowerCase();
            const index = lowerContent.indexOf(lowerTerm);
            
            if (index === -1) {
                return content.substring(0, maxLength);
            }
            
            const start = Math.max(0, index - 50);
            const end = Math.min(content.length, index + maxLength - 50);
            
            return (start > 0 ? '...' : '') + content.substring(start, end) + (end < content.length ? '...' : '');
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!text) return '';
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function createPageFromSearch(searchTerm) {
            currentPageId = generatePageId(searchTerm);
            switchTab('edit');
            
            // Initialize editor with search term as title
            editTitle.value = searchTerm;
            editContent.value = `== ${searchTerm} ==\n\nWrite your article content here.\n\n== References ==\n<references />\n\n[[Category:Minnesota History]]`;
        }

        // Featured Articles
        async function loadFeaturedArticles() {
            const featuredSection = document.getElementById('featured-articles');
            try {
                const snapshot = await db.collection('pages')
                    .where('featured', '==', true)
                    .limit(5)
                    .get();

                if (snapshot.empty) {
                    // If no featured articles, show recent articles
                    const recentSnapshot = await db.collection('pages')
                        .where('status', '==', 'approved')
                        .orderBy('updatedAt', 'desc')
                        .limit(3)
                        .get();
                    
                    if (recentSnapshot.empty) {
                        featuredSection.innerHTML = '<p><em>No articles available yet. Be the first to contribute!</em></p>';
                        return;
                    }
                    
                    displayRecentArticles(recentSnapshot, featuredSection);
                    return;
                }

                displayFeaturedArticles(snapshot, featuredSection);
            } catch (error) {
                console.error('Error loading featured articles:', error);
                featuredSection.innerHTML = '<div class="alert alert-warning">Unable to load featured articles at this time.</div>';
            }
        }

        function displayFeaturedArticles(snapshot, container) {
            let html = '<div class="row">';
            snapshot.forEach(doc => {
                const article = doc.data();
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="#" data-page="${doc.id}">${article.title}</a>
                                </h5>
                                <p class="card-text">${stripWikiMarkup(article.content || '').substring(0, 150)}...</p>
                                <a href="#" data-page="${doc.id}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-book-open me-1"></i> Read article
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayRecentArticles(snapshot, container) {
            let html = '<p><em>Recent contributions:</em></p><div class="row">';
            snapshot.forEach(doc => {
                const article = doc.data();
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="#" data-page="${doc.id}">${article.title}</a>
                                </h5>
                                <p class="card-text">${stripWikiMarkup(article.content || '').substring(0, 150)}...</p>
                                <a href="#" data-page="${doc.id}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-book-open me-1"></i> Read article
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Discussion and History tabs
        function showDiscussion() {
            loadingSpinner.style.display = 'block';
            pageContent.style.display = 'none';
            editSection.style.display = 'none';
            
            // Load discussions for current page
            db.collection('discussions')
                .where('pageId', '==', currentPageId)
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Discussion for "${pageTitle.textContent}"</h3>
                            ${currentUser ? 
                                `<button class="btn btn-primary" onclick="startDiscussion()">
                                    <i class="fas fa-comment-dots me-1"></i> Start a discussion
                                </button>` : 
                                '<button class="btn btn-primary" disabled>Log in to participate</button>'}
                        </div>
                    `;
                    
                    if (snapshot.empty) {
                        html += `
                            <div class="notice-box text-center py-4">
                                <i class="fas fa-comments fa-3x mb-3 text-muted"></i>
                                <p>No discussions have been started for this page yet.</p>
                                ${currentUser ? 
                                    `<p>Be the first to start a discussion!</p>` : 
                                    `<p>Log in to start a discussion.</p>`}
                            </div>
                        `;
                    } else {
                        html += `<div class="discussion-list">`;
                        snapshot.forEach(doc => {
                            const discussion = doc.data();
                            const date = formatDate(discussion.createdAt);
                            
                            html += `
                                <div class="card mb-3 shadow-sm">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">${discussion.topic}</h5>
                                        <span class="badge ${discussion.status === 'open' ? 'bg-success' : 'bg-secondary'}">
                                            ${discussion.status === 'open' ? 'Open' : 'Closed'}
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${discussion.content}</p>
                                    </div>
                                    <div class="card-footer text-muted d-flex justify-content-between">
                                        <span>
                                            <i class="fas fa-user me-1"></i>
                                            <a href="#" data-page="user-${discussion.author}">${discussion.authorName}</a>
                                        </span>
                                        <span><i class="far fa-clock me-1"></i> ${date}</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    
                    loadingSpinner.style.display = 'none';
                    pageContent.style.display = 'block';
                    pageContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading discussions:', error);
                    loadingSpinner.style.display = 'none';
                    pageContent.style.display = 'block';
                    pageContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading discussions. Please try again.
                        </div>
                    `;
                });
        }

        async function showHistory() {
            loadingSpinner.style.display = 'block';
            pageContent.style.display = 'none';
            editSection.style.display = 'none';
            
            try {
                const snapshot = await db.collection('revisions')
                    .where('pageId', '==', currentPageId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                let html = `<h3>Revision history</h3>`;
                
                if (snapshot.empty) {
                    html += '<p>No revision history available for this page.</p>';
                } else {
                    html += `<div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Summary</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    snapshot.forEach(doc => {
                        const revision = doc.data();
                        const date = formatDate(revision.timestamp);
                        const typeClass = revision.isMinor ? 'text-muted' : 'fw-bold';
                        
                        html += `
                            <tr class="history-item">
                                <td>${date}</td>
                                <td>
                                    <a href="#" data-page="user-${revision.author}">${revision.authorName || revision.authorEmail}</a>
                                </td>
                                <td class="${typeClass}">
                                    ${revision.summary}
                                    ${revision.status === 'pending' ? '<span class="badge bg-warning ms-2">Pending</span>' : ''}
                                </td>
                                <td>
                                    <span class="history-badge ${revision.isMinor ? 'minor' : 'major'}">
                                        ${revision.isMinor ? 'minor' : 'major'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    </div>`;
                }
                
                loadingSpinner.style.display = 'none';
                pageContent.style.display = 'block';
                pageContent.innerHTML = html;
            } catch (error) {
                console.error('Error loading history:', error);
                loadingSpinner.style.display = 'none';
                pageContent.style.display = 'block';
                pageContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error loading revision history.
                    </div>
                `;
            }
        }

        // Table of Contents generation
        function updateTableOfContents() {
            const headings = pageContent.querySelectorAll('h2, h3');
            const toc = document.getElementById('toc');
            
            if (headings.length < 3) {
                toc.style.display = 'none';
                return;
            }
            
            toc.style.display = 'block';
            const tocList = toc.querySelector('ul');
            tocList.innerHTML = '';
            
            let sectionNum = 1;
            let subsectionNum = 1;
            
            headings.forEach(heading => {
                const text = heading.textContent;
                const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                heading.id = id;
                
                const li = document.createElement('li');
                
                if (heading.tagName === 'H2') {
                    li.innerHTML = `${sectionNum} <a href="#${id}">${text}</a>`;
                    sectionNum++;
                    subsectionNum = 1;
                } else if (heading.tagName === 'H3') {
                    li.innerHTML = `${sectionNum - 1}.${subsectionNum} <a href="#${id}">${text}</a>`;
                    li.style.marginLeft = '1rem';
                    subsectionNum++;
                }
                
                tocList.appendChild(li);
            });
        }

        // Enhanced Helper Functions
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            return markdown
                // Headers
                .replace(/^====\s*(.*?)\s*====$/gm, '<h4>$1</h4>')
                .replace(/^===\s*(.*?)\s*===$/gm, '<h3>$1</h3>')
                .replace(/^==\s*(.*?)\s*==$/gm, '<h2>$1</h2>')
                // Text formatting
                .replace(/'''(.*?)'''/g, '<strong>$1</strong>')
                .replace(/''(.*?)''/g, '<em>$1</em>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Links
                .replace(/\[\[(.*?)\|(.*?)\]\]/g, '<a href="#" data-page="$1">$2</a>')
                .replace(/\[\[(.*?)\]\]/g, '<a href="#" data-page="$1">$1</a>')
                // Images
                .replace(/\[\[Image:(.*?)\|(.*?)\|(.*?)\]\]/g, '<figure class="figure"><img src="$1" alt="$3" class="figure-img img-fluid rounded"><figcaption class="figure-caption">$3</figcaption></figure>')
                // References
                .replace(/<ref>(.*?)<\/ref>/g, '<sup class="reference"><a href="#references">[$1]</a></sup>')
                .replace(/<references\s*\/>/g, '<div class="references"><h3>References</h3><ol><li>References will appear here</li></ol></div>')
                // Categories
                .replace(/\[\[Category:(.*?)\]\]/g, '')
                // Lists
                .replace(/^\*\s*(.*?)$/gm, '<li>$1</li>')
                .replace(/<li>(.+?)(?=\n<li>|\n|$)/gs, '<li>$1</li>')
                .replace(/(<li>.+?<\/li>\n)+/gs, '<ul>$&</ul>')
                // Line breaks and paragraphs
                .replace(/\n\n/g, '</p><p>')
                .replace(/^\s*$(?:\r\n?|\n)/gm, '</p><p>')
                .replace(/^(?!<[h|p|u|o|l])/gm, '<p>')
                .replace(/(?<![>])\n/g, '<br>')
                // Clean up
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[2-6]>)/g, '$1')
                .replace(/(<\/h[2-6]>)<\/p>/g, '$1')
                .replace(/<p>(<ul>)/g, '$1')
                .replace(/(<\/ul>)<\/p>/g, '$1')
                .replace(/<p>(<figure)/g, '$1')
                .replace(/(<\/figure>)<\/p>/g, '$1');
        }

        function stripWikiMarkup(text) {
            if (!text) return '';
            
            return text
                .replace(/==+\s*(.*?)\s*==+/g, '$1')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/\[\[(.*?)\|(.*?)\]\]/g, '$2')
                .replace(/\[\[(.*?)\]\]/g, '$1')
                .replace(/<ref>.*?<\/ref>/g, '')
                .replace(/<.*?>/g, '')
                .replace(/\n+/g, ' ')
                .trim();
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        function generatePageId(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .replace(/^-|-$/g, '');
        }

        function formatPageTitle(pageId) {
            return pageId
                .replace(/-/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        // Global functions for onclick handlers
        window.loadPage = loadPage;
        window.switchTab = switchTab;
        window.createPageFromSearch = createPageFromSearch;
        window.startDiscussion = () => {
            if (!currentUser) {
                showLoginPrompt('Please log in to start a discussion.');
                return;
            }
            discussionModal.show();
        };
        window.watchPage = () => {
            if (!currentUser) {
                showLoginPrompt('Please log in to watch pages.');
                return;
            }
            // Add page to user's watch list
            db.collection('users').doc(currentUser.uid).update({
                watchedPages: firebase.firestore.FieldValue.arrayUnion(currentPageId)
            }).then(() => {
                showSuccessMessage('Page added to your watch list');
            }).catch(error => {
                console.error('Error updating watch list:', error);
                alert('Error adding page to watch list');
            });
        };

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
