<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Minnesota Then - A Community History Wiki</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Toastr for notifications -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    
    <style>
        :root {
            /* Primary palette */
            --primary-50: #EFF6FF;
            --primary-100: #DBEAFE;
            --primary-200: #BFDBFE;
            --primary-300: #93C5FD;
            --primary-400: #60A5FA;
            --primary-500: #3B82F6;
            --primary-600: #2563EB;
            --primary-700: #1D4ED8;
            --primary-800: #1E40AF;
            --primary-900: #1E3A8A;
            
            /* Secondary palette */
            --secondary-50: #EEF2FF;
            --secondary-100: #E0E7FF;
            --secondary-200: #C7D2FE;
            --secondary-300: #A5B4FC;
            --secondary-400: #818CF8;
            --secondary-500: #6366F1;
            --secondary-600: #4F46E5;
            --secondary-700: #4338CA;
            --secondary-800: #3730A3;
            --secondary-900: #312E81;
            
            /* Neutral palette */
            --neutral-50: #F9FAFB;
            --neutral-100: #F3F4F6;
            --neutral-200: #E5E7EB;
            --neutral-300: #D1D5DB;
            --neutral-400: #9CA3AF;
            --neutral-500: #6B7280;
            --neutral-600: #4B5563;
            --neutral-700: #374151;
            --neutral-800: #1F2937;
            --neutral-900: #111827;
            
            /* Status colors */
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            
            /* Legacy wiki variables */
            --wiki-bg: var(--neutral-50);
            --wiki-text: var(--neutral-900);
            --wiki-link: var(--primary-600);
            --wiki-link-visited: var(--primary-800);
            --wiki-link-new: var(--error);
            --wiki-border: var(--neutral-300);
            --wiki-header: var(--neutral-100);
            --wiki-sidebar: var(--neutral-100);
            --wiki-blue: var(--primary-600);
            --wiki-gray: var(--neutral-500);
            
            /* Spacing system (8px increments) */
            --space-1: 0.25rem; /* 4px */
            --space-2: 0.5rem;  /* 8px */
            --space-3: 0.75rem; /* 12px */
            --space-4: 1rem;    /* 16px */
            --space-5: 1.25rem; /* 20px */
            --space-6: 1.5rem;  /* 24px */
            --space-8: 2rem;    /* 32px */
            --space-10: 2.5rem; /* 40px */
            --space-12: 3rem;   /* 48px */
            --space-16: 4rem;   /* 64px */
            
            /* Typography */
            --font-heading: 'EB Garamond', Georgia, Times, serif;
            --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Animation */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--wiki-bg);
            color: var(--wiki-text);
            line-height: 1.6;
            font-size: 14px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            line-height: 1.2;
        }

        /* Wikipedia-style header */
        .wiki-header {
            background-color: var(--wiki-header);
            border-bottom: 1px solid var(--wiki-border);
            padding: var(--space-2) 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            transition: box-shadow var(--transition-normal);
        }

        .wiki-header.scrolled {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .wiki-title {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            color: var(--wiki-text);
            font-weight: normal;
            margin: 0;
            transition: color var(--transition-fast);
        }

        .wiki-title:hover {
            color: var(--primary-600);
        }

        .wiki-subtitle {
            font-style: italic;
            color: var(--wiki-gray);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Wikipedia-style sidebar */
        .sidebar {
            background-color: var(--wiki-sidebar);
            border-right: 1px solid var(--wiki-border);
            padding: var(--space-2);
            min-height: calc(100vh - 80px);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .sidebar h5 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--wiki-text);
            margin: var(--space-4) 0 var(--space-2) 0;
            padding: var(--space-1) var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
        }

        .sidebar .nav-link {
            color: var(--wiki-link);
            padding: var(--space-1) var(--space-2);
            font-size: 0.85rem;
            border-radius: 4px;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .sidebar .nav-link:hover {
            color: var(--wiki-link);
            background-color: var(--primary-50);
            text-decoration: underline;
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-100);
            color: var(--primary-800);
            font-weight: 500;
        }

        /* Mobile sidebar toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary-600);
            color: white;
            border: none;
            z-index: 1100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }

        .sidebar-toggle:hover {
            background-color: var(--primary-700);
            transform: translateY(-2px);
        }

        /* Main content area */
        .content-area {
            background-color: var(--wiki-bg);
            padding: var(--space-4) var(--space-6);
            min-height: calc(100vh - 80px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0.8; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Wikipedia-style page title */
        #page-title {
            font-family: var(--font-heading);
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--wiki-text);
            margin-bottom: var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: var(--space-1);
        }

        /* Page metadata */
        .content-meta {
            font-size: 0.8rem;
            color: var(--wiki-gray);
            margin-bottom: var(--space-4);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--neutral-200);
        }

        /* Wikipedia-style tabs */
        .page-tabs {
            border-bottom: 1px solid var(--wiki-border);
            margin-bottom: var(--space-4);
        }

        .page-tabs .nav-link {
            border: 1px solid transparent;
            border-bottom: none;
            background-color: var(--wiki-header);
            color: var(--wiki-link);
            font-size: 0.85rem;
            padding: var(--space-2) var(--space-4);
            margin-right: var(--space-1);
            border-radius: 4px 4px 0 0;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .page-tabs .nav-link:hover {
            background-color: #fff;
            text-decoration: underline;
        }

        .page-tabs .nav-link.active {
            background-color: #fff;
            border-color: var(--wiki-border);
            color: var(--wiki-text);
            font-weight: 500;
        }

        /* Table of Contents */
        .toc {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            width: fit-content;
            float: right;
            max-width: 300px;
            font-size: 0.9rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .toc-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
            text-align: center;
            color: var(--neutral-700);
        }

        .toc ul {
            list-style-type: none;
            padding-left: var(--space-4);
            margin: 0;
        }

        .toc li {
            margin: var(--space-1) 0;
        }

        .toc a {
            color: var(--wiki-link);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .toc a:hover {
            text-decoration: underline;
            color: var(--primary-700);
        }

        /* Wikipedia-style sections */
        .wiki-section {
            margin-bottom: var(--space-8);
            clear: both;
        }

        .wiki-section h2 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 500;
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: var(--space-1);
            margin-top: var(--space-8);
            margin-bottom: var(--space-4);
            color: var(--neutral-800);
        }

        .wiki-section h3 {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: var(--space-6);
            margin-bottom: var(--space-2);
            color: var(--neutral-800);
        }

        /* Links */
        a {
            color: var(--wiki-link);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            text-decoration: underline;
        }

        a:visited {
            color: var(--wiki-link-visited);
        }

        .new-page-link {
            color: var(--wiki-link-new);
        }

        /* Search box */
        .search-container {
            margin: var(--space-4) 0;
        }

        .search-container input {
            font-size: 0.85rem;
            border: 1px solid var(--wiki-border);
            border-radius: 4px 0 0 4px;
            padding: var(--space-2);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .search-container input:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px var(--primary-100);
            outline: none;
        }

        .search-container button {
            font-size: 0.85rem;
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            border-left: none;
            color: var(--wiki-text);
            border-radius: 0 4px 4px 0;
            padding: var(--space-2) var(--space-3);
            transition: background-color var(--transition-fast);
        }

        .search-container button:hover {
            background-color: var(--neutral-200);
        }

        /* Edit toolbar */
        .edit-toolbar {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-2);
            margin-bottom: var(--space-4);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .edit-toolbar button {
            margin-right: var(--space-2);
            font-size: 0.8rem;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
        }

        .edit-toolbar button:hover {
            transform: translateY(-1px);
        }

        /* References */
        .references {
            font-size: 0.85rem;
            border-top: 1px solid var(--wiki-border);
            margin-top: var(--space-8);
            padding-top: var(--space-4);
        }

        .reference {
            color: var(--wiki-link);
            font-size: 0.75rem;
            text-decoration: none;
        }

        /* Infobox styling */
        .infobox {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-4);
            margin: 0 0 var(--space-4) var(--space-4);
            width: 300px;
            float: right;
            font-size: 0.9rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .infobox-title {
            font-weight: 600;
            text-align: center;
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
            color: var(--neutral-700);
        }

        .infobox-item {
            margin-bottom: var(--space-2);
            border-bottom: 1px solid var(--neutral-200);
            padding-bottom: var(--space-2);
        }

        .infobox-label {
            font-weight: 500;
            color: var(--neutral-700);
        }

        .infobox-value {
            color: var(--neutral-900);
        }

        /* Notices and status boxes */
        .notice-box {
            background-color: var(--primary-50);
            border: 1px solid var(--primary-200);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            border-radius: 4px;
            animation: fadeIn 0.4s ease;
        }

        .approval-pending {
            background-color: var(--warning-50);
            border: 1px solid var(--warning-200);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-radius: 4px;
        }

        /* Success message */
        .success-message {
            background-color: var(--success-50);
            border: 1px solid var(--success-200);
            color: var(--success-700);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-radius: 4px;
            display: none;
            animation: fadeIn 0.4s ease;
        }

        /* Footer */
        .wiki-footer {
            background-color: var(--wiki-header);
            border-top: 1px solid var(--wiki-border);
            padding: var(--space-8) 0;
            margin-top: var(--space-12);
            font-size: 0.8rem;
        }

        .wiki-footer h5 {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--neutral-700);
        }

        .wiki-footer a {
            color: var(--primary-600);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .wiki-footer a:hover {
            color: var(--primary-800);
            text-decoration: underline;
        }

        /* Auth status */
        #auth-status {
            font-size: 0.85rem;
        }

        .user-greeting {
            color: var(--neutral-700);
            font-weight: 500;
        }

        /* Modal customizations */
        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .modal-header {
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-4) var(--space-6);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            border-top: 1px solid var(--neutral-200);
            padding: var(--space-4) var(--space-6);
        }

        /* Form controls */
        .form-control:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        /* Button customizations */
        .btn-primary {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
            transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .btn-primary:hover {
            background-color: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-outline-primary {
            border-color: var(--primary-600);
            color: var(--primary-600);
            transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-50);
            color: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
        }

        /* Contributor badge */
        .contributor-badge {
            font-size: 0.7rem;
            background-color: var(--primary-100);
            color: var(--primary-800);
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: var(--space-2);
            vertical-align: middle;
            font-weight: 500;
        }

        .contributor-badge.admin {
            background-color: var(--secondary-100);
            color: var(--secondary-800);
        }

        /* Loading spinner */
        .loading-spinner {
            display: none;
            margin: var(--space-8) auto;
            text-align: center;
        }

        .spinner-border {
            color: var(--primary-500);
            width: 3rem;
            height: 3rem;
        }

        /* Edit history styles */
        .history-item {
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-3) 0;
            transition: background-color var(--transition-fast);
        }

        .history-item:hover {
            background-color: var(--neutral-50);
        }

        .history-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .history-badge.minor {
            background-color: var(--neutral-100);
            color: var(--neutral-700);
        }

        .history-badge.major {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        .history-badge.pending {
            background-color: var(--warning-100);
            color: var(--warning-800);
        }

        /* Admin dashboard */
        .admin-dashboard {
            background-color: var(--neutral-50);
            border-radius: 8px;
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .admin-card {
            background-color: white;
            border-radius: 8px;
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform var(--transition-fast);
        }

        .admin-card:hover {
            transform: translateY(-2px);
        }

        .admin-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: var(--neutral-800);
        }

        /* Structured editor */
        .section-editor {
            margin-bottom: var(--space-4);
            border: 1px solid var(--neutral-200);
            border-radius: 4px;
            padding: var(--space-3);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .section-actions button {
            margin-left: var(--space-2);
        }

        /* Citation styles */
        .citation {
            font-size: 0.8rem;
            margin-bottom: var(--space-2);
            padding-left: var(--space-3);
            text-indent: -1rem;
        }

        .citation-number {
            font-weight: 600;
            margin-right: 0.3rem;
        }

        /* Responsive design */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 80px;
                width: 280px;
                z-index: 1200;
                bottom: 0;
                box-shadow: none;
                transition: left var(--transition-normal), box-shadow var(--transition-normal);
            }
            
            .sidebar.show {
                left: 0;
                box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .content-area {
                padding: var(--space-4);
            }
            
            .wiki-title {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                top: 70px;
            }
            
            .toc {
                float: none;
                width: 100%;
                max-width: none;
                margin: var(--space-4) 0;
            }
            
            .infobox {
                float: none;
                width: 100%;
                margin: var(--space-4) 0;
            }
            
            .wiki-title {
                font-size: 1.5rem;
                text-align: center;
            }
            
            #page-title {
                font-size: 1.8rem;
            }
            
            .page-tabs .nav-link {
                padding: var(--space-2);
            }
            
            #auth-status {
                justify-content: center !important;
                margin-top: var(--space-2);
            }
        }

        @media (max-width: 576px) {
            .wiki-title {
                font-size: 1.3rem;
            }
            
            .wiki-subtitle {
                font-size: 0.75rem;
            }
            
            #page-title {
                font-size: 1.6rem;
            }
            
            .page-tabs .nav-link {
                font-size: 0.8rem;
                padding: var(--space-1) var(--space-2);
            }
            
            .content-area {
                padding: var(--space-3);
            }
            
            .edit-toolbar button {
                padding: var(--space-1) var(--space-2);
                margin-bottom: var(--space-2);
                font-size: 0.75rem;
            }
        }

        /* Print styles */
        @media print {
            .sidebar, .wiki-header, .wiki-footer, .edit-toolbar, #auth-status, .page-tabs {
                display: none !important;
            }
            
            .content-area {
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            body {
                font-size: 12pt;
                line-height: 1.4;
            }
            
            #page-title {
                font-size: 24pt;
                border-bottom: 1pt solid #000;
                margin-bottom: 12pt;
            }
            
            .wiki-section h2 {
                font-size: 18pt;
                border-bottom: 0.5pt solid #000;
                margin: 16pt 0 8pt 0;
                page-break-after: avoid;
            }
            
            .wiki-section h3 {
                font-size: 14pt;
                margin: 12pt 0 6pt 0;
                page-break-after: avoid;
            }
            
            a {
                color: #000;
                text-decoration: none;
            }
            
            a::after {
                content: " (" attr(href) ")";
                font-size: 90%;
                color: #333;
            }
            
            .toc, .infobox {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <header class="wiki-header" id="wikiHeader">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-8 col-md-6">
                    <a href="/" class="text-decoration-none">
                        <h1 class="wiki-title">Minnesota Then</h1>
                        <p class="wiki-subtitle">A Community History Wiki</p>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div id="auth-status" class="d-flex justify-content-end">
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                        <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid">
        <div class="row">
            <div class="col-lg-2 col-md-3 p-0">
                <div class="sidebar" id="sidebar">
                    <h5>Navigation</h5>
                    <ul class="nav flex-column" id="sidebar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="home">Main page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recent-changes">Recent changes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="random-page">Random article</a>
                        </li>
                        <li class="nav-item" id="admin-dashboard-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="admin-dashboard">Admin Dashboard</a>
                        </li>
                    </ul>

                    <h5>Topics</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="landmarks">Historic Landmarks</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="people">Notable People</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="events">Historic Events</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="indigenous">Indigenous History</a>
                        </li>
                    </ul>

                    <h5>Tools</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="help">Help</a>
                        </li>
                        <li class="nav-item" id="create-page-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="create-page">Create a page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="special-pages">Special pages</a>
                        </li>
                        <li class="nav-item" id="my-contributions-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="my-contributions">My contributions</a>
                        </li>
                    </ul>

                    <div class="search-container">
                        <h5>Search</h5>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="search-input" placeholder="Search Minnesota Then">
                            <button class="btn btn-outline-secondary" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <div class="col-lg-10 col-md-9">
                <div class="content-area">
                    <!-- Page tabs (Wikipedia-style) -->
                    <ul class="nav nav-tabs page-tabs" id="page-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-tab="article">Article</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="discussion">Discussion</a>
                        </li>
                        <li class="nav-item" id="edit-tab" style="display: none;">
                            <a class="nav-link" href="#" data-tab="edit">Edit</a>
                        </li>
                        <li class="nav-item" id="history-tab">
                            <a class="nav-link" href="#" data-tab="history">View history</a>
                        </li>
                    </ul>

                    <!-- Success Message -->
                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="success-text">Your changes have been saved successfully!</span>
                    </div>

                    <!-- Loading spinner -->
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading content...</p>
                    </div>

                    <!-- Page content container -->
                    <div id="page-container">
                        <!-- Content will be dynamically loaded here -->
                    </div>

                    <!-- Edit section (hidden by default) -->
                    <div id="edit-section" class="mt-4" style="display: none;">
                        <div class="edit-toolbar">
                            <strong>Editing tools:</strong>
                            <button class="btn btn-sm btn-outline-secondary" data-format="header">
                                <i class="fas fa-heading me-1"></i> Heading
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="bold">
                                <i class="fas fa-bold me-1"></i> Bold
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="italic">
                                <i class="fas fa-italic me-1"></i> Italic
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="link">
                                <i class="fas fa-link me-1"></i> Link
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="list">
                                <i class="fas fa-list me-1"></i> List
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="image">
                                <i class="fas fa-image me-1"></i> Image
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="reference">
                                <i class="fas fa-quote-right me-1"></i> Reference
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="sidebar">
                                <i class="fas fa-columns me-1"></i> Sidebar
                            </button>
                        </div>
                        <form id="edit-form">
                            <div class="mb-3">
                                <label for="edit-title" class="form-label">Article title</label>
                                <input type="text" class="form-control" id="edit-title" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-lead" class="form-label">Lead paragraph</label>
                                <textarea class="form-control" id="edit-lead" rows="3" placeholder="Brief summary of the article"></textarea>
                            </div>
                            
                            <div id="section-container">
                                <!-- Sections will be added here dynamically -->
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-section-btn">
                                <i class="fas fa-plus me-1"></i> Add Section
                            </button>
                            
                            <div class="mb-3">
                                <label for="edit-bibliography" class="form-label">Bibliography</label>
                                <textarea class="form-control" id="edit-bibliography" rows="5" placeholder="List of sources (one per line)"></textarea>
                                <small class="form-text text-muted">Format: Author, Title, Publisher, Year, URL (optional)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-sidebar" class="form-label">Sidebar Content</label>
                                <div id="sidebar-fields">
                                    <div class="mb-2">
                                        <label class="form-label">Sidebar Image URL</label>
                                        <input type="text" class="form-control" id="edit-sidebar-image" placeholder="Image URL">
                                    </div>
                                    <div id="sidebar-facts-container">
                                        <!-- Sidebar facts will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="add-sidebar-fact">
                                        <i class="fas fa-plus me-1"></i> Add Fact
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="edit-summary" class="form-label">Edit summary</label>
                                <input type="text" class="form-control" id="edit-summary" placeholder="Briefly describe your changes" maxlength="200">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="minor-edit">
                                <label class="form-check-label" for="minor-edit">
                                    This is a minor edit
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Save changes
                            </button>
                            <button type="button" class="btn btn-secondary" id="show-preview">
                                <i class="fas fa-eye me-1"></i> Show preview
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="cancel-edit">
                                <i class="fas fa-times me-1"></i> Cancel
                            </button>
                        </form>
                        
                        <div id="edit-preview" class="mt-3" style="display: none;">
                            <h4>Preview</h4>
                            <div class="border p-3" id="edit-preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="wiki-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h5>Minnesota Then</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="about">About Minnesota Then</a></li>
                        <li><a href="#" data-page="disclaimers">General disclaimer</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contribute</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="help">Help</a></li>
                        <li><a href="#" data-page="community-portal">Community portal</a></li>
                        <li><a href="#" data-page="recent-changes">Recent changes</a></li>
                        <li><a href="#" data-page="contact">Contact page</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Tools</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="special-pages">Special pages</a></li>
                        <li><a href="#" data-page="permanent-link">Permanent link</a></li>
                        <li><a href="#" data-page="page-information">Page information</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Legal</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="privacy">Privacy policy</a></li>
                        <li><a href="#" data-page="terms">Terms of use</a></li>
                        <li><small>Content is available under <a href="#" data-page="license">CC BY-SA 4.0</a></small></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <small>&copy; 2025 Minnesota Then Community. Powered by community contributions.</small>
            </div>
        </div>
    </footer>

    <!-- Authentication Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Log in</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="mb-3">
                            <label for="auth-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="auth-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div id="auth-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100" id="auth-submit-btn">Log in</button>
                    </form>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-link" id="switch-auth-mode">Create an account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal fade" id="imageUploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="image-upload-form">
                        <div class="mb-3">
                            <label for="image-file" class="form-label">Select Image</label>
                            <input type="file" class="form-control" id="image-file" accept="image/*" required>
                        </div>
                        <div class="mb-3">
                            <label for="image-title" class="form-label">Image Title</label>
                            <input type="text" class="form-control" id="image-title" placeholder="Descriptive title for the image" required>
                        </div>
                        <div class="mb-3">
                            <label for="image-description" class="form-label">Description</label>
                            <textarea class="form-control" id="image-description" rows="3" placeholder="Describe the image and provide attribution"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="image-source" class="form-label">Source</label>
                            <input type="text" class="form-control" id="image-source" placeholder="Original source of the image">
                        </div>
                        <div id="upload-error" class="alert alert-danger d-none"></div>
                        <div id="upload-progress" class="progress d-none mb-3">
                            <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="upload-submit-btn">Upload Image</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Discussion Modal -->
    <div class="modal fade" id="discussionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Start a discussion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="discussion-form">
                        <div class="mb-3">
                            <label for="discussion-topic" class="form-label">Topic</label>
                            <input type="text" class="form-control" id="discussion-topic" required>
                        </div>
                        <div class="mb-3">
                            <label for="discussion-content" class="form-label">Message</label>
                            <textarea class="form-control" id="discussion-content" rows="6" required></textarea>
                        </div>
                        <div id="discussion-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary">Post Discussion</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Review Changes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Version</h6>
                            <div id="current-version" class="border p-3" style="height: 500px; overflow-y: auto;"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Proposed Changes</h6>
                            <div id="proposed-changes" class="border p-3" style="height: 500px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="approval-comment" class="form-label">Comment</label>
                        <textarea class="form-control" id="approval-comment" rows="3" placeholder="Add any comments about your decision"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="reject-changes">
                        <i class="fas fa-times me-1"></i> Reject
                    </button>
                    <button type="button" class="btn btn-success" id="approve-changes">
                        <i class="fas fa-check me-1"></i> Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Toastr for notifications -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <!-- SimpleMDE Markdown Editor -->
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    
    <!-- Diff library for comparing versions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.1/diff.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };

        // Initialize Firebase
        let firebaseApp;
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }

        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Toastr configuration
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "5000"
        };

        // DOM Elements
        const wikiHeader = document.getElementById('wikiHeader');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authStatus = document.getElementById('auth-status');
        const authModal = new bootstrap.Modal(document.getElementById('authModal'));
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authModalTitle = document.getElementById('authModalTitle');
        const switchAuthMode = document.getElementById('switch-auth-mode');
        const authError = document.getElementById('auth-error');
        const pageContainer = document.getElementById('page-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const editSection = document.getElementById('edit-section');
        const editForm = document.getElementById('edit-form');
        const editTitle = document.getElementById('edit-title');
        const editLead = document.getElementById('edit-lead');
        const sectionContainer = document.getElementById('section-container');
        const addSectionBtn = document.getElementById('add-section-btn');
        const editBibliography = document.getElementById('edit-bibliography');
        const editSidebarImage = document.getElementById('edit-sidebar-image');
        const sidebarFactsContainer = document.getElementById('sidebar-facts-container');
        const addSidebarFactBtn = document.getElementById('add-sidebar-fact');
        const editSummary = document.getElementById('edit-summary');
        const cancelEdit = document.getElementById('cancel-edit');
        const showPreview = document.getElementById('show-preview');
        const editPreview = document.getElementById('edit-preview');
        const editPreviewContent = document.getElementById('edit-preview-content');
        const createPageItem = document.getElementById('create-page-item');
        const myContributionsItem = document.getElementById('my-contributions-item');
        const adminDashboardItem = document.getElementById('admin-dashboard-item');
        const editTab = document.getElementById('edit-tab');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const sidebarNav = document.getElementById('sidebar-nav');
        const pageTabs = document.getElementById('page-tabs');
        const successMessage = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        const imageUploadModal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
        const imageUploadForm = document.getElementById('image-upload-form');
        const discussionModal = new bootstrap.Modal(document.getElementById('discussionModal'));
        const discussionForm = document.getElementById('discussion-form');
        const approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
        const currentVersionContent = document.getElementById('current-version');
        const proposedChangesContent = document.getElementById('proposed-changes');
        const approveChangesBtn = document.getElementById('approve-changes');
        const rejectChangesBtn = document.getElementById('reject-changes');
        const approvalComment = document.getElementById('approval-comment');

        // State variables
        let isLoginMode = true;
        let currentPageId = 'home';
        let currentUser = null;
        let isEditing = false;
        let currentTab = 'article';
        let discussionTopics = [];
        let recentChanges = [];
        let pendingApprovals = [];
        let isAdminUser = false;
        let currentRevisionId = null;
        let simpleMDE = null;

        // Initialize the app
        function init() {
            setupAuth();
            setupNavigation();
            setupEditor();
            setupTabs();
            setupSidebarToggle();
            setupScrollEffects();
            loadPage(currentPageId);
            loadFeaturedArticles();
        }

        // Scroll effects
        function setupScrollEffects() {
            window.addEventListener('scroll', function() {
                if (window.scrollY > 20) {
                    wikiHeader.classList.add('scrolled');
                } else {
                    wikiHeader.classList.remove('scrolled');
                }
            });
        }

        // Toggle sidebar on mobile
        function setupSidebarToggle() {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');

                // Change icon based on state
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('show')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 992 &&
                    !sidebar.contains(e.target) &&
                    !sidebarToggle.contains(e.target) &&
                    sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    const icon = sidebarToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        }

        // Enhanced authentication
        function setupAuth() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    // Check if user is admin
                    db.ref(`users/${user.uid}/role`).once('value').then(snapshot => {
                        if (snapshot.exists() && snapshot.val() === 'admin') {
                            isAdminUser = true;
                            adminDashboardItem.style.display = 'block';
                        } else {
                            isAdminUser = false;
                            adminDashboardItem.style.display = 'none';
                        }
                        updateAuthUI();
                        updatePageActions();
                    }).catch(error => {
                        console.error("Error checking user role:", error);
                        isAdminUser = false;
                        adminDashboardItem.style.display = 'none';
                        updateAuthUI();
                        updatePageActions();
                    });
                } else {
                    isAdminUser = false;
                    adminDashboardItem.style.display = 'none';
                    updateAuthUI();
                    updatePageActions();
                }
            });

            loginBtn?.addEventListener('click', () => {
                isLoginMode = true;
                updateAuthModalUI();
                authModal.show();
            });

            signupBtn?.addEventListener('click', () => {
                isLoginMode = false;
                updateAuthModalUI();
                authModal.show();
            });

            switchAuthMode.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                updateAuthModalUI();
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = authEmail.value;
                const password = authPassword.value;

                authSubmitBtn.disabled = true;
                authSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        // Create user profile in Realtime Database
                        await db.ref(`users/${userCredential.user.uid}`).set({
                            email: email,
                            displayName: email.split('@')[0],
                            role: 'contributor',
                            joinDate: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                    authModal.hide();
                    showSuccess(isLoginMode ? 'Successfully logged in!' : 'Account created successfully!');
                } catch (error) {
                    authError.textContent = error.message;
                    authError.classList.remove('d-none');
                } finally {
                    authSubmitBtn.disabled = false;
                    authSubmitBtn.innerHTML = isLoginMode ? 'Log in' : 'Create account';
                }
            });
        }

        function updateAuthModalUI() {
            authModalTitle.textContent = isLoginMode ? 'Log in' : 'Create account';
            authSubmitBtn.textContent = isLoginMode ? 'Log in' : 'Create account';
            switchAuthMode.textContent = isLoginMode ? 'Create an account' : 'Already have an account?';
            authForm.reset();
            authError.classList.add('d-none');
        }

        function updateAuthUI() {
            if (currentUser) {
                const displayName = currentUser.email.split('@')[0];
                const badgeClass = isAdminUser ? 'contributor-badge admin' : 'contributor-badge';
                const badgeText = isAdminUser ? 'Admin' : 'Contributor';

                authStatus.innerHTML = `
                    <span class="user-greeting me-2">Welcome, ${displayName}</span>
                    <span class="${badgeClass}">${badgeText}</span>
                    <button id="logout-btn" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sign-out-alt me-1"></i> Log out
                    </button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
                createPageItem.style.display = 'block';
                myContributionsItem.style.display = 'block';
                editTab.style.display = 'block';
            } else {
                authStatus.innerHTML = `
                    <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-sign-in-alt me-1"></i> Log in
                    </button>
                    <button id="signup-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-user-plus me-1"></i> Create account
                    </button>
                `;

                document.getElementById('login-btn').addEventListener('click', () => {
                    isLoginMode = true;
                    updateAuthModalUI();
                    authModal.show();
                });
                document.getElementById('signup-btn').addEventListener('click', () => {
                    isLoginMode = false;
                    updateAuthModalUI();
                    authModal.show();
                });
                createPageItem.style.display = 'none';
                myContributionsItem.style.display = 'none';
                editTab.style.display = 'none';
            }
        }

        // Enhanced navigation
        function setupNavigation() {
            document.addEventListener('click', (e) => {
                // Handle navigation links
                if (e.target.closest('[data-page]')) {
                    e.preventDefault();
                    const link = e.target.closest('[data-page]');
                    const pageId = link.getAttribute('data-page');
                    if (pageId) {
                        loadPage(pageId);
                        if (window.innerWidth <= 992) {
                            sidebar.classList.remove('show');
                            const icon = sidebarToggle.querySelector('i');
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                        updateActiveNavLink(link);
                    }
                }
            });

            searchBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchPages(searchTerm);
                }
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        searchPages(searchTerm);
                    }
                }
            });
        }

        function updateActiveNavLink(activeLink) {
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            // Add active class to clicked link
            activeLink.classList.add('active');
        }

        // Tab system setup
        function setupTabs() {
            pageTabs.addEventListener('click', (e) => {
                e.preventDefault();
                if (e.target.closest('[data-tab]')) {
                    const link = e.target.closest('[data-tab]');
                    const tabId = link.getAttribute('data-tab');
                    if (tabId) {
                        switchTab(tabId);
                    }
                }
            });
        }

        function switchTab(tabId) {
            currentTab = tabId;

            // Update tab appearance
            pageTabs.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Show appropriate content
            switch (tabId) {
                case 'article':
                    showArticle();
                    break;
                case 'discussion':
                    showDiscussion();
                    break;
                case 'edit':
                    if (currentUser) {
                        startEditing();
                    } else {
                        showLoginPrompt('Please log in to edit pages.');
                        switchTab('article');
                    }
                    break;
                case 'history':
                    showHistory();
                    break;
            }
        }

        // Show success message
        function showSuccess(message) {
            toastr.success(message);
        }

        function showError(message) {
            toastr.error(message);
        }

        // Show login prompt
        function showLoginPrompt(message) {
            const prompt = confirm(`${message} Would you like to log in now?`);
            if (prompt) {
                isLoginMode = true;
                updateAuthModalUI();
                authModal.show();
            }
        }

        // Enhanced editor setup
        function setupEditor() {
            // Initialize Markdown editor
            simpleMDE = new SimpleMDE({
                element: document.getElementById("edit-lead"),
                spellChecker: false,
                toolbar: false,
                status: false
            });

            const toolbar = document.querySelector('.edit-toolbar');
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('[data-format]');
                if (button) {
                    const format = button.getAttribute('data-format');
                    if (format === 'image') {
                        // Open image upload modal
                        imageUploadModal.show();
                    } else {
                        insertFormat(format);
                    }
                }
            });

            // Add section button
            addSectionBtn.addEventListener('click', addNewSection);

            // Add sidebar fact button
            addSidebarFactBtn.addEventListener('click', addSidebarFact);

            showPreview.addEventListener('click', () => {
                if (editPreview.style.display === 'none') {
                    editPreview.style.display = 'block';
                    showPreview.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide preview';
                    updatePreview();
                } else {
                    editPreview.style.display = 'none';
                    showPreview.innerHTML = '<i class="fas fa-eye me-1"></i> Show preview';
                }
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showLoginPrompt('You must be logged in to edit pages.');
                    return;
                }

                const title = editTitle.value.trim();
                const lead = simpleMDE.value().trim();
                const bibliography = editBibliography.value.trim();
                const sidebarImage = editSidebarImage.value.trim();
                const summary = editSummary.value.trim() || 'No edit summary provided';
                const isMinor = document.getElementById('minor-edit').checked;

                if (!title || !lead) {
                    alert('Please provide both a title and lead paragraph.');
                    return;
                }

                // Collect sections
                const sections = [];
                const sectionElements = sectionContainer.querySelectorAll('.section-editor');
                sectionElements.forEach((sectionEl, index) => {
                    const header = sectionEl.querySelector('.section-header-input').value.trim();
                    const content = sectionEl.querySelector('.section-content').value.trim();
                    if (header && content) {
                        sections.push({
                            header: header,
                            content: content,
                            order: index
                        });
                    }
                });

                // Collect sidebar facts
                const sidebarFacts = [];
                const factElements = sidebarFactsContainer.querySelectorAll('.sidebar-fact');
                factElements.forEach(factEl => {
                    const label = factEl.querySelector('.fact-label').value.trim();
                    const value = factEl.querySelector('.fact-value').value.trim();
                    if (label && value) {
                        sidebarFacts.push({ label, value });
                    }
                });

                // Disable submit button and show loading state
                const submitBtn = editForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Saving...';

                try {
                    await submitRevision(title, lead, sections, bibliography, sidebarImage, sidebarFacts, summary, isMinor);
                    switchTab('article');
                    editForm.reset();
                    showSuccess('Your changes have been submitted successfully!');
                    loadPage(currentPageId);
                } catch (error) {
                    console.error('Error submitting revision:', error);
                    showError('There was an error submitting your changes. Please try again.');
                } finally {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save changes';
                }
            });

            cancelEdit.addEventListener('click', () => {
                if (confirm('Are you sure you want to cancel editing? Your changes will be lost.')) {
                    switchTab('article');
                    editForm.reset();
                }
            });

            // Image upload functionality
            imageUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showLoginPrompt('You must be logged in to upload images.');
                    return;
                }

                const fileInput = document.getElementById('image-file');
                const title = document.getElementById('image-title').value.trim();
                const description = document.getElementById('image-description').value.trim();
                const source = document.getElementById('image-source').value.trim();
                const uploadError = document.getElementById('upload-error');
                const uploadProgress = document.getElementById('upload-progress');
                const uploadProgressBar = document.getElementById('upload-progress-bar');
                const uploadSubmitBtn = document.getElementById('upload-submit-btn');

                if (!fileInput.files.length || !title) {
                    uploadError.textContent = 'Please provide both an image file and title.';
                    uploadError.classList.remove('d-none');
                    return;
                }

                const file = fileInput.files[0];
                const fileName = `${Date.now()}-${file.name}`;
                const storageRef = storage.ref(`images/${fileName}`);

                // Reset UI
                uploadError.classList.add('d-none');
                uploadProgress.classList.remove('d-none');
                uploadSubmitBtn.disabled = true;
                uploadSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Uploading...';

                try {
                    // Upload file with progress tracking
                    const uploadTask = storageRef.put(file);
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgressBar.style.width = `${progress}%`;
                        },
                        (error) => {
                            throw error;
                        }
                    );

                    // Wait for upload to complete
                    await uploadTask;

                    // Get download URL
                    const downloadURL = await storageRef.getDownloadURL();

                    // Store image metadata in Realtime Database
                    const newImageRef = db.ref('images').push();
                    await newImageRef.set({
                        title: title,
                        description: description,
                        source: source,
                        url: downloadURL,
                        fileName: fileName,
                        uploadedBy: currentUser.uid,
                        uploadedByEmail: currentUser.email,
                        uploadedAt: firebase.database.ServerValue.TIMESTAMP
                    });

                    // Insert image tag in editor
                    const imageTag = `[[Image:${downloadURL}|${title}|${description || title}]]`;
                    insertTextAtCursor(document.activeElement, imageTag);

                    // Close modal and reset form
                    imageUploadModal.hide();
                    imageUploadForm.reset();
                    showSuccess('Image uploaded successfully!');

                    // Update preview if open
                    updateLivePreview();
                } catch (error) {
                    console.error('Error uploading image:', error);
                    uploadError.textContent = `Error uploading image: ${error.message}`;
                    uploadError.classList.remove('d-none');
                } finally {
                    uploadProgress.classList.add('d-none');
                    uploadSubmitBtn.disabled = false;
                    uploadSubmitBtn.innerHTML = 'Upload Image';
                }
            });

            // Discussion form functionality
            discussionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showLoginPrompt('You must be logged in to start discussions.');
                    return;
                }

                const topic = document.getElementById('discussion-topic').value.trim();
                const content = document.getElementById('discussion-content').value.trim();
                const discussionError = document.getElementById('discussion-error');
                const submitBtn = discussionForm.querySelector('button[type="submit"]');

                if (!topic || !content) {
                    discussionError.textContent = 'Please provide both a topic and message.';
                    discussionError.classList.remove('d-none');
                    return;
                }

                // Disable submit button and show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Posting...';

                try {
                    const newDiscussionRef = db.ref('discussions').push();
                    await newDiscussionRef.set({
                        pageId: currentPageId,
                        topic: topic,
                        content: content,
                        author: currentUser.uid,
                        authorEmail: currentUser.email,
                        authorName: currentUser.email.split('@')[0],
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        status: 'open'
                    });

                    // Close modal and reset form
                    discussionModal.hide();
                    discussionForm.reset();
                    showSuccess('Discussion posted successfully!');

                    // Refresh discussion tab
                    if (currentTab === 'discussion') {
                        showDiscussion();
                    }
                } catch (error) {
                    console.error('Error posting discussion:', error);
                    discussionError.textContent = `Error posting discussion: ${error.message}`;
                    discussionError.classList.remove('d-none');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Post Discussion';
                }
            });

            // Admin approval functionality
            approveChangesBtn.addEventListener('click', async () => {
                await processApproval(true);
            });

            rejectChangesBtn.addEventListener('click', async () => {
                await processApproval(false);
            });
        }

        function addNewSection() {
            const sectionId = Date.now();
            const sectionHtml = `
                <div class="section-editor" data-section-id="${sectionId}">
                    <div class="section-header">
                        <input type="text" class="form-control section-header-input" placeholder="Section header">
                        <div class="section-actions">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-section">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <textarea class="form-control section-content mt-2" rows="5" placeholder="Section content"></textarea>
                </div>
            `;
            sectionContainer.insertAdjacentHTML('beforeend', sectionHtml);

            // Add event listener to remove button
            const newSection = sectionContainer.lastElementChild;
            newSection.querySelector('.remove-section').addEventListener('click', () => {
                if (confirm('Are you sure you want to remove this section?')) {
                    newSection.remove();
                }
            });
        }

        function addSidebarFact() {
            const factId = Date.now();
            const factHtml = `
                <div class="sidebar-fact mb-2" data-fact-id="${factId}">
                    <div class="input-group">
                        <input type="text" class="form-control fact-label" placeholder="Label (e.g., 'Established')">
                        <input type="text" class="form-control fact-value" placeholder="Value (e.g., '1858')">
                        <button class="btn btn-outline-danger remove-fact" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            sidebarFactsContainer.insertAdjacentHTML('beforeend', factHtml);

            // Add event listener to remove button
            const newFact = sidebarFactsContainer.lastElementChild;
            newFact.querySelector('.remove-fact').addEventListener('click', () => {
                newFact.remove();
            });
        }

        function insertTextAtCursor(element, text) {
            if (!element) return;
            
            if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                const startPos = element.selectionStart;
                const endPos = element.selectionEnd;
                const scrollTop = element.scrollTop;

                element.value = element.value.substring(0, startPos) + text +
                    element.value.substring(endPos, element.value.length);

                element.focus();
                element.selectionStart = startPos + text.length;
                element.selectionEnd = startPos + text.length;
                element.scrollTop = scrollTop;
            } else {
                // For contenteditable elements
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        function insertFormat(format) {
            const activeElement = document.activeElement;
            if (!activeElement) return;

            let replacement = '';
            
            switch (format) {
                case 'header':
                    replacement = '== Section Header ==';
                    break;
                case 'bold':
                    replacement = '**bold text**';
                    break;
                case 'italic':
                    replacement = '*italic text*';
                    break;
                case 'link':
                    replacement = '[[Link text]]';
                    break;
                case 'list':
                    replacement = '* List item\n* List item\n* List item';
                    break;
                case 'reference':
                    replacement = '<ref>Citation needed</ref>';
                    break;
                case 'sidebar':
                    replacement = '{{Infobox}}';
                    break;
            }

            insertTextAtCursor(activeElement, replacement);
            updateLivePreview();
        }

        function updateLivePreview() {
            if (editPreview.style.display !== 'none') {
                updatePreview();
            }
        }

        function updatePreview() {
            const title = editTitle.value;
            const lead = simpleMDE.value();
            
            // Collect sections
            const sections = [];
            const sectionElements = sectionContainer.querySelectorAll('.section-editor');
            sectionElements.forEach(sectionEl => {
                const header = sectionEl.querySelector('.section-header-input').value;
                const content = sectionEl.querySelector('.section-content').value;
                if (header || content) {
                    sections.push({ header, content });
                }
            });

            // Collect bibliography
            const bibliography = editBibliography.value.split('\n').filter(line => line.trim());

            // Collect sidebar facts
            const sidebarFacts = [];
            const factElements = sidebarFactsContainer.querySelectorAll('.sidebar-fact');
            factElements.forEach(factEl => {
                const label = factEl.querySelector('.fact-label').value;
                const value = factEl.querySelector('.fact-value').value;
                if (label || value) {
                    sidebarFacts.push({ label, value });
                }
            });

            // Generate HTML preview
            let html = `<h1>${title || 'Untitled Article'}</h1>`;
            
            if (lead) {
                html += `<div class="lead">${markdownToHtml(lead)}</div>`;
            }
            
            sections.forEach(section => {
                if (section.header) {
                    html += `<h2>${section.header}</h2>`;
                }
                if (section.content) {
                    html += markdownToHtml(section.content);
                }
            });
            
            if (bibliography.length > 0) {
                html += '<h2>References</h2><ol>';
                bibliography.forEach((ref, index) => {
                    html += `<li class="citation">${ref}</li>`;
                });
                html += '</ol>';
            }
            
            if (sidebarFacts.length > 0 || editSidebarImage.value) {
                html += '<div class="infobox">';
                if (editSidebarImage.value) {
                    html += `<img src="${editSidebarImage.value}" class="img-fluid mb-2" alt="Sidebar image">`;
                }
                if (sidebarFacts.length > 0) {
                    sidebarFacts.forEach(fact => {
                        html += `
                            <div class="infobox-item">
                                <div class="infobox-label">${fact.label || 'Label'}</div>
                                <div class="infobox-value">${fact.value || 'Value'}</div>
                            </div>
                        `;
                    });
                }
                html += '</div>';
            }

            editPreviewContent.innerHTML = html;
        }

        async function submitRevision(title, lead, sections, bibliography, sidebarImage, sidebarFacts, summary, isMinor = false) {
            const pageId = generatePageId(title);
            const isNewPage = !(await pageExists(pageId));

            const revisionData = {
                pageId: pageId,
                title: title,
                lead: lead,
                sections: sections,
                bibliography: bibliography,
                sidebar: {
                    image: sidebarImage,
                    facts: sidebarFacts
                },
                summary: summary,
                author: currentUser.uid,
                authorEmail: currentUser.email,
                authorName: currentUser.email.split('@')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                isMinor: isMinor,
                status: isAdminUser ? 'approved' : 'pending',
                isNewPage: isNewPage
            };

            // Save revision to history
            const newRevisionRef = db.ref('revisions').push();
            await newRevisionRef.set(revisionData);
            const revisionId = newRevisionRef.key;

            // If user is admin or this is an existing page, update the page content
            if (isAdminUser || !isNewPage) {
                const pageData = {
                    title: title,
                    lead: lead,
                    sections: sections,
                    bibliography: bibliography,
                    sidebar: {
                        image: sidebarImage,
                        facts: sidebarFacts
                    },
                    currentRevision: revisionId,
                    lastUpdatedBy: currentUser.uid,
                    lastUpdatedByEmail: currentUser.email,
                    lastUpdatedByName: currentUser.email.split('@')[0],
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    status: isAdminUser ? 'approved' : 'pending'
                };

                if (isNewPage) {
                    pageData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                    pageData.createdBy = currentUser.uid;
                }

                // Update page in database
                await db.ref(`pages/${pageId}`).update(pageData);
            }

            // If this is a new page, update current page ID
            if (isNewPage) {
                currentPageId = pageId;
            }

            // Notify admins if needed
            if (!isAdminUser) {
                await notifyAdmins(revisionId, pageId, title);
            }
        }

        async function notifyAdmins(revisionId, pageId, pageTitle) {
            // Get all admin users
            const snapshot = await db.ref('users').orderByChild('role').equalTo('admin').once('value');
            if (snapshot.exists()) {
                const admins = snapshot.val();
                const notification = {
                    type: 'revision',
                    revisionId: revisionId,
                    pageId: pageId,
                    pageTitle: pageTitle,
                    submittedBy: currentUser.uid,
                    submittedByName: currentUser.email.split('@')[0],
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                };

                // Send notification to each admin
                Object.keys(admins).forEach(adminId => {
                    db.ref(`notifications/${adminId}`).push(notification);
                });
            }
        }

        async function pageExists(pageId) {
            const snapshot = await db.ref(`pages/${pageId}`).once('value');
            return snapshot.exists();
        }

        // Enhanced page loading
        async function loadPage(pageId) {
            currentPageId = pageId;

            // Show loading spinner
            loadingSpinner.style.display = 'block';
            pageContainer.innerHTML = '';

            try {
                const snapshot = await db.ref(`pages/${pageId}`).once('value');
                if (snapshot.exists()) {
                    const pageData = snapshot.val();
                    displayPage(pageData);
                } else {
                    displayDefaultContent(pageId);
                }
            } catch (error) {
                console.error('Error loading page:', error);
                displayError();
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
            }

            // Reset to article tab
            switchTab('article');
        }

        function displayPage(pageData) {
            let html = `
                <div id="page-header">
                    <h1 id="page-title">${pageData.title || 'Untitled Page'}</h1>
                    <div class="content-meta" id="page-meta">
                        <span id="page-info">
                            Last updated by ${pageData.lastUpdatedByName || 'Unknown'} 
                            on ${new Date(pageData.updatedAt).toLocaleDateString()}
                        </span>
                        <span id="page-actions"></span>
                    </div>
                </div>
            `;

            // Add lead paragraph
            if (pageData.lead) {
                html += `<div class="lead">${markdownToHtml(pageData.lead)}</div>`;
            }

            // Add sections
            if (pageData.sections && pageData.sections.length > 0) {
                pageData.sections.forEach(section => {
                    if (section.header) {
                        html += `<h2>${section.header}</h2>`;
                    }
                    if (section.content) {
                        html += markdownToHtml(section.content);
                    }
                });
            }

            // Add bibliography
            if (pageData.bibliography && pageData.bibliography.length > 0) {
                html += '<h2>References</h2><ol>';
                pageData.bibliography.forEach((ref, index) => {
                    html += `<li class="citation">${ref}</li>`;
                });
                html += '</ol>';
            }

            // Add sidebar if exists
            if (pageData.sidebar && (pageData.sidebar.image || pageData.sidebar.facts)) {
                let sidebarHtml = '<div class="infobox">';
                
                if (pageData.sidebar.image) {
                    sidebarHtml += `<img src="${pageData.sidebar.image}" class="img-fluid mb-2" alt="Sidebar image">`;
                }
                
                if (pageData.sidebar.facts && pageData.sidebar.facts.length > 0) {
                    pageData.sidebar.facts.forEach(fact => {
                        sidebarHtml += `
                            <div class="infobox-item">
                                <div class="infobox-label">${fact.label || 'Label'}</div>
                                <div class="infobox-value">${fact.value || 'Value'}</div>
                            </div>
                        `;
                    });
                }
                
                sidebarHtml += '</div>';
                
                // Insert sidebar at the beginning of the content
                html = html.replace('<div class="lead">', `${sidebarHtml}<div class="lead">`);
            }

            pageContainer.innerHTML = html;
            updatePageActions();
        }

        function displayDefaultContent(pageId) {
            pageContainer.innerHTML = `
                <h1>Page Not Found: "${pageId}"</h1>
                <p>The page "${pageId}" does not exist yet. Would you like to create it?</p>
                <button id="create-page-btn" class="btn btn-success">Create this page</button>
            `;
            
            const createPageButton = document.getElementById('create-page-btn');
            if (createPageButton) {
                createPageButton.addEventListener('click', () => {
                    if (currentUser) {
                        editTitle.value = pageId.replace(/-/g, ' '); // Convert dashes to spaces for display
                        simpleMDE.value('This is the lead paragraph for ' + pageId.replace(/-/g, ' '));
                        switchTab('edit');
                    } else {
                        showLoginPrompt('You must be logged in to create pages.');
                    }
                });
            }
            
            updatePageActions();
        }

        function displayError() {
            pageContainer.innerHTML = '<h1>Error Loading Page</h1><p class="text-danger">An error occurred while trying to load the page. Please try again later.</p>';
            updatePageActions();
        }

        function updatePageActions() {
            const pageActions = document.getElementById('page-actions');
            if (!pageActions) return;

            let actionsHtml = '';
            
            if (currentUser) {
                actionsHtml += `
                    <button class="btn btn-sm btn-outline-primary me-2" id="edit-page-btn">
                        <i class="fas fa-edit me-1"></i> Edit
                    </button>
                `;
                
                if (isAdminUser) {
                    actionsHtml += `
                        <button class="btn btn-sm btn-outline-secondary" id="admin-actions-btn">
                            <i class="fas fa-cog me-1"></i> Admin Actions
                        </button>
                    `;
                }
            }
            
            pageActions.innerHTML = actionsHtml;
            
            // Add event listeners
            const editPageBtn = document.getElementById('edit-page-btn');
            if (editPageBtn) {
                editPageBtn.addEventListener('click', () => {
                    switchTab('edit');
                });
            }
            
            const adminActionsBtn = document.getElementById('admin-actions-btn');
            if (adminActionsBtn) {
                adminActionsBtn.addEventListener('click', () => {
                    showAdminActions();
                });
            }
        }

        function showAdminActions() {
            // Implement admin actions menu
            alert('Admin actions would be shown here');
        }

        function startEditing() {
            // Show edit section and hide content
            editSection.style.display = 'block';
            pageContainer.style.display = 'none';
            
            // Load current content into editor if available
            db.ref(`pages/${currentPageId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const pageData = snapshot.val();
                    editTitle.value = pageData.title || '';
                    simpleMDE.value(pageData.lead || '');
                    
                    // Clear existing sections
                    sectionContainer.innerHTML = '';
                    
                    // Add sections
                    if (pageData.sections && pageData.sections.length > 0) {
                        pageData.sections.forEach(section => {
                            const sectionId = Date.now();
                            const sectionHtml = `
                                <div class="section-editor" data-section-id="${sectionId}">
                                    <div class="section-header">
                                        <input type="text" class="form-control section-header-input" 
                                            value="${section.header || ''}" placeholder="Section header">
                                        <div class="section-actions">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-section">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <textarea class="form-control section-content mt-2" rows="5" 
                                        placeholder="Section content">${section.content || ''}</textarea>
                                </div>
                            `;
                            sectionContainer.insertAdjacentHTML('beforeend', sectionHtml);
                            
                            // Add event listener to remove button
                            const newSection = sectionContainer.lastElementChild;
                            newSection.querySelector('.remove-section').addEventListener('click', () => {
                                if (confirm('Are you sure you want to remove this section?')) {
                                    newSection.remove();
                                }
                            });
                        });
                    }
                    
                    // Set bibliography
                    if (pageData.bibliography && pageData.bibliography.length > 0) {
                        editBibliography.value = pageData.bibliography.join('\n');
                    }
                    
                    // Set sidebar content
                    if (pageData.sidebar) {
                        editSidebarImage.value = pageData.sidebar.image || '';
                        
                        // Clear existing sidebar facts
                        sidebarFactsContainer.innerHTML = '';
                        
                        // Add sidebar facts
                        if (pageData.sidebar.facts && pageData.sidebar.facts.length > 0) {
                            pageData.sidebar.facts.forEach(fact => {
                                const factId = Date.now();
                                const factHtml = `
                                    <div class="sidebar-fact mb-2" data-fact-id="${factId}">
                                        <div class="input-group">
                                            <input type="text" class="form-control fact-label" 
                                                value="${fact.label || ''}" placeholder="Label (e.g., 'Established')">
                                            <input type="text" class="form-control fact-value" 
                                                value="${fact.value || ''}" placeholder="Value (e.g., '1858')">
                                            <button class="btn btn-outline-danger remove-fact" type="button">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                                sidebarFactsContainer.insertAdjacentHTML('beforeend', factHtml);
                                
                                // Add event listener to remove button
                                const newFact = sidebarFactsContainer.lastElementChild;
                                newFact.querySelector('.remove-fact').addEventListener('click', () => {
                                    newFact.remove();
                                });
                            });
                        }
                    }
                } else {
                    // New page - set default values
                    editTitle.value = currentPageId.replace(/-/g, ' ');
                    simpleMDE.value('This is the lead paragraph for ' + currentPageId.replace(/-/g, ' '));
                    sectionContainer.innerHTML = '';
                    editBibliography.value = '';
                    editSidebarImage.value = '';
                    sidebarFactsContainer.innerHTML = '';
                }
            }).catch(error => {
                console.error('Error loading page for editing:', error);
                showError('Error loading page for editing');
                switchTab('article');
            });
        }

        function showArticle() {
            editSection.style.display = 'none';
            pageContainer.style.display = 'block';
        }

        async function showDiscussion() {
            editSection.style.display = 'none';
            pageContainer.style.display = 'block';
            loadingSpinner.style.display = 'block';
            
            try {
                const snapshot = await db.ref('discussions').orderByChild('pageId').equalTo(currentPageId).once('value');
                let html = '<h2>Discussion</h2>';
                
                if (currentUser) {
                    html += `
                        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#discussionModal">
                            <i class="fas fa-plus me-1"></i> Start New Discussion
                        </button>
                    `;
                }
                
                if (snapshot.exists()) {
                    discussionTopics = [];
                    snapshot.forEach(childSnapshot => {
                        const discussion = childSnapshot.val();
                        discussionTopics.push({ id: childSnapshot.key, ...discussion });
                    });
                    
                    if (discussionTopics.length > 0) {
                        discussionTopics.sort((a, b) => b.createdAt - a.createdAt);
                        
                        discussionTopics.forEach(topic => {
                            html += `
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">${topic.topic}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">
                                            Started by ${topic.authorName} on ${new Date(topic.createdAt).toLocaleDateString()}
                                        </h6>
                                        <p class="card-text">${topic.content}</p>
                                        <button class="btn btn-sm btn-outline-info view-discussion-btn" data-discussion-id="${topic.id}">
                                            View Discussion
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p>No discussions for this page yet. Be the first to start one!</p>';
                    }
                } else {
                    html += '<p>No discussions for this page yet. Be the first to start one!</p>';
                }
                
                pageContainer.innerHTML = html;
                
                // Add event listeners to view discussion buttons
                document.querySelectorAll('.view-discussion-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const discussionId = e.target.dataset.discussionId;
                        viewDiscussion(discussionId);
                    });
                });
            } catch (error) {
                console.error('Error loading discussions:', error);
                pageContainer.innerHTML = '<p class="text-danger">Error loading discussions.</p>';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function viewDiscussion(discussionId) {
            // Implement detailed discussion view
            alert('Viewing discussion: ' + discussionId);
        }

        async function showHistory() {
            editSection.style.display = 'none';
            pageContainer.style.display = 'block';
            loadingSpinner.style.display = 'block';
            
            try {
                const snapshot = await db.ref('revisions').orderByChild('pageId').equalTo(currentPageId).once('value');
                let html = '<h2>Page History</h2><ul class="list-group">';
                
                if (snapshot.exists()) {
                    recentChanges = [];
                    snapshot.forEach(childSnapshot => {
                        const revision = childSnapshot.val();
                        recentChanges.push({ id: childSnapshot.key, ...revision });
                    });
                    
                    if (recentChanges.length > 0) {
                        recentChanges.sort((a, b) => b.timestamp - a.timestamp);
                        
                        recentChanges.forEach(revision => {
                            const date = new Date(revision.timestamp);
                            const statusBadge = revision.status === 'pending' ? 
                                '<span class="badge bg-warning">pending</span>' : 
                                '<span class="badge bg-success">approved</span>';
                            
                            html += `
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</strong>
                                            <div>${revision.authorName} ${statusBadge}</div>
                                            <div><em>${revision.summary || 'No summary provided'}</em></div>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary view-revision-btn" data-revision-id="${revision.id}">
                                                View
                                            </button>
                                            ${isAdminUser && revision.status === 'pending' ? `
                                                <button class="btn btn-sm btn-outline-success review-revision-btn" data-revision-id="${revision.id}">
                                                    Review
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </li>
                            `;
                        });
                    } else {
                        html += '<li class="list-group-item">No revision history for this page.</li>';
                    }
                } else {
                    html += '<li class="list-group-item">No revision history for this page.</li>';
                }
                
                html += '</ul>';
                pageContainer.innerHTML = html;
                
                // Add event listeners to view revision buttons
                document.querySelectorAll('.view-revision-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const revisionId = e.target.dataset.revisionId;
                        viewRevision(revisionId);
                    });
                });
                
                // Add event listeners to review revision buttons (admin only)
                document.querySelectorAll('.review-revision-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const revisionId = e.target.dataset.revisionId;
                        reviewRevision(revisionId);
                    });
                });
            } catch (error) {
                console.error('Error loading page history:', error);
                pageContainer.innerHTML = '<p class="text-danger">Error loading page history.</p>';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function viewRevision(revisionId) {
            const revision = recentChanges.find(r => r.id === revisionId);
            if (!revision) return;

            let html = `
                <h2>Revision: ${new Date(revision.timestamp).toLocaleString()}</h2>
                <div class="mb-3">
                    <strong>Author:</strong> ${revision.authorName}<br>
                    <strong>Summary:</strong> ${revision.summary || 'No summary provided'}<br>
                    <strong>Status:</strong> ${revision.status}
                </div>
                <div class="revision-content">
                    <h3>${revision.title || 'Untitled Page'}</h3>
            `;

            if (revision.lead) {
                html += `<div class="lead">${markdownToHtml(revision.lead)}</div>`;
            }

            if (revision.sections && revision.sections.length > 0) {
                revision.sections.forEach(section => {
                    if (section.header) {
                        html += `<h4>${section.header}</h4>`;
                    }
                    if (section.content) {
                        html += markdownToHtml(section.content);
                    }
                });
            }

            if (revision.bibliography && revision.bibliography.length > 0) {
                html += '<h4>References</h4><ol>';
                revision.bibliography.forEach(ref => {
                    html += `<li class="citation">${ref}</li>`;
                });
                html += '</ol>';
            }

            html += '</div>';
            pageContainer.innerHTML = html;
        }

        async function reviewRevision(revisionId) {
            const revision = recentChanges.find(r => r.id === revisionId);
            if (!revision) return;

            currentRevisionId = revisionId;
            
            // Get current page content
            const currentPageSnapshot = await db.ref(`pages/${revision.pageId}`).once('value');
            const currentPage = currentPageSnapshot.val();
            
            // Display comparison
            currentVersionContent.innerHTML = formatContentForComparison(currentPage);
            proposedChangesContent.innerHTML = formatContentForComparison(revision);
            
            // Show approval modal
            approvalModal.show();
        }

        function formatContentForComparison(content) {
            if (!content) return '<p>No content</p>';
            
            let html = `<h4>${content.title || 'Untitled Page'}</h4>`;
            
            if (content.lead) {
                html += `<p>${content.lead}</p>`;
            }
            
            if (content.sections && content.sections.length > 0) {
                content.sections.forEach(section => {
                    if (section.header) {
                        html += `<h5>${section.header}</h5>`;
                    }
                    if (section.content) {
                        html += `<p>${section.content}</p>`;
                    }
                });
            }
            
            return html;
        }

        async function processApproval(approve) {
            if (!currentRevisionId || !isAdminUser) return;
            
            const revision = recentChanges.find(r => r.id === currentRevisionId);
            if (!revision) return;

            try {
                // Update revision status
                await db.ref(`revisions/${currentRevisionId}/status`).set(approve ? 'approved' : 'rejected');
                
                // Add admin comment
                const comment = approvalComment.value.trim();
                if (comment) {
                    await db.ref(`revisions/${currentRevisionId}/adminComment`).set(comment);
                }
                
                // If approved, update the page content
                if (approve) {
                    const pageUpdate = {
                        title: revision.title,
                        lead: revision.lead,
                        sections: revision.sections,
                        bibliography: revision.bibliography,
                        sidebar: revision.sidebar,
                        currentRevision: currentRevisionId,
                        lastUpdatedBy: revision.author,
                        lastUpdatedByEmail: revision.authorEmail,
                        lastUpdatedByName: revision.authorName,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP,
                        status: 'approved'
                    };
                    
                    await db.ref(`pages/${revision.pageId}`).update(pageUpdate);
                }
                
                // Notify the contributor
                await notifyUser(revision.author, {
                    type: 'revision',
                    revisionId: currentRevisionId,
                    pageId: revision.pageId,
                    pageTitle: revision.title,
                    status: approve ? 'approved' : 'rejected',
                    adminComment: comment,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    read: false
                });
                
                // Close modal and refresh
                approvalModal.hide();
                showSuccess(`Revision ${approve ? 'approved' : 'rejected'} successfully`);
                showHistory();
            } catch (error) {
                console.error('Error processing approval:', error);
                showError('Error processing approval');
            }
        }

        async function notifyUser(userId, notification) {
            await db.ref(`notifications/${userId}`).push(notification);
        }

        function markdownToHtml(markdown) {
            // Basic markdown to HTML conversion
            let html = markdown;
            
            // Headers
            html = html.replace(/^== (.*) ==$/gm, '<h2>$1</h2>');
            html = html.replace(/^= (.*) =$/gm, '<h1>$1</h1>');
            
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Links (simple internal wiki links)
            html = html.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
                const parts = p1.split('|');
                const pageName = parts[0];
                const linkText = parts[1] || pageName;
                return `<a href="#" data-page="${pageName.toLowerCase().replace(/\s/g, '-')}" class="wiki-link">${linkText}</a>`;
            });
            
            // Images (simple wiki image tag)
            html = html.replace(/\[\[Image:(.*?)\|(.*?)\|(.*?)\]\]/g, '<figure><img src="$1" alt="$2" class="img-fluid"><figcaption>$3</figcaption></figure>');
            html = html.replace(/\[\[Image:(.*?)\|(.*?)\]\]/g, '<img src="$1" alt="$2" class="img-fluid">');
            
            // Unordered lists
            html = html.replace(/^\* (.*)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            // References (basic)
            html = html.replace(/<ref>(.*?)<\/ref>/g, '<sup class="reference" data-content="$1">[ref]</sup>');
            
            // Basic paragraph wrapping
            html = html.split('\n\n').map(paragraph => `<p>${paragraph}</p>`).join('');
            
            return html;
        }

        function generatePageId(title) {
            return title.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
        }

        async function loadFeaturedArticles() {
            // Implement featured articles loading
            console.log("Loading featured articles");
        }

        async function searchPages(searchTerm) {
            try {
                const snapshot = await db.ref('pages').orderByChild('title').once('value');
                const results = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const page = childSnapshot.val();
                        if (page.title && page.title.toLowerCase().includes(searchTerm.toLowerCase())) {
                            results.push({ id: childSnapshot.key, ...page });
                        }
                    });
                }
                
                if (results.length > 0) {
                    let html = '<h2>Search Results</h2><ul class="list-group">';
                    results.forEach(page => {
                        html += `
                            <li class="list-group-item">
                                <a href="#" data-page="${page.id}" class="wiki-link">${page.title}</a>
                                <div class="text-muted small">${page.lead ? page.lead.substring(0, 150) + '...' : ''}</div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    pageContainer.innerHTML = html;
                } else {
                    pageContainer.innerHTML = '<p>No results found for "' + searchTerm + '"</p>';
                }
            } catch (error) {
                console.error('Error searching pages:', error);
                pageContainer.innerHTML = '<p class="text-danger">Error performing search</p>';
            }
        }

        // Call init when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
