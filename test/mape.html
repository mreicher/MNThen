<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then - Community History Wiki</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Toastr for notifications -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    
    <style>
        :root {
            /* Color palette */
            --primary-50: #EFF6FF;
            --primary-600: #2563EB;
            --primary-800: #1E40AF;
            --neutral-50: #F9FAFB;
            --neutral-200: #E5E7EB;
            --neutral-500: #6B7280;
            --neutral-700: #374151;
            --neutral-900: #111827;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            
            /* Spacing */
            --space-2: 0.5rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* Typography */
            --font-heading: 'EB Garamond', serif;
            --font-body: 'Open Sans', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--neutral-50);
            color: var(--neutral-900);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
        }

        /* Header Styles */
        .site-header {
            background: linear-gradient(135deg, #1E40AF 0%, #2563EB 100%);
            color: white;
            padding: var(--space-4) 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .site-header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
        }

        .site-header .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Hero Section */
        .hero-section {
            background: white;
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-6) 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .hero-content {
            text-align: center;
        }

        .hero-title {
            font-size: 2rem;
            color: var(--neutral-900);
            margin-bottom: var(--space-4);
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--neutral-700);
            margin-bottom: var(--space-6);
        }

        .search-bar {
            max-width: 600px;
            margin: 0 auto var(--space-6);
        }

        .auth-buttons {
            display: flex;
            gap: var(--space-2);
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Navigation */
        .wiki-nav {
            background-color: white;
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-2) 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* Sidebar */
        .sidebar {
            background-color: white;
            border-right: 1px solid var(--neutral-200);
            padding: var(--space-4);
            min-height: calc(100vh - 200px);
        }

        .content-area {
            padding: var(--space-4);
            min-height: calc(100vh - 200px);
            background-color: white;
        }

        .wiki-section {
            margin-bottom: var(--space-8);
        }

        .infobox {
            background-color: var(--neutral-50);
            border: 1px solid var(--neutral-200);
            padding: var(--space-4);
            margin: 0 0 var(--space-4) var(--space-4);
            width: 300px;
            float: right;
            border-radius: 8px;
        }

        .edit-toolbar {
            background-color: white;
            border: 1px solid var(--neutral-200);
            padding: var(--space-2);
            margin-bottom: var(--space-4);
            border-radius: 4px;
        }

        .contributor-badge {
            font-size: 0.7rem;
            background-color: var(--primary-50);
            color: var(--primary-800);
            padding: 2px 5px;
            border-radius: 4px;
        }

        .wiki-content {
            line-height: 1.8;
        }

        .wiki-content h1, .wiki-content h2, .wiki-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .wiki-content p {
            margin-bottom: 1rem;
        }

        .wiki-content ul, .wiki-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        /* Cards */
        .feature-card {
            transition: transform 0.2s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
        }

        /* Mobile styles */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                width: 280px;
                z-index: 1000;
                transition: left 0.3s ease;
                height: 100vh;
                overflow-y: auto;
            }

            .sidebar.show {
                left: 0;
            }

            .hero-title {
                font-size: 1.5rem;
            }

            .hero-subtitle {
                font-size: 1rem;
            }

            .auth-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Site Header -->
    <header class="site-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>Minnesota Then</h1>
                    <p class="tagline">Where History Lives and Grows</p>
                </div>
                <div class="col-md-4 text-end">
                    <div id="header-auth-status">
                        <!-- Auth status will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-section" id="hero-section">
        <div class="container">
            <div class="hero-content">
                <h2 class="hero-title">Discover, Document, and Share Minnesota's Rich History</h2>
                <p class="hero-subtitle">A collaborative wiki where communities preserve their stories for future generations</p>
                
                <!-- Search Bar -->
                <div class="search-bar">
                    <div class="input-group input-group-lg">
                        <input type="text" class="form-control" id="hero-search-input" placeholder="Search historical articles, people, places...">
                        <button class="btn btn-primary" id="hero-search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>

                <!-- Auth Buttons -->
                <div class="auth-buttons" id="hero-auth-buttons">
                    <button id="hero-login-btn" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-sign-in-alt"></i> Log In
                    </button>
                    <button id="hero-signup-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus"></i> Join the Community
                    </button>
                    <button id="hero-browse-btn" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-book-open"></i> Browse Articles
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Navigation -->
    <nav class="wiki-nav">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <nav class="nav">
                        <a class="nav-link active" href="#" data-page="home">Home</a>
                        <a class="nav-link" href="#" data-page="recent">Recent Changes</a>
                        <a class="nav-link" href="#" data-page="random">Random Article</a>
                        <a class="nav-link" href="#" data-page="categories">Categories</a>
                    </nav>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-sm btn-outline-primary d-lg-none" id="sidebar-toggle">
                        <i class="fas fa-bars"></i> Menu
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 p-0">
                <div class="sidebar" id="sidebar">
                    <h5><i class="fas fa-compass"></i> Navigation</h5>
                    <ul class="nav flex-column mb-4">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="home">
                                <i class="fas fa-home"></i> Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recent">
                                <i class="fas fa-clock"></i> Recent Changes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="random">
                                <i class="fas fa-random"></i> Random Article
                            </a>
                        </li>
                        <li class="nav-item" id="create-page-item" style="display:none;">
                            <a class="nav-link" href="#" data-page="create">
                                <i class="fas fa-plus"></i> Create Page
                            </a>
                        </li>
                        <li class="nav-item" id="admin-dash-item" style="display:none;">
                            <a class="nav-link" href="#" data-page="admin">
                                <i class="fas fa-cog"></i> Admin Dashboard
                            </a>
                        </li>
                    </ul>

                    <h5><i class="fas fa-tags"></i> Categories</h5>
                    <ul class="nav flex-column mb-4">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:places">
                                <i class="fas fa-map-marker-alt"></i> Places
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:people">
                                <i class="fas fa-users"></i> People
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:events">
                                <i class="fas fa-calendar"></i> Events
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:culture">
                                <i class="fas fa-theater-masks"></i> Culture
                            </a>
                        </li>
                    </ul>

                    <div class="mt-4">
                        <h5><i class="fas fa-search"></i> Quick Search</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="sidebar-search-input" placeholder="Search...">
                            <button class="btn btn-outline-secondary" id="sidebar-search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-9">
                <div class="content-area" id="content-area">
                    <!-- Content will be loaded here dynamically -->
                                        <div id="loading-spinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div id="auth-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100" id="auth-submit-btn">Login</button>
                    </form>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-link" id="switch-auth-mode">Create account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div class="modal fade" id="editorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <div class="mb-3">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-control" id="edit-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lead Paragraph</label>
                            <textarea class="form-control" id="edit-lead" rows="3" placeholder="Brief introduction or summary"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content (Markdown supported)</label>
                            <textarea class="form-control" id="edit-content" rows="15"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categories</label>
                            <select class="form-select" id="edit-categories" multiple>
                                <option value="places">Places</option>
                                <option value="people">People</option>
                                <option value="events">Events</option>
                                <option value="culture">Culture</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Edit Summary</label>
                            <input type="text" class="form-control" id="edit-summary" placeholder="Briefly describe your changes">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Toastr configuration
        toastr.options = {
            positionClass: "toast-top-right",
            timeOut: 3000,
            preventDuplicates: true
        };

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let currentPage = 'home';
        let simpleMDE;

        // DOM Elements
        const heroSection = document.getElementById('hero-section');
        const authModal = new bootstrap.Modal('#authModal');
        const editorModal = new bootstrap.Modal('#editorModal');
        const contentArea = document.getElementById('content-area');
        const loadingSpinner = document.getElementById('loading-spinner');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');

        // Initialize the app
        function init() {
            console.log('Initializing app...');
            setupAuth();
            setupUI();
            loadPage(currentPage);
        }

        // Authentication setup
        function setupAuth() {
            console.log('Setting up authentication...');
            
            auth.onAuthStateChanged(user => {
                console.log('Auth state changed:', user ? user.email : 'No user');
                currentUser = user;
                if (user) {
                    checkAdminStatus(user.uid);
                    updateAuthUI();
                    hideHeroSection();
                } else {
                    isAdmin = false;
                    updateAuthUI();
                    showHeroSection();
                }
            });

            // Setup auth button handlers
            setupAuthButtons();
        }

        function setupAuthButtons() {
            // Hero section buttons
            const heroLoginBtn = document.getElementById('hero-login-btn');
            const heroSignupBtn = document.getElementById('hero-signup-btn');
            const heroBrowseBtn = document.getElementById('hero-browse-btn');

            if (heroLoginBtn) {
                heroLoginBtn.addEventListener('click', () => showAuthModal(true));
            }
            if (heroSignupBtn) {
                heroSignupBtn.addEventListener('click', () => showAuthModal(false));
            }
            if (heroBrowseBtn) {
                heroBrowseBtn.addEventListener('click', () => {
                    hideHeroSection();
                    loadPage('home');
                });
            }

            // Auth form submission
            document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);

            // Switch between login/signup
            document.getElementById('switch-auth-mode').addEventListener('click', () => {
                const isLogin = document.getElementById('authModalTitle').textContent === 'Login';
                showAuthModal(!isLogin);
            });
        }

        async function handleAuthSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const isLogin = document.getElementById('authModalTitle').textContent === 'Login';
            
            const errorDiv = document.getElementById('auth-error');
            errorDiv.classList.add('d-none');

            try {
                if (isLogin) {
                    await auth.signInWithEmailAndPassword(email, password);
                    toastr.success('Logged in successfully');
                } else {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    // Create user profile
                    await db.ref(`users/${userCredential.user.uid}`).set({
                        email: email,
                        displayName: email.split('@')[0],
                        role: 'contributor',
                        joined: firebase.database.ServerValue.TIMESTAMP
                    });
                    toastr.success('Account created successfully');
                }
                authModal.hide();
            } catch (error) {
                console.error('Auth error:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
            }
        }

        function showAuthModal(isLogin) {
            document.getElementById('authModalTitle').textContent = isLogin ? 'Login' : 'Create Account';
            document.getElementById('auth-submit-btn').textContent = isLogin ? 'Login' : 'Create Account';
            document.getElementById('switch-auth-mode').textContent = isLogin ? 'Create account' : 'Already have an account?';
            document.getElementById('auth-error').classList.add('d-none');
            document.getElementById('auth-form').reset();
            authModal.show();
        }

        async function checkAdminStatus(uid) {
            try {
                const snapshot = await db.ref(`users/${uid}/role`).once('value');
                isAdmin = snapshot.val() === 'admin';
                updateAuthUI();
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        function updateAuthUI() {
            const headerAuthStatus = document.getElementById('header-auth-status');
            const heroAuthButtons = document.getElementById('hero-auth-buttons');
            
            if (currentUser) {
                // Update header
                headerAuthStatus.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="me-2 text-white">Welcome, ${currentUser.email.split('@')[0]}</span>
                        ${isAdmin ? '<span class="badge bg-warning me-2">Admin</span>' : ''}
                        <button id="logout-btn" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                `;
                
                // Update hero section
                heroAuthButtons.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        Welcome back, ${currentUser.email.split('@')[0]}! 
                        <a href="#" class="alert-link" data-page="create">Start contributing</a>
                    </div>
                `;

                // Add logout handler
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        auth.signOut();
                        toastr.info('Logged out successfully');
                    });
                }

                // Show authenticated menu items
                document.getElementById('create-page-item').style.display = 'block';
                if (isAdmin) {
                    document.getElementById('admin-dash-item').style.display = 'block';
                }
            } else {
                // Update header
                headerAuthStatus.innerHTML = `
                    <button class="btn btn-outline-light btn-sm me-2" onclick="showAuthModal(true)">
                        <i class="fas fa-sign-in-alt"></i> Log in
                    </button>
                    <button class="btn btn-light btn-sm" onclick="showAuthModal(false)">
                        <i class="fas fa-user-plus"></i> Sign up
                    </button>
                `;

                // Reset hero section
                heroAuthButtons.innerHTML = `
                    <button id="hero-login-btn" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-sign-in-alt"></i> Log In
                    </button>
                    <button id="hero-signup-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-user-plus"></i> Join the Community
                    </button>
                    <button id="hero-browse-btn" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-book-open"></i> Browse Articles
                    </button>
                `;

                // Re-setup button handlers
                setupAuthButtons();

                // Hide authenticated menu items
                document.getElementById('create-page-item').style.display = 'none';
                document.getElementById('admin-dash-item').style.display = 'none';
            }
        }

        function showHeroSection() {
            heroSection.style.display = 'block';
        }

        function hideHeroSection() {
            heroSection.style.display = 'none';
        }

        // UI Setup
        function setupUI() {
            // Sidebar toggle for mobile
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('show');
                });
            }

            // Navigation links
            document.addEventListener('click', (e) => {
                const pageLink = e.target.closest('[data-page]');
                if (pageLink) {
                    e.preventDefault();
                    const page = pageLink.getAttribute('data-page');
                    loadPage(page);
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Search functionality
            setupSearch();

            // Initialize markdown editor
            try {
                simpleMDE = new SimpleMDE({
                    element: document.getElementById('edit-content'),
                    spellChecker: false,
                    status: false,
                    toolbar: ["bold", "italic", "heading", "|", "unordered-list", "ordered-list", "|", "link", "preview", "guide"]
                });
            } catch (error) {
                console.error('Error initializing SimpleMDE:', error);
            }

            // Edit form submission
            document.getElementById('edit-form').addEventListener('submit', handleEditSubmit);
        }

        function setupSearch() {
            // Hero search
            const heroSearchBtn = document.getElementById('hero-search-btn');
            const heroSearchInput = document.getElementById('hero-search-input');
            
            if (heroSearchBtn && heroSearchInput) {
                heroSearchBtn.addEventListener('click', () => {
                    const query = heroSearchInput.value.trim();
                    if (query) {
                        hideHeroSection();
                        searchPages(query);
                    }
                });

                heroSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = heroSearchInput.value.trim();
                        if (query) {
                            hideHeroSection();
                            searchPages(query);
                        }
                    }
                });
            }

            // Sidebar search
            const sidebarSearchBtn = document.getElementById('sidebar-search-btn');
            const sidebarSearchInput = document.getElementById('sidebar-search-input');

                        
            if (sidebarSearchBtn && sidebarSearchInput) {
                sidebarSearchBtn.addEventListener('click', () => {
                    const query = sidebarSearchInput.value.trim();
                    if (query) {
                        searchPages(query);
                    }
                });

                sidebarSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = sidebarSearchInput.value.trim();
                        if (query) {
                            searchPages(query);
                        }
                    }
                });
            }
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            if (!currentUser) {
                toastr.error('You must be logged in to edit pages');
                return;
            }

            const pageData = {
                title: document.getElementById('edit-title').value.trim(),
                lead: document.getElementById('edit-lead').value.trim(),
                content: simpleMDE ? simpleMDE.value() : document.getElementById('edit-content').value,
                categories: Array.from(document.getElementById('edit-categories').selectedOptions)
                    .map(opt => opt.value),
                lastEdited: {
                    by: currentUser.uid,
                    name: currentUser.email.split('@')[0],
                    at: firebase.database.ServerValue.TIMESTAMP
                },
                summary: document.getElementById('edit-summary').value.trim(),
                created: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                const pageId = generatePageId(pageData.title);
                await db.ref(`pages/${pageId}`).set(pageData);
                
                // Record revision
                await db.ref(`revisions/${pageId}_${Date.now()}`).set({
                    ...pageData,
                    pageId: pageId,
                    editor: currentUser.uid,
                    status: isAdmin ? 'approved' : 'pending'
                });
                
                editorModal.hide();
                toastr.success('Page saved successfully');
                loadPage(pageId);
            } catch (error) {
                console.error('Error saving page:', error);
                toastr.error('Error saving page: ' + error.message);
            }
        }

        // Page loading functions
        function loadPage(page) {
            currentPage = page;
            showLoading();
            
            // Handle special pages
            if (page === 'home') {
                loadHomePage();
            } else if (page === 'recent') {
                loadRecentChanges();
            } else if (page === 'random') {
                loadRandomPage();
            } else if (page === 'create') {
                showEditor();
            } else if (page === 'admin') {
                loadAdminDashboard();
            } else if (page === 'categories') {
                loadCategoriesPage();
            } else if (page.startsWith('category:')) {
                const category = page.split(':')[1];
                loadCategoryPages(category);
            } else {
                loadWikiPage(page);
            }
        }

        function showLoading() {
            loadingSpinner.style.display = 'block';
            contentArea.innerHTML = '';
            contentArea.appendChild(loadingSpinner);
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
        }

        function loadHomePage() {
            const html = `
                <div class="row">
                    <div class="col-12">
                        <h1><i class="fas fa-home"></i> Welcome to Minnesota Then</h1>
                        <p class="lead">A collaborative platform for preserving and sharing Minnesota's rich history</p>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-lg-8">
                        <div class="card feature-card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-star"></i> Featured Article</h5>
                                <div id="featured-article">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2">Loading featured content...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card feature-card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-clock"></i> Recent Activity</h5>
                                <div id="recent-activity">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2">Loading recent changes...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card feature-card text-center">
                            <div class="card-body">
                                <i class="fas fa-map-marker-alt fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">Explore Places</h5>
                                <p class="card-text">Discover historic locations across Minnesota</p>
                                <a href="#" class="btn btn-primary" data-page="category:places">Browse Places</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card feature-card text-center">
                            <div class="card-body">
                                <i class="fas fa-users fa-3x text-success mb-3"></i>
                                <h5 class="card-title">Meet People</h5>
                                <p class="card-text">Learn about influential Minnesotans</p>
                                <a href="#" class="btn btn-success" data-page="category:people">Browse People</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card feature-card text-center">
                            <div class="card-body">
                                <i class="fas fa-calendar fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">Historical Events</h5>
                                <p class="card-text">Explore significant moments in time</p>
                                <a href="#" class="btn btn-warning" data-page="category:events">Browse Events</a>
                            </div>
                        </div>
                    </div>
                </div>

                ${currentUser ? `
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-plus-circle"></i> Ready to Contribute?</h5>
                                    <p class="mb-3">Help preserve Minnesota's history by creating or editing articles</p>
                                    <a href="#" class="btn btn-primary me-2" data-page="create">
                                        <i class="fas fa-plus"></i> Create New Article
                                    </a>
                                    <a href="#" class="btn btn-outline-primary" data-page="random">
                                        <i class="fas fa-edit"></i> Edit Random Article
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            contentArea.innerHTML = html;
            hideLoading();
            
            // Load featured article
            loadFeaturedArticle();
            loadRecentActivity();
        }

        async function loadFeaturedArticle() {
            try {
                const snapshot = await db.ref('pages').orderByChild('featured').equalTo(true).limitToFirst(1).once('value');
                const featuredDiv = document.getElementById('featured-article');
                
                if (snapshot.exists()) {
                    const pageId = Object.keys(snapshot.val())[0];
                    const page = snapshot.val()[pageId];
                    featuredDiv.innerHTML = `
                        <h3><a href="#" data-page="${pageId}" class="text-decoration-none">${page.title}</a></h3>
                        <p class="text-muted">${page.lead || 'No description available'}</p>
                        <div class="wiki-content">${markdownToHtml(page.content ? page.content.substring(0, 300) + '...' : '')}</div>
                        <a href="#" data-page="${pageId}" class="btn btn-outline-primary btn-sm mt-2">Read More</a>
                    `;
                } else {
                    // Show a random article instead
                    const allPages = await db.ref('pages').limitToFirst(1).once('value');
                    if (allPages.exists()) {
                        const pageId = Object.keys(allPages.val())[0];
                        const page = allPages.val()[pageId];
                        featuredDiv.innerHTML = `
                            <h3><a href="#" data-page="${pageId}" class="text-decoration-none">${page.title}</a></h3>
                            <p class="text-muted">${page.lead || 'No description available'}</p>
                            <div class="wiki-content">${markdownToHtml(page.content ? page.content.substring(0, 300) + '...' : '')}</div>
                            <a href="#" data-page="${pageId}" class="btn btn-outline-primary btn-sm mt-2">Read More</a>
                        `;
                    } else {
                        featuredDiv.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                                <h5>No Articles Yet</h5>
                                <p class="text-muted">Be the first to create an article!</p>
                                ${currentUser ? '<a href="#" class="btn btn-primary" data-page="create">Create First Article</a>' : ''}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading featured article:', error);
                document.getElementById('featured-article').innerHTML = '<p class="text-danger">Error loading featured article</p>';
            }
        }

        async function loadRecentActivity() {
            try {
                const snapshot = await db.ref('revisions').orderByChild('lastEdited/at').limitToLast(5).once('value');
                const activityDiv = document.getElementById('recent-activity');
                
                if (snapshot.exists()) {
                    let html = '<div class="list-group list-group-flush">';
                    const revisions = [];
                    snapshot.forEach(child => {
                        revisions.unshift(child.val()); // Reverse order
                    });
                    
                    revisions.forEach(rev => {
                        const pageId = generatePageId(rev.title);
                        html += `
                            <div class="list-group-item border-0 px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">
                                        <a href="#" data-page="${pageId}" class="text-decoration-none">${rev.title}</a>
                                    </h6>
                                    <small class="text-muted">${formatDate(rev.lastEdited.at)}</small>
                                </div>
                                <p class="mb-1 small text-muted">Edited by ${rev.lastEdited.name}</p>
                                ${rev.summary ? `<small class="text-muted">${rev.summary}</small>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += '<div class="text-center mt-3"><a href="#" data-page="recent" class="btn btn-outline-primary btn-sm">View All Changes</a></div>';
                    activityDiv.innerHTML = html;
                } else {
                    activityDiv.innerHTML = '<p class="text-muted text-center py-4">No recent activity</p>';
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recent-activity').innerHTML = '<p class="text-danger">Error loading recent activity</p>';
            }
        }

        async function loadWikiPage(pageId) {
            try {
                const snapshot = await db.ref(`pages/${pageId}`).once('value');
                hideLoading();
                
                if (snapshot.exists()) {
                    const page = snapshot.val();
                    const html = `
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1>${page.title}</h1>
                                ${page.categories && page.categories.length > 0 ? `
                                    <div class="mb-2">
                                        ${page.categories.map(cat => `
                                            <span class="badge bg-secondary me-1">
                                                <a href="#" data-page="category:${cat}" class="text-white text-decoration-none">${cat}</a>
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            ${currentUser ? `
                                <button class="btn btn-outline-primary" id="edit-page-btn">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            ` : ''}
                        </div>
                        
                        ${page.lead ? `<p class="lead">${page.lead}</p>` : ''}
                        
                        <div class="wiki-content">
                            ${markdownToHtml(page.content || '')}
                        </div>
                        
                        <div class="mt-5 pt-3 border-top">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> 
                                        Last edited by <strong>${page.lastEdited.name}</strong> 
                                        on ${formatDate(page.lastEdited.at)}
                                    </small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted">
                                        <a href="#" data-page="recent" class="text-decoration-none">
                                            <i class="fas fa-history"></i> View History
                                        </a>
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    contentArea.innerHTML = html;
                    
                    // Add edit button handler
                    if (currentUser) {
                        const editBtn = document.getElementById('edit-page-btn');
                        if (editBtn) {
                            editBtn.addEventListener('click', () => showEditor(pageId));
                        }
                    }
                } else {
                    contentArea.innerHTML = `
                        <div class="text-center py-5">
                                                       <i class="fas fa-file-alt fa-4x text-muted mb-4"></i>
                            <h2>Page Not Found</h2>
                            <p class="lead text-muted">The page "${pageId}" doesn't exist yet.</p>
                            ${currentUser ? `
                                <button class="btn btn-primary" onclick="showEditor('${pageId}')">
                                    <i class="fas fa-plus"></i> Create This Page
                                </button>
                            ` : `
                                <p class="text-muted">
                                    <a href="#" onclick="showAuthModal(false)" class="text-decoration-none">Sign up</a> 
                                    to create this page
                                </p>
                            `}
                            <div class="mt-3">
                                <a href="#" data-page="home" class="btn btn-outline-secondary">
                                    <i class="fas fa-home"></i> Go Home
                                </a>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading page:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading page: ${error.message}
                    </div>
                `;
            }
        }

        async function loadRecentChanges() {
            try {
                const snapshot = await db.ref('revisions').orderByChild('lastEdited/at').limitToLast(20).once('value');
                hideLoading();
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1><i class="fas fa-clock"></i> Recent Changes</h1>
                    </div>
                `;
                
                if (snapshot.exists()) {
                    html += '<div class="list-group">';
                    const revisions = [];
                    snapshot.forEach(child => {
                        revisions.unshift(child.val()); // Reverse order
                    });
                    
                    revisions.forEach(rev => {
                        const pageId = generatePageId(rev.title);
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">
                                        <a href="#" data-page="${pageId}" class="text-decoration-none">${rev.title}</a>
                                    </h5>
                                    <small class="text-muted">${formatDate(rev.lastEdited.at)}</small>
                                </div>
                                <p class="mb-1">Edited by <strong>${rev.lastEdited.name}</strong></p>
                                ${rev.summary ? `<small class="text-muted">${rev.summary}</small>` : '<small class="text-muted">No edit summary</small>'}
                                ${rev.categories && rev.categories.length > 0 ? `
                                    <div class="mt-2">
                                        ${rev.categories.map(cat => `
                                            <span class="badge bg-secondary me-1">
                                                <a href="#" data-page="category:${cat}" class="text-white text-decoration-none">${cat}</a>
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="text-center py-5">
                            <i class="fas fa-clock fa-4x text-muted mb-4"></i>
                            <h3>No Recent Changes</h3>
                            <p class="text-muted">No pages have been edited recently.</p>
                        </div>
                    `;
                }
                
                contentArea.innerHTML = html;
            } catch (error) {
                console.error('Error loading recent changes:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading recent changes: ${error.message}
                    </div>
                `;
            }
        }

        async function loadRandomPage() {
            try {
                const snapshot = await db.ref('pages').once('value');
                hideLoading();
                
                if (snapshot.exists()) {
                    const pages = Object.keys(snapshot.val());
                    const randomPageId = pages[Math.floor(Math.random() * pages.length)];
                    loadPage(randomPageId);
                } else {
                    contentArea.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-dice fa-4x text-muted mb-4"></i>
                            <h3>No Pages Available</h3>
                            <p class="text-muted">There are no pages to display randomly.</p>
                            ${currentUser ? `
                                <button class="btn btn-primary" data-page="create">
                                    <i class="fas fa-plus"></i> Create First Page
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading random page:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading random page: ${error.message}
                    </div>
                `;
            }
        }

        async function loadCategoriesPage() {
            try {
                const snapshot = await db.ref('pages').once('value');
                hideLoading();
                
                const categories = {
                    places: [],
                    people: [],
                    events: [],
                    culture: []
                };
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const page = child.val();
                        const pageId = child.key;
                        
                        if (page.categories) {
                            page.categories.forEach(cat => {
                                if (categories[cat]) {
                                    categories[cat].push({ id: pageId, ...page });
                                }
                            });
                        }
                    });
                }
                
                let html = `
                    <div class="mb-4">
                        <h1><i class="fas fa-tags"></i> Categories</h1>
                        <p class="lead">Browse articles by category</p>
                    </div>
                    
                    <div class="row">
                `;
                
                Object.entries(categories).forEach(([category, pages]) => {
                    const icons = {
                        places: 'fa-map-marker-alt',
                        people: 'fa-users',
                        events: 'fa-calendar',
                        culture: 'fa-palette'
                    };
                    
                    const colors = {
                        places: 'primary',
                        people: 'success',
                        events: 'warning',
                        culture: 'info'
                    };
                    
                    html += `
                        <div class="col-md-6 col-lg-3 mb-4">
                            <div class="card feature-card h-100">
                                <div class="card-body text-center">
                                    <i class="fas ${icons[category]} fa-3x text-${colors[category]} mb-3"></i>
                                    <h5 class="card-title text-capitalize">${category}</h5>
                                    <p class="card-text">${pages.length} article${pages.length !== 1 ? 's' : ''}</p>
                                    <a href="#" data-page="category:${category}" class="btn btn-${colors[category]}">
                                        Browse ${category}
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                contentArea.innerHTML = html;
            } catch (error) {
                console.error('Error loading categories:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading categories: ${error.message}
                    </div>
                `;
            }
        }

        async function loadCategoryPages(category) {
            try {
                const snapshot = await db.ref('pages').orderByChild('categories').once('value');
                hideLoading();
                
                const pages = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const page = child.val();
                        if (page.categories && page.categories.includes(category)) {
                            pages.push({ id: child.key, ...page });
                        }
                    });
                }
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1><i class="fas fa-tag"></i> ${category.charAt(0).toUpperCase() + category.slice(1)}</h1>
                            <p class="text-muted">${pages.length} article${pages.length !== 1 ? 's' : ''} in this category</p>
                        </div>
                        <a href="#" data-page="categories" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> All Categories
                        </a>
                    </div>
                `;
                
                if (pages.length > 0) {
                    html += '<div class="row">';
                    pages.forEach(page => {
                        html += `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card feature-card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <a href="#" data-page="${page.id}" class="text-decoration-none">${page.title}</a>
                                        </h5>
                                        <p class="card-text">${page.lead || 'No description available'}</p>
                                        <div class="mt-auto">
                                            <small class="text-muted">
                                                Last edited by ${page.lastEdited.name} on ${formatDate(page.lastEdited.at)}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="text-center py-5">
                            <i class="fas fa-folder-open fa-4x text-muted mb-4"></i>
                            <h3>No Articles in This Category</h3>
                            <p class="text-muted">Be the first to create an article in the ${category} category!</p>
                            ${currentUser ? `
                                <button class="btn btn-primary" data-page="create">
                                    <i class="fas fa-plus"></i> Create Article
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                contentArea.innerHTML = html;
            } catch (error) {
                console.error('Error loading category pages:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading category: ${error.message}
                    </div>
                `;
            }
        }

        async function searchPages(query) {
            try {
                showLoading();
                const snapshot = await db.ref('pages').once('value');
                hideLoading();
                
                const results = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const page = child.val();
                        const pageId = child.key;
                        
                        // Simple text search
                        const searchText = `${page.title} ${page.lead || ''} ${page.content || ''}`.toLowerCase();
                        if (searchText.includes(query.toLowerCase())) {
                            results.push({ id: pageId, ...page });
                        }
                    });
                }
                
                let html = `
                    <div class="mb-4">
                        <h1><i class="fas fa-search"></i> Search Results</h1>
                        <p class="text-muted">Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"</p>
                    </div>
                `;
                
                if (results.length > 0) {
                    html += '<div class="list-group">';
                    results.forEach(page => {
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">
                                        <a href="#" data-page="${page.id}" class="text-decoration-none">${page.title}</a>
                                    </h5>
                                    <small class="text-muted">${formatDate(page.lastEdited.at)}</small>
                                </div>
                                <p class="mb-1">${page.lead || 'No description available'}</p>
                                ${page.categories && page.categories.length > 0 ? `
                                    <div class="mt-2">
                                        ${page.categories.map(cat => `
                                            <span class="badge bg-secondary me-1">
                                                <a href="#" data-page="category:${cat}" class="text-white text-decoration-none">${cat}</a>
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-4x text-muted mb-4"></i>
                            <h3>No Results Found</h3>
                            <p class="text-muted">No articles match your search for "${query}"</p>
                            ${currentUser ? `
                                <button class="btn btn-primary" onclick="showEditor('${generatePageId(query)}')">
                                    <i class="fas fa-plus"></i> Create "${query}" Article
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                contentArea.innerHTML = html;
            } catch (error) {
                console.error('Error searching pages:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error searching: ${error.message}
                    </div>
                `;
            }
        }

        function showEditor(pageId = null) {
            if (!currentUser) {
                toastr.error('You must be logged in to edit pages');
                showAuthModal(true);
                return;
            }
            
            hideLoading();
            
            // Reset form
            document.getElementById('edit-form').reset();
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-lead').value = '';
            document.getElementById('edit-summary').value = '';
            
            if (simpleMDE) {
                simpleMDE.value('');
            } else {
                document.getElementById('edit-content').value = '';
            }
            
            // Clear category selections
            const categorySelect = document.getElementById('edit-categories');
            Array.from(categorySelect.options).forEach(option => option.selected = false);
            
            if (pageId) {
                // Load existing page for editing
                db.ref(`pages/${pageId}`).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const page = snapshot.val();
                        document.getElementById('edit-title').value = page.title;
                        document.getElementById('edit-lead').value = page.lead || '';
                        
                        if (simpleMDE) {
                            simpleMDE.value(page.content || '');
                        } else {
                            document.getElementById('edit-content').value = page.content || '';
                        }
                        
                        // Set categories
                        if (page.categories) {
                            page.categories.forEach(cat => {
                                const option = categorySelect.querySelector(`option[value="${cat}"]`);
                                if (option) option.selected = true;
                            });
                        }
                    } else if (pageId !== 'create') {
                        // New page with suggested title
                        const title = pageId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        document.getElementById('edit-title').value = title;
                    }
                }).catch(error => {
                    console.error('Error loading page for editing:', error);
                    toastr.error('Error loading page for editing');
                });
            }
            
            editorModal.show();
        }

        async function loadAdminDashboard() {
            if (!isAdmin) {
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-lock"></i>
                        Access denied. Admin privileges required.
                    </div>
                `;
                return;
            }
            
            try {
                const [pagesSnapshot, usersSnapshot, revisionsSnapshot] = await Promise.all([
                    db.ref('pages').once('value'),
                    db.ref('users').once('value'),
                    db.ref('revisions').orderByChild('status').equalTo('pending').once('value')
                ]);
                
                hideLoading();
                
                const totalPages = pagesSnapshot.exists() ? Object.keys(pagesSnapshot.val()).length : 0;
                const totalUsers = usersSnapshot.exists() ? Object.keys(usersSnapshot.val()).length : 0;
                const pendingReviews = revisionsSnapshot.exists() ? Object.keys(revisionsSnapshot.val()).length : 0;
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${totalPages}</h4>
                                            <p class="mb-0">Total Pages</p>
                                        </div>
                                        <i class="fas fa-file-alt fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${totalUsers}</h4>
                                            <p class="mb-0">Total Users</p>
                                        </div>
                                        <i class="fas fa-users fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${pendingReviews}</h4>
                                            <p class="mb-0">Pending Reviews</p>
                                        </div>
                                        <i class="fas fa-clock fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-clock"></i> Recent Activity</h5>
                                </div>
                                <div class="card-body">
                                    <div id="admin-recent-activity">Loading...</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" data-page="create">
                                            <i class="fas fa-plus"></i> Create New Page
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="loadPendingReviews()">
                                            <i class="fas fa-eye"></i> Review Pending Changes
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="loadUserManagement()">
                                            <i class="fas fa-users-cog"></i> Manage Users
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportData()">
                                            <i class="fas fa-download"></i> Export Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                contentArea.innerHTML = html;
                loadAdminRecentActivity();
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading admin dashboard: ${error.message}
                    </div>
                `;
            }
        }

        async function loadAdminRecentActivity() {
            try {
                const snapshot = await db.ref('revisions').orderByChild('lastEdited/at').limitToLast(10).once('value');
                const activityDiv = document.getElementById('admin-recent-activity');
                
                if (snapshot.exists()) {
                    let html = '<div class="list-group list-group-flush">';
                    const revisions = [];
                    snapshot.forEach(child => {
                        revisions.unshift({ id: child.key, ...child.val() });
                    });
                    
                    revisions.forEach(rev => {
                        const statusBadge = rev.status === 'approved' ? 
                            '<span class="badge bg-success">Approved</span>' :
                            '<span class="badge bg-warning">Pending</span>';
                        
                        html += `
                            <div class="list-group-item border-0 px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${rev.title} ${statusBadge}</h6>
                                    <small class="text-muted">${formatDate(rev.lastEdited.at)}</small>
                                </div>
                                <p class="mb-1 small">Edited by ${rev.lastEdited.name}</p>
                                <small class="text-muted">${rev.summary || 'No edit summary'}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    activityDiv.innerHTML = html;
                } else {
                    activityDiv.innerHTML = '<p class="text-muted">No recent activity</p>';
                }
            } catch (error) {
                console.error('Error loading admin recent activity:', error);
                document.getElementById('admin-recent-activity').innerHTML = '<p class="text-danger">Error loading activity</p>';
            }
        }

        // Utility functions
        function generatePageId(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            // Simple markdown parser - you might want to use a library like marked.js for production
            return markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>')
                .replace(/^(.*)$/gim, '<p>$1</p>')
                .replace(/<p><\/p>/gim, '')
                .replace(/<p>(<h[1-6]>.*<\/h[1-6]>)<\/p>/gim, '$1')
                .replace(/<p>(<ul>.*<\/ul>)<\/p>/gims, '$1')
                .replace(/<p>(<ol>.*<\/ol>)<\/p>/gims, '$1');
        }

        // Additional admin functions
        async function loadPendingReviews() {
            if (!isAdmin) return;
            
            try {
                showLoading();
                const snapshot = await db.ref('revisions').orderByChild('status').equalTo('pending').once('value');
                hideLoading();
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1><i class="fas fa-eye"></i> Pending Reviews</h1>
                        <button class="btn btn-outline-secondary" data-page="admin">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </button>
                    </div>
                `;
                
                if (snapshot.exists()) {
                    html += '<div class="list-group">';
                    snapshot.forEach(child => {
                        const rev = child.val();
                        const revId = child.key;
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${rev.title}</h5>
                                    <div>
                                        <button class="btn btn-success btn-sm me-2" onclick="approveRevision('${revId}')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectRevision('${revId}')">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-1">Edited by <strong>${rev.lastEdited.name}</strong> on ${formatDate(rev.lastEdited.at)}</p>
                                <small class="text-muted">${rev.summary || 'No edit summary'}</small>
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="previewRevision('${revId}')">
                                        <i class="fas fa-eye"></i> Preview Changes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle fa-4x text-success mb-4"></i>
                            <h3>All Caught Up!</h3>
                            <p class="text-muted">No pending reviews at this time.</p>
                        </div>
                    `;
                }
                
                contentArea.innerHTML = html;
            } catch (error) {
                console.error('Error loading pending reviews:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading pending reviews: ${error.message}
                    </div>
                `;
            }
        }

        async function approveRevision(revisionId) {
            if (!isAdmin) return;
            
            try {
                const revSnapshot = await db.ref(`revisions/${revisionId}`).once('value');
                if (revSnapshot.exists()) {
                    const revision = revSnapshot.val();
                    const pageId = generatePageId(revision.title);
                    
                    // Update the main page
                    await db.ref(`pages/${pageId}`).set({
                        title: revision.title,
                        lead: revision.lead,
                        content: revision.content,
                        categories: revision.categories,
                        lastEdited: revision.lastEdited,
                        created: revision.created
                    });
                    
                    // Mark revision as approved
                    await db.ref(`revisions/${revisionId}/status`).set('approved');
                    
                    toastr.success('Revision approved successfully');
                    loadPendingReviews(); // Refresh the list
                }
            } catch (error) {
                console.error('Error approving revision:', error);
                toastr.error('Error approving revision: ' + error.message);
            }
        }

        async function rejectRevision(revisionId) {
            if (!isAdmin) return;
            
            if (confirm('Are you sure you want to reject this revision? This action cannot be undone.')) {
                try {
                    await db.ref(`revisions/${revisionId}/status`).set('rejected');
                    toastr.success('Revision rejected');
                    loadPendingReviews(); // Refresh the list
                } catch (error) {
                    console.error('Error rejecting revision:', error);
                    toastr.error('Error rejecting revision: ' + error.message);
                }
            }
        }

        async function previewRevision(revisionId) {
            try {
                const snapshot = await db.ref(`revisions/${revisionId}`).once('value');
                if (snapshot.exists()) {
                    const revision = snapshot.val();
                    
                    // Create a modal for preview
                    const previewModal = document.createElement('div');
                    previewModal.className = 'modal fade';
                    previewModal.innerHTML = `
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Preview: ${revision.title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>Editor:</strong> ${revision.lastEdited.name}<br>
                                        <strong>Date:</strong> ${formatDate(revision.lastEdited.at)}<br>
                                        <strong>Summary:</strong> ${revision.summary || 'No edit summary'}
                                    </div>
                                    <hr>
                                    <h1>${revision.title}</h1>
                                    ${revision.lead ? `<p class="lead">${revision.lead}</p>` : ''}
                                    <div class="wiki-content">
                                        ${markdownToHtml(revision.content || '')}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-success" onclick="approveRevision('${revisionId}'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectRevision('${revisionId}'); bootstrap.Modal.getInstance(this.closest('.modal')).hide();">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(previewModal);
                    const modal = new bootstrap.Modal(previewModal);
                    modal.show();
                    
                    // Clean up modal when hidden
                    previewModal.addEventListener('hidden.bs.modal', () => {
                        document.body.removeChild(previewModal);
                    });
                }
            } catch (error) {
                console.error('Error previewing revision:', error);
                toastr.error('Error loading preview');
            }
        }

        async function loadUserManagement() {
            if (!isAdmin) return;
            
            try {
                showLoading();
                const snapshot = await db.ref('users').once('value');
                hideLoading();
                
                let html = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1><i class="fas fa-users-cog"></i> User Management</h1>
                        <button class="btn btn-outline-secondary" data-page="admin">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </button>
                    </div>
                `;
                
                if (snapshot.exists()) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Display Name</th>
                                        <th>Role</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    snapshot.forEach(child => {
                        const user = child.val();
                        const userId = child.key;
                        const isCurrentUser = userId === currentUser.uid;
                        
                        html += `
                            <tr>
                                <td>${user.email}</td>
                                <td>${user.displayName || 'N/A'}</td>
                                <td>
                                    <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-secondary'}">
                                        ${user.role || 'contributor'}
                                    </span>
                                </td>
                                <td>${formatDate(user.joined)}</td>
                                <td>
                                    ${!isCurrentUser ? `
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="changeUserRole('${userId}', '${user.role === 'admin' ? 'contributor' : 'admin'}')">
                                                <i class="fas fa-user-${user.role === 'admin' ? 'minus' : 'plus'}"></i>
                                                ${user.role === 'admin' ? 'Remove Admin' : 'Make Admin'}
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="suspendUser('${userId}')">
                                                <i class="fas fa-ban"></i> Suspend
                                            </button>
                                        </div>
                                    ` : '<span class="text-muted">Current User</span>'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-4x text-muted mb-4"></i>
                            <h3>No Users Found</h3>
                            <p class="text-muted">No user data available.</p>
                        </div>
                    `;
                }
                
                contentArea.innerHTML = html;
            } catch (error) {
                console.error('Error loading user management:', error);
                hideLoading();
                contentArea.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading user management: ${error.message}
                    </div>
                `;
            }
        }

        async function changeUserRole(userId, newRole) {
            if (!isAdmin) return;
            
            try {
                await db.ref(`users/${userId}/role`).set(newRole);
                toastr.success(`User role updated to ${newRole}`);
                loadUserManagement(); // Refresh the list
            } catch (error) {
                console.error('Error changing user role:', error);
                toastr.error('Error updating user role: ' + error.message);
            }
        }

        async function suspendUser(userId) {
            if (!isAdmin) return;
            
            if (confirm('Are you sure you want to suspend this user? They will no longer be able to edit pages.')) {
                try {
                    await db.ref(`users/${userId}/suspended`).set(true);
                    toastr.success('User suspended successfully');
                    loadUserManagement(); // Refresh the list
                } catch (error) {
                    console.error('Error suspending user:', error);
                    toastr.error('Error suspending user: ' + error.message);
                }
            }
        }

        async function exportData() {
            if (!isAdmin) return;
            
            try {
                toastr.info('Preparing data export...');
                
                const [pagesSnapshot, usersSnapshot, revisionsSnapshot] = await Promise.all([
                    db.ref('pages').once('value'),
                    db.ref('users').once('value'),
                    db.ref('revisions').once('value')
                ]);
                
                const exportData = {
                    pages: pagesSnapshot.val() || {},
                    users: usersSnapshot.val() || {},
                    revisions: revisionsSnapshot.val() || {},
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Create and download JSON file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `minnesota-then-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                toastr.success('Data exported successfully');
            } catch (error) {
                console.error('Error exporting data:', error);
                toastr.error('Error exporting data: ' + error.message);
            }
        }

        // Initialize Firebase SDK loading and app
        function loadFirebaseSDK() {
            return new Promise((resolve, reject) => {
                // Check if Firebase is already loaded
                if (typeof firebase !== 'undefined') {
                    resolve();
                    return;
                }
                
                // Load Firebase SDK
                const script = document.createElement('script');
                script.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js';
                script.onload = () => {
                    const authScript = document.createElement('script');
                    authScript.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js';
                    authScript.onload = () => {
                        const dbScript = document.createElement('script');
                        dbScript.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js';
                        dbScript.onload = () => {
                            const storageScript = document.createElement('script');
                            storageScript.src = 'https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js';
                            storageScript.onload = resolve;
                            storageScript.onerror = reject;
                            document.head.appendChild(storageScript);
                        };
                        dbScript.onerror = reject;
                        document.head.appendChild(dbScript);
                    };
                    authScript.onerror = reject;
                    document.head.appendChild(authScript);
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            toastr.error('An unexpected error occurred. Please refresh the page.');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            toastr.error('An unexpected error occurred. Please try again.');
        });

        // Service Worker registration for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app...');
            
            // Load Firebase SDK first, then initialize
            loadFirebaseSDK()
                .then(() => {
                    console.log('Firebase SDK loaded');
                    init();
                })
                .catch(error => {
                    console.error('Error loading Firebase SDK:', error);
                    contentArea.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error loading application. Please refresh the page.
                        </div>
                    `;
                });
        });

        // Expose functions to global scope for onclick handlers
        window.showAuthModal = showAuthModal;
        window.approveRevision = approveRevision;
        window.rejectRevision = rejectRevision;
        window.previewRevision = previewRevision;
        window.changeUserRole = changeUserRole;
        window.suspendUser = suspendUser;
        window.exportData = exportData;
        window.loadPendingReviews = loadPendingReviews;
        window.loadUserManagement = loadUserManagement;
        window.showEditor = showEditor;

    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

</body>
</html>

