<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then - Community History Wiki</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Toastr for notifications -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    
    <style>
        :root {
            /* Color palette */
            --primary-50: #EFF6FF;
            --primary-600: #2563EB;
            --primary-800: #1E40AF;
            --neutral-50: #F9FAFB;
            --neutral-200: #E5E7EB;
            --neutral-500: #6B7280;
            --neutral-700: #374151;
            --neutral-900: #111827;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            
            /* Spacing */
            --space-2: 0.5rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* Typography */
            --font-heading: 'EB Garamond', serif;
            --font-body: 'Open Sans', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--neutral-50);
            color: var(--neutral-900);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
        }

        .wiki-header {
            background-color: white;
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-2) 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .sidebar {
            background-color: white;
            border-right: 1px solid var(--neutral-200);
            padding: var(--space-4);
            min-height: calc(100vh - 80px);
        }

        .content-area {
            padding: var(--space-4);
            min-height: calc(100vh - 80px);
        }

        .wiki-section {
            margin-bottom: var(--space-8);
        }

        .infobox {
            background-color: white;
            border: 1px solid var(--neutral-200);
            padding: var(--space-4);
            margin: 0 0 var(--space-4) var(--space-4);
            width: 300px;
            float: right;
        }

        .edit-toolbar {
            background-color: white;
            border: 1px solid var(--neutral-200);
            padding: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .contributor-badge {
            font-size: 0.7rem;
            background-color: var(--primary-50);
            color: var(--primary-800);
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* Mobile styles */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 80px;
                width: 280px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            .sidebar.show {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="wiki-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <a href="/" class="text-decoration-none">
                        <h1 class="m-0">Minnesota Then</h1>
                        <p class="m-0 text-muted">Community History Wiki</p>
                    </a>
                </div>
                <div class="col-md-4 text-end" id="auth-status">
                    <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                    <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 p-0">
                <div class="sidebar" id="sidebar">
                    <h5>Navigation</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="home">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recent">Recent Changes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="random">Random Article</a>
                        </li>
                        <li class="nav-item" id="create-page-item" style="display:none;">
                            <a class="nav-link" href="#" data-page="create">Create Page</a>
                        </li>
                        <li class="nav-item" id="admin-dash-item" style="display:none;">
                            <a class="nav-link" href="#" data-page="admin">Admin Dashboard</a>
                        </li>
                    </ul>

                    <h5 class="mt-4">Categories</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:places">Places</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:people">People</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="category:events">Events</a>
                        </li>
                    </ul>

                    <div class="mt-4">
                        <h5>Search</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="Search...">
                            <button class="btn btn-outline-secondary" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary d-lg-none" id="sidebar-toggle" style="position:fixed; bottom:20px; right:20px; z-index:1000;">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9 col-lg-10">
                <div class="content-area" id="content-area">
                    <!-- Content will be loaded here dynamically -->
                    <div id="loading-spinner" class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div id="auth-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100" id="auth-submit-btn">Login</button>
                    </form>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-link" id="switch-auth-mode">Create account</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <div class="mb-3">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-control" id="edit-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lead Paragraph</label>
                            <textarea class="form-control" id="edit-lead" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea class="form-control" id="edit-content" rows="10"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categories</label>
                            <select class="form-select" id="edit-categories" multiple>
                                <option value="places">Places</option>
                                <option value="people">People</option>
                                <option value="events">Events</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Edit Summary</label>
                            <input type="text" class="form-control" id="edit-summary" placeholder="Briefly describe your changes">
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
            authDomain: "mnthen-3151d.firebaseapp.com",
            databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com",
            projectId: "mnthen-3151d",
            storageBucket: "mnthen-3151d.appspot.com",
            messagingSenderId: "416231360428",
            appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Toastr configuration
        toastr.options = {
            positionClass: "toast-top-right",
            timeOut: 3000
        };

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let currentPage = 'home';
        let simpleMDE;

        // DOM Elements
        const authStatus = document.getElementById('auth-status');
        const authModal = new bootstrap.Modal('#authModal');
        const editorModal = new bootstrap.Modal('#editorModal');
        const contentArea = document.getElementById('content-area');
        const loadingSpinner = document.getElementById('loading-spinner');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');

        // Initialize the app
        function init() {
            setupAuth();
            setupUI();
            loadPage(currentPage);
        }

        // Authentication setup
        function setupAuth() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    checkAdminStatus(user.uid);
                    updateAuthUI();
                } else {
                    updateAuthUI();
                }
            });

            // Login/signup buttons
            document.getElementById('login-btn').addEventListener('click', () => {
                showAuthModal(true);
            });

            document.getElementById('signup-btn').addEventListener('click', () => {
                showAuthModal(false);
            });

            // Auth form submission
            document.getElementById('auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const isLogin = document.getElementById('authModalTitle').textContent === 'Login';

                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                        toastr.success('Logged in successfully');
                    } else {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        // Create user profile
                        await db.ref(`users/${userCredential.user.uid}`).set({
                            email: email,
                            displayName: email.split('@')[0],
                            role: 'contributor',
                            joined: firebase.database.ServerValue.TIMESTAMP
                        });
                        toastr.success('Account created successfully');
                    }
                    authModal.hide();
                } catch (error) {
                    document.getElementById('auth-error').textContent = error.message;
                    document.getElementById('auth-error').classList.remove('d-none');
                }
            });

            // Switch between login/signup
            document.getElementById('switch-auth-mode').addEventListener('click', () => {
                const isLogin = document.getElementById('authModalTitle').textContent === 'Login';
                showAuthModal(!isLogin);
            });
        }

        function showAuthModal(isLogin) {
            document.getElementById('authModalTitle').textContent = isLogin ? 'Login' : 'Create Account';
            document.getElementById('auth-submit-btn').textContent = isLogin ? 'Login' : 'Create Account';
            document.getElementById('switch-auth-mode').textContent = isLogin ? 'Create account' : 'Already have an account?';
            document.getElementById('auth-error').classList.add('d-none');
            document.getElementById('auth-form').reset();
            authModal.show();
        }

        async function checkAdminStatus(uid) {
            const snapshot = await db.ref(`users/${uid}/role`).once('value');
            isAdmin = snapshot.val() === 'admin';
            updateAuthUI();
        }

        function updateAuthUI() {
            if (currentUser) {
                authStatus.innerHTML = `
                    <span class="me-2">Welcome, ${currentUser.email.split('@')[0]}</span>
                    ${isAdmin ? '<span class="badge bg-danger me-2">Admin</span>' : ''}
                    <button id="logout-btn" class="btn btn-outline-danger btn-sm">Logout</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    auth.signOut();
                    toastr.info('Logged out successfully');
                });

                document.getElementById('create-page-item').style.display = 'block';
                if (isAdmin) {
                    document.getElementById('admin-dash-item').style.display = 'block';
                } else {
                    document.getElementById('admin-dash-item').style.display = 'none';
                }
            } else {
                authStatus.innerHTML = `
                    <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                    <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                `;
                document.getElementById('create-page-item').style.display = 'none';
                document.getElementById('admin-dash-item').style.display = 'none';
            }
        }

        // UI Setup
        function setupUI() {
            // Sidebar toggle for mobile
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('show');
            });

            // Navigation links
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.target.closest('[data-page]').getAttribute('data-page');
                    loadPage(page);
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('show');
                    }
                });
            });

            // Search functionality
            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('search-input').value.trim();
                if (query) {
                    searchPages(query);
                }
            });

            // Initialize markdown editor
            simpleMDE = new SimpleMDE({
                element: document.getElementById('edit-content'),
                spellChecker: false,
                status: false
            });

            // Edit form submission
            document.getElementById('edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    toastr.error('You must be logged in to edit pages');
                    return;
                }

                const pageData = {
                    title: document.getElementById('edit-title').value.trim(),
                    lead: document.getElementById('edit-lead').value.trim(),
                    content: simpleMDE.value(),
                    categories: Array.from(document.getElementById('edit-categories').selectedOptions)
                        .map(opt => opt.value),
                    lastEdited: {
                        by: currentUser.uid,
                        name: currentUser.email.split('@')[0],
                        at: firebase.database.ServerValue.TIMESTAMP
                    },
                    summary: document.getElementById('edit-summary').value.trim()
                };

                try {
                    const pageId = generatePageId(pageData.title);
                    await db.ref(`pages/${pageId}`).set(pageData);
                    
                    // Record revision
                    await db.ref(`revisions/${pageId}_${Date.now()}`).set({
                        ...pageData,
                        editor: currentUser.uid,
                        status: isAdmin ? 'approved' : 'pending'
                    });
                    
                    editorModal.hide();
                    toastr.success('Page saved successfully');
                    loadPage(pageId);
                } catch (error) {
                    toastr.error('Error saving page: ' + error.message);
                }
            });
        }

        // Page loading
        function loadPage(page) {
            currentPage = page;
            loadingSpinner.style.display = 'block';
            contentArea.innerHTML = '';
            
            // Handle special pages
            if (page === 'home') {
                loadHomePage();
            } else if (page === 'recent') {
                loadRecentChanges();
            } else if (page === 'random') {
                loadRandomPage();
            } else if (page === 'create') {
                showEditor();
            } else if (page === 'admin') {
                loadAdminDashboard();
            } else if (page.startsWith('category:')) {
                const category = page.split(':')[1];
                loadCategoryPages(category);
            } else {
                loadWikiPage(page);
            }
        }

        function loadHomePage() {
            let html = `
                <h1>Welcome to Minnesota Then</h1>
                <p class="lead">A community-powered history wiki</p>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Featured Article</h5>
                                <div id="featured-article"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Recent Changes</h5>
                                <div id="recent-changes-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentArea.innerHTML = html;
            loadingSpinner.style.display = 'none';
            
            // Load featured article
            db.ref('pages').orderByChild('featured').equalTo(true).limitToFirst(1).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const pageId = Object.keys(snapshot.val())[0];
                    const page = snapshot.val()[pageId];
                    document.getElementById('featured-article').innerHTML = `
                        <h3><a href="#" data-page="${pageId}" class="text-decoration-none">${page.title}</a></h3>
                        <p>${page.lead || ''}</p>
                    `;
                } else {
                    document.getElementById('featured-article').innerHTML = '<p>No featured article yet</p>';
                }
            });
            
            // Load recent changes
            db.ref('revisions').orderByChild('lastEdited/at').limitToLast(5).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    let changesHtml = '<ul class="list-group list-group-flush">';
                    snapshot.forEach(child => {
                        const rev = child.val();
                        changesHtml += `
                            <li class="list-group-item">
                                <a href="#" data-page="${generatePageId(rev.title)}">${rev.title}</a>
                                <small class="text-muted d-block">
                                    Edited by ${rev.lastEdited.name} 
                                    ${formatDate(rev.lastEdited.at)}
                                </small>
                            </li>
                        `;
                    });
                    changesHtml += '</ul>';
                    document.getElementById('recent-changes-list').innerHTML = changesHtml;
                } else {
                    document.getElementById('recent-changes-list').innerHTML = '<p>No recent changes</p>';
                }
            });
        }

        function loadWikiPage(pageId) {
            db.ref(`pages/${pageId}`).once('value').then(snapshot => {
                loadingSpinner.style.display = 'none';
                
                if (snapshot.exists()) {
                    const page = snapshot.val();
                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1>${page.title}</h1>
                            ${currentUser ? `
                                <button class="btn btn-sm btn-outline-primary" id="edit-page-btn">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            ` : ''}
                        </div>
                        ${page.lead ? `<p class="lead">${page.lead}</p>` : ''}
                        <div class="wiki-content">${markdownToHtml(page.content || '')}</div>
                        <div class="mt-4 pt-3 border-top">
                            <small class="text-muted">
                                Last edited by ${page.lastEdited.name} 
                                on ${formatDate(page.lastEdited.at)}
                            </small>
                        </div>
                    `;
                    
                    contentArea.innerHTML = html;
                    
                    // Add edit button handler
                    if (currentUser) {
                        document.getElementById('edit-page-btn').addEventListener('click', () => {
                            showEditor(pageId);
                        });
                    }
                } else {
                    contentArea.innerHTML = `
                        <h1>Page Not Found</h1>
                        <p>The page "${pageId}" doesn't exist yet.</p>
                        ${currentUser ? `
                            <button class="btn btn-primary" id="create-page-btn">Create this page</button>
                        ` : `
                            <p><a href="#" data-page="create">Log in</a> to create this page.</p>
                        `}
                    `;
                    
                    if (currentUser) {
                        document.getElementById('create-page-btn').addEventListener('click', () => {
                            showEditor(pageId);
                        });
                    }
                }
            });
        }

        function loadRecentChanges() {
            db.ref('revisions').orderByChild('lastEdited/at').limitToLast(20).once('value').then(snapshot => {
                loadingSpinner.style.display = 'none';
                
                if (snapshot.exists()) {
                    let html = '<h1>Recent Changes</h1><ul class="list-group">';
                    snapshot.forEach(child => {
                        const rev = child.val();
                        html += `
                            <li class="list-group-item">
                                <a href="#" data-page="${generatePageId(rev.title)}">${rev.title}</a>
                                <div class="text-muted small">
                                    Edited by ${rev.lastEdited.name} 
                                    ${formatDate(rev.lastEdited.at)}
                                    ${rev.summary ? `(${rev.summary})` : ''}
                                </div>
                                ${isAdmin && rev.status === 'pending' ? `
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-success approve-btn" data-rev="${child.key}">
                                            Approve
                                        </button>
                                        <button class="btn btn-sm btn-danger reject-btn" data-rev="${child.key}">
                                            Reject
                                        </button>
                                    </div>
                                ` : ''}
                            </li>
                        `;
                    });
                    html += '</ul>';
                    contentArea.innerHTML = html;
                    
                    // Add approve/reject handlers
                    if (isAdmin) {
                        document.querySelectorAll('.approve-btn').forEach(btn => {
                            btn.addEventListener('click', () => approveRevision(btn.dataset.rev));
                        });
                        document.querySelectorAll('.reject-btn').forEach(btn => {
                            btn.addEventListener('click', () => rejectRevision(btn.dataset.rev));
                        });
                    }
                } else {
                    contentArea.innerHTML = '<h1>Recent Changes</h1><p>No changes yet.</p>';
                }
            });
        }

        function loadRandomPage() {
            db.ref('pages').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const pages = snapshot.val();
                    const pageIds = Object.keys(pages);
                    const randomPage = pageIds[Math.floor(Math.random() * pageIds.length)];
                    loadPage(randomPage);
                } else {
                    contentArea.innerHTML = '<h1>Random Article</h1><p>No articles yet.</p>';
                    loadingSpinner.style.display = 'none';
                }
            });
        }

        function loadCategoryPages(category) {
            db.ref('pages').orderByChild('categories').once('value').then(snapshot => {
                loadingSpinner.style.display = 'none';
                
                if (snapshot.exists()) {
                    let html = `<h1>${capitalizeFirstLetter(category)} Articles</h1><ul class="list-group">`;
                    let found = false;
                    
                    snapshot.forEach(child => {
                        const page = child.val();
                        if (page.categories && page.categories.includes(category)) {
                            found = true;
                            html += `
                                <li class="list-group-item">
                                    <a href="#" data-page="${generatePageId(page.title)}">${page.title}</a>
                                    <div class="text-muted small">${page.lead || ''}</div>
                                </li>
                            `;
                        }
                    });
                    
                    html += '</ul>';
                    contentArea.innerHTML = found ? html : `<h1>${capitalizeFirstLetter(category)} Articles</h1><p>No articles in this category yet.</p>`;
                } else {
                    contentArea.innerHTML = `<h1>${capitalizeFirstLetter(category)} Articles</h1><p>No articles yet.</p>`;
                }
            });
        }

        function loadAdminDashboard() {
            if (!isAdmin) {
                contentArea.innerHTML = '<h1>Access Denied</h1><p>You must be an admin to view this page.</p>';
                loadingSpinner.style.display = 'none';
                return;
            }
            
            contentArea.innerHTML = `
                <h1>Admin Dashboard</h1>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Pending Approvals</h5>
                                <div id="pending-approvals"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">User Management</h5>
                                <div id="user-management"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadingSpinner.style.display = 'none';
            
            // Load pending approvals
            db.ref('revisions').orderByChild('status').equalTo('pending').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    let html = '<ul class="list-group list-group-flush">';
                    snapshot.forEach(child => {
                        const rev = child.val();
                        html += `
                            <li class="list-group-item">
                                <a href="#" data-page="${generatePageId(rev.title)}">${rev.title}</a>
                                <div class="text-muted small">
                                    Edited by ${rev.lastEdited.name} 
                                    ${formatDate(rev.lastEdited.at)}
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-success approve-btn" data-rev="${child.key}">
                                        Approve
                                    </button>
                                    <button class="btn btn-sm btn-danger reject-btn" data-rev="${child.key}">
                                        Reject
                                    </button>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    document.getElementById('pending-approvals').innerHTML = html;
                    
                    // Add button handlers
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', () => approveRevision(btn.dataset.rev));
                    });
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', () => rejectRevision(btn.dataset.rev));
                    });
                } else {
                    document.getElementById('pending-approvals').innerHTML = '<p>No pending approvals</p>';
                }
            });
            
            // Load users
            db.ref('users').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    let html = '<ul class="list-group list-group-flush">';
                    snapshot.forEach(child => {
                        const user = child.val();
                        html += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    ${user.displayName || user.email}
                                    <div class="text-muted small">${user.role}</div>
                                </div>
                                <div>
                                    ${user.role !== 'admin' ? `
                                        <button class="btn btn-sm btn-outline-success make-admin-btn" data-uid="${child.key}">
                                            Make Admin
                                        </button>
                                    ` : ''}
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    document.getElementById('user-management').innerHTML = html;
                    
                    // Add make admin handlers
                    document.querySelectorAll('.make-admin-btn').forEach(btn => {
                        btn.addEventListener('click', () => makeAdmin(btn.dataset.uid));
                    });
                } else {
                    document.getElementById('user-management').innerHTML = '<p>No users</p>';
                }
            });
        }

        function showEditor(pageId = null) {
            if (!currentUser) {
                toastr.error('You must be logged in to edit pages');
                return;
            }
            
            // Reset form
            document.getElementById('edit-form').reset();
            simpleMDE.value('');
            
            if (pageId) {
                // Editing existing page
                db.ref(`pages/${pageId}`).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const page = snapshot.val();
                        document.getElementById('edit-title').value = page.title;
                        document.getElementById('edit-lead').value = page.lead || '';
                        simpleMDE.value(page.content || '');
                        
                        // Set categories
                        if (page.categories) {
                            const select = document.getElementById('edit-categories');
                            Array.from(select.options).forEach(opt => {
                                opt.selected = page.categories.includes(opt.value);
                            });
                        }
                    } else {
                        // New page - set title from URL
                        document.getElementById('edit-title').value = pageId.replace(/-/g, ' ');
                    }
                    editorModal.show();
                });
            } else {
                // Creating new page
                editorModal.show();
            }
        }

        async function approveRevision(revId) {
            try {
                // Get revision data
                const snapshot = await db.ref(`revisions/${revId}`).once('value');
                const rev = snapshot.val();
                
                // Update page with revision
                const pageId = generatePageId(rev.title);
                await db.ref(`pages/${pageId}`).set({
                    title: rev.title,
                    lead: rev.lead,
                    content: rev.content,
                    categories: rev.categories,
                    lastEdited: rev.lastEdited
                });
                
                // Update revision status
                await db.ref(`revisions/${revId}/status`).set('approved');
                
                toastr.success('Revision approved');
                loadPage(currentPage); // Refresh current view
            } catch (error) {
                toastr.error('Error approving revision: ' + error.message);
            }
        }

        async function rejectRevision(revId) {
            try {
                // Update revision status
                await db.ref(`revisions/${revId}/status`).set('rejected');
                toastr.success('Revision rejected');
                loadPage(currentPage); // Refresh current view
            } catch (error) {
                toastr.error('Error rejecting revision: ' + error.message);
            }
        }

        async function makeAdmin(uid) {
            try {
                await db.ref(`users/${uid}/role`).set('admin');
                toastr.success('User promoted to admin');
                loadPage('admin'); // Refresh admin dashboard
            } catch (error) {
                toastr.error('Error making user admin: ' + error.message);
            }
        }

        function searchPages(query) {
            db.ref('pages').once('value').then(snapshot => {
                loadingSpinner.style.display = 'none';
                
                if (snapshot.exists()) {
                    const pages = snapshot.val();
                    const results = Object.entries(pages)
                        .filter(([id, page]) => 
                            page.title.toLowerCase().includes(query.toLowerCase()) || 
                            (page.lead && page.lead.toLowerCase().includes(query.toLowerCase()))
                        .map(([id, page]) => ({ id, ...page }));
                    
                    if (results.length > 0) {
                        let html = `
                            <h1>Search Results for "${query}"</h1>
                            <ul class="list-group">
                        `;
                        
                        results.forEach(page => {
                            html += `
                                <li class="list-group-item">
                                    <a href="#" data-page="${page.id}">${page.title}</a>
                                    <div class="text-muted small">${page.lead || ''}</div>
                                </li>
                            `;
                        });
                        
                        html += '</ul>';
                        contentArea.innerHTML = html;
                    } else {
                        contentArea.innerHTML = `<h1>Search Results</h1><p>No results found for "${query}"</p>`;
                    }
                } else {
                    contentArea.innerHTML = `<h1>Search Results</h1><p>No pages yet.</p>`;
                }
            });
        }

        // Helper functions
        function generatePageId(title) {
            return title.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }

        function markdownToHtml(markdown) {
            // Basic markdown conversion
            if (!markdown) return '';
            
            // Headers
            let html = markdown
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>');
            
            // Bold and italic
            html = html
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Links
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Lists
            html = html.replace(/^\* (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            // Paragraphs
            html = html.replace(/^(?!<[a-z])(.*$)/gm, '<p>$1</p>');
            
            return html;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString();
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
