<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Minnesota Then - A Community History Wiki</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Primary palette */
            --primary-50: #EFF6FF;
            --primary-100: #DBEAFE;
            --primary-200: #BFDBFE;
            --primary-300: #93C5FD;
            --primary-400: #60A5FA;
            --primary-500: #3B82F6;
            --primary-600: #2563EB;
            --primary-700: #1D4ED8;
            --primary-800: #1E40AF;
            --primary-900: #1E3A8A;
            
            /* Secondary palette */
            --secondary-50: #EEF2FF;
            --secondary-100: #E0E7FF;
            --secondary-200: #C7D2FE;
            --secondary-300: #A5B4FC;
            --secondary-400: #818CF8;
            --secondary-500: #6366F1;
            --secondary-600: #4F46E5;
            --secondary-700: #4338CA;
            --secondary-800: #3730A3;
            --secondary-900: #312E81;
            
            /* Neutral palette */
            --neutral-50: #F9FAFB;
            --neutral-100: #F3F4F6;
            --neutral-200: #E5E7EB;
            --neutral-300: #D1D5DB;
            --neutral-400: #9CA3AF;
            --neutral-500: #6B7280;
            --neutral-600: #4B5563;
            --neutral-700: #374151;
            --neutral-800: #1F2937;
            --neutral-900: #111827;
            
            /* Status colors */
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            
            /* Legacy wiki variables for backward compatibility */
            --wiki-bg: var(--neutral-50);
            --wiki-text: var(--neutral-900);
            --wiki-link: var(--primary-600);
            --wiki-link-visited: var(--primary-800);
            --wiki-link-new: var(--error);
            --wiki-border: var(--neutral-300);
            --wiki-header: var(--neutral-100);
            --wiki-sidebar: var(--neutral-100);
            --wiki-blue: var(--primary-600);
            --wiki-gray: var(--neutral-500);
            
            /* Spacing system (8px increments) */
            --space-1: 0.25rem; /* 4px */
            --space-2: 0.5rem;  /* 8px */
            --space-3: 0.75rem; /* 12px */
            --space-4: 1rem;    /* 16px */
            --space-5: 1.25rem; /* 20px */
            --space-6: 1.5rem;  /* 24px */
            --space-8: 2rem;    /* 32px */
            --space-10: 2.5rem; /* 40px */
            --space-12: 3rem;   /* 48px */
            --space-16: 4rem;   /* 64px */
            
            /* Typography */
            --font-heading: 'EB Garamond', Georgia, Times, serif;
            --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            
            /* Animation */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--wiki-bg);
            color: var(--wiki-text);
            line-height: 1.6;
            font-size: 14px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            line-height: 1.2;
        }

        /* Wikipedia-style header */
        .wiki-header {
            background-color: var(--wiki-header);
            border-bottom: 1px solid var(--wiki-border);
            padding: var(--space-2) 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            transition: box-shadow var(--transition-normal);
        }

        .wiki-header.scrolled {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .wiki-title {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            color: var(--wiki-text);
            font-weight: normal;
            margin: 0;
            transition: color var(--transition-fast);
        }

        .wiki-title:hover {
            color: var(--primary-600);
        }

        .wiki-subtitle {
            font-style: italic;
            color: var(--wiki-gray);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Wikipedia-style sidebar */
        .sidebar {
            background-color: var(--wiki-sidebar);
            border-right: 1px solid var(--wiki-border);
            padding: var(--space-2);
            min-height: calc(100vh - 80px);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .sidebar h5 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--wiki-text);
            margin: var(--space-4) 0 var(--space-2) 0;
            padding: var(--space-1) var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
        }

        .sidebar .nav-link {
            color: var(--wiki-link);
            padding: var(--space-1) var(--space-2);
            font-size: 0.85rem;
            border-radius: 4px;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .sidebar .nav-link:hover {
            color: var(--wiki-link);
            background-color: var(--primary-50);
            text-decoration: underline;
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-100);
            color: var(--primary-800);
            font-weight: 500;
        }

        /* Mobile sidebar toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary-600);
            color: white;
            border: none;
            z-index: 1100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform var(--transition-fast), background-color var(--transition-fast);
        }

        .sidebar-toggle:hover {
            background-color: var(--primary-700);
            transform: translateY(-2px);
        }

        /* Main content area */
        .content-area {
            background-color: var(--wiki-bg);
            padding: var(--space-4) var(--space-6);
            min-height: calc(100vh - 80px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0.8; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Wikipedia-style page title */
        #page-title {
            font-family: var(--font-heading);
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--wiki-text);
            margin-bottom: var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: var(--space-1);
        }

        /* Page metadata */
        .content-meta {
            font-size: 0.8rem;
            color: var(--wiki-gray);
            margin-bottom: var(--space-4);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--neutral-200);
        }

        /* Wikipedia-style tabs */
        .page-tabs {
            border-bottom: 1px solid var(--wiki-border);
            margin-bottom: var(--space-4);
        }

        .page-tabs .nav-link {
            border: 1px solid transparent;
            border-bottom: none;
            background-color: var(--wiki-header);
            color: var(--wiki-link);
            font-size: 0.85rem;
            padding: var(--space-2) var(--space-4);
            margin-right: var(--space-1);
            border-radius: 4px 4px 0 0;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .page-tabs .nav-link:hover {
            background-color: #fff;
            text-decoration: underline;
        }

        .page-tabs .nav-link.active {
            background-color: #fff;
            border-color: var(--wiki-border);
            color: var(--wiki-text);
            font-weight: 500;
        }

        /* Table of Contents */
        .toc {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            width: fit-content;
            float: right;
            max-width: 300px;
            font-size: 0.9rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .toc-title {
            font-weight: 600;
            margin-bottom: var(--space-2);
            text-align: center;
            color: var(--neutral-700);
        }

        .toc ul {
            list-style-type: none;
            padding-left: var(--space-4);
            margin: 0;
        }

        .toc li {
            margin: var(--space-1) 0;
        }

        .toc a {
            color: var(--wiki-link);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .toc a:hover {
            text-decoration: underline;
            color: var(--primary-700);
        }

        /* Wikipedia-style sections */
        .wiki-section {
            margin-bottom: var(--space-8);
            clear: both;
        }

        .wiki-section h2 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 500;
            border-bottom: 1px solid var(--wiki-border);
            padding-bottom: var(--space-1);
            margin-top: var(--space-8);
            margin-bottom: var(--space-4);
            color: var(--neutral-800);
        }

        .wiki-section h3 {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: var(--space-6);
            margin-bottom: var(--space-2);
            color: var(--neutral-800);
        }

        /* Links */
        a {
            color: var(--wiki-link);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            text-decoration: underline;
        }

        a:visited {
            color: var(--wiki-link-visited);
        }

        .new-page-link {
            color: var(--wiki-link-new);
        }

        /* Search box */
        .search-container {
            margin: var(--space-4) 0;
        }

        .search-container input {
            font-size: 0.85rem;
            border: 1px solid var(--wiki-border);
            border-radius: 4px 0 0 4px;
            padding: var(--space-2);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .search-container input:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px var(--primary-100);
            outline: none;
        }

        .search-container button {
            font-size: 0.85rem;
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            border-left: none;
            color: var(--wiki-text);
            border-radius: 0 4px 4px 0;
            padding: var(--space-2) var(--space-3);
            transition: background-color var(--transition-fast);
        }

        .search-container button:hover {
            background-color: var(--neutral-200);
        }

        /* Edit toolbar */
        .edit-toolbar {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-2);
            margin-bottom: var(--space-4);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .edit-toolbar button {
            margin-right: var(--space-2);
            font-size: 0.8rem;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
        }

        .edit-toolbar button:hover {
            transform: translateY(-1px);
        }

        /* References */
        .references {
            font-size: 0.85rem;
            border-top: 1px solid var(--wiki-border);
            margin-top: var(--space-8);
            padding-top: var(--space-4);
        }

        .reference {
            color: var(--wiki-link);
            font-size: 0.75rem;
            text-decoration: none;
        }

        /* Infobox styling */
        .infobox {
            background-color: var(--wiki-header);
            border: 1px solid var(--wiki-border);
            padding: var(--space-4);
            margin: 0 0 var(--space-4) var(--space-4);
            width: 300px;
            float: right;
            font-size: 0.9rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .infobox-title {
            font-weight: 600;
            text-align: center;
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--wiki-border);
            color: var(--neutral-700);
        }

        /* Notices and status boxes */
        .notice-box {
            background-color: var(--primary-50);
            border: 1px solid var(--primary-200);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            border-radius: 4px;
            animation: fadeIn 0.4s ease;
        }

        .approval-pending {
            background-color: var(--warning-50);
            border: 1px solid var(--warning-200);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-radius: 4px;
        }

        /* Success message */
        .success-message {
            background-color: var(--success-50);
            border: 1px solid var(--success-200);
            color: var(--success-700);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border-radius: 4px;
            display: none;
            animation: fadeIn 0.4s ease;
        }

        /* Footer */
        .wiki-footer {
            background-color: var(--wiki-header);
            border-top: 1px solid var(--wiki-border);
            padding: var(--space-8) 0;
            margin-top: var(--space-12);
            font-size: 0.8rem;
        }

        .wiki-footer h5 {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--neutral-700);
        }

        .wiki-footer a {
            color: var(--primary-600);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .wiki-footer a:hover {
            color: var(--primary-800);
            text-decoration: underline;
        }

        /* Auth status */
        #auth-status {
            font-size: 0.85rem;
        }

        .user-greeting {
            color: var(--neutral-700);
            font-weight: 500;
        }

        /* Modal customizations */
        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .modal-header {
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-4) var(--space-6);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            border-top: 1px solid var(--neutral-200);
            padding: var(--space-4) var(--space-6);
        }

        /* Form controls */
        .form-control:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        /* Button customizations */
        .btn-primary {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
            transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .btn-primary:hover {
            background-color: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-outline-primary {
            border-color: var(--primary-600);
            color: var(--primary-600);
            transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-50);
            color: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
        }

        /* Contributor badge */
        .contributor-badge {
            font-size: 0.7rem;
            background-color: var(--primary-100);
            color: var(--primary-800);
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: var(--space-2);
            vertical-align: middle;
            font-weight: 500;
        }

        .contributor-badge.admin {
            background-color: var(--secondary-100);
            color: var(--secondary-800);
        }

        /* Loading spinner */
        .loading-spinner {
            display: none;
            margin: var(--space-8) auto;
            text-align: center;
        }

        .spinner-border {
            color: var(--primary-500);
            width: 3rem;
            height: 3rem;
        }

        /* Edit history styles */
        .history-item {
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--space-3) 0;
            transition: background-color var(--transition-fast);
        }

        .history-item:hover {
            background-color: var(--neutral-50);
        }

        .history-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .history-badge.minor {
            background-color: var(--neutral-100);
            color: var(--neutral-700);
        }

        .history-badge.major {
            background-color: var(--primary-100);
            color: var(--primary-700);
        }

        /* Responsive design */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 80px;
                width: 280px;
                z-index: 1200;
                bottom: 0;
                box-shadow: none;
                transition: left var(--transition-normal), box-shadow var(--transition-normal);
            }
            
            .sidebar.show {
                left: 0;
                box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .content-area {
                padding: var(--space-4);
            }
            
            .wiki-title {
                font-size: 1.6rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                top: 70px;
            }
            
            .toc {
                float: none;
                width: 100%;
                max-width: none;
                margin: var(--space-4) 0;
            }
            
            .infobox {
                float: none;
                width: 100%;
                margin: var(--space-4) 0;
            }
            
            .wiki-title {
                font-size: 1.5rem;
                text-align: center;
            }
            
            #page-title {
                font-size: 1.8rem;
            }
            
            .page-tabs .nav-link {
                padding: var(--space-2);
            }
            
            #auth-status {
                justify-content: center !important;
                margin-top: var(--space-2);
            }
        }

        @media (max-width: 576px) {
            .wiki-title {
                font-size: 1.3rem;
            }
            
            .wiki-subtitle {
                font-size: 0.75rem;
            }
            
            #page-title {
                font-size: 1.6rem;
            }
            
            .page-tabs .nav-link {
                font-size: 0.8rem;
                padding: var(--space-1) var(--space-2);
            }
            
            .content-area {
                padding: var(--space-3);
            }
            
            .edit-toolbar button {
                padding: var(--space-1) var(--space-2);
                margin-bottom: var(--space-2);
                font-size: 0.75rem;
            }
        }

        /* Print styles */
        @media print {
            .sidebar, .wiki-header, .wiki-footer, .edit-toolbar, #auth-status, .page-tabs {
                display: none !important;
            }
            
            .content-area {
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            body {
                font-size: 12pt;
                line-height: 1.4;
            }
            
            #page-title {
                font-size: 24pt;
                border-bottom: 1pt solid #000;
                margin-bottom: 12pt;
            }
            
            .wiki-section h2 {
                font-size: 18pt;
                border-bottom: 0.5pt solid #000;
                margin: 16pt 0 8pt 0;
                page-break-after: avoid;
            }
            
            .wiki-section h3 {
                font-size: 14pt;
                margin: 12pt 0 6pt 0;
                page-break-after: avoid;
            }
            
            a {
                color: #000;
                text-decoration: none;
            }
            
            a::after {
                content: " (" attr(href) ")";
                font-size: 90%;
                color: #333;
            }
            
            .toc, .infobox {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <header class="wiki-header" id="wikiHeader">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-8 col-md-6">
                    <a href="/" class="text-decoration-none">
                        <h1 class="wiki-title">Minnesota Then</h1>
                        <p class="wiki-subtitle">A Community History Wiki</p>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div id="auth-status" class="d-flex justify-content-end">
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">Log in</button>
                        <button id="signup-btn" class="btn btn-primary btn-sm">Create account</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid">
        <div class="row">
            <div class="col-lg-2 col-md-3 p-0">
                <div class="sidebar" id="sidebar">
                    <h5>Navigation</h5>
                    <ul class="nav flex-column" id="sidebar-nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="home">Main page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="recent-changes">Recent changes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="random-page">Random article</a>
                        </li>
                    </ul>

                    <h5>Topics</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="landmarks">Historic Landmarks</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="people">Notable People</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="events">Historic Events</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="indigenous">Indigenous History</a>
                        </li>
                    </ul>

                    <h5>Tools</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="help">Help</a>
                        </li>
                        <li class="nav-item" id="create-page-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="create-page">Create a page</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="special-pages">Special pages</a>
                        </li>
                        <li class="nav-item" id="my-contributions-item" style="display: none;">
                            <a class="nav-link" href="#" data-page="my-contributions">My contributions</a>
                        </li>
                    </ul>

                    <div class="search-container">
                        <h5>Search</h5>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="search-input" placeholder="Search Minnesota Then">
                            <button class="btn btn-outline-secondary" id="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <div class="col-lg-10 col-md-9">
                <div class="content-area">
                    <!-- Page tabs (Wikipedia-style) -->
                    <ul class="nav nav-tabs page-tabs" id="page-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-tab="article">Article</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="discussion">Discussion</a>
                        </li>
                        <li class="nav-item" id="edit-tab" style="display: none;">
                            <a class="nav-link" href="#" data-tab="edit">Edit</a>
                        </li>
                        <li class="nav-item" id="history-tab">
                            <a class="nav-link" href="#" data-tab="history">View history</a>
                        </li>
                    </ul>

                    <!-- Success Message -->
                    <div class="success-message" id="success-message">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="success-text">Your changes have been saved successfully!</span>
                    </div>

                    <div id="page-header">
                        <h1 id="page-title">Welcome to Minnesota Then</h1>
                        <div class="content-meta" id="page-meta">
                            <span id="page-info"></span>
                            <span id="page-actions" class="float-end"></span>
                        </div>
                    </div>

                    <!-- Loading spinner -->
                    <div id="loading-spinner" class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading content...</p>
                    </div>

                    <div id="page-content">
                        <div class="toc" id="toc">
                            <div class="toc-title">Contents</div>
                            <ul>
                                <li>1 <a href="#introduction">Introduction</a></li>
                                <li>2 <a href="#getting-started">Getting started</a></li>
                                <li>3 <a href="#featured">Featured articles</a></li>
                                <li>4 <a href="#community">Community</a></li>
                            </ul>
                        </div>

                        <section id="introduction" class="wiki-section">
                            <h2>Introduction</h2>
                            <p>Welcome to <strong>Minnesota Then</strong>, a community-driven historical wiki dedicated to preserving and sharing the rich history of Minnesota. Our goal is to create a comprehensive resource that documents the people, places, events, and stories that have shaped our state from its earliest inhabitants to the present day.</p>
                            
                            <p>This wiki serves as a collaborative platform where historians, researchers, students, and anyone with an interest in Minnesota's past can contribute their knowledge and discoveries. Whether you're researching your family history, exploring local landmarks, or studying significant historical events, Minnesota Then provides a reliable and comprehensive resource.</p>
                        </section>

                        <section id="getting-started" class="wiki-section">
                            <h2>Getting started</h2>
                            <p>Contributing to Minnesota Then is easy and rewarding:</p>
                            <ul>
                                <li><strong>Create an account</strong> to start contributing to articles</li>
                                <li><strong>Browse existing articles</strong> to get familiar with our style and standards</li>
                                <li><strong>Add new content</strong> or improve existing articles with additional information</li>
                                <li><strong>Cite your sources</strong> to maintain the reliability of information</li>
                                <li><strong>Follow our guidelines</strong> for writing neutral, encyclopedic content</li>
                            </ul>
                            
                            <div class="notice-box">
                                <strong>Note:</strong> All contributions are reviewed by our community of editors before publication to ensure accuracy and quality.
                            </div>
                        </section>

                        <section id="featured" class="wiki-section">
                            <h2>Featured articles</h2>
                            <p>Explore some of our comprehensive, well-researched articles:</p>
                            <div id="featured-articles">
                                <p><em>Loading featured articles...</em></p>
                            </div>
                        </section>

                        <section id="community" class="wiki-section">
                            <h2>Community</h2>
                            <p>Minnesota Then is built and maintained by a community of volunteers who share a passion for Minnesota history. Join us in preserving the stories that make our state unique.</p>
                            
                            <h3>How to help</h3>
                            <ul>
                                <li>Add articles about your local community</li>
                                <li>Upload historical photographs and documents</li>
                                <li>Improve existing articles with additional sources</li>
                                <li>Help with proofreading and fact-checking</li>
                                <li>Share your expertise on specific topics or time periods</li>
                            </ul>
                        </section>
                    </div>

                    <div id="edit-section" class="mt-4" style="display: none;">
                        <div class="edit-toolbar">
                            <strong>Editing tools:</strong>
                            <button class="btn btn-sm btn-outline-secondary" data-format="header">
                                <i class="fas fa-heading me-1"></i> Heading
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="bold">
                                <i class="fas fa-bold me-1"></i> Bold
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="italic">
                                <i class="fas fa-italic me-1"></i> Italic
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="link">
                                <i class="fas fa-link me-1"></i> Link
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="list">
                                <i class="fas fa-list me-1"></i> List
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="image">
                                <i class="fas fa-image me-1"></i> Image
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" data-format="reference">
                                <i class="fas fa-quote-right me-1"></i> Reference
                            </button>
                        </div>
                        <form id="edit-form">
                            <div class="mb-3">
                                <label for="edit-title" class="form-label">Article title</label>
                                <input type="text" class="form-control" id="edit-title" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-content" class="form-label">Content</label>
                                <textarea class="form-control" id="edit-content" rows="20" required placeholder="Write your article content here. Use wiki markup for formatting."></textarea>
                                <small class="form-text text-muted">Use == for headings, ** for bold, * for italic, and [[Link]] for internal links.</small>
                            </div>
                            <div class="mb-3">
                                <label for="edit-summary" class="form-label">Edit summary</label>
                                <input type="text" class="form-control" id="edit-summary" placeholder="Briefly describe your changes" maxlength="200">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="minor-edit">
                                <label class="form-check-label" for="minor-edit">
                                    This is a minor edit
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Save changes
                            </button>
                            <button type="button" class="btn btn-secondary" id="show-preview">
                                <i class="fas fa-eye me-1"></i> Show preview
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="cancel-edit">
                                <i class="fas fa-times me-1"></i> Cancel
                            </button>
                        </form>
                        
                        <div id="edit-preview" class="mt-3" style="display: none;">
                            <h4>Preview</h4>
                            <div class="border p-3" id="edit-preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="wiki-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h5>Minnesota Then</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="about">About Minnesota Then</a></li>
                        <li><a href="#" data-page="disclaimers">General disclaimer</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contribute</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="help">Help</a></li>
                        <li><a href="#" data-page="community-portal">Community portal</a></li>
                        <li><a href="#" data-page="recent-changes">Recent changes</a></li>
                        <li><a href="#" data-page="contact">Contact page</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Tools</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="special-pages">Special pages</a></li>
                        <li><a href="#" data-page="permanent-link">Permanent link</a></li>
                        <li><a href="#" data-page="page-information">Page information</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Legal</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" data-page="privacy">Privacy policy</a></li>
                        <li><a href="#" data-page="terms">Terms of use</a></li>
                        <li><small>Content is available under <a href="#" data-page="license">CC BY-SA 4.0</a></small></li>
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <small>&copy; 2025 Minnesota Then Community. Powered by community contributions.</small>
            </div>
        </div>
    </footer>

    <!-- Authentication Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">Log in</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="auth-form">
                        <div class="mb-3">
                            <label for="auth-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="auth-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="auth-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="auth-password" required>
                        </div>
                        <div id="auth-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary w-100" id="auth-submit-btn">Log in</button>
                    </form>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-link" id="switch-auth-mode">Create an account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal fade" id="imageUploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="image-upload-form">
                        <div class="mb-3">
                            <label for="image-file" class="form-label">Select Image</label>
                            <input type="file" class="form-control" id="image-file" accept="image/*" required>
                        </div>
                        <div class="mb-3">
                            <label for="image-title" class="form-label">Image Title</label>
                            <input type="text" class="form-control" id="image-title" placeholder="Descriptive title for the image" required>
                        </div>
                        <div class="mb-3">
                            <label for="image-description" class="form-label">Description</label>
                            <textarea class="form-control" id="image-description" rows="3" placeholder="Describe the image and provide attribution"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="image-source" class="form-label">Source</label>
                            <input type="text" class="form-control" id="image-source" placeholder="Original source of the image">
                        </div>
                        <div id="upload-error" class="alert alert-danger d-none"></div>
                        <div id="upload-progress" class="progress d-none mb-3">
                            <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="upload-submit-btn">Upload Image</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Discussion Modal -->
    <div class="modal fade" id="discussionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Start a discussion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="discussion-form">
                        <div class="mb-3">
                            <label for="discussion-topic" class="form-label">Topic</label>
                            <input type="text" class="form-control" id="discussion-topic" required>
                        </div>
                        <div class="mb-3">
                            <label for="discussion-content" class="form-label">Message</label>
                            <textarea class="form-control" id="discussion-content" rows="6" required></textarea>
                        </div>
                        <div id="discussion-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary">Post Discussion</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
   <script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
        authDomain: "mnthen-3151d.firebaseapp.com",
        databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com",
        projectId: "mnthen-3151d",
        storageBucket: "mnthen-3151d.appspot.com",
        messagingSenderId: "416231360428",
        appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
    };

    // Initialize Firebase
    let firebaseApp;
    if (!firebase.apps.length) {
        firebaseApp = firebase.initializeApp(firebaseConfig);
    } else {
        firebaseApp = firebase.app();
    }

    const auth = firebase.auth();
    const db = firebase.database(); // This is correctly initialized for Realtime Database
    const storage = firebase.storage();

    // Enhanced DOM Elements
    const wikiHeader = document.getElementById('wikiHeader');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const authStatus = document.getElementById('auth-status');
    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
    const authForm = document.getElementById('auth-form');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authModalTitle = document.getElementById('authModalTitle');
    const switchAuthMode = document.getElementById('switch-auth-mode');
    const authError = document.getElementById('auth-error');
    const pageTitle = document.getElementById('page-title');
    const pageContent = document.getElementById('page-content');
    const loadingSpinner = document.getElementById('loading-spinner');
    const pageInfo = document.getElementById('page-info');
    const pageActions = document.getElementById('page-actions');
    const editSection = document.getElementById('edit-section');
    const editForm = document.getElementById('edit-form');
    const editTitle = document.getElementById('edit-title');
    const editContent = document.getElementById('edit-content');
    const editPreview = document.getElementById('edit-preview');
    const editPreviewContent = document.getElementById('edit-preview-content');
    const editSummary = document.getElementById('edit-summary');
    const cancelEdit = document.getElementById('cancel-edit');
    const showPreview = document.getElementById('show-preview');
    const createPageItem = document.getElementById('create-page-item');
    const myContributionsItem = document.getElementById('my-contributions-item');
    const editTab = document.getElementById('edit-tab');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const sidebarNav = document.getElementById('sidebar-nav');
    const pageTabs = document.getElementById('page-tabs');
    const successMessage = document.getElementById('success-message');
    const successText = document.getElementById('success-text');
    const imageUploadModal = new bootstrap.Modal(document.getElementById('imageUploadModal'));
    const imageUploadForm = document.getElementById('image-upload-form');
    const discussionModal = new bootstrap.Modal(document.getElementById('discussionModal'));
    const discussionForm = document.getElementById('discussion-form');

    // State variables
    let isLoginMode = true;
    let currentPageId = 'home';
    let currentUser = null;
    let isEditing = false;
    let currentTab = 'article';
    let discussionTopics = [];
    let recentChanges = [];
    let isAdminUser = false;

    // Initialize the app
    function init() {
        setupAuth();
        setupNavigation();
        setupEditor();
        setupTabs();
        setupSidebarToggle();
        setupScrollEffects();
        loadPage(currentPageId);
        loadFeaturedArticles(); // You'll need to implement this for Realtime Database
    }

    // Scroll effects
    function setupScrollEffects() {
        window.addEventListener('scroll', function() {
            if (window.scrollY > 20) {
                wikiHeader.classList.add('scrolled');
            } else {
                wikiHeader.classList.remove('scrolled');
            }
        });
    }

    // Toggle sidebar on mobile
    function setupSidebarToggle() {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('show');

            // Change icon based on state
            const icon = this.querySelector('i');
            if (sidebar.classList.contains('show')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 992 &&
                !sidebar.contains(e.target) &&
                !sidebarToggle.contains(e.target) &&
                sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                const icon = sidebarToggle.querySelector('i');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
    }

    // Enhanced authentication
    function setupAuth() {
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // Check if user is admin in Realtime Database
                db.ref(`users/${user.uid}/role`).once('value').then(snapshot => {
                    if (snapshot.exists() && snapshot.val() === 'admin') {
                        isAdminUser = true;
                    } else {
                        isAdminUser = false;
                    }
                    updateAuthUI();
                    updatePageActions();
                }).catch(error => {
                    console.error("Error checking user role:", error);
                    isAdminUser = false;
                    updateAuthUI();
                    updatePageActions();
                });
            } else {
                isAdminUser = false;
                updateAuthUI();
                updatePageActions();
            }
        });

        loginBtn?.addEventListener('click', () => {
            isLoginMode = true;
            updateAuthModalUI();
            authModal.show();
        });

        signupBtn?.addEventListener('click', () => {
            isLoginMode = false;
            updateAuthModalUI();
            authModal.show();
        });

        switchAuthMode.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            updateAuthModalUI();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;

            authSubmitBtn.disabled = true;
            authSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    // Create user profile in Realtime Database
                    await db.ref(`users/${userCredential.user.uid}`).set({
                        email: email,
                        displayName: email.split('@')[0],
                        role: 'contributor',
                        joinDate: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                authModal.hide();
                showSuccessMessage(isLoginMode ? 'Successfully logged in!' : 'Account created successfully!');
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.remove('d-none');
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerHTML = isLoginMode ? 'Log in' : 'Create account';
            }
        });
    }

    function updateAuthModalUI() {
        authModalTitle.textContent = isLoginMode ? 'Log in' : 'Create account';
        authSubmitBtn.textContent = isLoginMode ? 'Log in' : 'Create account';
        switchAuthMode.textContent = isLoginMode ? 'Create an account' : 'Already have an account?';
        authForm.reset();
        authError.classList.add('d-none');
    }

    function updateAuthUI() {
        if (currentUser) {
            const displayName = currentUser.email.split('@')[0];
            const badgeClass = isAdminUser ? 'contributor-badge admin' : 'contributor-badge';
            const badgeText = isAdminUser ? 'Admin' : 'Contributor';

            authStatus.innerHTML = `
                <span class="user-greeting me-2">Welcome, ${displayName}</span>
                <span class="${badgeClass}">${badgeText}</span>
                <button id="logout-btn" class="btn btn-outline-primary btn-sm ms-2">
                    <i class="fas fa-sign-out-alt me-1"></i> Log out
                </button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            createPageItem.style.display = 'block';
            myContributionsItem.style.display = 'block';
            editTab.style.display = 'block';
        } else {
            authStatus.innerHTML = `
                <button id="login-btn" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-sign-in-alt me-1"></i> Log in
                </button>
                <button id="signup-btn" class="btn btn-primary btn-sm">
                    <i class="fas fa-user-plus me-1"></i> Create account
                </button>
            `;

            document.getElementById('login-btn').addEventListener('click', () => {
                isLoginMode = true;
                updateAuthModalUI();
                authModal.show();
            });
            document.getElementById('signup-btn').addEventListener('click', () => {
                isLoginMode = false;
                updateAuthModalUI();
                authModal.show();
            });
            createPageItem.style.display = 'none';
            myContributionsItem.style.display = 'none';
            editTab.style.display = 'none';
        }
    }

    // Enhanced navigation
    function setupNavigation() {
        document.addEventListener('click', (e) => {
            // Handle navigation links
            if (e.target.closest('[data-page]')) {
                e.preventDefault();
                const link = e.target.closest('[data-page]');
                const pageId = link.getAttribute('data-page');
                if (pageId) {
                    loadPage(pageId);
                    if (window.innerWidth <= 992) {
                        sidebar.classList.remove('show');
                        const icon = sidebarToggle.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                    updateActiveNavLink(link);
                }
            }
        });

        searchBtn.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                searchPages(searchTerm); // You'll need to implement this for Realtime Database
            }
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchPages(searchTerm); // You'll need to implement this for Realtime Database
                }
            }
        });
    }

    function updateActiveNavLink(activeLink) {
        // Remove active class from all nav links
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.classList.remove('active');
        });
        // Add active class to clicked link
        activeLink.classList.add('active');
    }

    // Tab system setup
    function setupTabs() {
        pageTabs.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.closest('[data-tab]')) {
                const link = e.target.closest('[data-tab]');
                const tabId = link.getAttribute('data-tab');
                if (tabId) {
                    switchTab(tabId);
                }
            }
        });
    }

    function switchTab(tabId) {
        currentTab = tabId;

        // Update tab appearance
        pageTabs.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

        // Show appropriate content
        switch (tabId) {
            case 'article':
                pageContent.style.display = 'block';
                editSection.style.display = 'none';
                loadingSpinner.style.display = 'none';
                break;
            case 'discussion':
                showDiscussion(); // You'll need to implement this for Realtime Database
                break;
            case 'edit':
                if (currentUser) {
                    startEditing();
                } else {
                    showLoginPrompt('Please log in to edit pages.');
                    switchTab('article');
                }
                break;
            case 'history':
                showHistory(); // You'll need to implement this for Realtime Database
                break;
        }
    }

    // Show success message
    function showSuccessMessage(message, duration = 4000) {
        successText.textContent = message;
        successMessage.style.display = 'block';

        // Hide message after duration
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, duration);
    }

    // Show login prompt
    function showLoginPrompt(message) {
        const prompt = confirm(`${message} Would you like to log in now?`);
        if (prompt) {
            isLoginMode = true;
            updateAuthModalUI();
            authModal.show();
        }
    }

    // Enhanced editor setup
    function setupEditor() {
        const toolbar = document.querySelector('.edit-toolbar');
        toolbar.addEventListener('click', (e) => {
            const button = e.target.closest('[data-format]');
            if (button) {
                const format = button.getAttribute('data-format');
                if (format === 'image') {
                    // Open image upload modal
                    imageUploadModal.show();
                } else {
                    insertFormat(format);
                }
            }
        });

        editContent.addEventListener('input', () => {
            updateLivePreview();
        });

        showPreview.addEventListener('click', () => {
            if (editPreview.style.display === 'none') {
                editPreview.style.display = 'block';
                showPreview.innerHTML = '<i class="fas fa-eye-slash me-1"></i> Hide preview';
                updatePreview();
            } else {
                editPreview.style.display = 'none';
                showPreview.innerHTML = '<i class="fas fa-eye me-1"></i> Show preview';
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showLoginPrompt('You must be logged in to edit pages.');
                return;
            }

            const title = editTitle.value.trim();
            const content = editContent.value.trim();
            const summary = editSummary.value.trim() || 'No edit summary provided';
            const isMinor = document.getElementById('minor-edit').checked;

            if (!title || !content) {
                alert('Please provide both a title and content.');
                return;
            }

            // Disable submit button and show loading state
            const submitBtn = editForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Saving...';

            try {
                await submitRevision(title, content, summary, isMinor);
                switchTab('article');
                editForm.reset();
                showSuccessMessage('Your changes have been submitted successfully!');
                loadPage(currentPageId);
            } catch (error) {
                console.error('Error submitting revision:', error);
                alert('There was an error submitting your changes. Please try again.');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save changes';
            }
        });

        cancelEdit.addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel editing? Your changes will be lost.')) {
                switchTab('article');
                editForm.reset();
            }
        });

        // Image upload functionality
        imageUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showLoginPrompt('You must be logged in to upload images.');
                return;
            }

            const fileInput = document.getElementById('image-file');
            const title = document.getElementById('image-title').value.trim();
            const description = document.getElementById('image-description').value.trim();
            const source = document.getElementById('image-source').value.trim();
            const uploadError = document.getElementById('upload-error');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadProgressBar = document.getElementById('upload-progress-bar');
            const uploadSubmitBtn = document.getElementById('upload-submit-btn');

            if (!fileInput.files.length || !title) {
                uploadError.textContent = 'Please provide both an image file and title.';
                uploadError.classList.remove('d-none');
                return;
            }

            const file = fileInput.files[0];
            const fileName = `${Date.now()}-${file.name}`;
            const storageRef = storage.ref(`images/${fileName}`);

            // Reset UI
            uploadError.classList.add('d-none');
            uploadProgress.classList.remove('d-none');
            uploadSubmitBtn.disabled = true;
            uploadSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Uploading...';

            try {
                // Upload file with progress tracking
                const uploadTask = storageRef.put(file);
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadProgressBar.style.width = `${progress}%`;
                    },
                    (error) => {
                        throw error;
                    }
                );

                // Wait for upload to complete
                await uploadTask;

                // Get download URL
                const downloadURL = await storageRef.getDownloadURL();

                // Store image metadata in Realtime Database
                const newImageRef = db.ref('images').push();
                await newImageRef.set({
                    title: title,
                    description: description,
                    source: source,
                    url: downloadURL,
                    fileName: fileName,
                    uploadedBy: currentUser.uid,
                    uploadedByEmail: currentUser.email,
                    uploadedAt: firebase.database.ServerValue.TIMESTAMP
                });

                // Insert image tag in editor
                const imageTag = `[[Image:${downloadURL}|${title}|${description || title}]]`;
                insertTextAtCursor(editContent, imageTag);

                // Close modal and reset form
                imageUploadModal.hide();
                imageUploadForm.reset();
                showSuccessMessage('Image uploaded successfully!');

                // Update preview if open
                updateLivePreview();
            } catch (error) {
                console.error('Error uploading image:', error);
                uploadError.textContent = `Error uploading image: ${error.message}`;
                uploadError.classList.remove('d-none');
            } finally {
                uploadProgress.classList.add('d-none');
                uploadSubmitBtn.disabled = false;
                uploadSubmitBtn.innerHTML = 'Upload Image';
            }
        });

        // Discussion form functionality
        discussionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showLoginPrompt('You must be logged in to start discussions.');
                return;
            }

            const topic = document.getElementById('discussion-topic').value.trim();
            const content = document.getElementById('discussion-content').value.trim();
            const discussionError = document.getElementById('discussion-error');
            const submitBtn = discussionForm.querySelector('button[type="submit"]');

            if (!topic || !content) {
                discussionError.textContent = 'Please provide both a topic and message.';
                discussionError.classList.remove('d-none');
                return;
            }

            // Disable submit button and show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Posting...';

            try {
                const newDiscussionRef = db.ref('discussions').push();
                await newDiscussionRef.set({
                    pageId: currentPageId,
                    topic: topic,
                    content: content,
                    author: currentUser.uid,
                    authorEmail: currentUser.email,
                    authorName: currentUser.email.split('@')[0],
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'open'
                });

                // Close modal and reset form
                discussionModal.hide();
                discussionForm.reset();
                showSuccessMessage('Discussion posted successfully!');

                // Refresh discussion tab
                if (currentTab === 'discussion') {
                    showDiscussion(); // You'll need to implement this for Realtime Database
                }
            } catch (error) {
                console.error('Error posting discussion:', error);
                discussionError.textContent = `Error posting discussion: ${error.message}`;
                discussionError.classList.remove('d-none');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Post Discussion';
            }
        });
    }

    function insertTextAtCursor(textarea, text) {
        const startPos = textarea.selectionStart;
        const endPos = textarea.selectionEnd;
        const scrollTop = textarea.scrollTop;

        textarea.value = textarea.value.substring(0, startPos) + text +
            textarea.value.substring(endPos, textarea.value.length);

        textarea.focus();
        textarea.selectionStart = startPos + text.length;
        textarea.selectionEnd = startPos + text.length;
        textarea.scrollTop = scrollTop;
    }

    function insertFormat(format) {
        const textarea = editContent;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        let replacement = '';

        switch (format) {
            case 'header':
                replacement = selectedText ? `== ${selectedText} ==` : '== New Section ==';
                break;
            case 'bold':
                replacement = selectedText ? `**${selectedText}**` : '**bold text**';
                break;
            case 'italic':
                replacement = selectedText ? `*${selectedText}*` : '*italic text*';
                break;
            case 'link':
                replacement = selectedText ? `[[${selectedText}]]` : '[[Link text]]';
                break;
            case 'list':
                if (selectedText) {
                    // Convert selected text to list items
                    const lines = selectedText.split('\n');
                    replacement = lines.map(line => `* ${line}`).join('\n');
                } else {
                    replacement = '* List item\n* List item\n* List item';
                }
                break;
            case 'reference':
                replacement = selectedText ? `<ref>${selectedText}</ref>` : '<ref>Citation needed</ref>';
                break;
        }

        const newText = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
        textarea.value = newText;
        textarea.focus();

        // Position cursor appropriately
        const newPosition = start + replacement.length;
        textarea.selectionStart = newPosition;
        textarea.selectionEnd = newPosition;

        updateLivePreview();
    }

    function updateLivePreview() {
        if (editPreview.style.display !== 'none') {
            updatePreview();
        }
    }

    function updatePreview() {
        const content = editContent.value;
        editPreviewContent.innerHTML = markdownToHtml(content); // Ensure markdownToHtml function is defined
    }

    async function submitRevision(title, content, summary, isMinor = false) {
        const pageId = generatePageId(title); // Ensure generatePageId function is defined

        // Check if this is a new page
        const isNewPage = !(await pageExists(pageId));

        const revisionData = {
            pageId: pageId,
            title: title,
            content: content,
            summary: summary,
            author: currentUser.uid,
            authorEmail: currentUser.email,
            authorName: currentUser.email.split('@')[0],
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            isMinor: isMinor,
            status: isAdminUser ? 'approved' : 'pending',
            isNewPage: isNewPage
        };

        // Save revision to history in Realtime Database
        await db.ref('revisions').push(revisionData);

        // If user is admin or this is an existing page, update the page content
        if (isAdminUser || !isNewPage) {
            const pageData = {
                title: title,
                content: content,
                lastUpdatedBy: currentUser.uid,
                lastUpdatedByEmail: currentUser.email,
                lastUpdatedByName: currentUser.email.split('@')[0],
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                createdAt: isNewPage ? firebase.database.ServerValue.TIMESTAMP : undefined, // RTDB doesn't have FieldValue.serverTimestamp() for conditional writes like this
                status: isAdminUser ? 'approved' : 'pending',
            };

            // Update page in Realtime Database
            await db.ref(`pages/${pageId}`).update(pageData); // Use update for partial updates, set for full replacement
        }

        // Update current page ID if this is a new page
        if (isNewPage) {
            currentPageId = pageId;
        }
    }

    async function pageExists(pageId) {
        const snapshot = await db.ref(`pages/${pageId}`).once('value');
        return snapshot.exists();
    }

    // Enhanced page loading
    async function loadPage(pageId) {
        currentPageId = pageId;

        // Show loading spinner
        pageContent.style.display = 'none';
        loadingSpinner.style.display = 'block';

        try {
            const snapshot = await db.ref(`pages/${pageId}`).once('value');
            if (snapshot.exists()) {
                const pageData = snapshot.val();
                displayPage(pageData); // Ensure displayPage function is defined
            } else {
                displayDefaultContent(pageId); // Ensure displayDefaultContent function is defined
            }
        } catch (error) {
            console.error('Error loading page:', error);
            displayError(); // Ensure displayError function is defined
        } finally {
            // Hide loading spinner
            loadingSpinner.style.display = 'none';
            pageContent.style.display = 'block';
        }

        // Reset to article tab
        switchTab('article');
    }

    // Placeholder functions - you'll need to define these
    function markdownToHtml(markdown) {
        // Implement your markdown to HTML conversion logic here
        // For a full-featured markdown parser, consider a library like marked.js
        let html = markdown;

        // Headers
        html = html.replace(/^== (.*) ==$/gm, '<h2>$1</h2>');
        html = html.replace(/^= (.*) =$/gm, '<h1>$1</h1>');

        // Bold
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Italic
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

        // Links (simple internal wiki links)
        html = html.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
            const parts = p1.split('|');
            const pageName = parts[0];
            const linkText = parts[1] || pageName;
            return `<a href="#" data-page="${pageName.toLowerCase().replace(/\s/g, '-')}" class="wiki-link">${linkText}</a>`;
        });

        // Images (simple wiki image tag)
        html = html.replace(/\[\[Image:(.*?)\|(.*?)\|(.*?)\]\]/g, '<figure><img src="$1" alt="$2" class="img-fluid"><figcaption>$3</figcaption></figure>');
        html = html.replace(/\[\[Image:(.*?)\|(.*?)\]\]/g, '<img src="$1" alt="$2" class="img-fluid">');


        // Unordered lists
        html = html.replace(/^\* (.*)$/gm, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');


        // References (basic)
        html = html.replace(/<ref>(.*?)<\/ref>/g, '<sup class="reference" data-content="$1">[ref]</sup>');

        // Basic paragraph wrapping
        html = html.split('\n\n').map(paragraph => `<p>${paragraph}</p>`).join('');


        return html;
    }

    function generatePageId(title) {
        return title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    function displayPage(pageData) {
        pageTitle.textContent = pageData.title;
        pageContent.innerHTML = markdownToHtml(pageData.content);
        let infoHtml = `Last updated by ${pageData.lastUpdatedByName} `;
        if (pageData.updatedAt) {
            infoHtml += `on ${new Date(pageData.updatedAt).toLocaleDateString()} at ${new Date(pageData.updatedAt).toLocaleTimeString()}`;
        }
        pageInfo.innerHTML = infoHtml;
        // You might want to update editTitle and editContent if you're loading a page into the editor
        editTitle.value = pageData.title;
        editContent.value = pageData.content;
        updatePageActions(); // Call to update action buttons based on user status
    }

    function displayDefaultContent(pageId) {
        pageTitle.textContent = `Page Not Found: "${pageId}"`;
        pageContent.innerHTML = `
            <p>The page "${pageId}" does not exist yet. Would you like to create it?</p>
            <button id="create-page-btn" class="btn btn-success">Create this page</button>
        `;
        pageInfo.textContent = '';
        const createPageButton = document.getElementById('create-page-btn');
        if (createPageButton) {
            createPageButton.addEventListener('click', () => {
                if (currentUser) {
                    editTitle.value = pageId; // Pre-fill title with the requested page ID
                    editContent.value = `This is the content for ${pageId}. Start editing here!`;
                    switchTab('edit');
                } else {
                    showLoginPrompt('You must be logged in to create pages.');
                }
            });
        }
        editTitle.value = pageId;
        editContent.value = '';
        updatePageActions();
    }

    function displayError() {
        pageTitle.textContent = 'Error Loading Page';
        pageContent.innerHTML = '<p class="text-danger">An error occurred while trying to load the page. Please try again later.</p>';
        pageInfo.textContent = '';
        updatePageActions();
    }

    function updatePageActions() {
        // Example: Control visibility of "Edit" button
        const editButton = document.querySelector('[data-tab="edit"]');
        if (editButton) {
            editButton.style.display = currentUser ? 'block' : 'none';
        }
        // Add more logic here to show/hide other actions based on isAdminUser and currentUser
    }

    function loadFeaturedArticles() {
        // Implement logic to load featured articles from Realtime Database
        // This would involve querying the 'pages' node and perhaps filtering or ordering
        // based on some criteria (e.g., a 'featured' flag, or most viewed).
        // For example, to get all pages:
        // db.ref('pages').once('value').then(snapshot => {
        //     const pages = snapshot.val();
        //     // Process pages here to display featured ones in your sidebar
        // });
        console.log("Loading featured articles (Realtime Database implementation needed).");
    }

    function searchPages(searchTerm) {
        // Implement search functionality for Realtime Database
        // Realtime Database search is typically done by fetching relevant data and
        // then filtering client-side, or by using Firebase Functions for more complex indexing.
        // For a basic example, you might fetch all page titles and filter:
        db.ref('pages').orderByChild('title').once('value')
            .then(snapshot => {
                const results = [];
                snapshot.forEach(childSnapshot => {
                    const page = childSnapshot.val();
                    if (page.title && page.title.toLowerCase().includes(searchTerm.toLowerCase())) {
                        results.push({ id: childSnapshot.key, title: page.title });
                    }
                });
                // Display search results, perhaps by loading the first result or showing a list
                if (results.length > 0) {
                    alert(`Found pages: ${results.map(r => r.title).join(', ')}`);
                    loadPage(results[0].id); // Load the first result
                } else {
                    alert(`No pages found for "${searchTerm}"`);
                }
            })
            .catch(error => {
                console.error("Error searching pages:", error);
                alert("An error occurred during search.");
            });
    }

    function showDiscussion() {
        pageContent.style.display = 'block'; // Or a dedicated discussion container
        editSection.style.display = 'none';
        loadingSpinner.style.display = 'block'; // Show spinner while loading discussions

        const discussionContainer = document.getElementById('discussion-container'); // Assuming you have a div for discussions
        if (!discussionContainer) {
            console.error("Discussion container not found!");
            return;
        }
        discussionContainer.innerHTML = '<h4>Discussions</h4><hr>';
        discussionContainer.innerHTML += '<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#discussionModal">Start New Discussion</button>';

        // Fetch discussions for the current page
        db.ref('discussions').orderByChild('pageId').equalTo(currentPageId).once('value')
            .then(snapshot => {
                loadingSpinner.style.display = 'none';
                if (snapshot.exists()) {
                    discussionTopics = [];
                    snapshot.forEach(childSnapshot => {
                        const discussion = childSnapshot.val();
                        discussionTopics.push({ id: childSnapshot.key, ...discussion });
                    });

                    if (discussionTopics.length > 0) {
                        discussionTopics.forEach(topic => {
                            const discussionElement = document.createElement('div');
                            discussionElement.classList.add('card', 'mb-3');
                            discussionElement.innerHTML = `
                                <div class="card-body">
                                    <h5 class="card-title">${topic.topic}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">Started by ${topic.authorName} on ${new Date(topic.createdAt).toLocaleDateString()}</h6>
                                    <p class="card-text">${topic.content}</p>
                                    <button class="btn btn-sm btn-outline-info view-discussion-btn" data-discussion-id="${topic.id}">View Discussion</button>
                                </div>
                            `;
                            discussionContainer.appendChild(discussionElement);
                        });

                        document.querySelectorAll('.view-discussion-btn').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const discussionId = e.target.dataset.discussionId;
                                // Implement logic to show detailed discussion view
                                alert(`Viewing discussion: ${discussionId}`);
                            });
                        });

                    } else {
                        discussionContainer.innerHTML += '<p>No discussions for this page yet. Be the first to start one!</p>';
                    }
                } else {
                    discussionContainer.innerHTML += '<p>No discussions for this page yet. Be the first to start one!</p>';
                }
            })
            .catch(error => {
                console.error("Error loading discussions:", error);
                loadingSpinner.style.display = 'none';
                discussionContainer.innerHTML += '<p class="text-danger">Error loading discussions.</p>';
            });
    }

    function showHistory() {
        pageContent.style.display = 'block'; // Or a dedicated history container
        editSection.style.display = 'none';
        loadingSpinner.style.display = 'block'; // Show spinner while loading history

        const historyContainer = document.getElementById('history-container'); // Assuming you have a div for history
        if (!historyContainer) {
            console.error("History container not found!");
            return;
        }
        historyContainer.innerHTML = '<h4>Page History</h4><hr>';

        // Fetch revisions for the current page
        db.ref('revisions').orderByChild('pageId').equalTo(currentPageId).once('value')
            .then(snapshot => {
                loadingSpinner.style.display = 'none';
                if (snapshot.exists()) {
                    recentChanges = [];
                    snapshot.forEach(childSnapshot => {
                        const revision = childSnapshot.val();
                        recentChanges.push({ id: childSnapshot.key, ...revision });
                    });

                    // Sort revisions by timestamp in descending order (most recent first)
                    recentChanges.sort((a, b) => b.timestamp - a.timestamp);

                    if (recentChanges.length > 0) {
                        const historyList = document.createElement('ul');
                        historyList.classList.add('list-group');
                        recentChanges.forEach(revision => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('list-group-item');
                            const timestamp = new Date(revision.timestamp).toLocaleString();
                            const minorTag = revision.isMinor ? ' <span class="badge bg-secondary">minor</span>' : '';
                            const statusTag = revision.status === 'pending' ? ' <span class="badge bg-warning">pending approval</span>' : '';
                            listItem.innerHTML = `
                                <strong>${timestamp}</strong> -
                                <span class="text-info">${revision.authorName}</span>
                                ${minorTag} ${statusTag}
                                <br>
                                Summary: <em>${revision.summary || 'No summary'}</em>
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-1 view-revision-btn" data-revision-id="${revision.id}">View Revision</button>
                            `;
                            historyList.appendChild(listItem);
                        });
                        historyContainer.appendChild(historyList);

                        document.querySelectorAll('.view-revision-btn').forEach(button => {
                            button.addEventListener('click', (e) => {
                                const revisionId = e.target.dataset.revisionId;
                                // Implement logic to show specific revision content
                                const revision = recentChanges.find(r => r.id === revisionId);
                                if (revision) {
                                    alert(`Revision Content:\n\n${revision.content}`);
                                }
                            });
                        });
                    } else {
                        historyContainer.innerHTML += '<p>No revision history for this page.</p>';
                    }
                } else {
                    historyContainer.innerHTML += '<p>No revision history for this page.</p>';
                }
            })
            .catch(error => {
                console.error("Error loading history:", error);
                loadingSpinner.style.display = 'none';
                historyContainer.innerHTML += '<p class="text-danger">Error loading page history.</p>';
            });
    }

    // Call init when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
