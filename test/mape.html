<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minnesota Then - Community History Wiki</title>
    <link rel="icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/wiki.css">
    <link rel="stylesheet" href="styles/editor.css">
    <link rel="stylesheet" href="styles/auth.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer">
</head>
    <style>
        :root {
    /* Color palette */
    --primary-blue: #1e3a8a;
    --primary-blue-light: #3b5bb5;
    --primary-blue-dark: #152c68;
    --secondary-color: #7d5ab5;
    --accent-color: #f97316;
    --warning-color: #f59e0b;
    --error-color: #dc2626;
    --success-color: #16a34a;
    
    /* Neutrals */
    --white: #ffffff;
    --off-white: #f9fafb;
    --light-gray: #f3f4f6;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
    --black: #020617;
    
    /* Border colors */
    --border-light: var(--gray-200);
    --border-medium: var(--gray-300);
    --border-dark: var(--gray-400);
    
    /* Text colors */
    --text-primary: var(--gray-900);
    --text-secondary: var(--gray-700);
    --text-muted: var(--gray-500);
    --text-light: var(--gray-400);
    --text-white: var(--white);
    
    /* Spacing system (8px) */
    --space-1: 0.25rem; /* 4px */
    --space-2: 0.5rem;  /* 8px */
    --space-3: 0.75rem; /* 12px */
    --space-4: 1rem;    /* 16px */
    --space-5: 1.25rem; /* 20px */
    --space-6: 1.5rem;  /* 24px */
    --space-8: 2rem;    /* 32px */
    --space-10: 2.5rem; /* 40px */
    --space-12: 3rem;   /* 48px */
    --space-16: 4rem;   /* 64px */
    
    /* Typography */
    --font-sans: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-serif: 'Source Serif Pro', Georgia, Times, serif;
    
    /* Component specific */
    --header-height: 4rem;
    --sidebar-width: 16rem;
    --content-width: calc(100% - var(--sidebar-width));
    --footer-bg: var(--primary-blue);
    
    /* Effects */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition-fast: 150ms ease-in-out;
    --transition-medium: 250ms ease-in-out;
    --transition-slow: 350ms ease-in-out;
    
    /* Border radius */
    --radius-sm: 0.25rem;
    --radius-md: 0.375rem;
    --radius-lg: 0.5rem;
    --radius-xl: 0.75rem;
    --radius-full: 9999px;
}

/* Base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-sans);
    line-height: 1.6;
    color: var(--text-primary);
    background-color: var(--white);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-serif);
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: var(--space-4);
    color: var(--text-primary);
}

h1 {
    font-size: 2.25rem;
    margin-bottom: var(--space-6);
}

h2 {
    font-size: 1.875rem;
    margin-top: var(--space-8);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--border-light);
}

h3 {
    font-size: 1.5rem;
    margin-top: var(--space-6);
    margin-bottom: var(--space-3);
}

h4 {
    font-size: 1.25rem;
    margin-top: var(--space-5);
    margin-bottom: var(--space-2);
}

p {
    margin-bottom: var(--space-4);
}

a {
    color: var(--primary-blue);
    text-decoration: none;
    transition: color var(--transition-fast);
}

a:hover {
    color: var(--primary-blue-light);
    text-decoration: underline;
}

ul, ol {
    margin-bottom: var(--space-4);
    margin-left: var(--space-5);
}

li {
    margin-bottom: var(--space-2);
}

/* Common components */
.wiki-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--border-medium);
    background-color: var(--white);
    color: var(--text-primary);
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
}

.wiki-button:hover {
    background-color: var(--gray-100);
    text-decoration: none;
    color: var(--text-primary);
}

.wiki-button-primary {
    background-color: var(--primary-blue);
    color: var(--white);
    border-color: var(--primary-blue);
}

.wiki-button-primary:hover {
    background-color: var(--primary-blue-light);
    border-color: var(--primary-blue-light);
    color: var(--white);
}

.wiki-text-button {
    border: none;
    background: none;
    padding: var(--space-2);
    color: var(--primary-blue);
}

.wiki-text-button:hover {
    text-decoration: underline;
    background: none;
}

/* Main structure */
.wiki-container {
    display: flex;
    min-height: calc(100vh - var(--header-height));
    padding-top: var(--header-height);
}

/* Footer styles */
.mnthen-footer {
    background-color: var(--footer-bg);
    color: var(--white);
    padding: var(--space-10) 0;
    margin-top: auto;
}

.mnthen-footer-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-4);
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
}

.mnthen-footer-section {
    flex: 1;
    min-width: 250px;
    margin-bottom: var(--space-6);
    padding: 0 var(--space-4);
}

.mnthen-footer-section h3 {
    font-size: 1.5rem;
    margin-bottom: var(--space-4);
    color: var(--white);
    border-bottom: none;
}

.mnthen-footer-section h4 {
    font-size: 1.25rem;
    margin-bottom: var(--space-4);
    color: var(--white);
}

.mnthen-footer-section p {
    margin-bottom: var(--space-3);
    font-size: 0.9rem;
}

.mnthen-footer-section ul {
    list-style: none;
    margin-left: 0;
}

.mnthen-footer-section ul li {
    margin-bottom: var(--space-2);
}

.mnthen-footer-section a {
    color: var(--gray-300);
    text-decoration: none;
    transition: color var(--transition-fast);
}

.mnthen-footer-section a:hover {
    color: var(--white);
    text-decoration: underline;
}

.social-links {
    display: flex;
    gap: var(--space-4);
    margin-top: var(--space-3);
}

.social-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--white);
    transition: background-color var(--transition-fast);
}

.social-links a:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: var(--white);
}

.copyright {
    margin-top: var(--space-6);
    font-size: 0.8rem;
    color: var(--gray-400);
}

/* Utility classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

.wiki-loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-8) 0;
    color: var(--text-muted);
}

.wiki-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--gray-200);
    border-top-color: var(--primary-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-4);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Header styles */
.mnthen-header {
    background-color: var(--white);
    border-bottom: 1px solid var(--border-light);
    box-shadow: var(--shadow-sm);
    height: var(--header-height);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.mnthen-header-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--space-4);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.mnthen-logo {
    display: flex;
    align-items: center;
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-blue);
    text-decoration: none;
    transition: opacity var(--transition-fast);
}

.mnthen-logo:hover {
    opacity: 0.9;
    text-decoration: none;
    color: var(--primary-blue);
}

.mnthen-logo-img {
    height: 2.5rem;
    margin-right: var(--space-2);
}

/* Mobile menu button */
.mnthen-mobile-menu {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-2);
}

.mnthen-mobile-menu span {
    display: block;
    width: 24px;
    height: 2px;
    background-color: var(--text-primary);
    transition: all var(--transition-medium);
    margin: 6px 0;
}

/* Navigation */
.mnthen-nav {
    height: 100%;
}

.mnthen-nav-list {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    height: 100%;
}

.mnthen-nav-item {
    height: 100%;
    display: flex;
    align-items: center;
    position: relative;
}

.mnthen-nav-item:not(:last-child) {
    margin-right: var(--space-2);
}

.mnthen-dropdown-btn {
    display: flex;
    align-items: center;
    padding: 0 var(--space-4);
    height: 100%;
    background: none;
    border: none;
    font-family: var(--font-sans);
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: color var(--transition-fast);
}

.mnthen-dropdown-btn:hover {
    color: var(--primary-blue);
}

.mnthen-dropdown-arrow {
    margin-left: var(--space-1);
    fill: currentColor;
    transition: transform var(--transition-fast);
}

.mnthen-dropdown-btn.active .mnthen-dropdown-arrow {
    transform: rotate(180deg);
}

.mnthen-dropdown-content {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: var(--white);
    min-width: 180px;
    box-shadow: var(--shadow-md);
    border-radius: var(--radius-md);
    overflow: hidden;
    z-index: 1;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all var(--transition-medium);
}

.mnthen-dropdown-content.active,
.mnthen-nav-item:hover .mnthen-dropdown-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.mnthen-dropdown-content a {
    display: block;
    padding: var(--space-3) var(--space-4);
    color: var(--text-primary);
    text-decoration: none;
    transition: background-color var(--transition-fast);
}

.mnthen-dropdown-content a:hover {
    background-color: var(--gray-100);
    color: var(--primary-blue);
}

/* Donate button */
.mnthen-donate-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-2) var(--space-5);
    background-color: var(--primary-blue);
    color: var(--white);
    font-weight: 600;
    border-radius: var(--radius-md);
    transition: background-color var(--transition-fast);
    height: 2.5rem;
}

.mnthen-donate-btn:hover {
    background-color: var(--primary-blue-light);
    color: var(--white);
    text-decoration: none;
}

/* Wiki-specific styles */

/* Sidebar */
.wiki-sidebar {
    width: var(--sidebar-width);
    background-color: var(--gray-100);
    border-right: 1px solid var(--border-light);
    height: 100%;
    position: fixed;
    overflow-y: auto;
    padding: var(--space-4);
    transition: transform var(--transition-medium);
}

.wiki-sidebar-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

.wiki-sidebar-section {
    margin-bottom: var(--space-4);
}

.wiki-sidebar-section h3 {
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-3);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--border-light);
}

.wiki-nav-list,
.wiki-category-list,
.wiki-tools-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.wiki-nav-list li,
.wiki-category-list li,
.wiki-tools-list li {
    margin-bottom: var(--space-2);
}

.wiki-nav-list a,
.wiki-category-list a,
.wiki-tools-list a {
    display: block;
    padding: var(--space-2);
    color: var(--text-secondary);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
}

.wiki-nav-list a:hover,
.wiki-category-list a:hover,
.wiki-tools-list a:hover {
    background-color: var(--gray-200);
    color: var(--primary-blue);
    text-decoration: none;
}

.wiki-search-form {
    display: flex;
    margin-top: var(--space-2);
}

#wiki-search-input {
    flex-grow: 1;
    padding: var(--space-2);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    font-size: 0.875rem;
}

#wiki-search-button {
    background-color: var(--primary-blue);
    color: var(--white);
    border: none;
    padding: var(--space-2) var(--space-3);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    cursor: pointer;
    transition: background-color var(--transition-fast);
}

#wiki-search-button:hover {
    background-color: var(--primary-blue-light);
}

/* Main content area */
.wiki-main-content {
    margin-left: var(--sidebar-width);
    padding: var(--space-6) var(--space-8);
    min-height: calc(100vh - var(--header-height));
    width: var(--content-width);
    transition: margin-left var(--transition-medium), width var(--transition-medium);
}

/* Wiki page tabs */
.wiki-page-tabs {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: var(--space-6);
}

.wiki-tabs-list {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
}

.wiki-tab {
    display: block;
    padding: var(--space-2) var(--space-4);
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    transition: all var(--transition-fast);
    margin-right: var(--space-2);
    font-weight: 500;
}

.wiki-tab:hover {
    color: var(--primary-blue);
    text-decoration: none;
}

.wiki-tab.active {
    color: var(--primary-blue);
    border-bottom-color: var(--primary-blue);
    font-weight: 600;
}

.wiki-auth-status {
    display: flex;
    gap: var(--space-3);
}

/* Article header */
.wiki-article-header {
    margin-bottom: var(--space-6);
}

.wiki-article-meta {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: var(--space-2);
}

.wiki-user-link {
    font-weight: 600;
}

/* Article content */
.wiki-article-content {
    font-family: var(--font-serif);
    line-height: 1.7;
}

.wiki-article-content p {
    margin-bottom: var(--space-4);
}

.wiki-article-content blockquote {
    border-left: 4px solid var(--gray-300);
    padding-left: var(--space-4);
    margin: var(--space-4) 0;
    color: var(--text-secondary);
    font-style: italic;
}

.wiki-article-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: var(--space-4) 0;
}

.wiki-article-content table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-4) 0;
}

.wiki-article-content th,
.wiki-article-content td {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--border-medium);
}

.wiki-article-content th {
    background-color: var(--gray-100);
    font-weight: 600;
    text-align: left;
}

.wiki-article-content tr:nth-child(even) {
    background-color: var(--gray-50);
}

/* Table of contents */
.wiki-toc {
    float: right;
    width: 300px;
    margin: 0 0 var(--space-4) var(--space-4);
    padding: var(--space-4);
    background-color: var(--gray-100);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
}

.wiki-toc-title {
    font-weight: 600;
    margin-bottom: var(--space-3);
    text-align: center;
}

.wiki-toc-list {
    list-style-type: none;
    margin: 0;
    padding: 0;
}

.wiki-toc-list li {
    margin-bottom: var(--space-2);
}

.wiki-toc-list a {
    color: var(--text-secondary);
    text-decoration: none;
}

.wiki-toc-list a:hover {
    color: var(--primary-blue);
    text-decoration: underline;
}

.wiki-toc-list .toc-level-2 {
    margin-left: var(--space-3);
}

.wiki-toc-list .toc-level-3 {
    margin-left: var(--space-6);
    font-size: 0.8125rem;
}

/* Wiki sections (view, edit, history, discuss) */
.wiki-view-container,
.wiki-edit-container,
.wiki-history-container,
.wiki-discuss-container {
    display: none;
}

.active-tab-content {
    display: block;
}

/* History table */
.wiki-history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: var(--space-4);
}

.wiki-history-table th,
.wiki-history-table td {
    padding: var(--space-3);
    border: 1px solid var(--border-light);
    text-align: left;
}

.wiki-history-table th {
    background-color: var(--gray-100);
    font-weight: 600;
}

.wiki-history-table tr:hover {
    background-color: var(--gray-100);
}

/* Discussion styles */
.wiki-discussion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}

.wiki-discussions-list {
    margin-top: var(--space-4);
}

.wiki-discussion-item {
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    overflow: hidden;
}

.wiki-discussion-header {
    padding: var(--space-3) var(--space-4);
    background-color: var(--gray-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.wiki-discussion-title {
    font-weight: 600;
    margin: 0;
}

.wiki-discussion-meta {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.wiki-discussion-content {
    padding: var(--space-4);
}

.wiki-discussion-actions {
    padding: var(--space-3) var(--space-4);
    background-color: var(--gray-50);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}

.wiki-new-discussion-form {
    display: none;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-top: var(--space-6);
    background-color: var(--gray-50);
}

.wiki-new-discussion-form h3 {
    margin-top: 0;
    margin-bottom: var(--space-4);
}

.form-group {
    margin-bottom: var(--space-4);
}

.form-group label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: 500;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: var(--space-2);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
}

.form-group textarea {
    min-height: 150px;
    resize: vertical;
}

.wiki-discussion-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
}

/* Information boxes */
.wiki-info-box {
    padding: var(--space-4);
    margin: var(--space-4) 0;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--primary-blue);
    background-color: var(--gray-100);
}

.wiki-warning-box {
    padding: var(--space-4);
    margin: var(--space-4) 0;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--warning-color);
    background-color: #fff8e6;
}

.wiki-error-box {
    padding: var(--space-4);
    margin: var(--space-4) 0;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--error-color);
    background-color: #fee2e2;
}

.wiki-success-box {
    padding: var(--space-4);
    margin: var(--space-4) 0;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--success-color);
    background-color: #dcfce7;
}

/* Modal */
.wiki-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.wiki-modal-content {
    background-color: var(--white);
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: modalFadeIn 0.3s;
}

.wiki-modal-header {
    padding: var(--space-4);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.wiki-modal-header h3 {
    margin: 0;
    font-weight: 600;
}

.wiki-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    color: var(--text-muted);
    transition: color var(--transition-fast);
}

.wiki-modal-close:hover {
    color: var(--text-primary);
}

.wiki-modal-body {
    padding: var(--space-4);
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Editor-specific styles */

.wiki-edit-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
    margin-bottom: var(--space-3);
    padding: var(--space-2);
    background-color: var(--gray-100);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
}

.wiki-edit-toolbar button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border: 1px solid var(--border-light);
    background-color: var(--white);
    color: var(--text-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.wiki-edit-toolbar button:hover {
    background-color: var(--gray-200);
    color: var(--primary-blue);
}

.wiki-edit-toolbar button[data-format="heading"] {
    font-size: 1.25rem;
}

.wiki-edit-toolbar button[data-format="subheading"] {
    font-size: 1.1rem;
}

.wiki-edit-form {
    margin-bottom: var(--space-6);
}

#wiki-editor {
    width: 100%;
    min-height: 400px;
    padding: var(--space-3);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-family: var(--font-sans);
    font-size: 1rem;
    line-height: 1.6;
    resize: vertical;
}

.wiki-edit-options {
    margin-top: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.wiki-edit-summary {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.wiki-edit-summary label {
    font-weight: 500;
}

#edit-summary {
    padding: var(--space-2);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
}

.wiki-edit-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
}

/* Preview section */
.wiki-preview-container {
    display: none;
    margin-top: var(--space-6);
    padding: var(--space-4);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background-color: var(--gray-100);
}

.wiki-preview-container h3 {
    margin-top: 0;
    margin-bottom: var(--space-3);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--border-light);
}

#wiki-preview-content {
    background-color: var(--white);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
}

/* Syntax highlighting for the editor */
.editor-highlight {
    color: var(--primary-blue);
    font-weight: bold;
}

.editor-heading {
    color: var(--primary-blue-dark);
    font-weight: bold;
}

.editor-link {
    color: var(--secondary-color);
}

.editor-citation {
    color: var(--accent-color);
}

/* Animations for the editor */
@keyframes saveSuccess {
    0% { background-color: var(--white); }
    50% { background-color: rgba(22, 163, 74, 0.1); }
    100% { background-color: var(--white); }
}

.save-success {
    animation: saveSuccess 1.5s ease;
}

/* Edit conflict warning */
.edit-conflict-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    border-radius: var(--radius-md);
}

.edit-conflict-warning h4 {
    margin-top: 0;
    margin-bottom: var(--space-2);
    color: #856404;
}

.edit-conflict-options {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-3);
}

/* Authentication-specific styles */

/* Auth form */
#auth-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.auth-form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.auth-form-group label {
    font-weight: 500;
}

.auth-form-group input {
    padding: var(--space-3);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    font-size: 1rem;
}

.auth-form-group input:focus {
    border-color: var(--primary-blue);
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.auth-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--space-2);
}

.auth-error {
    display: none;
    background-color: #fee2e2;
    color: var(--error-color);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
}

/* User info in header */
.user-info {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-full);
    background-color: var(--gray-300);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
}

.user-name {
    font-weight: 500;
}

/* Auth status in page tabs */
.wiki-auth-status {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.wiki-auth-status .user-greeting {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

/* Authentication animations */
@keyframes authSuccess {
    0% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
    100% { transform: translateY(0); }
}

.auth-success {
    animation: authSuccess 0.5s ease;
}

/* Permission-related styles */
.require-auth-message {
    background-color: var(--gray-100);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin: var(--space-6) 0;
    text-align: center;
}

.require-auth-message h3 {
    margin-top: 0;
    margin-bottom: var(--space-3);
}

.require-auth-message p {
    margin-bottom: var(--space-4);
}

.require-auth-actions {
    display: flex;
    justify-content: center;
    gap: var(--space-3);
}

/* Responsive styles */

/* Large screens (default) */
@media (min-width: 1200px) {
    .wiki-main-content {
        max-width: 1200px;
        margin-left: var(--sidebar-width);
        margin-right: auto;
    }
}

/* Medium screens */
@media (max-width: 1199px) {
    :root {
        --sidebar-width: 240px;
    }
    
    .wiki-main-content {
        padding: var(--space-4) var(--space-6);
    }
    
    .wiki-toc {
        width: 250px;
    }
}

/* Small screens (tablets) */
@media (max-width: 991px) {
    :root {
        --sidebar-width: 200px;
    }
    
    .wiki-main-content {
        padding: var(--space-4);
    }
    
    .mnthen-header-container {
        padding: 0 var(--space-3);
    }
    
    .mnthen-nav-item:not(:last-child) {
        margin-right: var(--space-1);
    }
    
    .mnthen-dropdown-btn {
        padding: 0 var(--space-3);
    }
    
    .wiki-article-content {
        font-size: 0.95rem;
    }
    
    .wiki-toc {
        float: none;
        width: 100%;
        margin: 0 0 var(--space-4) 0;
    }
    
    .mnthen-footer-container {
        padding: 0 var(--space-3);
    }
}

/* Mobile screens */
@media (max-width: 768px) {
    :root {
        --sidebar-width: 100%;
        --content-width: 100%;
        --header-height: 3.5rem;
    }
    
    body {
        font-size: 15px;
    }
    
    .mnthen-header-container {
        padding: 0 var(--space-2);
    }
    
    .mnthen-logo {
        font-size: 1.25rem;
    }
    
    .mnthen-logo-img {
        height: 2rem;
    }
    
    .mnthen-mobile-menu {
        display: block;
    }
    
    .mnthen-nav {
        position: fixed;
        top: var(--header-height);
        left: 0;
        width: 100%;
        height: calc(100vh - var(--header-height));
        background-color: var(--white);
        transform: translateX(-100%);
        transition: transform var(--transition-medium);
        overflow-y: auto;
        z-index: 1000;
        padding: var(--space-4);
    }
    
    .mnthen-nav.active {
        transform: translateX(0);
    }
    
    .mnthen-nav-list {
        flex-direction: column;
        height: auto;
    }
    
    .mnthen-nav-item {
        height: auto;
        margin-bottom: var(--space-3);
    }
    
    .mnthen-nav-item:not(:last-child) {
        margin-right: 0;
    }
    
    .mnthen-dropdown-btn {
        padding: var(--space-3) 0;
        width: 100%;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-light);
    }
    
    .mnthen-dropdown-content {
        position: static;
        opacity: 1;
        visibility: visible;
        transform: none;
        box-shadow: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height var(--transition-medium);
        margin-top: var(--space-2);
    }
    
    .mnthen-dropdown-content.active {
        max-height: 300px;
    }
    
    .mnthen-donate-btn {
        width: 100%;
        margin-top: var(--space-3);
    }
    
    .wiki-container {
        flex-direction: column;
    }
    
    .wiki-sidebar {
        position: static;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-light);
        padding: var(--space-3);
        height: auto;
    }
    
    .wiki-sidebar-content {
        gap: var(--space-4);
    }
    
    .wiki-main-content {
        margin-left: 0;
        width: 100%;
        padding: var(--space-3);
    }
    
    .wiki-page-tabs {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-3);
    }
    
    .wiki-tabs-list {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
        padding-bottom: var(--space-2);
    }
    
    .wiki-tab {
        display: inline-block;
    }
    
    .wiki-auth-status {
        justify-content: flex-start;
        padding-bottom: var(--space-2);
    }
    
    .wiki-article-header h1 {
        font-size: 1.75rem;
    }
    
    .wiki-edit-options {
        flex-direction: column;
    }
    
    .wiki-edit-actions {
        justify-content: space-between;
    }
    
    .wiki-history-table {
        display: block;
        overflow-x: auto;
    }
    
    .wiki-discussion-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
    }
    
    .mnthen-footer-container {
        flex-direction: column;
    }
    
    .mnthen-footer-section {
        width: 100%;
        padding: 0;
    }
    
    .social-links {
        justify-content: center;
    }
    
    /* Mobile auth modal */
    .wiki-modal-content {
        width: 90%;
    }
}

/* Small mobile screens */
@media (max-width: 480px) {
    :root {
        --header-height: 3rem;
    }
    
    body {
        font-size: 14px;
    }
    
    .mnthen-logo {
        font-size: 1rem;
    }
    
    .mnthen-logo-img {
        height: 1.75rem;
    }
    
    .wiki-article-header h1 {
        font-size: 1.5rem;
    }
    
    h2 {
        font-size: 1.4rem;
    }
    
    h3 {
        font-size: 1.2rem;
    }
    
    .wiki-edit-toolbar {
        gap: 0;
    }
    
    .wiki-edit-toolbar button {
        width: 32px;
        height: 32px;
    }
    
    .auth-actions {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .auth-actions button {
        width: 100%;
    }
}

/* Print styles */
@media print {
    .mnthen-header,
    .wiki-sidebar,
    .wiki-page-tabs,
    .mnthen-footer,
    .wiki-edit-container,
    .wiki-history-container,
    .wiki-discuss-container {
        display: none !important;
    }
    
    .wiki-main-content {
        margin: 0;
        padding: 0;
        width: 100%;
    }
    
    .wiki-article-content {
        font-size: 12pt;
        line-height: 1.5;
    }
    
    .wiki-article-content a {
        color: var(--text-primary);
        text-decoration: none;
    }
    
    .wiki-article-content a::after {
        content: " (" attr(href) ")";
        font-size: 0.8em;
        font-style: italic;
    }
}
    </style>
<body>
    <!-- Header -->
    <header class="mnthen-header">
        <div class="mnthen-header-container">
            <a href="/" class="mnthen-logo">
                <img src="https://www.mnthen.com/images/logo.webp" alt="Minnesota Then Logo" class="mnthen-logo-img" /> 
                Minnesota Then
            </a>
            
            <button class="mnthen-mobile-menu" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <nav class="mnthen-nav">
                <ul class="mnthen-nav-list">
                    <li class="mnthen-nav-item">
                        <button class="mnthen-dropdown-btn">
                            About
                            <svg class="mnthen-dropdown-arrow" viewBox="0 0 24 24" width="16" height="16">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="mnthen-dropdown-content">
                            <a href="https://mnthen.com/mission.html">Mission</a>
                            <a href="https://mnthen.com/ourteam.html">Our Team</a>
                            <a href="https://mnthen.com/contact">Contact</a>
                        </div>
                    </li>
                    <li class="mnthen-nav-item">
                        <button class="mnthen-dropdown-btn">
                            Multimedia
                            <svg class="mnthen-dropdown-arrow" viewBox="0 0 24 24" width="16" height="16">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="mnthen-dropdown-content">
                            <a href="https://mnthen.com/blog.html">Blog</a>
                            <a href="https://www.youtube.com/@mnthen" target="_blank">YouTube</a>
                            <a href="https://mnthen.com/podcast.html">Podcast</a>
                        </div>
                    </li>
                    <li class="mnthen-nav-item">
                        <button class="mnthen-dropdown-btn">
                            Resources
                            <svg class="mnthen-dropdown-arrow" viewBox="0 0 24 24" width="16" height="16">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="mnthen-dropdown-content">
                            <a href="https://mnthen.com/faq.html">Help Center</a>
                            <a href="https://mnthen.com/upcoming_events.html">Upcoming Events</a>
                            <a href="https://mnthen.com/resources.html">Research Tools</a>
                        </div>
                    </li>
                    <li class="mnthen-nav-item">
                        <button class="mnthen-dropdown-btn">
                            Interact
                            <svg class="mnthen-dropdown-arrow" viewBox="0 0 24 24" width="16" height="16">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div class="mnthen-dropdown-content">
                            <a href="https://www.patreon.com/mnthen" target="_blank">Join Our Patreon</a>
                            <a href="https://mnthen.com/markers.html">Share Your Story</a>
                            <a href="https://mnthen.com/trivia.html">Play Trivia Games</a> 
                        </div>
                    </li>
                    <li class="mnthen-nav-item">
                        <a href="https://mnthen.com/donate.html" class="mnthen-donate-btn">Donate</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Wiki Content Area -->
    <main class="wiki-container">
        <!-- Sidebar -->
        <aside class="wiki-sidebar">
            <div class="wiki-sidebar-content">
                <div class="wiki-sidebar-section">
                    <h3>Wiki Navigation</h3>
                    <ul class="wiki-nav-list">
                        <li><a href="#" data-page="Main_Page">Main Page</a></li>
                        <li><a href="#" data-page="Community_Portal">Community Portal</a></li>
                        <li><a href="#" data-page="Recent_Changes">Recent Changes</a></li>
                        <li><a href="#" data-page="Help">Help</a></li>
                    </ul>
                </div>
                
                <div class="wiki-sidebar-section">
                    <h3>Categories</h3>
                    <ul class="wiki-category-list">
                        <li><a href="#" data-category="People">People</a></li>
                        <li><a href="#" data-category="Places">Places</a></li>
                        <li><a href="#" data-category="Events">Events</a></li>
                        <li><a href="#" data-category="Industries">Industries</a></li>
                        <li><a href="#" data-category="Culture">Culture</a></li>
                    </ul>
                </div>
                
                <div class="wiki-sidebar-section">
                    <h3>Search</h3>
                    <div class="wiki-search-form">
                        <input type="text" id="wiki-search-input" placeholder="Search Minnesota Then Wiki">
                        <button id="wiki-search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="wiki-sidebar-section wiki-sidebar-tools">
                    <h3>Tools</h3>
                    <ul class="wiki-tools-list">
                        <li><a href="#" id="create-new-page-link">Create New Page</a></li>
                        <li><a href="#" id="random-page-link">Random Page</a></li>
                        <li><a href="#" id="what-links-here-link">What Links Here</a></li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="wiki-main-content">
            <div class="wiki-page-tabs">
                <ul class="wiki-tabs-list">
                    <li><a href="#" class="wiki-tab active" data-tab="read">Read</a></li>
                    <li><a href="#" class="wiki-tab" data-tab="edit">Edit</a></li>
                    <li><a href="#" class="wiki-tab" data-tab="history">History</a></li>
                    <li><a href="#" class="wiki-tab" data-tab="discuss">Discuss</a></li>
                </ul>
                <div class="wiki-auth-status" id="auth-status-container">
                    <button id="login-button" class="wiki-button">Log In</button>
                    <button id="signup-button" class="wiki-button wiki-button-primary">Sign Up</button>
                </div>
            </div>

            <!-- Article Header -->
            <div class="wiki-article-header">
                <h1 id="wiki-article-title">Welcome to Minnesota Then Wiki</h1>
                <div class="wiki-article-meta">
                    <span id="last-modified-info">Last modified on <time datetime="2023-10-30">October 30, 2023</time> by <a href="#" class="wiki-user-link">Admin</a></span>
                </div>
            </div>

            <!-- View Mode -->
            <div id="wiki-view-container" class="wiki-view-container active-tab-content">
                <div class="wiki-loading-indicator" id="wiki-loading">
                    <div class="wiki-spinner"></div>
                    <span>Loading article...</span>
                </div>
                
                <div class="wiki-article-content" id="article-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="wiki-edit-container" class="wiki-edit-container">
                <div class="wiki-edit-toolbar">
                    <button data-format="heading" title="Heading"><i class="fas fa-heading"></i></button>
                    <button data-format="subheading" title="Subheading"><i class="fas fa-heading fa-xs"></i></button>
                    <button data-format="bold" title="Bold"><i class="fas fa-bold"></i></button>
                    <button data-format="italic" title="Italic"><i class="fas fa-italic"></i></button>
                    <button data-format="link" title="Link"><i class="fas fa-link"></i></button>
                    <button data-format="list" title="List"><i class="fas fa-list-ul"></i></button>
                    <button data-format="reference" title="Reference"><i class="fas fa-quote-right"></i></button>
                    <button data-format="image" title="Image"><i class="fas fa-image"></i></button>
                </div>
                
                <div class="wiki-edit-form">
                    <textarea id="wiki-editor" placeholder="Enter article content here..."></textarea>
                    
                    <div class="wiki-edit-options">
                        <div class="wiki-edit-summary">
                            <label for="edit-summary">Edit Summary:</label>
                            <input type="text" id="edit-summary" placeholder="Briefly describe your changes">
                        </div>
                        
                        <div class="wiki-edit-actions">
                            <button id="preview-button" class="wiki-button">Preview</button>
                            <button id="save-button" class="wiki-button wiki-button-primary">Save Changes</button>
                        </div>
                    </div>
                </div>
                
                <div id="wiki-preview-container" class="wiki-preview-container">
                    <h3>Preview</h3>
                    <div id="wiki-preview-content" class="wiki-article-content"></div>
                </div>
            </div>

            <!-- History Mode -->
            <div id="wiki-history-container" class="wiki-history-container">
                <table class="wiki-history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Summary</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <!-- Will be filled by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Discussion Mode -->
            <div id="wiki-discuss-container" class="wiki-discuss-container">
                <div class="wiki-discussion-header">
                    <h2>Discussion: <span id="discuss-page-title">Page Title</span></h2>
                    <button id="new-discussion-button" class="wiki-button wiki-button-primary">New Topic</button>
                </div>
                
                <div id="wiki-discussions-list" class="wiki-discussions-list">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <div id="wiki-new-discussion-form" class="wiki-new-discussion-form">
                    <h3>Start a New Discussion</h3>
                    <div class="form-group">
                        <label for="discussion-topic">Topic:</label>
                        <input type="text" id="discussion-topic" placeholder="Enter topic title">
                    </div>
                    <div class="form-group">
                        <label for="discussion-content">Content:</label>
                        <textarea id="discussion-content" placeholder="Enter your comments here..."></textarea>
                    </div>
                    <div class="wiki-discussion-actions">
                        <button id="cancel-discussion-button" class="wiki-button">Cancel</button>
                        <button id="post-discussion-button" class="wiki-button wiki-button-primary">Post</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mnthen-footer">
        <div class="mnthen-footer-container">
            <div class="mnthen-footer-section">
                <h3>Minnesota Then</h3>
                <p>A community-driven history resource dedicated to preserving Minnesota's rich past.</p>
                <p class="copyright">&copy; 2025 Minnesota Then. All rights reserved</p>
            </div>
            
            <div class="mnthen-footer-section">
                <h4>About the Wiki</h4>
                <ul>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Community Guidelines</a></li>
                    <li><a href="#">Content Policies</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
            
            <div class="mnthen-footer-section">
                <h4>Connect</h4>
                <div class="social-links">
                    <a href="https://www.facebook.com/profile.php?id=100090355652945" target="_blank">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://bsky.app/profile/mnthen.bsky.social" target="_blank">
                        <i class="fa-brands fa-bluesky"></i>
                    </a>
                    <a href="https://www.linkedin.com/company/minnesota-then" target="_blank">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="wiki-modal">
        <div class="wiki-modal-content">
            <div class="wiki-modal-header">
                <h3 id="auth-modal-title">Log In</h3>
                <button class="wiki-modal-close">&times;</button>
            </div>
            <div class="wiki-modal-body">
                <div id="auth-error" class="auth-error"></div>
                <form id="auth-form">
                    <div class="auth-form-group">
                        <label for="auth-email">Email</label>
                        <input type="email" id="auth-email" required>
                    </div>
                    <div class="auth-form-group">
                        <label for="auth-password">Password</label>
                        <input type="password" id="auth-password" required>
                    </div>
                    <div class="auth-actions">
                        <button type="submit" id="auth-submit" class="wiki-button wiki-button-primary">Log In</button>
                        <button type="button" id="auth-switch" class="wiki-button wiki-text-button">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
    // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
    authDomain: "mnthen-3151d.firebaseapp.com",
    databaseURL: "https://mnthen-3151d-default-rtdb.firebaseio.com",
    projectId: "mnthen-3151d",
    storageBucket: "mnthen-3151d.appspot.com",
    messagingSenderId: "416231360428",
    appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Get database reference
const database = firebase.database();
const auth = firebase.auth();

// Wiki configuration
const wikiConfig = {
    // Default articles
    defaultArticles: {
        "Main_Page": {
            title: "Welcome to Minnesota Then Wiki",
            content: `== Welcome to Minnesota Then Wiki ==

The Minnesota Then Wiki is a community-driven historical resource dedicated to preserving and sharing the rich history of Minnesota. Our goal is to create a comprehensive collection of articles documenting the people, places, events, and stories that have shaped our state from its earliest days to the present.

== How to Contribute ==

Contributing to the Minnesota Then Wiki is easy:

1. **Create an account** - Sign up to become a contributor
2. **Browse existing articles** - Get familiar with our style and coverage
3. **Edit articles** - Improve existing content with new information or corrections
4. **Create new articles** - Add entries for historical topics not yet covered
5. **Add references** - Cite your sources to maintain accuracy and reliability

== Featured Content ==

=== People ===

* Minnesota's Notable Historical Figures
* Indigenous Leaders and Communities
* Pioneering Women
* Industrial Innovators

=== Places ===

* Historic Landmarks
* Lost Buildings and Sites
* Natural Landmarks
* Historic Districts

=== Events ===

* Major Historical Events
* Natural Disasters
* Cultural Milestones
* Political Developments

== Getting Started ==

* [[Help|Wiki Help Guide]] - Learn how to use and edit the wiki
* [[Community_Portal|Community Portal]] - Connect with other contributors
* [[Style_Guide|Style Guide]] - Guidelines for creating and editing articles
* [[Request_an_Article|Request an Article]] - Suggest topics for new articles

Thank you for helping preserve Minnesota's rich history!

[[Category:Help]]`,
            lastModified: Date.now(),
            lastModifiedBy: "Admin",
            createdAt: Date.now(),
            createdBy: "Admin"
        },
        "Help": {
            title: "Minnesota Then Wiki Help",
            content: `== Wiki Help Guide ==

Welcome to the Minnesota Then Wiki help page. This guide will help you understand how to use and contribute to our community wiki.

== Reading Articles ==

The Minnesota Then Wiki is organized like most wikis, with articles containing information on specific topics related to Minnesota history. You can navigate through articles by:

* Using the search box in the sidebar
* Clicking on links within articles
* Browsing categories
* Using the navigation links in the sidebar

== Editing Articles ==

Any registered user can edit articles on the Minnesota Then Wiki. To edit an article:

1. Navigate to the article you want to edit
2. Click the "Edit" tab at the top of the page
3. Make your changes in the editor
4. Provide a brief summary of your changes
5. Click "Save Changes"

=== Wiki Syntax ===

When editing, you can use these formatting marks:

* \`== Heading ==\` - Creates a main section heading
* \`=== Subheading ===\` - Creates a subsection heading
* \`**Bold text**\` - Makes text **bold**
* \`*Italic text*\` - Makes text *italic*
* \`[[Page Name]]\` - Creates a link to another wiki page
* \`[[Page Name|Display Text]]\` - Creates a link with custom text
* \`* Item\` - Creates a bullet point
* \`1. Item\` - Creates a numbered list
* \`[[Image:filename.jpg|alt text]]\` - Embeds an image
* \`<ref>Citation details</ref>\` - Adds a reference

== Creating New Articles ==

To create a new article:

1. Use the "Create New Page" link in the sidebar
2. Enter the title for your new article
3. Write your content using wiki syntax
4. Save your changes

== References and Citations ==

Good articles include references to verify information. To add references:

1. Place \`<ref>Source details</ref>\` after the fact you want to cite
2. Add \`== References ==\` and \`<references/>\` at the bottom of the article

== Article Discussion ==

Each article has a discussion tab where contributors can discuss potential changes or improvements. To participate:

1. Click the "Discuss" tab
2. Read existing discussions
3. Click "New Topic" to start a new discussion or reply to existing ones

== Getting Help ==

If you need additional help, you can:

* Contact wiki administrators
* Visit the [[Community_Portal|Community Portal]]
* Check the [[Style_Guide|Style Guide]]

[[Category:Help]]`,
            lastModified: Date.now(),
            lastModifiedBy: "Admin",
            createdAt: Date.now(),
            createdBy: "Admin"
        }
    },
    
    // Default categories
    defaultCategories: [
        "People",
        "Places",
        "Events",
        "Culture",
        "Industries",
        "Politics",
        "Education",
        "Help"
    ],
    
    // Wiki settings
    settings: {
        allowAnonymousEditing: false,
        requireApproval: false,
        maxHistoryEntries: 50,
        defaultRecentChanges: 20
    }
};

    /**
 * Utility functions for the Minnesota Then Wiki
 */

// Format a timestamp to a readable date
function formatDate(timestamp) {
    if (!timestamp) return 'Unknown date';
    
    const date = new Date(timestamp);
    return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

// Generate a page ID from a title
function generatePageId(title) {
    if (!title) return '';
    
    return title
        .trim()
        .replace(/\s+/g, '_')
        .replace(/[^a-zA-Z0-9_-]/g, '')
        .replace(/__+/g, '_');
}

// Get a user's display name (username or email prefix)
function getUserDisplayName(user) {
    if (!user) return 'Anonymous';
    
    if (user.displayName) {
        return user.displayName;
    } else if (user.email) {
        // Use the part before @ in the email
        return user.email.split('@')[0];
    } else {
        return 'User';
    }
}

// Convert wiki markup to HTML
function wikiMarkupToHtml(markup) {
    if (!markup) return '';
    
    let html = markup
        // Process references first
        .replace(/<ref>(.*?)<\/ref>/g, (match, p1) => {
            return `<sup class="wiki-reference">[1]</sup>`;
        })
        
        // Headings
        .replace(/^==\s*(.*?)\s*==$/gm, '<h2>$1</h2>')
        .replace(/^===\s*(.*?)\s*===$/gm, '<h3>$1</h3>')
        .replace(/^====\s*(.*?)\s*====$/gm, '<h4>$1</h4>')
        
        // Bold and italic
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        
        // Wiki links
        .replace(/\[\[(.*?)\|(.*?)\]\]/g, '<a href="#" data-page="$1">$2</a>')
        .replace(/\[\[(.*?)\]\]/g, '<a href="#" data-page="$1">$1</a>')
        
        // Lists
        .replace(/^\*\s*(.*?)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\.\s*(.*?)$/gm, '<li>$2</li>')
        
        // Images
        .replace(/\[\[Image:(.*?)\|(.*?)\]\]/g, '<figure class="wiki-image"><img src="$1" alt="$2"><figcaption>$2</figcaption></figure>')
        
        // Categories
        .replace(/\[\[Category:(.*?)\]\]/g, '<div class="wiki-category" data-category="$1">Category: $1</div>')
        
        // References section
        .replace(/<references\/>/g, '<div class="wiki-references"><h3>References</h3><ol></ol></div>');
    
    // Process lists properly (wrap consecutive <li> elements in <ul> or <ol>)
    let inList = false;
    let listType = '';
    let lines = html.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        if (line.startsWith('<li>')) {
            if (!inList) {
                // Start a new list
                inList = true;
                listType = line.match(/^<li>\d+\./) ? 'ol' : 'ul';
                lines[i] = `<${listType}>${line}`;
            }
        } else if (inList) {
            // End the current list
            lines[i-1] += `</${listType}>`;
            inList = false;
        }
    }
    
    // Close any open list at the end
    if (inList) {
        lines[lines.length-1] += `</${listType}>`;
    }
    
    html = lines.join('\n');
    
    // Process paragraphs (any text not inside a block element)
    html = html
        .replace(/^(?!<[hluofda]|$)(.+)$/gm, '<p>$1</p>')
        .replace(/<p>\s*<\/p>/g, '');
    
    return html;
}

// Generate table of contents from HTML content
function generateTableOfContents(htmlContent) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    
    const headings = tempDiv.querySelectorAll('h2, h3, h4');
    if (headings.length < 3) {
        return ''; // Don't show TOC if fewer than 3 headings
    }
    
    let tocHtml = '<div class="wiki-toc">';
    tocHtml += '<div class="wiki-toc-title">Contents</div>';
    tocHtml += '<ul class="wiki-toc-list">';
    
    let sectionCount = 1;
    let subsectionCount = 0;
    let subsubsectionCount = 0;
    
    headings.forEach(heading => {
        const headingText = heading.textContent;
        const headingId = headingText.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        
        // Set ID on the original heading
        heading.id = headingId;
        
        let listItemClass = '';
        let prefix = '';
        
        if (heading.tagName === 'H2') {
            listItemClass = 'toc-level-1';
            prefix = sectionCount + '. ';
            sectionCount++;
            subsectionCount = 1;
            subsubsectionCount = 1;
        } else if (heading.tagName === 'H3') {
            listItemClass = 'toc-level-2';
            prefix = (sectionCount - 1) + '.' + subsectionCount + ' ';
            subsectionCount++;
            subsubsectionCount = 1;
        } else if (heading.tagName === 'H4') {
            listItemClass = 'toc-level-3';
            prefix = (sectionCount - 1) + '.' + (subsectionCount - 1) + '.' + subsubsectionCount + ' ';
            subsubsectionCount++;
        }
        
        tocHtml += `<li class="${listItemClass}"><a href="#${headingId}">${prefix}${headingText}</a></li>`;
    });
    
    tocHtml += '</ul></div>';
    
    return tocHtml;
}

// Show a notification message
function showNotification(message, type = 'info', duration = 3000) {
    // Create notification element if it doesn't exist
    let notification = document.getElementById('wiki-notification');
    
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'wiki-notification';
        notification.className = 'wiki-notification';
        document.body.appendChild(notification);
    }
    
    // Set notification type class
    notification.className = `wiki-notification wiki-notification-${type}`;
    notification.innerHTML = message;
    notification.style.display = 'block';
    
    // Add animation class
    notification.classList.add('wiki-notification-show');
    
    // Hide after duration
    setTimeout(() => {
        notification.classList.remove('wiki-notification-show');
        notification.classList.add('wiki-notification-hide');
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 300);
    }, duration);
}

// Debounce function to limit how often a function can be called
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

// Check if user has permission to edit
function userCanEdit(user) {
    return !!user;
}

// Check if user has admin permissions
function userIsAdmin(user) {
    if (!user) return false;
    
    // In a real application, you would check against a list of admin users
    const adminEmails = [
        'admin@example.com'
    ];
    
    return adminEmails.includes(user.email);
}

// Search wiki content
function searchWikiContent(query, resultsCallback) {
    if (!query || query.trim() === '') {
        resultsCallback([]);
        return;
    }
    
    query = query.toLowerCase().trim();
    
    // Search in the Realtime Database
    database.ref('pages').once('value')
        .then(snapshot => {
            const results = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const pageId = childSnapshot.key;
                    const pageData = childSnapshot.val();
                    
                    // Check if title or content contains the query
                    if (
                        (pageData.title && pageData.title.toLowerCase().includes(query)) ||
                        (pageData.content && pageData.content.toLowerCase().includes(query))
                    ) {
                        results.push({
                            id: pageId,
                            title: pageData.title,
                            snippet: extractSearchSnippet(pageData.content, query),
                            lastModified: pageData.lastModified
                        });
                    }
                });
            }
            
            resultsCallback(results);
        })
        .catch(error => {
            console.error('Error searching wiki content:', error);
            resultsCallback([]);
        });
}

// Extract a relevant snippet from content for search results
function extractSearchSnippet(content, query, maxLength = 200) {
    if (!content) return '';
    
    const lowerContent = content.toLowerCase();
    const queryIndex = lowerContent.indexOf(query.toLowerCase());
    
    if (queryIndex === -1) {
        // Query not found, return the beginning of the content
        return content.substring(0, maxLength) + '...';
    }
    
    // Calculate start and end positions to show context around the query
    const snippetStart = Math.max(0, queryIndex - 60);
    const snippetEnd = Math.min(content.length, queryIndex + query.length + 60);
    
    let snippet = content.substring(snippetStart, snippetEnd);
    
    // Add ellipsis if we're not at the beginning or end
    if (snippetStart > 0) {
        snippet = '...' + snippet;
    }
    
    if (snippetEnd < content.length) {
        snippet = snippet + '...';
    }
    
    return snippet;
}

// Get a random page ID
function getRandomPageId(callback) {
    database.ref('pages').once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const pageIds = [];
                
                snapshot.forEach(childSnapshot => {
                    pageIds.push(childSnapshot.key);
                });
                
                if (pageIds.length > 0) {
                    const randomIndex = Math.floor(Math.random() * pageIds.length);
                    callback(pageIds[randomIndex]);
                } else {
                    callback('Main_Page');
                }
            } else {
                callback('Main_Page');
            }
        })
        .catch(error => {
            console.error('Error getting random page:', error);
            callback('Main_Page');
        });
}

// Check if an element is in viewport
function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

/**
 * Authentication management for Minnesota Then Wiki
 */

// DOM Elements
const authStatusContainer = document.getElementById('auth-status-container');
const loginButton = document.getElementById('login-button');
const signupButton = document.getElementById('signup-button');
const authModal = document.getElementById('auth-modal');
const authModalTitle = document.getElementById('auth-modal-title');
const authForm = document.getElementById('auth-form');
const authEmail = document.getElementById('auth-email');
const authPassword = document.getElementById('auth-password');
const authSubmit = document.getElementById('auth-submit');
const authSwitch = document.getElementById('auth-switch');
const authError = document.getElementById('auth-error');
const modalClose = document.querySelector('.wiki-modal-close');

// State variables
let isLoginMode = true;
let currentUser = null;

// Initialize authentication
function initAuth() {
    // Set up event listeners
    loginButton.addEventListener('click', () => {
        isLoginMode = true;
        updateAuthModalUI();
        showAuthModal();
    });
    
    signupButton.addEventListener('click', () => {
        isLoginMode = false;
        updateAuthModalUI();
        showAuthModal();
    });
    
    authSwitch.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        updateAuthModalUI();
    });
    
    authForm.addEventListener('submit', handleAuthSubmit);
    
    modalClose.addEventListener('click', hideAuthModal);
    
    // Listen for auth state changes
    auth.onAuthStateChanged(user => {
        currentUser = user;
        updateAuthUI();
        
        // Notify other modules of the auth change
        const event = new CustomEvent('authStateChanged', { detail: { user } });
        document.dispatchEvent(event);
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === authModal) {
            hideAuthModal();
        }
    });
}

// Handle authentication form submission
async function handleAuthSubmit(e) {
    e.preventDefault();
    
    const email = authEmail.value.trim();
    const password = authPassword.value.trim();
    
    if (!email || !password) {
        showAuthError('Please enter both email and password.');
        return;
    }
    
    // Clear previous errors
    hideAuthError();
    
    // Show loading state
    authSubmit.disabled = true;
    authSubmit.innerHTML = isLoginMode ? 'Logging in...' : 'Creating account...';
    
    try {
        if (isLoginMode) {
            // Log in
            await auth.signInWithEmailAndPassword(email, password);
            showNotification('Successfully logged in!', 'success');
        } else {
            // Sign up
            await auth.createUserWithEmailAndPassword(email, password);
            showNotification('Account created successfully!', 'success');
        }
        
        // Success - close modal
        hideAuthModal();
        authForm.reset();
    } catch (error) {
        // Handle auth errors
        let errorMessage = 'Authentication failed. Please try again.';
        
        switch (error.code) {
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                errorMessage = 'Invalid email or password.';
                break;
            case 'auth/email-already-in-use':
                errorMessage = 'This email is already registered.';
                break;
            case 'auth/weak-password':
                errorMessage = 'Password is too weak. Please use at least 6 characters.';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Please enter a valid email address.';
                break;
            case 'auth/too-many-requests':
                errorMessage = 'Too many attempts. Please try again later.';
                break;
        }
        
        showAuthError(errorMessage);
    } finally {
        // Reset button state
        authSubmit.disabled = false;
        authSubmit.innerHTML = isLoginMode ? 'Log In' : 'Create Account';
    }
}

// Update the UI based on authentication state
function updateAuthUI() {
    if (currentUser) {
        // User is logged in
        authStatusContainer.innerHTML = `
            <div class="user-info">
                <span class="user-greeting">Welcome, ${getUserDisplayName(currentUser)}</span>
                <button id="logout-button" class="wiki-button">Log Out</button>
            </div>
        `;
        
        // Add logout handler
        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                showNotification('You have been logged out', 'info');
            }).catch(error => {
                console.error('Error signing out:', error);
            });
        });
        
        // Update edit permissions throughout the UI
        document.querySelectorAll('[data-requires-auth]').forEach(element => {
            element.style.display = 'block';
        });
    } else {
        // User is logged out
        authStatusContainer.innerHTML = `
            <button id="login-button" class="wiki-button">Log In</button>
            <button id="signup-button" class="wiki-button wiki-button-primary">Sign Up</button>
        `;
        
        // Reattach event listeners
        document.getElementById('login-button').addEventListener('click', () => {
            isLoginMode = true;
            updateAuthModalUI();
            showAuthModal();
        });
        
        document.getElementById('signup-button').addEventListener('click', () => {
            isLoginMode = false;
            updateAuthModalUI();
            showAuthModal();
        });
        
        // Update edit permissions throughout the UI
        document.querySelectorAll('[data-requires-auth]').forEach(element => {
            element.style.display = 'none';
        });
    }
    
    // Update edit tab visibility
    const editTab = document.querySelector('[data-tab="edit"]');
    if (editTab) {
        editTab.style.display = currentUser ? 'block' : 'none';
    }
}

// Update the auth modal UI based on mode (login or signup)
function updateAuthModalUI() {
    authModalTitle.textContent = isLoginMode ? 'Log In' : 'Create Account';
    authSubmit.textContent = isLoginMode ? 'Log In' : 'Create Account';
    authSwitch.textContent = isLoginMode ? 'Create a new account' : 'Already have an account?';
    hideAuthError();
}

// Show auth error message
function showAuthError(message) {
    authError.textContent = message;
    authError.style.display = 'block';
}

// Hide auth error message
function hideAuthError() {
    authError.textContent = '';
    authError.style.display = 'none';
}

// Show the auth modal
function showAuthModal() {
    authModal.style.display = 'flex';
    authEmail.focus();
    
    // Add animation class
    setTimeout(() => {
        const modalContent = authModal.querySelector('.wiki-modal-content');
        modalContent.classList.add('modal-animation-in');
    }, 10);
}

// Hide the auth modal
function hideAuthModal() {
    const modalContent = authModal.querySelector('.wiki-modal-content');
    modalContent.classList.remove('modal-animation-in');
    modalContent.classList.add('modal-animation-out');
    
    setTimeout(() => {
        authModal.style.display = 'none';
        modalContent.classList.remove('modal-animation-out');
    }, 300);
}

// Get the current user
function getCurrentUser() {
    return currentUser;
}

// Check if a user is logged in
function isUserLoggedIn() {
    return !!currentUser;
}

// Require authentication to perform an action
function requireAuth(callback, message = 'You must be logged in to perform this action.') {
    if (currentUser) {
        callback();
    } else {
        showNotification(message, 'warning');
        isLoginMode = true;
        updateAuthModalUI();
        showAuthModal();
    }
}

/**
 * Database operations for Minnesota Then Wiki
 */

// Get a page by ID
function getPage(pageId, callback) {
    if (!pageId) {
        callback(null);
        return;
    }
    
    database.ref(`pages/${pageId}`).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const pageData = snapshot.val();
                callback(pageData);
            } else {
                callback(null);
            }
        })
        .catch(error => {
            console.error('Error fetching page:', error);
            callback(null);
        });
}

// Save a page to the database
function savePage(pageId, pageData, callback) {
    if (!pageId || !pageData) {
        callback(false, 'Invalid page data');
        return;
    }
    
    // Add timestamp if not present
    if (!pageData.lastModified) {
        pageData.lastModified = Date.now();
    }
    
    if (!pageData.createdAt) {
        pageData.createdAt = Date.now();
    }
    
    // Save to database
    database.ref(`pages/${pageId}`).update(pageData)
        .then(() => {
            // Save page history
            savePageHistory(pageId, pageData);
            
            callback(true);
        })
        .catch(error => {
            console.error('Error saving page:', error);
            callback(false, error.message);
        });
}

// Save a revision to the page history
function savePageHistory(pageId, pageData) {
    if (!pageId || !pageData) return;
    
    const historyEntry = {
        timestamp: Date.now(),
        title: pageData.title,
        content: pageData.content,
        editSummary: pageData.editSummary || '',
        editorId: pageData.lastModifiedById || null,
        editorName: pageData.lastModifiedBy || 'Anonymous'
    };
    
    // Add to the history
    database.ref(`history/${pageId}`).push(historyEntry);
    
    // Also add to recent changes
    const recentChangeEntry = {
        ...historyEntry,
        pageId: pageId
    };
    
    database.ref('recentChanges').push(recentChangeEntry);
}

// Get page history
function getPageHistory(pageId, callback, limit = 20) {
    if (!pageId) {
        callback([]);
        return;
    }
    
    database.ref(`history/${pageId}`)
        .orderByChild('timestamp')
        .limitToLast(limit)
        .once('value')
        .then(snapshot => {
            const history = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const revisionId = childSnapshot.key;
                    const revisionData = childSnapshot.val();
                    
                    history.unshift({
                        id: revisionId,
                        ...revisionData
                    });
                });
            }
            
            callback(history);
        })
        .catch(error => {
            console.error('Error fetching page history:', error);
            callback([]);
        });
}

// Get recent changes
function getRecentChanges(callback, limit = 20) {
    database.ref('recentChanges')
        .orderByChild('timestamp')
        .limitToLast(limit)
        .once('value')
        .then(snapshot => {
            const changes = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const changeId = childSnapshot.key;
                    const changeData = childSnapshot.val();
                    
                    changes.unshift({
                        id: changeId,
                        ...changeData
                    });
                });
            }
            
            callback(changes);
        })
        .catch(error => {
            console.error('Error fetching recent changes:', error);
            callback([]);
        });
}

// Check if a page exists
function pageExists(pageId, callback) {
    if (!pageId) {
        callback(false);
        return;
    }
    
    database.ref(`pages/${pageId}`).once('value')
        .then(snapshot => {
            callback(snapshot.exists());
        })
        .catch(error => {
            console.error('Error checking if page exists:', error);
            callback(false);
        });
}

// Get pages by category
function getPagesByCategory(category, callback, limit = 20) {
    if (!category) {
        callback([]);
        return;
    }
    
    // This is a simplified approach. In a real wiki, you would have a structured category system.
    database.ref('pages')
        .limitToFirst(limit)
        .once('value')
        .then(snapshot => {
            const pages = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const pageId = childSnapshot.key;
                    const pageData = childSnapshot.val();
                    
                    // Check if the content contains the category tag
                    if (pageData.content && pageData.content.includes(`[[Category:${category}]]`)) {
                        pages.push({
                            id: pageId,
                            title: pageData.title,
                            lastModified: pageData.lastModified
                        });
                    }
                });
            }
            
            callback(pages);
        })
        .catch(error => {
            console.error('Error fetching pages by category:', error);
            callback([]);
        });
}

// Get all categories
function getAllCategories(callback) {
    // In a real application, you would store categories in a separate collection
    // For this example, we'll return the default categories
    callback(wikiConfig.defaultCategories);
}

// Initialize default content if the database is empty
function initializeDefaultContent() {
    // Check if Main_Page exists
    pageExists('Main_Page', exists => {
        if (!exists) {
            // Add default articles
            Object.entries(wikiConfig.defaultArticles).forEach(([pageId, pageData]) => {
                savePage(pageId, pageData, success => {
                    if (success) {
                        console.log(`Created default page: ${pageId}`);
                    }
                });
            });
        }
    });
}

// Get page discussions
function getPageDiscussions(pageId, callback) {
    if (!pageId) {
        callback([]);
        return;
    }
    
    database.ref(`discussions/${pageId}`)
        .orderByChild('timestamp')
        .once('value')
        .then(snapshot => {
            const discussions = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const discussionId = childSnapshot.key;
                    const discussionData = childSnapshot.val();
                    
                    discussions.push({
                        id: discussionId,
                        ...discussionData
                    });
                });
            }
            
            callback(discussions);
        })
        .catch(error => {
            console.error('Error fetching discussions:', error);
            callback([]);
        });
}

// Add a new discussion topic
function addDiscussion(pageId, discussionData, callback) {
    if (!pageId || !discussionData) {
        callback(false, 'Invalid discussion data');
        return;
    }
    
    // Add timestamp
    discussionData.timestamp = Date.now();
    
    // Save to database
    database.ref(`discussions/${pageId}`).push(discussionData)
        .then(() => {
            callback(true);
        })
        .catch(error => {
            console.error('Error adding discussion:', error);
            callback(false, error.message);
        });
}

// Add a reply to a discussion
function addDiscussionReply(pageId, discussionId, replyData, callback) {
    if (!pageId || !discussionId || !replyData) {
        callback(false, 'Invalid reply data');
        return;
    }
    
    // Add timestamp
    replyData.timestamp = Date.now();
    
    // Save to database
    database.ref(`discussions/${pageId}/${discussionId}/replies`).push(replyData)
        .then(() => {
            callback(true);
        })
        .catch(error => {
            console.error('Error adding reply:', error);
            callback(false, error.message);
        });
}

/**
 * Core wiki functionality for Minnesota Then Wiki
 */

// DOM Elements
const wikiArticleTitle = document.getElementById('wiki-article-title');
const articleContent = document.getElementById('article-content');
const lastModifiedInfo = document.getElementById('last-modified-info');
const loadingIndicator = document.getElementById('wiki-loading');
const viewContainer = document.getElementById('wiki-view-container');
const editContainer = document.getElementById('wiki-edit-container');
const historyContainer = document.getElementById('wiki-history-container');
const discussContainer = document.getElementById('wiki-discuss-container');
const sidebarLinks = document.querySelectorAll('.wiki-sidebar a[data-page]');
const tabLinks = document.querySelectorAll('.wiki-tab');
const historyTableBody = document.getElementById('history-table-body');
const searchInput = document.getElementById('wiki-search-input');
const searchButton = document.getElementById('wiki-search-button');
const discussionsList = document.getElementById('wiki-discussions-list');
const newDiscussionButton = document.getElementById('new-discussion-button');
const newDiscussionForm = document.getElementById('wiki-new-discussion-form');
const discussPageTitle = document.getElementById('discuss-page-title');
const createNewPageLink = document.getElementById('create-new-page-link');
const randomPageLink = document.getElementById('random-page-link');
const categoryLinks = document.querySelectorAll('.wiki-category-list a[data-category]');

// State variables
let currentPageId = 'Main_Page';
let currentTab = 'read';
let currentPageData = null;

// Initialize the wiki
function initWiki() {
    // Initialize default content in the database
    initializeDefaultContent();
    
    // Set up event listeners
    setupEventListeners();
    
    // Load the initial page
    const urlParams = new URLSearchParams(window.location.search);
    const pageParam = urlParams.get('page');
    
    if (pageParam) {
        loadPage(pageParam);
    } else {
        loadPage(currentPageId);
    }
}

// Set up event listeners
function setupEventListeners() {
    // Sidebar page links
    sidebarLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = e.target.getAttribute('data-page');
            loadPage(pageId);
        });
    });
    
    // Tab navigation
    tabLinks.forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = e.target.getAttribute('data-tab');
            switchTab(tabId);
        });
    });
    
    // Create new page
    createNewPageLink.addEventListener('click', (e) => {
        e.preventDefault();
        requireAuth(() => {
            // Ask for page title
            const title = prompt('Enter a title for the new page:');
            if (title) {
                const pageId = generatePageId(title);
                
                // Check if page already exists
                pageExists(pageId, (exists) => {
                    if (exists) {
                        showNotification(`Page "${title}" already exists. You can edit it instead.`, 'warning');
                        loadPage(pageId);
                    } else {
                        // Create new page
                        currentPageId = pageId;
                        currentPageData = {
                            title: title,
                            content: `== ${title} ==\n\nWrite your content here.\n\n== References ==\n<references/>`,
                            lastModified: Date.now(),
                            lastModifiedBy: getUserDisplayName(currentUser),
                            lastModifiedById: currentUser.uid,
                            createdAt: Date.now(),
                            createdBy: getUserDisplayName(currentUser)
                        };
                        
                        // Switch to edit mode
                        switchTab('edit');
                    }
                });
            }
        });
    });
    
    // Random page
    randomPageLink.addEventListener('click', (e) => {
        e.preventDefault();
        getRandomPageId(pageId => {
            loadPage(pageId);
        });
    });
    
    // Search functionality
    searchButton.addEventListener('click', (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query) {
            showSearchResults(query);
        }
    });
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query) {
                showSearchResults(query);
            }
        }
    });
    
    // Category links
    categoryLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const category = e.target.getAttribute('data-category');
            showCategoryPages(category);
        });
    });
    
    // Discussion functionality
    newDiscussionButton.addEventListener('click', (e) => {
        e.preventDefault();
        requireAuth(() => {
            toggleNewDiscussionForm(true);
        });
    });
    
    document.getElementById('cancel-discussion-button').addEventListener('click', (e) => {
        e.preventDefault();
        toggleNewDiscussionForm(false);
    });
    
    document.getElementById('post-discussion-button').addEventListener('click', (e) => {
        e.preventDefault();
        submitNewDiscussion();
    });
    
    // Handle links within article content
    articleContent.addEventListener('click', (e) => {
        // Check if the click was on a wiki page link
        if (e.target.tagName === 'A' && e.target.hasAttribute('data-page')) {
            e.preventDefault();
            const pageId = e.target.getAttribute('data-page');
            loadPage(pageId);
        }
    });
}

// Load a page by ID
function loadPage(pageId) {
    if (!pageId) return;
    
    // Show loading indicator
    viewContainer.classList.add('active-tab-content');
    editContainer.style.display = 'none';
    historyContainer.style.display = 'none';
    discussContainer.style.display = 'none';
    loadingIndicator.style.display = 'flex';
    articleContent.innerHTML = '';
    
    // Update URL
    window.history.pushState({pageId}, null, `?page=${pageId}`);
    
    // Update current page ID
    currentPageId = pageId;
    
    // Fetch page from database
    getPage(pageId, (pageData) => {
        // Hide loading indicator
        loadingIndicator.style.display = 'none';
        
        if (pageData) {
            // Page exists
            displayPage(pageData);
            currentPageData = pageData;
            
            // Update tab navigation
            switchTab('read');
        } else {
            // Page doesn't exist
            displayPageNotFound(pageId);
        }
    });
}

// Display a page
function displayPage(pageData) {
    // Update title
    wikiArticleTitle.textContent = pageData.title || 'Untitled Page';
    
    // Convert wiki markup to HTML
    const contentHtml = wikiMarkupToHtml(pageData.content);
    
    // Generate table of contents
    const tocHtml = generateTableOfContents(contentHtml);
    
    // Update content
    articleContent.innerHTML = tocHtml + contentHtml;
    
    // Update last modified info
    if (pageData.lastModified) {
        const formattedDate = formatDate(pageData.lastModified);
        lastModifiedInfo.innerHTML = `Last modified on <time datetime="${new Date(pageData.lastModified).toISOString()}">${formattedDate}</time>`;
        
        if (pageData.lastModifiedBy) {
            lastModifiedInfo.innerHTML += ` by <a href="#" class="wiki-user-link">${pageData.lastModifiedBy}</a>`;
        }
    } else {
        lastModifiedInfo.innerHTML = '';
    }
    
    // Update discussion page title
    discussPageTitle.textContent = pageData.title || 'Untitled Page';
}

// Display "page not found" view
function displayPageNotFound(pageId) {
    // Format page ID for display
    const formattedTitle = pageId.replace(/_/g, ' ');
    
    // Update title
    wikiArticleTitle.textContent = `${formattedTitle} (Page Does Not Exist)`;
    
    // Clear last modified info
    lastModifiedInfo.innerHTML = '';
    
    // Show "page not found" message
    articleContent.innerHTML = `
        <div class="wiki-info-box">
            <h3>This page does not exist yet</h3>
            <p>The page "${formattedTitle}" does not exist yet. You can create it by clicking the "Edit" tab above.</p>
            <p>If you arrived here from another page, please check the link for errors.</p>
        </div>
    `;
    
    // Create empty page data for editing
    currentPageData = {
        title: formattedTitle,
        content: `== ${formattedTitle} ==\n\nWrite your content here.\n\n== References ==\n<references/>`,
        lastModified: null,
        lastModifiedBy: null,
        createdAt: null,
        createdBy: null
    };
}

// Switch between tabs (read, edit, history, discuss)
function switchTab(tabId) {
    if (!tabId || currentTab === tabId) return;
    
    // Update current tab
    currentTab = tabId;
    
    // Update tab styling
    tabLinks.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabId) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Hide all tab containers
    viewContainer.classList.remove('active-tab-content');
    editContainer.style.display = 'none';
    historyContainer.style.display = 'none';
    discussContainer.style.display = 'none';
    
    // Show appropriate container based on tab
    switch (tabId) {
        case 'read':
            viewContainer.classList.add('active-tab-content');
            break;
        case 'edit':
            // Check if user is logged in
            requireAuth(() => {
                editContainer.style.display = 'block';
                initializeEditor(currentPageData);
            });
            break;
        case 'history':
            historyContainer.style.display = 'block';
            loadPageHistory();
            break;
        case 'discuss':
            discussContainer.style.display = 'block';
            loadDiscussions();
            break;
    }
}

// Load page history
function loadPageHistory() {
    // Clear existing history
    historyTableBody.innerHTML = '';
    
    // Show loading message
    historyTableBody.innerHTML = `
        <tr>
            <td colspan="4" class="text-center">Loading history...</td>
        </tr>
    `;
    
    // Fetch history from database
    getPageHistory(currentPageId, (history) => {
        // Clear loading message
        historyTableBody.innerHTML = '';
        
        if (history.length === 0) {
            historyTableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">No revision history found for this page.</td>
                </tr>
            `;
            return;
        }
        
        // Display history
        history.forEach((revision, index) => {
            const row = document.createElement('tr');
            
            const dateCell = document.createElement('td');
            dateCell.textContent = formatDate(revision.timestamp);
            
            const userCell = document.createElement('td');
            userCell.textContent = revision.editorName || 'Anonymous';
            
            const summaryCell = document.createElement('td');
            summaryCell.textContent = revision.editSummary || 'No summary provided';
            
            const actionsCell = document.createElement('td');
            
            // View link
            const viewLink = document.createElement('a');
            viewLink.href = '#';
            viewLink.textContent = 'View';
            viewLink.classList.add('wiki-button', 'wiki-text-button');
            viewLink.addEventListener('click', (e) => {
                e.preventDefault();
                viewRevision(revision);
            });
            
            // Restore link
            const restoreLink = document.createElement('a');
            restoreLink.href = '#';
            restoreLink.textContent = 'Restore';
            restoreLink.classList.add('wiki-button', 'wiki-text-button');
            restoreLink.addEventListener('click', (e) => {
                e.preventDefault();
                requireAuth(() => {
                    restoreRevision(revision);
                });
            });
            
            // Compare link (if not the oldest revision)
            if (index < history.length - 1) {
                const compareLink = document.createElement('a');
                compareLink.href = '#';
                compareLink.textContent = 'Compare';
                compareLink.classList.add('wiki-button', 'wiki-text-button');
                compareLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    compareRevisions(revision, history[index + 1]);
                });
                
                actionsCell.appendChild(compareLink);
            }
            
            actionsCell.appendChild(viewLink);
            actionsCell.appendChild(restoreLink);
            
            row.appendChild(dateCell);
            row.appendChild(userCell);
            row.appendChild(summaryCell);
            row.appendChild(actionsCell);
            
            historyTableBody.appendChild(row);
        });
    });
}

// View a specific revision
function viewRevision(revision) {
    // Create a temporary page data object
    const tempPageData = {
        title: revision.title,
        content: revision.content,
        lastModified: revision.timestamp,
        lastModifiedBy: revision.editorName
    };
    
    // Display the revision
    displayPage(tempPageData);
    
    // Add notice
    articleContent.insertAdjacentHTML('afterbegin', `
        <div class="wiki-warning-box">
            <p><strong>Note:</strong> You are viewing an old revision of this page from ${formatDate(revision.timestamp)}.</p>
            <p><a href="#" onclick="loadPage('${currentPageId}'); return false;">Return to the current version</a></p>
        </div>
    `);
    
    // Switch to view tab
    switchTab('read');
}

// Restore a revision
function restoreRevision(revision) {
    if (confirm('Are you sure you want to restore this revision? This will overwrite the current version.')) {
        // Update current page data
        currentPageData.content = revision.content;
        currentPageData.title = revision.title;
        currentPageData.lastModified = Date.now();
        currentPageData.lastModifiedBy = getUserDisplayName(currentUser);
        currentPageData.lastModifiedById = currentUser.uid;
        currentPageData.editSummary = `Restored revision from ${formatDate(revision.timestamp)}`;
        
        // Save to database
        savePage(currentPageId, currentPageData, (success) => {
            if (success) {
                showNotification('Revision restored successfully', 'success');
                loadPage(currentPageId);
            } else {
                showNotification('Failed to restore revision', 'error');
            }
        });
    }
}

// Compare two revisions
function compareRevisions(newRevision, oldRevision) {
    // Switch to view tab
    switchTab('read');
    
    // Create diff HTML
    const diffTitle = newRevision.title !== oldRevision.title
        ? `<div class="wiki-diff-title"><del>${oldRevision.title}</del> <ins>${newRevision.title}</ins></div>`
        : '';
    
    // Simple line-by-line diff (a real wiki would use a proper diff algorithm)
    const oldLines = oldRevision.content.split('\n');
    const newLines = newRevision.content.split('\n');
    
    let diffContent = '';
    
    // Find the maximum number of lines
    const maxLines = Math.max(oldLines.length, newLines.length);
    
    for (let i = 0; i < maxLines; i++) {
        const oldLine = i < oldLines.length ? oldLines[i] : '';
        const newLine = i < newLines.length ? newLines[i] : '';
        
        if (oldLine !== newLine) {
            diffContent += `<div class="wiki-diff-line"><del>${oldLine}</del> <ins>${newLine}</ins></div>`;
        } else {
            diffContent += `<div class="wiki-diff-line wiki-diff-unchanged">${oldLine}</div>`;
        }
    }
    
    // Display the diff
    articleContent.innerHTML = `
        <div class="wiki-info-box">
            <p><strong>Comparing Revisions:</strong></p>
            <p>Older revision: ${formatDate(oldRevision.timestamp)} by ${oldRevision.editorName || 'Anonymous'}</p>
            <p>Newer revision: ${formatDate(newRevision.timestamp)} by ${newRevision.editorName || 'Anonymous'}</p>
            <p><a href="#" onclick="loadPage('${currentPageId}'); return false;">Return to the current version</a></p>
        </div>
        
        <div class="wiki-diff">
            ${diffTitle}
            <div class="wiki-diff-content">
                ${diffContent}
            </div>
        </div>
    `;
    
    // Update page title
    wikiArticleTitle.textContent = `Comparing Revisions of "${newRevision.title || 'Untitled Page'}"`;
}

// Load discussions for the current page
function loadDiscussions() {
    // Clear existing discussions
    discussionsList.innerHTML = '<div class="wiki-loading-indicator"><div class="wiki-spinner"></div><span>Loading discussions...</span></div>';
    
    // Hide new discussion form
    toggleNewDiscussionForm(false);
    
    // Fetch discussions from database
    getPageDiscussions(currentPageId, (discussions) => {
        // Clear loading indicator
        discussionsList.innerHTML = '';
        
        if (discussions.length === 0) {
            discussionsList.innerHTML = `
                <div class="wiki-info-box">
                    <p>There are no discussions for this page yet.</p>
                    <p>Click "New Topic" to start a discussion.</p>
                </div>
            `;
            return;
        }
        
        // Sort discussions by timestamp (newest first)
        discussions.sort((a, b) => b.timestamp - a.timestamp);
        
        // Display discussions
        discussions.forEach(discussion => {
            const discussionElement = createDiscussionElement(discussion);
            discussionsList.appendChild(discussionElement);
        });
    });
}

// Create a discussion element
function createDiscussionElement(discussion) {
    const element = document.createElement('div');
    element.className = 'wiki-discussion-item';
    
    const header = document.createElement('div');
    header.className = 'wiki-discussion-header';
    
    const title = document.createElement('h3');
    title.className = 'wiki-discussion-title';
    title.textContent = discussion.topic;
    
    const meta = document.createElement('div');
    meta.className = 'wiki-discussion-meta';
    meta.textContent = `${discussion.author || 'Anonymous'}  ${formatDate(discussion.timestamp)}`;
    
    header.appendChild(title);
    header.appendChild(meta);
    
    const content = document.createElement('div');
    content.className = 'wiki-discussion-content';
    content.innerHTML = `<p>${discussion.content}</p>`;
    
    element.appendChild(header);
    element.appendChild(content);
    
    // Add replies if they exist
    if (discussion.replies) {
        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'wiki-discussion-replies';
        
        Object.values(discussion.replies).forEach(reply => {
            const replyElement = document.createElement('div');
            replyElement.className = 'wiki-discussion-reply';
            
            const replyMeta = document.createElement('div');
            replyMeta.className = 'wiki-discussion-meta';
            replyMeta.textContent = `${reply.author || 'Anonymous'}  ${formatDate(reply.timestamp)}`;
            
            const replyContent = document.createElement('div');
            replyContent.className = 'wiki-discussion-content';
            replyContent.innerHTML = `<p>${reply.content}</p>`;
            
            replyElement.appendChild(replyMeta);
            replyElement.appendChild(replyContent);
            
            repliesContainer.appendChild(replyElement);
        });
        
        element.appendChild(repliesContainer);
    }
    
    // Add reply button
    const actions = document.createElement('div');
    actions.className = 'wiki-discussion-actions';
    
    const replyButton = document.createElement('button');
    replyButton.className = 'wiki-button';
    replyButton.textContent = 'Reply';
    replyButton.addEventListener('click', () => {
        requireAuth(() => {
            // Show reply form
            const replyForm = document.createElement('div');
            replyForm.className = 'wiki-reply-form';
            replyForm.innerHTML = `
                <div class="form-group">
                    <textarea id="reply-content-${discussion.id}" placeholder="Write your reply..."></textarea>
                </div>
                <div class="wiki-discussion-actions">
                    <button class="wiki-button cancel-reply-button">Cancel</button>
                    <button class="wiki-button wiki-button-primary submit-reply-button">Submit Reply</button>
                </div>
            `;
            
            // Add form after actions
            actions.insertAdjacentElement('afterend', replyForm);
            
            // Focus on textarea
            document.getElementById(`reply-content-${discussion.id}`).focus();
            
            // Add cancel handler
            replyForm.querySelector('.cancel-reply-button').addEventListener('click', () => {
                replyForm.remove();
            });
            
            // Add submit handler
            replyForm.querySelector('.submit-reply-button').addEventListener('click', () => {
                const replyContent = document.getElementById(`reply-content-${discussion.id}`).value.trim();
                
                if (replyContent) {
                    const replyData = {
                        content: replyContent,
                        author: getUserDisplayName(currentUser),
                        authorId: currentUser.uid,
                        timestamp: Date.now()
                    };
                    
                    addDiscussionReply(currentPageId, discussion.id, replyData, (success) => {
                        if (success) {
                            showNotification('Reply added successfully', 'success');
                            loadDiscussions();
                        } else {
                            showNotification('Failed to add reply', 'error');
                        }
                    });
                } else {
                    showNotification('Reply content cannot be empty', 'warning');
                }
            });
        });
    });
    
    actions.appendChild(replyButton);
    element.appendChild(actions);
    
    return element;
}

// Toggle the new discussion form
function toggleNewDiscussionForm(show) {
    newDiscussionForm.style.display = show ? 'block' : 'none';
    
    if (show) {
        // Reset form
        document.getElementById('discussion-topic').value = '';
        document.getElementById('discussion-content').value = '';
        
        // Focus on topic field
        document.getElementById('discussion-topic').focus();
    }
}

// Submit a new discussion
function submitNewDiscussion() {
    const topic = document.getElementById('discussion-topic').value.trim();
    const content = document.getElementById('discussion-content').value.trim();
    
    if (!topic || !content) {
        showNotification('Please provide both a topic and content for your discussion', 'warning');
        return;
    }
    
    const discussionData = {
        topic: topic,
        content: content,
        author: getUserDisplayName(currentUser),
        authorId: currentUser.uid,
        timestamp: Date.now(),
        pageId: currentPageId,
        pageTitle: currentPageData.title
    };
    
    addDiscussion(currentPageId, discussionData, (success) => {
        if (success) {
            showNotification('Discussion added successfully', 'success');
            toggleNewDiscussionForm(false);
            loadDiscussions();
        } else {
            showNotification('Failed to add discussion', 'error');
        }
    });
}

// Show search results
function showSearchResults(query) {
    // Switch to view tab
    switchTab('read');
    
    // Update title
    wikiArticleTitle.textContent = `Search Results: "${query}"`;
    
    // Clear last modified info
    lastModifiedInfo.innerHTML = '';
    
    // Show loading message
    articleContent.innerHTML = '<div class="wiki-loading-indicator"><div class="wiki-spinner"></div><span>Searching...</span></div>';
    
    // Perform search
    searchWikiContent(query, (results) => {
        if (results.length === 0) {
            articleContent.innerHTML = `
                <div class="wiki-info-box">
                    <h3>No results found</h3>
                    <p>Your search for "${query}" did not match any pages.</p>
                    <p>Suggestions:</p>
                    <ul>
                        <li>Make sure all words are spelled correctly</li>
                        <li>Try different keywords</li>
                        <li>Try more general keywords</li>
                    </ul>
                    <p><a href="#" id="create-search-page">Create a page titled "${query}"</a></p>
                </div>
            `;
            
            // Add event listener for creating a page
            document.getElementById('create-search-page').addEventListener('click', (e) => {
                e.preventDefault();
                requireAuth(() => {
                    const pageId = generatePageId(query);
                    
                    // Check if page already exists
                    pageExists(pageId, (exists) => {
                        if (exists) {
                            showNotification(`Page "${query}" already exists.`, 'warning');
                            loadPage(pageId);
                        } else {
                            // Create new page
                            currentPageId = pageId;
                            currentPageData = {
                                title: query,
                                content: `== ${query} ==\n\nWrite your content here.\n\n== References ==\n<references/>`,
                                lastModified: Date.now(),
                                lastModifiedBy: getUserDisplayName(currentUser),
                                lastModifiedById: currentUser.uid,
                                createdAt: Date.now(),
                                createdBy: getUserDisplayName(currentUser)
                            };
                            
                            // Switch to edit mode
                            switchTab('edit');
                        }
                    });
                });
            });
            
            return;
        }
        
        // Display results
        let resultsHtml = `<h2>Search Results: "${query}"</h2>`;
        resultsHtml += `<p>Found ${results.length} result${results.length !== 1 ? 's' : ''}:</p>`;
        
        resultsHtml += '<div class="wiki-search-results">';
        
        results.forEach(result => {
            resultsHtml += `
                <div class="wiki-search-result">
                    <h3><a href="#" data-page="${result.id}">${result.title}</a></h3>
                    <p>${highlightSearchQuery(result.snippet, query)}</p>
                    <div class="wiki-search-meta">Last modified: ${formatDate(result.lastModified)}</div>
                </div>
            `;
        });
        
        resultsHtml += '</div>';
        
        articleContent.innerHTML = resultsHtml;
    });
}

// Highlight search query in text
function highlightSearchQuery(text, query) {
    if (!text || !query) return text;
    
    // Simple highlighting (not regex-based for safety)
    const lowerText = text.toLowerCase();
    const lowerQuery = query.toLowerCase();
    
    let result = '';
    let lastIndex = 0;
    let index = lowerText.indexOf(lowerQuery);
    
    while (index !== -1) {
        // Add text before the match
        result += text.substring(lastIndex, index);
        
        // Add highlighted match
        result += `<mark>${text.substring(index, index + query.length)}</mark>`;
        
        // Move to after the match
        lastIndex = index + query.length;
        
        // Find next match
        index = lowerText.indexOf(lowerQuery, lastIndex);
    }
    
    // Add remaining text
    result += text.substring(lastIndex);
    
    return result;
}

// Show pages in a category
function showCategoryPages(category) {
    // Switch to view tab
    switchTab('read');
    
    // Update title
    wikiArticleTitle.textContent = `Category: ${category}`;
    
    // Clear last modified info
    lastModifiedInfo.innerHTML = '';
    
    // Show loading message
    articleContent.innerHTML = '<div class="wiki-loading-indicator"><div class="wiki-spinner"></div><span>Loading category pages...</span></div>';
    
    // Fetch pages in category
    getPagesByCategory(category, (pages) => {
        if (pages.length === 0) {
            articleContent.innerHTML = `
                <div class="wiki-info-box">
                    <h3>Category: ${category}</h3>
                    <p>There are no pages in this category yet.</p>
                    <p>You can add pages to this category by including <code>[[Category:${category}]]</code> in the page content.</p>
                </div>
            `;
            return;
        }
        
        // Sort pages by title
        pages.sort((a, b) => a.title.localeCompare(b.title));
        
        // Display category pages
        let categoryHtml = `<h2>Category: ${category}</h2>`;
        categoryHtml += `<p>The following ${pages.length} page${pages.length !== 1 ? 's are' : ' is'} in this category:</p>`;
        
        categoryHtml += '<ul class="wiki-category-pages">';
        
        pages.forEach(page => {
            categoryHtml += `
                <li><a href="#" data-page="${page.id}">${page.title}</a></li>
            `;
        });
        
        categoryHtml += '</ul>';
        
        articleContent.innerHTML = categoryHtml;
    });
}

/**
 * Editor functionality for Minnesota Then Wiki
 */

// DOM Elements
const wikiEditor = document.getElementById('wiki-editor');
const editSummary = document.getElementById('edit-summary');
const saveButton = document.getElementById('save-button');
const previewButton = document.getElementById('preview-button');
const previewContainer = document.getElementById('wiki-preview-container');
const previewContent = document.getElementById('wiki-preview-content');
const editToolbar = document.querySelector('.wiki-edit-toolbar');

// State variables
let isPreviewVisible = false;
let originalContent = '';

// Initialize the editor
function initializeEditor(pageData) {
    // Set initial content
    if (pageData) {
        wikiEditor.value = pageData.content || '';
        originalContent = pageData.content || '';
    } else {
        wikiEditor.value = '';
        originalContent = '';
    }
    
    // Clear edit summary
    editSummary.value = '';
    
    // Hide preview
    hidePreview();
    
    // Focus on editor
    setTimeout(() => {
        wikiEditor.focus();
    }, 100);
}

// Initialize editor event listeners
function initEditorEventListeners() {
    // Save button
    saveButton.addEventListener('click', saveChanges);
    
    // Preview button
    previewButton.addEventListener('click', togglePreview);
    
    // Editor toolbar buttons
    editToolbar.addEventListener('click', (e) => {
        if (e.target.closest('button')) {
            const button = e.target.closest('button');
            const format = button.getAttribute('data-format');
            
            if (format) {
                e.preventDefault();
                insertFormat(format);
            }
        }
    });
    
    // Live preview (debounced)
    wikiEditor.addEventListener('input', debounce(() => {
        if (isPreviewVisible) {
            updatePreview();
        }
    }, 500));
    
    // Check for unsaved changes before leaving
    window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges()) {
            // Standard message (browsers will display their own message)
            const message = 'You have unsaved changes. Are you sure you want to leave?';
            e.returnValue = message;
            return message;
        }
    });
}

// Insert formatting at cursor position
function insertFormat(format) {
    const start = wikiEditor.selectionStart;
    const end = wikiEditor.selectionEnd;
    const selectedText = wikiEditor.value.substring(start, end);
    
    let insertedText = '';
    let cursorOffset = 0;
    
    switch (format) {
        case 'heading':
            if (selectedText) {
                insertedText = `== ${selectedText} ==`;
                cursorOffset = 3;
            } else {
                insertedText = '== Heading ==';
                cursorOffset = 3;
            }
            break;
            
        case 'subheading':
            if (selectedText) {
                insertedText = `=== ${selectedText} ===`;
                cursorOffset = 4;
            } else {
                insertedText = '=== Subheading ===';
                cursorOffset = 4;
            }
            break;
            
        case 'bold':
            if (selectedText) {
                insertedText = `**${selectedText}**`;
                cursorOffset = 2;
            } else {
                insertedText = '**bold text**';
                cursorOffset = 2;
            }
            break;
            
        case 'italic':
            if (selectedText) {
                insertedText = `*${selectedText}*`;
                cursorOffset = 1;
            } else {
                insertedText = '*italic text*';
                cursorOffset = 1;
            }
            break;
            
        case 'link':
            if (selectedText) {
                insertedText = `[[${selectedText}]]`;
                cursorOffset = 2;
            } else {
                insertedText = '[[Page Name]]';
                cursorOffset = 2;
            }
            break;
            
        case 'list':
            if (selectedText) {
                // Convert each line to a list item
                const lines = selectedText.split('\n');
                insertedText = lines.map(line => `* ${line}`).join('\n');
            } else {
                insertedText = '* List item\n* Another item';
            }
            cursorOffset = 2;
            break;
            
        case 'reference':
            if (selectedText) {
                insertedText = `<ref>${selectedText}</ref>`;
                cursorOffset = 5;
            } else {
                insertedText = '<ref>Citation</ref>';
                cursorOffset = 5;
            }
            break;
            
        case 'image':
            insertedText = '[[Image:https://example.com/image.jpg|Image Description]]';
            cursorOffset = 8;
            break;
    }
    
    // Insert the text
    const newValue = wikiEditor.value.substring(0, start) + insertedText + wikiEditor.value.substring(end);
    wikiEditor.value = newValue;
    
    // Set cursor position
    if (selectedText) {
        // If text was selected, place cursor at the end of the inserted text
        wikiEditor.selectionStart = start + insertedText.length;
        wikiEditor.selectionEnd = start + insertedText.length;
    } else {
        // Otherwise, position cursor appropriately within the inserted text
        wikiEditor.selectionStart = start + cursorOffset;
        wikiEditor.selectionEnd = start + insertedText.length - cursorOffset;
    }
    
    // Focus back on the editor
    wikiEditor.focus();
    
    // Update preview if visible
    if (isPreviewVisible) {
        updatePreview();
    }
}

// Toggle preview visibility
function togglePreview() {
    if (isPreviewVisible) {
        hidePreview();
        previewButton.textContent = 'Preview';
    } else {
        showPreview();
        previewButton.textContent = 'Hide Preview';
    }
}

// Show preview
function showPreview() {
    updatePreview();
    previewContainer.style.display = 'block';
    isPreviewVisible = true;
    
    // Scroll to preview if not visible
    if (!isInViewport(previewContainer)) {
        previewContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

// Hide preview
function hidePreview() {
    previewContainer.style.display = 'none';
    isPreviewVisible = false;
}

// Update preview content
function updatePreview() {
    const content = wikiEditor.value;
    const html = wikiMarkupToHtml(content);
    previewContent.innerHTML = html;
}

// Save changes
function saveChanges() {
    // Check if there are changes
    if (!hasUnsavedChanges()) {
        showNotification('No changes to save', 'info');
        return;
    }
    
    // Get current user
    const user = getCurrentUser();
    if (!user) {
        showNotification('You must be logged in to save changes', 'warning');
        return;
    }
    
    // Update page data
    const pageData = {
        ...currentPageData,
        content: wikiEditor.value,
        lastModified: Date.now(),
        lastModifiedBy: getUserDisplayName(user),
        lastModifiedById: user.uid,
        editSummary: editSummary.value.trim() || 'Updated page'
    };
    
    // Show saving indicator
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    // Save to database
    savePage(currentPageId, pageData, (success, errorMessage) => {
        // Reset button
        saveButton.disabled = false;
        saveButton.textContent = 'Save Changes';
        
        if (success) {
            // Update current page data
            currentPageData = pageData;
            originalContent = pageData.content;
            
            // Show success message
            showNotification('Page saved successfully', 'success');
            
            // Switch to view tab
            switchTab('read');
            
            // Load the updated page
            loadPage(currentPageId);
        } else {
            // Show error message
            showNotification(`Failed to save page: ${errorMessage || 'Unknown error'}`, 'error');
        }
    });
}

// Check if there are unsaved changes
function hasUnsavedChanges() {
    return wikiEditor.value !== originalContent;
}

// Set up the editor when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initEditorEventListeners();
});

/**
 * Main entry point for Minnesota Then Wiki
 */

// Initialize the application when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    // Initialize components
    initAuth();
    initWiki();
    
    // Handle mobile menu toggle
    const mobileMenuBtn = document.querySelector('.mnthen-mobile-menu');
    const mainNav = document.querySelector('.mnthen-nav');
    
    if (mobileMenuBtn && mainNav) {
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenuBtn.classList.toggle('active');
            mainNav.classList.toggle('active');
        });
    }
    
    // Handle dropdowns in the header
    const dropdownBtns = document.querySelectorAll('.mnthen-dropdown-btn');
    
    dropdownBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Toggle dropdown
            const isActive = btn.classList.contains('active');
            
            // Close all dropdowns first
            dropdownBtns.forEach(otherBtn => {
                otherBtn.classList.remove('active');
                const content = otherBtn.nextElementSibling;
                if (content && content.classList.contains('mnthen-dropdown-content')) {
                    content.classList.remove('active');
                }
            });
            
            // Toggle the clicked dropdown
            if (!isActive) {
                btn.classList.add('active');
                const content = btn.nextElementSibling;
                if (content && content.classList.contains('mnthen-dropdown-content')) {
                    content.classList.add('active');
                }
            }
            
            e.stopPropagation();
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
        dropdownBtns.forEach(btn => {
            btn.classList.remove('active');
            const content = btn.nextElementSibling;
            if (content && content.classList.contains('mnthen-dropdown-content')) {
                content.classList.remove('active');
            }
        });
    });
    
    // Handle browser history navigation
    window.addEventListener('popstate', (e) => {
        if (e.state && e.state.pageId) {
            loadPage(e.state.pageId);
        } else {
            loadPage('Main_Page');
        }
    });
    
    // Create notification container
    const notificationContainer = document.createElement('div');
    notificationContainer.id = 'wiki-notification';
    notificationContainer.className = 'wiki-notification';
    document.body.appendChild(notificationContainer);
    
    // Add CSS for notification
    const notificationStyle = document.createElement('style');
    notificationStyle.textContent = `
        .wiki-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            font-size: 14px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .wiki-notification-info {
            background-color: #3b82f6;
        }
        
        .wiki-notification-success {
            background-color: #16a34a;
        }
        
        .wiki-notification-warning {
            background-color: #f59e0b;
        }
        
        .wiki-notification-error {
            background-color: #dc2626;
        }
        
        .wiki-notification-show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .wiki-notification-hide {
            transform: translateY(100px);
            opacity: 0;
        }
    `;
    document.head.appendChild(notificationStyle);
    
    // Add additional CSS for wiki diff
    const diffStyle = document.createElement('style');
    diffStyle.textContent = `
        .wiki-diff {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .wiki-diff-title {
            padding: 10px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        
        .wiki-diff-content {
            padding: 10px;
        }
        
        .wiki-diff-line {
            padding: 2px 0;
            line-height: 1.5;
        }
        
        .wiki-diff-unchanged {
            color: #666;
        }
        
        .wiki-diff del {
            background-color: #fee2e2;
            color: #dc2626;
            text-decoration: none;
            padding: 0 2px;
        }
        
        .wiki-diff ins {
            background-color: #dcfce7;
            color: #16a34a;
            text-decoration: none;
            padding: 0 2px;
        }
    `;
    document.head.appendChild(diffStyle);
    
    // Add additional CSS for search results
    const searchStyle = document.createElement('style');
    searchStyle.textContent = `
        .wiki-search-results {
            margin-top: 20px;
        }
        
        .wiki-search-result {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .wiki-search-result:last-child {
            border-bottom: none;
        }
        
        .wiki-search-result h3 {
            margin-bottom: 5px;
        }
        
        .wiki-search-meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .wiki-search-result mark {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0 2px;
            border-radius: 2px;
        }
    `;
    document.head.appendChild(searchStyle);
    
    // Add styles for discussion features
    const discussionStyle = document.createElement('style');
    discussionStyle.textContent = `
        .wiki-discussion-replies {
            margin-left: 20px;
            border-left: 3px solid #ddd;
            padding-left: 20px;
        }
        
        .wiki-discussion-reply {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .wiki-reply-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .wiki-reply-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
    `;
    document.head.appendChild(discussionStyle);
});
</script>
</body>
</html>
