<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minnesota Then - History Wiki</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  
  <style>
    :root {
      /* Color Palette */
      --color-primary: #1a365d;
      --color-primary-light: #2a4a7f;
      --color-primary-dark: #0f2340;
      --color-secondary: #718f94;
      --color-secondary-light: #92abaf;
      --color-secondary-dark: #5a7276;
      --color-accent: #d3a73b;
      --color-accent-light: #e6c675;
      --color-accent-dark: #b28a2e;
      --color-success: #2c9f5e;
      --color-warning: #e6a23c;
      --color-error: #b33939;
      --color-text-primary: #333333;
      --color-text-secondary: #6b7280;
      --color-text-tertiary: #9ca3af;
      --color-background: #ffffff;
      --color-background-alt: #f9fafb;
      --color-border: #e5e7eb;
      --color-border-dark: #d1d5db;
      
      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 24px;
      --space-6: 32px;
      --space-8: 48px;
      --space-10: 64px;
      
      /* Typography */
      --font-heading: 'Merriweather', serif;
      --font-body: 'Open Sans', sans-serif;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      
      /* Transitions */
      --transition-fast: 150ms ease-in-out;
      --transition-normal: 250ms ease-in-out;
      --transition-slow: 350ms ease-in-out;
    }
    
    /* Dark Mode Colors */
    .dark-mode {
      --color-primary: #3b82f6;
      --color-primary-light: #60a5fa;
      --color-primary-dark: #2563eb;
      --color-secondary: #64748b;
      --color-secondary-light: #94a3b8;
      --color-secondary-dark: #475569;
      --color-accent: #eab308;
      --color-accent-light: #fde047;
      --color-accent-dark: #ca8a04;
      --color-text-primary: #f3f4f6;
      --color-text-secondary: #d1d5db;
      --color-text-tertiary: #9ca3af;
      --color-background: #111827;
      --color-background-alt: #1f2937;
      --color-border: #374151;
      --color-border-dark: #4b5563;
    }
    
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-body);
      font-size: 16px;
      line-height: 1.5;
      color: var(--color-text-primary);
      background-color: var(--color-background);
      transition: background-color var(--transition-normal);
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-heading);
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: var(--space-4);
      color: var(--color-primary);
    }
    
    h1 {
      font-size: 2.25rem;
      margin-bottom: var(--space-6);
    }
    
    h2 {
      font-size: 1.8rem;
      margin-top: var(--space-8);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--color-border);
    }
    
    h3 {
      font-size: 1.5rem;
      margin-top: var(--space-6);
      margin-bottom: var(--space-3);
    }
    
    h4 {
      font-size: 1.25rem;
      margin-top: var(--space-5);
    }
    
    p {
      margin-bottom: var(--space-4);
    }
    
    a {
      color: var(--color-primary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    
    a:hover {
      color: var(--color-primary-light);
      text-decoration: underline;
    }
    
    ul, ol {
      margin-bottom: var(--space-4);
      padding-left: var(--space-5);
    }
    
    li {
      margin-bottom: var(--space-2);
    }
    
    button {
      cursor: pointer;
      font-family: var(--font-body);
      font-size: 1rem;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background-color: var(--color-background);
      color: var(--color-text-primary);
      transition: all var(--transition-fast);
    }
    
    button:hover {
      background-color: var(--color-background-alt);
    }
    
    input, textarea {
      font-family: var(--font-body);
      font-size: 1rem;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background-color: var(--color-background);
      color: var(--color-text-primary);
      width: 100%;
      transition: border-color var(--transition-fast);
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      border: 1px solid transparent;
    }
    
    .btn-primary {
      background-color: var(--color-primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--color-primary-light);
      text-decoration: none;
    }
    
    .btn-secondary {
      background-color: var(--color-secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: var(--color-secondary-light);
      text-decoration: none;
    }
    
    .btn-outline {
      border: 1px solid var(--color-border);
      background-color: transparent;
    }
    
    .btn-outline:hover {
      background-color: var(--color-background-alt);
      text-decoration: none;
    }
    
    .btn-sm {
      font-size: 0.875rem;
      padding: var(--space-1) var(--space-3);
    }
    
    .btn-lg {
      font-size: 1.125rem;
      padding: var(--space-3) var(--space-5);
    }
    
    /* Container */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--space-4);
    }
    
    /* Layout */
    .layout {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }
    
    .layout-content {
      display: flex;
      flex: 1;
    }
    
    /* Header */
    .header {
      background-color: var(--color-primary);
      color: white;
      padding: var(--space-4) 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-md);
    }
    
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-title {
      margin: 0;
      font-size: 1.5rem;
      color: white;
    }
    
    .header-title a {
      color: white;
      text-decoration: none;
    }
    
    .header-nav {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .header-nav-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
    }
    
    .header-user {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .header-btn {
      color: white;
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.4);
      transition: all var(--transition-fast);
    }
    
    .header-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* Sidebar */
    .sidebar {
      width: 280px;
      background-color: var(--color-background-alt);
      border-right: 1px solid var(--color-border);
      transition: transform var(--transition-normal);
      padding: var(--space-4);
    }
    
    .sidebar-section {
      margin-bottom: var(--space-6);
    }
    
    .sidebar-heading {
      font-size: 1.25rem;
      color: var(--color-primary);
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--color-border);
    }
    
    .sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-nav-item {
      margin-bottom: var(--space-2);
    }
    
    .sidebar-nav-link {
      display: block;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      color: var(--color-text-primary);
      transition: all var(--transition-fast);
    }
    
    .sidebar-nav-link:hover {
      background-color: var(--color-border);
      text-decoration: none;
    }
    
    .sidebar-nav-link.active {
      background-color: var(--color-primary-light);
      color: white;
    }
    
    .sidebar-search {
      margin-top: var(--space-3);
    }
    
    .search-form {
      display: flex;
      gap: var(--space-2);
    }
    
    .search-input {
      flex: 1;
    }
    
    /* Main Content */
    .main {
      flex: 1;
      padding: var(--space-6);
      min-width: 0;
    }
    
    .page-header {
      margin-bottom: var(--space-6);
    }
    
    .page-title {
      margin-bottom: var(--space-2);
    }
    
    .page-meta {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin-bottom: var(--space-4);
    }
    
    .page-actions {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }
    
    /* Article Styling */
    .article {
      max-width: 800px;
    }
    
    .article-section {
      margin-bottom: var(--space-6);
    }
    
    .article-image {
      margin: var(--space-4) 0;
    }
    
    .article-image.float-right {
      float: right;
      margin-left: var(--space-4);
      margin-bottom: var(--space-4);
      max-width: 40%;
    }
    
    .article-image.float-left {
      float: left;
      margin-right: var(--space-4);
      margin-bottom: var(--space-4);
      max-width: 40%;
    }
    
    .article-image img {
      width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
    }
    
    .article-image-caption {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      text-align: center;
      margin-top: var(--space-2);
      font-style: italic;
    }
    
    .article-toc {
      background-color: var(--color-background-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
    }
    
    .article-toc-title {
      font-size: 1.125rem;
      margin-bottom: var(--space-3);
      font-weight: 600;
    }
    
    .article-toc-list {
      list-style: none;
      padding-left: 0;
    }
    
    .article-toc-item {
      margin-bottom: var(--space-2);
    }
    
    .article-toc-link {
      display: block;
      padding: var(--space-1) 0;
      color: var(--color-text-primary);
    }
    
    .article-toc-sublist {
      list-style: none;
      padding-left: var(--space-4);
      margin-top: var(--space-1);
    }
    
    /* Edit Section */
    .edit-section {
      margin-top: var(--space-6);
      border-top: 1px solid var(--color-border);
      padding-top: var(--space-6);
    }
    
    .edit-header {
      margin-bottom: var(--space-4);
    }
    
    .edit-form-group {
      margin-bottom: var(--space-4);
    }
    
    .edit-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 500;
    }
    
    .edit-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-5);
    }
    
    .edit-preview {
      margin-top: var(--space-6);
      padding: var(--space-4);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-background-alt);
    }
    
    .edit-preview-header {
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--color-border);
    }
    
    /* Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }
    
    .modal-backdrop.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background-color: var(--color-background);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      opacity: 0;
      transition: all var(--transition-normal);
    }
    
    .modal-backdrop.active .modal {
      transform: translateY(0);
      opacity: 1;
    }
    
    .modal-header {
      padding: var(--space-4);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      margin: 0;
      font-size: 1.25rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      color: var(--color-text-secondary);
    }
    
    .modal-body {
      padding: var(--space-4);
    }
    
    .modal-footer {
      padding: var(--space-4);
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
    }
    
    /* Alert */
    .alert {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
    }
    
    .alert-info {
      background-color: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--color-primary);
    }
    
    .alert-success {
      background-color: rgba(44, 159, 94, 0.1);
      border-left: 4px solid var(--color-success);
    }
    
    .alert-warning {
      background-color: rgba(230, 162, 60, 0.1);
      border-left: 4px solid var(--color-warning);
    }
    
    .alert-error {
      background-color: rgba(179, 57, 57, 0.1);
      border-left: 4px solid var(--color-error);
    }
    
    /* Footer */
    .footer {
      background-color: var(--color-background-alt);
      border-top: 1px solid var(--color-border);
      padding: var(--space-6) 0;
    }
    
    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .footer-copyright {
      color: var(--color-text-secondary);
    }
    
    .footer-links {
      display: flex;
      gap: var(--space-4);
    }
    
    .footer-link {
      color: var(--color-text-secondary);
    }
    
    /* Utilities */
    .hidden {
      display: none !important;
    }
    
    .clearfix::after {
      content: "";
      display: table;
      clear: both;
    }
    
    /* Media Queries */
    @media (max-width: 992px) {
      .layout-content {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--color-border);
      }
      
      .main {
        padding: var(--space-4);
      }
    }
    
    @media (max-width: 768px) {
      .header-nav-toggle {
        display: block;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 280px;
        z-index: 40;
        transform: translateX(-100%);
        border-right: 1px solid var(--color-border);
        border-bottom: none;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .article-image.float-right,
      .article-image.float-left {
        float: none;
        margin: var(--space-4) 0;
        max-width: 100%;
      }
    }
    
    @media (max-width: 576px) {
      .header-title {
        font-size: 1.25rem;
      }
      
      .page-actions {
        flex-direction: column;
      }
      
      .page-actions .btn {
        width: 100%;
      }
    }
    
    /* Dark Mode Toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .slide-down {
      animation: slideDown 0.3s ease-in-out;
    }
    
    /* Table of Contents */
    .toc-container {
      position: sticky;
      top: 80px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      padding-right: var(--space-4);
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Header -->
    <header class="header">
      <div class="container header-container">
        <h1 class="header-title"><a href="#" data-page="home">Minnesota Then</a></h1>
        
        <button class="header-nav-toggle" id="sidebar-toggle">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        
        <div class="header-nav">
          <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
          
          <div class="header-user" id="auth-status">
            <button class="btn header-btn" id="login-btn">Login</button>
            <button class="btn header-btn" id="signup-btn">Sign Up</button>
          </div>
        </div>
      </div>
    </header>
    
    <div class="layout-content">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <h3 class="sidebar-heading">Navigation</h3>
          <ul class="sidebar-nav" id="sidebar-nav">
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link active" data-page="home">Home</a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" data-page="recent-changes">Recent Changes</a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" data-page="random-page">Random Page</a>
            </li>
            <li class="sidebar-nav-item" id="create-page-item" style="display: none;">
              <a href="#" class="sidebar-nav-link" data-page="create-page">Create New Page</a>
            </li>
          </ul>
        </div>
        
        <div class="sidebar-section">
          <h3 class="sidebar-heading">Search</h3>
          <div class="sidebar-search">
            <form class="search-form" id="search-form">
              <input 
                type="text" 
                class="search-input" 
                id="search-input" 
                placeholder="Search pages..."
              >
              <button type="submit" class="btn btn-primary btn-sm" id="search-btn">Go</button>
            </form>
          </div>
        </div>
        
        <div class="sidebar-section">
          <h3 class="sidebar-heading">Featured Pages</h3>
          <ul class="sidebar-nav" id="featured-pages">
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" data-page="minnesota-geography">Minnesota Geography</a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" data-page="early-settlers">Early Settlers</a>
            </li>
            <li class="sidebar-nav-item">
              <a href="#" class="sidebar-nav-link" data-page="native-peoples">Native Peoples</a>
            </li>
          </ul>
        </div>
      </aside>
      
      <!-- Main Content -->
      <main class="main">
        <div id="content-area">
          <header class="page-header">
            <h1 class="page-title" id="page-title">Welcome to Minnesota Then Wiki</h1>
            <div class="page-meta" id="page-meta"></div>
          </header>
          
          <div class="page-actions" id="page-actions" style="display: none;">
            <button class="btn btn-primary" id="edit-page-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Edit Page
            </button>
            <button class="btn btn-outline" id="history-page-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              View History
            </button>
          </div>
          
          <article class="article clearfix" id="page-content">
            <p>Loading content...</p>
          </article>
        </div>
        
        <div class="edit-section" id="edit-section" style="display: none;">
          <div class="edit-header">
            <h2>Edit Page</h2>
            <p>Use Markdown syntax for formatting. Preview will update as you type.</p>
          </div>
          
          <form id="edit-form">
            <div class="edit-form-group">
              <label for="edit-title" class="edit-label">Title</label>
              <input type="text" id="edit-title" class="edit-input" required>
            </div>
            
            <div class="edit-form-group">
              <label for="edit-content" class="edit-label">Content</label>
              <textarea id="edit-content" class="edit-input" rows="15" required></textarea>
              <div class="edit-markdown-help">
                <details>
                  <summary>Markdown Help</summary>
                  <div class="mt-2">
                    <p><code># Heading 1</code> - Creates a main heading</p>
                    <p><code>## Heading 2</code> - Creates a sub-heading</p>
                    <p><code>**bold text**</code> - Makes text bold</p>
                    <p><code>*italic text*</code> - Makes text italic</p>
                    <p><code>[link text](url)</code> - Creates a link</p>
                    <p><code>![alt text](image-url)</code> - Adds an image</p>
                    <p><code>- item</code> - Creates a bullet point</p>
                    <p><code>1. item</code> - Creates a numbered list</p>
                    <p><code>---</code> - Adds a horizontal rule</p>
                  </div>
                </details>
              </div>
            </div>
            
            <div class="edit-form-group">
              <label for="edit-summary" class="edit-label">Edit Summary</label>
              <input type="text" id="edit-summary" class="edit-input" placeholder="Briefly describe your changes">
            </div>
            
            <div class="edit-preview">
              <div class="edit-preview-header">
                <h3>Preview</h3>
              </div>
              <div id="edit-preview-content"></div>
            </div>
            
            <div class="edit-actions">
              <button type="submit" class="btn btn-primary">Submit for Approval</button>
              <button type="button" class="btn btn-outline" id="cancel-edit">Cancel</button>
            </div>
          </form>
        </div>
      </main>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
      <div class="container footer-content">
        <div class="footer-copyright">
          © 2023 Minnesota Then. All rights reserved.
        </div>
        <div class="footer-links">
          <a href="#" class="footer-link" data-page="about">About</a>
          <a href="#" class="footer-link" data-page="privacy">Privacy</a>
          <a href="#" class="footer-link" data-page="terms">Terms</a>
          <a href="#" class="footer-link" data-page="contact">Contact</a>
        </div>
      </div>
    </footer>
  </div>
  
  <!-- Auth Modal -->
  <div class="modal-backdrop" id="auth-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="auth-modal-title">Login</h3>
        <button type="button" class="modal-close" id="auth-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="auth-form">
          <div class="edit-form-group">
            <label for="auth-email" class="edit-label">Email</label>
            <input type="email" id="auth-email" required>
          </div>
          <div class="edit-form-group">
            <label for="auth-password" class="edit-label">Password</label>
            <input type="password" id="auth-password" required>
          </div>
          <div id="auth-error" class="alert alert-error hidden"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="switch-auth-mode">Need to sign up?</button>
        <button type="submit" form="auth-form" class="btn btn-primary" id="auth-submit-btn">Login</button>
      </div>
    </div>
  </div>
  
  <!-- History Modal -->
  <div class="modal-backdrop" id="history-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Page History</h3>
        <button type="button" class="modal-close" id="history-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="history-content"></div>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
      authDomain: "mnthen-3151d.firebaseapp.com",
      projectId: "mnthen-3151d",
      storageBucket: "mnthen-3151d.appspot.com",
      messagingSenderId: "416231360428",
      appId: "1:416231360428:web:36f69cc231be2d84a8dc09"
    };
    
    // Initialize Firebase
    let firebaseApp;
    if (!firebase.apps.length) {
      firebaseApp = firebase.initializeApp(firebaseConfig);
    } else {
      firebaseApp = firebase.app();
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    // DOM Elements
    // Auth-related elements
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const authStatus = document.getElementById('auth-status');
    const authModal = document.getElementById('auth-modal');
    const authModalTitle = document.getElementById('auth-modal-title');
    const authModalClose = document.getElementById('auth-modal-close');
    const authForm = document.getElementById('auth-form');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const switchAuthMode = document.getElementById('switch-auth-mode');
    const authError = document.getElementById('auth-error');
    
    // Content-related elements
    const pageTitle = document.getElementById('page-title');
    const pageContent = document.getElementById('page-content');
    const pageMeta = document.getElementById('page-meta');
    const pageActions = document.getElementById('page-actions');
    const editSection = document.getElementById('edit-section');
    const editForm = document.getElementById('edit-form');
    const editTitle = document.getElementById('edit-title');
    const editContent = document.getElementById('edit-content');
    const editPreviewContent = document.getElementById('edit-preview-content');
    const editSummary = document.getElementById('edit-summary');
    const cancelEdit = document.getElementById('cancel-edit');
    const editPageBtn = document.getElementById('edit-page-btn');
    const historyPageBtn = document.getElementById('history-page-btn');
    
    // Sidebar elements
    const createPageItem = document.getElementById('create-page-item');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const searchForm = document.getElementById('search-form');
    const sidebarNav = document.getElementById('sidebar-nav');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    
    // History modal elements
    const historyModal = document.getElementById('history-modal');
    const historyModalClose = document.getElementById('history-modal-close');
    const historyContent = document.getElementById('history-content');
    
    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    
    // State variables
    let isLoginMode = true;
    let currentPageId = 'home';
    let currentUser = null;
    let isEditing = false;
    let darkMode = localStorage.getItem('darkMode') === 'true';
    
    // Initialize the app
    function init() {
      setupAuth();
      setupNavigation();
      setupTheme();
      setupEditor();
      loadPage(currentPageId);
    }
    
    // Theme setup
    function setupTheme() {
      if (darkMode) {
        document.body.classList.add('dark-mode');
        updateThemeIcon(true);
      } else {
        document.body.classList.remove('dark-mode');
        updateThemeIcon(false);
      }
      
      themeToggle.addEventListener('click', toggleTheme);
    }
    
    function toggleTheme() {
      darkMode = !darkMode;
      localStorage.setItem('darkMode', darkMode);
      
      if (darkMode) {
        document.body.classList.add('dark-mode');
        updateThemeIcon(true);
      } else {
        document.body.classList.remove('dark-mode');
        updateThemeIcon(false);
      }
    }
    
    function updateThemeIcon(isDark) {
      if (isDark) {
        themeToggle.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        `;
      } else {
        themeToggle.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        `;
      }
    }
    
    // Setup editor with live preview
    function setupEditor() {
      editContent.addEventListener('input', updatePreview);
      editTitle.addEventListener('input', updatePreview);
    }
    
    function updatePreview() {
      const title = editTitle.value;
      const content = editContent.value;
      
      if (title) {
        editPreviewContent.innerHTML = `<h1>${title}</h1>` + markdownToHtml(content);
      } else {
        editPreviewContent.innerHTML = markdownToHtml(content);
      }
    }
    
    // Authentication setup
    function setupAuth() {
      // Check auth state
      auth.onAuthStateChanged(user => {
        currentUser = user;
        updateAuthUI();
      });
      
      // Login button click
      loginBtn.addEventListener('click', () => {
        isLoginMode = true;
        authModalTitle.textContent = 'Login';
        authSubmitBtn.textContent = 'Login';
        switchAuthMode.textContent = 'Need to sign up?';
        authForm.reset();
        authError.classList.add('hidden');
        authModal.classList.add('active');
      });
      
      // Signup button click
      signupBtn.addEventListener('click', () => {
        isLoginMode = false;
        authModalTitle.textContent = 'Sign Up';
        authSubmitBtn.textContent = 'Sign Up';
        switchAuthMode.textContent = 'Already have an account?';
        authForm.reset();
        authError.classList.add('hidden');
        authModal.classList.add('active');
      });
      
      // Close modal
      authModalClose.addEventListener('click', () => {
        authModal.classList.remove('active');
      });
      
      // Click outside to close
      authModal.addEventListener('click', (e) => {
        if (e.target === authModal) {
          authModal.classList.remove('active');
        }
      });
      
      // Switch between login/signup
      switchAuthMode.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        if (isLoginMode) {
          authModalTitle.textContent = 'Login';
          authSubmitBtn.textContent = 'Login';
          switchAuthMode.textContent = 'Need to sign up?';
        } else {
          authModalTitle.textContent = 'Sign Up';
          authSubmitBtn.textContent = 'Sign Up';
          switchAuthMode.textContent = 'Already have an account?';
        }
      });
      
      // Auth form submission
      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = authEmail.value;
        const password = authPassword.value;
        
        try {
          if (isLoginMode) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
          }
          authModal.classList.remove('active');
        } catch (error) {
          authError.textContent = error.message;
          authError.classList.remove('hidden');
        }
      });
    }
    
    // Update UI based on auth state
    function updateAuthUI() {
      if (currentUser) {
        authStatus.innerHTML = `
          <span class="user-greeting">Welcome, ${currentUser.email}</span>
          <button class="btn header-btn" id="logout-btn">Logout</button>
        `;
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        createPageItem.style.display = 'block';
        
        // Show page actions if not on special pages
        if (!['home', 'recent-changes', 'random-page', 'create-page', 'search-results'].includes(currentPageId)) {
          pageActions.style.display = 'flex';
        }
      } else {
        authStatus.innerHTML = `
          <button class="btn header-btn" id="login-btn">Login</button>
          <button class="btn header-btn" id="signup-btn">Sign Up</button>
        `;
        document.getElementById('login-btn').addEventListener('click', () => {
          isLoginMode = true;
          authModalTitle.textContent = 'Login';
          authSubmitBtn.textContent = 'Login';
          switchAuthMode.textContent = 'Need to sign up?';
          authForm.reset();
          authError.classList.add('hidden');
          authModal.classList.add('active');
        });
        document.getElementById('signup-btn').addEventListener('click', () => {
          isLoginMode = false;
          authModalTitle.textContent = 'Sign Up';
          authSubmitBtn.textContent = 'Sign Up';
          switchAuthMode.textContent = 'Already have an account?';
          authForm.reset();
          authError.classList.add('hidden');
          authModal.classList.add('active');
        });
        createPageItem.style.display = 'none';
        pageActions.style.display = 'none';
      }
    }
    
    // Navigation setup
    function setupNavigation() {
      // Sidebar navigation
      sidebarNav.addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.tagName === 'A') {
          const pageId = e.target.getAttribute('data-page');
          loadPage(pageId);
          
          if (window.innerWidth < 768) {
            sidebar.classList.remove('active');
          }
        }
      });
      
      // Featured pages navigation
      document.getElementById('featured-pages').addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.tagName === 'A') {
          const pageId = e.target.getAttribute('data-page');
          loadPage(pageId);
          
          if (window.innerWidth < 768) {
            sidebar.classList.remove('active');
          }
        }
      });
      
      // Footer links
      document.querySelector('.footer-links').addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.tagName === 'A') {
          const pageId = e.target.getAttribute('data-page');
          loadPage(pageId);
        }
      });
      
      // Logo click (home)
      document.querySelector('.header-title a').addEventListener('click', (e) => {
        e.preventDefault();
        loadPage('home');
      });
      
      // Mobile sidebar toggle
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });
      
      // Edit page button
      editPageBtn.addEventListener('click', () => {
        isEditing = true;
        editSection.style.display = 'block';
        
        // Load current page data into edit form
        db.collection('pages').doc(currentPageId).get().then(doc => {
          if (doc.exists) {
            editTitle.value = doc.data().title;
            editContent.value = doc.data().content;
            updatePreview();
          } else {
            editTitle.value = pageTitle.textContent;
            editContent.value = '';
            updatePreview();
          }
        });
        
        // Scroll to edit section
        editSection.scrollIntoView({ behavior: 'smooth' });
      });
      
      // History page button
      historyPageBtn.addEventListener('click', () => {
        showPageHistory(currentPageId);
      });
      
      // Close history modal
      historyModalClose.addEventListener('click', () => {
        historyModal.classList.remove('active');
      });
      
      // Click outside to close history modal
      historyModal.addEventListener('click', (e) => {
        if (e.target === historyModal) {
          historyModal.classList.remove('active');
        }
      });
      
      // Cancel edit
      cancelEdit.addEventListener('click', () => {
        isEditing = false;
        editSection.style.display = 'none';
      });
      
      // Edit form submission
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentUser) {
          alert('You must be logged in to edit pages.');
          return;
        }
        
        const title = editTitle.value;
        const content = editContent.value;
        const summary = editSummary.value || 'No summary provided';
        
        // Create a new revision
        const revisionData = {
          pageId: currentPageId,
          title: title,
          content: content,
          summary: summary,
          author: currentUser.email,
          authorId: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'pending'
        };
        
        try {
          // Add to revisions collection for approval
          await db.collection('revisions').add(revisionData);
          
          // Hide edit section
          isEditing = false;
          editSection.style.display = 'none';
          editForm.reset();
          
          // Show success message
          showAlert('Your changes have been submitted for approval. Thank you!', 'success');
          
          // Reload the page
          loadPage(currentPageId);
        } catch (error) {
          console.error('Error submitting revision:', error);
          showAlert('There was an error submitting your changes. Please try again.', 'error');
        }
      });
      
      // Search functionality
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const searchTerm = searchInput.value.trim();
        if (searchTerm) {
          searchPages(searchTerm);
          
          if (window.innerWidth < 768) {
            sidebar.classList.remove('active');
          }
        }
      });
    }
    
    // Show page history
    function showPageHistory(pageId) {
      historyContent.innerHTML = '<p>Loading history...</p>';
      historyModal.classList.add('active');
      
      db.collection('revisions')
        .where('pageId', '==', pageId)
        .orderBy('timestamp', 'desc')
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            historyContent.innerHTML = '<p>No revision history found for this page.</p>';
            return;
          }
          
          let html = '<div class="history-list">';
          snapshot.forEach(doc => {
            const revision = doc.data();
            const status = revision.status === 'approved' ? 
              '<span class="badge badge-success">Approved</span>' : 
              '<span class="badge badge-warning">Pending</span>';
            
            html += `
              <div class="history-item">
                <div class="history-header">
                  <strong>${formatDate(revision.timestamp)}</strong> by ${revision.author}
                  ${status}
                </div>
                <div class="history-summary">
                  ${revision.summary}
                </div>
              </div>
            `;
          });
          html += '</div>';
          
          historyContent.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading history:', error);
          historyContent.innerHTML = '<p>There was an error loading the page history. Please try again later.</p>';
        });
    }
    
    // Load a page
    function loadPage(pageId) {
      currentPageId = pageId;
      
      // Update active nav link
      document.querySelectorAll('.sidebar-nav-link').forEach(link => {
        if (link.getAttribute('data-page') === pageId) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
      
      // Hide edit section if showing
      if (isEditing) {
        isEditing = false;
        editSection.style.display = 'none';
      }
      
      // Show loading state
      pageContent.innerHTML = '<p>Loading content...</p>';
      
      // Handle special pages
      if (pageId === 'home') {
        loadHomePage();
        pageActions.style.display = 'none';
        return;
      } else if (pageId === 'recent-changes') {
        loadRecentChanges();
        pageActions.style.display = 'none';
        return;
      } else if (pageId === 'random-page') {
        loadRandomPage();
        pageActions.style.display = 'none';
        return;
      } else if (pageId === 'create-page') {
        if (currentUser) {
          startCreatingNewPage();
        } else {
          pageTitle.textContent = 'Access Denied';
          pageContent.innerHTML = '<p>You must be logged in to create new pages.</p>';
          pageMeta.textContent = '';
        }
        pageActions.style.display = 'none';
        return;
      }
      
      // Load regular page
      db.collection('pages').doc(pageId).get().then(doc => {
        if (doc.exists) {
          const pageData = doc.data();
          pageTitle.textContent = pageData.title;
          
          // Generate table of contents if content is long enough
          const content = pageData.content;
          const contentWithTOC = generateTableOfContents(content);
          
          pageContent.innerHTML = markdownToHtml(contentWithTOC);
          pageMeta.textContent = `Last updated: ${formatDate(pageData.updatedAt)} by ${pageData.lastUpdatedBy}`;
          
          // Handle TOC links
          document.querySelectorAll('.article-toc-link').forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const targetId = link.getAttribute('href').substring(1);
              const targetElement = document.getElementById(targetId);
              if (targetElement) {
                window.scrollTo({
                  top: targetElement.offsetTop - 80,
                  behavior: 'smooth'
                });
              }
            });
          });
          
          // Show page actions if user is logged in
          if (currentUser) {
            pageActions.style.display = 'flex';
          } else {
            pageActions.style.display = 'none';
          }
        } else {
          // Page doesn't exist
          pageTitle.textContent = 'Page Not Found';
          pageContent.innerHTML = `
            <div class="alert alert-info">
              <p>The page "${pageId}" doesn't exist yet.</p>
              ${currentUser ? `<p><a href="#" id="create-missing-page">Create it now</a>?</p>` : 
                `<p>Please <a href="#" id="login-to-create">login</a> to create this page.</p>`}
            </div>
          `;
          pageMeta.textContent = '';
          pageActions.style.display = 'none';
          
          // Add event listener for create link
          const createLink = document.getElementById('create-missing-page');
          if (createLink) {
            createLink.addEventListener('click', (e) => {
              e.preventDefault();
              startCreatingNewPage(pageId);
            });
          }
          
          // Add event listener for login link
          const loginLink = document.getElementById('login-to-create');
          if (loginLink) {
            loginLink.addEventListener('click', (e) => {
              e.preventDefault();
              isLoginMode = true;
              authModalTitle.textContent = 'Login';
              authSubmitBtn.textContent = 'Login';
              switchAuthMode.textContent = 'Need to sign up?';
              authForm.reset();
              authError.classList.add('hidden');
              authModal.classList.add('active');
            });
          }
        }
      }).catch(error => {
        console.error('Error loading page:', error);
        pageTitle.textContent = 'Error';
        pageContent.innerHTML = '<p>There was an error loading this page. Please try again later.</p>';
        pageMeta.textContent = '';
        pageActions.style.display = 'none';
      });
    }
    
    // Generate table of contents from markdown content
    function generateTableOfContents(content) {
      // Check if content is long enough to warrant a TOC
      const headingMatches = content.match(/^#{2,3} .+$/gm);
      if (!headingMatches || headingMatches.length < 3) {
        return content;
      }
      
      let toc = '<div class="article-toc">\n';
      toc += '<div class="article-toc-title">Contents</div>\n';
      toc += '<ul class="article-toc-list">\n';
      
      let modifiedContent = content;
      const headings = [];
      
      // Find all headings and build TOC
      const headingRegex = /^(#{2,3}) (.+)$/gm;
      let match;
      while ((match = headingRegex.exec(content)) !== null) {
        const level = match[1].length;
        const text = match[2].trim();
        const id = text.toLowerCase().replace(/[^\w]+/g, '-');
        
        headings.push({
          level,
          text,
          id
        });
        
        // Replace heading in content with heading + id
        modifiedContent = modifiedContent.replace(
          match[0],
          `${match[1]} <a id="${id}"></a>${text}`
        );
      }
      
      // Build TOC HTML
      let currentLevel = 2;
      headings.forEach(heading => {
        if (heading.level > currentLevel) {
          toc += '<ul class="article-toc-sublist">\n';
        } else if (heading.level < currentLevel) {
          toc += '</ul>\n';
        }
        
        toc += `<li class="article-toc-item"><a href="#${heading.id}" class="article-toc-link">${heading.text}</a></li>\n`;
        currentLevel = heading.level;
      });
      
      // Close any open lists
      while (currentLevel > 2) {
        toc += '</ul>\n';
        currentLevel--;
      }
      
      toc += '</ul>\n</div>\n\n';
      
      return toc + modifiedContent;
    }
    
    // Load home page
    function loadHomePage() {
      pageTitle.textContent = 'Welcome to Minnesota Then Wiki';
      pageMeta.textContent = '';
      
      // Default home page content
      const homeContent = `
        <section class="article-section">
          <p class="lead">Welcome to Minnesota Then, a collaborative encyclopedia dedicated to preserving and sharing the rich history of Minnesota.</p>
          
          <div class="article-image float-right">
            <img src="https://images.pexels.com/photos/2226900/pexels-photo-2226900.jpeg?auto=compress&cs=tinysrgb&w=800" alt="Minnesota landscape with lake and trees">
            <div class="article-image-caption">Minnesota's iconic lakes and forests</div>
          </div>
          
          <p>This wiki is a community resource where historians, students, and enthusiasts can collaborate to document Minnesota's fascinating past. From the indigenous peoples who first inhabited the land to the European settlers, from the industrial revolution to modern times - we aim to create a comprehensive resource about all aspects of Minnesota history.</p>
          
          <p>All content is community-created and reviewed for accuracy. To contribute, simply create an account and start editing or creating pages.</p>
        </section>
        
        <section class="article-section">
          <h2>Getting Started</h2>
          
          <p>Here are some ways to begin exploring Minnesota Then:</p>
          
          <ul>
            <li>Browse our featured articles in the sidebar</li>
            <li>Use the search function to find specific topics</li>
            <li>Check out recent changes to see what's new</li>
            <li>Click "Random Page" to discover something unexpected</li>
            <li>Create an account to contribute your knowledge</li>
          </ul>
        </section>
        
        <section class="article-section">
          <h2>Featured Content</h2>
          
          <div class="row">
            <div class="col">
              <h3>Geography</h3>
              <p>Explore Minnesota's diverse landscapes, from the North Shore of Lake Superior to the prairies of the southwest.</p>
              <p><a href="#" data-page="minnesota-geography">Read more about Minnesota Geography</a></p>
            </div>
            
            <div class="col">
              <h3>Early Settlement</h3>
              <p>Learn about the pioneers and immigrants who shaped Minnesota's early development.</p>
              <p><a href="#" data-page="early-settlers">Read more about Early Settlers</a></p>
            </div>
            
            <div class="col">
              <h3>Native Peoples</h3>
              <p>Discover the rich cultures and histories of Minnesota's indigenous peoples.</p>
              <p><a href="#" data-page="native-peoples">Read more about Native Peoples</a></p>
            </div>
          </div>
        </section>
        
        <section class="article-section">
          <h2>Contribute</h2>
          
          <p>Minnesota Then Wiki relies on contributors like you. Here's how you can help:</p>
          
          <ul>
            <li><strong>Write articles:</strong> Create new pages or expand existing ones</li>
            <li><strong>Edit content:</strong> Improve articles by adding information or fixing errors</li>
            <li><strong>Add images:</strong> Upload relevant historical photographs or illustrations</li>
            <li><strong>Research:</strong> Help verify facts and add citations</li>
          </ul>
          
          <p>All edits are reviewed by our community before being published to ensure accuracy and quality.</p>
          
          ${currentUser ? 
            `<p><a href="#" data-page="create-page" class="btn btn-primary">Create a New Page</a></p>` : 
            `<p><a href="#" id="login-to-contribute" class="btn btn-primary">Login to Contribute</a></p>`
          }
        </section>
      `;
      
      pageContent.innerHTML = homeContent;
      
      // Add event listeners for links
      document.querySelectorAll('#page-content a[data-page]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          loadPage(link.getAttribute('data-page'));
        });
      });
      
      // Login to contribute button
      const loginToContribute = document.getElementById('login-to-contribute');
      if (loginToContribute) {
        loginToContribute.addEventListener('click', (e) => {
          e.preventDefault();
          isLoginMode = true;
          authModalTitle.textContent = 'Login';
          authSubmitBtn.textContent = 'Login';
          switchAuthMode.textContent = 'Need to sign up?';
          authForm.reset();
          authError.classList.add('hidden');
          authModal.classList.add('active');
        });
      }
    }
    
    // Load recent changes
    function loadRecentChanges() {
      pageTitle.textContent = 'Recent Changes';
      pageContent.innerHTML = '<p>Loading recent changes...</p>';
      pageMeta.textContent = '';
      
      db.collection('pages')
        .orderBy('updatedAt', 'desc')
        .limit(20)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            pageContent.innerHTML = '<p>No recent changes found.</p>';
            return;
          }
          
          let html = '<div class="recent-changes">';
          snapshot.forEach(doc => {
            const page = doc.data();
            html += `
              <div class="recent-change-item">
                <h3><a href="#" data-page="${doc.id}">${page.title}</a></h3>
                <div class="recent-change-meta">
                  Updated ${formatDate(page.updatedAt)} by ${page.lastUpdatedBy}
                </div>
                <div class="recent-change-summary">
                  ${page.content.substring(0, 200)}...
                </div>
              </div>
            `;
          });
          html += '</div>';
          
          pageContent.innerHTML = html;
          
          // Add click event listeners to the links
          document.querySelectorAll('#page-content a[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              loadPage(link.getAttribute('data-page'));
            });
          });
        })
        .catch(error => {
          console.error('Error loading recent changes:', error);
          pageContent.innerHTML = '<p>There was an error loading recent changes. Please try again later.</p>';
        });
    }
    
    // Load a random page
    function loadRandomPage() {
      pageTitle.textContent = 'Random Page';
      pageContent.innerHTML = '<p>Loading a random page...</p>';
      pageMeta.textContent = '';
      
      db.collection('pages')
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            pageContent.innerHTML = `
              <p>No pages found yet. Be the first to create content!</p>
              ${currentUser ? 
                `<p><a href="#" data-page="create-page" class="btn btn-primary">Create a New Page</a></p>` : 
                `<p><a href="#" id="login-to-create-first" class="btn btn-primary">Login to Create Content</a></p>`
              }
            `;
            
            // Add event listener for login link
            const loginLink = document.getElementById('login-to-create-first');
            if (loginLink) {
              loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = true;
                authModalTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                switchAuthMode.textContent = 'Need to sign up?';
                authForm.reset();
                authError.classList.add('hidden');
                authModal.classList.add('active');
              });
            }
            
            return;
          }
          
          const randomIndex = Math.floor(Math.random() * snapshot.size);
          let currentIndex = 0;
          let randomPageId = '';
          
          snapshot.forEach(doc => {
            if (currentIndex === randomIndex) {
              randomPageId = doc.id;
            }
            currentIndex++;
          });
          
          if (randomPageId) {
            loadPage(randomPageId);
          } else {
            pageContent.innerHTML = '<p>Could not load a random page. Please try again.</p>';
          }
        })
        .catch(error => {
          console.error('Error loading random page:', error);
          pageContent.innerHTML = '<p>There was an error loading a random page. Please try again later.</p>';
        });
    }
    
    // Start creating a new page
    function startCreatingNewPage(suggestedPageId = '') {
      pageTitle.textContent = 'Create New Page';
      pageMeta.textContent = '';
      
      pageContent.innerHTML = `
        <div class="alert alert-info">
          <p>Before creating a new page, please search to make sure it doesn't already exist.</p>
        </div>
        
        <form id="new-page-form">
          <div class="edit-form-group">
            <label for="new-page-title" class="edit-label">Page Title</label>
            <input type="text" id="new-page-title" class="edit-input" required value="${suggestedPageId ? suggestedPageId.replace(/-/g, ' ') : ''}">
          </div>
          
          <div class="edit-form-group">
            <label for="new-page-content" class="edit-label">Content</label>
            <textarea id="new-page-content" class="edit-input" rows="15" required></textarea>
            
            <div class="edit-markdown-help">
              <details>
                <summary>Markdown Help</summary>
                <div class="mt-2">
                  <p><code># Heading 1</code> - Creates a main heading</p>
                  <p><code>## Heading 2</code> - Creates a sub-heading</p>
                  <p><code>**bold text**</code> - Makes text bold</p>
                  <p><code>*italic text*</code> - Makes text italic</p>
                  <p><code>[link text](url)</code> - Creates a link</p>
                  <p><code>![alt text](image-url)</code> - Adds an image</p>
                  <p><code>- item</code> - Creates a bullet point</p>
                  <p><code>1. item</code> - Creates a numbered list</p>
                  <p><code>---</code> - Adds a horizontal rule</p>
                </div>
              </details>
            </div>
          </div>
          
          <div class="edit-form-group">
            <label for="new-page-summary" class="edit-label">Edit Summary</label>
            <input type="text" id="new-page-summary" class="edit-input" placeholder="Briefly describe your new page">
          </div>
          
          <div class="edit-preview">
            <div class="edit-preview-header">
              <h3>Preview</h3>
            </div>
            <div id="new-page-preview"></div>
          </div>
          
          <div class="edit-actions">
            <button type="submit" class="btn btn-primary">Submit for Approval</button>
            <button type="button" class="btn btn-outline" id="cancel-new-page">Cancel</button>
          </div>
        </form>
      `;
      
      // Set up preview functionality
      const newPageTitle = document.getElementById('new-page-title');
      const newPageContent = document.getElementById('new-page-content');
      const newPagePreview = document.getElementById('new-page-preview');
      
      function updateNewPagePreview() {
        const title = newPageTitle.value;
        const content = newPageContent.value;
        
        if (title) {
          newPagePreview.innerHTML = `<h1>${title}</h1>` + markdownToHtml(content);
        } else {
          newPagePreview.innerHTML = markdownToHtml(content);
        }
      }
      
      newPageTitle.addEventListener('input', updateNewPagePreview);
      newPageContent.addEventListener('input', updateNewPagePreview);
      
      // Cancel button
      document.getElementById('cancel-new-page').addEventListener('click', () => {
        loadPage('home');
      });
      
      // Form submission
      document.getElementById('new-page-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = newPageTitle.value;
        const content = newPageContent.value;
        const summary = document.getElementById('new-page-summary').value || 'No summary provided';
        
        // Generate a page ID from the title
        const pageId = generatePageId(title);
        
        // Check if page already exists
        const pageExists = await db.collection('pages').doc(pageId).get()
          .then(doc => doc.exists);
        
        if (pageExists) {
          showAlert('A page with this title already exists. Please edit the existing page instead.', 'warning');
          return;
        }
        
        // Create a new revision for approval
        const revisionData = {
          pageId: pageId,
          title: title,
          content: content,
          summary: summary,
          author: currentUser.email,
          authorId: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'pending',
          isNewPage: true
        };
        
        try {
          // Add to revisions collection for approval
          await db.collection('revisions').add(revisionData);
          
          // Show success message
          showAlert('Your new page has been submitted for approval. Thank you!', 'success');
          
          // Go back to home
          loadPage('home');
        } catch (error) {
          console.error('Error submitting new page:', error);
          showAlert('There was an error submitting your new page. Please try again.', 'error');
        }
      });
    }
    
    // Search pages
    function searchPages(searchTerm) {
      currentPageId = 'search-results';
      
      pageTitle.textContent = `Search Results for "${searchTerm}"`;
      pageContent.innerHTML = '<p>Searching...</p>';
      pageMeta.textContent = '';
      pageActions.style.display = 'none';
      
      db.collection('pages')
        .orderBy('title')
        .startAt(searchTerm)
        .endAt(searchTerm + '\uf8ff')
        .limit(20)
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            pageContent.innerHTML = `
              <div class="alert alert-info">
                <p>No pages found matching "${searchTerm}".</p>
                ${currentUser ? 
                  `<p><a href="#" id="create-from-search">Create a new page titled "${searchTerm}"</a></p>` : 
                  `<p>Please <a href="#" id="login-to-create-from-search">login</a> to create this page.</p>`
                }
              </div>
            `;
            
            // Add event listener for create link
            const createLink = document.getElementById('create-from-search');
            if (createLink) {
              createLink.addEventListener('click', (e) => {
                e.preventDefault();
                startCreatingNewPage(searchTerm);
              });
            }
            
            // Add event listener for login link
            const loginLink = document.getElementById('login-to-create-from-search');
            if (loginLink) {
              loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = true;
                authModalTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                switchAuthMode.textContent = 'Need to sign up?';
                authForm.reset();
                authError.classList.add('hidden');
                authModal.classList.add('active');
              });
            }
            
            return;
          }
          
          let html = '<div class="search-results">';
          snapshot.forEach(doc => {
            const page = doc.data();
            html += `
              <div class="search-result-item">
                <h3><a href="#" data-page="${doc.id}">${page.title}</a></h3>
                <div class="search-result-snippet">
                  ${page.content.substring(0, 200)}...
                </div>
              </div>
            `;
          });
          html += '</div>';
          
          pageContent.innerHTML = html;
          
          // Add click event listeners to the links
          document.querySelectorAll('#page-content a[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              loadPage(link.getAttribute('data-page'));
            });
          });
        })
        .catch(error => {
          console.error('Error searching pages:', error);
          pageContent.innerHTML = '<p>There was an error performing the search. Please try again later.</p>';
        });
    }
    
    // Helper function to show alerts
    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} fade-in`;
      alertDiv.textContent = message;
      
      // Insert after header
      const contentArea = document.getElementById('content-area');
      contentArea.insertBefore(alertDiv, contentArea.firstChild);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => {
          alertDiv.remove();
        }, 300);
      }, 5000);
    }
    
    // Helper function to convert markdown to HTML
    function markdownToHtml(markdown) {
      if (!markdown) return '';
      
      // Simple markdown conversions
      let html = markdown
        // Headers with id anchors
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
        // Bold and italic
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Images with captions
        .replace(/!\[(.*?)\]\((.*?)\)(\{(.*?)\})?/g, (match, alt, src, _, caption) => {
          if (caption) {
            return `<div class="article-image ${caption.includes('right') ? 'float-right' : caption.includes('left') ? 'float-left' : ''}">
              <img src="${src}" alt="${alt}">
              <div class="article-image-caption">${alt}</div>
            </div>`;
          } else {
            return `<div class="article-image">
              <img src="${src}" alt="${alt}">
            </div>`;
          }
        })
        // Links
        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
        // Blockquotes
        .replace(/^\> (.*$)/gm, '<blockquote>$1</blockquote>')
        // Lists
        .replace(/^\- (.*$)/gm, '<li>$1</li>')
        .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
        // Horizontal rule
        .replace(/^---$/gm, '<hr>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      // Wrap lists
      html = html.replace(/<li>.*?<\/li>/g, function(match) {
        return '<ul>' + match + '</ul>';
      }).replace(/<\/ul><ul>/g, '');
      
      // Ensure paragraphs are properly wrapped
      if (!html.startsWith('<h1>') && !html.startsWith('<h2>') && !html.startsWith('<h3>') && !html.startsWith('<h4>') && !html.startsWith('<blockquote>') && !html.startsWith('<ul>') && !html.startsWith('<p>')) {
        html = '<p>' + html + '</p>';
      }
      
      return html;
    }
    
    // Helper function to format dates
    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown date';
      
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      
      // Format: March 15, 2023 at 2:30 PM
      return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true
      }).format(date);
    }
    
    // Helper function to generate page ID from title
    function generatePageId(title) {
      return title.toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
