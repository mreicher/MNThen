<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Voting System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Biometric Voting System</h1>
        <div id="auth-section" class="mt-4">
            <h2>Login</h2>
            <input type="text" id="username" class="form-control mb-2" placeholder="Username">
            <input type="password" id="password" class="form-control mb-2" placeholder="Password">
            <button id="loginBtn" class="btn btn-primary">Login</button>
        </div>
        <div id="voting-section" class="mt-4" style="display: none;">
            <h2>Vote</h2>
            <video id="webcam" autoplay></video>
            <button id="voteForBtn" class="btn btn-success mt-2">Vote For</button>
            <button id="voteAgainstBtn" class="btn btn-danger mt-2">Vote Against</button>
            <p id="location" class="mt-2"></p>
        </div>
        <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const votingSection = document.getElementById('voting-section');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const voteForBtn = document.getElementById('voteForBtn');
        const voteAgainstBtn = document.getElementById('voteAgainstBtn');
        const webcam = document.getElementById('webcam');
        const locationDisplay = document.getElementById('location');
        const errorMessage = document.getElementById('error-message');

        // Face-api.js Models URL
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'; // Use CDN for models

        // Load Face-api.js Models
        async function loadModels() {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        }

        // Start Webcam
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcam.srcObject = stream;
            } catch (error) {
                showError('Error accessing webcam: ' + error.message);
            }
        }

        // Get Geolocation
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const location = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };
                            locationDisplay.textContent = `Location: Latitude ${location.latitude}, Longitude ${location.longitude}`;
                            resolve(location);
                        },
                        (error) => {
                            showError('Geolocation error: ' + error.message);
                            reject(error);
                        }
                    );
                } else {
                    showError('Geolocation is not supported by this browser.');
                    reject('Geolocation not supported');
                }
            });
        }

        // Capture Image and Vote
        async function captureAndVote(vote) {
            const canvas = document.createElement('canvas');
            canvas.width = webcam.videoWidth;
            canvas.height = webcam.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(webcam, 0, 0, canvas.width, canvas.height);

            const location = await getLocation();
            const timestamp = new Date();

            // Convert canvas image to base64
            const imageData = canvas.toDataURL('image/jpeg');

            // Save vote to Firestore
            const voteData = {
                vote: vote,
                timestamp: timestamp,
                location: location,
                image: imageData, // Store image as base64
                userId: auth.currentUser.uid, // Associate vote with user
                ipAddress: await getIPAddress() // Log IP address
            };

            try {
                // Check if the user has already voted
                const voteRef = db.collection('votes').where('userId', '==', auth.currentUser.uid);
                const voteSnapshot = await voteRef.get();
                if (!voteSnapshot.empty) {
                    showError('You have already voted.');
                    return;
                }

                // Save the vote
                await db.collection('votes').add(voteData);
                alert('Vote recorded successfully!');
                auth.signOut(); // Log out the user after voting
                window.location.reload(); // Refresh the page
            } catch (error) {
                showError('Error recording vote: ' + error.message);
            }
        }

        // Get IP Address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error fetching IP address: ', error);
                return 'Unknown';
            }
        }

        // Login Function
        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                showError('Please enter both username and password.');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(username, password);
                authSection.style.display = 'none';
                votingSection.style.display = 'block';
                await loadModels();
                await startWebcam();
            } catch (error) {
                showError('Login failed: ' + error.message);
            }
        });

        // Voting Buttons
        voteForBtn.addEventListener('click', () => captureAndVote('For'));
        voteAgainstBtn.addEventListener('click', () => captureAndVote('Against'));

        // Error Handling
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
