<!DOCTYPE html>
 <html lang="en">
 <head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Community Markers Map</title>
 <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
 <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
 <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" />
 <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
 
 <style>
 /* Base Styles */
 :root {
 --color-architecture: #2563eb;
 --color-nature: #10b981;
 --color-events: #f59e0b;
 --color-people: #8b5cf6;
 --color-primary: #2563eb;
 --color-primary-dark: #1d4ed8;
 --color-secondary: #f8fafc;
 --color-secondary-dark: #f1f5f9;
 --color-danger: #ef4444;
 --color-danger-dark: #dc2626;
 --color-text: #333;
 --color-text-light: #64748b;
 --color-text-dark: #1e293b;
 --color-background: #f5f5f5;
 --color-white: #ffffff;
 --color-border: #e2e8f0;
 --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
 --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
 --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.12);
 --radius-sm: 8px;
 --radius-md: 12px;
 --radius-lg: 16px;
 --radius-full: 50px;
 --transition-fast: 0.2s;
 --transition-normal: 0.3s;
 }

 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 }

 body {
 overflow-x: hidden;
 color: var(--color-text);
 background-color: var(--color-background);
 line-height: 1.6;
 }

 .leaflet-control-attribution {
 display: none;
 }

 a {
 text-decoration: none;
 color: var(--color-primary);
 transition: color var(--transition-normal) ease;
 }

 a:hover {
 color: var(--color-primary-dark);
 }

 /* Typography */
 h1, h2, h3, h4, h5, h6 {
 color: var(--color-text-dark);
 margin-bottom: 0.5em;
 font-weight: 600;
 }

 p {
 margin-bottom: 1em;
 }

 /* Page Layout */
 .page {
 width: 100%;
 min-height: 100vh;
 position: relative;
 }

 .search-page {
 display: flex;
 flex-direction: column;
 align-items: center;
 justify-content: center;
 background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('https://www.mnthen.com/images/header/mn_history_header.jpg');
 background-size: cover;
 background-position: center;
 color: var(--color-white);
 text-align: center;
 }

 .search-page h1, .search-page h2, .search-page h3, 
 .search-page h4, .search-page h5, .search-page h6 {
 color: var(--color-white);
 }

 .map-page {
 display: none;
 position: relative;
 height: 100vh;
 width: 100%;
 }

 /* Map Container */
 #map {
 height: 100%;
 width: 100%;
 z-index: 1;
 }

 /* Hero Content */
 .hero-content {
 max-width: 800px;
 padding: 2rem;
 z-index: 2;
 animation: fadeIn 1s ease-out;
 }

 @keyframes fadeIn {
 from { opacity: 0; transform: translateY(20px); }
 to { opacity: 1; transform: translateY(0); }
 }

 .hero-content h1 {
 font-size: 3.5rem;
 margin-bottom: 1rem;
 text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
 }

 .hero-content p {
 font-size: 1.3rem;
 margin-bottom: 2rem;
 text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
 }

 /* Custom styles for Suneditor */
 #description-editor {
 border: 1px solid var(--color-border);
 border-radius: var(--radius-sm);
 margin-bottom: 1rem;
 }

 .sun-editor .se-toolbar {
 background-color: #f9fafb;
 border-bottom: 1px solid var(--color-border);
 }

 .sun-editor .se-wrapper {
 background-color: var(--color-white);
 }

 /* Search Components */
 .search-container {
 width: 100%;
 max-width: 600px;
 margin: 0 auto 2rem;
 }

 .search-bar {
 display: flex;
 border-radius: var(--radius-full);
 overflow: hidden;
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
 transition: transform var(--transition-normal) ease, box-shadow var(--transition-normal) ease;
 }

 .search-bar:hover {
 transform: translateY(-2px);
 box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
 }

 .search-input {
 flex: 1;
 padding: 1.2rem 1.5rem;
 border: none;
 font-size: 1.1rem;
 outline: none;
 }

 .search-button {
 padding: 1.2rem 2rem;
 background-color: var(--color-primary);
 color: var(--color-white);
 border: none;
 cursor: pointer;
 font-weight: bold;
 transition: background-color var(--transition-normal);
 }

 .search-button:hover {
 background-color: var(--color-primary-dark);
 }

 .map-search-bar {
 position: absolute;
 top: 20px;
 left: 50%;
 transform: translateX(-50%);
 display: flex;
 width: 80%;
 max-width: 500px;
 z-index: 10;
 border-radius: var(--radius-full);
 overflow: hidden;
 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
 transition: box-shadow var(--transition-normal) ease;
 }

 .map-search-bar:hover {
 box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
 }

 .map-search-input {
 flex: 1;
 padding: 0.9rem 1.25rem;
 border: none;
 font-size: 1rem;
 outline: none;
 }

 .map-search-button {
 display: flex;
 align-items: center;
 justify-content: center;
 width: 50px;
 height: 50px;
 border: none;
 background-color: var(--color-primary);
 border-radius: 0 50px 50px 0;
 cursor: pointer;
 transition: background-color var(--transition-fast);
 }

 .map-search-button:hover {
 background-color: var(--color-primary-dark);
 }

 .map-search-button i {
 color: var(--color-white);
 font-size: 18px;
 }

 /* Category Selector */
 .category-selector {
 position: absolute;
 bottom: 20px;
 left: 50%;
 transform: translateX(-50%);
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 gap: 12px;
 z-index: 10;
 padding: 12px 16px;
 background-color: rgba(255, 255, 255, 0.95);
 border-radius: var(--radius-md);
 box-shadow: var(--shadow-md);
 transition: transform var(--transition-normal) ease;
 }

 .category-selector:hover {
 transform: translateX(-50%) translateY(-2px);
 }

 .category-badge {
 padding: 0.6rem 1.2rem;
 border-radius: var(--radius-full);
 font-size: 0.95rem;
 font-weight: 600;
 cursor: pointer;
 transition: all var(--transition-normal);
 color: var(--color-white);
 box-shadow: var(--shadow-sm);
 }

 .category-badge.active {
 transform: scale(1.05);
 box-shadow: var(--shadow-md);
 }

 .category-badge.architecture {
 background-color: var(--color-architecture);
 }

 .category-badge.nature {
 background-color: var(--color-nature);
 }

 .category-badge.events {
 background-color: var(--color-events);
 }

 .category-badge.people {
 background-color: var(--color-people);
 }

 /* Floating Menu */
 .floating-menu {
 position: fixed;
 top: 20px;
 left: 20px;
 z-index: 1000;
 }

 .floating-btn {
 width: 48px;
 height: 48px;
 border-radius: 50%;
 background-color: var(--color-primary);
 color: var(--color-white);
 border: none;
 font-size: 1.5rem;
 cursor: pointer;
 box-shadow: var(--shadow-md);
 transition: all var(--transition-normal) ease;
 }

 .floating-btn:hover {
 background-color: var(--color-primary-dark);
 transform: scale(1.05);
 }

 .menu-content {
 display: none;
 position: absolute;
 top: 60px;
 left: 0;
 background-color: var(--color-white);
 border-radius: var(--radius-md);
 box-shadow: var(--shadow-lg);
 padding: 0.5rem;
 width: 220px;
 animation: slideIn 0.3s ease-out;
 }

 @keyframes slideIn {
 from { opacity: 0; transform: translateY(-10px); }
 to { opacity: 1; transform: translateY(0); }
 }

 .menu-content a {
 display: block;
 padding: 0.85rem 1.2rem;
 color: var(--color-text);
 border-radius: var(--radius-sm);
 transition: all var(--transition-normal);
 font-weight: 500;
 }

 .menu-content a:hover {
 background-color: #f3f4f6;
 color: var(--color-primary);
 transform: translateX(5px);
 }

 /* Scroll Down Button */
 .scroll-down {
 position: absolute;
 bottom: 30px;
 left: 50%;
 transform: translateX(-50%);
 display: flex;
 flex-direction: column;
 align-items: center;
 color: var(--color-white);
 cursor: pointer;
 animation: bounce 2s infinite;
 }

 .scroll-down span {
 margin-bottom: 0.5rem;
 font-weight: 500;
 letter-spacing: 0.5px;
 }

 @keyframes bounce {
 0%, 20%, 50%, 80%, 100% {
 transform: translateY(0) translateX(-50%);
 }
 40% {
 transform: translateY(-10px) translateX(-50%);
 }
 60% {
 transform: translateY(-5px) translateX(-50%);
 }
 }

 /* Overlay */
 .overlay {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background-color: rgba(0, 0, 0, 0.6);
 z-index: 1000;
 backdrop-filter: blur(3px);
 transition: opacity var(--transition-normal) ease;
 }

 /* Modal Base */
 .modal-base {
 display: none;
 position: fixed;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 background-color: var(--color-white);
 border-radius: var(--radius-lg);
 box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
 padding: 2.5rem;
 max-width: 90%;
 width: 500px;
 max-height: 90vh;
 overflow-y: auto;
 z-index: 1100;
 animation: modalFadeIn 0.3s ease-out;
 }

 @keyframes modalFadeIn {
 from { opacity: 0; transform: translate(-50%, -48%); }
 to { opacity: 1; transform: translate(-50%, -50%); }
 }

 .modal-base h2 {
 color: #1e3a8a;
 margin-bottom: 1.2rem;
 font-size: 1.8rem;
 border-bottom: 2px solid #f3f4f6;
 padding-bottom: 0.8rem;
 }

 .modal-base p {
 color: #4b5563;
 margin-bottom: 1.2rem;
 line-height: 1.7;
 }

 .close-btn {
 position: absolute;
 top: 15px;
 right: 15px;
 background: none;
 border: none;
 font-size: 1.5rem;
 cursor: pointer;
 color: #6b7280;
 transition: all var(--transition-fast);
 width: 36px;
 height: 36px;
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 }

 .close-btn:hover {
 color: #374151;
 background-color: #f3f4f6;
 }

 /* Auth Popup */
 .auth-popup {
 width: 420px;
 }

 .auth-tabs {
 display: flex;
 margin-bottom: 1.5rem;
 border-bottom: 1px solid #e5e7eb;
 }

 .auth-tab {
 flex: 1;
 padding: 0.85rem;
 background: none;
 border: none;
 border-bottom: 2px solid transparent;
 cursor: pointer;
 font-weight: 600;
 color: #6b7280;
 transition: all var(--transition-normal);
 }

 .auth-tab.active {
 color: var(--color-primary);
 border-bottom-color: var(--color-primary);
 }

 .auth-form {
 display: flex;
 flex-direction: column;
 gap: 1.2rem;
 }

 .form-group {
 display: flex;
 flex-direction: column;
 gap: 0.5rem;
 }

 .form-group label {
 font-weight: 500;
 font-size: 0.95rem;
 color: #4b5563;
 }

 .form-input {
 padding: 0.85rem;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-sm);
 font-size: 1rem;
 transition: all var(--transition-fast);
 }

 .form-input:focus {
 outline: none;
 border-color: var(--color-primary);
 box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
 }

 .auth-button {
 padding: 0.9rem;
 background-color: var(--color-primary);
 color: var(--color-white);
 border: none;
 border-radius: var(--radius-sm);
 font-weight: 600;
 cursor: pointer;
 transition: all var(--transition-normal);
 }

 .auth-button:hover {
 background-color: var(--color-primary-dark);
 transform: translateY(-2px);
 box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
 }

 /* Marker Info Modal */
 #markerInfoModal {
 width: 900px;
 max-width: 95%;
 }

 .marker-info-content {
 display: flex;
 flex-direction: column;
 gap: 2rem;
 }

 @media (min-width: 768px) {
 .marker-info-content {
 flex-direction: row;
 }
 }

 /* Marker Image Container */
 .marker-image-container {
 position: relative;
 display: inline-block;
 margin-bottom: 25px;
 flex: 1;
 border-radius: var(--radius-md);
 overflow: hidden;
 box-shadow: none;
 border: none;
 background-color: var(--color-white);
 }

 /* Marker Image */
 .marker-image {
 display: block;
 width: 100%;
 height: auto;
 transition: transform 0.5s ease;
 cursor: pointer;
 }

 .marker-image:hover {
 transform: scale(1.03);
 }

 /* Historical Source */
 .source-citation {
 background-color: #f8fafc;
 padding: 1.2rem;
 border-radius: var(--radius-md);
 margin-top: 1rem;
 font-size: 0.95rem;
 border: 1px solid var(--color-border);
 }

 .source-citation h4 {
 margin-bottom: 0.8rem;
 font-size: 1.1rem;
 color: #1e3a8a;
 }
 
 /* Copyright options */
 .copyright-info {
 margin-top: 0.8rem;
 font-size: 0.9rem;
 color: var(--color-text-light);
 font-style: italic;
 }

 .marker-details {
 flex: 1.5;
 display: flex;
 flex-direction: column;
 gap: 1.2rem;
 }

 .marker-title {
 font-size: 1.8rem;
 margin-bottom: 0.5rem;
 color: #1e3a8a;
 }

 .upload-info {
 font-size: 0.95rem;
 color: var(--color-text-light);
 display: flex;
 align-items: center;
 gap: 0.5rem;
 }

 .upload-info i {
 color: var(--color-primary);
 }

 .category-tags {
 display: flex;
 gap: 0.6rem;
 flex-wrap: wrap;
 }

 .category-tag {
 padding: 0.35rem 0.9rem;
 border-radius: var(--radius-full);
 font-size: 0.85rem;
 color: var(--color-white);
 font-weight: 600;
 box-shadow: var(--shadow-sm);
 }

 .category-tag.architecture {
 background-color: var(--color-architecture);
 }

 .category-tag.nature {
 background-color: var(--color-nature);
 }

 .category-tag.events {
 background-color: var(--color-events);
 }

 .category-tag.people {
 background-color: var(--color-people);
 }

 .description {
 line-height: 1.7;
 color: #4b5563;
 }

 .marker-stats {
 display: flex;
 gap: 1.5rem;
 margin-top: 0.8rem;
 }

 .stat-item {
 display: flex;
 align-items: center;
 gap: 0.5rem;
 color: var(--color-text-light);
 font-size: 0.95rem;
 }

 .interaction-buttons {
 display: flex;
 gap: 1rem;
 margin-top: 1rem;
 }

 .btn {
 padding: 0.7rem 1.2rem;
 border-radius: var(--radius-sm);
 font-weight: 600;
 cursor: pointer;
 transition: all var(--transition-normal);
 border: none;
 display: flex;
 align-items: center;
 gap: 0.5rem;
 }

 .btn-primary {
 background-color: var(--color-primary);
 color: var(--color-white);
 }

 .btn-primary:hover {
 background-color: var(--color-primary-dark);
 transform: translateY(-2px);
 box-shadow: var(--shadow-sm);
 }

 .btn-secondary {
 background-color: var(--color-secondary);
 color: #475569;
 border: 1px solid var(--color-border);
 }

 .btn-secondary:hover {
 background-color: var(--color-secondary-dark);
 transform: translateY(-2px);
 box-shadow: var(--shadow-sm);
 }

 .btn-danger {
 background-color: var(--color-danger);
 color: var(--color-white);
 }

 .btn-danger:hover {
 background-color: var(--color-danger-dark);
 transform: translateY(-2px);
 box-shadow: var(--shadow-sm);
 }

 .report-button {
 background-color: transparent;
 border: none;
 color: var(--color-danger);
 cursor: pointer;
 display: flex;
 align-items: center;
 gap: 0.5rem;
 font-size: 0.95rem;
 transition: all var(--transition-fast);
 padding: 0.5rem 0.8rem;
 border-radius: 6px;
 }

 .report-button:hover {
 color: var(--color-danger-dark);
 background-color: rgba(239, 68, 68, 0.05);
 }

 .share-buttons {
 display: flex;
 gap: 0.8rem;
 margin-top: 1.2rem;
 }

 .share-button {
 width: 40px;
 height: 40px;
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 color: var(--color-white);
 border: none;
 cursor: pointer;
 transition: all var(--transition-normal);
 box-shadow: var(--shadow-sm);
 }

 .share-button:hover {
 transform: translateY(-3px) scale(1.05);
 box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
 }

 .share-button.facebook {
 background-color: #1877f2;
 }

 .share-button.twitter {
 background-color: #1da1f2;
 }

 .share-button.linkedin {
 background-color: #0a66c2;
 }

 /* Comments Section */
 .comments-section {
 margin-top: 2rem;
 border-top: 1px solid #e5e7eb;
 padding-top: 1.5rem;
 }

 .comments-section h3 {
 margin-bottom: 1.2rem;
 font-size: 1.3rem;
 color: #1e3a8a;
 }

 .comments-list {
 display: flex;
 flex-direction: column;
 gap: 1.2rem;
 margin-bottom: 1.8rem;
 }

 .comment {
 background-color: #f8fafc;
 padding: 1.2rem;
 border-radius: var(--radius-md);
 box-shadow: var(--shadow-sm);
 transition: all var(--transition-normal);
 border: 1px solid var(--color-border);
 }

 .comment:hover {
 transform: translateY(-3px);
 box-shadow: var(--shadow-md);
 }

 .comment-header {
 display: flex;
 justify-content: space-between;
 margin-bottom: 0.8rem;
 }

 .comment-author {
 font-weight: 600;
 color: #1e3a8a;
 }

 .comment-date {
 font-size: 0.85rem;
 color: var(--color-text-light);
 }

 .comment-text {
 font-size: 0.95rem;
 line-height: 1.6;
 color: #4b5563;
 }

 .comment-form {
 display: flex;
 flex-direction: column;
 gap: 1rem;
 }

 .comment-form textarea {
 resize: vertical;
 min-height: 100px;
 border-radius: var(--radius-sm);
 padding: 1rem;
 font-family: inherit;
 font-size: 0.95rem;
 }

 /* Collections Grid */
 .collections-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
 gap: 1.8rem;
 margin: 1.8rem 0;
 }

 .collection-card {
 border-radius: var(--radius-lg);
 overflow: hidden;
 box-shadow: var(--shadow-md);
 transition: all var(--transition-normal);
 background-color: var(--color-white);
 position: relative;
 border: 1px solid var(--color-border);
 }

 .collection-card:hover {
 transform: translateY(-6px);
 box-shadow: var(--shadow-lg);
 }

 .collection-image {
 width: 100%;
 height: 180px;
 object-fit: cover;
 transition: transform 0.5s ease;
 }

 .collection-card:hover .collection-image {
 transform: scale(1.05);
 }

 .collection-info {
 padding: 1.5rem;
 }

 .collection-title {
 margin-bottom: 0.8rem;
 font-size: 1.2rem;
 color: #1e3a8a;
 }

 .collection-stats {
 display: flex;
 justify-content: space-between;
 margin-top: 1.2rem;
 font-size: 0.85rem;
 color: var(--color-text-light);
 }

 .collection-actions {
 position: absolute;
 top: 12px;
 right: 12px;
 display: flex;
 gap: 0.6rem;
 }

 .collection-action-btn {
 width: 36px;
 height: 36px;
 border-radius: 50%;
 background-color: rgba(255, 255, 255, 0.9);
 border: none;
 display: flex;
 align-items: center;
 justify-content: center;
 cursor: pointer;
 font-size: 0.9rem;
 color: #475569;
 transition: all var(--transition-fast);
 box-shadow: var(--shadow-sm);
 }

 .collection-action-btn:hover {
 background-color: var(--color-white);
 color: var(--color-primary);
 transform: scale(1.1);
 }

 /* Collection Markers Modal */
 .collection-markers-modal {
 width: 800px;
 max-width: 95%;
 }

 .collection-markers-list {
 margin-top: 1.8rem;
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
 gap: 1.2rem;
 }

 .collection-marker-item {
 background-color: #f8fafc;
 border-radius: var(--radius-md);
 padding: 1.2rem;
 box-shadow: var(--shadow-sm);
 position: relative;
 transition: all var(--transition-normal);
 border: 1px solid var(--color-border);
 }

 .collection-marker-item:hover {
 transform: translateY(-3px);
 box-shadow: var(--shadow-md);
 }

 .collection-marker-title {
 font-weight: 600;
 margin-bottom: 0.8rem;
 color: #1e3a8a;
 }

 .collection-marker-category {
 display: inline-block;
 padding: 0.25rem 0.7rem;
 border-radius: var(--radius-full);
 font-size: 0.75rem;
 color: var(--color-white);
 margin-bottom: 0.8rem;
 font-weight: 600;
 }

 .collection-marker-category.architecture {
 background-color: var(--color-architecture);
 }

 .collection-marker-category.nature {
 background-color: var(--color-nature);
 }

 .collection-marker-category.events {
 background-color: var(--color-events);
 }

 .collection-marker-category.people {
 background-color: var(--color-people);
 }

 .remove-from-collection {
 position: absolute;
 top: 0.8rem;
 right: 0.8rem;
 width: 28px;
 height: 28px;
 border-radius: 50%;
 background-color: rgba(239, 68, 68, 0.1);
 border: none;
 color: var(--color-danger);
 display: flex;
 align-items: center;
 justify-content: center;
 cursor: pointer;
 font-size: 0.8rem;
 transition: background-color var(--transition-fast);
 z-index: 5;
 }

 .remove-from-collection:hover {
 background-color: rgba(239, 68, 68, 0.2);
 }

 /* Notification */
 .notification {
 display: none;
 position: fixed;
 top: 20px;
 right: 20px;
 padding: 1rem 1.5rem;
 border-radius: 10px;
 color: var(--color-white);
 font-weight: 500;
 z-index: 2000;
 animation: slideIn 0.3s ease-out;
 box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
 max-width: 350px;
 }

 .notification.info {
 background-color: #3b82f6;
 border-left: 5px solid #2563eb;
 }

 .notification.success {
 background-color: #10b981;
 border-left: 5px solid #059669;
 }

 .notification.error {
 background-color: var(--color-danger);
 border-left: 5px solid var(--color-danger-dark);
 }

 .notification.warning {
 background-color: #f59e0b;
 border-left: 5px solid #d97706;
 }

 @keyframes slideIn {
 from {
 transform: translateX(100%);
 opacity: 0;
 }
 to {
 transform: translateX(0);
 opacity: 1;
 }
 }

 /* Expanded Image Modal */
 .expanded-image-modal {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background-color: rgba(0, 0, 0, 0.9);
 z-index: 2000;
 justify-content: center;
 align-items: center;
 flex-direction: column;
 }

 .expanded-image {
 max-width: 90%;
 max-height: 80vh;
 object-fit: contain;
 border-radius: var(--radius-sm);
 box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
 animation: zoomIn 0.3s ease-out;
 }

 @keyframes zoomIn {
 from { transform: scale(0.95); opacity: 0; }
 to { transform: scale(1); opacity: 1; }
 }

 .expanded-image-title {
 color: var(--color-white);
 font-size: 1.3rem;
 margin-top: 1.5rem;
 text-align: center;
 text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
 }

 /* Info Button */
 .info-button {
 position: absolute;
 bottom: 20px;
 right: 20px;
 width: 36px;
 height: 36px;
 border-radius: 50%;
 background-color: rgba(255, 255, 255, 0.7);
 border: 1px solid rgba(200, 200, 200, 0.3);
 cursor: pointer;
 display: flex;
 align-items: center;
 justify-content: center;
 box-shadow: var(--shadow-sm);
 z-index: 10;
 transition: all var(--transition-normal);
 opacity: 0.8;
 }

 .info-button:hover {
 background-color: rgba(255, 255, 255, 0.9);
 opacity: 1;
 transform: scale(1.1);
 }

 .info-button i {
 color: #1e3a8a;
 font-size: 18px;
 }

 /* Recenter Button */
 .recenter-button {
 position: fixed;
 bottom: 20px;
 right: 20px;
 width: 48px;
 height: 48px;
 border-radius: 50%;
 background-color: var(--color-primary);
 color: var(--color-white);
 border: none;
 font-size: 1.5rem;
 cursor: pointer;
 box-shadow: var(--shadow-md);
 z-index: 1000;
 display: flex;
 align-items: center;
 justify-content: center;
 transition: all var(--transition-normal);
 }

 .recenter-button:hover {
 background-color: var(--color-primary-dark);
 transform: scale(1.1);
 box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
 }

 /* Leaderboard styling */
 .leaderboard {
 margin-top: 1.5rem;
 }

 .leaderboard-title {
 font-size: 1.3rem;
 font-weight: 600;
 color: #1e3a8a;
 margin-bottom: 1.2rem;
 text-align: center;
 padding-bottom: 0.8rem;
 border-bottom: 2px solid var(--color-border);
 }

 .leaderboard-item {
 display: flex;
 align-items: center;
 padding: 1rem;
 border-radius: 10px;
 margin-bottom: 0.8rem;
 background-color: #f8fafc;
 transition: all var(--transition-normal);
 border: 1px solid var(--color-border);
 }

 .leaderboard-item:hover {
 transform: translateY(-3px);
 box-shadow: var(--shadow-md);
 }

 .leaderboard-rank {
 font-size: 1.2rem;
 font-weight: 700;
 color: var(--color-primary);
 width: 40px;
 height: 40px;
 display: flex;
 align-items: center;
 justify-content: center;
 background-color: #e0e7ff;
 border-radius: 50%;
 margin-right: 1rem;
 }

 .leaderboard-user {
 flex: 1;
 font-weight: 600;
 color: #1e293b;
 }

 .leaderboard-points {
 font-weight: 600;
 color: #10b981;
 background-color: #ecfdf5;
 padding: 0.4rem 0.8rem;
 border-radius: var(--radius-full);
 }

 /* Copyright options */
 .copyright-options {
 margin-top: 15px;
 }
 
 .copyright-option {
 display: flex;
 align-items: center;
 margin-bottom: 10px;
 cursor: pointer;
 }
 
 .copyright-option input[type="checkbox"] {
 margin-right: 10px;
 width: 18px;
 height: 18px;
 cursor: pointer;
 }

 .copyright-option label {
 cursor: pointer;
 font-size: 0.95rem;
 color: #4b5563;
 }

 /* Return link */
 .return-link {
 display: inline-block;
 color: var(--color-white);
 background-color: rgba(255, 255, 255, 0.2);
 padding: 0.7rem 1.5rem;
 border-radius: var(--radius-full);
 font-weight: 500;
 transition: all var(--transition-normal);
 margin-top: 1rem;
 backdrop-filter: blur(5px);
 border: 1px solid rgba(255, 255, 255, 0.1);
 }

 .return-link:hover {
 background-color: rgba(255, 255, 255, 0.3);
 transform: translateY(-2px);
 color: var(--color-white);
 }

 /* Collections Feature Enhancements */
 .collections-empty-state {
 text-align: center;
 padding: 2rem;
 background-color: #f8fafc;
 border-radius: var(--radius-md);
 border: 1px dashed var(--color-border);
 margin: 1.5rem 0;
 }

 .collections-empty-state i {
 font-size: 3rem;
 color: var(--color-text-light);
 margin-bottom: 1rem;
 }

 .collections-empty-state h3 {
 margin-bottom: 0.5rem;
 color: #1e3a8a;
 }

 .collection-preview {
 display: flex;
 flex-wrap: wrap;
 gap: 0.5rem;
 margin-top: 1rem;
 }

 .collection-preview-item {
 width: 50px;
 height: 50px;
 border-radius: var(--radius-sm);
 object-fit: cover;
 transition: transform 0.2s;
 }

 .collection-preview-item:hover {
 transform: scale(1.1);
 z-index: 2;
 }

 .collection-preview-more {
 width: 50px;
 height: 50px;
 border-radius: var(--radius-sm);
 background-color: rgba(0, 0, 0, 0.5);
 color: var(--color-white);
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: bold;
 }

 .collection-filter {
 display: flex;
 align-items: center;
 gap: 1rem;
 margin-bottom: 1.5rem;
 }

 .collection-filter-input {
 flex: 1;
 padding: 0.7rem 1rem;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-full);
 font-size: 0.95rem;
 }

 .collection-filter-input:focus {
 outline: none;
 border-color: var(--color-primary);
 box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
 }

 .collection-sort {
 padding: 0.7rem 1rem;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 background-color: var(--color-white);
 cursor: pointer;
 }

 /* Responsive Adjustments */
 @media (max-width: 768px) {
 .hero-content h1 {
 font-size: 2.5rem;
 }

 .search-bar {
 flex-direction: column;
 border-radius: var(--radius-md);
 }

 .search-input, .search-button {
 width: 100%;
 border-radius: 0;
 }

 .search-input {
 border-radius: var(--radius-md) var(--radius-md) 0 0;
 }

 .search-button {
 border-radius: 0 0 var(--radius-md) var(--radius-md);
 }

 .map-search-bar {
 width: 90%;
 }

 #markerInfoModal {
 width: 95%;
 max-height: 85vh;
 }

 .marker-info-content {
 flex-direction: column;
 }

 .marker-image {
 max-height: 250px;
 object-fit: cover;
 }

 .category-selector {
 padding: 10px;
 width: 90%;
 }

 .category-badge {
 padding: 0.5rem 1rem;
 font-size: 0.85rem;
 }

 .collection-markers-list {
 grid-template-columns: 1fr;
 }
 }
 </style>
 </head>
 <body>
 <div class="floating-menu" id="floatingMenu">
 <button class="floating-btn" id="floatingBtn">☰</button>
 <div class="menu-content" id="menuContent">
 <a href="#" id="homeLink">Home</a>
 <a href="#" id="aboutLink">About Us</a>
 <a href="#" id="instructionsLink">Instructions</a>
 <a href="#" id="loginLink">Login/Join</a>
 <a href="#" id="collectionsLink">Collections</a>
 <a href="#" id="leaderboardLink">Leaderboard</a>
 </div>
 </div>

 <div class="page search-page" id="searchPage">
 <div class="hero-content">
 <h1>Community Markers</h1>
 <p>Discover and share meaningful places across Minnesota.</p>
 <div class="search-container">
 <div class="search-bar">
 <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput">
 <button class="search-button" id="searchButton">Search</button>
 </div>
 </div>
 <a href="https://www.mnthen.com" class="return-link">Return to Minnesota Then</a>
 </div>
 <div class="scroll-down" id="scrollDown">
 <span>View Map</span>
 <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
 <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
 </svg>
 </div>
 <button class="info-button" id="infoButton"><i class="fas fa-info"></i></button>
 </div>

 <div class="page map-page" id="mapPage">
 <div class="map-search-bar">
 <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput">
 <button class="map-search-button" id="mapSearchButton">
 <i class="fas fa-search"></i>
 </button>
 </div>
 <div id="map"></div>
 <div class="category-selector">
 <span class="category-badge architecture" data-category="architecture">Architecture</span>
 <span class="category-badge nature" data-category="nature">Nature</span>
 <span class="category-badge events" data-category="events">Events</span>
 <span class="category-badge people" data-category="people">People</span>
 </div>
 <button class="recenter-button" id="recenterButton"><i class="fas fa-crosshairs"></i></button>
 </div>

 <div id="overlay" class="overlay"></div>

 <div id="notification" class="notification"></div>

 <div id="authPopup" class="modal-base auth-popup">
 <button id="closePopup" class="close-btn">×</button>
 <div class="auth-container">
 <div class="auth-tabs">
 <button id="showLogin" class="auth-tab active">Login</button>
 <button id="showJoin" class="auth-tab">Join</button>
 </div>
 <form id="loginForm" class="auth-form">
 <div class="form-group">
 <label for="loginEmail">Email</label>
 <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
 </div>
 <div class="form-group">
 <label for="loginPassword">Password</label>
 <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
 </div>
 <button type="submit" id="loginButton" class="auth-button">Login</button>
 </form>
 <form id="joinForm" class="auth-form" style="display: none;">
 <div class="form-group">
 <label for="joinEmail">Email</label>
 <input type="email" id="joinEmail" class="form-input" placeholder="Enter your email" required>
 </div>
 <div class="form-group">
 <label for="joinPassword">Password</label>
 <input type="password" id="joinPassword" class="form-input" placeholder="Create a password" required>
 </div>
 <div class="form-group">
 <label for="joinFirstName">First Name</label>
 <input type="text" id="joinFirstName" class="form-input" placeholder="Enter your first name" required>
 </div>
 <div class="form-group">
 <label for="joinLastName">Last Name</label>
 <input type="text" id="joinLastName" class="form-input" placeholder="Enter your last name" required>
 </div>
 <div class="form-group">
 <label for="joinCity">City</label>
 <input type="text" id="joinCity" class="form-input" placeholder="Enter your city" required>
 </div>
 <button type="submit" id="joinButton" class="auth-button">Join</button>
 </form>
 </div>
 </div>

 <div id="aboutPopup" class="modal-base">
 <button id="closeAbout" class="close-btn">×</button>
 <h2>About Us</h2>
 <p>
 Community Markers is a platform that allows users to discover and share meaningful places across Minnesota. Our mission is to create a digital map that showcases the rich history, culture, and natural beauty of our state through the eyes of its residents and visitors.
 </p>
 <p>
 By creating and exploring markers on our interactive map, you can share your favorite locations, hidden gems, and historical sites with others. Whether it's a scenic overlook, a local restaurant, or a significant landmark, Community Markers helps preserve and celebrate the diverse experiences that make Minnesota unique.
 </p>
 <p>
 Join our growing community of explorers and storytellers as we map out the best of Minnesota, one marker at a time!
 </p>
 </div>

 <div id="instructionsPopup" class="modal-base">
 <button id="closeInstructions" class="close-btn">×</button>
 <h2>Instructions</h2>
 <ol>
 <li>To add a marker, click on the map at the desired location.</li>
 <li>Fill in the marker details, including title, description, and an optional image.</li>
 <li>Click "Submit for Review" to save your marker to the map.</li>
 <li>To view marker details, click on any marker on the map.</li>
 <li>Use the search bar to find specific locations in Minnesota.</li>
 <li>Filter markers by category using the category buttons at the bottom of the map.</li>
 <li>Create collections to organize markers by theme or location.</li>
 <li>Share your favorite markers on social media.</li>
 </ol>
 <p>Remember to respect others and follow community guidelines when adding markers. Enjoy exploring Minnesota!</p>
 </div>

 <div id="logoutPopup" class="modal-base auth-popup">
 <button id="cancelLogout" class="close-btn">×</button>
 <h2>Log Out</h2>
 <p>Are you sure you want to log out?</p>
 <button id="confirmLogout" class="auth-button">Log Out</button>
 </div>

 <div id="markerModal" class="modal-base">
 <button id="closeModal" class="close-btn">×</button>
 <h2>Add New Marker</h2>
 <form id="markerForm">
 <div class="form-group">
 <label for="title" class="form-label">Title (max 50 characters)</label>
 <input type="text" id="title" class="form-input" maxlength="50" required>
 </div>
 <div class="form-group">
 <label for="category" class="form-label">Category</label>
 <select id="category" class="form-input" required>
 <option value="">Select a category</option>
 <option value="architecture">Architecture</option>
 <option value="nature">Nature</option>
 <option value="events">Events</option>
 <option value="people">People</option>
 </select>
 </div>
 <div class="form-group">
 <label for="description" class="form-label">Description</label>
 <textarea id="description-editor"></textarea>
 </div>
 <div class="form-group">
 <label for="imageUpload" class="form-label">Image</label>
 <input type="file" id="imageUpload" class="form-input" accept="image/*">
 </div>
 <div class="form-group">
 <label for="date" class="form-label">Date</label>
 <input type="date" id="date" class="form-input" required>
 </div>
 <div class="form-group">
 <label class="form-label">Copyright Information</label>
 <div class="copyright-options">
 <div class="copyright-option">
 <input type="checkbox" id="creativeCommons" name="copyright" value="creativeCommons">
 <label for="creativeCommons">Creative Commons BY-NC 4.0</label>
 </div>
 <div class="copyright-option">
 <input type="checkbox" id="authorOwned" name="copyright" value="authorOwned">
 <label for="authorOwned">Author Owned</label>
 </div>
 </div>
 </div>
 <button type="submit" class="btn btn-primary">Submit for Review</button>
 </form>
 </div>

 <div id="markerInfoModal" class="modal-base" style="display: none;">
 <button id="closeMarkerInfo" class="close-btn">×</button>
 <div class="marker-info-content">
 <div class="marker-image-container">
 <img id="markerInfoImage" src="/placeholder.svg" alt="" class="marker-image">
 </div>
 
 <div class="marker-details">
 <h3 id="markerInfoTitle" class="marker-title"></h3>
 <p class="upload-info" id="markerInfoUploader"></p>
 <div class="category-tags" id="markerInfoCategories"></div>
 <p class="description" id="markerInfoDescription"></p>
 <div class="source-citation">
 <h4>Copyright Information</h4>
 <div class="copyright-info" id="markerInfoCopyright"></div>
 </div>
 <div class="marker-stats">
 <span id="markerInfoViews" class="stat-item">
 <i class="fas fa-eye"></i>
 <span>0 views</span>
 </span>
 <span id="markerInfoLikes" class="stat-item">
 <i class="fas fa-heart"></i>
 <span>0 likes</span>
 </span>
 </div>
 <div class="interaction-buttons" id="interactionButtons">
 <button id="likeButton" class="btn btn-primary">
 <i class="fas fa-heart"></i> Like
 </button>
 <button id="addToCollectionButton" class="btn btn-secondary">
 <i class="fas fa-folder-plus"></i> Add to Collection
 </button>
 <button id="reportButton" class="report-button">
 <i class="fas fa-flag"></i> Report
 </button>
 </div>
 <div class="share-buttons">
 <button class="share-button facebook">
 <i class="fab fa-facebook-f"></i>
 </button>
 <button class="share-button twitter">
 <i class="fab fa-twitter"></i>
 </button>
 <button class="share-button linkedin">
 <i class="fab fa-linkedin-in"></i>
 </button>
 </div>
 <div class="comments-section">
 <h3>Comments</h3>
 <div class="comments-list" id="commentsList"></div>
 <form class="comment-form" id="commentForm">
 <textarea class="form-input" placeholder="Add a comment..." required></textarea>
 <button type="submit" class="btn btn-primary">Post Comment</button>
 </form>
 </div>
 </div>
 </div>
 </div>

 <div id="expandedImageModal" class="expanded-image-modal">
 <img id="expandedImage" class="expanded-image" src="/placeholder.svg" alt="Expanded marker image">
 <h3 id="expandedImageTitle" class="expanded-image-title"></h3>
 </div>

 <div id="collectionsModal" class="modal-base">
 <button id="closeCollections" class="close-btn">×</button>
 <h2>Your Collections</h2>
 <div class="collection-filter">
 <input type="text" class="collection-filter-input" id="collectionSearchInput" placeholder="Search collections...">
 <select class="collection-sort" id="collectionSort">
 <option value="newest">Newest First</option>
 <option value="oldest">Oldest First</option>
 <option value="name">Name (A-Z)</option>
 <option value="markers">Most Markers</option>
 </select>
 </div>
 <div class="collections-grid" id="collectionsGrid"></div>
 <button id="createCollectionBtn" class="btn btn-primary">Create New Collection</button>
 </div>

 <div id="collectionMarkersModal" class="modal-base collection-markers-modal">
 <button id="closeCollectionMarkers" class="close-btn">×</button>
 <h2 id="collectionMarkersTitle">Collection Markers</h2>
 <p id="collectionMarkersDescription">View and manage markers in this collection.</p>
 <div class="collection-filter">
 <input type="text" class="collection-filter-input" id="collectionMarkerSearchInput" placeholder="Search markers in this collection...">
 <select class="collection-sort" id="collectionMarkerSort">
 <option value="newest">Newest First</option>
 <option value="oldest">Oldest First</option>
 <option value="name">Name (A-Z)</option>
 <option value="category">Category</option>
 </select>
 </div>
 <div class="collection-markers-list" id="collectionMarkersList"></div>
 </div>

 <div id="leaderboardModal" class="modal-base">
 <button id="closeLeaderboard" class="close-btn">×</button>
 <h2>Community Leaderboard</h2>
 <div class="leaderboard" id="leaderboardList"></div>
 </div>

 <div id="reportModal" class="modal-base">
 <button id="closeReport" class="close-btn">×</button>
 <h2>Report Inappropriate Content</h2>
 <form id="reportForm">
 <div class="form-group">
 <label class="form-label">Reason for Report</label>
 <select class="form-input" required>
 <option value="">Select a reason</option>
 <option value="inappropriate">Inappropriate Content</option>
 <option value="spam">Spam</option>
 <option value="offensive">Offensive Language</option>
 <option value="inaccurate">Inaccurate Information</option>
 <option value="other">Other</option>
 </select>
 </div>
 <div class="form-group">
 <label class="form-label">Additional Details</label>
 <textarea class="form-input" rows="4" required></textarea>
 </div>
 <button type="submit" class="btn btn-primary">Submit Report</button>
 </form>
 </div>

 <div id="citationModal" class="modal-base">
 <button id="closeCitation" class="close-btn">×</button>
 <h2>Image Citation</h2>
 <p>Image source: <a href="https://collection.mndigital.org/catalog/p16022coll55:121" target="_blank" rel="noopener noreferrer">MN Digital Library</a></p>
 <p>Photographer: Minneapolis Park & Recreation Board</p>
 <p>Description: Convention American Association of Park Superintendents, Minneapolis, August 11-13, 1908, at the foot of Minnehaha Falls, Minneapolis, Minnesota. (August 11-13, 1908)</p>
 </div>

 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
 <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

 <script>
 // Firebase Configuration
 const firebaseConfig = {
 apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
 authDomain: "mnthen-3151d.firebaseapp.com",
 projectId: "mnthen-3151d",
 storageBucket: "mnthen-3151d.appspot.com",
 messagingSenderId: "416231360428",
 appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
 };

 // Initialize Firebase
 let firebaseApp;
 if (!firebase.apps.length) {
 firebaseApp = firebase.initializeApp(firebaseConfig);
 } else {
 firebaseApp = firebase.app();
 }

 const auth = firebaseApp.auth();
 const database = firebaseApp.database();
 const storage = firebaseApp.storage();

 // Map Variables
 let map = null;
 let markers = null;
 let tempMarker = null;
 let markerIcons = {};

 // Global Variables
 let currentUser = null;
 let currentMarkerId = null;
 let selectedCategories = new Set();
 let currentCollectionId = null;
 let allCollections = [];
 let allMarkers = [];

 // Profanity Filter
 const profanityList = [
 // Sexual references
 "ass", "asshole", "bastard", "bitch", "cock", "cunt", "dick", "pussy", 
 "slut", "whore", "prick", "twat", 

 // Vulgar language
 "fuck", "fucking", "shit", "shitty", "crap", "piss", "damn", "hell", 
 "dammit", "bullshit", "motherfucker", "fuckwit", 

 // Derogatory terms
 "jag", "dipshit", "douchebag", "douche", "asshat", "jackass", 
 "nimrod", "moron", "imbecile", "idiot", 

 // Offensive slurs (generic, removed specific group-based slurs)
 "retard", "tard", "dumb", 

 // Crude anatomical references
 "tits", "boobs", "balls", "screw", 

 // Political/controversial additions
 "Trump", "Wisconsin",

 // Variations and common misspellings
 "fk", "fck", "sh1t", "f u c k", "b i t c h"
 ];

 function containsProfanity(text) {
 if (!text) return false;
 
 // Normalize text thoroughly
 const normalizedText = text.toLowerCase().replace(/[^a-z0-9]/g, '');
 
 // Check for full word matches and subword matches
 return profanityList.some(profanity => {
 // Exact word match
 const wordRegex = new RegExp(`\\b${profanity}\\b`, 'i');
 
 // Substring match to catch variations
 const substringMatch = normalizedText.includes(profanity);
 
 return wordRegex.test(text) || substringMatch;
 });
 }

 // Points System Configuration
 const POINTS = {
 ADD_MARKER: 10,
 RECEIVE_LIKE: 5,
 ADD_COMMENT: 2,
 MARKER_VIEW: 1,
 };

 // Badge System Configuration
 const BADGES = {
 NEWCOMER: { name: "Newcomer", icon: "star", requirement: 1 },
 CONTRIBUTOR: { name: "Active Contributor", icon: "pen", requirement: 5 },
 HISTORIAN: { name: "Local Historian", icon: "book", requirement: 10 },
 PHOTOGRAPHER: { name: "Photography Expert", icon: "camera", requirement: 15 },
 EXPLORER: { name: "Minnesota Explorer", icon: "compass", requirement: 20 },
 };

 // DOM Elements
 const floatingBtn = document.getElementById("floatingBtn");
 const menuContent = document.getElementById("menuContent");
 const loginLink = document.getElementById("loginLink");
 const authPopup = document.getElementById("authPopup");
 const closePopup = document.getElementById("closePopup");
 const joinForm = document.getElementById("joinForm");
 const loginForm = document.getElementById("loginForm");
 const showLogin = document.getElementById("showLogin");
 const showJoin = document.getElementById("showJoin");
 const joinButton = document.getElementById("joinButton");
 const loginButton = document.getElementById("loginButton");
 const notification = document.getElementById("notification");
 const searchPage = document.getElementById("searchPage");
 const mapPage = document.getElementById("mapPage");
 const scrollDown = document.getElementById("scrollDown");
 const searchInput = document.getElementById("searchInput");
 const searchButton = document.getElementById("searchButton");
 const mapSearchInput = document.getElementById("mapSearchInput");
 const mapSearchButton = document.getElementById("mapSearchButton");
 const markerModal = document.getElementById("markerModal");
 const closeModal = document.getElementById("closeModal");
 const markerForm = document.getElementById("markerForm");
 const titleInput = document.getElementById("title");
 const categoryInput = document.getElementById("category");
 const imageUpload = document.getElementById("imageUpload");
 const dateInput = document.getElementById("date");
 const creativeCommonsCheckbox = document.getElementById("creativeCommons");
 const authorOwnedCheckbox = document.getElementById("authorOwned");
 const aboutLink = document.getElementById("aboutLink");
 const aboutPopup = document.getElementById("aboutPopup");
 const overlay = document.getElementById("overlay");
 const closeAbout = document.getElementById("closeAbout");
 const logoutPopup = document.getElementById("logoutPopup");
 const confirmLogout = document.getElementById("confirmLogout");
 const cancelLogout = document.getElementById("cancelLogout");
 const instructionsLink = document.getElementById("instructionsLink");
 const instructionsPopup = document.getElementById("instructionsPopup");
 const closeInstructions = document.getElementById("closeInstructions");
 const markerInfoModal = document.getElementById("markerInfoModal");
 const closeMarkerInfo = document.getElementById("closeMarkerInfo");
 const markerInfoImage = document.getElementById("markerInfoImage");
 const markerInfoTitle = document.getElementById("markerInfoTitle");
 const markerInfoDescription = document.getElementById("markerInfoDescription");
 const markerInfoCategories = document.getElementById("markerInfoCategories");
 const markerInfoCopyright = document.getElementById("markerInfoCopyright");
 const markerInfoViews = document.getElementById("markerInfoViews");
 const markerInfoUploader = document.getElementById("markerInfoUploader");
 const markerInfoLikes = document.getElementById("markerInfoLikes");
 const likeButton = document.getElementById("likeButton");
 const addToCollectionButton = document.getElementById("addToCollectionButton");
 const reportButton = document.getElementById("reportButton");
 const interactionButtons = document.getElementById("interactionButtons");
 const commentsList = document.getElementById("commentsList");
 const commentForm = document.getElementById("commentForm");
 const expandedImageModal = document.getElementById("expandedImageModal");
 const expandedImage = document.getElementById("expandedImage");
 const expandedImageTitle = document.getElementById("expandedImageTitle");
 const collectionsLink = document.getElementById("collectionsLink");
 const collectionsModal = document.getElementById("collectionsModal");
 const closeCollections = document.getElementById("closeCollections");
 const collectionMarkersModal = document.getElementById("collectionMarkersModal");
 const closeCollectionMarkers = document.getElementById("closeCollectionMarkers");
 const collectionMarkersTitle = document.getElementById("collectionMarkersTitle");
 const collectionMarkersDescription = document.getElementById("collectionMarkersDescription");
 const collectionMarkersList = document.getElementById("collectionMarkersList");
 const leaderboardLink = document.getElementById("leaderboardLink");
 const leaderboardModal = document.getElementById("leaderboardModal");
 const closeLeaderboard = document.getElementById("closeLeaderboard");
 const reportModal = document.getElementById("reportModal");
 const closeReport = document.getElementById("closeReport");
 const homeLink = document.getElementById("homeLink");
 const categoryBadges = document.querySelectorAll(".category-badge");
 const infoButton = document.getElementById("infoButton");
 const citationModal = document.getElementById("citationModal");
 const closeCitation = document.getElementById("closeCitation");
 const recenterButton = document.getElementById("recenterButton");
 const collectionSearchInput = document.getElementById("collectionSearchInput");
 const collectionSort = document.getElementById("collectionSort");
 const collectionMarkerSearchInput = document.getElementById("collectionMarkerSearchInput");
 const collectionMarkerSort = document.getElementById("collectionMarkerSort");

 // Initialize Suneditor
 const editor = SUNEDITOR.create('description-editor', {
 height: '300px',
 buttonList: [
 ['undo', 'redo'],
 ['font', 'fontSize', 'formatBlock'],
 ['bold', 'underline', 'italic', 'strike', 'subscript', 'superscript'],
 ['fontColor', 'hiliteColor'],
 ['align', 'list'],
 ['link', 'image'],
 ['fullScreen', 'showBlocks', 'codeView'],
 ],
 });

 // Create custom marker icons for each category
 function createMarkerIcons() {
 const iconOptions = {
 iconSize: [25, 41],
 iconAnchor: [12, 41],
 popupAnchor: [1, -34],
 shadowSize: [41, 41]
 };

 // Create custom marker icons for each category
 markerIcons = {
 architecture: L.divIcon({
 className: 'custom-marker architecture',
 html: `<i class="fas fa-building" style="color: var(--color-architecture);"></i>`,
 iconSize: [30, 30],
 iconAnchor: [15, 15]
 }),
 nature: L.divIcon({
 className: 'custom-marker nature',
 html: `<i class="fas fa-leaf" style="color: var(--color-nature);"></i>`,
 iconSize: [30, 30],
 iconAnchor: [15, 15]
 }),
 events: L.divIcon({
 className: 'custom-marker events',
 html: `<i class="fas fa-calendar-alt" style="color: var(--color-events);"></i>`,
 iconSize: [30, 30],
 iconAnchor: [15, 15]
 }),
 people: L.divIcon({
 className: 'custom-marker people',
 html: `<i class="fas fa-users" style="color: var(--color-people);"></i>`,
 iconSize: [30, 30],
 iconAnchor: [15, 15]
 }),
 default: L.divIcon({
 className: 'custom-marker default',
 html: `<i class="fas fa-map-marker-alt" style="color: var(--color-primary);"></i>`,
 iconSize: [30, 30],
 iconAnchor: [15, 15]
 })
 };

 // Add CSS for marker icons
 const style = document.createElement('style');
 style.textContent = `
 .custom-marker {
 display: flex;
 align-items: center;
 justify-content: center;
 background-color: white;
 border-radius: 50%;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
 width: 30px !important;
 height: 30px !important;
 transition: transform 0.2s;
 }
 .custom-marker:hover {
 transform: scale(1.2);
 z-index: 1000 !important;
 }
 .custom-marker i {
 font-size: 16px;
 }
 .custom-marker.architecture i { color: var(--color-architecture); }
 .custom-marker.nature i { color: var(--color-nature); }
 .custom-marker.events i { color: var(--color-events); }
 .custom-marker.people i { color: var(--color-people); }
 `;
 document.head.appendChild(style);
 }

 // Initialize Map Function
 function initializeMap() {
 if (!map && document.getElementById("map")) {
 map = L.map("map", {
 zoomControl: false,
 attributionControl: true
 }).setView([44.9778, -93.265], 10);

 L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
 attribution: '',
 maxZoom: 18,
 }).addTo(map);

 // Create custom marker icons
 createMarkerIcons();

 // Add zoom control to bottom left
 L.control.zoom({
 position: 'bottomleft'
 }).addTo(map);

 markers = L.markerClusterGroup({
 iconCreateFunction: function(cluster) {
 return L.divIcon({
 html: `<div class="cluster-icon">${cluster.getChildCount()}</div>`,
 className: 'custom-cluster',
 iconSize: L.point(40, 40)
 });
 }
 });
 
 // Add CSS for cluster icons
 const style = document.createElement('style');
 style.textContent = `
 .custom-cluster {
 background-color: var(--color-primary);
 color: white;
 border-radius: 50%;
 text-align: center;
 line-height: 40px;
 font-weight: bold;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
 }
 .cluster-icon {
 width: 100%;
 height: 100%;
 display: flex;
 align-items: center;
 justify-content: center;
 }
 `;
 document.head.appendChild(style);
 
 map.addLayer(markers);

 // Add map click handler
 map.on("click", (e) => {
 if (!currentUser) {
 showNotification("Please log in to add markers.", "error");
 return;
 }
 if (tempMarker) map.removeLayer(tempMarker);
 tempMarker = L.marker(e.latlng, {
 icon: markerIcons.default
 }).addTo(map);
 markerModal.style.display = "block";
 overlay.style.display = "block";
 });

 // Load existing markers
 loadMarkers();
 
 // Make sure map takes up 100% of the screen view
 const mapContainer = document.getElementById("map");
 mapContainer.style.height = "100vh";
 mapContainer.style.width = "100%";
 
 // Force map to update its size after initialization
 setTimeout(() => {
 map.invalidateSize();
 }, 100);
 }
 }

 // Load Markers Function
 function loadMarkers() {
 if (!markers) return;

 markers.clearLayers();
 allMarkers = [];

 database.ref("markers").once("value", (snapshot) => {
 snapshot.forEach((childSnapshot) => {
 const markerData = childSnapshot.val();
 markerData.id = childSnapshot.key;
 allMarkers.push(markerData);

 // Filter by selected categories if any are selected
 if (selectedCategories.size === 0 || selectedCategories.has(markerData.category)) {
 addMarkerToMap(markerData);
 }
 });
 });
 }

 // Add Marker to Map Function
 function addMarkerToMap(markerData) {
 const icon = markerData.category && markerIcons[markerData.category] 
 ? markerIcons[markerData.category] 
 : markerIcons.default;
 
 const marker = L.marker([markerData.lat, markerData.lng], {
 icon: icon
 });
 
 const popupContent = `
 <div class="marker-popup">
 <h2><a href="#" class="title-link" data-marker-id="${markerData.id}">${markerData.title}</a></h2>
 <p class="description">${stripHtml(markerData.description).split(" ").slice(0, 10).join(" ")}${stripHtml(markerData.description).split(" ").length > 10 ? "..." : ""}</p>
 </div>
 `;
 marker.bindPopup(popupContent);

 // Use on('popupopen') instead of trying to access the DOM node directly
 marker.on('popupopen', function() {
 setTimeout(() => {
 const titleLink = document.querySelector(`.title-link[data-marker-id="${markerData.id}"]`);
 if (titleLink) {
 titleLink.addEventListener("click", (e) => {
 e.preventDefault();
 updateMarkerInfoModal(markerData);
 markerInfoModal.style.display = "block";
 overlay.style.display = "block";
 marker.closePopup();
 });
 }
 }, 100); // Small delay to ensure DOM is ready
 });

 markers.addLayer(marker);
 }

 // Update Marker Info Modal Function
 function updateMarkerInfoModal(data) {
 currentMarkerId = data.id;
 markerInfoTitle.textContent = data.title;

 if (data.image) {
 markerInfoImage.src = data.image;
 markerInfoImage.style.cursor = "pointer";
 markerInfoImage.onclick = () => {
 expandedImageModal.style.display = "flex";
 expandedImage.src = data.image;
 expandedImage.alt = data.title;
 expandedImageTitle.textContent = data.title;
 overlay.style.zIndex = "1000";
 expandedImageModal.style.zIndex = "2000";
 };
 } else {
 markerInfoImage.src = "https://via.placeholder.com/400x300?text=No+Image+Available";
 markerInfoImage.style.cursor = "default";
 markerInfoImage.onclick = null;
 }

 markerInfoImage.alt = data.title;
 markerInfoUploader.innerHTML = `<i class="fas fa-user"></i> Taken by ${data.uploaderName || "Anonymous"} on ${new Date(data.date).toLocaleDateString()}`;
 
 // Display plain text description instead of HTML
 markerInfoDescription.textContent = data.description ? stripHtml(data.description) : "";
 
 // Display copyright information
 if (data.copyright) {
 let copyrightText = "";
 if (data.copyright.creativeCommons) {
 copyrightText += "Licensed under Creative Commons BY-NC 4.0.";
 }
 if (data.copyright.authorOwned) {
 copyrightText += copyrightText ? ", Author Owned" : "All associated content is author owned.";
 }
 markerInfoCopyright.textContent = `${copyrightText || "Not specified"}`;
 } else {
 markerInfoCopyright.textContent = "Not specified";
 }
 
 markerInfoViews.innerHTML = `<i class="fas fa-eye"></i> <span>${data.views || 0} views</span>`;
 markerInfoLikes.innerHTML = `<i class="fas fa-heart"></i> <span>${data.likes || 0} likes</span>`;

 markerInfoCategories.innerHTML = `
 <span class="category-tag ${data.category || 'architecture'}">${data.category ? data.category.charAt(0).toUpperCase() + data.category.slice(1) : 'Uncategorized'}</span>
 `;

 loadComments(data.id).then((comments) => {
 commentsList.innerHTML = comments.length > 0 ?
 comments
 .map(
 (comment) => `
 <div class="comment">
 <div class="comment-header">
 <span class="comment-author">${comment.userName || "Anonymous"}</span>
 <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
 </div>
 <p class="comment-text">${comment.text}</p>
 </div>
 `
 )
 .join("")
 : "<p>No comments yet. Be the first to comment!</p>";
 });

 database.ref(`markers/${data.id}/views`).transaction((currentViews) => {
 return (currentViews || 0) + 1;
 }).then(() => {
 if (currentUser) {
 updateUserPoints(POINTS.MARKER_VIEW);
 }
 });

 updateLikeButtonState();
 }
 
 // Helper function to strip HTML tags
 function stripHtml(html) {
 if (!html) return "";
 const temp = document.createElement("div");
 temp.innerHTML = html;
 return temp.textContent || temp.innerText || "";
 }

 // Load Comments Function
 function loadComments(markerId) {
 return database.ref(`comments/${markerId}`).once("value").then((snapshot) => {
 const comments = [];
 snapshot.forEach((childSnapshot) => {
 comments.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });
 return comments;
 });
 }

 // Update Like Button State Function
 function updateLikeButtonState() {
 if (!currentUser || !currentMarkerId) {
 likeButton.disabled = true;
 likeButton.innerHTML = '<i class="far fa-heart"></i> Login to Like';
 return;
 }

 likeButton.disabled = false;

 database.ref(`likes/${currentMarkerId}/${currentUser.uid}`).once("value", (snapshot) => {
 if (snapshot.exists()) {
 likeButton.classList.add("liked");
 likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
 } else {
 likeButton.classList.remove("liked");
 likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
 }
 });
 }

 // Show Notification Function
 function showNotification(message, type) {
 notification.textContent = message;
 notification.className = `notification ${type}`;
 notification.style.display = "block";

 setTimeout(() => {
 notification.style.display = "none";
 }, 3000);
 }

 // Update User Points Function
 function updateUserPoints(points) {
 if (!currentUser) return;

 const userPointsRef = database.ref(`users/${currentUser.uid}/points`);

 userPointsRef.transaction((currentPoints) => {
 return (currentPoints || 0) + points;
 }).then(() => {
 checkForBadges();
 });
 }

 // Check for Badges Function
 function checkForBadges() {
 if (!currentUser) return;

 database.ref(`users/${currentUser.uid}/points`).once("value", (snapshot) => {
 const points = snapshot.val() || 0;
 const earnedBadges = [];

 for (const [badgeId, badge] of Object.entries(BADGES)) {
 if (points >= badge.requirement) {
 earnedBadges.push(badgeId);
 }
 }

 database.ref(`users/${currentUser.uid}/badges`).set(earnedBadges);
 });
 }

 // Load User Data Function
 function loadUserData() {
 if (!currentUser) return;

 database.ref(`users/${currentUser.uid}`).once("value", (snapshot) => {
 const userData = snapshot.val() || {};

 if (userData.firstName && userData.lastName) {
 currentUser.displayName = `${userData.firstName} ${userData.lastName}`;
 }

 // Update UI based on user data
 loginLink.textContent = "Logout";
 loginLink.removeEventListener("click", showLoginPopup);
 loginLink.addEventListener("click", showLogoutPopup);
 });
 }

 // Show Login Popup Function
 function showLoginPopup(e) {
 e.preventDefault();
 authPopup.style.display = "block";
 overlay.style.display = "block";
 }

 // Show Logout Popup Function
 function showLogoutPopup(e) {
 e.preventDefault();
 logoutPopup.style.display = "block";
 overlay.style.display = "block";
 }

 // Initialize Map and Firebase when the DOM is fully loaded
 document.addEventListener("DOMContentLoaded", () => {
 // Show search page first
 searchPage.style.display = "flex";
 mapPage.style.display = "none";

 // Initialize Firebase Auth state
 auth.onAuthStateChanged((user) => {
 currentUser = user;

 if (user) {
 showNotification("Welcome back!", "success");
 loadUserData();
 loginLink.textContent = "Logout";
 loginLink.removeEventListener("click", showLoginPopup);
 loginLink.addEventListener("click", showLogoutPopup);
 } else {
 loginLink.textContent = "Login/Join";
 loginLink.removeEventListener("click", showLogoutPopup);
 loginLink.addEventListener("click", showLoginPopup);
 }
 });

 // Initialize map if mapPage is displayed
 const mapPageObserver = new MutationObserver((mutations) => {
 mutations.forEach((mutation) => {
 if (mutation.attributeName === "style") {
 if (mapPage.style.display === "block" && !map) {
 initializeMap();
 }
 }
 });
 });

 mapPageObserver.observe(mapPage, {
 attributes: true, // Monitor style changes
 });
 });

 // Event Listeners
 floatingBtn.addEventListener("click", () => {
 menuContent.style.display = menuContent.style.display === "block" ? "none" : "block";
 });

 menuContent.addEventListener("click", (e) => {
 if (e.target.tagName === "A") {
 menuContent.style.display = "none";
 }
 });

 showLogin.addEventListener("click", () => {
 loginForm.style.display = "block";
 joinForm.style.display = "none";
 showLogin.classList.add("active");
 showJoin.classList.remove("active");
 });

 showJoin.addEventListener("click", () => {
 loginForm.style.display = "none";
 joinForm.style.display = "block";
 showJoin.classList.add("active");
 showLogin.classList.remove("active");
 });

 closePopup.addEventListener("click", () => {
 authPopup.style.display = "none";
 overlay.style.display = "none";
 });

 loginForm.addEventListener("submit", (e) => {
 e.preventDefault();
 const email = document.getElementById("loginEmail").value;
 const password = document.getElementById("loginPassword").value;

 auth.signInWithEmailAndPassword(email, password)
 .then((userCredential) => {
 showNotification("Logged in successfully", "success");
 authPopup.style.display = "none";
 overlay.style.display = "none";
 currentUser = userCredential.user;

 // Load user data (including displayName)
 loadUserData();
 })
 .catch((error) => {
 showNotification(error.message, "error");
 });
 });

 joinForm.addEventListener("submit", (e) => {
 e.preventDefault();
 const email = document.getElementById("joinEmail").value;
 const password = document.getElementById("joinPassword").value;
 const firstName = document.getElementById("joinFirstName").value;
 const lastName = document.getElementById("joinLastName").value;
 const city = document.getElementById("joinCity").value;

 auth.createUserWithEmailAndPassword(email, password)
 .then((userCredential) => {
 currentUser = userCredential.user;
 return database.ref("users/" + userCredential.user.uid).set({
 firstName: firstName,
 lastName: lastName,
 city: city,
 email: email,
 points: 0,
 badges: [],
 joinDate: Date.now(),
 });
 })
 .then(() => {
 showNotification("Account created successfully", "success");
 authPopup.style.display = "none";
 overlay.style.display = "none";
 loadUserData();
 })
 .catch((error) => {
 showNotification(error.message, "error");
 });
 });

 confirmLogout.addEventListener("click", () => {
 auth.signOut().then(() => {
 showNotification("Logged out successfully", "success");
 logoutPopup.style.display = "none";
 overlay.style.display = "none";
 currentUser = null;
 loginLink.textContent = "Login/Join";
 loginLink.removeEventListener("click", showLogoutPopup);
 loginLink.addEventListener("click", showLoginPopup);
 }).catch((error) => {
 showNotification(error.message, "error");
 });
 });

 cancelLogout.addEventListener("click", () => {
 logoutPopup.style.display = "none";
 overlay.style.display = "none";
 });

 aboutLink.addEventListener("click", (e) => {
 e.preventDefault();
 aboutPopup.style.display = "block";
 overlay.style.display = "block";
 });

 closeAbout.addEventListener("click", () => {
 aboutPopup.style.display = "none";
 overlay.style.display = "none";
 });

 instructionsLink.addEventListener("click", (e) => {
 e.preventDefault();
 instructionsPopup.style.display = "block";
 overlay.style.display = "block";
 });

 closeInstructions.addEventListener("click", () => {
 instructionsPopup.style.display = "none";
 overlay.style.display = "none";
 });

 markerForm.addEventListener("submit", (e) => {
 e.preventDefault();

 // Get form values
 const title = titleInput.value;
 const category = categoryInput.value;
 const description = editor.getContents(); // Get content from Suneditor
 const date = dateInput.value;
 
 // Get copyright information
 const copyright = {
 creativeCommons: creativeCommonsCheckbox.checked,
 authorOwned: authorOwnedCheckbox.checked
 };

 // Check for profanity
 if (containsProfanity(title) || containsProfanity(stripHtml(description))) {
 showNotification("Please watch your language! Your submission contains inappropriate words.", "error");
 return;
 }

 // Check if a location is selected
 if (!tempMarker) {
 showNotification("Please select a location on the map", "error");
 return;
 }

 // Prepare marker data
 const newMarkerRef = database.ref("markers").push();
 const newMarker = {
 id: newMarkerRef.key,
 title: title,
 category: category,
 description: description,
 lat: tempMarker.getLatLng().lat,
 lng: tempMarker.getLatLng().lng,
 uploaderName: currentUser.displayName || "Anonymous",
 uploaderId: currentUser.uid,
 date: date,
 timestamp: Date.now(),
 views: 0,
 likes: 0,
 copyright: copyright
 };

 // Handle image upload (if applicable)
 if (imageUpload.files.length > 0) {
 const file = imageUpload.files[0];
 const storageRef = storage.ref("marker_images/" + newMarkerRef.key);

 storageRef.put(file).then((snapshot) => {
 return snapshot.ref.getDownloadURL();
 }).then((downloadURL) => {
 newMarker.image = downloadURL; // Add image URL to marker data
 return newMarkerRef.set(newMarker);
 }).then(() => {
 showNotification("Marker added successfully", "success");
 markerModal.style.display = "none";
 overlay.style.display = "none";
 map.removeLayer(tempMarker);
 tempMarker = null;
 markerForm.reset();
 editor.setContents(""); // Clear Suneditor content
 addMarkerToMap(newMarker);
 updateUserPoints(POINTS.ADD_MARKER);
 }).catch((error) => {
 showNotification(error.message, "error");
 });
 } else {
 // If no image is uploaded
 newMarkerRef.set(newMarker).then(() => {
 showNotification("Marker added successfully", "success");
 markerModal.style.display = "none";
 overlay.style.display = "none";
 map.removeLayer(tempMarker);
 tempMarker = null;
 markerForm.reset();
 editor.setContents(""); // Clear Suneditor content
 addMarkerToMap(newMarker);
 updateUserPoints(POINTS.ADD_MARKER);
 }).catch((error) => {
 showNotification(error.message, "error");
 });
 }
 });

 closeModal.addEventListener("click", () => {
 markerModal.style.display = "none";
 overlay.style.display = "none";
 if (tempMarker) {
 map.removeLayer(tempMarker);
 tempMarker = null;
 }
 });

 searchButton.addEventListener("click", () => {
 const searchTerm = searchInput.value;
 if (searchTerm.trim() === "") {
 showNotification("Please enter a search term", "error");
 return;
 }

 // Switch to map page
 searchPage.style.display = "none";
 mapPage.style.display = "block";

 // Initialize map if not already done
 if (!map) {
 initializeMap();
 }

 // Perform search
 performSearch(searchTerm);
 });

 mapSearchButton.addEventListener("click", () => {
 const searchTerm = mapSearchInput.value;
 if (searchTerm.trim() === "") {
 showNotification("Please enter a search term", "error");
 return;
 }
 performSearch(searchTerm);
 });

 function performSearch(searchTerm) {
 // Add Minnesota to the search if not already included
 if (!searchTerm.toLowerCase().includes("minnesota") && !searchTerm.toLowerCase().includes("mn")) {
 searchTerm = searchTerm + " Minnesota";
 }
 
 const geocodingUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}`;
 
 fetch(geocodingUrl)
 .then((response) => response.json())
 .then((data) => {
 // Filter results to only include Minnesota locations
 const mnResults = data.filter(result => {
 // Check if the display name contains Minnesota or MN
 return (result.display_name.toLowerCase().includes("minnesota") || 
 result.display_name.toLowerCase().includes(", mn,")) &&
 // Verify the result is in the US
 result.display_name.toLowerCase().includes("united states");
 });
 
 if (mnResults.length > 0) {
 const result = mnResults[0];
 map.setView([result.lat, result.lon], 13);
 
 // Use correct singular/plural form based on number of results
 const resultText = mnResults.length === 1 ? "result" : "results";
 showNotification(`Found ${mnResults.length} ${resultText} for "${searchTerm}"`, "success");
 } else {
 showNotification("No locations found in Minnesota", "error");
 }
 })
 .catch((error) => {
 console.error("Error:", error);
 showNotification("An error occurred while searching", "error");
 });
 }

 scrollDown.addEventListener("click", () => {
 searchPage.style.display = "none";
 mapPage.style.display = "block";

 // Initialize map if not already done
 if (!map) {
 initializeMap();
 }
 });

 homeLink.addEventListener("click", (e) => {
 e.preventDefault();
 searchPage.style.display = "flex";
 mapPage.style.display = "none";
 });

 likeButton.addEventListener("click", () => {
 if (!currentUser) {
 showNotification("Please log in to like markers", "error");
 return;
 }

 if (!currentMarkerId) return;

 const likeRef = database.ref(`likes/${currentMarkerId}/${currentUser.uid}`);
 const markerLikesRef = database.ref(`markers/${currentMarkerId}/likes`);

 likeRef.once("value", (snapshot) => {
 if (snapshot.exists()) {
 // User has already liked, so unlike
 likeRef.remove();
 markerLikesRef.transaction((currentLikes) => (currentLikes || 1) - 1);
 likeButton.classList.remove("liked");
 likeButton.innerHTML = '<i class="far fa-heart"></i> Like';
 showNotification("You unliked this marker", "success");
 } else {
 // User hasn't liked, so add like
 likeRef.set(true);
 markerLikesRef.transaction((currentLikes) => (currentLikes || 0) + 1);
 likeButton.classList.add("liked");
 likeButton.innerHTML = '<i class="fas fa-heart"></i> Liked';
 showNotification("You liked this marker", "success");

 // Update marker uploader's points
 database.ref(`markers/${currentMarkerId}`).once("value", (snapshot) => {
 const markerData = snapshot.val();
 if (markerData && markerData.uploaderId && markerData.uploaderId !== currentUser.uid) {
 const uploaderPointsRef = database.ref(`users/${markerData.uploaderId}/points`);
 uploaderPointsRef.transaction((currentPoints) => (currentPoints || 0) + POINTS.RECEIVE_LIKE);
 }
 });
 }
 });
 });

 addToCollectionButton.addEventListener("click", () => {
 if (!currentUser) {
 showNotification("Please log in to add markers to collections", "error");
 return;
 }

 if (!currentMarkerId) {
 showNotification("No marker selected", "error");
 return;
 }

 showCollectionSelector(currentMarkerId);
 });

 reportButton.addEventListener("click", () => {
 if (!currentUser) {
 showNotification("Please log in to report markers", "error");
 return;
 }

 reportModal.style.display = "block";
 overlay.style.display = "block";
 });

 document.getElementById("reportForm").addEventListener("submit", (e) => {
 e.preventDefault();
 const reason = e.target.querySelector("select").value;
 const details = e.target.querySelector("textarea").value;

 // Check for profanity
 if (containsProfanity(details)) {
 showNotification("Please watch your language! Your report contains inappropriate words.", "error");
 return;
 }

 if (!currentUser) {
 showNotification("Please log in to report markers", "error");
 return;
 }

 if (!currentMarkerId) {
 showNotification("No marker selected", "error");
 return;
 }

 const reportRef = database.ref("reports").push();
 reportRef.set({
 markerId: currentMarkerId,
 reporterId: currentUser.uid,
 reporterName: currentUser.displayName || "Anonymous",
 reason: reason,
 details: details,
 timestamp: Date.now(),
 status: "pending",
 }).then(() => {
 showNotification("Report submitted successfully", "success");
 reportModal.style.display = "none";
 overlay.style.display = "none";
 e.target.reset();
 }).catch((error) => {
 showNotification(error.message, "error");
 });
 });

 commentForm.addEventListener("submit", (e) => {
 e.preventDefault();
 const text = e.target.querySelector("textarea").value;

 // Check for profanity
 if (containsProfanity(text)) {
 showNotification("Please watch your language! Your comment contains inappropriate words.", "error");
 return;
 }

 if (!currentUser) {
 showNotification("Please log in to add comments", "error");
 return;
 }

 if (!currentMarkerId) {
 showNotification("No marker selected", "error");
 return;
 }

 const commentRef = database.ref(`comments/${currentMarkerId}`).push();
 commentRef.set({
 userId: currentUser.uid,
 userName: currentUser.displayName || "Anonymous", // Use displayName if available
 text: text,
 timestamp: Date.now(),
 }).then(() => {
 showNotification("Comment added successfully", "success");
 e.target.reset();
 updateUserPoints(POINTS.ADD_COMMENT);

 // Reload comments
 loadComments(currentMarkerId).then((comments) => {
 commentsList.innerHTML = comments
 .map(
 (comment) => `
 <div class="comment">
 <div class="comment-header">
 <span class="comment-author">${comment.userName}</span>
 <span class="comment-date">${new Date(comment.timestamp).toLocaleDateString()}</span>
 </div>
 <p class="comment-text">${comment.text}</p>
 </div>
 `
 )
 .join("");
 });
 }).catch((error) => {
 showNotification(error.message, "error");
 });
 });

 document.querySelectorAll(".share-button").forEach((button) => {
 button.addEventListener("click", () => {
 if (!currentMarkerId) {
 showNotification("No marker selected", "error");
 return;
 }

 const platform = button.classList[1];
 const markerData = {
 title: markerInfoTitle.textContent,
 description: markerInfoDescription.textContent,
 };

 shareMarker(platform, markerData);
 });
 });

 closeMarkerInfo.addEventListener("click", () => {
 markerInfoModal.style.display = "none";
 overlay.style.display = "none";
 });

 expandedImageModal.addEventListener("click", (e) => {
 if (e.target === expandedImageModal) {
 expandedImageModal.style.display = "none";
 overlay.style.zIndex = "1000";
 }
 });

 collectionsLink.addEventListener("click", (e) => {
 e.preventDefault();

 if (!currentUser) {
 showNotification("Please log in to view collections", "error");
 return;
 }

 loadCollections();
 collectionsModal.style.display = "block";
 overlay.style.display = "block";
 });

 closeCollections.addEventListener("click", () => {
 collectionsModal.style.display = "none";
 overlay.style.display = "none";
 });

 closeCollectionMarkers.addEventListener("click", () => {
 collectionMarkersModal.style.display = "none";
 overlay.style.display = "none";
 });

 leaderboardLink.addEventListener("click", (e) => {
 e.preventDefault();
 loadLeaderboard();
 leaderboardModal.style.display = "block";
 overlay.style.display = "block";
 });

 closeLeaderboard.addEventListener("click", () => {
 leaderboardModal.style.display = "none";
 overlay.style.display = "none";
 });

 closeReport.addEventListener("click", () => {
 reportModal.style.display = "none";
 overlay.style.display = "none";
 });

 categoryBadges.forEach((badge) => {
 badge.addEventListener("click", () => {
 const category = badge.dataset.category;

 if (badge.classList.contains("active")) {
 badge.classList.remove("active");
 selectedCategories.delete(category);
 } else {
 badge.classList.add("active");
 selectedCategories.add(category);
 }

 loadMarkers();
 });
 });

 infoButton.addEventListener("click", () => {
 citationModal.style.display = "block";
 overlay.style.display = "block";
 });

 closeCitation.addEventListener("click", () => {
 citationModal.style.display = "none";
 overlay.style.display = "none";
 });

 recenterButton.addEventListener("click", () => {
 if (map) {
 map.setView([44.9778, -93.265], 10);
 }
 });

 // Collection search and sort functionality
 collectionSearchInput.addEventListener("input", (e) => {
 filterCollections(e.target.value, collectionSort.value);
 });

 collectionSort.addEventListener("change", (e) => {
 filterCollections(collectionSearchInput.value, e.target.value);
 });

 collectionMarkerSearchInput.addEventListener("input", (e) => {
 filterCollectionMarkers(e.target.value, collectionMarkerSort.value);
 });

 collectionMarkerSort.addEventListener("change", (e) => {
 filterCollectionMarkers(collectionMarkerSearchInput.value, e.target.value);
 });

 // Collections Feature
 function loadCollections() {
 if (!currentUser) return;

 const collectionsGrid = document.getElementById("collectionsGrid");
 collectionsGrid.innerHTML = '<div class="loading">Loading collections...</div>';

 database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
 allCollections = [];
 
 if (!snapshot.exists()) {
 showEmptyCollectionsState();
 return;
 }

 snapshot.forEach((childSnapshot) => {
 allCollections.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });

 if (allCollections.length === 0) {
 showEmptyCollectionsState();
 return;
 }

 renderCollections(allCollections);
 });
 }

 function showEmptyCollectionsState() {
 const collectionsGrid = document.getElementById("collectionsGrid");
 collectionsGrid.innerHTML = `
 <div class="collections-empty-state">
 <i class="fas fa-folder-open"></i>
 <h3>No Collections Yet</h3>
 <p>Create your first collection to organize markers by theme or location.</p>
 </div>
 `;
 }

 function renderCollections(collections) {
 const collectionsGrid = document.getElementById("collectionsGrid");
 
 collectionsGrid.innerHTML = collections
 .map(collection => {
 // Get preview images for collection
 const markerIds = Object.keys(collection.markers || {});
 const markerCount = markerIds.length;
 
 // Find marker images for preview
 const previewMarkers = allMarkers.filter(marker => 
 markerIds.includes(marker.id) && marker.image
 ).slice(0, 4);
 
 const previewHTML = previewMarkers.length > 0 
 ? `
 <div class="collection-preview">
 ${previewMarkers.map(marker => 
 `<img src="${marker.image}" alt="${marker.title}" class="collection-preview-item">`
 ).join('')}
 ${markerCount > 4 ? `<div class="collection-preview-more">+${markerCount - 4}</div>` : ''}
 </div>
 ` 
 : '';
 
 return `
 <div class="collection-card">
 <img src="${collection.image || "https://via.placeholder.com/300x150?text=Collection"}" class="collection-image" alt="${collection.name}">
 <div class="collection-actions">
 <button class="collection-action-btn view-collection" data-collection-id="${collection.id}" title="View Markers">
 <i class="fas fa-eye"></i>
 </button>
 <button class="collection-action-btn edit-collection" data-collection-id="${collection.id}" title="Edit Collection">
 <i class="fas fa-edit"></i>
 </button>
 <button class="collection-action-btn delete-collection" data-collection-id="${collection.id}" title="Delete Collection">
 <i class="fas fa-trash"></i>
 </button>
 </div>
 <div class="collection-info">
 <h3 class="collection-title">${collection.name}</h3>
 <p>${collection.description || "No description"}</p>
 ${previewHTML}
 <div class="collection-stats">
 <span><i class="fas fa-map-marker-alt"></i> ${markerCount} marker${markerCount !== 1 ? 's' : ''}</span>
 <span><i class="fas fa-calendar-alt"></i> Created ${new Date(collection.created).toLocaleDateString()}</span>
 </div>
 </div>
 </div>
 `;
 })
 .join("");
 
 // Add event listeners to the view, edit, and delete buttons
 document.querySelectorAll('.view-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.currentTarget.dataset.collectionId;
 viewCollectionMarkers(collectionId);
 });
 });
 
 document.querySelectorAll('.edit-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.currentTarget.dataset.collectionId;
 editCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.delete-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.currentTarget.dataset.collectionId;
 deleteCollection(collectionId);
 });
 });
 }

 function filterCollections(searchTerm, sortOption) {
 if (!allCollections.length) return;
 
 let filteredCollections = [...allCollections];
 
 // Apply search filter
 if (searchTerm) {
 const term = searchTerm.toLowerCase();
 filteredCollections = filteredCollections.filter(collection => 
 collection.name.toLowerCase().includes(term) || 
 (collection.description && collection.description.toLowerCase().includes(term))
 );
 }
 
 // Apply sort
 switch(sortOption) {
 case 'newest':
 filteredCollections.sort((a, b) => b.created - a.created);
 break;
 case 'oldest':
 filteredCollections.sort((a, b) => a.created - b.created);
 break;
 case 'name':
 filteredCollections.sort((a, b) => a.name.localeCompare(b.name));
 break;
 case 'markers':
 filteredCollections.sort((a, b) => 
 Object.keys(b.markers || {}).length - Object.keys(a.markers || {}).length
 );
 break;
 }
 
 renderCollections(filteredCollections);
 }

 document.getElementById("createCollectionBtn").addEventListener("click", () => {
 const name = prompt("Enter collection name:");
 if (!name) return;
 
 const description = prompt("Enter collection description (optional):");
 
 createCollection(name, description)
 .then(() => {
 showNotification("Collection created successfully", "success");
 loadCollections();
 })
 .catch((error) => {
 showNotification(error.message, "error");
 });
 });

 function createCollection(name, description) {
 if (!currentUser) return Promise.reject(new Error("User not logged in"));

 const collectionRef = database.ref(`collections/${currentUser.uid}`).push();
 return collectionRef.set({
 name,
 description,
 created: Date.now(),
 markers: {},
 }).then(() => collectionRef.key);
 }

 function editCollection(collectionId) {
 if (!currentUser) return;
 
 const collection = allCollections.find(c => c.id === collectionId);
 if (!collection) {
 showNotification("Collection not found", "error");
 return;
 }
 
 const newName = prompt("Enter new collection name:", collection.name);
 if (!newName) return;
 
 const newDescription = prompt("Enter new collection description:", collection.description || "");
 
 database.ref(`collections/${currentUser.uid}/${collectionId}`).update({
 name: newName,
 description: newDescription
 }).then(() => {
 showNotification("Collection updated successfully", "success");
 loadCollections();
 }).catch(error => {
 showNotification(error.message, "error");
 });
 }

 function addMarkerToCollection(markerId, collectionId) {
 if (!currentUser) return Promise.reject(new Error("User not logged in"));

 return database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).set(true)
 .then(() => {
 showNotification("Marker added to collection", "success");
 })
 .catch((error) => {
 showNotification(error.message, "error");
 });
 }

 function viewCollectionMarkers(collectionId) {
 if (!currentUser) return;
 
 currentCollectionId = collectionId;
 
 database.ref(`collections/${currentUser.uid}/${collectionId}`).once("value", (snapshot) => {
 const collection = snapshot.val();
 if (!collection) {
 showNotification("Collection not found", "error");
 return;
 }
 
 collectionMarkersTitle.textContent = collection.name;
 collectionMarkersDescription.textContent = collection.description || "View and manage markers in this collection.";
 
 // Get markers in this collection
 const markerIds = Object.keys(collection.markers || {});
 
 if (markerIds.length === 0) {
 collectionMarkersList.innerHTML = `
 <div class="collections-empty-state">
 <i class="fas fa-map-marker-alt"></i>
 <h3>No Markers Yet</h3>
 <p>Add markers to this collection by clicking "Add to Collection" when viewing a marker.</p>
 </div>
 `;
 collectionMarkersModal.style.display = "block";
 overlay.style.display = "block";
 return;
 }
 
 collectionMarkersList.innerHTML = '<div class="loading">Loading markers...</div>';
 
 // Fetch marker details for each marker ID
 const markerPromises = markerIds.map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 if (validMarkers.length === 0) {
 collectionMarkersList.innerHTML = `
 <div class="collections-empty-state">
 <i class="fas fa-exclamation-triangle"></i>
 <h3>No Valid Markers Found</h3>
 <p>The markers in this collection may have been deleted.</p>
 </div>
 `;
 return;
 }
 
 // Store markers for filtering
 const collectionMarkers = validMarkers;
 
 renderCollectionMarkers(collectionMarkers);
 });
 
 collectionMarkersModal.style.display = "block";
 overlay.style.display = "block";
 });
 }

 function renderCollectionMarkers(markers) {
 collectionMarkersList.innerHTML = markers
 .map(marker => `
 <div class="collection-marker-item">
 <button class="remove-from-collection" data-marker-id="${marker.id}" title="Remove from collection">
 <i class="fas fa-times"></i>
 </button>
 <h4 class="collection-marker-title">${marker.title}</h4>
 <span class="collection-marker-category ${marker.category}">${marker.category ? marker.category.charAt(0).toUpperCase() + marker.category.slice(1) : 'Uncategorized'}</span>
 <p>${stripHtml(marker.description).substring(0, 100)}${stripHtml(marker.description).length > 100 ? '...' : ''}</p>
 <button class="btn btn-primary view-marker-btn" data-marker-id="${marker.id}">View Marker</button>
 </div>
 `)
 .join('');
 
 // Add event listeners to the view and remove buttons
 document.querySelectorAll('.view-marker-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const markerId = e.target.dataset.markerId;
 viewMarkerFromCollection(markerId);
 });
 });
 
 document.querySelectorAll('.remove-from-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const markerId = e.target.closest('.remove-from-collection').dataset.markerId;
 removeMarkerFromCollection(markerId, currentCollectionId);
 });
 });
 }

 function filterCollectionMarkers(searchTerm, sortOption) {
 if (!currentCollectionId) return;
 
 database.ref(`collections/${currentUser.uid}/${currentCollectionId}`).once("value", (snapshot) => {
 const collection = snapshot.val();
 if (!collection) return;
 
 const markerIds = Object.keys(collection.markers || {});
 if (markerIds.length === 0) return;
 
 // Get all markers in this collection
 const markerPromises = markerIds.map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 let validMarkers = markers.filter(marker => marker !== null);
 
 // Apply search filter
 if (searchTerm) {
 const term = searchTerm.toLowerCase();
 validMarkers = validMarkers.filter(marker => 
 marker.title.toLowerCase().includes(term) || 
 stripHtml(marker.description).toLowerCase().includes(term) ||
 marker.category.toLowerCase().includes(term)
 );
 }
 
 // Apply sort
 switch(sortOption) {
 case 'newest':
 validMarkers.sort((a, b) => b.timestamp - a.timestamp);
 break;
 case 'oldest':
 validMarkers.sort((a, b) => a.timestamp - b.timestamp);
 break;
 case 'name':
 validMarkers.sort((a, b) => a.title.localeCompare(b.title));
 break;
 case 'category':
 validMarkers.sort((a, b) => a.category.localeCompare(b.category));
 break;
 }
 
 renderCollectionMarkers(validMarkers);
 });
 });
 }

 function viewMarkerFromCollection(markerId) {
 database.ref(`markers/${markerId}`).once("value", (snapshot) => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 updateMarkerInfoModal(markerData);
 collectionMarkersModal.style.display = "none";
 markerInfoModal.style.display = "block";
 } else {
 showNotification("Marker not found", "error");
 }
 });
 }

 function removeMarkerFromCollection(markerId, collectionId) {
 if (!currentUser || !collectionId) return;
 
 database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).remove()
 .then(() => {
 showNotification("Marker removed from collection", "success");
 // Refresh the collection markers view
 viewCollectionMarkers(collectionId);
 })
 .catch(error => {
 showNotification(error.message, "error");
 });
 }

 function deleteCollection(collectionId) {
 if (!currentUser) return;
 
 if (confirm("Are you sure you want to delete this collection? This action cannot be undone.")) {
 database.ref(`collections/${currentUser.uid}/${collectionId}`).remove()
 .then(() => {
 showNotification("Collection deleted successfully", "success");
 loadCollections();
 })
 .catch(error => {
 showNotification(error.message, "error");
 });
 }
 }

 function showCollectionSelector(markerId) {
 if (!currentUser) {
 showNotification("Please log in to add markers to collections", "error");
 return;
 }

 const collectionSelectorModal = document.createElement("div");
 collectionSelectorModal.className = "modal-base";
 collectionSelectorModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Add to Collection</h2>
 <div id="collectionList" class="collections-grid"></div>
 <button id="newCollectionBtn" class="btn btn-primary">Create New Collection</button>
 `;
 document.body.appendChild(collectionSelectorModal);
 collectionSelectorModal.style.display = "block";
 overlay.style.display = "block";

 const closeBtn = collectionSelectorModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 collectionSelectorModal.style.display = "none";
 overlay.style.display = "none";
 collectionSelectorModal.remove();
 });

 const collectionList = document.getElementById("collectionList");
 const newCollectionBtn = document.getElementById("newCollectionBtn");

 loadUserCollections(collectionList, markerId);

 newCollectionBtn.addEventListener("click", () => createNewCollection(markerId, collectionSelectorModal));
 }

 function loadUserCollections(collectionList, markerId) {
 database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
 collectionList.innerHTML = "";
 
 if (!snapshot.exists()) {
 collectionList.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
 return;
 }
 
 const collections = [];
 snapshot.forEach((childSnapshot) => {
 collections.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });

 if (collections.length === 0) {
 collectionList.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
 return;
 }

 // Check if marker is already in any collections
 const checkPromises = collections.map(collection => {
 return database.ref(`collections/${currentUser.uid}/${collection.id}/markers/${markerId}`).once("value")
 .then(snapshot => {
 collection.hasMarker = snapshot.exists();
 return collection;
 });
 });

 Promise.all(checkPromises).then(checkedCollections => {
 collectionList.innerHTML = checkedCollections
 .map(
 (collection) => `
 <div class="collection-card">
 <img src="${collection.image || "https://via.placeholder.com/300x150?text=Collection"}" class="collection-image" alt="${collection.name}">
 <div class="collection-info">
 <h3 class="collection-title">${collection.name}</h3>
 <p>${collection.description || "No description"}</p>
 <div class="collection-stats">
 <span><i class="fas fa-map-marker-alt"></i> ${Object.keys(collection.markers || {}).length} markers</span>
 </div>
 ${collection.hasMarker ? 
 `<button class="btn btn-secondary remove-from-collection-btn" data-collection-id="${collection.id}" data-marker-id="${markerId}">
 <i class="fas fa-minus-circle"></i> Remove from collection
 </button>` : 
 `<button class="btn btn-primary add-to-collection-btn" data-collection-id="${collection.id}" data-marker-id="${markerId}">
 <i class="fas fa-plus-circle"></i> Add to collection
 </button>`
 }
 </div>
 </div>
 `
 )
 .join("");
 
 // Add event listeners to the newly created buttons
 document.querySelectorAll('.add-to-collection-btn[data-marker-id]').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.add-to-collection-btn').dataset.collectionId;
 const markerId = e.target.closest('.add-to-collection-btn').dataset.markerId;
 addMarkerToCollection(markerId, collectionId)
 .then(() => {
 // Update button to show it's now in the collection
 const button = e.target.closest('.add-to-collection-btn');
 button.classList.remove('btn-primary');
 button.classList.add('btn-secondary', 'remove-from-collection-btn');
 button.classList.remove('add-to-collection-btn');
 button.innerHTML = '<i class="fas fa-minus-circle"></i> Remove from collection';
 
 // Add the remove event listener
 button.addEventListener('click', removeHandler);
 });
 });
 });
 
 // Function for remove handler to avoid duplication
 function removeHandler(e) {
 const button = e.target.closest('.remove-from-collection-btn');
 const collectionId = button.dataset.collectionId;
 const markerId = button.dataset.markerId;
 
 removeMarkerFromCollection(markerId, collectionId)
 .then(() => {
 // Update button to show it's no longer in the collection
 button.classList.remove('btn-secondary', 'remove-from-collection-btn');
 button.classList.add('btn-primary', 'add-to-collection-btn');
 button.innerHTML = '<i class="fas fa-plus-circle"></i> Add to collection';
 
 // Remove this handler and add the add handler
 button.removeEventListener('click', removeHandler);
 button.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.add-to-collection-btn').dataset.collectionId;
 const markerId = e.target.closest('.add-to-collection-btn').dataset.markerId;
 addMarkerToCollection(markerId, collectionId);
 });
 });
 }
 
 // Add event listeners for remove buttons
 document.querySelectorAll('.remove-from-collection-btn[data-marker-id]').forEach(btn => {
 btn.addEventListener('click', removeHandler);
 });
 });
 });
 }

 function createNewCollection(markerId, modalElement) {
 const name = prompt("Enter collection name:");
 if (!name) return;
 
 const description = prompt("Enter collection description (optional):");
 
 createCollection(name, description)
 .then((collectionId) => {
 return addMarkerToCollection(markerId, collectionId);
 })
 .then(() => {
 showNotification("Marker added to new collection", "success");
 
 // Close the modal if it exists
 if (modalElement) {
 modalElement.style.display = "none";
 overlay.style.display = "none";
 modalElement.remove();
 }
 })
 .catch((error) => {
 showNotification(error.message, "error");
 });
 }

 // Enhanced version of addMarkerToCollection that returns a promise
 function addMarkerToCollection(markerId, collectionId) {
 if (!currentUser) return Promise.reject(new Error("User not logged in"));

 return database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).set(true)
 .then(() => {
 showNotification("Marker added to collection", "success");
 
 // Get the marker data to update collection thumbnail if needed
 return database.ref(`markers/${markerId}`).once("value");
 })
 .then((snapshot) => {
 const markerData = snapshot.val();
 
 // If the marker has an image and the collection doesn't, use it as the collection image
 if (markerData && markerData.image) {
 return database.ref(`collections/${currentUser.uid}/${collectionId}/image`).once("value")
 .then((imageSnapshot) => {
 if (!imageSnapshot.exists()) {
 // Set the collection image to the marker image
 return database.ref(`collections/${currentUser.uid}/${collectionId}/image`).set(markerData.image);
 }
 return Promise.resolve();
 });
 }
 return Promise.resolve();
 })
 .catch((error) => {
 showNotification(error.message, "error");
 return Promise.reject(error);
 });
 }

 // Enhanced version of removeMarkerFromCollection that returns a promise
 function removeMarkerFromCollection(markerId, collectionId) {
 if (!currentUser || !collectionId) return Promise.reject(new Error("User not logged in or collection ID missing"));
 
 return database.ref(`collections/${currentUser.uid}/${collectionId}/markers/${markerId}`).remove()
 .then(() => {
 showNotification("Marker removed from collection", "success");
 return Promise.resolve();
 })
 .catch(error => {
 showNotification(error.message, "error");
 return Promise.reject(error);
 });
 }

 // Leaderboard Feature
 function loadLeaderboard() {
 const leaderboardList = document.getElementById("leaderboardList");
 leaderboardList.innerHTML = '<div class="loading">Loading leaderboard...</div>';
 
 database.ref("users")
 .orderByChild("points")
 .limitToLast(10)
 .once("value", (snapshot) => {
 const users = [];
 
 snapshot.forEach((childSnapshot) => {
 const userData = childSnapshot.val();
 // Only include users with both first and last names defined
 if (userData.firstName && userData.lastName) {
 users.push({
 id: childSnapshot.key,
 ...userData,
 });
 }
 });
 
 users.reverse(); // Highest points first
 
 if (users.length === 0) {
 leaderboardList.innerHTML = "<p>No users on the leaderboard yet.</p>";
 return;
 }
 
 leaderboardList.innerHTML = `
 <div class="leaderboard-container">
 <div class="leaderboard-header">
 <h2>Top Contributors</h2>
 </div>
 <div class="leaderboard-content">
 ${users
 .map((user, index) => {
 const rank = index + 1;
 let rankClass = "";
 
 // Add special styling for top 3
 if (rank === 1) rankClass = "gold";
 else if (rank === 2) rankClass = "silver";
 else if (rank === 3) rankClass = "bronze";
 
 // Get badges for this user
 const badges = user.badges || [];
 const badgeIcons = badges.map(badge => {
 const badgeInfo = BADGES[badge];
 return badgeInfo ? `<span class="badge-icon" title="${badgeInfo.name}"><i class="fas fa-${badgeInfo.icon}"></i></span>` : '';
 }).join('');
 
 return `
 <div class="leaderboard-item ${rankClass}">
 <div class="leaderboard-rank">${rank}</div>
 <div class="leaderboard-user">
 ${user.firstName} ${user.lastName}
 <div class="user-badges">${badgeIcons}</div>
 </div>
 <div class="leaderboard-points">${user.points || 0} pts</div>
 </div>
 `;
 })
 .join("")}
 </div>
 </div>
 `;
 
 // Add CSS for improved styling
 if (!document.getElementById("leaderboardStyles")) {
 const styleEl = document.createElement("style");
 styleEl.id = "leaderboardStyles";
 styleEl.textContent = `
 .leaderboard-container {
 background: #ffffff;
 border-radius: 8px;
 border: 2px solid #1a4b8c;
 overflow: hidden;
 margin: 20px 0;
 }
 .leaderboard-header {
 background: #ffffff;
 color: #1a4b8c;
 padding: 16px 20px;
 border-bottom: 1px solid #e0e0e0;
 }
 .leaderboard-header h2 {
 margin: 0;
 font-size: 1.5rem;
 }
 .leaderboard-content {
 padding: 10px;
 }
 .leaderboard-item {
 display: flex;
 align-items: center;
 padding: 12px 15px;
 border-bottom: 1px solid #eee;
 transition: background-color 0.2s;
 }
 .leaderboard-item:hover {
 background-color: #f9f9f9;
 }
 .leaderboard-rank {
 font-weight: bold;
 width: 40px;
 height: 40px;
 border-radius: 50%;
 background: #f0f0f0;
 display: flex;
 align-items: center;
 justify-content: center;
 margin-right: 15px;
 }
 .leaderboard-user {
 flex: 1;
 font-weight: 500;
 }
 .user-badges {
 display: flex;
 gap: 5px;
 margin-top: 5px;
 }
 .badge-icon {
 color: #1a4b8c;
 font-size: 0.9rem;
 }
 .leaderboard-points {
 font-weight: bold;
 color: #1a4b8c;
 background-color: #e0e7ff;
 padding: 0.4rem 0.8rem;
 border-radius: 50px;
 }
 .gold .leaderboard-rank {
 background: linear-gradient(135deg, #FFD700, #FFC800);
 color: #7D6608;
 }
 .silver .leaderboard-rank {
 background: linear-gradient(135deg, #C0C0C0, #E0E0E0);
 color: #555;
 }
 .bronze .leaderboard-rank {
 background: linear-gradient(135deg, #CD7F32, #E0955B);
 color: #6E4523;
 }
 `;
 document.head.appendChild(styleEl);
 }
 });
 }

 // Social Sharing
 function shareMarker(platform, marker) {
 const url = window.location.href;
 const text = `Check out this interesting location in Minnesota: ${marker.title}`;

 const shareUrls = {
 facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
 twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
 linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(marker.title)}`,
 };

 window.open(shareUrls[platform], "_blank");
 }

 // Custom marker icons based on category
 function createCategoryIcon(category) {
 // Define colors for each category (matching the category badge colors)
 const colors = {
 architecture: "#2563eb",
 nature: "#10b981",
 events: "#f59e0b",
 people: "#8b5cf6",
 default: "#2563eb"
 };
 
 const color = colors[category] || colors.default;
 
 return L.divIcon({
 className: 'custom-marker',
 html: `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%; border: 2px solid white;"></div>`,
 iconSize: [24, 24],
 iconAnchor: [12, 12]
 });
 }

 // Update the addMarkerToMap function to use category-based icons
 function addMarkerToMap(markerData) {
 const icon = createCategoryIcon(markerData.category);
 const marker = L.marker([markerData.lat, markerData.lng], { icon: icon });
 
 const popupContent = `
 <div class="marker-popup">
 <h2><a href="#" class="title-link" data-marker-id="${markerData.id}">${markerData.title}</a></h2>
 <p class="description">${markerData.description.split(" ").slice(0, 10).join(" ")}${markerData.description.split(" ").length > 10 ? "..." : ""}</p>
 </div>
 `;
 marker.bindPopup(popupContent);

 // Use on('popupopen') instead of trying to access the DOM node directly
 marker.on('popupopen', function() {
 setTimeout(() => {
 const titleLink = document.querySelector(`.title-link[data-marker-id="${markerData.id}"]`);
 if (titleLink) {
 titleLink.addEventListener("click", (e) => {
 e.preventDefault();
 updateMarkerInfoModal(markerData);
 markerInfoModal.style.display = "block";
 overlay.style.display = "block";
 marker.closePopup();
 });
 }
 }, 100); // Small delay to ensure DOM is ready
 });

 markers.addLayer(marker);
 }

 // Document click handler for closing modals when clicking outside
 document.addEventListener("click", (e) => {
 if (e.target === overlay) {
 document.querySelectorAll(".modal-base").forEach((modal) => {
 modal.style.display = "none";
 });
 expandedImageModal.style.display = "none";
 overlay.style.display = "none";
 }
 });

 // Make sure the map takes up 100% of the screen view when displayed
 window.addEventListener('resize', () => {
 if (map) {
 map.invalidateSize();
 }
 });

 // Close expanded image when clicking on it
 expandedImageModal.addEventListener('click', () => {
 expandedImageModal.style.display = "none";
 overlay.style.zIndex = "1000";
 });

 // Initialize the application
 document.addEventListener('DOMContentLoaded', () => {
 // Initialize tooltips for better UX
 document.querySelectorAll('[title]').forEach(element => {
 element.setAttribute('data-tooltip', element.getAttribute('title'));
 element.removeAttribute('title');
 });
 
 // Show search page first
 searchPage.style.display = "flex";
 mapPage.style.display = "none";

 // Initialize Firebase Auth state
 auth.onAuthStateChanged((user) => {
 currentUser = user;

 if (user) {
 showNotification("Welcome back!", "success");
 loadUserData();
 loginLink.textContent = "Logout";
 loginLink.removeEventListener("click", showLoginPopup);
 loginLink.addEventListener("click", showLogoutPopup);
 } else {
 loginLink.textContent = "Login/Join";
 loginLink.removeEventListener("click", showLogoutPopup);
 loginLink.addEventListener("click", showLoginPopup);
 }
 });

 // Initialize map if mapPage is displayed
 const mapPageObserver = new MutationObserver((mutations) => {
 mutations.forEach((mutation) => {
 if (mutation.attributeName === "style") {
 if (mapPage.style.display === "block" && !map) {
 initializeMap();
 }
 }
 });
 });

 mapPageObserver.observe(mapPage, {
 attributes: true, // Monitor style changes
 });
 });

 // Export collections feature
 function exportCollection(collectionId) {
 if (!currentUser || !collectionId) return;
 
 database.ref(`collections/${currentUser.uid}/${collectionId}`).once("value")
 .then(snapshot => {
 const collection = snapshot.val();
 if (!collection) {
 showNotification("Collection not found", "error");
 return;
 }
 
 // Get markers in this collection
 const markerIds = Object.keys(collection.markers || {});
 
 if (markerIds.length === 0) {
 showNotification("No markers in this collection to export", "warning");
 return;
 }
 
 // Fetch marker details for each marker ID
 const markerPromises = markerIds.map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 if (validMarkers.length === 0) {
 showNotification("No valid markers found in this collection", "error");
 return;
 }
 
 // Create export data
 const exportData = {
 name: collection.name,
 description: collection.description,
 created: collection.created,
 exportDate: Date.now(),
 markers: validMarkers.map(marker => ({
 title: marker.title,
 category: marker.category,
 description: stripHtml(marker.description),
 lat: marker.lat,
 lng: marker.lng,
 date: marker.date,
 uploaderName: marker.uploaderName
 }))
 };
 
 // Convert to JSON and create download link
 const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
 const downloadAnchorNode = document.createElement('a');
 downloadAnchorNode.setAttribute("href", dataStr);
 downloadAnchorNode.setAttribute("download", `${collection.name.replace(/\s+/g, '_')}_collection.json`);
 document.body.appendChild(downloadAnchorNode);
 downloadAnchorNode.click();
 downloadAnchorNode.remove();
 
 showNotification("Collection exported successfully", "success");
 });
 })
 .catch(error => {
 showNotification("Error exporting collection: " + error.message, "error");
 });
 }

 // Print collection feature
 function printCollection(collectionId) {
 if (!currentUser || !collectionId) return;
 
 database.ref(`collections/${currentUser.uid}/${collectionId}`).once("value")
 .then(snapshot => {
 const collection = snapshot.val();
 if (!collection) {
 showNotification("Collection not found", "error");
 return;
 }
 
 // Get markers in this collection
 const markerIds = Object.keys(collection.markers || {});
 
 if (markerIds.length === 0) {
 showNotification("No markers in this collection to print", "warning");
 return;
 }
 
 // Fetch marker details for each marker ID
 const markerPromises = markerIds.map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 if (validMarkers.length === 0) {
 showNotification("No valid markers found in this collection", "error");
 return;
 }
 
 // Create print window
 const printWindow = window.open('', '_blank');
 
 // Generate HTML content
 let printContent = `
 <!DOCTYPE html>
 <html>
 <head>
 <title>${collection.name} - Collection Print</title>
 <style>
 body {
 font-family: Arial, sans-serif;
 line-height: 1.6;
 margin: 20px;
 color: #333;
 }
 h1 {
 color: #1e3a8a;
 border-bottom: 2px solid #e2e8f0;
 padding-bottom: 10px;
 }
 .collection-info {
 margin-bottom: 30px;
 }
 .marker {
 margin-bottom: 30px;
 page-break-inside: avoid;
 border: 1px solid #e2e8f0;
 border-radius: 8px;
 padding: 15px;
 }
 .marker h2 {
 color: #1e3a8a;
 margin-top: 0;
 }
 .category {
 display: inline-block;
 padding: 3px 10px;
 border-radius: 20px;
 color: white;
 font-size: 12px;
 font-weight: bold;
 margin-bottom: 10px;
 }
 .architecture { background-color: #2563eb; }
 .nature { background-color: #10b981; }
 .events { background-color: #f59e0b; }
 .people { background-color: #8b5cf6; }
 .coordinates {
 font-size: 12px;
 color: #64748b;
 margin-bottom: 10px;
 }
 .uploader {
 font-style: italic;
 color: #64748b;
 font-size: 12px;
 margin-top: 10px;
 }
 @media print {
 body {
 font-size: 12pt;
 }
 h1 {
 font-size: 18pt;
 }
 h2 {
 font-size: 14pt;
 }
 }
 </style>
 </head>
 <body>
 <h1>${collection.name}</h1>
 <div class="collection-info">
 <p>${collection.description || "No description provided."}</p>
 <p>Created: ${new Date(collection.created).toLocaleDateString()}</p>
 <p>Number of markers: ${validMarkers.length}</p>
 </div>
 `;
 
 // Add each marker
 validMarkers.forEach(marker => {
 printContent += `
 <div class="marker">
 <h2>${marker.title}</h2>
 <span class="category ${marker.category}">${marker.category.charAt(0).toUpperCase() + marker.category.slice(1)}</span>
 <div class="coordinates">Coordinates: ${marker.lat.toFixed(6)}, ${marker.lng.toFixed(6)}</div>
 <p>${stripHtml(marker.description)}</p>
 <div class="uploader">Added by ${marker.uploaderName || "Anonymous"} on ${new Date(marker.date).toLocaleDateString()}</div>
 </div>
 `;
 });
 
 printContent += `
 </body>
 </html>
 `;
 
 printWindow.document.open();
 printWindow.document.write(printContent);
 printWindow.document.close();
 
 // Wait for content to load then print
 printWindow.onload = function() {
 printWindow.print();
 };
 
 showNotification("Collection prepared for printing", "success");
 });
 })
 .catch(error => {
 showNotification("Error printing collection: " + error.message, "error");
 });
 }

 // Add collection sharing functionality
 function shareCollection(collectionId) {
 if (!currentUser || !collectionId) return;
 
 // Generate a shareable link
 const shareableLink = `${window.location.origin}${window.location.pathname}?collection=${collectionId}&user=${currentUser.uid}`;
 
 // Create a temporary input to copy the link
 const tempInput = document.createElement("input");
 document.body.appendChild(tempInput);
 tempInput.value = shareableLink;
 tempInput.select();
 document.execCommand("copy");
 document.body.removeChild(tempInput);
 
 showNotification("Collection link copied to clipboard!", "success");
 
 // Show sharing options
 const shareModal = document.createElement("div");
 shareModal.className = "modal-base";
 shareModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Share Collection</h2>
 <p>Share your collection with others:</p>
 <div class="form-group">
 <input type="text" class="form-input" value="${shareableLink}" readonly>
 </div>
 <p>Or share directly:</p>
 <div class="share-buttons">
 <button class="share-button facebook">
 <i class="fab fa-facebook-f"></i>
 </button>
 <button class="share-button twitter">
 <i class="fab fa-twitter"></i>
 </button>
 <button class="share-button linkedin">
 <i class="fab fa-linkedin-in"></i>
 </button>
 </div>
 `;
 document.body.appendChild(shareModal);
 shareModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = shareModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 shareModal.style.display = "none";
 overlay.style.display = "none";
 shareModal.remove();
 });
 
 // Social sharing buttons
 shareModal.querySelectorAll(".share-button").forEach(button => {
 button.addEventListener("click", () => {
 const platform = button.classList[1];
 
 database.ref(`collections/${currentUser.uid}/${collectionId}`).once("value")
 .then(snapshot => {
 const collection = snapshot.val();
 if (!collection) return;
 
 const shareText = `Check out my Minnesota collection: ${collection.name}`;
 
 const shareUrls = {
 facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareableLink)}`,
 twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareableLink)}`,
 linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(shareableLink)}&title=${encodeURIComponent(collection.name)}`,
 };
 
 window.open(shareUrls[platform], "_blank");
 });
 });
 });
 }

 // Check for shared collection in URL
 function checkForSharedCollection() {
 const urlParams = new URLSearchParams(window.location.search);
 const collectionId = urlParams.get('collection');
 const userId = urlParams.get('user');
 
 if (collectionId && userId) {
 // Load the shared collection
 database.ref(`collections/${userId}/${collectionId}`).once("value")
 .then(snapshot => {
 const collection = snapshot.val();
 if (!collection) {
 showNotification("Shared collection not found", "error");
 return;
 }
 
 // Show the collection in a modal
 const sharedCollectionModal = document.createElement("div");
 sharedCollectionModal.className = "modal-base collection-markers-modal";
 sharedCollectionModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Shared Collection: ${collection.name}</h2>
 <p>${collection.description || "No description provided."}</p>
 <div class="collection-markers-list" id="sharedCollectionMarkersList">
 <div class="loading">Loading shared markers...</div>
 </div>
 ${currentUser ? `
 <button id="importCollectionBtn" class="btn btn-primary">
 <i class="fas fa-download"></i> Import to My Collections
 </button>
 ` : `
 <p>Log in to import this collection to your account.</p>
 `}
 `;
 document.body.appendChild(sharedCollectionModal);
 sharedCollectionModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = sharedCollectionModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 sharedCollectionModal.style.display = "none";
 overlay.style.display = "none";
 sharedCollectionModal.remove();
 });
 
 // Load markers
 const markerIds = Object.keys(collection.markers || {});
 const markersList = sharedCollectionModal.querySelector("#sharedCollectionMarkersList");
 
 if (markerIds.length === 0) {
 markersList.innerHTML = "<p>No markers in this collection.</p>";
 return;
 }
 
 // Fetch marker details for each marker ID
 const markerPromises = markerIds.map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 if (validMarkers.length === 0) {
 markersList.innerHTML = "<p>No valid markers found in this collection.</p>";
 return;
 }
 
 markersList.innerHTML = validMarkers
 .map(marker => `
 <div class="collection-marker-item">
 <h4 class="collection-marker-title">${marker.title}</h4>
 <span class="collection-marker-category ${marker.category}">${marker.category}</span>
 <p>${stripHtml(marker.description).substring(0, 100)}${stripHtml(marker.description).length > 100 ? '...' : ''}</p>
 <button class="btn btn-primary view-shared-marker-btn" data-marker-id="${marker.id}">View Marker</button>
 </div>
 `)
 .join('');
 
 // Add event listeners to the view buttons
 sharedCollectionModal.querySelectorAll('.view-shared-marker-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const markerId = e.target.dataset.markerId;
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 updateMarkerInfoModal(markerData);
 sharedCollectionModal.style.display = "none";
 markerInfoModal.style.display = "block";
 } else {
 showNotification("Marker not found", "error");
 }
 });
 });
 });
 
 // Import collection button
 const importBtn = sharedCollectionModal.querySelector("#importCollectionBtn");
 if (importBtn) {
 importBtn.addEventListener("click", () => {
 if (!currentUser) {
 showNotification("Please log in to import collections", "error");
 return;
 }
 
 // Create a new collection for the current user
 const newCollectionRef = database.ref(`collections/${currentUser.uid}`).push();
 const newCollection = {
 name: `${collection.name} (Imported)`,
 description: collection.description,
 created: Date.now(),
 markers: {},
 image: collection.image
 };
 
 // Add all markers to the new collection
 validMarkers.forEach(marker => {
 newCollection.markers[marker.id] = true;
 });
 
 newCollectionRef.set(newCollection)
 .then(() => {
 showNotification("Collection imported successfully", "success");
 sharedCollectionModal.style.display = "none";
 overlay.style.display = "none";
 sharedCollectionModal.remove();
 })
 .catch(error => {
 showNotification("Error importing collection: " + error.message, "error");
 });
 });
 }
 });
 })
 .catch(error => {
 showNotification("Error loading shared collection: " + error.message, "error");
 });
 }
 }

 // Call this function when the page loads
 window.addEventListener('load', checkForSharedCollection);

 // Make map markers match category colors
 function updateMapMarkers() {
 if (!map || !markers) return;
 
 // Clear existing markers
 markers.clearLayers();
 
 // Load markers with category-colored icons
 database.ref("markers").once("value", (snapshot) => {
 snapshot.forEach((childSnapshot) => {
 const markerData = childSnapshot.val();
 markerData.id = childSnapshot.key;
 
 // Filter by selected categories if any are selected
 if (selectedCategories.size === 0 || selectedCategories.has(markerData.category)) {
 addMarkerToMap(markerData);
 }
 });
 });
 }

 // Update the loadMarkers function to use the new marker icons
 function loadMarkers() {
 if (!markers) return;
 
 markers.clearLayers();
 
 database.ref("markers").once("value", (snapshot) => {
 snapshot.forEach((childSnapshot) => {
 const markerData = childSnapshot.val();
 markerData.id = childSnapshot.key;
 
 // Filter by selected categories if any are selected
 if (selectedCategories.size === 0 || selectedCategories.has(markerData.category)) {
 addMarkerToMap(markerData);
 }
 });
 });
 }

 // Add this to the end of the script to ensure everything is properly initialized
 window.addEventListener('load', () => {
 // Make sure the map is responsive
 window.addEventListener('resize', () => {
 if (map) {
 map.invalidateSize();
 }
 });
 
 

 // Initialize tooltips
 document.addEventListener('mouseover', (e) => {
 const target = e.target;
 if (target.hasAttribute('data-tooltip')) {
 const tooltip = document.createElement('div');
 tooltip.className = 'tooltip';
 tooltip.textContent = target.getAttribute('data-tooltip');
 document.body.appendChild(tooltip);
 
 const rect = target.getBoundingClientRect();
 tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
 tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
 
 target.addEventListener('mouseout', () => {
 tooltip.remove();
 }, { once: true });
 }
 });
 
 // Add CSS for tooltips
 const tooltipStyle = document.createElement('style');
 tooltipStyle.textContent = `
 .tooltip {
 position: fixed;
 background-color: rgba(0, 0, 0, 0.8);
 color: white;
 padding: 5px 10px;
 border-radius: 4px;
 font-size: 12px;
 z-index: 9999;
 pointer-events: none;
 white-space: nowrap;
 }
 .tooltip::after {
 content: '';
 position: absolute;
 top: 100%;
 left: 50%;
 margin-left: -5px;
 border-width: 5px;
 border-style: solid;
 border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
 }
 `;
 document.head.appendChild(tooltipStyle);
 
 // Add keyboard navigation for accessibility
 document.addEventListener('keydown', (e) => {
 // ESC key closes any open modals
 if (e.key === 'Escape') {
 document.querySelectorAll('.modal-base').forEach(modal => {
 if (modal.style.display === 'block') {
 modal.style.display = 'none';
 overlay.style.display = 'none';
 }
 });
 
 if (expandedImageModal.style.display === 'flex') {
 expandedImageModal.style.display = 'none';
 overlay.style.zIndex = '1000';
 }
 }
 });
 
 // Add collection sorting functionality
 function sortCollections(sortBy) {
 if (!currentUser) return;
 
 const collectionsGrid = document.getElementById("collectionsGrid");
 if (!collectionsGrid) return;
 
 database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
 if (!snapshot.exists()) return;
 
 const collections = [];
 snapshot.forEach((childSnapshot) => {
 collections.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });
 
 if (collections.length === 0) return;
 
 // Sort collections based on criteria
 switch (sortBy) {
 case 'name':
 collections.sort((a, b) => a.name.localeCompare(b.name));
 break;
 case 'date':
 collections.sort((a, b) => b.created - a.created);
 break;
 case 'markers':
 collections.sort((a, b) => {
 const aCount = Object.keys(a.markers || {}).length;
 const bCount = Object.keys(b.markers || {}).length;
 return bCount - aCount;
 });
 break;
 }
 
 // Update the display
 collectionsGrid.innerHTML = collections
 .map(
 (collection) => `
 <div class="collection-card">
 <img src="${collection.image || "https://via.placeholder.com/300x150?text=Collection"}" class="collection-image" alt="${collection.name}">
 <div class="collection-actions">
 <button class="collection-action-btn view-collection" data-collection-id="${collection.id}" title="View Markers">
 <i class="fas fa-eye"></i>
 </button>
 <button class="collection-action-btn share-collection" data-collection-id="${collection.id}" title="Share Collection">
 <i class="fas fa-share-alt"></i>
 </button>
 <button class="collection-action-btn export-collection" data-collection-id="${collection.id}" title="Export Collection">
 <i class="fas fa-file-export"></i>
 </button>
 <button class="collection-action-btn print-collection" data-collection-id="${collection.id}" title="Print Collection">
 <i class="fas fa-print"></i>
 </button>
 <button class="collection-action-btn delete-collection" data-collection-id="${collection.id}" title="Delete Collection">
 <i class="fas fa-trash"></i>
 </button>
 </div>
 <div class="collection-info">
 <h3 class="collection-title">${collection.name}</h3>
 <p>${collection.description || "No description"}</p>
 <div class="collection-stats">
 <span><i class="fas fa-map-marker-alt"></i> ${Object.keys(collection.markers || {}).length} markers</span>
 <span><i class="fas fa-calendar-alt"></i> Created ${new Date(collection.created).toLocaleDateString()}</span>
 </div>
 </div>
 </div>
 `
 )
 .join("");
 
 // Add event listeners to the buttons
 document.querySelectorAll('.view-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 viewCollectionMarkers(collectionId);
 });
 });
 
 document.querySelectorAll('.share-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 shareCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.export-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 exportCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.print-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 printCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.delete-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 deleteCollection(collectionId);
 });
 });
 });
 }
 
 // Enhance the loadCollections function to include sorting options
 function loadCollections() {
 if (!currentUser) return;

 const collectionsGrid = document.getElementById("collectionsGrid");
 collectionsGrid.innerHTML = '<div class="loading">Loading collections...</div>';
 
 // Add sorting options
 const sortingOptions = document.createElement('div');
 sortingOptions.className = 'sorting-options';
 sortingOptions.innerHTML = `
 <span>Sort by: </span>
 <button class="sort-btn active" data-sort="date">Date</button>
 <button class="sort-btn" data-sort="name">Name</button>
 <button class="sort-btn" data-sort="markers">Markers</button>
 `;
 
 // Insert sorting options before the grid
 collectionsGrid.parentNode.insertBefore(sortingOptions, collectionsGrid);
 
 // Add event listeners to sorting buttons
 sortingOptions.querySelectorAll('.sort-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 // Update active state
 sortingOptions.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
 e.target.classList.add('active');
 
 // Sort collections
 sortCollections(e.target.dataset.sort);
 });
 });

 database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
 if (!snapshot.exists()) {
 collectionsGrid.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
 return;
 }

 const collections = [];
 snapshot.forEach((childSnapshot) => {
 collections.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });

 if (collections.length === 0) {
 collectionsGrid.innerHTML = "<p>You have no collections yet. Create one to get started!</p>";
 return;
 }

 // Sort by date (newest first) by default
 collections.sort((a, b) => b.created - a.created);

 collectionsGrid.innerHTML = collections
 .map(
 (collection) => `
 <div class="collection-card">
 <img src="${collection.image || "https://via.placeholder.com/300x150?text=Collection"}" class="collection-image" alt="${collection.name}">
 <div class="collection-actions">
 <button class="collection-action-btn view-collection" data-collection-id="${collection.id}" title="View Markers">
 <i class="fas fa-eye"></i>
 </button>
 <button class="collection-action-btn share-collection" data-collection-id="${collection.id}" title="Share Collection">
 <i class="fas fa-share-alt"></i>
 </button>
 <button class="collection-action-btn export-collection" data-collection-id="${collection.id}" title="Export Collection">
 <i class="fas fa-file-export"></i>
 </button>
 <button class="collection-action-btn print-collection" data-collection-id="${collection.id}" title="Print Collection">
 <i class="fas fa-print"></i>
 </button>
 <button class="collection-action-btn delete-collection" data-collection-id="${collection.id}" title="Delete Collection">
 <i class="fas fa-trash"></i>
 </button>
 </div>
 <div class="collection-info">
 <h3 class="collection-title">${collection.name}</h3>
 <p>${collection.description || "No description"}</p>
 <div class="collection-stats">
 <span><i class="fas fa-map-marker-alt"></i> ${Object.keys(collection.markers || {}).length} markers</span>
 <span><i class="fas fa-calendar-alt"></i> Created ${new Date(collection.created).toLocaleDateString()}</span>
 </div>
 </div>
 </div>
 `
 )
 .join("");
 
 // Add event listeners to the buttons
 document.querySelectorAll('.view-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 viewCollectionMarkers(collectionId);
 });
 });
 
 document.querySelectorAll('.share-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 shareCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.export-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 exportCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.print-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 printCollection(collectionId);
 });
 });
 
 document.querySelectorAll('.delete-collection').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const collectionId = e.target.closest('.collection-action-btn').dataset.collectionId;
 deleteCollection(collectionId);
 });
 });
 });
 }
 
 // Add CSS for sorting options
 const sortingStyle = document.createElement('style');
 sortingStyle.textContent = `
 .sorting-options {
 display: flex;
 align-items: center;
 margin-bottom: 1rem;
 gap: 0.5rem;
 }
 .sort-btn {
 background: none;
 border: 1px solid #e2e8f0;
 padding: 0.4rem 0.8rem;
 border-radius: 4px;
 cursor: pointer;
 font-size: 0.9rem;
 transition: all 0.2s;
 }
 .sort-btn:hover {
 background-color: #f1f5f9;
 }
 .sort-btn.active {
 background-color: #2563eb;
 color: white;
 border-color: #2563eb;
 }
 `;
 document.head.appendChild(sortingStyle);
 
 // Add collection search functionality
 function addCollectionSearch() {
 const collectionsModal = document.getElementById("collectionsModal");
 if (!collectionsModal) return;
 
 // Create search input
 const searchContainer = document.createElement('div');
 searchContainer.className = 'collection-search';
 searchContainer.innerHTML = `
 <input type="text" class="form-input" placeholder="Search collections..." id="collectionSearchInput">
 `;
 
 // Insert search before the grid
 const collectionsGrid = document.getElementById("collectionsGrid");
 collectionsGrid.parentNode.insertBefore(searchContainer, collectionsGrid);
 
 // Add event listener for search
 const searchInput = document.getElementById("collectionSearchInput");
 searchInput.addEventListener('input', (e) => {
 const searchTerm = e.target.value.toLowerCase();
 
 // Filter collection cards
 document.querySelectorAll('.collection-card').forEach(card => {
 const title = card.querySelector('.collection-title').textContent.toLowerCase();
 const description = card.querySelector('.collection-info p').textContent.toLowerCase();
 
 if (title.includes(searchTerm) || description.includes(searchTerm)) {
 card.style.display = 'block';
 } else {
 card.style.display = 'none';
 }
 });
 });
 }
 
 // Add CSS for collection search
 const searchStyle = document.createElement('style');
 searchStyle.textContent = `
 .collection-search {
 margin-bottom: 1rem;
 }
 .collection-search .form-input {
 width: 100%;
 padding: 0.8rem;
 border: 1px solid #d1d5db;
 border-radius: 8px;
 font-size: 1rem;
 }
 .collection-search .form-input:focus {
 outline: none;
 border-color: #2563eb;
 box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
 }
 `;
 document.head.appendChild(searchStyle);
 
 // Modify the collectionsLink click handler to add search functionality
 collectionsLink.addEventListener("click", (e) => {
 e.preventDefault();

 if (!currentUser) {
 showNotification("Please log in to view collections", "error");
 return;
 }

 loadCollections();
 collectionsModal.style.display = "block";
 overlay.style.display = "block";
 
 // Add search functionality after modal is displayed
 setTimeout(addCollectionSearch, 100);
 });
 
 // Add collection categories functionality
 function addCollectionCategories() {
 if (!currentUser) return;
 
 // Get all markers in user's collections
 database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
 if (!snapshot.exists()) return;
 
 const collections = [];
 snapshot.forEach((childSnapshot) => {
 const collection = childSnapshot.val();
 collection.id = childSnapshot.key;
 collections.push(collection);
 });
 
 if (collections.length === 0) return;
 
 // Get all marker IDs from all collections
 const allMarkerIds = new Set();
 collections.forEach(collection => {
 if (collection.markers) {
 Object.keys(collection.markers).forEach(markerId => {
 allMarkerIds.add(markerId);
 });
 }
 });
 
 if (allMarkerIds.size === 0) return;
 
 // Get marker data for all markers
 const markerPromises = Array.from(allMarkerIds).map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 if (validMarkers.length === 0) return;
 
 // Count markers by category
 const categoryCounts = {
 architecture: 0,
 nature: 0,
 events: 0,
 people: 0
 };
 
 validMarkers.forEach(marker => {
 if (marker.category && categoryCounts.hasOwnProperty(marker.category)) {
 categoryCounts[marker.category]++;
 }
 });
 
 // Add category filters to collections modal
 const collectionsModal = document.getElementById("collectionsModal");
 if (!collectionsModal) return;
 
 const categoryFilters = document.createElement('div');
 categoryFilters.className = 'category-filters';
 categoryFilters.innerHTML = `
 <div class="filter-label">Filter by category:</div>
 <div class="filter-badges">
 <span class="filter-badge all active" data-category="all">All</span>
 ${Object.entries(categoryCounts).map(([category, count]) => 
 count > 0 ? `<span class="filter-badge ${category}" data-category="${category}">${category.charAt(0).toUpperCase() + category.slice(1)} (${count})</span>` : ''
 ).join('')}
 </div>
 `;
 
 // Insert category filters after the search
 const searchContainer = collectionsModal.querySelector('.collection-search');
 if (searchContainer) {
 searchContainer.after(categoryFilters);
 } else {
 const collectionsGrid = document.getElementById("collectionsGrid");
 collectionsGrid.parentNode.insertBefore(categoryFilters, collectionsGrid);
 }
 
 // Add event listeners to category filters
 categoryFilters.querySelectorAll('.filter-badge').forEach(badge => {
 badge.addEventListener('click', (e) => {
 // Update active state
 categoryFilters.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
 e.target.classList.add('active');
 
 const selectedCategory = e.target.dataset.category;
 
 

 // Filter collections based on category
 filterCollectionsByCategory(selectedCategory, collections, validMarkers);
 });
 });
 });
 });
 }
 
 // Filter collections by category
 function filterCollectionsByCategory(category, collections, markers) {
 if (category === 'all') {
 // Show all collections
 document.querySelectorAll('.collection-card').forEach(card => {
 card.style.display = 'block';
 });
 return;
 }
 
 // Get all markers with the selected category
 const categoryMarkers = markers.filter(marker => marker.category === category);
 const categoryMarkerIds = new Set(categoryMarkers.map(marker => marker.id));
 
 // Filter collections that contain at least one marker with the selected category
 document.querySelectorAll('.collection-card').forEach(card => {
 const collectionId = card.querySelector('.collection-action-btn').dataset.collectionId;
 const collection = collections.find(c => c.id === collectionId);
 
 if (collection && collection.markers) {
 // Check if any marker in the collection has the selected category
 const hasCategory = Object.keys(collection.markers).some(markerId => categoryMarkerIds.has(markerId));
 
 if (hasCategory) {
 card.style.display = 'block';
 } else {
 card.style.display = 'none';
 }
 } else {
 card.style.display = 'none';
 }
 });
 }
 
 // Add CSS for category filters
 const categoryFilterStyle = document.createElement('style');
 categoryFilterStyle.textContent = `
 .category-filters {
 margin-bottom: 1rem;
 }
 .filter-label {
 margin-bottom: 0.5rem;
 font-weight: 500;
 }
 .filter-badges {
 display: flex;
 flex-wrap: wrap;
 gap: 0.5rem;
 }
 .filter-badge {
 padding: 0.4rem 0.8rem;
 border-radius: 50px;
 font-size: 0.85rem;
 cursor: pointer;
 transition: all 0.3s;
 background-color: #f1f5f9;
 color: #475569;
 }
 .filter-badge:hover {
 transform: translateY(-2px);
 }
 .filter-badge.active {
 transform: scale(1.05);
 box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
 }
 .filter-badge.all.active {
 background-color: #475569;
 color: white;
 }
 .filter-badge.architecture.active {
 background-color: #2563eb;
 color: white;
 }
 .filter-badge.nature.active {
 background-color: #10b981;
 color: white;
 }
 .filter-badge.events.active {
 background-color: #f59e0b;
 color: white;
 }
 .filter-badge.people.active {
 background-color: #8b5cf6;
 color: white;
 }
 `;
 document.head.appendChild(categoryFilterStyle);
 
 

 // Modify the collectionsLink click handler to add category filters
 collectionsLink.addEventListener("click", (e) => {
 e.preventDefault();

 if (!currentUser) {
 showNotification("Please log in to view collections", "error");
 return;
 }

 loadCollections();
 collectionsModal.style.display = "block";
 overlay.style.display = "block";
 
 // Add search and category filters after modal is displayed
 setTimeout(() => {
 addCollectionSearch();
 addCollectionCategories();
 }, 100);
 });
 
 // Add collection bulk actions
 function addCollectionBulkActions() {
 const collectionsModal = document.getElementById("collectionsModal");
 if (!collectionsModal) return;
 
 // Create bulk actions container
 const bulkActionsContainer = document.createElement('div');
 bulkActionsContainer.className = 'bulk-actions-container';
 bulkActionsContainer.innerHTML = `
 <div class="bulk-actions-toggle">
 <input type="checkbox" id="selectAllCollections">
 <label for="selectAllCollections">Select All</label>
 </div>
 <div class="bulk-actions" style="display: none;">
 <button class="btn btn-secondary bulk-export-btn">
 <i class="fas fa-file-export"></i> Export Selected
 </button>
 <button class="btn btn-danger bulk-delete-btn">
 <i class="fas fa-trash"></i> Delete Selected
 </button>
 </div>
 `;
 
 // Insert bulk actions before the grid
 const collectionsGrid = document.getElementById("collectionsGrid");
 collectionsGrid.parentNode.insertBefore(bulkActionsContainer, collectionsGrid);
 
 // Add select checkboxes to collection cards
 document.querySelectorAll('.collection-card').forEach(card => {
 const checkbox = document.createElement('div');
 checkbox.className = 'collection-checkbox';
 checkbox.innerHTML = `<input type="checkbox" class="collection-select" data-collection-id="${card.querySelector('.collection-action-btn').dataset.collectionId}">`;
 card.appendChild(checkbox);
 });
 
 // Select all checkbox functionality
 const selectAllCheckbox = document.getElementById('selectAllCollections');
 selectAllCheckbox.addEventListener('change', (e) => {
 const isChecked = e.target.checked;
 document.querySelectorAll('.collection-select').forEach(checkbox => {
 checkbox.checked = isChecked;
 });
 
 // Show/hide bulk actions
 const bulkActions = document.querySelector('.bulk-actions');
 bulkActions.style.display = isChecked ? 'flex' : 'none';
 });
 
 // Individual checkbox functionality
 document.querySelectorAll('.collection-select').forEach(checkbox => {
 checkbox.addEventListener('change', () => {
 // Check if any checkboxes are selected
 const anySelected = Array.from(document.querySelectorAll('.collection-select')).some(cb => cb.checked);
 
 // Show/hide bulk actions
 const bulkActions = document.querySelector('.bulk-actions');
 bulkActions.style.display = anySelected ? 'flex' : 'none';
 
 // Update select all checkbox
 const allSelected = Array.from(document.querySelectorAll('.collection-select')).every(cb => cb.checked);
 selectAllCheckbox.checked = allSelected;
 });
 });
 
 // Bulk export functionality
 const bulkExportBtn = document.querySelector('.bulk-export-btn');
 bulkExportBtn.addEventListener('click', () => {
 const selectedCollectionIds = Array.from(document.querySelectorAll('.collection-select:checked')).map(cb => cb.dataset.collectionId);
 
 if (selectedCollectionIds.length === 0) {
 showNotification("No collections selected", "warning");
 return;
 }
 
 // Create a zip file with all selected collections
 showNotification("Preparing collections for export...", "info");
 
 // For each collection, get the data and export it
 const exportPromises = selectedCollectionIds.map(collectionId => 
 new Promise((resolve, reject) => {
 database.ref(`collections/${currentUser.uid}/${collectionId}`).once("value")
 .then(snapshot => {
 const collection = snapshot.val();
 if (!collection) {
 resolve(null);
 return;
 }
 
 // Get markers in this collection
 const markerIds = Object.keys(collection.markers || {});
 
 if (markerIds.length === 0) {
 resolve({
 name: collection.name,
 description: collection.description,
 created: collection.created,
 exportDate: Date.now(),
 markers: []
 });
 return;
 }
 
 // Fetch marker details for each marker ID
 const markerPromises = markerIds.map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 // Create export data
 const exportData = {
 name: collection.name,
 description: collection.description,
 created: collection.created,
 exportDate: Date.now(),
 markers: validMarkers.map(marker => ({
 title: marker.title,
 category: marker.category,
 description: stripHtml(marker.description),
 lat: marker.lat,
 lng: marker.lng,
 date: marker.date,
 uploaderName: marker.uploaderName
 }))
 };
 
 resolve(exportData);
 }).catch(reject);
 })
 .catch(reject);
 })
 );
 
 Promise.all(exportPromises)
 .then(collectionsData => {
 const validCollections = collectionsData.filter(data => data !== null);
 
 if (validCollections.length === 0) {
 showNotification("No valid collections to export", "error");
 return;
 }
 
 // Create a combined export file
 const combinedExport = {
 exportDate: Date.now(),
 collections: validCollections
 };
 
 // Convert to JSON and create download link
 const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(combinedExport, null, 2));
 const downloadAnchorNode = document.createElement('a');
 downloadAnchorNode.setAttribute("href", dataStr);
 downloadAnchorNode.setAttribute("download", `minnesota_collections_export.json`);
 document.body.appendChild(downloadAnchorNode);
 downloadAnchorNode.click();
 downloadAnchorNode.remove();
 
 showNotification(`Exported ${validCollections.length} collections successfully`, "success");
 })
 .catch(error => {
 showNotification("Error exporting collections: " + error.message, "error");
 });
 });
 
 // Bulk delete functionality
 const bulkDeleteBtn = document.querySelector('.bulk-delete-btn');
 bulkDeleteBtn.addEventListener('click', () => {
 const selectedCollectionIds = Array.from(document.querySelectorAll('.collection-select:checked')).map(cb => cb.dataset.collectionId);
 
 if (selectedCollectionIds.length === 0) {
 showNotification("No collections selected", "warning");
 return;
 }
 
 if (confirm(`Are you sure you want to delete ${selectedCollectionIds.length} collections? This action cannot be undone.`)) {
 // Delete each selected collection
 const deletePromises = selectedCollectionIds.map(collectionId => 
 database.ref(`collections/${currentUser.uid}/${collectionId}`).remove()
 );
 
 Promise.all(deletePromises)
 .then(() => {
 showNotification(`Deleted ${selectedCollectionIds.length} collections successfully`, "success");
 loadCollections();
 
 // Re-add search and category filters
 setTimeout(() => {
 addCollectionSearch();
 addCollectionCategories();
 addCollectionBulkActions();
 }, 100);
 })
 .catch(error => {
 showNotification("Error deleting collections: " + error.message, "error");
 });
 }
 });
 }
 
 // Add CSS for bulk actions
 const bulkActionsStyle = document.createElement('style');
 bulkActionsStyle.textContent = `
 .bulk-actions-container {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 1rem;
 padding: 0.5rem;
 background-color: #f8fafc;
 border-radius: 8px;
 border: 1px solid #e2e8f0;
 }
 .bulk-actions-toggle {
 display: flex;
 align-items: center;
 gap: 0.5rem;
 }
 .bulk-actions-toggle input[type="checkbox"] {
 width: 18px;
 height: 18px;
 cursor: pointer;
 }
 .bulk-actions-toggle label {
 cursor: pointer;
 font-weight: 500;
 }
 .bulk-actions {
 display: flex;
 gap: 0.5rem;
 }
 .collection-checkbox {
 position: absolute;
 top: 10px;
 left: 10px;
 z-index: 5;
 }
 .collection-checkbox input[type="checkbox"] {
 width: 20px;
 height: 20px;
 cursor: pointer;
 background-color: white;
 border-radius: 4px;
 border: 2px solid white;
 }
 `;
 document.head.appendChild(bulkActionsStyle);
 
 // Modify the collectionsLink click handler to add bulk actions
 collectionsLink.addEventListener("click", (e) => {
 e.preventDefault();

 if (!currentUser) {
 showNotification("Please log in to view collections", "error");
 return;
 }

 loadCollections();
 collectionsModal.style.display = "block";
 overlay.style.display = "block";
 
 // Add search, category filters, and bulk actions after modal is displayed
 setTimeout(() => {
 addCollectionSearch();
 addCollectionCategories();
 addCollectionBulkActions();
 }, 100);
 });
 
 // Add collection import functionality
 function addCollectionImport() {
 // Create import button
 const importBtn = document.createElement('button');
 importBtn.className = 'btn btn-secondary';
 importBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Collection';
 importBtn.style.marginLeft = '0.5rem';
 
 // Add import button next to create collection button
 const createCollectionBtn = document.getElementById('createCollectionBtn');
 if (createCollectionBtn) {
 createCollectionBtn.parentNode.insertBefore(importBtn, createCollectionBtn.nextSibling);
 }
 
 // Add event listener for import button
 importBtn.addEventListener('click', () => {
 // Create file input
 const fileInput = document.createElement('input');
 fileInput.type = 'file';
 fileInput.accept = '.json';
 fileInput.style.display = 'none';
 document.body.appendChild(fileInput);
 
 // Trigger file selection
 fileInput.click();
 
 // Handle file selection
 fileInput.addEventListener('change', (e) => {
 const file = e.target.files[0];
 if (!file) {
 fileInput.remove();
 return;
 }
 
 const reader = new FileReader();
 reader.onload = (event) => {
 try {
 const importData = JSON.parse(event.target.result);
 
 // Check if it's a single collection or multiple collections
 if (importData.collections) {
 // Multiple collections
 importMultipleCollections(importData.collections);
 } else {
 // Single collection
 importSingleCollection(importData);
 }
 
 fileInput.remove();
 } catch (error) {
 showNotification("Error parsing import file: " + error.message, "error");
 fileInput.remove();
 }
 };
 reader.readAsText(file);
 });
 });
 }
 
 // Import a single collection
 function importSingleCollection(collectionData) {
 if (!currentUser) {
 showNotification("Please log in to import collections", "error");
 return;
 }
 
 // Validate collection data
 if (!collectionData.name || !collectionData.markers || !Array.isArray(collectionData.markers)) {
 showNotification("Invalid collection data format", "error");
 return;
 }
 
 // Create a new collection
 const newCollectionRef = database.ref(`collections/${currentUser.uid}`).push();
 const newCollection = {
 name: `${collectionData.name} (Imported)`,
 description: collectionData.description || "Imported collection",
 created: Date.now(),
 markers: {}
 };
 
 // Process markers
 const markerPromises = collectionData.markers.map(markerData => {
 // Check if marker already exists with the same coordinates
 return database.ref("markers").orderByChild("lat").equalTo(markerData.lat).once("value")
 .then(snapshot => {
 let existingMarkerId = null;
 
 snapshot.forEach(childSnapshot => {
 const existingMarker = childSnapshot.val();
 if (existingMarker.lng === markerData.lng) {
 existingMarkerId = childSnapshot.key;
 }
 });
 
 if (existingMarkerId) {
 // Use existing marker
 newCollection.markers[existingMarkerId] = true;
 return Promise.resolve();
 } else {
 // Create new marker
 const newMarkerRef = database.ref("markers").push();
 const newMarker = {
 title: markerData.title,
 category: markerData.category,
 description: markerData.description,
 lat: markerData.lat,
 lng: markerData.lng,
 uploaderName: currentUser.displayName || "Anonymous",
 uploaderId: currentUser.uid,
 date: markerData.date || new Date().toISOString().split('T')[0],
 timestamp: Date.now(),
 views: 0,
 likes: 0
 };
 
 return newMarkerRef.set(newMarker)
 .then(() => {
 newCollection.markers[newMarkerRef.key] = true;
 return Promise.resolve();
 });
 }
 });
 });
 
 Promise.all(markerPromises)
 .then(() => {
 return newCollectionRef.set(newCollection);
 })
 .then(() => {
 showNotification(`Collection "${collectionData.name}" imported successfully with ${collectionData.markers.length} markers`, "success");
 loadCollections();
 
 // Re-add search, category filters, and bulk actions
 setTimeout(() => {
 addCollectionSearch();
 addCollectionCategories();
 addCollectionBulkActions();
 addCollectionImport();
 }, 100);
 })
 .catch(error => {
 showNotification("Error importing collection: " + error.message, "error");
 });
 }
 
 // Import multiple collections
 function importMultipleCollections(collections) {
 if (!currentUser) {
 showNotification("Please log in to import collections", "error");
 return;
 }
 
 if (!Array.isArray(collections) || collections.length === 0) {
 showNotification("No valid collections to import", "error");
 return;
 }
 
 // Ask user which collections to import
 const selectCollectionsModal = document.createElement('div');
 selectCollectionsModal.className = 'modal-base';
 selectCollectionsModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Select Collections to Import</h2>
 <div class="import-collections-list">
 ${collections.map((collection, index) => `
 <div class="import-collection-item">
 <input type="checkbox" id="import-collection-${index}" class="import-collection-checkbox" checked>
 <label for="import-collection-${index}">
 <strong>${collection.name}</strong>
 <div>${collection.description || "No description"}</div>
 <div class="import-collection-stats">
 <span><i class="fas fa-map-marker-alt"></i> ${collection.markers ? collection.markers.length : 0} markers</span>
 </div>
 </label>
 </div>
 `).join('')}
 </div>
 <button id="importSelectedCollectionsBtn" class="btn btn-primary">Import Selected Collections</button>
 `;
 document.body.appendChild(selectCollectionsModal);
 selectCollectionsModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = selectCollectionsModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 selectCollectionsModal.style.display = "none";
 overlay.style.display = "none";
 selectCollectionsModal.remove();
 });
 
 // Import selected collections button
 const importSelectedBtn = document.getElementById("importSelectedCollectionsBtn");
 importSelectedBtn.addEventListener("click", () => {
 const selectedIndices = Array.from(document.querySelectorAll('.import-collection-checkbox:checked')).map(cb => 
 parseInt(cb.id.replace('import-collection-', ''))
 );
 
 if (selectedIndices.length === 0) {
 showNotification("No collections selected", "warning");
 return;
 }
 
 const selectedCollections = selectedIndices.map(index => collections[index]);
 
 // Close the modal
 selectCollectionsModal.style.display = "none";
 overlay.style.display = "none";
 selectCollectionsModal.remove();
 
 // Import each selected collection
 let importedCount = 0;
 
 function importNext(index) {
 if (index >= selectedCollections.length) {
 showNotification(`Imported ${importedCount} collections successfully`, "success");
 loadCollections();
 
 // Re-add search, category filters, and bulk actions
 setTimeout(() => {
 addCollectionSearch();
 addCollectionCategories();
 addCollectionBulkActions();
 addCollectionImport();
 }, 100);
 return;
 }
 
 importSingleCollection(selectedCollections[index])
 .then(() => {
 importedCount++;
 importNext(index + 1);
 })
 .catch(error => {
 showNotification(`Error importing collection ${index + 1}: ${error.message}`, "error");
 importNext(index + 1);
 });
 }
 
 importNext(0);
 });
 }
 
 // Add CSS for import collections
 const importCollectionsStyle = document.createElement('style');
 importCollectionsStyle.textContent = `
 .import-collections-list {
 max-height: 400px;
 overflow-y: auto;
 margin: 1rem 0;
 border: 1px solid #e2e8f0;
 border-radius: 8px;
 }
 .import-collection-item {
 display: flex;
 align-items: flex-start;
 padding: 1rem;
 border-bottom: 1px solid #e2e8f0;
 }
 .import-collection-item:last-child {
 border-bottom: none;
 }
 .import-collection-checkbox {
 margin-right: 1rem;
 margin-top: 0.25rem;
 width: 18px;
 height: 18px;
 }
 .import-collection-stats {
 margin-top: 0.5rem;
 font-size: 0.85rem;
 color: #64748b;
 }
 `;
 document.head.appendChild(importCollectionsStyle);
 
 // Modify the collectionsLink click handler to add import functionality
 collectionsLink.addEventListener("click", (e) => {
 e.preventDefault();

 if (!currentUser) {
 showNotification("Please log in to view collections", "error");
 return;
 }

 loadCollections();
 collectionsModal.style.display = "block";
 overlay.style.display = "block";
 
 

 // Add search, category filters, bulk actions, and import functionality after modal is displayed
 setTimeout(() => {
 addCollectionSearch();
 addCollectionCategories();
 addCollectionBulkActions();
 addCollectionImport();
 }, 100);
 });
 
 // Add collection statistics and analytics
 function addCollectionStatistics() {
 if (!currentUser) return;
 
 // Create statistics container
 const statsContainer = document.createElement('div');
 statsContainer.className = 'collection-statistics';
 statsContainer.innerHTML = `
 <h3>Your Collection Statistics</h3>
 <div class="stats-loading">Loading statistics...</div>
 <div class="stats-grid" style="display: none;">
 <div class="stat-card">
 <div class="stat-icon"><i class="fas fa-folder"></i></div>
 <div class="stat-value" id="totalCollections">0</div>
 <div class="stat-label">Collections</div>
 </div>
 <div class="stat-card">
 <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
 <div class="stat-value" id="totalMarkers">0</div>
 <div class="stat-label">Saved Markers</div>
 </div>
 <div class="stat-card">
 <div class="stat-icon"><i class="fas fa-tags"></i></div>
 <div class="stat-value" id="totalCategories">0</div>
 <div class="stat-label">Categories</div>
 </div>
 <div class="stat-card">
 <div class="stat-icon"><i class="fas fa-share-alt"></i></div>
 <div class="stat-value" id="totalShares">0</div>
 <div class="stat-label">Shares</div>
 </div>
 </div>
 <div class="category-distribution">
 <h4>Category Distribution</h4>
 <div class="category-bars">
 <div class="category-loading">Loading categories...</div>
 </div>
 </div>
 `;
 
 // Add to collections modal
 const collectionsModal = document.getElementById("collectionsModal");
 if (!collectionsModal) return;
 
 // Find the collections grid
 const collectionsGrid = document.getElementById("collectionsGrid");
 if (!collectionsGrid) return;
 
 // Insert statistics before the grid
 collectionsGrid.parentNode.insertBefore(statsContainer, collectionsGrid);
 
 // Load statistics data
 database.ref(`collections/${currentUser.uid}`).once("value", (snapshot) => {
 if (!snapshot.exists()) {
 statsContainer.querySelector('.stats-loading').textContent = "No collections found.";
 return;
 }
 
 const collections = [];
 snapshot.forEach((childSnapshot) => {
 collections.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });
 
 if (collections.length === 0) {
 statsContainer.querySelector('.stats-loading').textContent = "No collections found.";
 return;
 }
 
 // Get all marker IDs from all collections
 const allMarkerIds = new Set();
 collections.forEach(collection => {
 if (collection.markers) {
 Object.keys(collection.markers).forEach(markerId => {
 allMarkerIds.add(markerId);
 });
 }
 });
 
 // Get marker data for all markers
 const markerPromises = Array.from(allMarkerIds).map(markerId => 
 database.ref(`markers/${markerId}`).once("value").then(snapshot => {
 const markerData = snapshot.val();
 if (markerData) {
 markerData.id = markerId;
 return markerData;
 }
 return null;
 })
 );
 
 Promise.all(markerPromises).then(markers => {
 const validMarkers = markers.filter(marker => marker !== null);
 
 // Count markers by category
 const categoryCounts = {
 architecture: 0,
 nature: 0,
 events: 0,
 people: 0
 };
 
 validMarkers.forEach(marker => {
 if (marker.category && categoryCounts.hasOwnProperty(marker.category)) {
 categoryCounts[marker.category]++;
 }
 });
 
 // Count total shares (placeholder - would need actual share tracking)
 const totalShares = collections.reduce((total, collection) => total + (collection.shares || 0), 0);
 
 // Update statistics
 document.getElementById('totalCollections').textContent = collections.length;
 document.getElementById('totalMarkers').textContent = validMarkers.length;
 document.getElementById('totalCategories').textContent = Object.values(categoryCounts).filter(count => count > 0).length;
 document.getElementById('totalShares').textContent = totalShares;
 
 // Show statistics grid
 statsContainer.querySelector('.stats-loading').style.display = 'none';
 statsContainer.querySelector('.stats-grid').style.display = 'grid';
 
 // Update category distribution
 const categoryBars = statsContainer.querySelector('.category-bars');
 const totalMarkers = validMarkers.length;
 
 if (totalMarkers === 0) {
 categoryBars.innerHTML = "<p>No markers in your collections.</p>";
 return;
 }
 
 categoryBars.innerHTML = Object.entries(categoryCounts)
 .filter(([_, count]) => count > 0)
 .map(([category, count]) => {
 const percentage = Math.round((count / totalMarkers) * 100);
 return `
 <div class="category-bar-item">
 <div class="category-name">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
 <div class="category-bar-container">
 <div class="category-bar ${category}" style="width: ${percentage}%;">${percentage}%</div>
 </div>
 <div class="category-count">${count}</div>
 </div>
 `;
 })
 .join('');
 });
 });
 }
 
 // Add CSS for collection statistics
 const statisticsStyle = document.createElement('style');
 statisticsStyle.textContent = `
 .collection-statistics {
 background-color: #f8fafc;
 border-radius: 12px;
 padding: 1.5rem;
 margin-bottom: 2rem;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
 }
 .collection-statistics h3 {
 margin-top: 0;
 margin-bottom: 1rem;
 color: #1e293b;
 font-size: 1.25rem;
 }
 .stats-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
 gap: 1rem;
 margin-bottom: 1.5rem;
 }
 .stat-card {
 background-color: white;
 border-radius: 8px;
 padding: 1rem;
 text-align: center;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
 transition: transform 0.2s;
 }
 .stat-card:hover {
 transform: translateY(-3px);
 }
 .stat-icon {
 font-size: 1.5rem;
 color: #2563eb;
 margin-bottom: 0.5rem;
 }
 .stat-value {
 font-size: 1.75rem;
 font-weight: bold;
 color: #1e293b;
 }
 .stat-label {
 color: #64748b;
 font-size: 0.9rem;
 }
 .category-distribution {
 margin-top: 1.5rem;
 }
 .category-distribution h4 {
 margin-top: 0;
 margin-bottom: 1rem;
 color: #1e293b;
 font-size: 1.1rem;
 }
 .category-bar-item {
 display: flex;
 align-items: center;
 margin-bottom: 0.75rem;
 }
 .category-name {
 width: 100px;
 font-size: 0.9rem;
 color: #1e293b;
 }
 .category-bar-container {
 flex-grow: 1;
 height: 20px;
 background-color: #e2e8f0;
 border-radius: 10px;
 overflow: hidden;
 margin: 0 0.75rem;
 }
 .category-bar {
 height: 100%;
 color: white;
 font-size: 0.8rem;
 font-weight: bold;
 display: flex;
 align-items: center;
 justify-content: center;
 min-width: 30px;
 transition: width 0.5s ease-out;
 }
 .category-bar.architecture {
 background-color: #2563eb;
 }
 .category-bar.nature {
 background-color: #10b981;
 }
 .category-bar.events {
 background-color: #f59e0b;
 }
 .category-bar.people {
 background-color: #8b5cf6;
 }
 .category-count {
 width: 40px;
 text-align: right;
 font-size: 0.9rem;
 color: #64748b;
 }
 .stats-loading, .category-loading {
 color: #64748b;
 font-style: italic;
 padding: 1rem 0;
 }
 `;
 document.head.appendChild(statisticsStyle);
 
 // Add marker clustering for better map performance
 function addMarkerClustering() {
 if (!map) return;
 
 // Create marker cluster group
 markerCluster = L.markerClusterGroup({
 maxClusterRadius: 50,
 spiderfyOnMaxZoom: true,
 showCoverageOnHover: false,
 zoomToBoundsOnClick: true,
 disableClusteringAtZoom: 18,
 iconCreateFunction: function(cluster) {
 const count = cluster.getChildCount();
 let size = 'small';
 
 if (count > 50) {
 size = 'large';
 } else if (count > 20) {
 size = 'medium';
 }
 
 return L.divIcon({
 html: `<div class="cluster-icon ${size}">${count}</div>`,
 className: 'marker-cluster',
 iconSize: L.point(40, 40)
 });
 }
 });
 
 // Add CSS for marker clusters
 const clusterStyle = document.createElement('style');
 clusterStyle.textContent = `
 .marker-cluster {
 background: none;
 border: none;
 }
 .cluster-icon {
 display: flex;
 align-items: center;
 justify-content: center;
 background-color: rgba(37, 99, 235, 0.8);
 color: white;
 border-radius: 50%;
 font-weight: bold;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
 width: 100%;
 height: 100%;
 }
 .cluster-icon.small {
 background-color: rgba(37, 99, 235, 0.8);
 }
 .cluster-icon.medium {
 background-color: rgba(245, 158, 11, 0.8);
 }
 .cluster-icon.large {
 background-color: rgba(220, 38, 38, 0.8);
 }
 `;
 document.head.appendChild(clusterStyle);
 
 // Add cluster group to map
 map.addLayer(markerCluster);
 
 // Update the addMarkerToMap function to use clustering
 window.originalAddMarkerToMap = window.addMarkerToMap;
 window.addMarkerToMap = function(markerData) {
 const marker = createMarkerWithIcon(markerData);
 
 // Add popup
 marker.bindPopup(`
 <div class="marker-popup">
 <h3>${markerData.title}</h3>
 <span class="marker-category ${markerData.category}">${markerData.category}</span>
 <p>${stripHtml(markerData.description).substring(0, 100)}${stripHtml(markerData.description).length > 100 ? '...' : ''}</p>
 <button class="btn btn-primary view-marker-btn" data-marker-id="${markerData.id}">View Details</button>
 </div>
 `);
 
 // Add click event
 marker.on("click", function() {
 currentMarkerId = markerData.id;
 
 // Increment view count
 database.ref(`markers/${markerData.id}/views`).transaction(function(currentViews) {
 return (currentViews || 0) + 1;
 });
 });
 
 // Store marker reference
 markerReferences[markerData.id] = marker;
 
 // Add to cluster group instead of markers layer
 markerCluster.addLayer(marker);
 
 return marker;
 };
 
 // Update the loadMarkers function to use clustering
 window.originalLoadMarkers = window.loadMarkers;
 window.loadMarkers = function() {
 if (!markerCluster) return;
 
 markerCluster.clearLayers();
 markerReferences = {};
 
 database.ref("markers").once("value", (snapshot) => {
 snapshot.forEach((childSnapshot) => {
 const markerData = childSnapshot.val();
 markerData.id = childSnapshot.key;
 
 // Filter by selected categories if any are selected
 if (selectedCategories.size === 0 || selectedCategories.has(markerData.category)) {
 addMarkerToMap(markerData);
 }
 });
 });
 };
 }
 
 // Enhance mobile responsiveness
 function enhanceMobileResponsiveness() {
 const mobileStyle = document.createElement('style');
 mobileStyle.textContent = `
 @media (max-width: 768px) {
 .navbar {
 flex-direction: column;
 padding: 0.5rem;
 }
 .navbar-brand {
 margin-bottom: 0.5rem;
 }
 .navbar-links {
 width: 100%;
 justify-content: space-around;
 }
 .search-container {
 flex-direction: column;
 padding: 1rem;
 }
 .search-input {
 width: 100%;
 margin-bottom: 0.5rem;
 }
 .search-button {
 width: 100%;
 }
 .map-container {
 height: calc(100vh - 120px);
 }
 .modal-base {
 width: 95%;
 max-width: 95%;
 max-height: 90vh;
 padding: 1rem;
 }
 .collection-card {
 width: 100%;
 }
 .stats-grid {
 grid-template-columns: repeat(2, 1fr);
 }
 .category-name {
 width: 80px;
 }
 .filter-badges {
 flex-wrap: wrap;
 }
 .filter-badge {
 margin-bottom: 0.5rem;
 }
 .bulk-actions-container {
 flex-direction: column;
 align-items: flex-start;
 }
 .bulk-actions {
 margin-top: 0.5rem;
 width: 100%;
 justify-content: space-between;
 }
 .collection-markers-list {
 max-height: 50vh;
 }
 }
 
 @media (max-width: 480px) {
 .stats-grid {
 grid-template-columns: 1fr;
 }
 .navbar-links a {
 font-size: 0.9rem;
 padding: 0.3rem 0.5rem;
 }
 .category-bar-item {
 flex-direction: column;
 align-items: flex-start;
 margin-bottom: 1.5rem;
 }
 .category-name {
 width: 100%;
 margin-bottom: 0.25rem;
 }
 .category-bar-container {
 width: 100%;
 margin: 0.25rem 0;
 }
 .category-count {
 width: 100%;
 text-align: left;
 }
 }
 `;
 document.head.appendChild(mobileStyle);
 
 // Add viewport meta tag if not present
 if (!document.querySelector('meta[name="viewport"]')) {
 const viewportMeta = document.createElement('meta');
 viewportMeta.name = 'viewport';
 viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
 document.head.appendChild(viewportMeta);
 }
 
 // Add touch-friendly interactions
 document.addEventListener('touchstart', function() {}, {passive: true});
 }
 
 // Add keyboard navigation and screen reader support
 function enhanceAccessibility() {
 // Add ARIA labels to interactive elements
 document.querySelectorAll('button, a').forEach(element => {
 if (!element.getAttribute('aria-label') && !element.textContent.trim()) {
 // Try to find an icon and use its class for a label
 const icon = element.querySelector('i[class*="fa-"]');
 if (icon) {
 const iconClass = Array.from(icon.classList).find(cls => cls.startsWith('fa-'));
 if (iconClass) {
 const label = iconClass.replace('fa-', '').replace(/-/g, ' ');
 element.setAttribute('aria-label', label);
 }
 }
 }
 });
 
 // Add skip to content link
 const skipLink = document.createElement('a');
 skipLink.href = '#main-content';
 skipLink.className = 'skip-link';
 skipLink.textContent = 'Skip to main content';
 document.body.insertBefore(skipLink, document.body.firstChild);
 
 // Add CSS for skip link
 const skipLinkStyle = document.createElement('style');
 skipLinkStyle.textContent = `
 .skip-link {
 position: absolute;
 top: -40px;
 left: 0;
 background: #2563eb;
 color: white;
 padding: 8px;
 z-index: 9999;
 transition: top 0.3s;
 }
 .skip-link:focus {
 top: 0;
 }
 
 /* Focus styles */
 a:focus, button:focus, input:focus, select:focus, textarea:focus {
 outline: 2px solid #2563eb;
 outline-offset: 2px;
 }
 
 /* High contrast mode support */
 @media (forced-colors: active) {
 .btn, .navbar-links a, .collection-card, .modal-base {
 border: 1px solid currentColor;
 }
 }
 `;
 document.head.appendChild(skipLinkStyle);
 
 // Add main landmark
 const mainContent = document.createElement('main');
 mainContent.id = 'main-content';
 mainContent.setAttribute('role', 'main');
 
 // Move content into main landmark
 const mapPage = document.getElementById('mapPage');
 const searchPage = document.getElementById('searchPage');
 
 if (mapPage && searchPage) {
 // Clone the elements
 const mapPageClone = mapPage.cloneNode(true);
 const searchPageClone = searchPage.cloneNode(true);
 
 // Add to main content
 mainContent.appendChild(searchPageClone);
 mainContent.appendChild(mapPageClone);
 
 // Replace original elements
 mapPage.parentNode.replaceChild(mainContent, mapPage);
 searchPage.parentNode.removeChild(searchPage);
 }
 
 // Add keyboard navigation for map
 if (map) {
 map.keyboard.disable(); // Disable default keyboard handling
 
 document.addEventListener('keydown', (e) => {
 if (!map || document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
 return;
 }
 
 const panAmount = 50; // pixels
 
 switch (e.key) {
 case 'ArrowUp':
 map.panBy([0, -panAmount]);
 e.preventDefault();
 break;
 case 'ArrowDown':
 map.panBy([0, panAmount]);
 e.preventDefault();
 break;
 case 'ArrowLeft':
 map.panBy([-panAmount, 0]);
 e.preventDefault();
 break;
 case 'ArrowRight':
 map.panBy([panAmount, 0]);
 e.preventDefault();
 break;
 case '+':
 map.zoomIn();
 e.preventDefault();
 break;
 case '-':
 map.zoomOut();
 e.preventDefault();
 break;
 case 'Home':
 map.setView([44.9778, -93.2650], 13); // Reset to Minneapolis
 e.preventDefault();
 break;
 }
 });
 }
 }
 
 // Final CSS enhancements
 function enhanceFinalStyling() {
 const finalStyle = document.createElement('style');
 finalStyle.textContent = `
 /* Smooth transitions */
 * {
 transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
 }
 
 /* Improved button styles */
 .btn {
 font-weight: 500;
 letter-spacing: 0.01em;
 text-transform: none;
 border-radius: 8px;
 padding: 0.6rem 1.2rem;
 box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
 }
 
 .btn-primary {
 background-color: #2563eb;
 border-color: #2563eb;
 }
 
 .btn-primary:hover {
 background-color: #1d4ed8;
 border-color: #1d4ed8;
 transform: translateY(-1px);
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
 }
 
 .btn-secondary {
 background-color: #f1f5f9;
 border-color: #e2e8f0;
 color: #1e293b;
 }
 
 .btn-secondary:hover {
 background-color: #e2e8f0;
 border-color: #cbd5e1;
 transform: translateY(-1px);
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
 }
 
 .btn-danger {
 background-color: #ef4444;
 border-color: #ef4444;
 color: white;
 }
 
 .btn-danger:hover {
 background-color: #dc2626;
 border-color: #dc2626;
 transform: translateY(-1px);
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
 }
 
 /* Improved form controls */
 .form-input, .form-select, .form-textarea {
 border-radius: 8px;
 padding: 0.75rem;
 border: 1px solid #d1d5db;
 transition: all 0.3s;
 }
 
 .form-input:focus, .form-select:focus, .form-textarea:focus {
 border-color: #2563eb;
 box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
 outline: none;
 }
 
 /* Card hover effects */
 .collection-card {
 transition: all 0.3s;
 }
 
 .collection-card:hover {
 transform: translateY(-5px);
 box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
 }
 
 /* Improved modal styling */
 .modal-base {
 border-radius: 12px;
 box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
 border: none;
 }
 
 /* Improved notification styling */
 .notification {
 border-radius: 8px;
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
 padding: 1rem;
 font-weight: 500;
 }
 
 /* Improved navbar */
 .navbar {
 background-color: white;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
 }
 
 .navbar-links a {
 border-radius: 8px;
 transition: all 0.3s;
 }
 
 .navbar-links a:hover {
 background-color: #f1f5f9;
 transform: translateY(-2px);
 }
 
 /* Improved map controls */
 .leaflet-control-zoom {
 border-radius: 8px;
 overflow: hidden;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
 }
 
 .leaflet-control-zoom a {
 background-color: white;
 color: #1e293b;
 transition: all 0.3s;
 }
 
 .leaflet-control-zoom a:hover {
 background-color: #f1f5f9;
 color: #2563eb;
 }
 
 /* Improved marker popup */
 .leaflet-popup-content-wrapper {
 border-radius: 8px;
 box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
 }
 
 .marker-popup h3 {
 margin-top: 0;
 color: #1e293b;
 }
 
 .marker-category {
 display: inline-block;
 padding: 0.25rem 0.5rem;
 border-radius: 4px;
 color: white;
 font-size: 0.75rem;
 font-weight: bold;
 margin-bottom: 0.5rem;
 }
 
 /* Print styles */
 @media print {
 .navbar, .map-controls, .leaflet-control, .btn {
 display: none !important;
 }
 
 .map-container {
 height: auto !important;
 page-break-inside: avoid;
 }
 
 .collection-card {
 page-break-inside: avoid;
 box-shadow: none !important;
 border: 1px solid #e2e8f0;
 }
 }
 `;
 document.head.appendChild(finalStyle);
 }
 
 // Initialize all enhancements
 function initializeEnhancements() {
 // Add marker clustering when map is initialized
 const originalInitializeMap = window.initializeMap;
 window.initializeMap = function() {
 originalInitializeMap();
 
 // Add marker clustering after map is initialized
 setTimeout(addMarkerClustering, 100);
 };
 
 // Add collection statistics when collections are loaded
 const originalLoadCollections = window.loadCollections;
 window.loadCollections = function() {
 originalLoadCollections();
 
 // Add collection statistics after collections are loaded
 setTimeout(addCollectionStatistics, 100);
 };
 
 // Enhance mobile responsiveness
 enhanceMobileResponsiveness();
 
 // Enhance accessibility
 enhanceAccessibility();
 
 // Apply final styling enhancements
 enhanceFinalStyling();
 }
 
 // Call initialize enhancements
 initializeEnhancements();
 
 // Add a welcome tour for new users
 function addWelcomeTour() {
 // Check if user has seen the tour
 if (currentUser && localStorage.getItem(`tour_seen_${currentUser.uid}`) !== 'true') {
 // Create tour modal
 const tourModal = document.createElement('div');
 tourModal.className = 'modal-base tour-modal';
 tourModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Welcome to Minnesota Community Markers!</h2>
 <div class="tour-content">
 <div class="tour-step active" data-step="1">
 <div class="tour-image">
 <img src="/placeholder.svg?height=200&width=300" alt="Map Overview">
 </div>
 <h3>Discover Minnesota</h3>
 <p>Explore interesting locations across Minnesota with our interactive map. See markers added by community members and discover new places to visit.</p>
 </div>
 <div class="tour-step" data-step="2">
 <div class="tour-image">
 <img src="/placeholder.svg?height=200&width=300" alt="Adding Markers">
 </div>
 <h3>Add Your Own Markers</h3>
 <p>Share your favorite locations by adding markers to the map. Just click on the map and fill in the details about the location.</p>
 </div>
 <div class="tour-step" data-step="3">
 <div class="tour-image">
 <img src="/placeholder.svg?height=200&width=300" alt="Collections Feature">
 </div>
 <h3>Create Collections</h3>
 <p>Organize markers into collections for easy access. Create themed collections like "Hiking Spots" or "Best Restaurants" to share with others.</p>
 </div>
 <div class="tour-step" data-step="4">
 <div class="tour-image">
 <img src="/placeholder.svg?height=200&width=300" alt="Sharing Collections">
 </div>
 <h3>Share with Friends</h3>
 <p>Share your collections with friends and family. Export collections for offline use or print them for your next adventure.</p>
 </div>
 </div>
 <div class="tour-navigation">
 <button class="btn btn-secondary tour-prev" disabled>Previous</button>
 <div class="tour-dots">
 <span class="tour-dot active" data-step="1"></span>
 <span class="tour-dot" data-step="2"></span>
 <span class="tour-dot" data-step="3"></span>
 <span class="tour-dot" data-step="4"></span>
 </div>
 <button class="btn btn-primary tour-next">Next</button>
 </div>
 <div class="tour-skip">
 <button class="btn btn-text skip-tour-btn">Skip Tour</button>
 </div>
 `;
 document.body.appendChild(tourModal);
 tourModal.style.display = "block";
 overlay.style.display = "block";
 
 // Add CSS for tour
 const tourStyle = document.createElement('style');
 tourStyle.textContent = `
 .tour-modal {
 max-width: 600px;
 }
 .tour-content {
 margin: 1.5rem 0;
 }
 .tour-step {
 display: none;
 text-align: center;
 }
 .tour-step.active {
 display: block;
 animation: fadeIn 0.5s;
 }
 .tour-image {
 margin-bottom: 1rem;
 }
 .tour-image img {
 border-radius: 8px;
 max-width: 100%;
 height: auto;
 }
 .tour-navigation {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-top: 1.5rem;
 }
 .tour-dots {
 display: flex;
 gap: 0.5rem;
 }
 .tour-dot {
 width: 10px;
 height: 10px;
 border-radius: 50%;
 background-color: #e2e8f0;
 cursor: pointer;
 transition: all 0.3s;
 }
 .tour-dot.active {
 background-color: #2563eb;
 transform: scale(1.2);
 }
 .tour-skip {
 text-align: center;
 margin-top: 1rem;
 }
 .btn-text {
 background: none;
 border: none;
 color: #64748b;
 text-decoration: underline;
 cursor: pointer;
 }
 @keyframes fadeIn {
 from { opacity: 0; }
 to { opacity: 1; }
 }
 `;
 document.head.appendChild(tourStyle);
 
 // Tour navigation
 const tourSteps = tourModal.querySelectorAll('.tour-step');
 const tourDots = tourModal.querySelectorAll('.tour-dot');
 const prevBtn = tourModal.querySelector('.tour-prev');
 const nextBtn = tourModal.querySelector('.tour-next');
 const skipBtn = tourModal.querySelector('.skip-tour-btn');
 const closeBtn = tourModal.querySelector('.close-btn');
 
 let currentStep = 1;
 
 // Next button
 nextBtn.addEventListener('click', () => {
 if (currentStep < tourSteps.length) {
 // Hide current step
 tourSteps.forEach(step => step.classList.remove('active'));
 tourDots.forEach(dot => dot.classList.remove('active'));
 
 // Show next step
 currentStep++;
 tourSteps[currentStep - 1].classList.add('active');
 tourDots[currentStep - 1].classList.add('active');
 
 // Update buttons
 prevBtn.disabled = false;
 
 if (currentStep === tourSteps.length) {
 nextBtn.textContent = 'Finish';
 }
 } else {
 // End tour
 tourModal.style.display = 'none';
 overlay.style.display = 'none';
 
 // Mark tour as seen
 if (currentUser) {
 localStorage.setItem(`tour_seen_${currentUser.uid}`, 'true');
 }
 }
 });
 
 // Previous button
 prevBtn.addEventListener('click', () => {
 if (currentStep > 1) {
 // Hide current step
 tourSteps.forEach(step => step.classList.remove('active'));
 tourDots.forEach(dot => dot.classList.remove('active'));
 
 // Show previous step
 currentStep--;
 tourSteps[currentStep - 1].classList.add('active');
 tourDots[currentStep - 1].classList.add('active');
 
 // Update buttons
 nextBtn.textContent = 'Next';
 
 if (currentStep === 1) {
 prevBtn.disabled = true;
 }
 }
 });
 
 // Dot navigation
 tourDots.forEach(dot => {
 dot.addEventListener('click', () => {
 const step = parseInt(dot.dataset.step);
 
 // Hide current step
 tourSteps.forEach(step => step.classList.remove('active'));
 tourDots.forEach(dot => dot.classList.remove('active'));
 
 // Show selected step
 currentStep = step;
 tourSteps[currentStep - 1].classList.add('active');
 tourDots[currentStep - 1].classList.add('active');
 
 // Update buttons
 prevBtn.disabled = currentStep === 1;
 nextBtn.textContent = currentStep === tourSteps.length ? 'Finish' : 'Next';
 });
 });
 
 // Skip tour
 skipBtn.addEventListener('click', () => {
 tourModal.style.display = 'none';
 overlay.style.display = 'none';
 
 // Mark tour as seen
 if (currentUser) {
 localStorage.setItem(`tour_seen_${currentUser.uid}`, 'true');
 }
 });
 
 // Close button
 closeBtn.addEventListener('click', () => {
 tourModal.style.display = 'none';
 overlay.style.display = 'none';
 
 // Mark tour as seen
 if (currentUser) {
 localStorage.setItem(`tour_seen_${currentUser.uid}`, 'true');
 }
 });
 }
 }
 
 // Call welcome tour when user logs in
 const originalLoadUserData = window.loadUserData;
 window.loadUserData = function() {
 originalLoadUserData();
 
 // Show welcome tour after user data is loaded
 setTimeout(addWelcomeTour, 500);
 };
 
 

 // Final initialization
 console.log("Community Markers Map application initialized successfully!");
 
 // Add dark mode toggle
 function addDarkModeToggle() {
 // Create dark mode toggle button
 const darkModeToggle = document.createElement('button');
 darkModeToggle.className = 'dark-mode-toggle';
 darkModeToggle.setAttribute('aria-label', 'Toggle dark mode');
 darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
 document.body.appendChild(darkModeToggle);
 
 // Check for saved preference
 const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
 const savedMode = localStorage.getItem('darkMode');
 
 // Set initial mode
 if (savedMode === 'dark' || (savedMode === null && prefersDarkMode)) {
 document.documentElement.classList.add('dark');
 darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
 }
 
 // Toggle dark mode
 darkModeToggle.addEventListener('click', () => {
 document.documentElement.classList.toggle('dark');
 
 // Update button icon
 if (document.documentElement.classList.contains('dark')) {
 darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
 localStorage.setItem('darkMode', 'dark');
 } else {
 darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
 localStorage.setItem('darkMode', 'light');
 }
 
 // Update map tiles if map exists
 if (map) {
 updateMapTiles();
 }
 });
 
 // Add CSS for dark mode
 const darkModeStyle = document.createElement('style');
 darkModeStyle.textContent = `
 .dark-mode-toggle {
 position: fixed;
 bottom: 20px;
 right: 20px;
 width: 50px;
 height: 50px;
 border-radius: 50%;
 background-color: white;
 color: #1e293b;
 border: none;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 1.25rem;
 cursor: pointer;
 z-index: 1000;
 transition: all 0.3s;
 }
 
 .dark-mode-toggle:hover {
 transform: translateY(-3px);
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
 }
 
 /* Dark mode styles */
 .dark {
 color-scheme: dark;
 }
 
 .dark body {
 background-color: #0f172a;
 color: #f1f5f9;
 }
 
 .dark .navbar {
 background-color: #1e293b;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
 }
 
 .dark .navbar-brand {
 color: white;
 }
 
 .dark .navbar-links a {
 color: #e2e8f0;
 }
 
 .dark .navbar-links a:hover {
 background-color: #334155;
 }
 
 .dark .search-container {
 background-color: #1e293b;
 }
 
 .dark .search-input {
 background-color: #334155;
 color: white;
 border-color: #475569;
 }
 
 .dark .search-input::placeholder {
 color: #94a3b8;
 }
 
 .dark .modal-base {
 background-color: #1e293b;
 color: #f1f5f9;
 }
 
 .dark .close-btn {
 color: #f1f5f9;
 }
 
 .dark .form-input, .dark .form-select, .dark .form-textarea {
 background-color: #334155;
 color: white;
 border-color: #475569;
 }
 
 .dark .btn-secondary {
 background-color: #334155;
 border-color: #475569;
 color: #f1f5f9;
 }
 
 .dark .btn-secondary:hover {
 background-color: #475569;
 }
 
 .dark .collection-card {
 background-color: #334155;
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
 }
 
 .dark .collection-info {
 background-color: #334155;
 }
 
 .dark .collection-title {
 color: #f1f5f9;
 }
 
 .dark .collection-stats {
 color: #cbd5e1;
 }
 
 .dark .collection-statistics {
 background-color: #1e293b;
 }
 
 .dark .stat-card {
 background-color: #334155;
 }
 
 .dark .stat-value {
 color: #f1f5f9;
 }
 
 .dark .stat-label {
 color: #cbd5e1;
 }
 
 .dark .category-name {
 color: #f1f5f9;
 }
 
 .dark .category-bar-container {
 background-color: #475569;
 }
 
 .dark .filter-badge {
 background-color: #334155;
 color: #cbd5e1;
 }
 
 .dark .bulk-actions-container {
 background-color: #1e293b;
 border-color: #334155;
 }
 
 .dark .tooltip {
 background-color: rgba(15, 23, 42, 0.9);
 }
 
 .dark .tooltip::after {
 border-color: rgba(15, 23, 42, 0.9) transparent transparent transparent;
 }
 
 .dark .dark-mode-toggle {
 background-color: #334155;
 color: #f1f5f9;
 }
 
 .dark .notification {
 background-color: #1e293b;
 color: #f1f5f9;
 }
 
 .dark .notification.success {
 background-color: #065f46;
 }
 
 .dark .notification.error {
 background-color: #991b1b;
 }
 
 .dark .notification.warning {
 background-color: #92400e;
 }
 
 .dark .notification.info {
 background-color: #1e40af;
 }
 `;
 document.head.appendChild(darkModeStyle);
 }
 
 // Update map tiles for dark mode
 function updateMapTiles() {
 if (!map) return;
 
 const isDarkMode = document.documentElement.classList.contains('dark');
 
 // Remove current tile layer
 map.eachLayer(layer => {
 if (layer instanceof L.TileLayer) {
 map.removeLayer(layer);
 }
 });
 
 // Add appropriate tile layer
 if (isDarkMode) {
 L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
 attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
 subdomains: 'abcd',
 maxZoom: 19
 }).addTo(map);
 } else {
 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
 attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
 maxZoom: 19
 }).addTo(map);
 }
 }
 
 // Add "Save Current View" feature
 function addSaveViewFeature() {
 if (!map) return;
 
 // Create save view button
 const saveViewBtn = document.createElement('button');
 saveViewBtn.className = 'map-control-btn save-view-btn';
 saveViewBtn.innerHTML = '<i class="fas fa-bookmark"></i>';
 saveViewBtn.setAttribute('title', 'Save current view');
 saveViewBtn.setAttribute('data-tooltip', 'Save current view');
 
 // Add to map controls
 const mapControls = document.querySelector('.map-controls');
 if (mapControls) {
 mapControls.appendChild(saveViewBtn);
 } else {
 // Create map controls if not exists
 const newMapControls = document.createElement('div');
 newMapControls.className = 'map-controls';
 newMapControls.appendChild(saveViewBtn);
 document.querySelector('.map-container').appendChild(newMapControls);
 }
 
 // Save view event
 saveViewBtn.addEventListener('click', () => {
 if (!currentUser) {
 showNotification("Please log in to save views", "error");
 return;
 }
 
 const center = map.getCenter();
 const zoom = map.getZoom();
 
 // Create save view modal
 const saveViewModal = document.createElement('div');
 saveViewModal.className = 'modal-base';
 saveViewModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Save Current View</h2>
 <form id="saveViewForm">
 <div class="form-group">
 <label for="viewName">Name</label>
 <input type="text" id="viewName" class="form-input" placeholder="My Favorite View" required>
 </div>
 <div class="form-group">
 <label for="viewDescription">Description (optional)</label>
 <textarea id="viewDescription" class="form-textarea" rows="3" placeholder="Describe this view..."></textarea>
 </div>
 <div class="form-group">
 <button type="submit" class="btn btn-primary">Save View</button>
 </div>
 </form>
 `;
 document.body.appendChild(saveViewModal);
 saveViewModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = saveViewModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 saveViewModal.style.display = "none";
 overlay.style.display = "none";
 saveViewModal.remove();
 });
 
 // Form submit event
 const saveViewForm = document.getElementById('saveViewForm');
 saveViewForm.addEventListener('submit', (e) => {
 e.preventDefault();
 
 const viewName = document.getElementById('viewName').value;
 const viewDescription = document.getElementById('viewDescription').value;
 
 // Save to database
 const savedViewRef = database.ref(`savedViews/${currentUser.uid}`).push();
 savedViewRef.set({
 name: viewName,
 description: viewDescription,
 lat: center.lat,
 lng: center.lng,
 zoom: zoom,
 created: Date.now()
 })
 .then(() => {
 showNotification("View saved successfully", "success");
 saveViewModal.style.display = "none";
 overlay.style.display = "none";
 saveViewModal.remove();
 })
 .catch(error => {
 showNotification("Error saving view: " + error.message, "error");
 });
 });
 });
 
 // Create load view button
 const loadViewBtn = document.createElement('button');
 loadViewBtn.className = 'map-control-btn load-view-btn';
 loadViewBtn.innerHTML = '<i class="fas fa-list"></i>';
 loadViewBtn.setAttribute('title', 'Load saved views');
 loadViewBtn.setAttribute('data-tooltip', 'Load saved views');
 
 // Add to map controls
 if (mapControls) {
 mapControls.appendChild(loadViewBtn);
 } else {
 document.querySelector('.map-container').querySelector('.map-controls').appendChild(loadViewBtn);
 }
 
 // Load views event
 loadViewBtn.addEventListener('click', () => {
 if (!currentUser) {
 showNotification("Please log in to load saved views", "error");
 return;
 }
 
 // Create load view modal
 const loadViewModal = document.createElement('div');
 loadViewModal.className = 'modal-base';
 loadViewModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Saved Views</h2>
 <div id="savedViewsList" class="saved-views-list">
 <div class="loading">Loading saved views...</div>
 </div>
 `;
 document.body.appendChild(loadViewModal);
 loadViewModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = loadViewModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 loadViewModal.style.display = "none";
 overlay.style.display = "none";
 loadViewModal.remove();
 });
 
 // Load saved views
 const savedViewsList = document.getElementById('savedViewsList');
 
 database.ref(`savedViews/${currentUser.uid}`).once("value", (snapshot) => {
 if (!snapshot.exists()) {
 savedViewsList.innerHTML = "<p>You have no saved views yet.</p>";
 return;
 }
 
 const views = [];
 snapshot.forEach((childSnapshot) => {
 views.push({
 id: childSnapshot.key,
 ...childSnapshot.val(),
 });
 });
 
 if (views.length === 0) {
 savedViewsList.innerHTML = "<p>You have no saved views yet.</p>";
 return;
 }
 
 // Sort by date (newest first)
 views.sort((a, b) => b.created - a.created);
 
 savedViewsList.innerHTML = views
 .map(
 (view) => `
 <div class="saved-view-item">
 <div class="saved-view-info">
 <h3>${view.name}</h3>
 <p>${view.description || "No description"}</p>
 <div class="saved-view-meta">
 <span><i class="fas fa-map-marker-alt"></i> ${view.lat.toFixed(6)}, ${view.lng.toFixed(6)}</span>
 <span><i class="fas fa-search"></i> Zoom: ${view.zoom}</span>
 <span><i class="fas fa-calendar-alt"></i> ${new Date(view.created).toLocaleDateString()}</span>
 </div>
 </div>
 <div class="saved-view-actions">
 <button class="btn btn-primary load-view-item-btn" data-view-id="${view.id}">Load</button>
 <button class="btn btn-danger delete-view-btn" data-view-id="${view.id}">Delete</button>
 </div>
 </div>
 `
 )
 .join("");
 
 // Add event listeners to the buttons
 document.querySelectorAll('.load-view-item-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const viewId = e.target.dataset.viewId;
 const view = views.find(v => v.id === viewId);
 
 if (view) {
 map.setView([view.lat, view.lng], view.zoom);
 loadViewModal.style.display = "none";
 overlay.style.display = "none";
 loadViewModal.remove();
 }
 });
 });
 
 document.querySelectorAll('.delete-view-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const viewId = e.target.dataset.viewId;
 
 if (confirm("Are you sure you want to delete this saved view?")) {
 database.ref(`savedViews/${currentUser.uid}/${viewId}`).remove()
 .then(() => {
 e.target.closest('.saved-view-item').remove();
 showNotification("View deleted successfully", "success");
 
 // Check if there are no more views
 if (document.querySelectorAll('.saved-view-item').length === 0) {
 savedViewsList.innerHTML = "<p>You have no saved views yet.</p>";
 }
 })
 .catch(error => {
 showNotification("Error deleting view: " + error.message, "error");
 });
 }
 });
 });
 });
 });
 
 // Add CSS for saved views
 const savedViewsStyle = document.createElement('style');
 savedViewsStyle.textContent = `
 .map-controls {
 position: absolute;
 top: 20px;
 right: 20px;
 z-index: 1000;
 display: flex;
 flex-direction: column;
 gap: 10px;
 }
 
 .map-control-btn {
 width: 40px;
 height: 40px;
 border-radius: 50%;
 background-color: white;
 color: #1e293b;
 border: none;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 1rem;
 cursor: pointer;
 transition: all 0.3s;
 }
 
 .map-control-btn:hover {
 transform: translateY(-2px);
 box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
 }
 
 .dark .map-control-btn {
 background-color: #334155;
 color: #f1f5f9;
 }
 
 .saved-views-list {
 max-height: 400px;
 overflow-y: auto;
 }
 
 .saved-view-item {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: 1rem;
 border-bottom: 1px solid #e2e8f0;
 }
 
 .dark .saved-view-item {
 border-bottom-color: #334155;
 }
 
 .saved-view-item:last-child {
 border-bottom: none;
 }
 
 .saved-view-info {
 flex: 1;
 }
 
 .saved-view-info h3 {
 margin-top: 0;
 margin-bottom: 0.5rem;
 }
 
 .saved-view-info p {
 margin-top: 0;
 margin-bottom: 0.5rem;
 color: #64748b;
 }
 
 .dark .saved-view-info p {
 color: #94a3b8;
 }
 
 .saved-view-meta {
 display: flex;
 flex-wrap: wrap;
 gap: 1rem;
 font-size: 0.85rem;
 color: #64748b;
 }
 
 .dark .saved-view-meta {
 color: #94a3b8;
 }
 
 .saved-view-actions {
 display: flex;
 gap: 0.5rem;
 }
 
 @media (max-width: 768px) {
 .saved-view-item {
 flex-direction: column;
 align-items: flex-start;
 }
 
 .saved-view-actions {
 margin-top: 1rem;
 width: 100%;
 justify-content: flex-end;
 }
 }
 `;
 document.head.appendChild(savedViewsStyle);
 }
 
 // Add "Report Issue" functionality
 function addReportIssueFeature() {
 // Create report issue link
 const reportIssueLink = document.createElement('a');
 reportIssueLink.href = '#';
 reportIssueLink.textContent = 'Report Issue';
 reportIssueLink.className = 'report-issue-link';
 
 // Add to navbar
 const navbar = document.querySelector('.navbar-links');
 if (navbar) {
 navbar.appendChild(reportIssueLink);
 }
 
 // Report issue event
 reportIssueLink.addEventListener('click', (e) => {
 e.preventDefault();
 
 // Create report issue modal
 const reportIssueModal = document.createElement('div');
 reportIssueModal.className = 'modal-base';
 reportIssueModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>Report an Issue</h2>
 <form id="reportIssueForm">
 <div class="form-group">
 <label for="issueType">Issue Type</label>
 <select id="issueType" class="form-select" required>
 <option value="">Select an issue type</option>
 <option value="bug">Bug or Error</option>
 <option value="inappropriate">Inappropriate Content</option>
 <option value="suggestion">Suggestion</option>
 <option value="other">Other</option>
 </select>
 </div>
 <div class="form-group">
 <label for="issueDescription">Description</label>
 <textarea id="issueDescription" class="form-textarea" rows="5" placeholder="Please describe the issue in detail..." required></textarea>
 </div>
 <div class="form-group">
 <label for="issueLocation">Location (optional)</label>
 <div class="location-input">
 <input type="text" id="issueLocation" class="form-input" placeholder="Click on the map to select location" readonly>
 <button type="button" id="selectLocationBtn" class="btn btn-secondary">Select on Map</button>
 </div>
 </div>
 <div class="form-group">
 <button type="submit" class="btn btn-primary">Submit Report</button>
 </div>
 </form>
 `;
 document.body.appendChild(reportIssueModal);
 reportIssueModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = reportIssueModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 reportIssueModal.style.display = "none";
 overlay.style.display = "none";
 reportIssueModal.remove();
 
 // Reset map click handler
 if (map) {
 map.off('click', mapClickHandler);
 }
 });
 
 // Select location button
 const selectLocationBtn = document.getElementById('selectLocationBtn');
 const issueLocationInput = document.getElementById('issueLocation');
 let selectedLocation = null;
 
 selectLocationBtn.addEventListener('click', () => {
 // Close modal temporarily
 reportIssueModal.style.display = "none";
 overlay.style.display = "none";
 
 // Show map if not visible
 if (mapPage.style.display === "none") {
 searchPage.style.display = "none";
 mapPage.style.display = "block";
 
 // Initialize map if not initialized
 if (!map) {
 initializeMap();
 }
 }
 
 // Show notification
 showNotification("Click on the map to select a location", "info", 5000);
 
 // Set map click handler
 const mapClickHandler = function(e) {
 selectedLocation = e.latlng;
 issueLocationInput.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
 
 // Show modal again
 reportIssueModal.style.display = "block";
 overlay.style.display = "block";
 
 // Remove click handler
 map.off('click', mapClickHandler);
 };
 
 map.on('click', mapClickHandler);
 });
 
 // Form submit event
 const reportIssueForm = document.getElementById('reportIssueForm');
 reportIssueForm.addEventListener('submit', (e) => {
 e.preventDefault();
 
 const issueType = document.getElementById('issueType').value;
 const issueDescription = document.getElementById('issueDescription').value;
 
 // Save to database
 const issueRef = database.ref('issues').push();
 issueRef.set({
 type: issueType,
 description: issueDescription,
 location: selectedLocation ? {
 lat: selectedLocation.lat,
 lng: selectedLocation.lng
 } : null,
 user: currentUser ? {
 uid: currentUser.uid,
 name: currentUser.displayName || 'Anonymous',
 email: currentUser.email || 'No email'
 } : {
 uid: null,
 name: 'Anonymous',
 email: 'No email'
 },
 status: 'new',
 created: Date.now(),
 userAgent: navigator.userAgent,
 screenSize: {
 width: window.innerWidth,
 height: window.innerHeight
 }
 })
 .then(() => {
 showNotification("Issue reported successfully. Thank you for your feedback!", "success");
 reportIssueModal.style.display = "none";
 overlay.style.display = "none";
 reportIssueModal.remove();
 })
 .catch(error => {
 showNotification("Error reporting issue: " + error.message, "error");
 });
 });
 });
 
 // Add CSS for report issue
 const reportIssueStyle = document.createElement('style');
 reportIssueStyle.textContent = `
 .report-issue-link {
 margin-left: 1rem;
 font-size: 0.9rem;
 color: #64748b;
 }
 
 .dark .report-issue-link {
 color: #94a3b8;
 }
 
 .location-input {
 display: flex;
 gap: 0.5rem;
 }
 
 .location-input .form-input {
 flex: 1;
 }
 
 @media (max-width: 768px) {
 .location-input {
 flex-direction: column;
 }
 }
 `;
 document.head.appendChild(reportIssueStyle);
 }
 
 // Final performance optimizations
 function optimizePerformance() {
 // Debounce function for performance
 function debounce(func, wait) {
 let timeout;
 return function() {
 const context = this;
 const args = arguments;
 clearTimeout(timeout);
 timeout = setTimeout(() => func.apply(context, args), wait);
 };
 }
 
 // Debounce resize event
 const debouncedResize = debounce(() => {
 if (map) {
 map.invalidateSize();
 }
 }, 250);
 
 window.addEventListener('resize', debouncedResize);
 
 // Use requestAnimationFrame for smooth animations
 const originalShowNotification = window.showNotification;
 window.showNotification = function(message, type = "info", duration = 3000) {
 requestAnimationFrame(() => {
 originalShowNotification(message, type, duration);
 });
 };
 
 // Optimize marker loading
 const originalLoadMarkers = window.loadMarkers;
 window.loadMarkers = function() {
 // Show loading indicator
 const loadingIndicator = document.createElement('div');
 loadingIndicator.className = 'loading-indicator';
 loadingIndicator.innerHTML = '<div class="spinner"></div><div>Loading markers...</div>';
 document.body.appendChild(loadingIndicator);
 
 // Use setTimeout to prevent UI blocking
 setTimeout(() => {
 originalLoadMarkers();
 
 // Remove loading indicator
 loadingIndicator.remove();
 }, 10);
 };
 
 // Add CSS for loading indicator
 const loadingStyle = document.createElement('style');
 loadingStyle.textContent = `
 .loading-indicator {
 position: fixed;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 background-color: rgba(255, 255, 255, 0.9);
 color: #1e293b;
 padding: 1rem 2rem;
 border-radius: 8px;
 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
 display: flex;
 flex-direction: column;
 align-items: center;
 gap: 0.5rem;
 z-index: 9999;
 }
 
 .dark .loading-indicator {
 background-color: rgba(30, 41, 59, 0.9);
 color: #f1f5f9;
 }
 
 .spinner {
 width: 30px;
 height: 30px;
 border: 3px solid #e2e8f0;
 border-top-color: #2563eb;
 border-radius: 50%;
 animation: spin 1s linear infinite;
 }
 
 .dark .spinner {
 border-color: #334155;
 border-top-color: #3b82f6;
 }
 
 @keyframes spin {
 to { transform: rotate(360deg); }
 }
 `;
 document.head.appendChild(loadingStyle);
 
 // Use IntersectionObserver for lazy loading
 const lazyLoadImages = () => {
 const imageObserver = new IntersectionObserver((entries, observer) => {
 entries.forEach(entry => {
 if (entry.isIntersecting) {
 const img = entry.target;
 const src = img.getAttribute('data-src');
 if (src) {
 img.src = src;
 img.removeAttribute('data-src');
 observer.unobserve(img);
 }
 }
 });
 });
 
 document.querySelectorAll('img[data-src]').forEach(img => {
 imageObserver.observe(img);
 });
 };
 
 // Call lazy load on page load and when collections are loaded
 window.addEventListener('load', lazyLoadImages);
 
 const originalLoadCollections = window.loadCollections;
 window.loadCollections = function() {
 originalLoadCollections();
 
 // Lazy load images after collections are loaded
 setTimeout(lazyLoadImages, 100);
 };
 }
 
 // Initialize final features
 function initializeFinalFeatures() {
 // Add dark mode toggle
 addDarkModeToggle();
 
 // Add save view feature
 addSaveViewFeature();
 
 // Add report issue feature
 addReportIssueFeature();
 
 // Optimize performance
 optimizePerformance();
 }
 
 // Call initialize final features
 initializeFinalFeatures();
 
 // Add a feedback button
 function addFeedbackButton() {
 // Create feedback button
 const feedbackBtn = document.createElement('button');
 feedbackBtn.className = 'feedback-btn';
 feedbackBtn.innerHTML = '<i class="fas fa-comment-alt"></i>';
 feedbackBtn.setAttribute('aria-label', 'Provide feedback');
 feedbackBtn.setAttribute('title', 'Provide feedback');
 document.body.appendChild(feedbackBtn);
 
 // Feedback button event
 feedbackBtn.addEventListener('click', () => {
 // Create feedback modal
 const feedbackModal = document.createElement('div');
 feedbackModal.className = 'modal-base';
 feedbackModal.innerHTML = `
 <button class="close-btn">×</button>
 <h2>We Value Your Feedback</h2>
 <p>Help us improve the Minnesota Community Markers Map by sharing your thoughts.</p>
 <form id="feedbackForm">
 <div class="form-group">
 <label for="feedbackType">Feedback Type</label>
 <select id="feedbackType" class="form-select" required>
 <option value="">Select feedback type</option>
 <option value="suggestion">Suggestion</option>
 <option value="compliment">Compliment</option>
 <option value="issue">Issue</option>
 <option value="other">Other</option>
 </select>
 </div>
 <div class="form-group">
 <label for="feedbackMessage">Your Feedback</label>
 <textarea id="feedbackMessage" class="form-textarea" rows="5" placeholder="Tell us what you think..." required></textarea>
 </div>
 <div class="form-group">
 <label for="feedbackRating">Rate Your Experience (1-5)</label>
 <div class="rating-container">
 <div class="star-rating">
 <input type="radio" id="star5" name="rating" value="5" /><label for="star5"></label>
 <input type="radio" id="star4" name="rating" value="4" /><label for="star4"></label>
 <input type="radio" id="star3" name="rating" value="3" /><label for="star3"></label>
 <input type="radio" id="star2" name="rating" value="2" /><label for="star2"></label>
 <input type="radio" id="star1" name="rating" value="1" /><label for="star1"></label>
 </div>
 </div>
 </div>
 <div class="form-group">
 <button type="submit" class="btn btn-primary">Submit Feedback</button>
 </div>
 </form>
 `;
 document.body.appendChild(feedbackModal);
 feedbackModal.style.display = "block";
 overlay.style.display = "block";
 
 // Close button event
 const closeBtn = feedbackModal.querySelector(".close-btn");
 closeBtn.addEventListener("click", () => {
 feedbackModal.style.display = "none";
 overlay.style.display = "none";
 feedbackModal.remove();
 });
 
 // Form submit event
 const feedbackForm = document.getElementById('feedbackForm');
 feedbackForm.addEventListener('submit', (e) => {
 e.preventDefault();
 
 const feedbackType = document.getElementById('feedbackType').value;
 const feedbackMessage = document.getElementById('feedbackMessage').value;
 const feedbackRating = document.querySelector('input[name="rating"]:checked')?.value || '0';
 
 // Save to database
 const feedbackRef = database.ref('feedback').push();
 feedbackRef.set({
 type: feedbackType,
 message: feedbackMessage,
 rating: feedbackRating,
 user: currentUser ? {
 uid: currentUser.uid,
 name: currentUser.displayName || 'Anonymous',
 email: currentUser.email || 'No email'
 } : {
 uid: null,
 name: 'Anonymous',
 email: 'No email'
 },
 created: Date.now()
 })
 .then(() => {
 showNotification("Thank you for your feedback!", "success");
 feedbackModal.style.display = "none";
 overlay.style.display = "none";
 feedbackModal.remove();
 })
 .catch(error => {
 showNotification("Error submitting feedback: " + error.message, "error");
 });
 });
 });
 
 // Add CSS for feedback button and star rating
 const feedbackStyle = document.createElement('style');
 feedbackStyle.textContent = `
 .feedback-btn {
 position: fixed;
 bottom: 20px;
 left: 20px;
 width: 50px;
 height: 50px;
 border-radius: 50%;
 background-color: #2563eb;
 color: white;
 border: none;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 1.25rem;
 cursor: pointer;
 z-index: 1000;
 transition: all 0.3s;
 }
 
 .feedback-btn:hover {
 transform: translateY(-3px);
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
 background-color: #1d4ed8;
 }
 
 .rating-container {
 display: flex;
 align-items: center;
 margin-top: 0.5rem;
 }
 
 .star-rating {
 display: flex;
 flex-direction: row-reverse;
 font-size: 1.5rem;
 justify-content: flex-end;
 padding: 0 0.2em;
 text-align: center;
 }
 
 .star-rating input {
 display: none;
 }
 
 .star-rating label {
 color: #ccc;
 cursor: pointer;
 }
 
 .star-rating :checked ~ label {
 color: #f90;
 }
 
 .star-rating label:hover,
 .star-rating label:hover ~ label {
 color: #fc0;
 }
 
 .dark .star-rating label {
 color: #475569;
 }
 
 .dark .star-rating :checked ~ label {
 color: #f59e0b;
 }
 
 .dark .star-rating label:hover,
 .dark .star-rating label:hover ~ label {
 color: #fbbf24;
 }
 
 .star-rating label:before {
 content: "★";
 }
 `;
 document.head.appendChild(feedbackStyle);
 }
 
 // Call add feedback button
 addFeedbackButton();
 

 // Final application check
 console.log("Minnesota Community Markers Map application fully initialized and ready to use!");
 });
 </script>
</body>
</html>
