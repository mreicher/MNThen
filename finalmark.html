<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Markers Map</title>
  <link rel="shortcut icon" type="image/x-icon" href="https://www.mnthen.com/images/mnthenfav.ico">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://www.mnthen.com/css/mnthen_marker.css">
  <style>
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}
#map {
    height: 100vh;
    width: 100vw;
}
.page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: transform 0.5s ease-in-out;
}
.search-page {
    background-color: #f0f0f0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
}
.map-page {
    transform: translateY(100%);
    z-index: 5;
}
.modal-base {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    z-index: 1001;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}
.close-btn {
    position: absolute;
    right: 1rem;
    top: 1rem;
    font-size: 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}
.close-btn:hover {
    background-color: #f0f0f0;
    color: #333;
}
.floating-menu {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
.floating-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s ease;
}
.floating-btn:hover {
    background-color: #0056b3;
}
.menu-content {
    display: none;
    position: absolute;
    bottom: 60px;
    right: 0;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    width: 200px;
    padding: 10px;
}
.menu-content a {
    display: block;
    padding: 10px;
    color: #333;
    text-decoration: none;
    border-bottom: 1px solid #eee;
}
.menu-content a:hover {
    background-color: #f9f9f9;
}
.menu-content a:last-child {
    border-bottom: none;
}
.overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 1002;
    display: none;
}
.notification.success {
    background-color: #4CAF50;
}
.notification.error {
    background-color: #f44336;
}
.info-button {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background-color: #101010;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
.info-button:hover {
    background-color: #545454;
}
.auth-popup {
    max-width: 400px;
    padding: 2rem;
}
.auth-tabs {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.auth-tab {
    padding: 0.5rem 1rem;
    border: none;
    background-color: transparent;
    color: #007bff;
    font-size: 1rem;
    cursor: pointer;
    transition: color 0.2s, border-bottom 0.2s;
}
.auth-tab.active {
    color: #333;
    border-bottom: 2px solid #007bff;
}
.auth-tab:hover {
    color: #0056b3;
}
.auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.form-group label {
    font-size: 0.95rem;
    color: #555;
    font-weight: 500;
}
.form-group input {
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
}
.form-group input:focus {
    border-color: #007bff;
    outline: none;
}
.auth-button {
    padding: 0.75rem 1rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
}
.auth-button:hover {
    background-color: #0056b3;
}
#markerModal form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
#markerModal input,
#markerModal textarea {
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
}
#markerModal input:focus,
#markerModal textarea:focus {
    border-color: #007bff;
    outline: none;
}
#markerModal button {
    padding: 0.75rem 1rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s;
}
#markerModal button:hover {
    background-color: #0056b3;
}
#markerInfoModal {
    max-width: 800px;
    display: flex;
    flex-direction: row;
    padding: 2rem;
}
#markerInfoModal .marker-info-content {
    display: flex;
    flex-direction: row;
    gap: 2rem;
}
#markerInfoModal .marker-image-container {
    width: 50%;
}
#markerInfoModal .marker-details {
    width: 50%;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
#markerInfoModal img {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 12px;
}
#markerInfoModal h3 {
    margin: 0;
    color: #333;
    font-size: 1.75rem;
    font-weight: bold;
}
#markerInfoModal .upload-info {
    font-size: 0.95rem;
    color: #666;
    margin: 0.5rem 0;
}
#markerInfoModal .description {
    margin: 0;
    line-height: 1.6;
    color: #444;
    font-size: 1rem;
}
#markerInfoModal .stats {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
    font-size: 0.95rem;
    color: #666;
}
#markerInfoModal .interaction-buttons {
    display: flex;
    justify-content: flex-end;
    margin-top: auto;
}
#markerInfoModal .interaction-buttons button {
    padding: 0.75rem 1.5rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s;
}
#markerInfoModal .interaction-buttons button:hover {
    background-color: #0056b3;
}
.title-link {
    color: #007bff;
    text-decoration: none;
    cursor: pointer;
}
.title-link:hover {
    text-decoration: underline;
}
.leaflet-popup-content {
    width: 300px !important;
}
.marker-popup img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 10px;
}
.marker-popup h3 {
    margin: 0 0 5px 0;
    font-size: 1.25rem;
    font-weight: bold;
}
.marker-popup p {
    margin: 0 0 5px 0;
    font-size: 0.95rem;
    color: #555;
}
  </style>
</head>
<body>
<div class="floating-menu" id="floatingMenu">
  <button class="floating-btn" id="floatingBtn">â˜°</button>
  <div class="menu-content" id="menuContent">
    <a href="#" id="homeLink">Home</a>
    <a href="#" id="aboutLink">About Us</a>
    <a href="#" id="instructionsLink">Instructions</a>
    <a href="#" id="loginLink">Login/Join</a>
  </div>
</div>

<div class="page search-page" id="searchPage">
  <div class="hero-content">
    <h1>Community Markers</h1>
    <p>Discover and share meaningful places across Minnesota.</p>
    <div class="search-container">
      <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search for a location..." id="searchInput">
        <button class="search-button" id="searchButton">Search Location</button>
      </div>
    </div>
  </div>
  <div class="scroll-down" id="scrollDown">
    <span>View Map</span>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M7 13l5 5 5-5M7 6l5 5 5-5"/>
    </svg>
  </div>
</div>

<div class="page map-page" id="mapPage">
  <div class="map-search-bar">
    <input type="text" class="map-search-input" placeholder="Search for a location in Minnesota..." id="mapSearchInput">
    <button class="map-search-button" id="mapSearchButton">Search</button>
  </div>
  <div id="map"></div>
</div>

<div id="overlay" class="overlay"></div>

<div id="notification" class="notification"></div>

<!-- Auth Popup -->
<div id="authPopup" class="modal-base auth-popup">
  <button id="closePopup" class="close-btn">&times;</button>
  <div class="auth-container">
    <div class="auth-header">
      <p>Join our community or log in to your account</p>
    </div>
    <div class="auth-tabs">
      <button id="showLogin" class="auth-tab active">Login</button>
      <button id="showJoin" class="auth-tab">Join</button>
    </div>
    <form id="loginForm" class="auth-form">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" required>
      </div>
      <button type="submit" id="loginButton" class="auth-button">Login</button>
    </form>
    <form id="joinForm" class="auth-form" style="display: none;">
      <div class="form-group">
        <label for="joinEmail">Email</label>
        <input type="email" id="joinEmail" placeholder="Enter your email" required>
      </div>
      <div class="form-group">
        <label for="joinPassword">Password</label>
        <input type="password" id="joinPassword" placeholder="Create a password" required>
      </div>
      <div class="form-group">
        <label for="joinFirstName">First Name</label>
        <input type="text" id="joinFirstName" placeholder="Enter your first name" required>
      </div>
      <div class="form-group">
        <label for="joinLastName">Last Name</label>
        <input type="text" id="joinLastName" placeholder="Enter your last name" required>
      </div>
      <div class="form-group">
        <label for="joinCity">City</label>
        <input type="text" id="joinCity" placeholder="Enter your city" required>
      </div>
      <button type="submit" id="joinButton" class="auth-button">Join</button>
    </form>
  </div>
</div>

<!-- About Popup -->
<div id="aboutPopup" class="modal-base">
  <button id="closeAbout" class="close-btn">&times;</button>
  <h2>About Us</h2>
  <p>This is a sample about us section.</p>
</div>

<!-- Instructions Popup -->
<div id="instructionsPopup" class="modal-base">
  <button id="closeInstructions" class="close-btn">&times;</button>
  <h2>Instructions</h2>
  <p>Instructions on how to use the map.</p>
</div>

<!-- Logout Popup -->
<div id="logoutPopup" class="modal-base auth-popup">
  <button id="cancelLogout" class="close-btn">&times;</button>
  <p>Are you sure you want to log out?</p>
  <button id="confirmLogout">Log Out</button>
</div>

<!-- Marker Modal -->
<div id="markerModal" class="modal-base">
  <button id="closeModal" class="close-btn">&times;</button>
  <form id="markerForm">
    <input type="text" id="title" placeholder="Title" required>
    <textarea id="description" placeholder="Description" required></textarea>
    <input type="text" id="image" placeholder="Image URL (optional)">
    <input type="date" id="date">
    <button type="submit">Add Marker</button>
  </form>
</div>

<!-- Marker Info Modal -->
<div id="markerInfoModal" class="modal-base">
  <button id="closeMarkerInfo" class="close-btn">&times;</button>
  <img id="markerInfoImage" src="/placeholder.svg" alt="">
  <h3 id="markerInfoTitle"></h3>
  <p id="markerInfoDescription"></p>
  <p id="markerInfoDate"></p>
  <p id="markerInfoViews"></p>
  <p id="markerInfoUploader"></p>
  <p id="markerInfoLikes"></p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBDUAF3qJGhLYQJPHyWwY0JzonN5l8ERzE",
  authDomain: "mnthen-3151d.firebaseapp.com",
  projectId: "mnthen-3151d",
  storageBucket: "mnthen-3151d.appspot.com",
  messagingSenderId: "416231360428",
  appId: "1:416231360428:web:36f69cc231be2d84a8dc09",
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// DOM Elements
const floatingBtn = document.getElementById("floatingBtn");
const menuContent = document.getElementById("menuContent");
const loginLink = document.getElementById("loginLink");
//const logoutButton = document.getElementById("logoutButton");
const authPopup = document.getElementById("authPopup");
const closePopup = document.getElementById("closePopup");
const joinForm = document.getElementById("joinForm");
const loginForm = document.getElementById("loginForm");
const showLogin = document.getElementById("showLogin");
const showJoin = document.getElementById("showJoin");
const joinButton = document.getElementById("joinButton");
const loginButton = document.getElementById("loginButton");
const notification = document.getElementById("notification");
const joinEmail = document.getElementById("joinEmail");
const joinPassword = document.getElementById("joinPassword");
const joinFirstName = document.getElementById("joinFirstName");
const joinLastName = document.getElementById("joinLastName");
const joinCity = document.getElementById("joinCity");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const searchPage = document.getElementById("searchPage");
const mapPage = document.getElementById("mapPage");
const scrollDown = document.getElementById("scrollDown");
const searchInput = document.getElementById("searchInput");
const searchButton = document.getElementById("searchButton");
const mapSearchInput = document.getElementById("mapSearchInput");
const mapSearchButton = document.getElementById("mapSearchButton");
const markerModal = document.getElementById("markerModal");
const closeModal = document.getElementById("closeModal");
const markerForm = document.getElementById("markerForm");
const titleInput = document.getElementById("title");
const descriptionInput = document.getElementById("description");
const imageInput = document.getElementById("image");
const dateInput = document.getElementById("date");
const aboutLink = document.getElementById("aboutLink");
const aboutPopup = document.getElementById("aboutPopup");
const overlay = document.getElementById("overlay");
const closeAbout = document.getElementById("closeAbout");
const logoutPopup = document.getElementById("logoutPopup");
const confirmLogout = document.getElementById("confirmLogout");
const cancelLogout = document.getElementById("cancelLogout");
const instructionsLink = document.getElementById("instructionsLink");
const instructionsPopup = document.getElementById("instructionsPopup");
const closeInstructions = document.getElementById("closeInstructions");
const markerInfoModal = document.getElementById("markerInfoModal");
const closeMarkerInfo = document.getElementById("closeMarkerInfo");
const markerInfoImage = document.getElementById("markerInfoImage");
const markerInfoTitle = document.getElementById("markerInfoTitle");
const markerInfoDescription = document.getElementById("markerInfoDescription");
const markerInfoDate = document.getElementById("markerInfoDate");
const markerInfoViews = document.getElementById("markerInfoViews");
const markerInfoUploader = document.getElementById("markerInfoUploader");
const markerInfoLikes = document.getElementById("markerInfoLikes");

// Global Variables
let map = null;
let markers = null;
let tempMarker = null;
let markersData = JSON.parse(localStorage.getItem('markers') || '[]');
let currentUser = null;

// Firebase Auth State Listener
auth.onAuthStateChanged((user) => {
  currentUser = user;
  loginLink.textContent = user ? "Log Out" : "Login/Join";

  if (user) {
    loginLink.removeEventListener("click", openAuthPopup);
    loginLink.addEventListener("click", openLogoutPopup);
  } else {
    loginLink.removeEventListener("click", openLogoutPopup);
    loginLink.addEventListener("click", openAuthPopup);
  }
});

// FAB Menu Toggle
floatingBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  menuContent.style.display = menuContent.style.display === "block" ? "none" : "block";
});

// Close FAB Menu on Outside Click
window.addEventListener("click", (e) => {
  if (!e.target.matches(".floating-btn") && !e.target.matches(".menu-content a")) {
    menuContent.style.display = "none";
  }
});

// Event Listeners for FAB Menu Links
document.querySelectorAll(".menu-content a").forEach((link) => {
  link.addEventListener("click", (e) => {
    e.preventDefault();
    menuContent.style.display = "none";
  });
});

aboutLink.addEventListener("click", (e) => {
  e.preventDefault();
  aboutPopup.style.display = "block";
  overlay.style.display = "block";
});

instructionsLink.addEventListener("click", (e) => {
  e.preventDefault();
  instructionsPopup.style.display = "block";
  overlay.style.display = "block";
});

loginLink.addEventListener("click", (e) => {
  e.preventDefault();
  if (currentUser) {
    openLogoutPopup(e);
  } else {
    openAuthPopup(e);
  }
});

// Scroll Down functionality
scrollDown.addEventListener("click", () => {
  searchPage.style.transform = "translateY(-100%)";
  mapPage.style.transform = "translateY(0)";
  setTimeout(() => {
    initializeMap();
  }, 500);
});

// Home Link functionality
document.getElementById("homeLink").addEventListener("click", (e) => {
  e.preventDefault();
  searchPage.style.transform = "translateY(0)";
  mapPage.style.transform = "translateY(100%)";
});

// Close Popups
closeAbout.addEventListener("click", () => {
  aboutPopup.style.display = "none";
  overlay.style.display = "none";
});

closeInstructions.addEventListener("click", () => {
  instructionsPopup.style.display = "none";
  overlay.style.display = "none";
});

closePopup.addEventListener("click", () => {
  authPopup.style.display = "none";
  authPopup.classList.remove("active");
  overlay.style.display = "none";
});

window.addEventListener("click", (e) => {
  if (e.target === overlay) {
    aboutPopup.style.display = "none";
    instructionsPopup.style.display = "none";
    authPopup.style.display = "none";
    authPopup.classList.remove("active");
    logoutPopup.style.display = "none";
    logoutPopup.classList.remove("active");
    overlay.style.display = "none";
  }
});

// Auth Popup Functions
function openAuthPopup(e) {
  e.preventDefault();
  authPopup.style.display = "block";
  authPopup.classList.add("active");
  overlay.style.display = "block";
}

function openLogoutPopup(e) {
  e.preventDefault();
  logoutPopup.style.display = "block";
  logoutPopup.classList.add("active");
  overlay.style.display = "block";
}

confirmLogout.addEventListener("click", () => {
  auth.signOut().then(() => {
    showNotification("Logged out successfully!", "success");
    logoutPopup.style.display = "none";
    logoutPopup.classList.remove("active");
    overlay.style.display = "none";
  }).catch((error) => {
    showNotification("Logout failed: " + error.message, "error");
  });
});

cancelLogout.addEventListener("click", () => {
  logoutPopup.style.display = "none";
  logoutPopup.classList.remove("active");
  overlay.style.display = "none";
});

// Auth Form Toggles
showLogin.addEventListener("click", () => {
  joinForm.style.display = "none";
  loginForm.style.display = "block";
});

showJoin.addEventListener("click", () => {
  loginForm.style.display = "none";
  joinForm.style.display = "block";
});

// Join and Login Functions
joinButton.addEventListener("click", (e) => {
  e.preventDefault();
  const email = joinEmail.value;
  const password = joinPassword.value;
  const firstName = joinFirstName.value;
  const lastName = joinLastName.value;
  const city = joinCity.value;

  if (!email || !password || !firstName || !lastName || !city) {
    showNotification("Please fill out all fields.", "error");
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      const user = userCredential.user;
      return database.ref("users/" + user.uid).set({
        email: email,
        firstName: firstName,
        lastName: lastName,
        city: city,
      });
    })
    .then(() => {
      showNotification("Join successful!", "success");
      authPopup.style.display = "none";
      authPopup.classList.remove("active");
      overlay.style.display = "none";
      joinForm.reset();
    })
    .catch((error) => {
      showNotification("Join failed: " + error.message, "error");
    });
});

loginButton.addEventListener("click", (e) => {
  e.preventDefault();
  const email = loginEmail.value;
  const password = loginPassword.value;

  if (!email || !password) {
    showNotification("Please fill out all fields.", "error");
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      showNotification("Login successful!", "success");
      authPopup.style.display = "none";
      authPopup.classList.remove("active");
      overlay.style.display = "none";
      loginForm.reset();
    })
    .catch((error) => {
      showNotification("Login failed: " + error.message, "error");
    });
});

// Notification Function
function showNotification(message, type) {
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = "block";
  setTimeout(() => {
    notification.style.display = "none";
  }, 3000);
}

// Map Functions
function initializeMap() {
  if (!map) {
    map = L.map("map", {
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 19,
    }).setView([44.9778, -93.265], 10);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "",
      maxZoom: 18,
    }).addTo(map);
    
    markers = L.markerClusterGroup();
    map.addLayer(markers);

    map.on("click", (e) => {
      if (!firebase.auth().currentUser) {
        showNotification("Please log in to add markers.", "error");
        return;
      }
      if (tempMarker) map.removeLayer(tempMarker);
      tempMarker = L.marker(e.latlng).addTo(map);
      markerModal.style.display = "block";
      overlay.style.display = "block";
    });

    loadMarkers();
  }
}

function loadMarkers() {
  if (!markers) return;

  markers.clearLayers();
  markersData = JSON.parse(localStorage.getItem("markers") || "[]");

  markersData.forEach((data) => {
    const marker = L.marker([data.lat, data.lng]);
    const popupContent = `
      <div class="marker-popup">
        <h3><a href="#" class="title-link">${data.title}</a></h3>
        <p class="description">${data.description.substring(0, 45)}${data.description.length > 45 ? '...' : ''}</p>
        <p><small>Added on: ${new Date(data.date).toLocaleDateString()}</small></p>
      </div>
    `;
    const popup = L.popup().setContent(popupContent);
    marker.bindPopup(popup);

    popup.on('add', (event) => {
      const titleLink = event.target._contentNode.querySelector('.title-link');
      titleLink.addEventListener('click', () => {
        updateMarkerInfoModal(data);
        markerInfoModal.style.display = "block";
        overlay.style.display = "block";
        marker.closePopup();
      });
    });

    markers.addLayer(marker);
  });
}

// Update Marker Info Modal
function updateMarkerInfoModal(data) {
  markerInfoTitle.textContent = data.title;
  markerInfoImage.src = data.image || "/placeholder.svg";
  markerInfoImage.alt = data.title;
  markerInfoUploader.textContent = `Uploaded by: ${data.uploaderName || 'Anonymous'}`;
  markerInfoDate.textContent = `Uploaded on: ${new Date(data.date).toLocaleDateString()}`;
  markerInfoDescription.textContent = data.description;
  markerInfoViews.textContent = `Views: ${data.views || 0}`;
  markerInfoLikes.textContent = `Likes: ${data.likes || 0}`;

  // Increment views
  data.views = (data.views || 0) + 1;
  localStorage.setItem("markers", JSON.stringify(markersData));
}

// Close Marker Info Modal
closeMarkerInfo.addEventListener("click", () => {
  markerInfoModal.style.display = "none";
  overlay.style.display = "none";
});

// Search Functionality
function performSearch(query, inputElement) {
  if (!query) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", Minnesota, USA")}`)
    .then((response) => response.json())
    .then((data) => {
      const minnesotaResults = data.filter((result) => result.display_name.includes("Minnesota"));
      if (minnesotaResults.length > 0) {
        const { lat, lon } = minnesotaResults[0];
        searchPage.style.transform = "translateY(-100%)";
        mapPage.style.transform = "translateY(0)";

        setTimeout(() => {
          initializeMap();
          map.setView([parseFloat(lat), parseFloat(lon)], 13);
          showNotification("Location found in Minnesota!", "success");
        }, 500);
      } else {
        showNotification("Location not found in Minnesota", "error");
      }
    })
    .catch(() => {
      showNotification("Error searching location", "error");
    })
    .finally(() => {
      if (inputElement) {
        inputElement.value = "";
      }
    });
}

// Event Listeners for Search
searchInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") performSearch(searchInput.value.trim(), searchInput);
});

searchButton.addEventListener("click", () => {
  performSearch(searchInput.value.trim(), searchInput);
});

mapSearchInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") performSearch(mapSearchInput.value.trim(), mapSearchInput);
});

mapSearchButton.addEventListener("click", () => {
  performSearch(mapSearchInput.value.trim(), mapSearchInput);
});

  const authTabs = document.querySelectorAll('.auth-tab');
  
  authTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      authTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      if (tab.id === 'showLogin') {
        joinForm.style.display = 'none';
        loginForm.style.display = 'flex';
      } else {
        loginForm.style.display = 'none';
        joinForm.style.display = 'flex';
      }
    });
  });

// Marker Form Submission
markerForm.addEventListener("submit", (e) => {
  e.preventDefault();

  if (!tempMarker || !currentUser) {
    showNotification("You must be logged in to add a marker.", "error");
    return;
  }

  const description = descriptionInput.value.trim();
  if (description.split(/\s+/).length > 250) {
    showNotification("Description must be 250 words or less.", "error");
    return;
  }

  const newMarker = {
    title: titleInput.value.trim(),
    description: description,
    image: imageInput.value.trim(),
    date: dateInput.value,
    lat: tempMarker.getLatLng().lat,
    lng: tempMarker.getLatLng().lng,
    timestamp: Date.now(),
    userId: currentUser.uid,
    uploaderName: `${currentUser.displayName || 'Anonymous'}`,
    views: 0,
    likes: 0,
  };

  markersData.push(newMarker);
  localStorage.setItem("markers", JSON.stringify(markersData));

  map.removeLayer(tempMarker);
  tempMarker = null;
  markerModal.style.display = "none";
  overlay.style.display = "none";
  markerForm.reset();

  loadMarkers();
  showNotification("Marker added successfully!", "success");
});

// Close Marker Modal
closeModal.addEventListener("click", () => {
  markerModal.style.display = "none";
  overlay.style.display = "none";
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
});

// Initialize Date Input
dateInput.valueAsDate = new Date();

// Initialize Map if Map Page is Active
if (mapPage.style.transform === "translateY(0)") {
  initializeMap();
}
</script>
</body>
</html>
